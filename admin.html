<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Curriculum Expert ‚Äî Admin</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: #f8f7f5;
    color: #1a1a2e;
    min-height: 100vh;
    padding: 2rem;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  header h1 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1a1a2e;
  }

  header h1 span {
    color: #718096;
    font-weight: 400;
    font-size: 1rem;
    margin-left: 0.5rem;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .refresh-btn {
    padding: 0.45rem 1rem;
    background: #2d3748;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: background 0.15s;
  }

  .refresh-btn:hover { background: #1a202c; }

  .generated-at {
    font-size: 0.75rem;
    color: #a0aec0;
  }

  /* Summary cards */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 1.25rem 1.25rem 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .card .label {
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #a0aec0;
    margin-bottom: 0.35rem;
  }

  .card .value {
    font-size: 2rem;
    font-weight: 700;
    color: #2d3748;
    line-height: 1;
  }

  .card .value.sm { font-size: 1.4rem; }

  .card .sub {
    font-size: 0.72rem;
    color: #a0aec0;
    margin-top: 0.3rem;
  }

  /* Sections */
  .section-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    margin-bottom: 1.25rem;
  }

  @media (max-width: 860px) {
    .section-grid { grid-template-columns: 1fr; }
    .section-grid.three { grid-template-columns: 1fr; }
  }

  .section-grid.three {
    grid-template-columns: 1fr 1fr 1fr;
  }

  .panel {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .panel h2 {
    font-size: 0.82rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #718096;
    margin-bottom: 1rem;
  }

  /* Bar charts */
  .bar-list { display: flex; flex-direction: column; gap: 0.55rem; }

  .bar-row {
    display: grid;
    grid-template-columns: 110px 1fr 40px;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.8rem;
  }

  .bar-row .name {
    color: #4a5568;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-transform: capitalize;
  }

  .bar-track {
    height: 10px;
    background: #edf2f7;
    border-radius: 5px;
    overflow: hidden;
  }

  .bar-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.4s ease;
  }

  .bar-row .count {
    font-size: 0.75rem;
    color: #718096;
    text-align: right;
    font-weight: 600;
  }

  /* Day chart */
  .day-chart {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 80px;
    margin-top: 0.25rem;
  }

  .day-bar-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
    gap: 3px;
  }

  .day-bar {
    width: 100%;
    border-radius: 3px 3px 0 0;
    min-height: 2px;
    transition: height 0.3s ease;
  }

  .day-label {
    font-size: 0.58rem;
    color: #cbd5e0;
    white-space: nowrap;
  }

  /* Split bar (thinkers) */
  .split-bar-wrap {
    margin-top: 0.25rem;
  }

  .split-bar {
    display: flex;
    height: 18px;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.4rem;
  }

  .split-legend {
    display: flex;
    gap: 1.25rem;
    font-size: 0.78rem;
    color: #4a5568;
  }

  .split-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 2px;
    margin-right: 0.3rem;
    vertical-align: middle;
  }

  /* Recent questions table */
  .recent-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.78rem;
  }

  .recent-table th {
    text-align: left;
    padding: 0.4rem 0.6rem;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #a0aec0;
    border-bottom: 1px solid #e2e8f0;
  }

  .recent-table td {
    padding: 0.45rem 0.6rem;
    color: #4a5568;
    border-bottom: 1px solid #f7fafc;
    vertical-align: middle;
  }

  .recent-table tr:last-child td { border-bottom: none; }
  .recent-table tr:hover td { background: #f7fafc; }

  .pill {
    display: inline-block;
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    font-size: 0.67rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .pill-subject {
    background: #ebf8ff;
    color: #2b6cb0;
  }

  .pill-length-short    { background: #f0fff4; color: #276749; }
  .pill-length-medium   { background: #fefcbf; color: #7b6000; }
  .pill-length-extended { background: #fff5f5; color: #9b2c2c; }

  .pill-file {
    background: #e9d8fd;
    color: #553c9a;
  }

  .pill-infographic {
    background: #fef3c7;
    color: #92400e;
  }

  /* Options chips row */
  .opts {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.2rem;
  }

  .opt-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    padding: 0.1rem 0.4rem;
    border-radius: 999px;
    font-size: 0.65rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .chip-thinkers-on  { background: #e9d8fd; color: #553c9a; }
  .chip-thinkers-off { background: #f7fafc; color: #a0aec0; border: 1px solid #e2e8f0; }
  .chip-file         { background: #e9d8fd; color: #553c9a; }
  .chip-short        { background: #f0fff4; color: #276749; }
  .chip-medium       { background: #fefcbf; color: #7b6000; }
  .chip-extended     { background: #fff5f5; color: #9b2c2c; }

  .empty {
    text-align: center;
    padding: 2rem;
    color: #a0aec0;
    font-size: 0.85rem;
  }

  .error-msg {
    background: #fff5f5;
    border: 1px solid #feb2b2;
    color: #9b2c2c;
    padding: 1rem 1.25rem;
    border-radius: 8px;
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }
</style>
</head>
<body>

<header>
  <h1>Curriculum Expert <span>Usage Dashboard</span></h1>
  <div class="header-right">
    <span class="generated-at" id="genAt">Loading‚Ä¶</span>
    <button class="refresh-btn" onclick="load()">‚Üª Refresh</button>
    <a href="/" style="padding:0.45rem 1rem;background:#f0f4f8;color:#2d3748;border:1px solid #e2e8f0;border-radius:6px;font-size:0.82rem;font-weight:600;text-decoration:none;font-family:inherit">‚Üê Back to App</a>
  </div>
</header>

<div id="error" style="display:none"></div>

<!-- Summary cards -->
<div class="cards" id="cards"></div>

<!-- Row 1: Subject + Day chart -->
<div class="section-grid">
  <div class="panel" id="panel-subject">
    <h2>Queries by Subject</h2>
    <div id="subject-chart" class="bar-list"><div class="empty">No data yet</div></div>
  </div>
  <div class="panel" id="panel-day">
    <h2>Last 14 Days</h2>
    <div id="day-chart" class="day-chart"></div>
  </div>
</div>

<!-- Row 2: Length + Thinkers + Model -->
<div class="section-grid three">
  <div class="panel">
    <h2>Answer Length</h2>
    <div id="length-chart" class="bar-list"><div class="empty">No data yet</div></div>
  </div>
  <div class="panel">
    <h2>Thinkers Toggle</h2>
    <div id="thinkers-chart"><div class="empty">No data yet</div></div>
  </div>
  <div class="panel">
    <h2>Model Used</h2>
    <div id="model-chart" class="bar-list"><div class="empty">No data yet</div></div>
  </div>
</div>

<!-- Recent activity -->
<div class="panel" id="panel-recent">
  <h2>Recent Activity ‚Äî Queries &amp; Infographics</h2>
  <div id="recent-table"><div class="empty">No queries yet</div></div>
</div>

<script>
const ACCENT_COLORS = {
  history:    '#92400e',
  geography:  '#0d9488',
  maths:      '#2563eb',
  mathematics:'#2563eb',
  science:    '#059669',
  english:    '#c96830',
  mfl:        '#7c3aed',
  're':       '#be185d',
  other:      '#718096',
};

const MODEL_COLORS = {
  'claude-haiku': '#81e6d9',
  'claude-sonnet': '#4299e1',
  'claude-opus': '#9f7aea',
  'gpt': '#10b981',
  'unknown': '#a0aec0',
};

function subjectColor(s) {
  const lower = (s || '').toLowerCase();
  for (const [key, col] of Object.entries(ACCENT_COLORS)) {
    if (lower.includes(key)) return col;
  }
  return '#718096';
}

function modelColor(m) {
  const lower = (m || '').toLowerCase();
  for (const [key, col] of Object.entries(MODEL_COLORS)) {
    if (lower.includes(key)) return col;
  }
  return '#a0aec0';
}

function fmt(n) {
  if (n === null || n === undefined) return '‚Äî';
  return Number(n).toLocaleString();
}

function fmtDuration(ms) {
  if (!ms) return '‚Äî';
  if (ms < 1000) return ms + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}

function fmtTokens(inp, out) {
  if (inp == null && out == null) return '‚Äî';
  const k = n => n >= 1000 ? (n / 1000).toFixed(1) + 'k' : String(n);
  const parts = [];
  if (inp != null) parts.push(`‚Üë${k(inp)}`);
  if (out != null) parts.push(`‚Üì${k(out)}`);
  return parts.join(' ');
}

function fmtDate(ts) {
  if (!ts) return '';
  try {
    return new Date(ts).toLocaleString('en-GB', {
      day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
    });
  } catch { return ts.slice(0, 16).replace('T', ' '); }
}

function barChart(data, colorFn) {
  if (!data || Object.keys(data).length === 0) {
    return '<div class="empty">No data yet</div>';
  }
  const max = Math.max(...Object.values(data));
  return '<div class="bar-list">' +
    Object.entries(data).map(([k, v]) => {
      const pct = max > 0 ? (v / max * 100).toFixed(1) : 0;
      const color = colorFn ? colorFn(k) : '#4299e1';
      return `<div class="bar-row">
        <span class="name" title="${k}">${k}</span>
        <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div>
        <span class="count">${v}</span>
      </div>`;
    }).join('') +
  '</div>';
}

function renderCards(s) {
  const cards = [
    { label: 'Total Queries',   value: fmt(s.total),        sub: 'all time' },
    { label: 'Today',           value: fmt(s.today),        sub: 'queries today' },
    { label: 'This Week',       value: fmt(s.this_week),    sub: 'last 7 days' },
    { label: 'Infographics',    value: fmt(s.infographics), sub: 'generated' },
    { label: 'File Uploads',    value: fmt(s.uploads),      sub: `${fmt(s.with_file)} queries used a file` },
    { label: 'Avg Response',    value: fmtDuration(s.avg_duration_ms), sub: 'time to complete', sm: true },
  ];
  return cards.map(c => `
    <div class="card">
      <div class="label">${c.label}</div>
      <div class="value${c.sm ? ' sm' : ''}">${c.value}</div>
      ${c.sub ? `<div class="sub">${c.sub}</div>` : ''}
    </div>`).join('');
}

function renderDayChart(byDay) {
  if (!byDay || byDay.length === 0) return '';
  const max = Math.max(...byDay.map(d => d.count), 1);
  return byDay.map(d => {
    const pct = (d.count / max * 100).toFixed(1);
    const label = d.date.slice(5); // MM-DD
    const title = `${d.date}: ${d.count} queries`;
    return `<div class="day-bar-wrap" title="${title}">
      <div class="day-bar" style="height:${pct}%;background:#4299e1;min-height:${d.count > 0 ? '4' : '2'}px"></div>
      <span class="day-label">${label}</span>
    </div>`;
  }).join('');
}

function renderThinkers(t) {
  const total = (t.on || 0) + (t.off || 0);
  if (total === 0) return '<div class="empty">No data yet</div>';
  const onPct  = ((t.on  / total) * 100).toFixed(1);
  const offPct = ((t.off / total) * 100).toFixed(1);
  return `<div class="split-bar-wrap">
    <div class="split-bar">
      <div style="width:${onPct}%;background:#805ad5"></div>
      <div style="width:${offPct}%;background:#e2e8f0"></div>
    </div>
    <div class="split-legend">
      <span><span class="split-dot" style="background:#805ad5"></span>On: ${t.on} (${onPct}%)</span>
      <span><span class="split-dot" style="background:#cbd5e0"></span>Off: ${t.off} (${offPct}%)</span>
    </div>
  </div>`;
}

function renderRecent(rows) {
  if (!rows || rows.length === 0) return '<div class="empty">No activity yet</div>';

  const head = `<table class="recent-table">
    <thead><tr>
      <th>Time</th>
      <th>Type</th>
      <th>Subject</th>
      <th>Question / Prompt</th>
      <th>Options</th>
      <th>Tokens</th>
      <th>Duration</th>
    </tr></thead><tbody>`;

  const body = rows.map(r => {
    const isInfographic = r.type === 'infographic';
    const subj = r.subject || '';
    const q = (r.question || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Type badge
    const typeBadge = isInfographic
      ? '<span class="pill pill-infographic">‚ú® Infographic</span>'
      : '<span class="pill pill-subject" style="background:#ebf8ff;color:#2b6cb0">üí¨ Query</span>';

    // Subject chip
    const subjChip = subj && subj !== 'unknown'
      ? `<span class="pill" style="background:${subjectColor(subj)}18;color:${subjectColor(subj)};font-weight:600;font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:999px;text-transform:capitalize">${subj}</span>`
      : '<span style="color:#cbd5e0">‚Äî</span>';

    // Options chips (queries only)
    let optsHtml = '';
    if (!isInfographic) {
      const lengthChip = `<span class="opt-chip chip-${r.length || 'medium'}">${
        { short: '‚ö° Short', medium: 'üìù Medium', extended: 'üìñ Extended' }[r.length] || r.length
      }</span>`;
      const thinkersChip = r.cite_thinkers !== false
        ? '<span class="opt-chip chip-thinkers-on">üìö Thinkers</span>'
        : '<span class="opt-chip chip-thinkers-off">üìö off</span>';
      const fileChip = r.has_file
        ? '<span class="opt-chip chip-file">üìé File</span>'
        : '';
      optsHtml = `<div class="opts">${lengthChip}${thinkersChip}${fileChip}</div>`;
    }

    // Success indicator
    const failBadge = r.success === false
      ? ' <span style="color:#fc8181;font-size:0.7rem">‚ö† failed</span>' : '';

    const tokStr = fmtTokens(r.input_tokens, r.output_tokens);
    const tokTitle = (r.input_tokens != null || r.output_tokens != null)
      ? `title="${r.input_tokens ?? '?'} in / ${r.output_tokens ?? '?'} out"` : '';
    return `<tr>
      <td style="white-space:nowrap;color:#a0aec0;font-size:0.75rem">${fmtDate(r.ts)}</td>
      <td style="white-space:nowrap">${typeBadge}</td>
      <td>${subjChip}</td>
      <td style="max-width:300px">${q}${failBadge}</td>
      <td>${optsHtml}</td>
      <td style="color:#718096;white-space:nowrap;font-size:0.73rem;font-variant-numeric:tabular-nums" ${tokTitle}>${tokStr}</td>
      <td style="color:#a0aec0;white-space:nowrap;font-size:0.75rem">${fmtDuration(r.duration_ms)}</td>
    </tr>`;
  }).join('');

  return head + body + '</tbody></table>';
}

async function load() {
  document.getElementById('genAt').textContent = 'Loading‚Ä¶';
  document.getElementById('error').style.display = 'none';
  try {
    const res = await fetch('/admin/stats');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const d = await res.json();

    document.getElementById('genAt').textContent =
      'Updated ' + new Date(d.generated_at).toLocaleTimeString('en-GB');

    document.getElementById('cards').innerHTML = renderCards(d.summary);
    document.getElementById('subject-chart').innerHTML =
      barChart(d.by_subject, subjectColor);
    document.getElementById('day-chart').innerHTML =
      renderDayChart(d.by_day);
    document.getElementById('length-chart').innerHTML =
      barChart(d.by_length, k => ({ short: '#48bb78', medium: '#ecc94b', extended: '#fc8181' }[k] || '#a0aec0'));
    document.getElementById('thinkers-chart').innerHTML =
      renderThinkers(d.thinkers);
    document.getElementById('model-chart').innerHTML =
      barChart(d.by_model, modelColor);
    document.getElementById('recent-table').innerHTML =
      renderRecent(d.recent);

  } catch (e) {
    const el = document.getElementById('error');
    el.className = 'error-msg';
    el.textContent = 'Failed to load stats: ' + e.message;
    el.style.display = 'block';
    document.getElementById('genAt').textContent = 'Error';
  }
}

load();
setInterval(load, 60000); // auto-refresh every minute
</script>
</body>
</html>
