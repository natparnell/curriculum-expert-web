<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restorative Conversation Simulator</title>
<style>
:root {
  --amber-50: #fffbeb;
  --amber-100: #fef3c7;
  --amber-200: #fde68a;
  --amber-300: #fcd34d;
  --amber-400: #fbbf24;
  --amber-500: #f59e0b;
  --amber-600: #d97706;
  --amber-700: #b45309;
  --green-50: #f0fdf4;
  --green-100: #dcfce7;
  --green-200: #bbf7d0;
  --green-300: #86efac;
  --green-400: #4ade80;
  --green-500: #22c55e;
  --green-600: #16a34a;
  --green-700: #15803d;
  --blue-50: #eff6ff;
  --blue-100: #dbeafe;
  --blue-200: #bfdbfe;
  --blue-300: #93c5fd;
  --blue-400: #60a5fa;
  --blue-500: #3b82f6;
  --blue-600: #2563eb;
  --blue-700: #1d4ed8;
  --warm-50: #fdf8f0;
  --warm-100: #f5ead6;
  --warm-200: #e8d5b5;
  --warm-700: #6b4c2a;
  --warm-800: #4a3520;
  --warm-900: #2d1f12;
  --red-400: #f87171;
  --red-500: #ef4444;
  --red-600: #dc2626;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
  --shadow-xl: 0 20px 25px rgba(0,0,0,0.1), 0 10px 10px rgba(0,0,0,0.04);
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, var(--warm-50) 0%, var(--amber-50) 50%, var(--green-50) 100%);
  min-height: 100vh;
  color: var(--warm-900);
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
.header {
  text-align: center;
  padding: 30px 20px 20px;
}
.header h1 {
  font-size: 2.2rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--amber-700), var(--green-700));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 6px;
}
.header .subtitle {
  font-size: 1.05rem;
  color: var(--warm-700);
  font-weight: 400;
}

/* Screens */
.screen { display: none; }
.screen.active { display: block; }

/* Scenario Selection */
.scenario-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 24px;
  margin-top: 24px;
}
.scenario-card {
  background: white;
  border-radius: var(--radius-xl);
  padding: 28px;
  box-shadow: var(--shadow-md);
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}
.scenario-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}
.scenario-card:nth-child(1)::before { background: linear-gradient(90deg, var(--red-400), var(--amber-400)); }
.scenario-card:nth-child(2)::before { background: linear-gradient(90deg, var(--amber-400), var(--amber-300)); }
.scenario-card:nth-child(3)::before { background: linear-gradient(90deg, var(--blue-400), var(--blue-300)); }
.scenario-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-xl);
  border-color: var(--amber-300);
}
.scenario-card .sc-icon {
  width: 56px; height: 56px;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem;
  margin-bottom: 16px;
}
.scenario-card:nth-child(1) .sc-icon { background: linear-gradient(135deg, #fee2e2, #fecaca); }
.scenario-card:nth-child(2) .sc-icon { background: linear-gradient(135deg, var(--amber-100), var(--amber-200)); }
.scenario-card:nth-child(3) .sc-icon { background: linear-gradient(135deg, var(--blue-100), var(--blue-200)); }
.scenario-card h3 {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--warm-900);
}
.scenario-card .sc-year {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.78rem;
  font-weight: 600;
  margin-bottom: 10px;
}
.scenario-card:nth-child(1) .sc-year { background: #fee2e2; color: var(--red-600); }
.scenario-card:nth-child(2) .sc-year { background: var(--amber-100); color: var(--amber-700); }
.scenario-card:nth-child(3) .sc-year { background: var(--blue-100); color: var(--blue-700); }
.scenario-card p {
  font-size: 0.92rem;
  color: #6b5c4e;
  line-height: 1.6;
}
.scenario-card .sc-difficulty {
  margin-top: 14px;
  font-size: 0.8rem;
  color: #8b7a6b;
  display: flex;
  align-items: center;
  gap: 6px;
}
.diff-dots { display: flex; gap: 3px; }
.diff-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #e0d5c7;
}
.diff-dot.filled { background: var(--amber-500); }

/* Simulation Layout */
.sim-layout {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 20px;
  margin-top: 16px;
}
@media (max-width: 900px) {
  .sim-layout { grid-template-columns: 1fr; }
  .sidebar { display: none; }
}

/* Main conversation area */
.conv-area {
  background: white;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 600px;
}

/* Stage indicator */
.stage-bar {
  background: linear-gradient(135deg, var(--warm-50), var(--amber-50));
  padding: 14px 20px;
  border-bottom: 1px solid var(--warm-100);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.stage-pip {
  width: 32px; height: 6px;
  border-radius: 3px;
  background: var(--warm-200);
  transition: background 0.4s ease;
}
.stage-pip.completed { background: var(--green-500); }
.stage-pip.current { background: var(--amber-500); animation: pulsePip 2s infinite; }
@keyframes pulsePip {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
.stage-label {
  margin-left: auto;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--amber-700);
  background: var(--amber-100);
  padding: 4px 12px;
  border-radius: 20px;
}

/* Chat area */
.chat-area {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-height: 480px;
}
.chat-area::-webkit-scrollbar { width: 6px; }
.chat-area::-webkit-scrollbar-track { background: transparent; }
.chat-area::-webkit-scrollbar-thumb { background: var(--warm-200); border-radius: 3px; }

.msg {
  max-width: 85%;
  animation: msgIn 0.4s ease;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg-student {
  align-self: flex-start;
}
.msg-student .msg-bubble {
  background: linear-gradient(135deg, #f8f4ef, #f3ece2);
  border-radius: 4px 18px 18px 18px;
  padding: 14px 18px;
  position: relative;
  border: 1px solid var(--warm-100);
}
.msg-student .msg-name {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--amber-700);
  margin-bottom: 4px;
}
.msg-student .msg-text {
  font-size: 0.95rem;
  color: var(--warm-800);
  line-height: 1.6;
}

.msg-staff {
  align-self: flex-end;
}
.msg-staff .msg-bubble {
  background: linear-gradient(135deg, var(--green-50), #e8f5e9);
  border-radius: 18px 4px 18px 18px;
  padding: 14px 18px;
  border: 1px solid var(--green-200);
}
.msg-staff .msg-name {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--green-700);
  margin-bottom: 4px;
  text-align: right;
}
.msg-staff .msg-text {
  font-size: 0.95rem;
  color: var(--warm-800);
  line-height: 1.6;
}

.msg-narrator {
  align-self: center;
  max-width: 90%;
}
.msg-narrator .msg-bubble {
  background: linear-gradient(135deg, var(--blue-50), #eef2ff);
  border-radius: 14px;
  padding: 12px 18px;
  text-align: center;
  border: 1px solid var(--blue-200);
  font-size: 0.88rem;
  color: var(--blue-700);
  font-style: italic;
}

/* Coach note */
.coach-note {
  background: linear-gradient(135deg, var(--amber-50), #fff9eb);
  border: 1px solid var(--amber-200);
  border-left: 4px solid var(--amber-500);
  border-radius: 0 12px 12px 0;
  padding: 12px 16px;
  margin: 4px 0;
  animation: noteIn 0.5s ease;
  align-self: stretch;
  max-width: 100%;
}
@keyframes noteIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}
.coach-note .cn-label {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--amber-700);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.coach-note .cn-text {
  font-size: 0.85rem;
  color: var(--warm-800);
  line-height: 1.5;
}
.coach-note.good { border-left-color: var(--green-500); background: linear-gradient(135deg, var(--green-50), #f0fdf4); }
.coach-note.good .cn-label { color: var(--green-700); }
.coach-note.ok { border-left-color: var(--amber-500); }
.coach-note.poor { border-left-color: var(--red-500); background: linear-gradient(135deg, #fff5f5, #fef2f2); }
.coach-note.poor .cn-label { color: var(--red-600); }

/* Response options */
.response-area {
  border-top: 1px solid var(--warm-100);
  padding: 16px 20px;
  background: linear-gradient(to top, var(--warm-50), white);
}
.response-prompt {
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--warm-700);
  margin-bottom: 10px;
}
.response-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.response-btn {
  background: white;
  border: 2px solid var(--warm-200);
  border-radius: var(--radius);
  padding: 12px 16px;
  font-size: 0.9rem;
  color: var(--warm-800);
  cursor: pointer;
  transition: all 0.25s ease;
  text-align: left;
  line-height: 1.5;
  font-family: inherit;
}
.response-btn:hover {
  border-color: var(--amber-400);
  background: var(--amber-50);
  transform: translateX(4px);
}
.response-btn.selected-good {
  border-color: var(--green-500);
  background: var(--green-50);
}
.response-btn.selected-ok {
  border-color: var(--amber-500);
  background: var(--amber-50);
}
.response-btn.selected-poor {
  border-color: var(--red-500);
  background: #fef2f2;
}

.continue-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, var(--amber-500), var(--amber-600));
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 12px 28px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  margin-top: 12px;
  font-family: inherit;
}
.continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Meters */
.meters {
  display: flex;
  gap: 16px;
  padding: 12px 20px;
  background: white;
  border-bottom: 1px solid var(--warm-100);
}
.meter {
  flex: 1;
}
.meter-label {
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.meter-label.trust { color: var(--blue-600); }
.meter-label.quality { color: var(--green-600); }
.meter-track {
  height: 8px;
  background: #eee;
  border-radius: 4px;
  overflow: hidden;
}
.meter-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.6s ease, background 0.4s ease;
}
.meter-fill.trust-fill {
  background: linear-gradient(90deg, var(--blue-400), var(--blue-500));
}
.meter-fill.quality-fill {
  background: linear-gradient(90deg, var(--green-400), var(--green-500));
}

/* Sidebar */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.sidebar-card {
  background: white;
  border-radius: var(--radius-lg);
  padding: 20px;
  box-shadow: var(--shadow);
}
.sidebar-card h4 {
  font-size: 0.88rem;
  font-weight: 700;
  color: var(--warm-800);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sidebar-card h4 .icon {
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px;
  font-size: 0.8rem;
}
.rq-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.rq-list li {
  font-size: 0.82rem;
  color: var(--warm-700);
  padding: 8px 10px;
  background: var(--warm-50);
  border-radius: 8px;
  border-left: 3px solid var(--amber-400);
  line-height: 1.5;
}
.rq-list li.highlight {
  background: var(--amber-100);
  border-left-color: var(--amber-600);
  font-weight: 600;
}

/* Student profile */
.student-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}
.student-avatar {
  width: 44px; height: 44px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  font-weight: 700;
  color: white;
}
.student-info .si-name {
  font-size: 0.92rem;
  font-weight: 700;
  color: var(--warm-900);
}
.student-info .si-detail {
  font-size: 0.78rem;
  color: var(--warm-700);
}
.emotion-state {
  margin-top: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.8rem;
  font-weight: 600;
  text-align: center;
}

/* Summary screen */
.summary {
  background: white;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  margin-top: 16px;
}
.summary-header {
  padding: 32px;
  text-align: center;
  color: white;
}
.summary-header.gold { background: linear-gradient(135deg, #d97706, #f59e0b, #fbbf24); }
.summary-header.silver { background: linear-gradient(135deg, #6b7280, #9ca3af, #d1d5db); }
.summary-header.bronze { background: linear-gradient(135deg, #92400e, #b45309, #d97706); }
.summary-header h2 {
  font-size: 2rem;
  margin-bottom: 6px;
}
.summary-header .award-icon {
  font-size: 3rem;
  margin-bottom: 8px;
}
.summary-header .score-text {
  font-size: 1.1rem;
  opacity: 0.9;
}

.summary-body {
  padding: 28px;
}
.summary-section {
  margin-bottom: 24px;
}
.summary-section h3 {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--warm-800);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--warm-100);
}
.stage-breakdown {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.sb-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  border-radius: 10px;
  background: var(--warm-50);
}
.sb-stage {
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--warm-700);
  min-width: 140px;
}
.sb-choice {
  flex: 1;
  font-size: 0.85rem;
  color: var(--warm-800);
}
.sb-quality {
  font-size: 0.75rem;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 20px;
  white-space: nowrap;
}
.sb-quality.q-good { background: var(--green-100); color: var(--green-700); }
.sb-quality.q-ok { background: var(--amber-100); color: var(--amber-700); }
.sb-quality.q-poor { background: #fee2e2; color: var(--red-600); }

.strengths-list, .dev-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.strengths-list li, .dev-list li {
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.88rem;
  line-height: 1.5;
}
.strengths-list li {
  background: var(--green-50);
  border-left: 3px solid var(--green-500);
  color: var(--green-700);
}
.dev-list li {
  background: var(--amber-50);
  border-left: 3px solid var(--amber-500);
  color: var(--amber-700);
}

.expert-path {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.ep-row {
  padding: 10px 14px;
  border-radius: 10px;
  background: var(--green-50);
  border: 1px solid var(--green-200);
}
.ep-stage-name {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--green-700);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.ep-text {
  font-size: 0.88rem;
  color: var(--warm-800);
  margin-top: 4px;
  line-height: 1.5;
}

.emotion-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.ec-card {
  padding: 16px;
  border-radius: var(--radius);
  text-align: center;
}
.ec-card.yours { background: var(--blue-50); border: 1px solid var(--blue-200); }
.ec-card.optimal { background: var(--green-50); border: 1px solid var(--green-200); }
.ec-card .ec-label {
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}
.ec-card.yours .ec-label { color: var(--blue-600); }
.ec-card.optimal .ec-label { color: var(--green-600); }
.ec-card .ec-emotion {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--warm-800);
}

.summary-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  padding: 20px 28px 28px;
}
.btn-primary {
  background: linear-gradient(135deg, var(--amber-500), var(--amber-600));
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 12px 28px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  font-family: inherit;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.btn-secondary {
  background: white;
  color: var(--warm-800);
  border: 2px solid var(--warm-200);
  border-radius: var(--radius);
  padding: 12px 28px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  font-family: inherit;
}
.btn-secondary:hover { border-color: var(--amber-400); background: var(--amber-50); }

/* Typing indicator */
.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 10px 16px;
  align-self: flex-start;
}
.typing-indicator span {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--warm-200);
  animation: typingBounce 1.4s infinite ease-in-out;
}
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
  40% { transform: scale(1); opacity: 1; }
}

/* Intro screen for scenario */
.scenario-intro {
  background: white;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  padding: 36px;
  text-align: center;
  max-width: 680px;
  margin: 24px auto;
}
.scenario-intro h2 {
  font-size: 1.6rem;
  color: var(--warm-900);
  margin-bottom: 16px;
}
.scenario-intro .intro-context {
  font-size: 0.95rem;
  color: var(--warm-700);
  line-height: 1.7;
  text-align: left;
  background: var(--warm-50);
  border-radius: var(--radius);
  padding: 20px;
  margin: 16px 0;
  border-left: 4px solid var(--amber-400);
}
.scenario-intro .intro-student {
  display: flex;
  align-items: center;
  gap: 16px;
  text-align: left;
  padding: 16px;
  background: var(--blue-50);
  border-radius: var(--radius);
  margin: 16px 0;
}
.intro-student .is-avatar {
  width: 56px; height: 56px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}
.intro-student .is-text h4 {
  font-size: 1rem;
  color: var(--warm-900);
}
.intro-student .is-text p {
  font-size: 0.88rem;
  color: var(--warm-700);
  margin-top: 2px;
}

/* Utility */
.hidden { display: none !important; }
.text-center { text-align: center; }
.mt-2 { margin-top: 8px; }
.mt-4 { margin-top: 16px; }

/* Responsive for projector */
@media (min-width: 1400px) {
  .container { max-width: 1300px; }
  .chat-area { max-height: 560px; }
  .header h1 { font-size: 2.5rem; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Restorative Conversation Simulator</h1>
    <p class="subtitle">Professional Development for School Staff</p>
  </div>

  <!-- SCREEN: Scenario Selection -->
  <div id="screen-select" class="screen active">
    <div class="text-center">
      <p style="font-size:1.05rem; color: var(--warm-700); max-width:640px; margin:0 auto;">
        Choose a scenario to practise your restorative conversation skills. Each scenario guides you through a complete restorative conversation framework with a virtual student.
      </p>
    </div>
    <div class="scenario-grid">
      <div class="scenario-card" onclick="startScenario(0)">
        <div class="sc-icon">&#9888;</div>
        <span class="sc-year">Year 9</span>
        <h3>After a Fight</h3>
        <p>Two Year 9 boys had a physical altercation at break time. You are meeting with Kyle, who started the fight because he felt "disrespected." He is defensive and believes he was justified.</p>
        <div class="sc-difficulty">
          <span>Difficulty:</span>
          <div class="diff-dots">
            <div class="diff-dot filled"></div>
            <div class="diff-dot filled"></div>
            <div class="diff-dot filled"></div>
          </div>
          <span>Challenging</span>
        </div>
      </div>
      <div class="scenario-card" onclick="startScenario(1)">
        <div class="sc-icon">&#128172;</div>
        <span class="sc-year">Year 8</span>
        <h3>Persistent Low-Level Disruption</h3>
        <p>Amira has been repeatedly disrupting lessons for two weeks and is now on a behaviour report. She is hiding the fact that her parents are separating, and she is frustrated and embarrassed.</p>
        <div class="sc-difficulty">
          <span>Difficulty:</span>
          <div class="diff-dots">
            <div class="diff-dot filled"></div>
            <div class="diff-dot filled"></div>
            <div class="diff-dot"></div>
          </div>
          <span>Moderate</span>
        </div>
      </div>
      <div class="scenario-card" onclick="startScenario(2)">
        <div class="sc-icon">&#128683;</div>
        <span class="sc-year">Year 10</span>
        <h3>Damage to Property</h3>
        <p>Jayden kicked a door and broke a window after learning he could not attend a school trip due to previous behaviour. He is now calm but feels the decision was deeply unfair.</p>
        <div class="sc-difficulty">
          <span>Difficulty:</span>
          <div class="diff-dots">
            <div class="diff-dot filled"></div>
            <div class="diff-dot filled"></div>
            <div class="diff-dot"></div>
          </div>
          <span>Moderate</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SCREEN: Scenario Intro -->
  <div id="screen-intro" class="screen">
    <div class="scenario-intro" id="intro-content"></div>
  </div>

  <!-- SCREEN: Simulation -->
  <div id="screen-sim" class="screen">
    <div class="sim-layout">
      <div>
        <div class="conv-area">
          <div class="stage-bar" id="stage-bar"></div>
          <div class="meters">
            <div class="meter">
              <div class="meter-label trust">
                <span>Trust Level</span>
                <span id="trust-val">50%</span>
              </div>
              <div class="meter-track">
                <div class="meter-fill trust-fill" id="trust-fill" style="width:50%"></div>
              </div>
            </div>
            <div class="meter">
              <div class="meter-label quality">
                <span>Restorative Quality</span>
                <span id="quality-val">0%</span>
              </div>
              <div class="meter-track">
                <div class="meter-fill quality-fill" id="quality-fill" style="width:0%"></div>
              </div>
            </div>
          </div>
          <div class="chat-area" id="chat-area"></div>
          <div class="response-area" id="response-area"></div>
        </div>
      </div>
      <div class="sidebar">
        <div class="sidebar-card" id="student-card"></div>
        <div class="sidebar-card">
          <h4><span class="icon" style="background:var(--amber-100);">&#128218;</span> Key Restorative Questions</h4>
          <ul class="rq-list" id="rq-list">
            <li>"What happened?"</li>
            <li>"What were you thinking/feeling at the time?"</li>
            <li>"Who has been affected by this?"</li>
            <li>"How have they been affected?"</li>
            <li>"What do you think needs to happen to make things right?"</li>
            <li>"How can we make sure this doesn't happen again?"</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- SCREEN: Summary -->
  <div id="screen-summary" class="screen">
    <div class="summary" id="summary-content"></div>
  </div>
</div>

<script>
// ========== SCENARIO DATA ==========

const STAGE_NAMES = [
  "Setting the Scene",
  "Tell the Story",
  "Explore the Impact",
  "Take Responsibility",
  "Repair & Restore",
  "Moving Forward"
];

const STAGE_RQ_HIGHLIGHTS = [
  [],
  [0, 1],
  [2, 3],
  [1],
  [4],
  [5]
];

const scenarios = [
  // ===== SCENARIO 0: Kyle - After a Fight =====
  {
    title: "After a Fight",
    studentName: "Kyle",
    studentYear: "Year 9",
    studentDetail: "Involved in a physical altercation at break time",
    avatarColor: "#dc2626",
    avatarLetter: "K",
    introContext: "Two Year 9 boys, Kyle and Marcus, were involved in a physical fight during break time. Other students witnessed it, and a teaching assistant intervened. Kyle appears to have started the physical altercation. He has been separated from Marcus and is waiting in the inclusion room. He is agitated and feels strongly that he was provoked. You are a member of the pastoral team meeting with Kyle first for a restorative conversation.",
    introStudentDesc: "Kyle is usually fairly well-behaved but has a short temper. He cares about respect and loyalty. He is currently angry and defensive, believing Marcus provoked him by making comments about his family.",
    startTrust: 35,
    startEmotion: "Angry and defensive",
    stages: [
      // STAGE 0: Setting the Scene
      {
        narration: "Kyle is sitting with his arms crossed, leg bouncing. He glances at you warily as you enter the room.",
        studentOpener: "I already know what you're gonna say, so you might as well just give me the exclusion and get it over with.",
        options: [
          {
            text: "Kyle, I'm not here to punish you. I'd like us to have a conversation so I can understand what happened. There are just two ground rules -- we're honest with each other, and we listen. Does that sound fair?",
            quality: "good",
            trust: 12,
            score: 3,
            studentResponse: "*uncrosses arms slightly* ... Fine. But I'm telling you now, I ain't the bad guy here.",
            coachNote: "Excellent opening. You immediately challenged Kyle's assumption that this is purely punitive, established clear ground rules, and sought his agreement -- all key restorative principles. Using 'does that sound fair?' gives him agency.",
            emotion: "Guarded but willing"
          },
          {
            text: "I'm here to talk about what happened. Let's just have a calm chat about it, yeah?",
            quality: "ok",
            trust: 5,
            score: 2,
            studentResponse: "*shrugs* Whatever. Can we just be quick about it?",
            coachNote: "A reasonable start, but you missed the opportunity to establish clear ground rules and reassure Kyle this isn't purely about punishment. Without that framing, he's likely to remain defensive.",
            emotion: "Dismissive"
          },
          {
            text: "Right, Kyle. I've heard what happened at break time. Fighting is completely unacceptable, as you well know.",
            quality: "poor",
            trust: -10,
            score: 0,
            studentResponse: "See? You've already made up your mind! You don't even know what he said to me. This is such a joke.",
            coachNote: "Starting with a judgement immediately puts Kyle on the back foot. He feels unheard before the conversation has even begun. In restorative practice, we avoid leading with blame or pre-judgement.",
            emotion: "Very defensive and hostile"
          },
          {
            text: "Kyle, before we talk about anything, I want you to know that whatever happened, you're safe here and I genuinely want to hear your side. Can we agree to be honest with each other and take turns to speak?",
            quality: "good",
            trust: 15,
            score: 3,
            studentResponse: "*pauses, looks at you properly for the first time* ... Yeah. Yeah, alright. But you actually need to listen, yeah? Not just pretend.",
            coachNote: "Outstanding. Leading with safety and genuine care is powerful with an agitated student. Explicitly naming 'your side' validates that his perspective matters. The ground rules are collaborative, not imposed.",
            emotion: "Cautiously engaged"
          }
        ]
      },
      // STAGE 1: Tell the Story
      {
        narration: "Kyle shifts in his seat, gathering his thoughts.",
        studentOpener: "So what do you wanna know then?",
        options: [
          {
            text: "In your own words, Kyle -- what happened today?",
            quality: "good",
            trust: 8,
            score: 3,
            studentResponse: "Right, so basically... Marcus has been chatting bare rubbish about my mum for like two weeks. Today he proper went in on it in front of everyone. Saying stuff about how she can't afford to feed us and that. Everyone was laughing. So yeah, I pushed him and then it just kicked off. I know I shouldn't have hit him but... what was I supposed to do? Just stand there and take it?",
            coachNote: "Perfect open question. 'In your own words' signals you want his genuine perspective, not a rehearsed version. This is the foundation of restorative dialogue -- letting the person tell their story without interruption.",
            emotion: "Opening up, still frustrated"
          },
          {
            text: "Why did you hit Marcus?",
            quality: "ok",
            trust: 2,
            score: 1,
            studentResponse: "Because he deserved it! He's been going on about my family for weeks. You lot never do anything about it when I tell you, so I had to sort it myself.",
            coachNote: "'Why' questions can feel accusatory and tend to produce justifications rather than reflection. 'What happened?' is more open and less threatening than 'Why did you hit him?' which has an implicit judgement built in.",
            emotion: "Defensive, justifying"
          },
          {
            text: "I've been told you started the fight. Is that right?",
            quality: "poor",
            trust: -8,
            score: 0,
            studentResponse: "Oh here we go. So you've already been told I started it, yeah? Then why are you even asking? Marcus was the one who started it with his mouth. But no one cares about that, do they?",
            coachNote: "Leading with what you've been told undermines trust immediately. Kyle feels the narrative is already decided. In restorative practice, we approach without a fixed version of events and let the young person share first.",
            emotion: "Hostile, shut down"
          }
        ]
      },
      // STAGE 2: Explore the Impact
      {
        narration: "Kyle has shared his version. Now it's time to help him think about who was affected.",
        studentOpener: "Look, I know fighting's wrong and that. But he proper had it coming.",
        options: [
          {
            text: "I hear you, Kyle, and we'll come back to that. Can I ask -- when you think about everything that happened, who do you think has been affected by it? Not just the fight, but all of it.",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "*thinks for a moment* ... I mean, Marcus obviously. And I guess... the other kids who saw it. Some of the younger ones looked well scared. And Miss Taylor who had to break it up -- she proper hurt her wrist trying to get between us. *quieter* And my mum's gonna go mental when she finds out. She's got enough going on without this.",
            coachNote: "Excellent. You acknowledged his feelings, then broadened the question beyond just the direct parties. Saying 'all of it' invites Kyle to think holistically. He identified multiple people affected, including himself and his mum -- a sign of growing empathy.",
            emotion: "Reflective, some guilt emerging"
          },
          {
            text: "Do you think Marcus deserved to be hit?",
            quality: "poor",
            trust: -5,
            score: 0,
            studentResponse: "Yeah, honestly? Yeah I do. You can't just say that stuff about someone's mum and expect nothing to happen.",
            coachNote: "This is a closed, leading question that invites Kyle to double down on his position. It doesn't help him explore impact at all. We need to guide him toward thinking about who was affected, not whether violence was justified.",
            emotion: "Entrenched, defiant"
          },
          {
            text: "Who do you think was affected by what happened at break time?",
            quality: "ok",
            trust: 6,
            score: 2,
            studentResponse: "Marcus, I suppose. And me. I'm probably getting excluded now, aren't I?",
            coachNote: "A reasonable question from the restorative framework, but you could have acknowledged Kyle's feelings first. Also, he jumped straight to consequences for himself -- a gentler, broader prompt might have helped him think about others more fully.",
            emotion: "Worried about consequences"
          },
          {
            text: "I can see this matters to you a lot, and what Marcus said sounds really hurtful. I want to understand more about that. But first, I'd like you to think about this -- when the fight happened and everyone was watching, who do you think was affected by what they saw? Take your time.",
            quality: "good",
            trust: 12,
            score: 3,
            studentResponse: "*long pause* ... The Year 7s. There were some Year 7s there and one of them was crying. That weren't... I didn't mean for that. And Miss Taylor grabbed my arm and I nearly elbowed her by accident. She didn't deserve that. *rubs his face* And Marcus... even though he was being a prick -- sorry -- even though he was out of order, I could see he was scared when I went for him. He thought I was gonna properly hurt him.",
            coachNote: "Masterful. You validated Kyle's emotions, signalled that his grievance will be addressed, then used a specific, vivid prompt ('everyone was watching') to help him visualise the wider impact. His response shows genuine empathy developing -- he's seeing beyond his own anger.",
            emotion: "Genuinely reflective, empathetic"
          }
        ]
      },
      // STAGE 3: Take Responsibility
      {
        narration: "Kyle is becoming more reflective. This is the moment to help him own his part.",
        studentOpener: "I get that people got scared and that. But Marcus started it with what he said. That's what no one gets.",
        options: [
          {
            text: "I absolutely hear that what Marcus said was hurtful and wrong, and that needs to be dealt with separately. But right now, thinking about your own actions today -- what part did you play in what happened?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "*sighs heavily* ... I hit him. I threw the first punch. I could've walked away or gone to find a teacher, but I didn't. I just saw red. And I know I could've really hurt him -- or Miss Taylor. I didn't think about any of that.",
            coachNote: "Perfectly balanced. You validated his grievance without dismissing it, clearly separated the two issues, then used an open question focused on his actions. Kyle was able to take genuine ownership because he felt heard first.",
            emotion: "Taking ownership, remorseful"
          },
          {
            text: "But you know that hitting someone is never the answer, don't you, Kyle?",
            quality: "poor",
            trust: -6,
            score: 0,
            studentResponse: "Yeah, I know, everyone keeps saying that. But what else am I supposed to do when someone's dissing my family and no one does anything about it? It's easy for you lot to say 'walk away' when you ain't the one getting it.",
            coachNote: "This is a rhetorical, lecturing question that invites Kyle to defend his position. 'Don't you?' is a tag question that seeks compliance rather than genuine reflection. He's now focused on justifying himself again rather than taking responsibility.",
            emotion: "Resentful, defensive"
          },
          {
            text: "What could you have done differently today?",
            quality: "ok",
            trust: 4,
            score: 2,
            studentResponse: "I dunno... walked away, I guess? Told a teacher? But honestly, I was so angry I just didn't think.",
            coachNote: "This jumps slightly ahead to solutions without first asking Kyle to clearly own his part. The response is fairly superficial -- 'walked away, I guess' -- because he hasn't been guided to fully reflect on his own responsibility. Naming your own actions comes before problem-solving.",
            emotion: "Compliant but not deeply reflective"
          }
        ]
      },
      // STAGE 4: Repair & Restore
      {
        narration: "Kyle is showing genuine reflection. Now guide him toward making things right.",
        studentOpener: "So what happens now? Am I getting excluded or what?",
        options: [
          {
            text: "We'll talk about consequences separately. Right now, I'm more interested in what you think needs to happen to start putting things right -- for Marcus, for Miss Taylor, for the younger students who were upset, and for yourself.",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "I should probably say sorry to Miss Taylor. That's... yeah, she was only trying to help. And I guess I need to talk to Marcus. Not saying I forgive what he said, but I shouldn't have hit him. Maybe I could apologise to him and then we could sort out the stuff he's been saying? Like with someone there to help? And the Year 7s... I dunno, maybe if they see me and Marcus being normal again, that would help?",
            coachNote: "Excellent reframe. By separating consequences from restoration, you kept the restorative focus. Naming specific people helped Kyle think concretely. His response shows genuine restorative thinking -- he's proposing meaningful actions, not just token apologies.",
            emotion: "Proactive, genuine"
          },
          {
            text: "You'll need to apologise to Marcus and write a letter of apology to Miss Taylor.",
            quality: "poor",
            trust: -5,
            score: 0,
            studentResponse: "Fine. Whatever. Can I write it now and go?",
            coachNote: "Imposing specific actions removes Kyle's agency and turns restoration into a task to complete. Restorative practice requires the young person to identify what needs to happen themselves. A forced apology has little meaning.",
            emotion: "Compliant but disengaged"
          },
          {
            text: "What do you think you could do to make things better?",
            quality: "ok",
            trust: 5,
            score: 2,
            studentResponse: "Say sorry to Marcus, I suppose. And maybe Miss Taylor too.",
            coachNote: "A reasonable question but quite vague. Being more specific about who was affected helps the student think concretely about different types of harm and different types of repair. The response is a bit generic as a result.",
            emotion: "Willing but surface-level"
          }
        ]
      },
      // STAGE 5: Moving Forward
      {
        narration: "The conversation is nearing its end. Time to help Kyle plan for the future.",
        studentOpener: "I don't wanna be in this situation again. It's not worth it.",
        options: [
          {
            text: "That's a really mature thing to say, Kyle. So if you found yourself in a similar situation -- someone saying things that really got to you -- what would you do differently? What would help you make a different choice?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "I think... I need to actually tell someone when it's happening, not just let it build up. Like, if Marcus or anyone starts again, I need to go to my form tutor or you or someone, instead of just getting more and more angry until I snap. And maybe... like, is there someone I could talk to about dealing with my temper? Because I know I go from zero to a hundred dead fast.",
            coachNote: "Outstanding closing. You affirmed his insight, used a concrete hypothetical, and asked what support he would need. Kyle's response shows deep reflection -- he identified both a strategy (telling someone) and a personal development need (managing anger). This is genuine restorative thinking.",
            emotion: "Hopeful, self-aware"
          },
          {
            text: "Good. Let's make sure there's no repeat of this, OK? If there's any more fighting, it'll be a fixed-term exclusion.",
            quality: "poor",
            trust: -8,
            score: 0,
            studentResponse: "*face hardens* Right. Yeah. Got it.",
            coachNote: "Ending with a threat undoes much of the restorative work. Kyle shuts down because the conversation has returned to a punitive frame. The future-planning stage should be about building capacity and support, not issuing warnings.",
            emotion: "Shut down, resentful"
          },
          {
            text: "What will you do differently if something like this happens again?",
            quality: "ok",
            trust: 4,
            score: 2,
            studentResponse: "Walk away, I guess. Tell a teacher. I dunno.",
            coachNote: "The right question but it could be more scaffolded. Kyle gives stock answers rather than personalised strategies. Adding 'what would help you make that choice?' or 'what support would you need?' would deepen the reflection.",
            emotion: "Compliant"
          }
        ]
      }
    ],
    emotionOptimal: "Hopeful, self-aware, and genuinely wanting to make things right",
    emotionPoor: "Resentful, shut down, and viewing the process as just another punishment"
  },

  // ===== SCENARIO 1: Amira - Persistent Low-Level Disruption =====
  {
    title: "Persistent Low-Level Disruption",
    studentName: "Amira",
    studentYear: "Year 8",
    studentDetail: "On behaviour report for persistent disruption over 2 weeks",
    avatarColor: "#d97706",
    avatarLetter: "A",
    introContext: "Amira is a Year 8 student who has been persistently disrupting lessons for the past two weeks -- talking over the teacher, calling out, distracting other students, and refusing to complete work. Several teachers have raised concerns. She has been placed on a behaviour report. What staff don't yet know is that Amira's parents are going through a separation, and she is struggling to cope. She is usually a sociable, bright student who has never been in serious trouble before. You are meeting with her during Period 3 for a restorative conversation.",
    introStudentDesc: "Amira is usually chatty and popular. Recently she's been irritable, tearful at home, and unable to concentrate. She is embarrassed about the behaviour report and worried about people finding out what's happening at home.",
    startTrust: 40,
    startEmotion: "Embarrassed and guarded",
    stages: [
      // STAGE 0: Setting the Scene
      {
        narration: "Amira comes in and sits down. She's fiddling with the sleeve of her blazer and avoiding eye contact. She looks smaller than usual.",
        studentOpener: "*barely audible* Am I in more trouble?",
        options: [
          {
            text: "No, Amira. You're not in trouble right now. I've asked to see you because I've noticed things haven't been great for you recently, and I wanted to check in. Whatever we talk about stays between us unless I'm worried about your safety. Is that OK?",
            quality: "good",
            trust: 14,
            score: 3,
            studentResponse: "*looks up briefly, surprised* ... You've noticed? I thought everyone was just annoyed at me.",
            coachNote: "Excellent. Leading with care rather than behaviour immediately changes the dynamic. Naming confidentiality upfront is crucial when underlying issues might be sensitive. 'Check in' signals support, not interrogation.",
            emotion: "Surprised, slightly hopeful"
          },
          {
            text: "Come in, Amira. Have a seat. I wanted to talk to you about what's been going on in your lessons recently.",
            quality: "ok",
            trust: 3,
            score: 2,
            studentResponse: "*sits down stiffly* I know. I've been getting told off loads. I'm on report, aren't I? Everyone keeps going on about it.",
            coachNote: "Neutral but you've jumped straight to behaviour, which is what Amira expects and dreads. She's already framing this as another telling-off. A warmer, more personal opening would help her feel this is different from previous conversations.",
            emotion: "Bracing for criticism"
          },
          {
            text: "Amira, several teachers have raised concerns about your behaviour. You're on report now, which should tell you how serious this is.",
            quality: "poor",
            trust: -10,
            score: 0,
            studentResponse: "*eyes fill with tears, looks away* I know. I know I've been rubbish. Can I just go back to class?",
            coachNote: "Leading with the weight of multiple teachers' complaints is overwhelming for a student who is already struggling. Amira immediately wants to escape. The underlying issues are now much harder to reach because she feels attacked, not supported.",
            emotion: "Upset, wants to flee"
          },
          {
            text: "Amira, first of all -- are you alright? Genuinely. I'm not asking about lessons or reports. I'm asking about you.",
            quality: "good",
            trust: 16,
            score: 3,
            studentResponse: "*chin wobbles* ... *long pause* ... Not really, miss. No.",
            coachNote: "Powerful and direct. By explicitly separating this from academic/behaviour concerns, you've signalled that Amira matters as a person. The simple, genuine 'are you alright?' cuts through the noise. Her honest response shows the door is opening.",
            emotion: "Emotional, on the verge of opening up"
          }
        ]
      },
      // STAGE 1: Tell the Story
      {
        narration: "Amira is starting to let her guard down, though she's still uncertain.",
        studentOpener: "I don't really know what to say. I know I've been annoying in lessons.",
        options: [
          {
            text: "Forget about lessons for a minute. I'm interested in you. Can you tell me what's been going on recently? Not just at school -- just... how things have been for you.",
            quality: "good",
            trust: 12,
            score: 3,
            studentResponse: "*long silence, then quietly* ... Things at home aren't great. My mum and dad are... they're splitting up. And it's been really bad at home. They argue every night and my little brother cries and I have to take him upstairs and... *voice cracks* Sorry. I haven't told anyone.",
            coachNote: "By explicitly broadening the conversation beyond school and giving Amira permission to talk about whatever matters, you created space for the real issue to emerge. 'I haven't told anyone' tells you this disclosure is a big moment of trust.",
            emotion: "Vulnerable, trusting you"
          },
          {
            text: "What's been happening in your lessons? Teachers have said you've been calling out and not doing your work.",
            quality: "ok",
            trust: 0,
            score: 1,
            studentResponse: "*shrugs defensively* I dunno. I just can't concentrate. Everything's annoying and I just... I can't sit there doing worksheets about rivers when... *stops herself* It doesn't matter.",
            coachNote: "Asking about lesson behaviour keeps the focus on symptoms rather than causes. Amira nearly disclosed what's really going on but pulled back because the conversation feels too focused on her conduct. You'll need to work harder to reach the underlying issue.",
            emotion: "Frustrated, guarded"
          },
          {
            text: "You need to explain to me why your behaviour has changed so much. What's going on?",
            quality: "poor",
            trust: -8,
            score: 0,
            studentResponse: "I don't need to explain anything! You don't know what it's like! *crosses arms* Everyone just keeps having a go at me and no one even asks if I'm OK.",
            coachNote: "'You need to explain' is demanding and positions you as an authority figure requiring answers. Amira's outburst actually reveals what she needs -- someone to ask if she's OK -- but she's now too defensive to share voluntarily.",
            emotion: "Angry, feeling unheard"
          }
        ]
      },
      // STAGE 2: Explore the Impact
      {
        narration: "Whether or not Amira has fully disclosed, you need to help her see the impact of the classroom disruption while remaining sensitive to what's underneath.",
        studentOpener: "I know I've been a pain. I'm not stupid. I can see teachers getting fed up with me.",
        options: [
          {
            text: "It sounds like you're carrying a lot right now, and that makes sense. I want to gently ask though -- when you think about the lessons where things haven't gone well, who else do you think might have been affected? Not to make you feel bad, but just to think about it.",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "*thinks* ... The other kids, I suppose. Like, Priya was getting annoyed with me in science because she was trying to listen and I kept talking. And... Mrs Chen. She's actually nice and I could see she was upset when I kicked off in her lesson on Monday. I didn't mean to upset her, I just... I couldn't sit still.",
            coachNote: "Beautifully handled. You acknowledged her emotional burden, named your intention (not to make her feel bad), and asked an open impact question. Amira was able to reflect honestly because she felt held, not judged. She's naming specific people and showing empathy.",
            emotion: "Reflective, showing care for others"
          },
          {
            text: "Do you think your behaviour has been affecting other students' learning?",
            quality: "ok",
            trust: 2,
            score: 2,
            studentResponse: "Probably, yeah. I mean, I know Priya was getting annoyed. And some of the quiet kids look uncomfortable when I get told off.",
            coachNote: "A closed question that gets a 'probably, yeah' rather than genuine reflection. It also focuses only on other students. A more open question would help Amira think about the wider impact, including on staff and on herself.",
            emotion: "Compliant"
          },
          {
            text: "Well, seven teachers have reported issues, Amira. That affects a lot of people.",
            quality: "poor",
            trust: -8,
            score: 0,
            studentResponse: "*tears up* I know! I know everyone hates me right now! You don't need to keep saying it. *puts her head down*",
            coachNote: "Citing the number of complaints is shaming, not restorative. Amira is already aware she's causing problems. Piling on makes her feel overwhelmed and hopeless rather than empowered to change. This could also damage trust beyond repair if she's hiding a safeguarding issue.",
            emotion: "Overwhelmed, shutting down"
          }
        ]
      },
      // STAGE 3: Take Responsibility
      {
        narration: "Amira is engaging with the conversation. Guide her toward owning her part while recognising the context.",
        studentOpener: "It's not like I'm doing it on purpose though. I'm not trying to ruin anyone's lesson.",
        options: [
          {
            text: "I believe you, and what's happening at home is really hard. At the same time, even when things aren't our fault, our actions still affect other people. What part do you think you've played in how things have been in lessons, even if you didn't mean to?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "*nods slowly* I've been taking it out on everyone, haven't I? Like, I'm angry at home but I'm bringing it into school and being horrible to teachers who haven't done anything wrong. Mrs Chen asked me nicely to open my book and I told her to shut up. That was well out of order. I was just... I was already upset before I even got to school that day.",
            coachNote: "Excellent balance. You validated both the difficulty and the need for responsibility. The phrase 'even when things aren't our fault, our actions still affect people' is a key restorative principle. Amira can own her behaviour without feeling her pain is dismissed.",
            emotion: "Genuinely owning it, self-aware"
          },
          {
            text: "That's not an excuse though, is it, Amira? Lots of people have difficult things going on at home.",
            quality: "poor",
            trust: -12,
            score: 0,
            studentResponse: "*face crumples* I'm not making excuses! I'm telling you what's wrong! You asked me and now you're throwing it back at me? ... Can I go?",
            coachNote: "Devastating. Amira took a risk by sharing something vulnerable, and this response dismisses it. 'Lots of people have difficult things going on' minimises her specific pain. She now feels betrayed for having opened up. This could seriously damage the relationship.",
            emotion: "Betrayed, completely shut down"
          },
          {
            text: "I understand it's hard, but can you see that your behaviour hasn't been acceptable?",
            quality: "ok",
            trust: 0,
            score: 1,
            studentResponse: "Yeah. I know. I've been horrible.",
            coachNote: "This gets compliance but not genuine reflection. 'Can you see that it hasn't been acceptable?' is a leading question seeking agreement. Amira's 'I've been horrible' is self-punishing rather than constructive. Guide her to own specific actions rather than global self-criticism.",
            emotion: "Self-critical rather than reflective"
          }
        ]
      },
      // STAGE 4: Repair & Restore
      {
        narration: "Amira is being honest and reflective. Help her think about what could help repair things.",
        studentOpener: "I feel bad about Mrs Chen especially. She's always been nice to me.",
        options: [
          {
            text: "That says a lot about you that you care about that. What do you think might help put things right with Mrs Chen, and with your other teachers? And what support do you think you might need so things can start getting better for you?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "Maybe I could talk to Mrs Chen? Like, not in front of everyone, but just tell her I'm sorry and that it wasn't about her. And maybe... could I tell my teachers that things are hard at home without having to tell them exactly what? Like, so they know I'm not just being horrible for no reason? And... *very quietly* I think I might need to talk to someone. About the home stuff. I don't know who though.",
            coachNote: "Brilliant. Pairing repair with support is essential for Amira's scenario. She's generated meaningful actions: personal apology, contextual information for teachers, and -- crucially -- asked for pastoral support. The question about what support she needs opened a vital door.",
            emotion: "Taking initiative, asking for help"
          },
          {
            text: "I think you should apologise to Mrs Chen and the other teachers you've disrupted.",
            quality: "poor",
            trust: -4,
            score: 0,
            studentResponse: "*looks uncomfortable* All of them? But some of them don't even like me anyway. I'll say sorry to Mrs Chen though.",
            coachNote: "Imposed apologies feel like punishment, not restoration. The blanket instruction to apologise to all teachers is overwhelming and doesn't help Amira think about what meaningful repair looks like. She should be guiding this process, not you.",
            emotion: "Reluctant, overwhelmed"
          },
          {
            text: "Is there anything you think would help make things better with your teachers?",
            quality: "ok",
            trust: 4,
            score: 2,
            studentResponse: "I could say sorry to Mrs Chen, I suppose. And try harder in lessons.",
            coachNote: "A reasonable question, but 'try harder' is vague and unsustainable without support. You've focused only on repair with teachers without addressing what Amira needs. For a student struggling at home, repair must include a support plan, not just apologies.",
            emotion: "Willing but unsupported"
          }
        ]
      },
      // STAGE 5: Moving Forward
      {
        narration: "The conversation has been productive. Help Amira plan for how things can be different going forward.",
        studentOpener: "I don't want to keep getting in trouble. It's making everything worse.",
        options: [
          {
            text: "I can hear that, and I think you've been really brave today talking about all of this. Looking ahead -- if you're having a bad day, or things at home feel too much, what could you do differently at school? And how can we help you with that?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "Maybe I could... like, have somewhere to go if it gets too much? Instead of kicking off in a lesson? Like, if I feel like I'm about to lose it, I could go to the wellbeing room or come find you? And maybe... could we sort out someone for me to talk to about the home stuff? Because I'm not sleeping and I can't concentrate and I don't know how to make it better on my own.",
            coachNote: "Perfect ending. Affirming her courage, asking about strategies AND support, and using 'we' to show partnership. Amira's response is mature and specific -- she's identified an exit strategy, a safe person, and a need for pastoral support. This is genuine restorative success.",
            emotion: "Hopeful, supported, relieved"
          },
          {
            text: "Right, so you'll stay on the behaviour report for now, and we'll review it in a week. I need to see improvement.",
            quality: "poor",
            trust: -10,
            score: 0,
            studentResponse: "*face falls* ... Right. OK. A week. Fine.",
            coachNote: "Ending with the report and a demand for improvement is entirely punitive. After everything Amira has shared, this tells her the system cares more about her conduct data than her wellbeing. The emotional connection built during the conversation is at risk of being undone.",
            emotion: "Deflated, feels unsupported"
          },
          {
            text: "What will you do differently in lessons from now on?",
            quality: "ok",
            trust: 3,
            score: 2,
            studentResponse: "Try to concentrate more. Not call out. Just keep my head down, I suppose.",
            coachNote: "Amira's 'keep my head down' is a survival strategy, not a plan. Without discussing support systems, safe spaces, or pastoral care, you're asking a struggling child to simply endure. The moving forward stage should build capacity and wrap-around support, not just seek behaviour compliance.",
            emotion: "Compliant but unsupported"
          }
        ]
      }
    ],
    emotionOptimal: "Relieved, supported, and hopeful -- with a clear plan for pastoral support and repair",
    emotionPoor: "Shut down, feeling the system only cares about behaviour data, unlikely to seek help"
  },

  // ===== SCENARIO 2: Jayden - Damage to Property =====
  {
    title: "Damage to Property",
    studentName: "Jayden",
    studentYear: "Year 10",
    studentDetail: "Kicked a door and broke a window after being denied a school trip",
    avatarColor: "#2563eb",
    avatarLetter: "J",
    introContext: "Jayden is a Year 10 student who was told this morning that he would not be allowed to attend the residential trip next week due to accumulated behaviour points. He became very upset, stormed out of the room, kicked a fire door (denting it), and punched a corridor window which cracked. A member of staff guided him to a quiet room. He has now calmed down but is still angry. He feels the decision is unfair because he had been 'trying really hard' for the past month. You are meeting with him once he has had time to settle.",
    introStudentDesc: "Jayden has had a challenging year behaviourally but has genuinely been making an effort recently. He was excited about the trip and saw it as a reward for his improvement. He feels let down by the school and that his recent effort has been ignored.",
    startTrust: 40,
    startEmotion: "Calm but simmering anger, sense of injustice",
    stages: [
      // STAGE 0: Setting the Scene
      {
        narration: "Jayden is sitting with his hands flat on the table, staring at them. There's a small cut on his knuckle from the window. He looks up as you come in.",
        studentOpener: "Before you start, I already know I'm not going on the trip and I've probably made it worse. So.",
        options: [
          {
            text: "Jayden, I can see you've hurt your hand -- are you OK? Before we talk about anything, let me make sure that cut's been looked at. And just so you know, this conversation isn't about the trip decision. I want to understand what happened and how you're feeling. We'll be honest with each other and take turns. Sound alright?",
            quality: "good",
            trust: 14,
            score: 3,
            studentResponse: "*looks at his hand* It's fine. It's nothing. *pause* You actually want to know how I'm feeling? Because no one's asked me that today. They just told me I can't go and then everyone acted like I was the problem.",
            coachNote: "Outstanding opening. Noticing the injury shows care for Jayden as a person. Separating this conversation from the trip decision is crucial -- he's expecting a lecture. Establishing ground rules and focusing on understanding rather than judging changes the entire dynamic.",
            emotion: "Surprised, guarded but willing"
          },
          {
            text: "Alright, Jayden. Let's have a chat about what happened this morning.",
            quality: "ok",
            trust: 3,
            score: 2,
            studentResponse: "*sighs* Yeah, go on then. What do you want me to say?",
            coachNote: "Functional but flat. Jayden expects a standard conversation that ends with punishment. Without warmth, care for his injury, or clear ground rules, he has no reason to believe this will be different. 'What do you want me to say?' shows he's in compliance mode, not engagement mode.",
            emotion: "Resigned, passive"
          },
          {
            text: "Jayden, breaking a window and damaging a door is serious. You could have hurt yourself or someone else. We need to discuss this.",
            quality: "poor",
            trust: -10,
            score: 0,
            studentResponse: "*jaw tightens* Yeah, cheers. Really helpful. Do you want to tell me how disappointed you are as well? Get in the queue.",
            coachNote: "Leading with the seriousness of the damage and the risk is a safety lecture, not a restorative opening. Jayden has already heard this from others. He's now even more entrenched in his defensive position. The opportunity for genuine dialogue has narrowed significantly.",
            emotion: "Hostile, sarcastic"
          },
          {
            text: "Jayden, first things first -- that hand. Has someone cleaned that up? *pause* Good. Now, I know today has been really tough. I'm not here to lecture you. I'd like us to talk honestly, and I'll listen properly. The only rules are honesty and respect -- from both of us. Can we agree on that?",
            quality: "good",
            trust: 16,
            score: 3,
            studentResponse: "*flexes his hand, winces* Yeah. That's... yeah, we can do that. It's just... you know how hard I've been trying, yeah? Like, I've actually been trying. And it feels like none of that mattered.",
            coachNote: "Superb. The physical care, the acknowledgement of difficulty, and the emphasis on mutual respect and honesty all build trust rapidly. 'From both of us' signals equality. Jayden immediately moves beyond defensiveness to sharing what's really bothering him -- the perceived unfairness.",
            emotion: "Opening up, feels heard"
          }
        ]
      },
      // STAGE 1: Tell the Story
      {
        narration: "Jayden is settling into the conversation, though the injustice is clearly still burning.",
        studentOpener: "I bet they told you I just lost it for no reason.",
        options: [
          {
            text: "I'd rather hear it from you. In your own words, Jayden -- talk me through what happened this morning, from the start.",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "Right. So I've been proper trying, yeah? Ask anyone. I've not had a single detention in three weeks. I've been doing my homework. I even apologised to Mr Harris after that thing last term. And I was so buzzing about the trip because I thought it was like... proof that things were getting better. Then Mrs Okoro pulls me aside before Period 1 and just goes 'Sorry Jayden, you can't go, you've got too many points.' Just like that. No warning, nothing. And everyone else is talking about what they're packing and I'm just standing there like an idiot. So yeah, I lost it. I went out and I kicked the door and I punched the window. Which was stupid, I know. But it felt like nothing I do matters.",
            coachNote: "Perfect. 'I'd rather hear it from you' signals you haven't prejudged. The open prompt gets Jayden's full narrative, including the crucial context about his recent effort and the way the news was delivered. 'It felt like nothing I do matters' is the emotional core of this scenario.",
            emotion: "Passionate, emotional, honest"
          },
          {
            text: "Tell me what happened with the door and the window.",
            quality: "ok",
            trust: 2,
            score: 1,
            studentResponse: "I kicked the door and punched the window. Innit. That's what happened. *pause* But no one cares about why, do they?",
            coachNote: "Too narrow. By focusing only on the property damage, you've asked Jayden to recount the bit he already feels worst about without the context. His pushback ('no one cares about why') tells you he needs to be asked about the full story, not just the destructive moment.",
            emotion: "Frustrated, feeling unheard"
          },
          {
            text: "I've already been briefed on what happened. I know about the damage. I want to know why you thought that was an appropriate response.",
            quality: "poor",
            trust: -10,
            score: 0,
            studentResponse: "Appropriate? Are you serious? Was it appropriate to tell me I can't go on a trip after I've been busting my back to be good? No one cares about what's appropriate when it comes to treating me like rubbish, do they?",
            coachNote: "'I've already been briefed' tells Jayden the story is already decided. 'Why you thought that was an appropriate response' is a rhetorical question dripping with judgement. Jayden is now arguing the case rather than reflecting. The word 'appropriate' is dismissive and patronising.",
            emotion: "Furious, combative"
          }
        ]
      },
      // STAGE 2: Explore the Impact
      {
        narration: "Jayden has shared his story. Now help him think about who was affected by his actions, while acknowledging his feelings.",
        studentOpener: "I know I shouldn't have smashed the window. I'm not an idiot. I was just so angry.",
        options: [
          {
            text: "I get that, and your anger about the trip makes sense -- we can talk about that. But I want you to think about the moment when you kicked the door and hit the window. Who was around? Who might have been affected by what happened?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "*thinks* There were some kids in the corridor. Year 7s, I think. And that new TA -- Miss... Miss Williams? She looked proper scared. She didn't know what to do. And Mr Peters came running out of his classroom looking stressed. *quieter* And I could've cut my hand well bad, actually. My mum would've... *trails off* She'd be gutted if I'd properly hurt myself.",
            coachNote: "Excellent. You validated his anger as understandable while redirecting to impact. Asking specifically 'who was around?' helps him visualise the scene. He identified scared younger students, a frightened staff member, and risk to himself. Mentioning his mum shows emotional depth.",
            emotion: "Reflective, concerned about others"
          },
          {
            text: "Do you think the school should have to pay to fix the damage you caused?",
            quality: "poor",
            trust: -6,
            score: 0,
            studentResponse: "Oh what, so this is about money now? Great. Is that all the school cares about? The window costs more than caring about how students feel, does it?",
            coachNote: "Framing impact as financial cost is reductive and provocative. Jayden immediately sees this as the school prioritising property over his wellbeing, which reinforces his sense of injustice. Impact should be explored in human terms -- who was scared, upset, or affected -- not financial ones.",
            emotion: "Bitter, more entrenched"
          },
          {
            text: "Who do you think was affected by what you did?",
            quality: "ok",
            trust: 4,
            score: 2,
            studentResponse: "The school, I guess? Like, the door and the window. And whoever had to deal with me. The TA looked a bit freaked out.",
            coachNote: "A sound question but quite blunt without emotional scaffolding. Jayden gives a somewhat surface-level answer focused on the physical damage rather than the human impact. Acknowledging his feelings first, and then being more specific about the scene, would draw out deeper reflection.",
            emotion: "Thinking but not deeply"
          }
        ]
      },
      // STAGE 3: Take Responsibility
      {
        narration: "Jayden is showing signs of reflection. Now help him own his part while holding space for the legitimate frustration.",
        studentOpener: "I still think the trip thing was unfair though. I had been trying.",
        options: [
          {
            text: "And I hear you on that, Jayden -- I really do. Your effort recently has been noticed, and we should talk about how that gets recognised. But separate from the trip decision, which is a separate conversation -- what part did you play in what happened in that corridor this morning?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "*long pause* ... I lost control. Proper lost it. And that's on me. No one made me kick that door or punch that window. I chose to do that, even if I was angry. And I could've hurt Miss Williams or one of them Year 7s if I'd... like, if a piece of glass had come off or something. I didn't think about any of that. I just wanted to smash something.",
            coachNote: "Masterfully balanced. You validated his effort AND his grievance, committed to a future conversation about the trip, and then clearly separated the property damage as a distinct issue for him to own. Jayden takes full, genuine responsibility because he doesn't feel his feelings are being dismissed.",
            emotion: "Genuinely taking responsibility"
          },
          {
            text: "But Jayden, you can't just break things when you're angry. You know that.",
            quality: "poor",
            trust: -8,
            score: 0,
            studentResponse: "Obviously I know that! Do you think I'm proud of it? I'm just saying, if the school hadn't mugged me off over the trip, none of this would've happened!",
            coachNote: "This is a statement, not a question, and it's patronising. 'You know that' implies Jayden is stupid. He deflects back to the trip because you haven't acknowledged his point. He can't move to responsibility while his legitimate frustration is being dismissed.",
            emotion: "Defensive, blaming the school"
          },
          {
            text: "Regardless of how you feel about the trip, what did you do that was wrong?",
            quality: "ok",
            trust: 2,
            score: 1,
            studentResponse: "I broke a window and dented a door. And I scared people. I know that.",
            coachNote: "'Regardless of how you feel' is dismissive of his emotions. 'What did you do wrong?' gets factual compliance but not reflective ownership. The response lists actions rather than showing genuine understanding of impact. Acknowledging feelings first creates the space for genuine responsibility.",
            emotion: "Flat, compliant"
          }
        ]
      },
      // STAGE 4: Repair & Restore
      {
        narration: "Jayden is owning his actions. Guide him toward making things right.",
        studentOpener: "I know I need to sort this out. I just don't know how you fix a broken window, like, emotionally. *half smiles*",
        options: [
          {
            text: "*smiles gently* Well, let's think about it. You mentioned Miss Williams, the Year 7 students, Mr Peters -- and yourself. What do you think needs to happen to start putting things right with each of those people? And is there anything else you think should happen?",
            quality: "good",
            trust: 10,
            score: 3,
            studentResponse: "I should definitely talk to Miss Williams. She's new and I probably properly scared her. I could explain I wasn't gonna hurt anyone, I was just... yeah. And Mr Peters -- I've got him for English and he's sound, so I could say sorry for making him have to deal with that. The Year 7s... maybe if they see me being normal and not, like, some scary angry kid? *pause* And the door and window -- I mean, I can't pay for it but maybe I could do something? Like, help the site team or something? Show I'm not just gonna break stuff and walk off?",
            coachNote: "Excellent. Naming specific people prompted specific repair actions. Jayden's suggestion to help the site team shows creative, genuine restoration beyond just verbal apologies. His desire for the Year 7s to see him 'being normal' shows awareness of his reputation impact. The humour earlier was a positive sign of rapport.",
            emotion: "Proactive, constructive"
          },
          {
            text: "You'll need to pay for the window repair, and you'll be in internal exclusion until we've sorted this out.",
            quality: "poor",
            trust: -8,
            score: 0,
            studentResponse: "*face darkens* Pay for it? My mum can't afford that! And internal exclusion? So first I can't go on the trip, now I'm being excluded? This school is a joke.",
            coachNote: "Imposing financial consequences and exclusion is purely punitive and destroys the restorative work. Jayden sees a pattern of the school punishing him while ignoring his effort and feelings. This will deepen his resentment and disengagement significantly.",
            emotion: "Furious, disengaged"
          },
          {
            text: "What do you think you should do to make up for the damage?",
            quality: "ok",
            trust: 4,
            score: 2,
            studentResponse: "Erm... say sorry? And maybe like... do some community service or whatever you call it? Help clean up or something?",
            coachNote: "Reasonable but vague. Without prompting Jayden to think about specific people, his repair plan is generic. 'Say sorry' and 'community service' are institutional responses, not personal restorative actions. Guide him to think about the humans involved.",
            emotion: "Willing but generic"
          }
        ]
      },
      // STAGE 5: Moving Forward
      {
        narration: "Jayden has engaged well with the repair process. Now help him build a plan for managing anger in the future -- and address the trip situation.",
        studentOpener: "I don't wanna be that guy who smashes things up. That's not who I am. I've been really trying.",
        options: [
          {
            text: "I know you have, Jayden, and that effort is real -- please don't feel it's been wasted. So let me ask: when you felt that wave of anger this morning, what do you think could have helped you handle it differently? And what support can we put in place so that when you hit a moment like that again -- because they will come -- you've got a better option than a fire door?",
            quality: "good",
            trust: 12,
            score: 3,
            studentResponse: "I think... I need to be able to go somewhere. Like, when it hit me, I just needed to get out of that corridor. If there was somewhere I could go to just be angry safely -- like, not hurt anything -- that would help. And maybe... could I talk to someone about the anger thing? Because it's not just about today. I've always been like this and I don't want to be. *pause* And... the trip thing. I know it's probably too late, but can someone at least look at my record from the last month? Because I really was trying. Even if I can't go, I just want someone to see that.",
            coachNote: "Outstanding closing. Validating his effort, asking about strategies AND support, and using humour keeps the conversation human. Jayden identifies a safe space, a desire for anger management support, and -- crucially -- asks for his recent effort to be recognised. The conversation ends with hope and a clear action plan.",
            emotion: "Hopeful, self-aware, feeling heard"
          },
          {
            text: "Well, next time you feel angry, just walk away and count to ten. Come and find a member of staff.",
            quality: "poor",
            trust: -5,
            score: 0,
            studentResponse: "Count to ten? *stares at you* Yeah. Sure. That'll fix everything. Thanks for the advice.",
            coachNote: "Generic anger management platitudes are deeply unhelpful and feel dismissive. 'Count to ten' trivialises what is clearly a significant anger management challenge. Jayden's sarcasm tells you the relationship has been damaged by this superficial response at a moment when he needed genuine support.",
            emotion: "Sarcastic, feels patronised"
          },
          {
            text: "What will you do differently next time you're feeling angry?",
            quality: "ok",
            trust: 4,
            score: 2,
            studentResponse: "Try to walk away, I suppose. Find somewhere to calm down. Maybe talk to someone instead of smashing things.",
            coachNote: "A reasonable question but Jayden gives stock answers without a concrete plan. The 'I suppose' suggests low commitment. Without discussing what support the school can provide and without addressing the trip grievance, the forward plan is weak and unlikely to hold.",
            emotion: "Compliant but uninspired"
          }
        ]
      }
    ],
    emotionOptimal: "Hopeful, self-aware, and trusting the school will support him -- with a clear plan for managing anger",
    emotionPoor: "Deeply resentful, viewing the school as an adversary, more likely to disengage entirely"
  }
];

// ========== STATE ==========
let currentScenario = null;
let currentStage = 0;
let trustLevel = 50;
let qualityScore = 0;
let maxQuality = 0;
let choices = [];
let studentEmotion = "";

// ========== FUNCTIONS ==========

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

function startScenario(idx) {
  currentScenario = idx;
  currentStage = 0;
  const sc = scenarios[idx];
  trustLevel = sc.startTrust;
  qualityScore = 0;
  maxQuality = sc.stages.length * 3;
  choices = [];
  studentEmotion = sc.startEmotion;

  const intro = document.getElementById('intro-content');
  intro.innerHTML = `
    <h2>${sc.title}</h2>
    <div class="intro-context">${sc.introContext}</div>
    <div class="intro-student">
      <div class="is-avatar" style="background:${sc.avatarColor}">${sc.avatarLetter}</div>
      <div class="is-text">
        <h4>${sc.studentName} -- ${sc.studentYear}</h4>
        <p>${sc.introStudentDesc}</p>
      </div>
    </div>
    <p style="font-size:0.9rem; color:var(--warm-700); margin-top:12px;">You will guide this conversation through six restorative stages. At each stage, choose how to respond. Your choices will affect the student's trust and willingness to engage.</p>
    <button class="btn-primary mt-4" onclick="beginSimulation()">Begin Conversation</button>
  `;
  showScreen('intro');
}

function beginSimulation() {
  showScreen('sim');
  updateStageBar();
  updateMeters();
  updateStudentCard();
  updateRQHighlights();
  document.getElementById('chat-area').innerHTML = '';
  document.getElementById('response-area').innerHTML = '';
  playStage();
}

function updateStageBar() {
  const bar = document.getElementById('stage-bar');
  let html = '';
  for (let i = 0; i < 6; i++) {
    let cls = 'stage-pip';
    if (i < currentStage) cls += ' completed';
    else if (i === currentStage) cls += ' current';
    html += `<div class="${cls}"></div>`;
  }
  html += `<span class="stage-label">Stage ${currentStage + 1}: ${STAGE_NAMES[currentStage]}</span>`;
  bar.innerHTML = html;
}

function updateMeters() {
  const tv = Math.max(0, Math.min(100, trustLevel));
  document.getElementById('trust-val').textContent = tv + '%';
  document.getElementById('trust-fill').style.width = tv + '%';
  if (tv < 30) document.getElementById('trust-fill').style.background = 'linear-gradient(90deg, #f87171, #ef4444)';
  else if (tv < 60) document.getElementById('trust-fill').style.background = 'linear-gradient(90deg, var(--amber-400), var(--amber-500))';
  else document.getElementById('trust-fill').style.background = 'linear-gradient(90deg, var(--blue-400), var(--blue-500))';

  const qv = maxQuality > 0 ? Math.round((qualityScore / maxQuality) * 100) : 0;
  document.getElementById('quality-val').textContent = qv + '%';
  document.getElementById('quality-fill').style.width = qv + '%';
}

function updateStudentCard() {
  const sc = scenarios[currentScenario];
  let emotionColor = '#fef3c7';
  let emotionTextColor = 'var(--amber-700)';
  if (trustLevel >= 60) { emotionColor = 'var(--green-100)'; emotionTextColor = 'var(--green-700)'; }
  else if (trustLevel < 30) { emotionColor = '#fee2e2'; emotionTextColor = 'var(--red-600)'; }

  document.getElementById('student-card').innerHTML = `
    <div class="student-profile">
      <div class="student-avatar" style="background:${sc.avatarColor}">${sc.avatarLetter}</div>
      <div class="student-info">
        <div class="si-name">${sc.studentName}</div>
        <div class="si-detail">${sc.studentYear} -- ${sc.studentDetail}</div>
      </div>
    </div>
    <div class="emotion-state" style="background:${emotionColor}; color:${emotionTextColor}">
      Current state: ${studentEmotion}
    </div>
  `;
}

function updateRQHighlights() {
  const highlights = STAGE_RQ_HIGHLIGHTS[currentStage] || [];
  const items = document.querySelectorAll('#rq-list li');
  items.forEach((li, i) => {
    li.classList.toggle('highlight', highlights.includes(i));
  });
}

function addMessage(type, name, text) {
  const chat = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = 'msg msg-' + type;
  if (type === 'narrator') {
    div.innerHTML = `<div class="msg-bubble">${text}</div>`;
  } else {
    div.innerHTML = `
      <div class="msg-bubble">
        <div class="msg-name">${name}</div>
        <div class="msg-text">${text}</div>
      </div>
    `;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function addCoachNote(text, quality) {
  const chat = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = `coach-note ${quality}`;
  div.innerHTML = `
    <div class="cn-label">Coach's Note</div>
    <div class="cn-text">${text}</div>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
  const chat = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = 'typing-indicator';
  div.id = 'typing';
  div.innerHTML = '<span></span><span></span><span></span>';
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function removeTyping() {
  const el = document.getElementById('typing');
  if (el) el.remove();
}

function playStage() {
  const sc = scenarios[currentScenario];
  const stage = sc.stages[currentStage];

  addMessage('narrator', '', stage.narration);

  setTimeout(() => {
    showTyping();
    setTimeout(() => {
      removeTyping();
      addMessage('student', sc.studentName, stage.studentOpener);
      showOptions(stage.options);
    }, 1200);
  }, 600);
}

function showOptions(options) {
  const area = document.getElementById('response-area');
  // Shuffle display order but track original index
  const indices = options.map((_, i) => i);
  // Shuffle
  for (let i = indices.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [indices[i], indices[j]] = [indices[j], indices[i]];
  }

  let html = '<div class="response-prompt">Choose your response:</div><div class="response-options">';
  indices.forEach(idx => {
    html += `<button class="response-btn" data-idx="${idx}" onclick="selectOption(${idx})">${options[idx].text}</button>`;
  });
  html += '</div>';
  area.innerHTML = html;
}

function selectOption(idx) {
  const sc = scenarios[currentScenario];
  const stage = sc.stages[currentStage];
  const option = stage.options[idx];

  // Disable all buttons and highlight selected
  document.querySelectorAll('.response-btn').forEach(btn => {
    btn.disabled = true;
    btn.style.cursor = 'default';
    btn.style.opacity = '0.5';
  });
  const selectedBtn = document.querySelector(`.response-btn[data-idx="${idx}"]`);
  selectedBtn.style.opacity = '1';
  selectedBtn.classList.add('selected-' + option.quality);

  // Add staff message
  addMessage('staff', 'You', option.text);

  // Update state
  trustLevel += option.trust;
  trustLevel = Math.max(0, Math.min(100, trustLevel));
  qualityScore += option.score;
  studentEmotion = option.emotion;
  choices.push({
    stage: currentStage,
    stageName: STAGE_NAMES[currentStage],
    optionIdx: idx,
    quality: option.quality,
    text: option.text,
    coachNote: option.coachNote,
    score: option.score
  });

  updateMeters();
  updateStudentCard();

  // Show student response after typing
  setTimeout(() => {
    showTyping();
    setTimeout(() => {
      removeTyping();
      addMessage('student', sc.studentName, option.studentResponse);

      // Show coach note
      setTimeout(() => {
        addCoachNote(option.coachNote, option.quality);

        // Show continue button
        const area = document.getElementById('response-area');
        if (currentStage < 5) {
          area.innerHTML = `<button class="continue-btn" onclick="nextStage()">Continue to Next Stage &#8594;</button>`;
        } else {
          area.innerHTML = `<button class="continue-btn" onclick="showSummary()">View Summary &#8594;</button>`;
        }
      }, 800);
    }, 1500);
  }, 500);
}

function nextStage() {
  currentStage++;
  updateStageBar();
  updateRQHighlights();
  document.getElementById('response-area').innerHTML = '';
  playStage();
}

function showSummary() {
  showScreen('summary');
  const sc = scenarios[currentScenario];
  const pct = Math.round((qualityScore / maxQuality) * 100);
  let award, awardClass, awardIcon;
  if (pct >= 80) { award = 'Gold'; awardClass = 'gold'; awardIcon = '\u2605'; }
  else if (pct >= 50) { award = 'Silver'; awardClass = 'silver'; awardIcon = '\u2606'; }
  else { award = 'Bronze'; awardClass = 'bronze'; awardIcon = '\u25CB'; }

  // Strengths & development areas
  const strengths = [];
  const developments = [];
  const goodCount = choices.filter(c => c.quality === 'good').length;
  const okCount = choices.filter(c => c.quality === 'ok').length;
  const poorCount = choices.filter(c => c.quality === 'poor').length;

  if (choices[0] && choices[0].quality === 'good') strengths.push('Strong opening that established safety and clear ground rules');
  if (choices[0] && choices[0].quality === 'poor') developments.push('The opening set a punitive tone -- focus on establishing safety and ground rules before discussing the incident');
  if (choices[1] && choices[1].quality === 'good') strengths.push('Used open questions effectively to let the student tell their story');
  if (choices[1] && choices[1].quality !== 'good') developments.push('Practise using open questions (e.g. "What happened?") rather than leading or closed questions when exploring the student\'s story');
  if (choices[2] && choices[2].quality === 'good') strengths.push('Helped the student explore impact on others while acknowledging their feelings');
  if (choices[2] && choices[2].quality === 'poor') developments.push('When exploring impact, avoid shaming or listing complaints -- guide the student to identify affected people themselves');
  if (choices[3] && choices[3].quality === 'good') strengths.push('Balanced validation of feelings with clear expectation of responsibility');
  if (choices[3] && choices[3].quality === 'poor') developments.push('Students need to feel heard before they can take responsibility -- validate feelings first, then guide toward ownership');
  if (choices[4] && choices[4].quality === 'good') strengths.push('Facilitated student-led repair actions rather than imposing solutions');
  if (choices[4] && choices[4].quality !== 'good') developments.push('Let the student identify how to make things right rather than telling them what to do -- this builds genuine ownership of the repair process');
  if (choices[5] && choices[5].quality === 'good') strengths.push('Created a concrete, supported plan for the future with the student\'s input');
  if (choices[5] && choices[5].quality === 'poor') developments.push('Avoid ending with threats or generic advice -- the moving forward stage should build capacity and identify support structures');

  if (goodCount >= 4) strengths.push('Consistently strong restorative practice throughout the conversation');
  if (trustLevel >= 70) strengths.push('Built a high level of trust with the student');
  if (poorCount >= 2) developments.push('Multiple responses were punitive or dismissive -- review the restorative questioning framework');
  if (trustLevel < 40) developments.push('Trust remained low throughout -- focus on warmth, validation, and genuine curiosity about the student\'s experience');

  if (strengths.length === 0) strengths.push('Engaged with the restorative conversation process');
  if (developments.length === 0) developments.push('Continue to develop and refine your already strong restorative practice');

  // Expert path
  const expertPath = sc.stages.map((stage, i) => {
    const best = stage.options.reduce((a, b) => a.score > b.score ? a : b);
    return { stageName: STAGE_NAMES[i], text: best.text };
  });

  // Emotion comparison
  const yourEmotion = studentEmotion;
  const optimalEmotion = sc.emotionOptimal;
  const poorEmotion = sc.emotionPoor;

  let html = `
    <div class="summary-header ${awardClass}">
      <div class="award-icon">${awardIcon} ${awardIcon} ${awardIcon}</div>
      <h2>${award} Award</h2>
      <div class="score-text">Restorative Quality: ${pct}% | Trust Level: ${Math.max(0, Math.min(100, trustLevel))}%</div>
    </div>
    <div class="summary-body">
      <div class="summary-section">
        <h3>Stage-by-Stage Breakdown</h3>
        <div class="stage-breakdown">
  `;
  choices.forEach(c => {
    const qLabel = c.quality === 'good' ? 'Excellent' : c.quality === 'ok' ? 'Adequate' : 'Needs Work';
    const qClass = c.quality === 'good' ? 'q-good' : c.quality === 'ok' ? 'q-ok' : 'q-poor';
    html += `
      <div class="sb-row">
        <div class="sb-stage">${c.stageName}</div>
        <div class="sb-choice">${truncate(c.text, 80)}</div>
        <span class="sb-quality ${qClass}">${qLabel}</span>
      </div>
    `;
  });
  html += `</div></div>`;

  html += `
    <div class="summary-section">
      <h3>Key Strengths</h3>
      <ul class="strengths-list">
        ${strengths.map(s => `<li>${s}</li>`).join('')}
      </ul>
    </div>
    <div class="summary-section">
      <h3>Areas for Development</h3>
      <ul class="dev-list">
        ${developments.map(d => `<li>${d}</li>`).join('')}
      </ul>
    </div>
  `;

  html += `
    <div class="summary-section">
      <h3>Student's Final Emotional State</h3>
      <div class="emotion-comparison">
        <div class="ec-card yours">
          <div class="ec-label">Your Outcome</div>
          <div class="ec-emotion">${yourEmotion}</div>
        </div>
        <div class="ec-card optimal">
          <div class="ec-label">Optimal Outcome</div>
          <div class="ec-emotion">${optimalEmotion}</div>
        </div>
      </div>
    </div>
  `;

  html += `
    <div class="summary-section">
      <h3>The Expert Path</h3>
      <p style="font-size:0.88rem; color:var(--warm-700); margin-bottom:12px;">These are the optimal responses at each stage, demonstrating best restorative practice:</p>
      <div class="expert-path">
        ${expertPath.map(ep => `
          <div class="ep-row">
            <div class="ep-stage-name">${ep.stageName}</div>
            <div class="ep-text">"${ep.text}"</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  html += `</div>`;
  html += `
    <div class="summary-actions">
      <button class="btn-primary" onclick="startScenario(${currentScenario})">Retry This Scenario</button>
      <button class="btn-secondary" onclick="backToMenu()">Choose Another Scenario</button>
    </div>
  `;

  document.getElementById('summary-content').innerHTML = html;
}

function truncate(str, len) {
  return str.length > len ? str.substring(0, len) + '...' : str;
}

function backToMenu() {
  showScreen('select');
}
</script>
</body>
</html>
