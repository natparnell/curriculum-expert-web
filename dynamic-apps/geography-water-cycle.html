<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water Cycle Interactive</title>
<style>
:root {
  --sky-light: #87CEEB;
  --sky-dark: #4A90C4;
  --cloud-white: #F0F0F0;
  --cloud-grey: #B0B0B0;
  --water-light: #4FC3F7;
  --water-mid: #2196F3;
  --water-deep: #1565C0;
  --water-ground: #0D47A1;
  --earth-light: #8D6E63;
  --earth-mid: #6D4C41;
  --earth-dark: #4E342E;
  --green-light: #81C784;
  --green-mid: #4CAF50;
  --green-dark: #2E7D32;
  --snow-white: #FAFAFA;
  --sun-yellow: #FFD54F;
  --sun-orange: #FFB300;
  --urban-grey: #78909C;
  --bg-panel: #F5F9FC;
  --text-primary: #263238;
  --text-secondary: #546E7A;
  --border-color: #CFD8DC;
  --accent: #0288D1;
  --accent-hover: #0277BD;
  --danger: #E53935;
  --warning: #F9A825;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-panel);
  color: var(--text-primary);
  line-height: 1.5;
}

header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(135deg, var(--sky-dark), var(--water-mid));
  color: white;
  padding: 14px 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}

header p {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-top: 2px;
}

.app-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.main-grid {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 20px;
  margin-bottom: 20px;
}

.canvas-wrapper {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  overflow: hidden;
  position: relative;
}

canvas {
  display: block;
  width: 100%;
  cursor: pointer;
}

.controls-panel {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.controls-panel h2 {
  font-size: 1.05rem;
  color: var(--text-primary);
  border-bottom: 2px solid var(--accent);
  padding-bottom: 8px;
}

.control-group label {
  display: block;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.control-group .slider-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.control-group input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  height: 6px;
  border-radius: 3px;
  background: var(--border-color);
  outline: none;
}

.control-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

.slider-value {
  min-width: 36px;
  text-align: right;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--accent);
}

.season-toggle {
  display: flex;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid var(--accent);
}

.season-btn {
  flex: 1;
  padding: 8px 4px;
  border: none;
  background: white;
  color: var(--accent);
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.season-btn.active {
  background: var(--accent);
  color: white;
}

.flow-rates {
  background: var(--bg-panel);
  border-radius: 8px;
  padding: 12px;
}

.flow-rates h3 {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.flow-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 0.78rem;
}

.flow-item .flow-label {
  color: var(--text-secondary);
}

.flow-item .flow-bar-wrap {
  width: 80px;
  height: 8px;
  background: var(--border-color);
  border-radius: 4px;
  overflow: hidden;
  margin: 0 8px;
  flex-shrink: 0;
}

.flow-item .flow-bar {
  height: 100%;
  border-radius: 4px;
  transition: width 0.4s ease;
}

.flow-item .flow-val {
  min-width: 28px;
  text-align: right;
  font-weight: 600;
  font-size: 0.75rem;
  color: var(--accent);
}

.info-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.info-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  padding: 20px;
}

.info-card h3 {
  font-size: 1rem;
  margin-bottom: 10px;
  color: var(--sky-dark);
  display: flex;
  align-items: center;
  gap: 8px;
}

.info-card h3 .icon {
  font-size: 1.2rem;
}

.info-card p, .info-card li {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

.info-card ul {
  padding-left: 18px;
  margin-top: 6px;
}

.info-card li { margin-bottom: 4px; }

.popup-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.35);
  z-index: 200;
  justify-content: center;
  align-items: center;
}

.popup-overlay.visible {
  display: flex;
}

.popup-box {
  background: white;
  border-radius: 12px;
  padding: 24px;
  max-width: 420px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  position: relative;
}

.popup-box h3 {
  font-size: 1.1rem;
  color: var(--sky-dark);
  margin-bottom: 8px;
}

.popup-box p {
  font-size: 0.88rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

.popup-close {
  position: absolute;
  top: 12px; right: 14px;
  background: none;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
  color: var(--text-secondary);
  line-height: 1;
}

.popup-close:hover { color: var(--text-primary); }

.legend-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 6px;
  padding-top: 10px;
  border-top: 1px solid var(--border-color);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.72rem;
  color: var(--text-secondary);
}

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

@media (max-width: 860px) {
  .main-grid {
    grid-template-columns: 1fr;
  }
  .controls-panel {
    order: 2;
  }
}

@media (max-width: 500px) {
  header { padding: 10px 16px; }
  header h1 { font-size: 1.2rem; }
  .app-container { padding: 12px; }
  .info-section { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<header>
  <h1>Water Cycle Interactive</h1>
  <p>Explore how temperature, vegetation, and urbanisation affect the water cycle</p>
</header>

<div class="app-container">
  <div class="main-grid">
    <div class="canvas-wrapper">
      <canvas id="cycleCanvas" width="800" height="500"></canvas>
    </div>

    <div class="controls-panel">
      <h2>Parameters</h2>

      <div class="control-group">
        <label>Temperature</label>
        <div class="slider-row">
          <input type="range" id="tempSlider" min="-10" max="40" value="15">
          <span class="slider-value" id="tempVal">15 C</span>
        </div>
      </div>

      <div class="control-group">
        <label>Vegetation Cover</label>
        <div class="slider-row">
          <input type="range" id="vegSlider" min="0" max="100" value="60">
          <span class="slider-value" id="vegVal">60%</span>
        </div>
      </div>

      <div class="control-group">
        <label>Urbanisation</label>
        <div class="slider-row">
          <input type="range" id="urbanSlider" min="0" max="100" value="20">
          <span class="slider-value" id="urbanVal">20%</span>
        </div>
      </div>

      <div class="control-group">
        <label>Season</label>
        <div class="season-toggle">
          <button class="season-btn active" data-season="summer" id="btnSummer">Summer</button>
          <button class="season-btn" data-season="winter" id="btnWinter">Winter</button>
        </div>
      </div>

      <div class="flow-rates">
        <h3>Flow Rates</h3>
        <div class="flow-item">
          <span class="flow-label">Evaporation</span>
          <div class="flow-bar-wrap"><div class="flow-bar" id="barEvap" style="width:50%;background:var(--water-light)"></div></div>
          <span class="flow-val" id="valEvap">50</span>
        </div>
        <div class="flow-item">
          <span class="flow-label">Transpiration</span>
          <div class="flow-bar-wrap"><div class="flow-bar" id="barTransp" style="width:30%;background:var(--green-mid)"></div></div>
          <span class="flow-val" id="valTransp">30</span>
        </div>
        <div class="flow-item">
          <span class="flow-label">Precipitation</span>
          <div class="flow-bar-wrap"><div class="flow-bar" id="barPrecip" style="width:40%;background:var(--water-mid)"></div></div>
          <span class="flow-val" id="valPrecip">40</span>
        </div>
        <div class="flow-item">
          <span class="flow-label">Runoff</span>
          <div class="flow-bar-wrap"><div class="flow-bar" id="barRunoff" style="width:25%;background:var(--earth-light)"></div></div>
          <span class="flow-val" id="valRunoff">25</span>
        </div>
        <div class="flow-item">
          <span class="flow-label">Infiltration</span>
          <div class="flow-bar-wrap"><div class="flow-bar" id="barInfilt" style="width:35%;background:var(--earth-mid)"></div></div>
          <span class="flow-val" id="valInfilt">35</span>
        </div>
        <div class="flow-item">
          <span class="flow-label">Groundwater</span>
          <div class="flow-bar-wrap"><div class="flow-bar" id="barGround" style="width:20%;background:var(--water-ground)"></div></div>
          <span class="flow-val" id="valGround">20</span>
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-item"><div class="legend-dot" style="background:#4FC3F7"></div>Evaporation</div>
        <div class="legend-item"><div class="legend-dot" style="background:#81C784"></div>Transpiration</div>
        <div class="legend-item"><div class="legend-dot" style="background:#2196F3"></div>Rain</div>
        <div class="legend-item"><div class="legend-dot" style="background:#FAFAFA;border:1px solid #ccc"></div>Snow</div>
        <div class="legend-item"><div class="legend-dot" style="background:#8D6E63"></div>Runoff</div>
        <div class="legend-item"><div class="legend-dot" style="background:#0D47A1"></div>Groundwater</div>
      </div>
    </div>
  </div>

  <div class="info-section">
    <div class="info-card">
      <h3><span class="icon">&#9748;</span> Water Cycle Processes</h3>
      <p>The water cycle (hydrological cycle) is the continuous movement of water through the Earth system:</p>
      <ul>
        <li><strong>Evaporation:</strong> Solar energy heats water surfaces, turning liquid water into vapour that rises into the atmosphere.</li>
        <li><strong>Transpiration:</strong> Plants absorb water through roots and release vapour through leaves, adding moisture to the air.</li>
        <li><strong>Condensation:</strong> Water vapour cools as it rises, forming tiny droplets that cluster into clouds.</li>
        <li><strong>Precipitation:</strong> When cloud droplets grow heavy enough, they fall as rain, snow, sleet, or hail.</li>
        <li><strong>Surface runoff:</strong> Water flows over land, collecting in streams and rivers that feed lakes and oceans.</li>
        <li><strong>Infiltration:</strong> Water soaks into the ground, passing through soil and rock to recharge underground aquifers.</li>
        <li><strong>Groundwater flow:</strong> Water moves slowly through permeable rock layers, eventually feeding springs and rivers.</li>
      </ul>
    </div>

    <div class="info-card">
      <h3><span class="icon">&#127961;</span> Human Activity and the Water Cycle</h3>
      <p>Human actions significantly alter the natural water cycle:</p>
      <ul>
        <li><strong>Deforestation:</strong> Removing trees reduces transpiration and increases surface runoff, lowering local rainfall and raising flood risk.</li>
        <li><strong>Urbanisation:</strong> Concrete and tarmac create impermeable surfaces. Rainwater cannot infiltrate, so it rushes across surfaces into drains, increasing peak river discharge.</li>
        <li><strong>Climate change:</strong> Rising temperatures accelerate evaporation and alter precipitation patterns, creating more intense rainfall events alongside longer droughts.</li>
        <li><strong>Agriculture:</strong> Irrigation extracts groundwater faster than it recharges. Soil compaction from machinery also reduces infiltration.</li>
        <li><strong>Water abstraction:</strong> Extracting water from rivers and aquifers for drinking, industry, and farming can deplete reserves and lower water tables.</li>
      </ul>
    </div>

    <div class="info-card">
      <h3><span class="icon">&#127754;</span> Flood Risk and Urbanisation</h3>
      <p>Urban areas face amplified flood risk because:</p>
      <ul>
        <li><strong>Impermeable surfaces</strong> (roads, roofs, car parks) prevent infiltration, channelling almost all rainfall directly into drains and rivers.</li>
        <li><strong>Faster lag times:</strong> Water reaches rivers much more quickly in urban areas, producing a steep, high hydrograph peak.</li>
        <li><strong>Overwhelmed drainage:</strong> Storm drains have limited capacity. Intense rainfall can exceed this, causing surface water flooding.</li>
        <li><strong>Reduced storage:</strong> Loss of green spaces, wetlands, and floodplains removes natural sponge-like water stores.</li>
        <li><strong>Mitigation strategies</strong> include sustainable urban drainage systems (SuDS), permeable paving, green roofs, retention ponds, and restoring urban green corridors.</li>
      </ul>
    </div>
  </div>
</div>

<div class="popup-overlay" id="popupOverlay">
  <div class="popup-box">
    <button class="popup-close" id="popupClose">&times;</button>
    <h3 id="popupTitle">Process</h3>
    <p id="popupText">Description</p>
  </div>
</div>

<script>
(function() {
  'use strict';

  // === Canvas setup ===
  const canvas = document.getElementById('cycleCanvas');
  const ctx = canvas.getContext('2d');
  const W = 800, H = 500;
  canvas.width = W;
  canvas.height = H;

  // === State ===
  let temperature = 15;
  let vegetation = 60;
  let urbanisation = 20;
  let season = 'summer';
  let particles = [];
  let animFrame = null;
  let time = 0;

  // === Derived rates (0-100) ===
  let rates = { evap: 50, transp: 30, precip: 40, runoff: 25, infilt: 35, ground: 20 };

  function calcRates() {
    const seasonMult = season === 'summer' ? 1.0 : 0.5;
    const tempFactor = Math.max(0, (temperature + 10) / 50);

    rates.evap = Math.round(Math.min(100, tempFactor * 80 * seasonMult));
    rates.transp = Math.round(Math.min(100, (vegetation / 100) * 60 * tempFactor * seasonMult));
    rates.precip = Math.round(Math.min(100, (rates.evap + rates.transp) * 0.65));
    const impermeable = urbanisation / 100;
    rates.runoff = Math.round(Math.min(100, rates.precip * (0.15 + impermeable * 0.7)));
    rates.infilt = Math.round(Math.min(100, rates.precip * (0.6 - impermeable * 0.5) * (1 + vegetation / 200)));
    rates.ground = Math.round(Math.min(100, rates.infilt * 0.6));
  }

  function updateUI() {
    document.getElementById('tempVal').textContent = temperature + ' C';
    document.getElementById('vegVal').textContent = vegetation + '%';
    document.getElementById('urbanVal').textContent = urbanisation + '%';

    const bars = [
      ['barEvap', 'valEvap', rates.evap],
      ['barTransp', 'valTransp', rates.transp],
      ['barPrecip', 'valPrecip', rates.precip],
      ['barRunoff', 'valRunoff', rates.runoff],
      ['barInfilt', 'valInfilt', rates.infilt],
      ['barGround', 'valGround', rates.ground]
    ];
    bars.forEach(([barId, valId, val]) => {
      document.getElementById(barId).style.width = val + '%';
      document.getElementById(valId).textContent = val;
    });
  }

  // === Controls ===
  document.getElementById('tempSlider').addEventListener('input', e => {
    temperature = parseInt(e.target.value);
    calcRates(); updateUI();
  });
  document.getElementById('vegSlider').addEventListener('input', e => {
    vegetation = parseInt(e.target.value);
    calcRates(); updateUI();
  });
  document.getElementById('urbanSlider').addEventListener('input', e => {
    urbanisation = parseInt(e.target.value);
    calcRates(); updateUI();
  });

  document.getElementById('btnSummer').addEventListener('click', () => {
    season = 'summer';
    document.getElementById('btnSummer').classList.add('active');
    document.getElementById('btnWinter').classList.remove('active');
    calcRates(); updateUI();
  });
  document.getElementById('btnWinter').addEventListener('click', () => {
    season = 'winter';
    document.getElementById('btnWinter').classList.add('active');
    document.getElementById('btnSummer').classList.remove('active');
    calcRates(); updateUI();
  });

  // === Landscape geometry ===
  const GROUND_Y = 340;
  const OCEAN_LEFT = 0;
  const OCEAN_RIGHT = 200;
  const MOUNTAIN_PEAK_X = 580;
  const MOUNTAIN_PEAK_Y = 160;
  const RIVER_X = 400;
  const WATER_TABLE_Y = 430;

  function getGroundY(x) {
    if (x < OCEAN_RIGHT) return GROUND_Y + 40;
    if (x < 300) return GROUND_Y - (x - OCEAN_RIGHT) * 0.1;
    if (x < MOUNTAIN_PEAK_X) {
      const t = (x - 300) / (MOUNTAIN_PEAK_X - 300);
      return GROUND_Y - 10 - t * (GROUND_Y - 10 - MOUNTAIN_PEAK_Y);
    }
    if (x < 700) {
      const t = (x - MOUNTAIN_PEAK_X) / (700 - MOUNTAIN_PEAK_X);
      return MOUNTAIN_PEAK_Y + t * (GROUND_Y - 20 - MOUNTAIN_PEAK_Y);
    }
    return GROUND_Y - 20 + (x - 700) * 0.15;
  }

  // === Drawing ===
  function drawSky() {
    const isWinter = season === 'winter';
    const grad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
    if (isWinter) {
      grad.addColorStop(0, '#6B8FAD');
      grad.addColorStop(1, '#9BB5C9');
    } else {
      grad.addColorStop(0, '#4A90C4');
      grad.addColorStop(1, '#87CEEB');
    }
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, GROUND_Y + 60);
  }

  function drawSun() {
    const sunX = 80, sunY = 60;
    const brightness = season === 'summer' ? 1 : 0.6;
    ctx.save();
    // Rays
    ctx.strokeStyle = `rgba(255,213,79,${0.3 * brightness})`;
    ctx.lineWidth = 2;
    for (let i = 0; i < 12; i++) {
      const angle = (i / 12) * Math.PI * 2 + time * 0.005;
      const inner = 32, outer = 48 + Math.sin(time * 0.03 + i) * 5;
      ctx.beginPath();
      ctx.moveTo(sunX + Math.cos(angle) * inner, sunY + Math.sin(angle) * inner);
      ctx.lineTo(sunX + Math.cos(angle) * outer, sunY + Math.sin(angle) * outer);
      ctx.stroke();
    }
    // Glow
    const glow = ctx.createRadialGradient(sunX, sunY, 10, sunX, sunY, 50);
    glow.addColorStop(0, `rgba(255,213,79,${0.5 * brightness})`);
    glow.addColorStop(1, 'rgba(255,213,79,0)');
    ctx.fillStyle = glow;
    ctx.fillRect(sunX - 50, sunY - 50, 100, 100);
    // Body
    ctx.fillStyle = `rgba(255,213,79,${brightness})`;
    ctx.beginPath();
    ctx.arc(sunX, sunY, 24, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = `rgba(255,179,0,${brightness * 0.6})`;
    ctx.beginPath();
    ctx.arc(sunX, sunY, 18, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  function drawClouds() {
    const cloudAlpha = Math.min(1, rates.precip / 60 + 0.3);
    function drawCloud(cx, cy, scale) {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.scale(scale, scale);
      ctx.fillStyle = `rgba(240,240,240,${cloudAlpha})`;
      ctx.beginPath();
      ctx.arc(0, 0, 30, 0, Math.PI * 2);
      ctx.arc(30, -8, 24, 0, Math.PI * 2);
      ctx.arc(-28, 2, 22, 0, Math.PI * 2);
      ctx.arc(12, -20, 20, 0, Math.PI * 2);
      ctx.arc(-14, -15, 18, 0, Math.PI * 2);
      ctx.fill();
      // Darker underside
      ctx.fillStyle = `rgba(176,176,176,${cloudAlpha * 0.5})`;
      ctx.beginPath();
      ctx.ellipse(0, 10, 40, 10, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }
    const drift = Math.sin(time * 0.003) * 8;
    drawCloud(300 + drift, 70, 1.1);
    drawCloud(480 + drift * 0.7, 55, 0.9);
    drawCloud(160 + drift * 1.2, 90, 0.7);
    if (rates.precip > 50) {
      drawCloud(620 + drift * 0.5, 80, 0.8);
    }
  }

  function drawMountains() {
    const isWinter = season === 'winter';
    // Back mountain
    ctx.fillStyle = isWinter ? '#7A8B99' : '#6D8B74';
    ctx.beginPath();
    ctx.moveTo(450, GROUND_Y);
    ctx.lineTo(560, 140);
    ctx.lineTo(680, GROUND_Y - 10);
    ctx.closePath();
    ctx.fill();

    // Main mountain
    const mGrad = ctx.createLinearGradient(500, MOUNTAIN_PEAK_Y, 500, GROUND_Y);
    mGrad.addColorStop(0, isWinter ? '#8899A6' : '#7B9B6E');
    mGrad.addColorStop(1, isWinter ? '#5A6B78' : '#5D7A50');
    ctx.fillStyle = mGrad;
    ctx.beginPath();
    ctx.moveTo(420, GROUND_Y);
    ctx.lineTo(MOUNTAIN_PEAK_X, MOUNTAIN_PEAK_Y);
    ctx.lineTo(720, GROUND_Y - 20);
    ctx.closePath();
    ctx.fill();

    // Snow cap
    if (temperature < 20 || isWinter) {
      const snowLine = MOUNTAIN_PEAK_Y + Math.max(0, (temperature - 0)) * 2;
      ctx.fillStyle = 'rgba(250,250,250,0.9)';
      ctx.beginPath();
      ctx.moveTo(MOUNTAIN_PEAK_X, MOUNTAIN_PEAK_Y);
      const leftSnow = MOUNTAIN_PEAK_X - (snowLine - MOUNTAIN_PEAK_Y) * 0.8;
      const rightSnow = MOUNTAIN_PEAK_X + (snowLine - MOUNTAIN_PEAK_Y) * 0.9;
      ctx.lineTo(leftSnow, snowLine);
      ctx.quadraticCurveTo(MOUNTAIN_PEAK_X, snowLine + 10, rightSnow, snowLine);
      ctx.closePath();
      ctx.fill();
    }
  }

  function drawGround() {
    const isWinter = season === 'winter';
    // Main terrain
    const gGrad = ctx.createLinearGradient(0, GROUND_Y, 0, H);
    gGrad.addColorStop(0, isWinter ? '#8B7D6B' : '#6D8B5E');
    gGrad.addColorStop(0.15, isWinter ? '#7A6B5A' : '#8D6E63');
    gGrad.addColorStop(1, '#4E342E');
    ctx.fillStyle = gGrad;
    ctx.beginPath();
    ctx.moveTo(OCEAN_RIGHT, GROUND_Y);
    for (let x = OCEAN_RIGHT; x <= W; x += 4) {
      ctx.lineTo(x, getGroundY(x));
    }
    ctx.lineTo(W, H);
    ctx.lineTo(OCEAN_RIGHT, H);
    ctx.closePath();
    ctx.fill();

    // Urban overlay
    if (urbanisation > 10) {
      const urbanAlpha = (urbanisation / 100) * 0.5;
      ctx.fillStyle = `rgba(120,144,156,${urbanAlpha})`;
      ctx.fillRect(240, GROUND_Y - 15, 120, 20);
      // Buildings
      const numBuildings = Math.floor(urbanisation / 15);
      ctx.fillStyle = `rgba(96,125,139,${urbanAlpha + 0.2})`;
      for (let i = 0; i < numBuildings; i++) {
        const bx = 250 + i * 22;
        const bh = 15 + (i % 3) * 10;
        ctx.fillRect(bx, GROUND_Y - 15 - bh, 16, bh);
        // Windows
        ctx.fillStyle = `rgba(255,235,59,${urbanAlpha})`;
        for (let wy = GROUND_Y - 12 - bh; wy < GROUND_Y - 18; wy += 8) {
          ctx.fillRect(bx + 3, wy + 2, 4, 3);
          ctx.fillRect(bx + 9, wy + 2, 4, 3);
        }
        ctx.fillStyle = `rgba(96,125,139,${urbanAlpha + 0.2})`;
      }
    }

    // Water table
    ctx.fillStyle = 'rgba(13,71,161,0.25)';
    ctx.fillRect(OCEAN_RIGHT, WATER_TABLE_Y, W - OCEAN_RIGHT, H - WATER_TABLE_Y);
    // Water table line
    ctx.strokeStyle = 'rgba(13,71,161,0.4)';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(OCEAN_RIGHT, WATER_TABLE_Y);
    ctx.lineTo(W, WATER_TABLE_Y);
    ctx.stroke();
    ctx.setLineDash([]);

    // Label
    ctx.fillStyle = 'rgba(13,71,161,0.6)';
    ctx.font = '10px sans-serif';
    ctx.fillText('WATER TABLE', W - 90, WATER_TABLE_Y + 14);
  }

  function drawOcean() {
    const oGrad = ctx.createLinearGradient(0, GROUND_Y, 0, H);
    oGrad.addColorStop(0, '#4FC3F7');
    oGrad.addColorStop(0.4, '#2196F3');
    oGrad.addColorStop(1, '#1565C0');
    ctx.fillStyle = oGrad;
    ctx.beginPath();
    ctx.moveTo(0, GROUND_Y + 5);
    // Waves
    for (let x = 0; x <= OCEAN_RIGHT + 10; x += 2) {
      const waveY = GROUND_Y + 5 + Math.sin(x * 0.04 + time * 0.04) * 3;
      ctx.lineTo(x, waveY);
    }
    ctx.lineTo(OCEAN_RIGHT + 10, H);
    ctx.lineTo(0, H);
    ctx.closePath();
    ctx.fill();

    // Surface shimmer
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 1;
    for (let i = 0; i < 4; i++) {
      const wy = GROUND_Y + 15 + i * 18;
      ctx.beginPath();
      for (let x = 10; x < OCEAN_RIGHT - 10; x += 2) {
        ctx.lineTo(x, wy + Math.sin(x * 0.06 + time * 0.03 + i) * 2);
      }
      ctx.stroke();
    }

    ctx.fillStyle = 'rgba(13,71,161,0.5)';
    ctx.font = 'bold 11px sans-serif';
    ctx.fillText('OCEAN', 70, GROUND_Y + 60);
  }

  function drawRiver() {
    ctx.strokeStyle = '#2196F3';
    ctx.lineWidth = 8;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(RIVER_X, getGroundY(RIVER_X));
    ctx.quadraticCurveTo(350, GROUND_Y + 5, 280, GROUND_Y + 10);
    ctx.quadraticCurveTo(240, GROUND_Y + 15, OCEAN_RIGHT + 5, GROUND_Y + 20);
    ctx.stroke();

    // River shimmer
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(RIVER_X - 5, getGroundY(RIVER_X) + 2);
    ctx.quadraticCurveTo(350, GROUND_Y + 7, 280, GROUND_Y + 12);
    ctx.stroke();
  }

  function drawTrees() {
    const treeCount = Math.floor(vegetation / 10);
    const isWinter = season === 'winter';
    const treePositions = [220, 380, 430, 460, 520, 640, 680, 710, 740, 760];

    for (let i = 0; i < Math.min(treeCount, treePositions.length); i++) {
      const tx = treePositions[i];
      const ty = getGroundY(tx);
      if (ty > GROUND_Y + 20) continue;

      // Trunk
      ctx.fillStyle = '#5D4037';
      ctx.fillRect(tx - 3, ty - 30, 6, 30);

      // Canopy
      if (isWinter && temperature < 5) {
        ctx.strokeStyle = '#5D4037';
        ctx.lineWidth = 1.5;
        for (let b = 0; b < 4; b++) {
          const angle = -Math.PI / 2 + (b - 1.5) * 0.5;
          ctx.beginPath();
          ctx.moveTo(tx, ty - 25);
          ctx.lineTo(tx + Math.cos(angle) * 18, ty - 25 + Math.sin(angle) * 18);
          ctx.stroke();
        }
      } else {
        ctx.fillStyle = isWinter ? '#5A7A4A' : '#4CAF50';
        ctx.beginPath();
        ctx.moveTo(tx, ty - 52);
        ctx.lineTo(tx - 16, ty - 20);
        ctx.lineTo(tx + 16, ty - 20);
        ctx.closePath();
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(tx, ty - 42);
        ctx.lineTo(tx - 13, ty - 15);
        ctx.lineTo(tx + 13, ty - 15);
        ctx.closePath();
        ctx.fill();
      }
    }
  }

  function drawLabels() {
    ctx.save();
    ctx.font = '10px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.85)';

    // Process labels with arrows
    const labels = [
      { text: 'EVAPORATION', x: 120, y: 260, angle: -Math.PI / 2 },
      { text: 'CONDENSATION', x: 370, y: 45, angle: 0 },
      { text: 'PRECIPITATION', x: 440, y: 130, angle: Math.PI / 6 },
      { text: 'TRANSPIRATION', x: 500, y: 245, angle: -Math.PI / 3 }
    ];

    labels.forEach(l => {
      ctx.save();
      ctx.translate(l.x, l.y);
      // Background
      const metrics = ctx.measureText(l.text);
      ctx.fillStyle = 'rgba(0,0,0,0.35)';
      ctx.fillRect(-2, -10, metrics.width + 4, 14);
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.fillText(l.text, 0, 0);
      ctx.restore();
    });

    // Ground labels
    ctx.fillStyle = 'rgba(255,255,255,0.75)';
    ctx.fillText('SURFACE RUNOFF', 280, GROUND_Y + 35);
    ctx.fillText('INFILTRATION', 420, GROUND_Y + 50);
    ctx.fillText('GROUNDWATER FLOW', 520, WATER_TABLE_Y + 30);

    ctx.restore();
  }

  function drawArrows() {
    ctx.save();
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4, 3]);

    function arrow(x1, y1, x2, y2, color) {
      ctx.strokeStyle = color;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
      // Arrowhead
      const angle = Math.atan2(y2 - y1, x2 - x1);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(x2, y2);
      ctx.lineTo(x2 - 8 * Math.cos(angle - 0.4), y2 - 8 * Math.sin(angle - 0.4));
      ctx.lineTo(x2 - 8 * Math.cos(angle + 0.4), y2 - 8 * Math.sin(angle + 0.4));
      ctx.closePath();
      ctx.fill();
    }

    // Evaporation arrow
    arrow(110, GROUND_Y - 5, 110, 140, 'rgba(79,195,247,0.7)');
    // Transpiration arrow
    arrow(500, 260, 480, 120, 'rgba(129,199,132,0.7)');
    // Precipitation arrow
    arrow(450, 95, 470, 200, 'rgba(33,150,243,0.7)');
    // Runoff arrow
    arrow(350, GROUND_Y + 5, 220, GROUND_Y + 25, 'rgba(141,110,99,0.7)');
    // Infiltration arrow
    arrow(430, GROUND_Y + 10, 430, WATER_TABLE_Y - 10, 'rgba(109,76,65,0.7)');
    // Groundwater arrow
    arrow(600, WATER_TABLE_Y + 15, 250, WATER_TABLE_Y + 15, 'rgba(13,71,161,0.6)');

    ctx.setLineDash([]);
    ctx.restore();
  }

  // === Particles ===
  const PARTICLE_TYPES = {
    evaporation: { color: '#4FC3F7', size: 3 },
    transpiration: { color: '#81C784', size: 2.5 },
    condensation: { color: '#B0BEC5', size: 2 },
    rain: { color: '#2196F3', size: 2.5 },
    snow: { color: '#FAFAFA', size: 3 },
    runoff: { color: '#8D6E63', size: 2.5 },
    infiltration: { color: '#6D4C41', size: 2 },
    groundwater: { color: '#0D47A1', size: 2 }
  };

  function createParticle(type, x, y, vx, vy) {
    return { type, x, y, vx, vy, life: 1, maxLife: 200 + Math.random() * 200, age: 0 };
  }

  function spawnParticles() {
    const spawnChance = 0.15;

    // Evaporation from ocean
    if (Math.random() < spawnChance * (rates.evap / 50)) {
      const x = 30 + Math.random() * (OCEAN_RIGHT - 40);
      particles.push(createParticle('evaporation', x, GROUND_Y, (Math.random() - 0.3) * 0.3, -0.6 - Math.random() * 0.5));
    }

    // Transpiration from trees
    if (Math.random() < spawnChance * (rates.transp / 60)) {
      const treeXs = [220, 380, 430, 460, 520, 640, 680];
      const idx = Math.floor(Math.random() * Math.min(Math.floor(vegetation / 15), treeXs.length));
      const tx = treeXs[idx];
      const ty = getGroundY(tx);
      if (ty <= GROUND_Y + 10) {
        particles.push(createParticle('transpiration', tx + (Math.random() - 0.5) * 10, ty - 40, (Math.random() - 0.5) * 0.3, -0.5 - Math.random() * 0.4));
      }
    }

    // Precipitation
    if (Math.random() < spawnChance * (rates.precip / 40)) {
      const px = 250 + Math.random() * 350;
      const py = 60 + Math.random() * 30;
      const isSnow = temperature < 2 || (season === 'winter' && temperature < 8);
      if (isSnow) {
        particles.push(createParticle('snow', px, py, (Math.random() - 0.5) * 0.5, 0.4 + Math.random() * 0.3));
      } else {
        particles.push(createParticle('rain', px, py, 0, 1.5 + Math.random() * 1));
      }
    }

    // Runoff
    if (Math.random() < spawnChance * (rates.runoff / 50) * 0.5) {
      const rx = 350 + Math.random() * 100;
      particles.push(createParticle('runoff', rx, getGroundY(rx), -0.8 - Math.random() * 0.4, 0.2));
    }

    // Infiltration
    if (Math.random() < spawnChance * (rates.infilt / 50) * 0.4) {
      const ix = 350 + Math.random() * 200;
      particles.push(createParticle('infiltration', ix, getGroundY(ix) + 5, 0, 0.3 + Math.random() * 0.3));
    }

    // Groundwater
    if (Math.random() < spawnChance * (rates.ground / 60) * 0.3) {
      const gx = 500 + Math.random() * 200;
      particles.push(createParticle('groundwater', gx, WATER_TABLE_Y + 5 + Math.random() * 30, -0.4 - Math.random() * 0.3, 0));
    }
  }

  function updateParticles() {
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.age++;
      p.life = Math.max(0, 1 - p.age / p.maxLife);

      // Snow sway
      if (p.type === 'snow') {
        p.vx = Math.sin(time * 0.02 + p.x * 0.01) * 0.4;
      }

      // Evaporation/transpiration: slow down and fade at cloud level
      if ((p.type === 'evaporation' || p.type === 'transpiration') && p.y < 80) {
        p.type = 'condensation';
        p.vx = 0.3;
        p.vy = 0;
        p.maxLife = p.age + 80;
      }

      // Remove off-screen or dead
      if (p.life <= 0 || p.x < -10 || p.x > W + 10 || p.y < -10 || p.y > H + 10) {
        particles.splice(i, 1);
        continue;
      }

      // Rain/snow hitting ground
      if ((p.type === 'rain' || p.type === 'snow') && p.y >= getGroundY(p.x) - 2) {
        particles.splice(i, 1);
        continue;
      }

      // Runoff reaching ocean
      if (p.type === 'runoff' && p.x <= OCEAN_RIGHT + 5) {
        particles.splice(i, 1);
        continue;
      }

      // Infiltration reaching water table
      if (p.type === 'infiltration' && p.y >= WATER_TABLE_Y) {
        particles.splice(i, 1);
        continue;
      }

      // Groundwater reaching ocean
      if (p.type === 'groundwater' && p.x <= OCEAN_RIGHT + 10) {
        particles.splice(i, 1);
        continue;
      }
    }

    // Cap particles
    if (particles.length > 400) {
      particles.splice(0, particles.length - 400);
    }
  }

  function drawParticles() {
    particles.forEach(p => {
      const info = PARTICLE_TYPES[p.type];
      ctx.globalAlpha = p.life * 0.85;
      ctx.fillStyle = info.color;

      if (p.type === 'snow') {
        // Snowflake
        ctx.beginPath();
        ctx.arc(p.x, p.y, info.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.5)';
        ctx.lineWidth = 0.5;
        for (let a = 0; a < 3; a++) {
          const ang = (a / 3) * Math.PI;
          ctx.beginPath();
          ctx.moveTo(p.x - Math.cos(ang) * info.size, p.y - Math.sin(ang) * info.size);
          ctx.lineTo(p.x + Math.cos(ang) * info.size, p.y + Math.sin(ang) * info.size);
          ctx.stroke();
        }
      } else if (p.type === 'rain') {
        // Raindrop elongated
        ctx.beginPath();
        ctx.ellipse(p.x, p.y, info.size * 0.6, info.size * 1.5, 0, 0, Math.PI * 2);
        ctx.fill();
      } else {
        ctx.beginPath();
        ctx.arc(p.x, p.y, info.size, 0, Math.PI * 2);
        ctx.fill();
      }
    });
    ctx.globalAlpha = 1;
  }

  // === Click zones for popup ===
  const clickZones = [
    {
      name: 'Evaporation',
      test: (x, y) => x < OCEAN_RIGHT + 30 && y > GROUND_Y - 40 && y < GROUND_Y + 50,
      desc: 'Evaporation is the process by which liquid water is heated by the sun and transforms into water vapour, rising into the atmosphere. It occurs primarily from oceans, lakes, and rivers. Higher temperatures increase the rate of evaporation, meaning more water enters the atmosphere in warmer conditions. Globally, about 86% of evaporation comes from the oceans.'
    },
    {
      name: 'Condensation',
      test: (x, y) => y < 120 && x > 150 && x < 550,
      desc: 'Condensation occurs when rising water vapour cools and changes back into tiny liquid droplets or ice crystals. These gather around microscopic dust particles (condensation nuclei) to form clouds and fog. The altitude at which condensation begins is called the dew point. Clouds are the visible result of condensation in the atmosphere.'
    },
    {
      name: 'Precipitation',
      test: (x, y) => y > 90 && y < 250 && x > 350 && x < 550,
      desc: 'Precipitation happens when water droplets or ice crystals in clouds become too heavy and fall to Earth as rain, snow, sleet, or hail. The type depends on temperature: above 2 degrees C produces rain, below this threshold and with sufficient cold air produces snow. Intense precipitation events are becoming more common due to increased evaporation from climate change.'
    },
    {
      name: 'Transpiration',
      test: (x, y) => x > 400 && x < 560 && y > 200 && y < GROUND_Y,
      desc: 'Transpiration is the release of water vapour from plant leaves through tiny pores called stomata. Trees and plants draw water up from the soil through their roots and release it into the atmosphere. A single large tree can transpire over 400 litres of water per day. Dense vegetation significantly increases the amount of moisture returned to the atmosphere.'
    },
    {
      name: 'Surface Runoff',
      test: (x, y) => y > GROUND_Y - 20 && y < GROUND_Y + 45 && x > OCEAN_RIGHT && x < 450,
      desc: 'Surface runoff occurs when precipitation flows over the land surface towards rivers, lakes, and oceans. It increases when the ground is saturated, frozen, or covered by impermeable surfaces (roads, buildings). Urbanisation dramatically increases runoff because concrete and tarmac prevent water soaking in. This leads to faster river response times and higher flood peaks.'
    },
    {
      name: 'Infiltration',
      test: (x, y) => y > GROUND_Y + 20 && y < WATER_TABLE_Y && x > 350 && x < 600,
      desc: 'Infiltration is the process of water soaking into the ground through soil and rock. The infiltration rate depends on soil type (sandy soil absorbs quickly, clay slowly), vegetation cover (roots create pathways), and land use (urban surfaces prevent infiltration). Water that infiltrates slowly percolates downward to recharge groundwater stores in underground aquifers.'
    },
    {
      name: 'Groundwater Flow',
      test: (x, y) => y > WATER_TABLE_Y - 10 && x > 300,
      desc: 'Groundwater is water stored in porous rock (aquifers) beneath the water table. It moves slowly through permeable rock layers, eventually feeding springs, rivers, and the ocean. This baseflow is crucial for maintaining river levels during dry periods. Groundwater can take days to thousands of years to complete its journey. Over-extraction for drinking water and agriculture can lower the water table significantly.'
    },
    {
      name: 'Mountains',
      test: (x, y) => x > 480 && x < 700 && y < GROUND_Y && y > 130,
      desc: 'Mountains play a vital role in the water cycle through orographic rainfall. As moist air is forced upward over high ground, it cools and condenses, producing heavy precipitation on the windward side. The leeward side (rain shadow) receives much less rainfall. Mountains also store water as snow and ice, releasing it gradually during warmer months to feed rivers downstream. This is why many major rivers originate in mountain ranges.'
    },
    {
      name: 'The Sun',
      test: (x, y) => x < 130 && y < 110,
      desc: 'The sun is the primary energy source driving the entire water cycle. Solar radiation heats water surfaces causing evaporation, warms the atmosphere to create air movements that transport moisture, and drives temperature differences that cause precipitation. Without solar energy, the water cycle would cease. Seasonal changes in solar intensity cause significant variations in evaporation and precipitation rates.'
    }
  ];

  // === Popup ===
  const overlay = document.getElementById('popupOverlay');
  const popupTitle = document.getElementById('popupTitle');
  const popupText = document.getElementById('popupText');

  canvas.addEventListener('click', (e) => {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width;
    const scaleY = H / rect.height;
    const mx = (e.clientX - rect.left) * scaleX;
    const my = (e.clientY - rect.top) * scaleY;

    for (const zone of clickZones) {
      if (zone.test(mx, my)) {
        popupTitle.textContent = zone.name;
        popupText.textContent = zone.desc;
        overlay.classList.add('visible');
        return;
      }
    }
  });

  document.getElementById('popupClose').addEventListener('click', () => {
    overlay.classList.remove('visible');
  });
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('visible');
  });

  // === Hover cursor ===
  canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width;
    const scaleY = H / rect.height;
    const mx = (e.clientX - rect.left) * scaleX;
    const my = (e.clientY - rect.top) * scaleY;

    let hovering = false;
    for (const zone of clickZones) {
      if (zone.test(mx, my)) { hovering = true; break; }
    }
    canvas.style.cursor = hovering ? 'pointer' : 'default';
  });

  // === Main loop ===
  function draw() {
    ctx.clearRect(0, 0, W, H);
    drawSky();
    drawSun();
    drawOcean();
    drawMountains();
    drawGround();
    drawRiver();
    drawTrees();
    drawArrows();
    drawLabels();
    spawnParticles();
    updateParticles();
    drawParticles();
    time++;
    animFrame = requestAnimationFrame(draw);
  }

  calcRates();
  updateUI();
  draw();
})();
</script>
</body>
</html>