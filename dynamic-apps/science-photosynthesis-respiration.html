<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photosynthesis &amp; Respiration Balance</title>
  <style>
    :root {
      --green-dark:    #1b5e20;
      --green-mid:     #2e7d32;
      --green-light:   #4caf50;
      --green-pale:    #c8e6c9;
      --teal-dark:     #00695c;
      --teal-mid:      #00897b;
      --teal-light:    #4db6ac;
      --teal-pale:     #b2dfdb;
      --bg-page:       #f0f7f4;
      --bg-card:       #ffffff;
      --bg-header:     #1b5e20;
      --text-main:     #1a2e1a;
      --text-muted:    #546e5a;
      --text-light:    #f1f8e9;
      --border:        #c8e6c9;
      --red-zone:      rgba(229, 57, 53, 0.12);
      --green-zone:    rgba(67, 160, 71, 0.12);
      --red-line:      #e53935;
      --green-line:    #43a047;
      --orange:        #f57c00;
      --shadow:        0 2px 8px rgba(0,0,0,0.10);
      --radius:        10px;
      --gauge-bg:      #e8f5e9;
      --gauge-photo:   #2e7d32;
      --gauge-resp:    #00897b;
      --font:          'Segoe UI', system-ui, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg-page);
      color: var(--text-main);
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: var(--bg-header);
      color: var(--text-light);
      padding: 18px 28px 16px;
      display: flex;
      align-items: flex-end;
      gap: 16px;
      flex-wrap: wrap;
    }
    header .leaf-icon {
      font-size: 2.2rem;
      line-height: 1;
    }
    header .header-text h1 {
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    header .header-text p {
      font-size: 0.88rem;
      opacity: 0.82;
      margin-top: 2px;
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    .main-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      padding: 20px 24px;
      max-width: 1280px;
      margin: 0 auto;
    }

    /* â”€â”€ CARDS â”€â”€ */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--green-dark);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card h2 .icon { font-size: 1.1rem; }

    /* â”€â”€ LEFT COLUMN â”€â”€ */
    .left-col {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* â”€â”€ SLIDERS â”€â”€ */
    .slider-group { display: flex; flex-direction: column; gap: 14px; }

    .slider-row label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 5px;
    }
    .slider-row label .val-badge {
      background: var(--green-pale);
      color: var(--green-dark);
      padding: 2px 9px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      min-width: 52px;
      text-align: center;
    }
    .slider-row .sub {
      font-size: 0.76rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }
    input[type="range"].light-slider  { background: linear-gradient(to right, #fff176, #fbc02d); }
    input[type="range"].co2-slider    { background: linear-gradient(to right, #b3e5fc, #0288d1); }
    input[type="range"].temp-slider   { background: linear-gradient(to right, #b2dfdb, #e53935); }
    input[type="range"].water-slider  { background: linear-gradient(to right, #b3e5fc, #1565c0); }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--green-dark);
      border: 2px solid #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      cursor: pointer;
      transition: transform 0.1s;
    }
    input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); }
    input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--green-dark);
      border: 2px solid #fff;
      cursor: pointer;
    }

    /* â”€â”€ GAUGES â”€â”€ */
    .gauges-row {
      display: flex;
      gap: 14px;
      justify-content: space-around;
    }
    .gauge-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .gauge-wrap svg { display: block; }
    .gauge-label {
      font-size: 0.78rem;
      font-weight: 700;
      text-align: center;
      line-height: 1.25;
    }
    .gauge-label.photo { color: var(--green-mid); }
    .gauge-label.resp  { color: var(--teal-dark); }
    .gauge-val {
      font-size: 1.15rem;
      font-weight: 800;
    }

    /* â”€â”€ NET READOUT â”€â”€ */
    .net-readout {
      background: var(--bg-page);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .net-readout .net-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.84rem;
    }
    .net-readout .net-row .label { color: var(--text-muted); font-weight: 500; }
    .net-readout .net-row .value { font-weight: 700; }
    .net-readout .net-main {
      font-size: 1rem;
      font-weight: 700;
      padding-top: 6px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .net-pos  { color: var(--green-mid); }
    .net-neg  { color: var(--red-line); }
    .net-zero { color: var(--orange); }

    /* â”€â”€ COMPENSATION BADGE â”€â”€ */
    .comp-badge {
      font-size: 0.82rem;
      padding: 6px 12px;
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
    }
    .comp-badge.active   { background: #fff3e0; color: #e65100; border: 1px solid #ffcc02; }
    .comp-badge.inactive { background: var(--green-pale); color: var(--green-dark); border: 1px solid var(--green-light); }

    /* â”€â”€ RIGHT COLUMN â”€â”€ */
    .right-col {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* â”€â”€ CANVAS GRAPH â”€â”€ */
    #graph-canvas {
      width: 100%;
      display: block;
      border-radius: 6px;
    }
    .graph-card { padding: 16px 16px 12px; }
    .graph-card h2 { margin-bottom: 8px; }

    /* â”€â”€ INFO PANEL â”€â”€ */
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .info-tile {
      background: var(--bg-page);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 13px 14px;
    }
    .info-tile h3 {
      font-size: 0.82rem;
      font-weight: 700;
      color: var(--teal-dark);
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .info-tile p, .info-tile li {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.55;
    }
    .info-tile ul { padding-left: 16px; }
    .info-tile ul li { margin-bottom: 3px; }

    /* â”€â”€ LEGEND â”€â”€ */
    .legend {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 0.78rem;
      margin-top: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-muted);
      font-weight: 600;
    }
    .legend-dot {
      width: 12px;
      height: 4px;
      border-radius: 2px;
    }

    /* â”€â”€ ENZYME TEMP VISUAL â”€â”€ */
    .enzyme-bar {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(to right, #b2dfdb 0%, #43a047 35%, #fbc02d 60%, #e53935 100%);
      margin: 8px 0 4px;
      position: relative;
    }
    .enzyme-bar .marker {
      position: absolute;
      top: -4px;
      width: 2px;
      height: 16px;
      background: var(--text-main);
      border-radius: 1px;
      transform: translateX(-50%);
      transition: left 0.25s ease;
    }
    .enzyme-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.68rem;
      color: var(--text-muted);
    }
    .enzyme-status {
      font-size: 0.78rem;
      font-weight: 700;
      margin-top: 4px;
      text-align: center;
    }

    /* â”€â”€ LIMITING FACTOR BARS â”€â”€ */
    .limiting-bars { display: flex; flex-direction: column; gap: 7px; margin-top: 4px; }
    .lim-row { display: flex; align-items: center; gap: 8px; font-size: 0.78rem; }
    .lim-name { width: 60px; color: var(--text-muted); font-weight: 600; flex-shrink: 0; }
    .lim-track { flex: 1; height: 8px; background: var(--gauge-bg); border-radius: 4px; overflow: hidden; }
    .lim-fill  { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
    .lim-pct   { width: 36px; text-align: right; font-weight: 700; font-size: 0.75rem; color: var(--text-main); }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 768px) {
      .main-grid {
        grid-template-columns: 1fr;
        padding: 12px 14px;
      }
      .info-grid { grid-template-columns: 1fr; }
      .gauges-row { gap: 8px; }
    }
  </style>
</head>
<body>

<header>
  <div class="leaf-icon">ğŸŒ¿</div>
  <div class="header-text">
    <h1>Photosynthesis &amp; Respiration Balance</h1>
    <p>Adjust the conditions to explore rates, limiting factors and the compensation point</p>
  </div>
</header>

<div class="main-grid">

  <!-- LEFT: Controls + Gauges -->
  <div class="left-col">

    <!-- Sliders -->
    <div class="card">
      <h2><span class="icon">ğŸ›ï¸</span> Environmental Conditions</h2>
      <div class="slider-group">

        <div class="slider-row">
          <label>
            Light Intensity
            <span class="val-badge" id="light-val">50</span>
          </label>
          <div class="sub">Increases photosynthesis up to the saturation point</div>
          <input type="range" class="light-slider" id="light" min="0" max="100" value="50">
        </div>

        <div class="slider-row">
          <label>
            CO<sub>2</sub> Concentration
            <span class="val-badge" id="co2-val">50</span>
          </label>
          <div class="sub">Raw material for the Calvin cycle (dark reactions)</div>
          <input type="range" class="co2-slider" id="co2" min="0" max="100" value="50">
        </div>

        <div class="slider-row">
          <label>
            Temperature (Â°C)
            <span class="val-badge" id="temp-val">25Â°C</span>
          </label>
          <div class="sub">Affects enzyme activity; optimum ~25-35Â°C for most plants</div>
          <input type="range" class="temp-slider" id="temp" min="0" max="50" value="25">
        </div>

        <div class="slider-row">
          <label>
            Water Availability
            <span class="val-badge" id="water-val">50</span>
          </label>
          <div class="sub">Required for light-dependent reactions; low water closes stomata</div>
          <input type="range" class="water-slider" id="water" min="0" max="100" value="50">
        </div>

      </div>
    </div>

    <!-- Gauges -->
    <div class="card">
      <h2><span class="icon">âš¡</span> Current Rates</h2>
      <div class="gauges-row">
        <div class="gauge-wrap">
          <svg id="gauge-photo" width="120" height="70" viewBox="0 0 120 70" role="img" aria-label="Photosynthesis rate gauge"></svg>
          <div class="gauge-label photo">Photosynthesis<br>Rate</div>
          <div class="gauge-val net-pos" id="photo-val-display">0.0</div>
        </div>
        <div class="gauge-wrap">
          <svg id="gauge-resp" width="120" height="70" viewBox="0 0 120 70" role="img" aria-label="Respiration rate gauge"></svg>
          <div class="gauge-label resp">Respiration<br>Rate</div>
          <div class="gauge-val net-pos" id="resp-val-display">0.0</div>
        </div>
      </div>

      <!-- Numeric readout -->
      <div class="net-readout" style="margin-top:14px;">
        <div class="net-row">
          <span class="label">Gross photosynthesis rate</span>
          <span class="value net-pos" id="rd-photo">0.0 units</span>
        </div>
        <div class="net-row">
          <span class="label">Respiration rate</span>
          <span class="value" style="color:var(--teal-dark)" id="rd-resp">0.0 units</span>
        </div>
        <div class="net-main">
          <span>Net gas exchange</span>
          <span id="rd-net">0.0 units</span>
        </div>
      </div>

      <div id="comp-badge" class="comp-badge inactive" style="margin-top:10px;">
        Graph shows compensation point
      </div>
    </div>

    <!-- Limiting factors -->
    <div class="card">
      <h2><span class="icon">ğŸ”¬</span> Limiting Factor Strengths</h2>
      <div class="limiting-bars">
        <div class="lim-row">
          <span class="lim-name">Light</span>
          <div class="lim-track"><div class="lim-fill" id="lf-light" style="background:#fbc02d;"></div></div>
          <span class="lim-pct" id="lf-light-pct">50%</span>
        </div>
        <div class="lim-row">
          <span class="lim-name">CO<sub>2</sub></span>
          <div class="lim-track"><div class="lim-fill" id="lf-co2" style="background:#0288d1;"></div></div>
          <span class="lim-pct" id="lf-co2-pct">50%</span>
        </div>
        <div class="lim-row">
          <span class="lim-name">Temp</span>
          <div class="lim-track"><div class="lim-fill" id="lf-temp" style="background:#43a047;"></div></div>
          <span class="lim-pct" id="lf-temp-pct">50%</span>
        </div>
        <div class="lim-row">
          <span class="lim-name">Water</span>
          <div class="lim-track"><div class="lim-fill" id="lf-water" style="background:#1565c0;"></div></div>
          <span class="lim-pct" id="lf-water-pct">50%</span>
        </div>
      </div>
      <p style="font-size:0.75rem;color:var(--text-muted);margin-top:10px;">
        The <strong>lowest</strong> factor is the limiting factor at any given moment. Increasing other factors has no effect until the current limit is raised (Blackman's Law).
      </p>
    </div>

  </div>

  <!-- RIGHT: Graph + Info -->
  <div class="right-col">

    <!-- Graph -->
    <div class="card graph-card">
      <h2><span class="icon">ğŸ“ˆ</span> Net Gas Exchange vs Light Intensity</h2>
      <canvas id="graph-canvas" height="320"></canvas>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot" style="background:var(--green-line); width:24px; height:3px;"></div>
          Net O<sub>2</sub> release (net photosynthesis)
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:var(--red-line); width:24px; height:3px;"></div>
          Net CO<sub>2</sub> release (net respiration)
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:var(--orange); width:24px; height:3px; border-top: 2px dashed var(--orange); height:0px;"></div>
          Compensation point
        </div>
      </div>
    </div>

    <!-- Info tiles -->
    <div class="card" style="padding:16px;">
      <h2><span class="icon">ğŸ“š</span> Key Concepts (GCSE Biology)</h2>
      <div class="info-grid">

        <div class="info-tile">
          <h3>ğŸŒ… Compensation Point</h3>
          <p>
            The light intensity at which the rate of photosynthesis exactly equals the rate of respiration. At this point, no net gas exchange occurs: all CO<sub>2</sub> produced by respiration is used in photosynthesis, and all O<sub>2</sub> produced is used in respiration.
          </p>
          <p style="margin-top:6px;">
            Shade-adapted plants have a <strong>lower</strong> compensation point, allowing them to survive in dim light conditions.
          </p>
        </div>

        <div class="info-tile">
          <h3>âš¡ Light Saturation Point</h3>
          <p>
            Above this light intensity, photosynthesis can no longer increase, because another factor (CO<sub>2</sub> or temperature) becomes limiting. The graph levels off into a plateau.
          </p>
          <p style="margin-top:6px;">
            Increasing CO<sub>2</sub> or temperature (up to the optimum) raises the saturation point and allows a higher maximum rate.
          </p>
        </div>

        <div class="info-tile">
          <h3>ğŸ§ª Limiting Factors</h3>
          <ul>
            <li><strong>Light</strong>: drives the light-dependent reactions in the thylakoid; produces ATP and NADPH.</li>
            <li><strong>CO<sub>2</sub></strong>: fixed by RuBisCO in the Calvin cycle; low CO<sub>2</sub> slows the dark reactions.</li>
            <li><strong>Temperature</strong>: controls enzyme reaction rates; too high denatures enzymes.</li>
            <li><strong>Water</strong>: split in photolysis to release O<sub>2</sub>; shortage causes stomata to close.</li>
          </ul>
        </div>

        <div class="info-tile">
          <h3>ğŸŒ¡ï¸ Temperature and Enzymes</h3>
          <p style="margin-bottom:6px;">
            RuBisCO and other photosynthetic enzymes have an optimum temperature (typically 25-35Â°C). Below the optimum, kinetic energy is lower and collisions are less frequent. Above the optimum, the enzyme's tertiary structure is disrupted (denaturation), causing an irreversible loss of function.
          </p>
          <div class="enzyme-bar">
            <div class="marker" id="enzyme-marker" style="left:50%"></div>
          </div>
          <div class="enzyme-labels">
            <span>0Â°C</span><span>Optimum ~30Â°C</span><span>50Â°C</span>
          </div>
          <div class="enzyme-status" id="enzyme-status">Normal enzyme activity</div>
        </div>

        <div class="info-tile" style="grid-column: span 2;">
          <h3>âš—ï¸ The Equations</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px;">
            <div>
              <p style="font-weight:700;color:var(--green-dark);margin-bottom:4px;">Photosynthesis</p>
              <p style="font-family:monospace;font-size:0.82rem;background:var(--green-pale);padding:7px 10px;border-radius:6px;line-height:1.7;">
                6CO<sub>2</sub> + 6H<sub>2</sub>O<br>
                &nbsp;&nbsp;&#x2192; C<sub>6</sub>H<sub>12</sub>O<sub>6</sub> + 6O<sub>2</sub>
              </p>
              <p style="font-size:0.74rem;margin-top:5px;color:var(--text-muted);">Requires: light energy, chlorophyll<br>Occurs in: chloroplasts (thylakoids + stroma)</p>
            </div>
            <div>
              <p style="font-weight:700;color:var(--teal-dark);margin-bottom:4px;">Aerobic Respiration</p>
              <p style="font-family:monospace;font-size:0.82rem;background:var(--teal-pale);padding:7px 10px;border-radius:6px;line-height:1.7;">
                C<sub>6</sub>H<sub>12</sub>O<sub>6</sub> + 6O<sub>2</sub><br>
                &nbsp;&nbsp;&#x2192; 6CO<sub>2</sub> + 6H<sub>2</sub>O + ATP
              </p>
              <p style="font-size:0.74rem;margin-top:5px;color:var(--text-muted);">Continuous in all living cells<br>Occurs in: mitochondria (matrix + cristae)</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CONSTANTS & HELPERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MAX_PHOTO_RATE = 10.0;  // arbitrary units, max gross photosynthesis
  const BASE_RESP_RATE = 1.8;   // baseline respiration at 25Â°C
  const TEMP_OPT       = 30;    // enzyme optimum temperature
  const LIGHT_SAT_BASE = 70;    // light saturation point at base conditions

  // Clamp utility
  function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MODEL: compute photosynthesis and respiration rates from slider values
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /** Temperature multiplier for photosynthesis enzymes (bell curve). */
  function tempPhotoFactor(t) {
    if (t <= 0)  return 0.05;
    if (t >= 50) return 0.02;
    // Bell curve: peak at TEMP_OPT, steep right tail (denaturation)
    const dist = t - TEMP_OPT;
    if (dist <= 0) {
      // Below optimum: gradual increase
      return clamp(0.1 + 0.9 * Math.exp(-0.0035 * dist * dist), 0, 1);
    } else {
      // Above optimum: faster drop (denaturation)
      return clamp(Math.exp(-0.018 * dist * dist), 0, 1);
    }
  }

  /** Temperature multiplier for respiration (Q10 rule: doubles per 10Â°C up to ~40Â°C then drops). */
  function tempRespFactor(t) {
    if (t <= 0)  return 0.1;
    if (t >= 50) return 0.15;
    const optR = 38;
    const dist  = t - optR;
    if (dist <= 0) {
      return clamp(0.15 + 0.85 * Math.pow(1.082, t), 0, 3.5);
    } else {
      return clamp(Math.pow(1.082, optR) * Math.exp(-0.025 * dist * dist), 0, 3.5);
    }
  }

  /**
   * Compute gross photosynthesis rate for a given light intensity (0-100)
   * and the current CO2, temp, water slider values.
   */
  function calcPhotosynthesis(light, co2, temp, water) {
    const l = light / 100;
    const c = co2   / 100;
    const w = water / 100;
    const tf = tempPhotoFactor(temp);

    // Effective CO2 limited by water (stomata close when water is low)
    const effCO2 = c * (0.2 + 0.8 * Math.pow(w, 0.5));

    // Light saturation point scales with CO2 and temperature
    const satPoint = LIGHT_SAT_BASE * effCO2 * tf + 10;

    // Hyperbolic saturation curve with light
    const lightFactor = (l * satPoint) / (l * satPoint + (1 - l + 0.01) * 20 + 0.5);
    // But light factor also hard-limits at current l value
    const rawLight = l / (l + 0.15);

    // Non-light limiting: minimum of CO2 and temperature availability
    const nonLightLimit = Math.min(effCO2, tf);

    const rate = MAX_PHOTO_RATE * rawLight * nonLightLimit;
    return clamp(rate, 0, MAX_PHOTO_RATE);
  }

  /**
   * Compute respiration rate. Respiration is independent of light but
   * affected by temperature and somewhat by water stress.
   */
  function calcRespiration(temp, water) {
    const tf = tempRespFactor(temp);
    const wf = 0.7 + 0.3 * (water / 100); // slight water effect on resp
    return clamp(BASE_RESP_RATE * tf * wf, 0.1, 6.0);
  }

  /**
   * Limiting factor strengths (0-100 %) for display bars.
   * Each represents how much that factor is currently limiting photosynthesis.
   */
  function calcLimitingFactors(light, co2, temp, water) {
    const tf = tempPhotoFactor(temp);
    const wf = 0.2 + 0.8 * Math.pow(water / 100, 0.5);

    // Each factor expressed as % of its potential contribution
    const lightPct = Math.round(light);
    const co2Pct   = Math.round(co2 * wf);
    const tempPct  = Math.round(tf * 100);
    const waterPct = Math.round(water);
    return { lightPct, co2Pct, tempPct, waterPct };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SVG ARC GAUGE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function describeArc(cx, cy, r, startDeg, endDeg) {
    const toRad = d => (d - 90) * Math.PI / 180;
    const s = toRad(startDeg);
    const e = toRad(endDeg);
    const x1 = cx + r * Math.cos(s);
    const y1 = cy + r * Math.sin(s);
    const x2 = cx + r * Math.cos(e);
    const y2 = cy + r * Math.sin(e);
    const large = (endDeg - startDeg > 180) ? 1 : 0;
    return `M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`;
  }

  function buildGauge(svgEl, colour) {
    // Static background arc
    const bgArc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    bgArc.setAttribute('d', describeArc(60, 65, 48, -30, 210));
    bgArc.setAttribute('fill', 'none');
    bgArc.setAttribute('stroke', '#e8f5e9');
    bgArc.setAttribute('stroke-width', '10');
    bgArc.setAttribute('stroke-linecap', 'round');
    svgEl.appendChild(bgArc);

    // Foreground arc (animated)
    const fgArc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    fgArc.setAttribute('d', describeArc(60, 65, 48, -30, -30)); // starts empty
    fgArc.setAttribute('fill', 'none');
    fgArc.setAttribute('stroke', colour);
    fgArc.setAttribute('stroke-width', '10');
    fgArc.setAttribute('stroke-linecap', 'round');
    fgArc.style.transition = 'all 0.35s ease';
    svgEl.appendChild(fgArc);

    return fgArc;
  }

  const photoGaugeSvg = document.getElementById('gauge-photo');
  const respGaugeSvg  = document.getElementById('gauge-resp');
  const photoArc = buildGauge(photoGaugeSvg, getComputedStyle(document.documentElement).getPropertyValue('--gauge-photo').trim() || '#2e7d32');
  const respArc  = buildGauge(respGaugeSvg,  getComputedStyle(document.documentElement).getPropertyValue('--gauge-resp').trim()  || '#00897b');

  function updateGauge(arcEl, fraction) {
    const clampedF = clamp(fraction, 0, 1);
    const startDeg = -30;
    const span     = 240;
    const endDeg   = startDeg + clampedF * span;
    arcEl.setAttribute('d', describeArc(60, 65, 48, startDeg, Math.max(startDeg + 0.5, endDeg)));
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CANVAS GRAPH
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const canvas = document.getElementById('graph-canvas');
  const ctx    = canvas.getContext('2d');
  const STEPS  = 200; // number of x points to plot

  function resizeCanvas() {
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width  = Math.max(rect.width - 32, 200);
    canvas.height = 320;
  }

  function drawGraph(co2, temp, water) {
    resizeCanvas();
    const W  = canvas.width;
    const H  = canvas.height;
    const PAD = { top: 30, right: 20, bottom: 48, left: 58 };
    const plotW = W - PAD.left - PAD.right;
    const plotH = H - PAD.top  - PAD.bottom;

    // Compute data arrays
    const rRate  = calcRespiration(temp, water);
    const netMin = -rRate;            // at light = 0, net = -respiration
    let netMax   = 0;
    const netData = [];

    for (let i = 0; i <= STEPS; i++) {
      const lightVal = (i / STEPS) * 100;
      const pRate    = calcPhotosynthesis(lightVal, co2, temp, water);
      const net      = pRate - rRate;
      netData.push(net);
      if (net > netMax) netMax = net;
    }

    // Y axis bounds
    const yMin = Math.min(netMin * 1.25, -0.5);
    const yMax = Math.max(netMax * 1.15,  1.0);
    const yRange = yMax - yMin;

    // Helper: data coords to canvas coords
    function toX(i) { return PAD.left + (i / STEPS) * plotW; }
    function toY(v) { return PAD.top  + (1 - (v - yMin) / yRange) * plotH; }
    const zeroY = toY(0);

    ctx.clearRect(0, 0, W, H);

    // â”€â”€ Background zones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Red zone (net < 0)
    ctx.fillStyle = 'rgba(229, 57, 53, 0.08)';
    ctx.fillRect(PAD.left, toY(0), plotW, toY(yMin) - toY(0));

    // Green zone (net > 0)
    ctx.fillStyle = 'rgba(67, 160, 71, 0.08)';
    ctx.fillRect(PAD.left, PAD.top, plotW, toY(0) - PAD.top);

    // â”€â”€ Grid lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.strokeStyle = '#e0ebe0';
    ctx.lineWidth   = 1;
    // Horizontal grid: 5 lines
    for (let g = 0; g <= 4; g++) {
      const v = yMin + (g / 4) * yRange;
      const gy = toY(v);
      ctx.beginPath();
      ctx.setLineDash([4, 4]);
      ctx.moveTo(PAD.left, gy);
      ctx.lineTo(PAD.left + plotW, gy);
      ctx.stroke();
    }
    // Vertical grid: 5 lines
    for (let g = 0; g <= 4; g++) {
      const gx = PAD.left + (g / 4) * plotW;
      ctx.beginPath();
      ctx.setLineDash([4, 4]);
      ctx.moveTo(gx, PAD.top);
      ctx.lineTo(gx, PAD.top + plotH);
      ctx.stroke();
    }
    ctx.setLineDash([]);

    // â”€â”€ Zero line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.strokeStyle = '#bdbdbd';
    ctx.lineWidth   = 1.5;
    ctx.beginPath();
    ctx.moveTo(PAD.left, zeroY);
    ctx.lineTo(PAD.left + plotW, zeroY);
    ctx.stroke();

    // â”€â”€ Axes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.strokeStyle = '#546e5a';
    ctx.lineWidth   = 2;
    ctx.beginPath();
    ctx.moveTo(PAD.left, PAD.top);
    ctx.lineTo(PAD.left, PAD.top + plotH);
    ctx.lineTo(PAD.left + plotW, PAD.top + plotH);
    ctx.stroke();

    // â”€â”€ Axis labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.fillStyle = '#546e5a';
    ctx.font      = '11px ' + getComputedStyle(document.body).fontFamily;
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';

    // Y axis ticks
    const tickVals = [];
    const step = yRange / 4;
    for (let g = 0; g <= 4; g++) {
      tickVals.push(yMin + g * step);
    }
    tickVals.forEach(v => {
      ctx.fillText(v.toFixed(1), PAD.left - 6, toY(v));
      ctx.strokeStyle = '#c8e6c9';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(PAD.left - 4, toY(v));
      ctx.lineTo(PAD.left, toY(v));
      ctx.stroke();
    });

    // X axis ticks: 0, 25, 50, 75, 100
    ctx.textAlign    = 'center';
    ctx.textBaseline = 'top';
    [0, 25, 50, 75, 100].forEach(v => {
      const gx = PAD.left + (v / 100) * plotW;
      ctx.fillStyle   = '#546e5a';
      ctx.fillText(v, gx, PAD.top + plotH + 6);
      ctx.strokeStyle = '#c8e6c9';
      ctx.lineWidth   = 1;
      ctx.beginPath();
      ctx.moveTo(gx, PAD.top + plotH);
      ctx.lineTo(gx, PAD.top + plotH + 4);
      ctx.stroke();
    });

    // Axis titles
    ctx.fillStyle    = '#2e7d32';
    ctx.font         = 'bold 11px ' + getComputedStyle(document.body).fontFamily;
    ctx.textAlign    = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText('Light Intensity (arbitrary units)', PAD.left + plotW / 2, H - 2);

    ctx.save();
    ctx.translate(13, PAD.top + plotH / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillStyle    = '#2e7d32';
    ctx.textAlign    = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Net Gas Exchange (units)', 0, 0);
    ctx.restore();

    // â”€â”€ Find compensation point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let compI = -1;
    for (let i = 0; i < netData.length - 1; i++) {
      if (netData[i] <= 0 && netData[i + 1] > 0) {
        compI = i + Math.abs(netData[i]) / (Math.abs(netData[i]) + Math.abs(netData[i + 1]));
        break;
      }
    }

    // â”€â”€ Find light saturation point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Where the slope becomes very shallow
    let satI = -1;
    const peakNet = Math.max(...netData);
    const satThreshold = peakNet * 0.97;
    for (let i = 10; i < netData.length; i++) {
      if (netData[i] >= satThreshold) { satI = i; break; }
    }

    // â”€â”€ Net exchange curve (coloured segments) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.lineWidth   = 2.5;
    ctx.lineJoin    = 'round';
    ctx.setLineDash([]);

    // Build path segments: red below zero, green above zero
    let prevAbove = netData[0] >= 0;
    let pathStart = 0;

    function drawSegment(fromI, toI, colour) {
      ctx.strokeStyle = colour;
      ctx.beginPath();
      for (let i = fromI; i <= toI; i++) {
        const x = toX(i);
        const y = toY(netData[i]);
        if (i === fromI) ctx.moveTo(x, y);
        else             ctx.lineTo(x, y);
      }
      ctx.stroke();
    }

    for (let i = 1; i <= STEPS; i++) {
      const above = netData[i] >= 0;
      if (above !== prevAbove || i === STEPS) {
        drawSegment(pathStart, i, prevAbove ? '#43a047' : '#e53935');
        pathStart = i;
        prevAbove = above;
      }
    }

    // â”€â”€ Compensation point annotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (compI > 0) {
      const cx_ = toX(compI);
      const cy_ = toY(0);

      // Dashed vertical line
      ctx.strokeStyle = '#f57c00';
      ctx.lineWidth   = 1.5;
      ctx.setLineDash([5, 4]);
      ctx.beginPath();
      ctx.moveTo(cx_, PAD.top);
      ctx.lineTo(cx_, PAD.top + plotH);
      ctx.stroke();
      ctx.setLineDash([]);

      // Dot
      ctx.fillStyle = '#f57c00';
      ctx.beginPath();
      ctx.arc(cx_, cy_, 5, 0, Math.PI * 2);
      ctx.fill();

      // Label
      ctx.font = 'bold 10px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillStyle   = '#e65100';
      ctx.textAlign   = cx_ > PAD.left + plotW * 0.6 ? 'right' : 'left';
      ctx.textBaseline = 'bottom';
      const labelX = cx_ > PAD.left + plotW * 0.6 ? cx_ - 8 : cx_ + 8;
      ctx.fillText('Compensation', labelX, cy_ - 4);
      ctx.fillText('point', labelX, cy_ - 14);
      ctx.fillText('LI â‰ˆ ' + Math.round((compI / STEPS) * 100), labelX, cy_ + 14);
    }

    // â”€â”€ Light saturation point annotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (satI > 0 && satI < STEPS - 5) {
      const sx = toX(satI);

      ctx.strokeStyle = '#1565c0';
      ctx.lineWidth   = 1.5;
      ctx.setLineDash([5, 3]);
      ctx.beginPath();
      ctx.moveTo(sx, PAD.top);
      ctx.lineTo(sx, PAD.top + plotH);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.font = 'bold 10px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillStyle    = '#1565c0';
      ctx.textAlign    = sx > PAD.left + plotW * 0.65 ? 'right' : 'left';
      ctx.textBaseline = 'top';
      const lx2 = sx > PAD.left + plotW * 0.65 ? sx - 8 : sx + 8;
      ctx.fillText('Light saturation', lx2, PAD.top + 6);
      ctx.fillText('point', lx2, PAD.top + 18);
    }

    // â”€â”€ Zone labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const midGreenY = PAD.top + Math.max(4, (zeroY - PAD.top) / 2);
    const midRedY   = zeroY + (PAD.top + plotH - zeroY) / 2;

    ctx.font = '10px ' + getComputedStyle(document.body).fontFamily;
    ctx.textAlign    = 'right';
    ctx.textBaseline = 'middle';

    if (midGreenY > PAD.top + 10) {
      ctx.fillStyle = 'rgba(56, 142, 60, 0.7)';
      ctx.fillText('Net O\u2082 release', PAD.left + plotW - 6, midGreenY);
    }
    if (midRedY < PAD.top + plotH - 6) {
      ctx.fillStyle = 'rgba(198, 40, 40, 0.7)';
      ctx.fillText('Net CO\u2082 release', PAD.left + plotW - 6, midRedY);
    }

    return { hasCompPoint: compI > 0 };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CURRENT LIGHT POINT INDICATOR on graph
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function drawCurrentPoint(lightVal, rRate, photoRate) {
    const W  = canvas.width;
    const H  = canvas.height;
    const PAD = { top: 30, right: 20, bottom: 48, left: 58 };
    const plotW = W - PAD.left - PAD.right;
    const plotH = H - PAD.top  - PAD.bottom;

    const co2   = parseInt(document.getElementById('co2').value);
    const temp  = parseInt(document.getElementById('temp').value);
    const water = parseInt(document.getElementById('water').value);

    const netMin = -rRate * 1.25;
    let netMax   = 0;
    for (let i = 0; i <= STEPS; i++) {
      const lv  = (i / STEPS) * 100;
      const pr  = calcPhotosynthesis(lv, co2, temp, water);
      const net = pr - rRate;
      if (net > netMax) netMax = net;
    }
    netMax = Math.max(netMax * 1.15, 1.0);
    const yMin   = Math.min(netMin, -0.5);
    const yRange = netMax - yMin;

    function toX2(v)  { return PAD.left + (v / 100) * plotW; }
    function toY2(v)  { return PAD.top  + (1 - (v - yMin) / yRange) * plotH; }

    const net = photoRate - rRate;
    const px  = toX2(lightVal);
    const py  = toY2(net);

    // Draw pulsing dot for current position
    ctx.fillStyle    = '#ffffff';
    ctx.strokeStyle  = net >= 0 ? '#2e7d32' : '#e53935';
    ctx.lineWidth    = 2.5;
    ctx.beginPath();
    ctx.arc(px, py, 6, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();

    // Value bubble
    const label  = (net >= 0 ? '+' : '') + net.toFixed(1);
    ctx.font     = 'bold 10px ' + getComputedStyle(document.body).fontFamily;
    const textW  = ctx.measureText(label).width + 10;
    const bubbleX = px + 10;
    const bubbleY = py - 14;

    ctx.fillStyle = net >= 0 ? '#2e7d32' : '#e53935';
    const bx = Math.min(bubbleX, PAD.left + plotW - textW - 4);
    const by = Math.max(bubbleY, PAD.top + 2);
    ctx.beginPath();
    ctx.roundRect(bx - 2, by - 2, textW + 2, 16, 3);
    ctx.fill();

    ctx.fillStyle    = '#ffffff';
    ctx.textAlign    = 'left';
    ctx.textBaseline = 'top';
    ctx.fillText(label, bx + 3, by);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // UPDATE ALL UI
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function update() {
    const light = parseInt(document.getElementById('light').value);
    const co2   = parseInt(document.getElementById('co2').value);
    const temp  = parseInt(document.getElementById('temp').value);
    const water = parseInt(document.getElementById('water').value);

    // Update badge displays
    document.getElementById('light-val').textContent = light;
    document.getElementById('co2-val').textContent   = co2;
    document.getElementById('temp-val').textContent  = temp + 'Â°C';
    document.getElementById('water-val').textContent = water;

    // Compute rates
    const photoRate = calcPhotosynthesis(light, co2, temp, water);
    const respRate  = calcRespiration(temp, water);
    const netRate   = photoRate - respRate;

    // Gauges
    updateGauge(photoArc, photoRate / MAX_PHOTO_RATE);
    updateGauge(respArc,  respRate  / 6.0);

    // Gauge value displays
    document.getElementById('photo-val-display').textContent = photoRate.toFixed(1);
    document.getElementById('resp-val-display').textContent  = respRate.toFixed(1);

    // Numeric readout
    document.getElementById('rd-photo').textContent = photoRate.toFixed(1) + ' units';
    document.getElementById('rd-resp').textContent  = respRate.toFixed(1)  + ' units';

    const netEl = document.getElementById('rd-net');
    netEl.textContent = (netRate >= 0 ? '+' : '') + netRate.toFixed(1) + ' units';
    netEl.className   = netRate > 0.05 ? 'net-pos' : (netRate < -0.05 ? 'net-neg' : 'net-zero');

    // Compensation badge
    const compBadge = document.getElementById('comp-badge');
    const { hasCompPoint } = drawGraph(co2, temp, water);
    drawCurrentPoint(light, respRate, photoRate);

    if (hasCompPoint) {
      compBadge.className = 'comp-badge active';
      compBadge.textContent = 'Compensation point shown on graph';
    } else {
      compBadge.className = 'comp-badge inactive';
      compBadge.textContent = netRate <= 0
        ? 'No compensation point: photosynthesis never exceeds respiration'
        : 'No compensation point: photosynthesis always exceeds respiration';
    }

    // Limiting factor bars
    const lf = calcLimitingFactors(light, co2, temp, water);
    setLimBar('light', lf.lightPct);
    setLimBar('co2',   lf.co2Pct);
    setLimBar('temp',  lf.tempPct);
    setLimBar('water', lf.waterPct);

    // Enzyme temperature marker
    const marker = document.getElementById('enzyme-marker');
    marker.style.left = (temp / 50 * 100) + '%';

    const enzymeStatus = document.getElementById('enzyme-status');
    if (temp < 5) {
      enzymeStatus.textContent  = 'Very low activity: insufficient kinetic energy';
      enzymeStatus.style.color  = '#0288d1';
    } else if (temp < 20) {
      enzymeStatus.textContent = 'Below optimum: slow enzyme activity';
      enzymeStatus.style.color = '#00897b';
    } else if (temp <= 35) {
      enzymeStatus.textContent = 'Near optimum: high enzyme activity';
      enzymeStatus.style.color = '#2e7d32';
    } else if (temp <= 42) {
      enzymeStatus.textContent = 'Above optimum: enzyme activity declining';
      enzymeStatus.style.color = '#f57c00';
    } else {
      enzymeStatus.textContent = 'Denaturation: enzyme tertiary structure disrupted';
      enzymeStatus.style.color = '#e53935';
    }
  }

  function setLimBar(name, pct) {
    const fill = document.getElementById('lf-' + name);
    const pctEl = document.getElementById('lf-' + name + '-pct');
    fill.style.width = clamp(pct, 0, 100) + '%';
    pctEl.textContent = clamp(pct, 0, 100) + '%';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // EVENT LISTENERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ['light', 'co2', 'temp', 'water'].forEach(id => {
    document.getElementById(id).addEventListener('input', update);
  });

  window.addEventListener('resize', () => { update(); });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // INITIAL RENDER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  update();

</script>
</body>
</html>
