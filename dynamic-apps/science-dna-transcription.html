<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DNA Transcription &amp; Translation</title>
<style>
:root {
  --bg-primary: #0a0e1a;
  --bg-secondary: #111827;
  --bg-panel: #1a2234;
  --bg-card: #1e293b;
  --border: #2d3a52;
  --border-light: #384766;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent: #38bdf8;
  --accent-dim: rgba(56, 189, 248, 0.15);
  --accent-hover: #7dd3fc;
  --base-a: #22c55e;
  --base-a-bg: rgba(34, 197, 94, 0.2);
  --base-t: #ef4444;
  --base-t-bg: rgba(239, 68, 68, 0.2);
  --base-c: #3b82f6;
  --base-c-bg: rgba(59, 130, 246, 0.2);
  --base-g: #eab308;
  --base-g-bg: rgba(234, 179, 8, 0.2);
  --base-u: #f97316;
  --base-u-bg: rgba(249, 115, 22, 0.2);
  --amino-bg: #7c3aed;
  --amino-text: #f3f4f6;
  --ribosome: #6366f1;
  --ribosome-bg: rgba(99, 102, 241, 0.15);
  --polypeptide: #ec4899;
  --helix-sugar: #475569;
  --success: #22c55e;
  --danger: #dc2626;
  --warning: #f59e0b;
  --header-height: 72px;
  --radius: 8px;
  --radius-sm: 4px;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.5);
  --transition: 0.3s ease;
}

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.55;
  overflow-x: hidden;
}

header {
  position: sticky; top: 0; z-index: 100;
  background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
  border-bottom: 1px solid var(--border); padding: 0 24px;
  height: var(--header-height); display: flex; align-items: center;
  justify-content: space-between; box-shadow: var(--shadow-lg);
}
header .title-group h1 { font-size: 1.3rem; font-weight: 700; color: var(--accent); letter-spacing: 0.3px; }
header .title-group p { font-size: 0.78rem; color: var(--text-secondary); margin-top: 1px; }
.header-right { display: flex; align-items: center; gap: 12px; }
.header-right select {
  background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 6px 10px; font-size: 0.78rem; cursor: pointer; outline: none;
}
.header-right select:focus { border-color: var(--accent); }

main {
  max-width: 1440px; margin: 0 auto; padding: 16px;
  display: grid; grid-template-columns: 1fr 330px; gap: 14px;
}
.panel {
  background: var(--bg-panel); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 16px; box-shadow: var(--shadow);
}
.panel h2 {
  font-size: 0.92rem; color: var(--accent); margin-bottom: 10px;
  padding-bottom: 6px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 6px;
}
.panel h3 { font-size: 0.85rem; color: var(--text-primary); margin: 10px 0 6px 0; }

.full-width { grid-column: 1 / -1; }
.progress-bar-container {
  grid-column: 1 / -1; background: var(--bg-card); border-radius: 6px; height: 6px; overflow: hidden;
}
.progress-bar-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--success));
  border-radius: 6px; transition: width 0.4s ease; width: 0%;
}
.phase-indicator { grid-column: 1 / -1; display: flex; gap: 4px; }
.phase-step {
  flex: 1; text-align: center; padding: 8px 4px; background: var(--bg-card);
  border: 1px solid var(--border); border-radius: var(--radius);
  font-size: 0.72rem; color: var(--text-muted); transition: all var(--transition);
}
.phase-step.active {
  background: var(--accent-dim); border-color: var(--accent); color: var(--accent); font-weight: 600;
}
.phase-step.completed { background: rgba(34,197,94,0.1); border-color: var(--success); color: var(--success); }

.controls-bar {
  grid-column: 1 / -1; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; padding: 10px 16px;
}
.controls-bar label { font-size: 0.78rem; color: var(--text-secondary); }
.btn {
  background: var(--accent); color: #0f172a; border: none; border-radius: var(--radius-sm);
  padding: 7px 16px; font-size: 0.8rem; font-weight: 600; cursor: pointer;
  transition: background 0.2s, transform 0.1s; user-select: none;
}
.btn:hover { background: var(--accent-hover); }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; }
.btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
.btn-secondary:hover { background: #334155; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #ef4444; }
.speed-control { display: flex; align-items: center; gap: 6px; }
.speed-control input[type="range"] { width: 80px; accent-color: var(--accent); }
.speed-val { font-size: 0.72rem; color: var(--text-secondary); min-width: 28px; }
.controls-spacer { flex: 1; }
.step-counter { font-size: 0.76rem; color: var(--text-muted); }
.kbd-hint { font-size: 0.65rem; color: var(--text-muted); margin-left: 4px; }
.kbd-hint kbd {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 3px;
  padding: 1px 4px; font-size: 0.6rem; font-family: inherit;
}

.viz-area { display: flex; flex-direction: column; gap: 14px; }
.base-legend { display: flex; gap: 12px; flex-wrap: wrap; padding: 6px 0; font-size: 0.72rem; }
.base-legend-item { display: flex; align-items: center; gap: 4px; }
.base-legend-swatch {
  width: 16px; height: 16px; border-radius: 3px; display: flex; align-items: center;
  justify-content: center; font-size: 0.65rem; font-weight: 700; font-family: 'Consolas', 'Courier New', monospace;
}
.helix-panel canvas {
  width: 100%; height: 180px; display: block;
  border-radius: var(--radius-sm); background: rgba(0,0,0,0.15);
}

.strand-container { overflow-x: auto; padding: 6px 0; }
.strand-container::-webkit-scrollbar { height: 6px; }
.strand-container::-webkit-scrollbar-track { background: var(--bg-card); border-radius: 3px; }
.strand-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.strand-row { display: flex; align-items: center; gap: 2px; margin: 2px 0; min-width: max-content; }
.strand-label {
  font-size: 0.68rem; color: var(--text-muted); width: 90px; flex-shrink: 0;
  text-align: right; padding-right: 8px; font-weight: 600;
}
.base-cell {
  width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
  font-size: 0.78rem; font-weight: 700; border-radius: var(--radius-sm);
  transition: all var(--transition); font-family: 'Consolas', 'Courier New', monospace;
}
.base-cell.empty { background: rgba(255,255,255,0.02); border: 1px dashed rgba(255,255,255,0.08); color: transparent; }
.base-cell.appearing { animation: baseAppear 0.4s ease forwards; }
@keyframes baseAppear {
  0% { transform: scale(0) translateY(-16px); opacity: 0; }
  60% { transform: scale(1.12) translateY(0); }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}
.base-A { background: var(--base-a-bg); color: var(--base-a); border: 1px solid var(--base-a); }
.base-T { background: var(--base-t-bg); color: var(--base-t); border: 1px solid var(--base-t); }
.base-C { background: var(--base-c-bg); color: var(--base-c); border: 1px solid var(--base-c); }
.base-G { background: var(--base-g-bg); color: var(--base-g); border: 1px solid var(--base-g); }
.base-U { background: var(--base-u-bg); color: var(--base-u); border: 1px solid var(--base-u); }
.base-cell.codon-active { outline: 2px solid var(--accent); outline-offset: 1px; box-shadow: 0 0 8px rgba(56,189,248,0.4); }
.bond-row { display: flex; gap: 2px; margin: 0; min-width: max-content; }
.bond-cell {
  width: 28px; height: 12px; display: flex; align-items: center;
  justify-content: center; font-size: 0.55rem; color: var(--text-muted);
}
.bond-spacer { width: 90px; flex-shrink: 0; }
.codon-markers { display: flex; gap: 2px; min-width: max-content; margin-top: 2px; }
.codon-marker {
  width: 28px; height: 14px; display: flex; align-items: center;
  justify-content: center; font-size: 0.5rem; color: var(--text-muted);
}
.codon-marker-spacer { width: 90px; flex-shrink: 0; }

.translation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start; }
.ribosome-view { padding: 12px 8px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
.ribosome-body {
  background: linear-gradient(180deg, rgba(99,102,241,0.25), rgba(99,102,241,0.08));
  border: 2px solid var(--ribosome); border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
  width: 200px; height: 120px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; position: relative; gap: 6px;
}
.ribosome-label {
  font-size: 0.62rem; color: var(--ribosome); font-weight: 700;
  letter-spacing: 1px; position: absolute; top: -16px; text-transform: uppercase;
}
.ribosome-sublabel { font-size: 0.55rem; color: var(--text-muted); position: absolute; bottom: -14px; }
.codon-window {
  display: flex; gap: 3px; padding: 5px 10px;
  background: rgba(0,0,0,0.35); border-radius: var(--radius-sm); border: 1px solid rgba(99,102,241,0.3);
}
.trna-display { font-size: 0.7rem; color: var(--text-secondary); text-align: center; line-height: 1.4; }
.trna-display strong { color: var(--text-primary); }
.trna-graphic {
  display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 10px;
  background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border);
  min-height: 100px; justify-content: center;
}
.trna-arm { font-size: 0.6rem; color: var(--text-muted); text-align: center; }
.trna-anticodon-row { display: flex; gap: 2px; }
.trna-amino-label {
  font-size: 0.75rem; font-weight: 700; padding: 4px 10px;
  border-radius: 10px; color: var(--amino-text); margin-top: 4px;
}

.polypeptide-container { display: flex; flex-wrap: wrap; gap: 3px; align-items: center; padding: 8px; min-height: 36px; }
.amino-acid-bead {
  display: inline-flex; align-items: center; justify-content: center; padding: 3px 8px;
  border-radius: 12px; font-size: 0.66rem; font-weight: 600; color: var(--amino-text);
  animation: beadAppear 0.35s ease; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
@keyframes beadAppear {
  0% { transform: scale(0); opacity: 0; }
  70% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}
.amino-acid-bead.stop-bead { background: var(--danger); font-style: italic; }
.peptide-bond { color: var(--text-muted); font-size: 0.55rem; padding: 0 1px; }
.status-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; }
.status-item { background: var(--bg-card); border-radius: var(--radius-sm); padding: 8px 10px; border-left: 3px solid var(--accent); }
.status-item .label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.status-item .value { font-size: 0.88rem; font-weight: 600; color: var(--text-primary); font-family: 'Consolas', 'Courier New', monospace; }

.sidebar { display: flex; flex-direction: column; gap: 14px; }
.codon-table-container { max-height: 360px; overflow-y: auto; }
.codon-table-container::-webkit-scrollbar { width: 5px; }
.codon-table-container::-webkit-scrollbar-track { background: var(--bg-card); }
.codon-table-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.codon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; font-size: 0.62rem; }
.codon-entry {
  background: var(--bg-card); padding: 3px 4px; border-radius: 2px;
  text-align: center; transition: all 0.2s; border: 1px solid transparent; cursor: default;
}
.codon-entry:hover { border-color: var(--border-light); }
.codon-entry .codon-seq { font-family: 'Consolas', 'Courier New', monospace; font-weight: 700; color: var(--text-secondary); font-size: 0.6rem; }
.codon-entry .codon-aa { font-weight: 600; font-size: 0.58rem; }
.codon-entry.highlighted { background: var(--accent-dim); border-color: var(--accent); transform: scale(1.05); }
.codon-entry.stop-highlight { background: rgba(220,38,38,0.2); border-color: var(--danger); transform: scale(1.05); }

.info-content { font-size: 0.76rem; color: var(--text-secondary); line-height: 1.6; }
.info-content p { margin-bottom: 8px; }
.info-content strong { color: var(--text-primary); }
.info-content .highlight-box {
  background: var(--bg-card); border-left: 3px solid var(--accent);
  padding: 8px 10px; margin: 8px 0; border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-size: 0.73rem;
}
.info-content .warn-box {
  background: rgba(245,158,11,0.08); border-left: 3px solid var(--warning);
  padding: 8px 10px; margin: 8px 0; border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-size: 0.73rem;
}
.info-content ul { margin: 4px 0 8px 18px; font-size: 0.73rem; }
.info-content li { margin-bottom: 3px; }
.seq-info { font-size: 0.7rem; color: var(--text-muted); padding: 6px 0; }
.seq-info span { margin-right: 14px; }

/* === RESPONSIVE === */
@media (max-width: 960px) {
  main {
    grid-template-columns: 1fr;
  }
  .sidebar { order: 10; }
  .viz-area { order: 1; }
  .controls-bar { order: 0; }
  .phase-indicator { order: -1; }
  .progress-bar-container { order: -2; }
  header { padding: 0 16px; }
  header .title-group h1 { font-size: 1.1rem; }
  .translation-grid { grid-template-columns: 1fr; }
}

@media (max-width: 600px) {
  .controls-bar { gap: 6px; }
  .btn { padding: 6px 10px; font-size: 0.73rem; }
  .base-cell { width: 22px; height: 22px; font-size: 0.68rem; }
  .bond-cell { width: 22px; }
  .strand-label { width: 66px; font-size: 0.6rem; }
  .bond-spacer, .codon-marker-spacer { width: 66px; }
  .codon-marker { width: 22px; }
  .phase-step { font-size: 0.6rem; padding: 6px 2px; }
  .kbd-hint { display: none; }
  .ribosome-body { width: 160px; height: 100px; }
}
</style>
</head>
<body>

<header>
  <div class="title-group">
    <h1>DNA Transcription &amp; Translation</h1>
    <p>Step through the Central Dogma of Molecular Biology</p>
  </div>
  <div class="header-right">
    <select id="sequenceSelect" title="Choose a DNA sequence">
      <option value="0">Insulin fragment (33 bases)</option>
      <option value="1">Haemoglobin fragment (39 bases)</option>
      <option value="2">Collagen fragment (45 bases)</option>
      <option value="3">Enkephalin (24 bases)</option>
    </select>
  </div>
</header>

<main>
  <!-- Progress bar -->
  <div class="progress-bar-container full-width">
    <div class="progress-bar-fill" id="progressBar"></div>
  </div>

  <!-- Phase indicator -->
  <div class="phase-indicator">
    <div class="phase-step" id="phase-helix">1. DNA Double Helix</div>
    <div class="phase-step" id="phase-transcription">2. Transcription</div>
    <div class="phase-step" id="phase-processing">3. mRNA Processing</div>
    <div class="phase-step" id="phase-translation">4. Translation</div>
    <div class="phase-step" id="phase-complete">5. Protein Complete</div>
  </div>

  <!-- Controls -->
  <div class="controls-bar panel full-width">
    <button class="btn" id="btnNext">Next Step</button>
    <span class="kbd-hint"><kbd>Space</kbd></span>
    <button class="btn btn-secondary" id="btnAuto">Auto-play</button>
    <div class="speed-control">
      <label>Speed:</label>
      <input type="range" id="speedSlider" min="1" max="10" value="5" title="Playback speed">
      <span class="speed-val" id="speedLabel">5x</span>
    </div>
    <button class="btn btn-danger" id="btnReset">Reset</button>
    <div class="controls-spacer"></div>
    <div class="step-counter" id="stepCounter">Step 0</div>
  </div>

  <!-- Visualisation area (left column) -->
  <div class="viz-area">
    <!-- Base legend -->
    <div class="panel">
      <h2>Base Key</h2>
      <div class="base-legend" id="baseLegend"></div>
      <div class="seq-info" id="seqInfo"></div>
    </div>

    <!-- Helix display -->
    <div class="panel helix-panel">
      <h2>DNA Double Helix (2D Ladder View)</h2>
      <canvas id="helixCanvas"></canvas>
    </div>

    <!-- Strand display -->
    <div class="panel" id="strandPanel">
      <h2>Strand View</h2>
      <div class="strand-container" id="strandContainer"></div>
    </div>

    <!-- Translation area (ribosome + tRNA) -->
    <div class="panel" id="translationPanel" style="display:none;">
      <h2>Translation at the Ribosome</h2>
      <div class="translation-grid">
        <div class="ribosome-view">
          <div class="ribosome-body">
            <span class="ribosome-label">Ribosome</span>
            <div class="codon-window" id="codonWindow"></div>
            <div class="trna-display" id="trnaDisplay">Waiting for mRNA...</div>
            <span class="ribosome-sublabel">A site | P site</span>
          </div>
        </div>
        <div class="trna-graphic" id="trnaGraphic">
          <div class="trna-arm">tRNA molecule</div>
          <div class="trna-anticodon-row" id="trnaAnticodonRow"></div>
          <div class="trna-arm" id="trnaArrow"></div>
          <div class="trna-amino-label" id="trnaAminoLabel" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- Status bar -->
    <div class="panel">
      <h2>Current Status</h2>
      <div class="status-bar">
        <div class="status-item">
          <div class="label">Phase</div>
          <div class="value" id="statusPhase">Ready</div>
        </div>
        <div class="status-item">
          <div class="label">Current Codon</div>
          <div class="value" id="statusCodon">---</div>
        </div>
        <div class="status-item">
          <div class="label">Amino Acid</div>
          <div class="value" id="statusAmino">---</div>
        </div>
        <div class="status-item">
          <div class="label">Chain Length</div>
          <div class="value" id="statusChain">0</div>
        </div>
      </div>
    </div>

    <!-- Polypeptide chain -->
    <div class="panel" id="polypeptidePanel" style="display:none;">
      <h2>Growing Polypeptide Chain</h2>
      <div class="polypeptide-container" id="polypeptideChain"></div>
    </div>
  </div>

  <!-- Sidebar (right column) -->
  <div class="sidebar">
    <!-- Codon Table -->
    <div class="panel">
      <h2>Codon Table (64 Codons)</h2>
      <div class="codon-table-container" id="codonTableContainer"></div>
    </div>

    <!-- Info panel -->
    <div class="panel">
      <h2>Information</h2>
      <div class="info-content" id="infoContent"></div>
    </div>
  </div>
</main>

<script>
(function() {
  'use strict';

  /* ================================================================
     CODON LOOKUP TABLE: all 64 codons mapped to amino acids
     ================================================================ */
  var CODON_MAP = {
    'UUU':'Phe','UUC':'Phe','UUA':'Leu','UUG':'Leu',
    'CUU':'Leu','CUC':'Leu','CUA':'Leu','CUG':'Leu',
    'AUU':'Ile','AUC':'Ile','AUA':'Ile','AUG':'Met',
    'GUU':'Val','GUC':'Val','GUA':'Val','GUG':'Val',
    'UCU':'Ser','UCC':'Ser','UCA':'Ser','UCG':'Ser',
    'CCU':'Pro','CCC':'Pro','CCA':'Pro','CCG':'Pro',
    'ACU':'Thr','ACC':'Thr','ACA':'Thr','ACG':'Thr',
    'GCU':'Ala','GCC':'Ala','GCA':'Ala','GCG':'Ala',
    'UAU':'Tyr','UAC':'Tyr','UAA':'Stop','UAG':'Stop',
    'UGU':'Cys','UGC':'Cys','UGA':'Stop','UGG':'Trp',
    'CAU':'His','CAC':'His','CAA':'Gln','CAG':'Gln',
    'CGU':'Arg','CGC':'Arg','CGA':'Arg','CGG':'Arg',
    'AAU':'Asn','AAC':'Asn','AAA':'Lys','AAG':'Lys',
    'AGU':'Ser','AGC':'Ser','AGA':'Arg','AGG':'Arg',
    'GAU':'Asp','GAC':'Asp','GAA':'Glu','GAG':'Glu',
    'GGU':'Gly','GGC':'Gly','GGA':'Gly','GGG':'Gly'
  };

  /* Amino acid colours for polypeptide beads and tRNA label */
  var AMINO_COLORS = {
    'Phe':'#8b5cf6', 'Leu':'#a78bfa', 'Ile':'#7c3aed', 'Met':'#22c55e',
    'Val':'#6d28d9', 'Ser':'#3b82f6', 'Pro':'#ec4899', 'Thr':'#14b8a6',
    'Ala':'#f97316', 'Tyr':'#eab308', 'Cys':'#a3e635', 'Trp':'#06b6d4',
    'His':'#f43f5e', 'Gln':'#d946ef', 'Arg':'#2563eb', 'Asn':'#f59e0b',
    'Lys':'#10b981', 'Asp':'#ef4444', 'Glu':'#dc2626', 'Gly':'#64748b',
    'Stop':'#dc2626'
  };

  /* Full amino acid names for the info display */
  var AMINO_FULL = {
    'Phe':'Phenylalanine','Leu':'Leucine','Ile':'Isoleucine','Met':'Methionine (START)',
    'Val':'Valine','Ser':'Serine','Pro':'Proline','Thr':'Threonine',
    'Ala':'Alanine','Tyr':'Tyrosine','Cys':'Cysteine','Trp':'Tryptophan',
    'His':'Histidine','Gln':'Glutamine','Arg':'Arginine','Asn':'Asparagine',
    'Lys':'Lysine','Asp':'Aspartate','Glu':'Glutamate','Gly':'Glycine',
    'Stop':'STOP signal'
  };

  /* Base colour map for canvas rendering */
  var BASE_COLOR = {
    A: '#22c55e', T: '#ef4444', C: '#3b82f6', G: '#eab308', U: '#f97316'
  };

  /* ================================================================
     PRESET DNA SEQUENCES (template strand shown 3' to 5')
     Each starts with TAC (so mRNA begins AUG = start codon) and
     ends with a stop-codon complement.
     ================================================================ */
  var SEQUENCES = [
    {
      name: 'Insulin fragment',
      desc: 'A short fragment inspired by human insulin B-chain.',
      template: 'TACCAATTGCCTGAGCTTACGAATCCGACTATT'
    },
    {
      name: 'Haemoglobin fragment',
      desc: 'Fragment inspired by haemoglobin beta subunit.',
      template: 'TACGTTCACCTGACCCCAGAGGAGAAGTCTGCCGTTACT'
    },
    {
      name: 'Collagen fragment',
      desc: 'Repeating Gly-Pro-Pro motif typical of collagen.',
      template: 'TACCCTGGACCAGGTCCAGGTCCTGGACCAGGACCAGGCCCAATT'
    },
    {
      name: 'Enkephalin',
      desc: 'Met-enkephalin, a short opioid peptide.',
      template: 'TACTTCGAATACGGACCAATT'
    }
  ];

  /* Helper: DNA complement */
  function dnaComplement(b) {
    return { A:'T', T:'A', C:'G', G:'C' }[b];
  }

  /* Helper: coding strand from template */
  function codingStrand(template) {
    return template.split('').map(dnaComplement).join('');
  }

  /* Helper: transcribe one template base to mRNA */
  function transcribeBase(b) {
    return { A:'U', T:'A', C:'G', G:'C' }[b];
  }

  /* Helper: mRNA base to tRNA anticodon base */
  function anticodonOf(b) {
    return { A:'U', U:'A', C:'G', G:'C' }[b];
  }

  /* ================================================================
     APPLICATION STATE
     ================================================================ */
  var state = {
    seqIndex: 0,
    phase: 'idle',
    step: 0,
    totalSteps: 0,
    mRNA: [],
    protein: [],
    autoPlay: false,
    autoTimer: null,
    transcriptionIndex: 0,
    translationCodonIndex: 0
  };

  /* ================================================================
     DOM REFERENCES
     ================================================================ */
  function $(id) { return document.getElementById(id); }

  var helixCanvas = $('helixCanvas');
  var ctx = helixCanvas.getContext('2d');
  var strandContainer = $('strandContainer');
  var translationPanel = $('translationPanel');
  var polypeptidePanel = $('polypeptidePanel');
  var codonWindow = $('codonWindow');
  var trnaDisplay = $('trnaDisplay');
  var trnaGraphic = $('trnaGraphic');
  var trnaAnticodonRow = $('trnaAnticodonRow');
  var trnaArrow = $('trnaArrow');
  var trnaAminoLabel = $('trnaAminoLabel');
  var polypeptideChain = $('polypeptideChain');
  var codonTableContainer = $('codonTableContainer');
  var btnNext = $('btnNext');
  var btnAuto = $('btnAuto');
  var btnReset = $('btnReset');
  var sequenceSelect = $('sequenceSelect');
  var speedSlider = $('speedSlider');
  var speedLabel = $('speedLabel');
  var stepCounter = $('stepCounter');
  var progressBar = $('progressBar');
  var baseLegend = $('baseLegend');
  var seqInfo = $('seqInfo');
  var infoContent = $('infoContent');

  /* ================================================================
     INITIALISATION
     ================================================================ */
  function init() {
    buildBaseLegend();
    buildCodonTable();
    bindEvents();
    resetAll();
    showDefaultInfo();
  }

  function bindEvents() {
    btnNext.addEventListener('click', nextStep);
    btnAuto.addEventListener('click', toggleAutoPlay);
    btnReset.addEventListener('click', resetAll);
    sequenceSelect.addEventListener('change', function() {
      state.seqIndex = parseInt(this.value);
      resetAll();
    });
    speedSlider.addEventListener('input', function() {
      speedLabel.textContent = this.value + 'x';
      if (state.autoPlay) {
        stopAutoPlay();
        startAutoPlay();
      }
    });
    window.addEventListener('resize', onResize);

    /* Keyboard shortcut: Space = next step, Escape = reset */
    document.addEventListener('keydown', function(e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      if (e.code === 'Space') {
        e.preventDefault();
        if (state.phase !== 'complete') nextStep();
      } else if (e.code === 'Escape') {
        resetAll();
      } else if (e.code === 'KeyA') {
        toggleAutoPlay();
      }
    });
  }

  function getSpeed() {
    var v = parseInt(speedSlider.value);
    return 1300 - (v - 1) * 120;
  }

  /* ================================================================
     BASE LEGEND
     ================================================================ */
  function buildBaseLegend() {
    var items = [
      { base: 'A', label: 'Adenine', cls: 'base-A' },
      { base: 'T', label: 'Thymine', cls: 'base-T' },
      { base: 'C', label: 'Cytosine', cls: 'base-C' },
      { base: 'G', label: 'Guanine', cls: 'base-G' },
      { base: 'U', label: 'Uracil (RNA)', cls: 'base-U' }
    ];
    baseLegend.innerHTML = items.map(function(it) {
      return '<div class="base-legend-item">' +
        '<div class="base-legend-swatch ' + it.cls + '">' + it.base + '</div>' +
        '<span style="color:var(--text-secondary);">' + it.label + '</span>' +
        '</div>';
    }).join('');
  }

  /* ================================================================
     SEQUENCE INFO LINE
     ================================================================ */
  function updateSeqInfo() {
    var seq = SEQUENCES[state.seqIndex];
    var t = seq.template;
    var codons = Math.floor(t.length / 3);
    seqInfo.innerHTML =
      '<span><strong>Sequence:</strong> ' + seq.name + '</span>' +
      '<span><strong>Bases:</strong> ' + t.length + '</span>' +
      '<span><strong>Codons:</strong> ' + codons + '</span>' +
      '<span style="color:var(--text-muted);font-style:italic;">' + seq.desc + '</span>';
  }

  /* ================================================================
     RESET
     ================================================================ */
  function resetAll() {
    stopAutoPlay();
    var seq = SEQUENCES[state.seqIndex];
    state.phase = 'idle';
    state.step = 0;
    state.mRNA = [];
    state.protein = [];
    state.transcriptionIndex = 0;
    state.translationCodonIndex = 0;
    state.totalSteps = computeTotalSteps(seq.template);
    translationPanel.style.display = 'none';
    polypeptidePanel.style.display = 'none';
    codonWindow.innerHTML = '';
    trnaDisplay.textContent = 'Waiting for mRNA...';
    trnaAnticodonRow.innerHTML = '';
    trnaAminoLabel.style.display = 'none';
    trnaArrow.textContent = '';
    polypeptideChain.innerHTML = '';
    updatePhaseIndicator();
    updateStatus('Ready', '---', '---', 0);
    updateStepCounter();
    updateProgress();
    updateSeqInfo();
    renderStrands();
    resizeHelixCanvas();
    drawHelix(seq.template, 0);
    clearCodonHighlight();
    showDefaultInfo();
  }

  function computeTotalSteps(template) {
    /* 1 (start) + N (transcription bases) + 1 (processing) + codons (translation) */
    return 1 + template.length + 1 + Math.floor(template.length / 3);
  }

  /* ================================================================
     PROGRESS BAR
     ================================================================ */
  function updateProgress() {
    var pct = state.totalSteps > 0 ? Math.min(100, (state.step / state.totalSteps) * 100) : 0;
    progressBar.style.width = pct + '%';
  }

  /* ================================================================
     PHASE INDICATOR
     ================================================================ */
  function updatePhaseIndicator() {
    var phases = ['helix', 'transcription', 'processing', 'translation', 'complete'];
    var order = { idle: -1, helix: 0, transcription: 1, processing: 2, translation: 3, complete: 4 };
    var current = order[state.phase] !== undefined ? order[state.phase] : -1;
    phases.forEach(function(p, i) {
      var el = $('phase-' + p);
      el.className = 'phase-step';
      if (i < current) el.classList.add('completed');
      else if (i === current) el.classList.add('active');
    });
  }

  /* ================================================================
     STATUS DISPLAY
     ================================================================ */
  function updateStatus(phase, codon, amino, chainLen) {
    $('statusPhase').textContent = phase;
    $('statusCodon').textContent = codon;
    $('statusAmino').textContent = amino;
    $('statusChain').textContent = chainLen;
  }

  function updateStepCounter() {
    stepCounter.textContent = 'Step ' + state.step + ' / ' + state.totalSteps;
  }

  /* ================================================================
     HELIX CANVAS: 2D ladder view with unwinding animation
     ================================================================ */
  function onResize() { resizeHelixCanvas(); }

  function resizeHelixCanvas() {
    var parent = helixCanvas.parentElement;
    var w = parent.clientWidth - 32;
    helixCanvas.width = w * (window.devicePixelRatio || 1);
    helixCanvas.height = 180 * (window.devicePixelRatio || 1);
    helixCanvas.style.width = w + 'px';
    helixCanvas.style.height = '180px';
    ctx.setTransform((window.devicePixelRatio || 1), 0, 0, (window.devicePixelRatio || 1), 0, 0);
    var seq = SEQUENCES[state.seqIndex];
    var progress = state.transcriptionIndex / seq.template.length;
    if (state.phase === 'idle') progress = 0;
    drawHelix(seq.template, progress);
  }

  function drawHelix(template, unwoundFraction) {
    var w = helixCanvas.width / (window.devicePixelRatio || 1);
    var h = 180;
    ctx.clearRect(0, 0, w, h);

    var n = template.length;
    var spacing = Math.min(24, (w - 60) / n);
    var startX = 30;
    var cy = h / 2;
    var amp = 32;
    var comp = { A:'T', T:'A', C:'G', G:'C' };

    /* Draw backbone lines first (behind bases) */
    ctx.lineWidth = 2;
    for (var i = 1; i < n; i++) {
      var x0 = startX + (i - 1) * spacing;
      var x1 = startX + i * spacing;
      var prevUnwound = (i - 1) / n < unwoundFraction;
      var currUnwound = i / n < unwoundFraction;

      if (!prevUnwound && !currUnwound) {
        /* Both wound: sinusoidal backbone */
        var ph0 = ((i - 1) / n) * Math.PI * 4;
        var ph1 = (i / n) * Math.PI * 4;
        var ty0 = cy + Math.sin(ph0) * amp;
        var ty1 = cy + Math.sin(ph1) * amp;
        var by0 = cy - Math.sin(ph0) * amp;
        var by1 = cy - Math.sin(ph1) * amp;
        ctx.strokeStyle = '#475569';
        ctx.beginPath(); ctx.moveTo(x0, ty0); ctx.lineTo(x1, ty1); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x0, by0); ctx.lineTo(x1, by1); ctx.stroke();
      } else if (prevUnwound && currUnwound) {
        /* Both unwound: flat separated strands */
        var sepT = cy - amp - 12;
        var sepC = cy + amp + 12;
        ctx.strokeStyle = '#475569';
        ctx.beginPath(); ctx.moveTo(x0, sepT); ctx.lineTo(x1, sepT); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x0, sepC); ctx.lineTo(x1, sepC); ctx.stroke();
      }
    }

    /* Draw rungs, bases, and mRNA */
    for (var i = 0; i < n; i++) {
      var x = startX + i * spacing;
      var unwound = i / n < unwoundFraction;
      var tBase = template[i];
      var cBase = comp[tBase];

      if (!unwound) {
        var ph = (i / n) * Math.PI * 4;
        var ty = cy + Math.sin(ph) * amp;
        var by = cy - Math.sin(ph) * amp;

        /* Hydrogen bond rung */
        ctx.beginPath();
        ctx.moveTo(x, ty);
        ctx.lineTo(x, by);
        ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
        ctx.lineWidth = 1;
        ctx.setLineDash([3, 3]);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.lineWidth = 2;

        /* Template base (top strand) */
        ctx.beginPath();
        ctx.arc(x, ty, 6, 0, Math.PI * 2);
        ctx.fillStyle = BASE_COLOR[tBase];
        ctx.fill();

        /* Coding base (bottom strand) */
        ctx.beginPath();
        ctx.arc(x, by, 6, 0, Math.PI * 2);
        ctx.fillStyle = BASE_COLOR[cBase];
        ctx.fill();

        /* Base letter labels (only if enough spacing) */
        if (spacing >= 16) {
          ctx.font = '8px Consolas, monospace';
          ctx.fillStyle = '#0f172a';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(tBase, x, ty);
          ctx.fillText(cBase, x, by);
        }
      } else {
        /* Unwound region */
        var sepT = cy - amp - 12;
        var sepC = cy + amp + 12;

        /* Template base (top, separated) */
        ctx.beginPath();
        ctx.arc(x, sepT, 6, 0, Math.PI * 2);
        ctx.fillStyle = BASE_COLOR[tBase];
        ctx.fill();

        /* Coding base (bottom, separated) */
        ctx.beginPath();
        ctx.arc(x, sepC, 6, 0, Math.PI * 2);
        ctx.fillStyle = BASE_COLOR[cBase];
        ctx.fill();

        if (spacing >= 16) {
          ctx.font = '8px Consolas, monospace';
          ctx.fillStyle = '#0f172a';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(tBase, x, sepT);
          ctx.fillText(cBase, x, sepC);
        }

        /* mRNA base being built (between template and centre) */
        if (i < state.mRNA.length) {
          var mBase = state.mRNA[i];
          var my = sepT + 16;

          /* Hydrogen bond from template to mRNA */
          ctx.beginPath();
          ctx.moveTo(x, sepT + 6);
          ctx.lineTo(x, my - 4);
          ctx.strokeStyle = 'rgba(249, 115, 22, 0.4)';
          ctx.lineWidth = 1;
          ctx.setLineDash([2, 2]);
          ctx.stroke();
          ctx.setLineDash([]);
          ctx.lineWidth = 2;

          ctx.beginPath();
          ctx.arc(x, my, 5, 0, Math.PI * 2);
          ctx.fillStyle = BASE_COLOR[mBase];
          ctx.fill();

          if (spacing >= 16) {
            ctx.font = '7px Consolas, monospace';
            ctx.fillStyle = '#0f172a';
            ctx.fillText(mBase, x, my);
          }
        }

        /* RNA polymerase indicator at the unwinding front */
        if (i === state.transcriptionIndex - 1 && state.phase === 'transcription') {
          ctx.beginPath();
          ctx.arc(x + spacing * 0.5, cy, 10, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(56, 189, 248, 0.15)';
          ctx.fill();
          ctx.strokeStyle = 'rgba(56, 189, 248, 0.6)';
          ctx.lineWidth = 1.5;
          ctx.stroke();
          ctx.lineWidth = 2;
          ctx.font = '6px Segoe UI';
          ctx.fillStyle = '#38bdf8';
          ctx.textAlign = 'center';
          ctx.fillText('RNA Pol', x + spacing * 0.5, cy + 3);
        }
      }
    }

    /* Strand direction labels */
    ctx.font = '9px Segoe UI';
    ctx.fillStyle = '#64748b';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText("3'", 4, cy - amp);
    ctx.fillText("5'", 4, cy + amp);
    ctx.textAlign = 'right';
    ctx.fillText("5'", w - 4, cy - amp);
    ctx.fillText("3'", w - 4, cy + amp);

    /* Label strands */
    ctx.textAlign = 'left';
    ctx.font = '8px Segoe UI';
    ctx.fillStyle = '#94a3b8';
    ctx.fillText('Template', 4, cy - amp - 14);
    ctx.fillText('Coding', 4, cy + amp + 16);
    if (state.mRNA.length > 0) {
      ctx.fillStyle = '#f97316';
      ctx.fillText('mRNA', 4, cy - amp + 10);
    }
  }

  /* ================================================================
     STRAND RENDERING (text-based base cells)
     ================================================================ */
  function renderStrands() {
    var seq = SEQUENCES[state.seqIndex];
    var template = seq.template;
    var coding = codingStrand(template);
    var html = '';

    /* Coding strand (5' to 3') */
    html += '<div class="strand-row">';
    html += '<div class="strand-label">Coding 5\'&rarr;3\'</div>';
    for (var i = 0; i < coding.length; i++) {
      html += '<div class="base-cell base-' + coding[i] + '">' + coding[i] + '</div>';
    }
    html += '</div>';

    /* Bond row */
    html += '<div class="bond-row">';
    html += '<div class="bond-spacer"></div>';
    for (var i = 0; i < template.length; i++) {
      var bonds = (template[i] === 'C' || template[i] === 'G') ? '|||' : '||';
      html += '<div class="bond-cell">' + bonds + '</div>';
    }
    html += '</div>';

    /* Template strand (3' to 5') */
    html += '<div class="strand-row">';
    html += '<div class="strand-label">Template 3\'&rarr;5\'</div>';
    for (var i = 0; i < template.length; i++) {
      html += '<div class="base-cell base-' + template[i] + '">' + template[i] + '</div>';
    }
    html += '</div>';

    /* Bond row for mRNA (hidden initially) */
    html += '<div class="bond-row" id="mrnaBondRow" style="display:none;">';
    html += '<div class="bond-spacer"></div>';
    for (var i = 0; i < template.length; i++) {
      html += '<div class="bond-cell" id="mrnaBond' + i + '"></div>';
    }
    html += '</div>';

    /* mRNA strand (hidden initially, cells start empty) */
    html += '<div class="strand-row" id="mrnaRow" style="display:none;">';
    html += '<div class="strand-label" style="color:var(--base-u);">mRNA 5\'&rarr;3\'</div>';
    for (var i = 0; i < template.length; i++) {
      html += '<div class="base-cell empty" id="mrnaBase' + i + '"></div>';
    }
    html += '</div>';

    /* Codon grouping markers (hidden initially) */
    html += '<div class="codon-markers" id="codonMarkerRow" style="display:none;">';
    html += '<div class="codon-marker-spacer"></div>';
    for (var i = 0; i < template.length; i++) {
      var codonNum = Math.floor(i / 3) + 1;
      var posInCodon = i % 3;
      if (posInCodon === 1) {
        html += '<div class="codon-marker" style="color:var(--accent);font-weight:600;">' + codonNum + '</div>';
      } else {
        html += '<div class="codon-marker"></div>';
      }
    }
    html += '</div>';

    strandContainer.innerHTML = html;
  }

  function showMrnaRow() {
    var mrnaRow = $('mrnaRow');
    var bondRow = $('mrnaBondRow');
    if (mrnaRow) mrnaRow.style.display = 'flex';
    if (bondRow) bondRow.style.display = 'flex';
  }

  function showCodonMarkers() {
    var row = $('codonMarkerRow');
    if (row) row.style.display = 'flex';
  }

  function addMrnaBase(index, base) {
    var cell = $('mrnaBase' + index);
    var bond = $('mrnaBond' + index);
    if (cell) {
      cell.className = 'base-cell base-' + base + ' appearing';
      cell.textContent = base;
    }
    if (bond) bond.textContent = '|';

    /* Scroll the strand container to keep current base visible */
    var container = strandContainer;
    if (cell) {
      var cellLeft = cell.offsetLeft;
      var containerScroll = container.scrollLeft;
      var containerWidth = container.clientWidth;
      if (cellLeft > containerScroll + containerWidth - 100) {
        container.scrollTo({ left: cellLeft - containerWidth + 150, behavior: 'smooth' });
      }
    }
  }

  /* ================================================================
     CODON TABLE: 64 entries, 4 columns
     ================================================================ */
  function buildCodonTable() {
    var bases = ['U', 'C', 'A', 'G'];
    var html = '<div class="codon-grid">';
    for (var i1 = 0; i1 < 4; i1++) {
      for (var i2 = 0; i2 < 4; i2++) {
        for (var i3 = 0; i3 < 4; i3++) {
          var codon = bases[i1] + bases[i2] + bases[i3];
          var aa = CODON_MAP[codon];
          var col = AMINO_COLORS[aa] || '#7c3aed';
          html += '<div class="codon-entry" id="codon-' + codon + '">';
          html += '<span class="codon-seq">' + codon + '</span> ';
          html += '<span class="codon-aa" style="color:' + col + ';">' + aa + '</span>';
          html += '</div>';
        }
      }
    }
    html += '</div>';
    codonTableContainer.innerHTML = html;
  }

  function highlightCodon(codon) {
    clearCodonHighlight();
    var el = $('codon-' + codon);
    if (el) {
      var aa = CODON_MAP[codon];
      el.classList.add(aa === 'Stop' ? 'stop-highlight' : 'highlighted');
      el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
  }

  function clearCodonHighlight() {
    document.querySelectorAll('.codon-entry.highlighted, .codon-entry.stop-highlight').forEach(function(el) {
      el.classList.remove('highlighted', 'stop-highlight');
    });
  }

  /* ================================================================
     MRNA CODON HIGHLIGHTING (in the strand view)
     ================================================================ */
  function highlightMrnaCodon(startIdx) {
    clearMrnaHighlight();
    var len = SEQUENCES[state.seqIndex].template.length;
    for (var i = startIdx; i < startIdx + 3 && i < len; i++) {
      var cell = $('mrnaBase' + i);
      if (cell) cell.classList.add('codon-active');
    }
  }

  function clearMrnaHighlight() {
    document.querySelectorAll('.base-cell.codon-active').forEach(function(el) {
      el.classList.remove('codon-active');
    });
  }

  /* ================================================================
     POLYPEPTIDE CHAIN
     ================================================================ */
  function addAminoAcidBead(aa) {
    /* Add peptide bond dash between beads */
    if (polypeptideChain.children.length > 0 && aa !== 'Stop') {
      var dash = document.createElement('span');
      dash.className = 'peptide-bond';
      dash.textContent = '\u2014'; /* em dash as bond */
      polypeptideChain.appendChild(dash);
    }
    var bead = document.createElement('span');
    bead.className = 'amino-acid-bead' + (aa === 'Stop' ? ' stop-bead' : '');
    bead.textContent = aa;
    bead.title = AMINO_FULL[aa] || aa;
    bead.style.background = AMINO_COLORS[aa] || '#7c3aed';
    polypeptideChain.appendChild(bead);
  }

  /* ================================================================
     RIBOSOME & tRNA DISPLAY
     ================================================================ */
  function showRibosome(codon) {
    var bases = codon.split('');
    codonWindow.innerHTML = bases.map(function(b) {
      return '<div class="base-cell base-' + b + '" style="width:26px;height:26px;font-size:0.76rem;">' + b + '</div>';
    }).join('');

    var anticodon = bases.map(anticodonOf).join('');
    var aa = CODON_MAP[codon] || '?';
    var fullName = AMINO_FULL[aa] || aa;
    trnaDisplay.innerHTML = 'Codon: <strong>' + codon + '</strong>';

    /* Update tRNA graphic */
    trnaAnticodonRow.innerHTML = anticodon.split('').map(function(b) {
      return '<div class="base-cell base-' + b + '" style="width:22px;height:22px;font-size:0.7rem;">' + b + '</div>';
    }).join('');
    trnaArrow.textContent = 'Anticodon: ' + anticodon;
    trnaAminoLabel.style.display = 'inline-block';
    trnaAminoLabel.textContent = aa === 'Stop' ? 'Release Factor' : aa + ' (' + fullName + ')';
    trnaAminoLabel.style.background = AMINO_COLORS[aa] || '#7c3aed';
  }

  function clearRibosome() {
    codonWindow.innerHTML = '';
    trnaDisplay.textContent = 'Waiting for mRNA...';
    trnaAnticodonRow.innerHTML = '';
    trnaArrow.textContent = '';
    trnaAminoLabel.style.display = 'none';
  }

  /* ================================================================
     STEP LOGIC: the core state machine
     ================================================================ */
  function nextStep() {
    if (state.phase === 'complete') return;

    var seq = SEQUENCES[state.seqIndex];
    var template = seq.template;
    state.step++;
    updateStepCounter();
    updateProgress();

    switch (state.phase) {
      case 'idle':
        /* Begin: show helix then immediately start transcription */
        state.phase = 'transcription';
        state.transcriptionIndex = 0;
        showMrnaRow();
        updatePhaseIndicator();
        updateStatus('Transcription', '---', '---', 0);
        updateInfoForPhase('transcription');
        break;

      case 'transcription':
        if (state.transcriptionIndex < template.length) {
          var tBase = template[state.transcriptionIndex];
          var mBase = transcribeBase(tBase);
          state.mRNA.push(mBase);
          addMrnaBase(state.transcriptionIndex, mBase);
          state.transcriptionIndex++;

          /* Update helix canvas */
          drawHelix(template, state.transcriptionIndex / template.length);
          updateStatus(
            'Transcribing ' + state.transcriptionIndex + '/' + template.length,
            '---', tBase + ' \u2192 ' + mBase, 0
          );

          /* Check if transcription is complete */
          if (state.transcriptionIndex >= template.length) {
            state.phase = 'processing';
            updatePhaseIndicator();
            updateStatus('mRNA Processing', '---', '---', 0);
            updateInfoForPhase('processing');
            showCodonMarkers();
          }
        }
        break;

      case 'processing':
        /* Transition from processing to translation */
        state.phase = 'translation';
        state.translationCodonIndex = 0;
        translationPanel.style.display = 'block';
        polypeptidePanel.style.display = 'block';
        updatePhaseIndicator();
        updateStatus('Translation', '---', '---', 0);
        updateInfoForPhase('translation');
        break;

      case 'translation':
        translateNextCodon();
        break;
    }
  }

  function translateNextCodon() {
    var mRNA = state.mRNA;
    var idx = state.translationCodonIndex * 3;

    /* Not enough bases for a full codon */
    if (idx + 2 >= mRNA.length) {
      finishTranslation('Ran out of codons (incomplete final triplet).');
      return;
    }

    var codon = mRNA[idx] + mRNA[idx + 1] + mRNA[idx + 2];
    var aa = CODON_MAP[codon];

    highlightCodon(codon);
    highlightMrnaCodon(idx);
    showRibosome(codon);

    if (aa === 'Stop') {
      addAminoAcidBead('Stop');
      updateStatus('STOP codon reached', codon, 'Release factor', state.protein.length);
      finishTranslation('Stop codon (' + codon + ') reached. Polypeptide released.');
      return;
    }

    state.protein.push(aa);
    addAminoAcidBead(aa);
    updateStatus(
      'Codon ' + (state.translationCodonIndex + 1),
      codon,
      aa + ' (' + (AMINO_FULL[aa] || '') + ')',
      state.protein.length
    );

    state.translationCodonIndex++;

    /* Check ahead */
    var nextIdx = state.translationCodonIndex * 3;
    if (nextIdx + 2 >= mRNA.length) {
      finishTranslation('All complete codons translated.');
    }
  }

  function finishTranslation(reason) {
    state.phase = 'complete';
    updatePhaseIndicator();
    updateProgress();
    updateInfoForPhase('complete', reason);
    stopAutoPlay();
  }

  /* ================================================================
     INFO PANEL: contextual educational content
     ================================================================ */
  function showDefaultInfo() {
    infoContent.innerHTML =
      '<p><strong>The Central Dogma</strong> describes how genetic information flows inside cells:</p>' +
      '<div class="highlight-box">DNA &rarr; mRNA (transcription) &rarr; Protein (translation)</div>' +
      '<p><strong>Transcription</strong> occurs in the nucleus. The enzyme RNA polymerase reads the ' +
      'template (antisense) strand of DNA from 3\' to 5\' and builds a complementary mRNA strand from 5\' to 3\'.</p>' +
      '<h3>Base Pairing</h3>' +
      '<ul>' +
      '<li>Adenine (A) pairs with Thymine (T) in DNA, or Uracil (U) in RNA</li>' +
      '<li>Cytosine (C) pairs with Guanine (G)</li>' +
      '<li>G-C pairs form 3 hydrogen bonds (stronger)</li>' +
      '<li>A-T / A-U pairs form 2 hydrogen bonds</li>' +
      '</ul>' +
      '<h3>Translation</h3>' +
      '<p>Ribosomes read mRNA in groups of three bases called <strong>codons</strong>. ' +
      'Each codon specifies one amino acid. Transfer RNA (tRNA) molecules carry amino acids ' +
      'to the ribosome, matching their anticodon to the mRNA codon.</p>' +
      '<h3>Start &amp; Stop Codons</h3>' +
      '<div class="highlight-box">' +
      '<strong>Start:</strong> AUG (codes for Methionine; signals translation to begin)<br>' +
      '<strong>Stop:</strong> UAA, UAG, UGA (no amino acid; release factors terminate translation)' +
      '</div>' +
      '<h3>Mutations</h3>' +
      '<p>A change to even one DNA base can alter the mRNA codon. Point mutations fall into three categories:</p>' +
      '<ul>' +
      '<li><strong>Silent:</strong> no amino acid change (due to redundancy in the code)</li>' +
      '<li><strong>Missense:</strong> a different amino acid is incorporated</li>' +
      '<li><strong>Nonsense:</strong> a premature stop codon is created, truncating the protein</li>' +
      '</ul>' +
      '<div class="warn-box">There are also <strong>frameshift mutations</strong> (insertions or deletions) ' +
      'that shift the reading frame and typically alter every downstream codon.</div>';
  }

  function updateInfoForPhase(phase, extra) {
    switch (phase) {
      case 'transcription':
        infoContent.innerHTML =
          '<p><strong>Transcription in progress</strong></p>' +
          '<p>RNA polymerase has bound to the promoter region and is reading the template strand ' +
          'from 3\' to 5\'. A complementary mRNA strand is being synthesised from 5\' to 3\'.</p>' +
          '<div class="highlight-box">' +
          'Template A &rarr; mRNA <span style="color:var(--base-u);font-weight:700;">U</span><br>' +
          'Template T &rarr; mRNA <span style="color:var(--base-a);font-weight:700;">A</span><br>' +
          'Template C &rarr; mRNA <span style="color:var(--base-g);font-weight:700;">G</span><br>' +
          'Template G &rarr; mRNA <span style="color:var(--base-c);font-weight:700;">C</span>' +
          '</div>' +
          '<p>Watch the helix unwind in the canvas above. The mRNA uses <strong>uracil (U)</strong> ' +
          'in place of thymine (T).</p>' +
          '<p>The RNA polymerase enzyme is shown at the replication fork as a blue circle.</p>';
        break;

      case 'processing':
        infoContent.innerHTML =
          '<p><strong>mRNA Processing</strong></p>' +
          '<p>In eukaryotic cells, the newly synthesised pre-mRNA undergoes several modifications ' +
          'before leaving the nucleus:</p>' +
          '<div class="highlight-box">' +
          '1. <strong>5\' capping:</strong> a modified guanine nucleotide is added to the 5\' end, ' +
          'protecting the mRNA from degradation and aiding ribosome binding.<br><br>' +
          '2. <strong>3\' polyadenylation:</strong> a poly-A tail (up to 200 adenine nucleotides) ' +
          'is added to the 3\' end for stability and nuclear export.<br><br>' +
          '3. <strong>Splicing:</strong> introns (non-coding regions) are removed by the spliceosome. ' +
          'Exons (coding regions) are joined together to form the mature mRNA.' +
          '</div>' +
          '<p>The mature mRNA then exits through <strong>nuclear pores</strong> and travels to a ' +
          'ribosome in the cytoplasm (or rough ER) for translation.</p>' +
          '<p>Click <strong>Next Step</strong> (or press <kbd>Space</kbd>) to begin translation.</p>';
        break;

      case 'translation':
        infoContent.innerHTML =
          '<p><strong>Translation in progress</strong></p>' +
          '<p>The ribosome reads the mRNA three bases at a time. Each triplet is a <strong>codon</strong>.</p>' +
          '<p>A <strong>tRNA</strong> molecule with a complementary <strong>anticodon</strong> binds to the codon ' +
          'at the ribosome\'s A site, bringing the correct amino acid.</p>' +
          '<div class="highlight-box">' +
          'The first codon is always <strong style="color:var(--base-a);">AUG</strong> ' +
          '(Methionine), which serves as the <strong>start codon</strong> and signals the ribosome ' +
          'to begin building the polypeptide chain.' +
          '</div>' +
          '<p>A <strong>peptide bond</strong> forms between the amino acid at the P site and the new ' +
          'amino acid at the A site. The ribosome then translocates along the mRNA by one codon.</p>' +
          '<p>Translation continues until a <strong>stop codon</strong> (UAA, UAG, or UGA) enters the A site. ' +
          'No tRNA recognises stop codons; instead, <strong>release factors</strong> bind and trigger release ' +
          'of the polypeptide.</p>';
        break;

      case 'complete':
        var proteinStr = state.protein.join(' - ');
        infoContent.innerHTML =
          '<p><strong>Translation Complete</strong></p>' +
          '<p>' + (extra || '') + '</p>' +
          '<p>The polypeptide chain contains <strong>' + state.protein.length +
          ' amino acid' + (state.protein.length !== 1 ? 's' : '') + '</strong>.</p>' +
          '<div class="highlight-box"><strong>Protein sequence:</strong><br>' + proteinStr + '</div>' +
          '<h3>What happens next?</h3>' +
          '<p>The polypeptide chain must <strong>fold</strong> into its correct 3D shape to become ' +
          'a functional protein. Folding is driven by:</p>' +
          '<ul>' +
          '<li>Hydrogen bonds between R groups</li>' +
          '<li>Ionic bonds between charged side chains</li>' +
          '<li>Disulphide bridges between cysteine residues</li>' +
          '<li>Hydrophobic interactions in the protein core</li>' +
          '</ul>' +
          '<p>Chaperone proteins often assist with folding. Misfolded proteins are tagged for ' +
          'degradation by the proteasome.</p>' +
          '<div class="highlight-box">' +
          'This demonstrates the <strong>Central Dogma</strong>:<br>' +
          'DNA &rarr; mRNA &rarr; Protein</div>' +
          '<p>Try selecting a different sequence from the dropdown, or press <strong>Reset</strong> to start again.</p>';
        break;
    }
  }

  /* ================================================================
     AUTO-PLAY
     ================================================================ */
  function startAutoPlay() {
    state.autoPlay = true;
    btnAuto.textContent = 'Pause';
    btnAuto.classList.remove('btn-secondary');
    btnAuto.classList.add('btn-danger');
    state.autoTimer = setInterval(function() {
      if (state.phase === 'complete') {
        stopAutoPlay();
        return;
      }
      nextStep();
    }, getSpeed());
  }

  function stopAutoPlay() {
    state.autoPlay = false;
    btnAuto.textContent = 'Auto-play';
    btnAuto.classList.remove('btn-danger');
    btnAuto.classList.add('btn-secondary');
    if (state.autoTimer) {
      clearInterval(state.autoTimer);
      state.autoTimer = null;
    }
  }

  function toggleAutoPlay() {
    if (state.autoPlay) stopAutoPlay();
    else startAutoPlay();
  }

  /* ================================================================
     START THE APP
     ================================================================ */
  init();
})();
</script>
</body>
</html>
