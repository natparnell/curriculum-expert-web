<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Population Pyramid Comparator</title>
<style>
  :root {
    --male: #2a9d8f;
    --male-light: #2a9d8f55;
    --female: #e76f51;
    --female-light: #e76f5155;
    --bg: #f8f9fa;
    --card: #ffffff;
    --text: #264653;
    --text-light: #5f7a87;
    --border: #dde3e8;
    --accent: #264653;
    --stage1: #e76f51;
    --stage2: #f4a261;
    --stage3: #e9c46a;
    --stage4: #2a9d8f;
    --stage5: #264653;
    --overlay-male: rgba(42,157,143,0.45);
    --overlay-female: rgba(231,111,81,0.45);
    --overlay-male2: rgba(38,70,83,0.45);
    --overlay-female2: rgba(244,162,97,0.45);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  header {
    background: linear-gradient(135deg, #264653 0%, #2a9d8f 100%);
    color: white;
    padding: 18px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.12);
  }

  header h1 {
    font-size: 1.55rem;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  header .subtitle {
    font-size: 0.85rem;
    opacity: 0.85;
    font-weight: 400;
  }

  .header-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .btn {
    background: rgba(255,255,255,0.18);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .btn:hover { background: rgba(255,255,255,0.3); }
  .btn.active { background: rgba(255,255,255,0.35); border-color: white; }

  .legend {
    display: flex;
    gap: 18px;
    align-items: center;
    font-size: 0.82rem;
    color: white;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .legend-swatch {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    border: 1px solid rgba(255,255,255,0.4);
  }

  .main-container {
    display: flex;
    gap: 0;
    padding: 20px;
    max-width: 1600px;
    margin: 0 auto;
    flex-wrap: wrap;
  }

  .pyramid-panel {
    flex: 1;
    min-width: 380px;
    background: var(--card);
    border-radius: 14px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    transition: all 0.3s;
  }

  .pyramid-panel:first-child { margin-right: 10px; }
  .pyramid-panel:last-child { margin-left: 10px; }

  .pyramid-panel.overlay-mode {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .overlay-panel {
    display: none;
    flex: 1;
    min-width: 380px;
    background: var(--card);
    border-radius: 14px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    padding: 20px;
    flex-direction: column;
    gap: 14px;
    width: 100%;
  }
  .overlay-panel.active { display: flex; }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
  }

  .panel-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-light);
    font-weight: 700;
  }

  select {
    padding: 8px 14px;
    border-radius: 8px;
    border: 1.5px solid var(--border);
    font-size: 0.92rem;
    font-weight: 600;
    color: var(--text);
    background: white;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
    min-width: 160px;
  }
  select:focus { border-color: var(--male); }

  .dtm-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    letter-spacing: 0.5px;
  }

  .time-slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 0;
  }
  .time-slider-container label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-light);
    white-space: nowrap;
  }
  .time-slider-container .year-display {
    font-size: 1.05rem;
    font-weight: 800;
    color: var(--text);
    min-width: 44px;
    text-align: center;
  }
  input[type="range"] {
    flex: 1;
    accent-color: var(--male);
    height: 6px;
    cursor: pointer;
  }

  .pyramid-canvas-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1.05;
    min-height: 320px;
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
  }

  .annotation-box {
    position: absolute;
    background: var(--accent);
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.72rem;
    font-weight: 600;
    line-height: 1.3;
    max-width: 200px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s;
    box-shadow: 0 3px 10px rgba(0,0,0,0.18);
    z-index: 10;
  }
  .annotation-box.visible { opacity: 1; }
  .annotation-box::after {
    content: '';
    position: absolute;
    width: 8px; height: 8px;
    background: var(--accent);
    transform: rotate(45deg);
  }
  .annotation-box.arrow-left::after { left: -4px; top: 50%; margin-top: -4px; }
  .annotation-box.arrow-right::after { right: -4px; top: 50%; margin-top: -4px; }
  .annotation-box.arrow-bottom::after { bottom: -4px; left: 50%; margin-left: -4px; }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 8px;
  }

  .stat-card {
    background: var(--bg);
    border-radius: 10px;
    padding: 10px 12px;
    text-align: center;
  }
  .stat-card .stat-value {
    font-size: 1.15rem;
    font-weight: 800;
    color: var(--text);
  }
  .stat-card .stat-label {
    font-size: 0.68rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    margin-top: 2px;
    font-weight: 600;
  }

  .swap-btn-container {
    display: flex;
    align-items: center;
    justify-content: center;
    align-self: center;
    flex-shrink: 0;
  }
  .swap-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 12px rgba(0,0,0,0.15);
    transition: transform 0.3s, background 0.2s;
  }
  .swap-btn:hover { transform: scale(1.12); background: #2a9d8f; }

  @media (max-width: 900px) {
    .main-container { flex-direction: column; gap: 16px; }
    .pyramid-panel:first-child, .pyramid-panel:last-child { margin: 0; }
    .swap-btn-container { order: -1; }
    header { padding: 14px 18px; }
    header h1 { font-size: 1.25rem; }
  }

  .tooltip {
    position: fixed;
    background: rgba(38,70,83,0.95);
    color: white;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 0.78rem;
    pointer-events: none;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    line-height: 1.4;
    font-weight: 500;
    max-width: 220px;
  }

  .play-btn {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: var(--text);
    transition: all 0.2s;
  }
  .play-btn:hover { border-color: var(--male); color: var(--male); }
  .play-btn.playing { border-color: var(--female); color: var(--female); }
</style>
</head>
<body>

<div class="tooltip" id="tooltip"></div>

<header>
  <div>
    <h1>Population Pyramid Comparator</h1>
    <div class="subtitle">Explore demographic structures across countries and decades</div>
  </div>
  <div class="header-controls">
    <div class="legend">
      <div class="legend-item"><div class="legend-swatch" style="background:var(--male)"></div> Male</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--female)"></div> Female</div>
    </div>
    <button class="btn" id="overlayBtn" onclick="toggleOverlay()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.5" fill="none"/><rect x="7" y="5" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.5"/></svg>
      Overlay
    </button>
    <button class="btn" id="annotBtn" onclick="toggleAnnotations()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.5"/><text x="8" y="11.5" text-anchor="middle" fill="currentColor" font-size="10" font-weight="700">i</text></svg>
      Annotations
    </button>
  </div>
</header>

<div class="main-container" id="mainContainer">
  <!-- Left Panel -->
  <div class="pyramid-panel" id="panelLeft">
    <div class="panel-header">
      <span class="panel-label">Left</span>
      <select id="selLeft" onchange="onCountryChange('left')"></select>
      <span class="dtm-badge" id="dtmLeft">DTM Stage 4</span>
    </div>
    <div class="time-slider-container">
      <label>Year</label>
      <button class="play-btn" id="playLeft" onclick="togglePlay('left')" title="Animate through decades">&#9654;</button>
      <input type="range" id="sliderLeft" min="0" max="3" step="1" value="3" oninput="onSliderChange('left')">
      <span class="year-display" id="yearLeft">2020</span>
    </div>
    <div class="pyramid-canvas-wrapper" id="wrapperLeft">
      <canvas id="canvasLeft"></canvas>
    </div>
    <div class="stats-grid" id="statsLeft"></div>
  </div>

  <!-- Swap Button -->
  <div class="swap-btn-container">
    <button class="swap-btn" onclick="swapPanels()" title="Swap countries">&#8644;</button>
  </div>

  <!-- Right Panel -->
  <div class="pyramid-panel" id="panelRight">
    <div class="panel-header">
      <span class="panel-label">Right</span>
      <select id="selRight" onchange="onCountryChange('right')"></select>
      <span class="dtm-badge" id="dtmRight">DTM Stage 5</span>
    </div>
    <div class="time-slider-container">
      <label>Year</label>
      <button class="play-btn" id="playRight" onclick="togglePlay('right')" title="Animate through decades">&#9654;</button>
      <input type="range" id="sliderRight" min="0" max="3" step="1" value="3" oninput="onSliderChange('right')">
      <span class="year-display" id="yearRight">2020</span>
    </div>
    <div class="pyramid-canvas-wrapper" id="wrapperRight">
      <canvas id="canvasRight"></canvas>
    </div>
    <div class="stats-grid" id="statsRight"></div>
  </div>

  <!-- Overlay Panel (hidden by default) -->
  <div class="overlay-panel" id="overlayPanel">
    <div class="panel-header">
      <span class="panel-label">Overlay Comparison</span>
      <div class="legend" style="font-size:0.75rem; color:var(--text);">
        <div class="legend-item"><div class="legend-swatch" style="background:var(--male)"></div><div class="legend-swatch" style="background:var(--female); margin-left:-4px;"></div> <span id="overlayLabelA">Country A</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:var(--stage5)"></div><div class="legend-swatch" style="background:var(--stage2); margin-left:-4px;"></div> <span id="overlayLabelB">Country B</span></div>
      </div>
    </div>
    <div class="pyramid-canvas-wrapper" id="wrapperOverlay">
      <canvas id="canvasOverlay"></canvas>
    </div>
  </div>
</div>

<script>
// ─── AGE GROUPS ───
const AGE_GROUPS = ['0-4','5-9','10-14','15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74','75-79','80+'];
const DECADES = [1960, 1980, 2000, 2020];

// ─── COUNTRY DATA ───
// Each country has data per decade.  Values are percentages of total population per age-sex group.
// male[] and female[] arrays correspond to AGE_GROUPS (index 0 = 0-4).
// Data is approximate but realistic, sourced from UN population division patterns.

const COUNTRIES = {
  "Niger": {
    dtmByYear: {1960:1, 1980:1, 2000:2, 2020:2},
    data: {
      1960: {
        pop: 3.4, medianAge: 14.8, birthRate: 55, deathRate: 30,
        male:   [10.5, 8.2, 6.8, 5.6, 4.5, 3.6, 2.9, 2.3, 1.9, 1.5, 1.1, 0.8, 0.5, 0.3, 0.2, 0.1, 0.05],
        female: [10.2, 8.0, 6.7, 5.5, 4.6, 3.7, 3.0, 2.4, 1.9, 1.5, 1.2, 0.8, 0.6, 0.3, 0.2, 0.1, 0.05]
      },
      1980: {
        pop: 5.7, medianAge: 14.5, birthRate: 54, deathRate: 24,
        male:   [10.8, 8.5, 7.0, 5.7, 4.5, 3.5, 2.8, 2.3, 1.8, 1.4, 1.1, 0.7, 0.5, 0.3, 0.15, 0.08, 0.04],
        female: [10.5, 8.3, 6.9, 5.7, 4.6, 3.6, 2.9, 2.4, 1.9, 1.5, 1.1, 0.8, 0.5, 0.3, 0.2, 0.1, 0.05]
      },
      2000: {
        pop: 11.3, medianAge: 14.6, birthRate: 52, deathRate: 17,
        male:   [10.5, 8.8, 7.2, 5.8, 4.5, 3.5, 2.8, 2.2, 1.8, 1.4, 1.1, 0.7, 0.5, 0.3, 0.15, 0.08, 0.04],
        female: [10.2, 8.5, 7.0, 5.8, 4.6, 3.6, 2.9, 2.3, 1.9, 1.5, 1.1, 0.8, 0.5, 0.35, 0.2, 0.1, 0.05]
      },
      2020: {
        pop: 24.2, medianAge: 15.2, birthRate: 46, deathRate: 8,
        male:   [9.8, 8.5, 7.3, 6.0, 4.7, 3.6, 2.8, 2.2, 1.7, 1.3, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08, 0.04],
        female: [9.5, 8.2, 7.1, 5.9, 4.8, 3.7, 2.9, 2.3, 1.8, 1.4, 1.1, 0.7, 0.5, 0.35, 0.2, 0.1, 0.05]
      }
    }
  },
  "Uganda": {
    dtmByYear: {1960:1, 1980:2, 2000:2, 2020:2},
    data: {
      1960: {
        pop: 6.8, medianAge: 15.5, birthRate: 50, deathRate: 22,
        male:   [10.0, 8.2, 6.8, 5.5, 4.4, 3.5, 2.8, 2.3, 1.8, 1.4, 1.1, 0.8, 0.5, 0.3, 0.2, 0.1, 0.05],
        female: [9.8, 8.0, 6.7, 5.5, 4.5, 3.6, 2.9, 2.4, 1.9, 1.5, 1.1, 0.8, 0.6, 0.3, 0.2, 0.1, 0.05]
      },
      1980: {
        pop: 12.7, medianAge: 14.8, birthRate: 50, deathRate: 17,
        male:   [10.2, 8.5, 7.0, 5.6, 4.4, 3.4, 2.7, 2.2, 1.8, 1.4, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08, 0.04],
        female: [10.0, 8.3, 6.9, 5.6, 4.5, 3.5, 2.8, 2.3, 1.9, 1.4, 1.1, 0.8, 0.5, 0.3, 0.2, 0.1, 0.05]
      },
      2000: {
        pop: 24.0, medianAge: 14.9, birthRate: 47, deathRate: 15,
        male:   [10.3, 8.6, 7.0, 5.6, 4.3, 3.3, 2.6, 2.1, 1.7, 1.4, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08, 0.04],
        female: [10.0, 8.4, 6.9, 5.6, 4.4, 3.4, 2.7, 2.2, 1.8, 1.4, 1.1, 0.8, 0.5, 0.35, 0.2, 0.1, 0.05]
      },
      2020: {
        pop: 45.7, medianAge: 15.7, birthRate: 41, deathRate: 6,
        male:   [9.2, 8.2, 7.2, 6.0, 4.7, 3.6, 2.8, 2.1, 1.7, 1.3, 1.0, 0.7, 0.5, 0.3, 0.2, 0.1, 0.05],
        female: [9.0, 8.0, 7.0, 5.9, 4.8, 3.7, 2.9, 2.3, 1.8, 1.4, 1.1, 0.8, 0.5, 0.35, 0.2, 0.12, 0.06]
      }
    }
  },
  "Kenya": {
    dtmByYear: {1960:2, 1980:2, 2000:2, 2020:3},
    data: {
      1960: {
        pop: 8.1, medianAge: 16.0, birthRate: 50, deathRate: 20,
        male:   [9.8, 8.0, 6.6, 5.4, 4.4, 3.5, 2.8, 2.3, 1.9, 1.5, 1.1, 0.8, 0.6, 0.4, 0.2, 0.1, 0.05],
        female: [9.5, 7.8, 6.5, 5.4, 4.5, 3.6, 2.9, 2.4, 2.0, 1.5, 1.2, 0.9, 0.6, 0.4, 0.25, 0.12, 0.06]
      },
      1980: {
        pop: 16.3, medianAge: 15.0, birthRate: 50, deathRate: 13,
        male:   [10.0, 8.5, 7.0, 5.6, 4.3, 3.3, 2.6, 2.1, 1.7, 1.3, 1.0, 0.7, 0.5, 0.3, 0.15, 0.1, 0.05],
        female: [9.8, 8.3, 6.9, 5.6, 4.4, 3.5, 2.8, 2.2, 1.8, 1.4, 1.1, 0.8, 0.5, 0.3, 0.2, 0.1, 0.05]
      },
      2000: {
        pop: 31.0, medianAge: 16.8, birthRate: 40, deathRate: 12,
        male:   [8.5, 7.8, 7.0, 5.8, 4.6, 3.6, 2.8, 2.2, 1.8, 1.5, 1.1, 0.8, 0.5, 0.4, 0.2, 0.1, 0.05],
        female: [8.3, 7.6, 6.8, 5.8, 4.7, 3.7, 2.9, 2.3, 1.9, 1.5, 1.2, 0.9, 0.6, 0.4, 0.25, 0.12, 0.06]
      },
      2020: {
        pop: 53.8, medianAge: 20.0, birthRate: 28, deathRate: 5,
        male:   [7.2, 6.8, 6.5, 5.8, 5.2, 4.4, 3.5, 2.7, 2.1, 1.7, 1.3, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08],
        female: [7.0, 6.6, 6.3, 5.7, 5.2, 4.5, 3.6, 2.8, 2.2, 1.8, 1.4, 1.0, 0.7, 0.5, 0.3, 0.18, 0.1]
      }
    }
  },
  "India": {
    dtmByYear: {1960:2, 1980:2, 2000:3, 2020:3},
    data: {
      1960: {
        pop: 449, medianAge: 19.5, birthRate: 42, deathRate: 22,
        male:   [8.5, 7.2, 6.2, 5.3, 4.5, 3.8, 3.2, 2.7, 2.2, 1.8, 1.4, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08],
        female: [8.2, 7.0, 6.0, 5.2, 4.5, 3.8, 3.2, 2.7, 2.3, 1.8, 1.4, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08]
      },
      1980: {
        pop: 697, medianAge: 20.5, birthRate: 36, deathRate: 14,
        male:   [7.8, 7.0, 6.2, 5.4, 4.6, 3.8, 3.1, 2.6, 2.1, 1.7, 1.3, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08],
        female: [7.5, 6.8, 6.0, 5.3, 4.5, 3.8, 3.1, 2.6, 2.2, 1.7, 1.4, 1.0, 0.7, 0.5, 0.3, 0.18, 0.1]
      },
      2000: {
        pop: 1057, medianAge: 23.5, birthRate: 26, deathRate: 9,
        male:   [6.5, 6.2, 5.8, 5.4, 4.8, 4.2, 3.5, 2.9, 2.4, 1.9, 1.5, 1.1, 0.8, 0.5, 0.3, 0.18, 0.1],
        female: [6.2, 5.9, 5.6, 5.2, 4.7, 4.1, 3.5, 2.9, 2.4, 2.0, 1.5, 1.1, 0.8, 0.55, 0.35, 0.2, 0.12]
      },
      2020: {
        pop: 1380, medianAge: 28.4, birthRate: 18, deathRate: 7,
        male:   [4.8, 4.9, 5.0, 4.9, 4.7, 4.5, 4.1, 3.6, 3.1, 2.6, 2.1, 1.6, 1.2, 0.9, 0.6, 0.35, 0.2],
        female: [4.5, 4.6, 4.7, 4.7, 4.5, 4.3, 3.9, 3.5, 3.0, 2.5, 2.1, 1.6, 1.2, 0.9, 0.65, 0.4, 0.25]
      }
    }
  },
  "Brazil": {
    dtmByYear: {1960:2, 1980:3, 2000:3, 2020:4},
    data: {
      1960: {
        pop: 72, medianAge: 18.0, birthRate: 43, deathRate: 14,
        male:   [8.8, 7.5, 6.5, 5.5, 4.6, 3.8, 3.1, 2.5, 2.1, 1.7, 1.3, 0.9, 0.6, 0.4, 0.25, 0.12, 0.06],
        female: [8.5, 7.3, 6.3, 5.4, 4.6, 3.8, 3.2, 2.6, 2.2, 1.7, 1.3, 1.0, 0.7, 0.45, 0.28, 0.15, 0.08]
      },
      1980: {
        pop: 121, medianAge: 20.5, birthRate: 31, deathRate: 9,
        male:   [7.2, 6.8, 6.2, 5.5, 4.8, 4.1, 3.4, 2.8, 2.2, 1.8, 1.3, 1.0, 0.7, 0.5, 0.3, 0.15, 0.08],
        female: [7.0, 6.6, 6.0, 5.4, 4.8, 4.1, 3.4, 2.8, 2.3, 1.8, 1.4, 1.0, 0.7, 0.5, 0.3, 0.18, 0.1]
      },
      2000: {
        pop: 175, medianAge: 26.0, birthRate: 20, deathRate: 7,
        male:   [5.2, 5.3, 5.4, 5.3, 5.0, 4.5, 4.0, 3.4, 2.8, 2.3, 1.8, 1.3, 0.9, 0.6, 0.4, 0.22, 0.12],
        female: [5.0, 5.1, 5.2, 5.2, 5.0, 4.5, 4.0, 3.5, 2.9, 2.4, 1.9, 1.4, 1.0, 0.7, 0.45, 0.28, 0.16]
      },
      2020: {
        pop: 213, medianAge: 33.5, birthRate: 14, deathRate: 7,
        male:   [3.5, 3.6, 3.8, 4.0, 4.2, 4.2, 4.1, 3.9, 3.6, 3.2, 2.7, 2.2, 1.7, 1.2, 0.8, 0.5, 0.35],
        female: [3.3, 3.5, 3.6, 3.8, 4.1, 4.2, 4.1, 3.9, 3.7, 3.3, 2.8, 2.3, 1.8, 1.4, 0.9, 0.6, 0.45]
      }
    }
  },
  "Mexico": {
    dtmByYear: {1960:2, 1980:3, 2000:3, 2020:4},
    data: {
      1960: {
        pop: 38, medianAge: 17.0, birthRate: 45, deathRate: 12,
        male:   [9.2, 7.8, 6.5, 5.5, 4.5, 3.7, 3.0, 2.5, 2.0, 1.6, 1.2, 0.9, 0.6, 0.4, 0.2, 0.12, 0.06],
        female: [8.9, 7.5, 6.3, 5.4, 4.5, 3.8, 3.1, 2.6, 2.1, 1.7, 1.3, 0.9, 0.7, 0.45, 0.25, 0.14, 0.08]
      },
      1980: {
        pop: 69, medianAge: 17.8, birthRate: 35, deathRate: 7,
        male:   [8.0, 7.5, 6.8, 5.8, 4.8, 3.8, 3.1, 2.5, 2.0, 1.6, 1.2, 0.9, 0.6, 0.4, 0.25, 0.12, 0.06],
        female: [7.8, 7.3, 6.6, 5.7, 4.8, 3.9, 3.2, 2.6, 2.1, 1.7, 1.3, 1.0, 0.7, 0.45, 0.28, 0.15, 0.08]
      },
      2000: {
        pop: 103, medianAge: 23.5, birthRate: 23, deathRate: 5,
        male:   [5.8, 5.8, 5.7, 5.5, 5.0, 4.3, 3.6, 3.0, 2.4, 2.0, 1.5, 1.2, 0.8, 0.6, 0.35, 0.2, 0.1],
        female: [5.6, 5.6, 5.5, 5.4, 5.0, 4.4, 3.7, 3.1, 2.5, 2.1, 1.6, 1.2, 0.9, 0.65, 0.4, 0.25, 0.14]
      },
      2020: {
        pop: 129, medianAge: 29.3, birthRate: 17, deathRate: 6,
        male:   [4.2, 4.3, 4.5, 4.6, 4.5, 4.3, 4.0, 3.6, 3.2, 2.7, 2.2, 1.8, 1.3, 1.0, 0.65, 0.4, 0.28],
        female: [4.0, 4.1, 4.3, 4.5, 4.5, 4.3, 4.1, 3.7, 3.3, 2.8, 2.3, 1.9, 1.4, 1.1, 0.75, 0.5, 0.38]
      }
    }
  },
  "United Kingdom": {
    dtmByYear: {1960:4, 1980:4, 2000:4, 2020:4},
    data: {
      1960: {
        pop: 52, medianAge: 35.0, birthRate: 18, deathRate: 12,
        male:   [4.0, 3.6, 3.4, 3.5, 3.6, 3.5, 3.4, 3.5, 3.5, 3.3, 3.0, 2.6, 2.1, 1.6, 1.1, 0.6, 0.3],
        female: [3.8, 3.4, 3.2, 3.4, 3.5, 3.4, 3.3, 3.5, 3.5, 3.4, 3.1, 2.7, 2.3, 1.8, 1.3, 0.8, 0.5]
      },
      1980: {
        pop: 56, medianAge: 34.2, birthRate: 13, deathRate: 12,
        male:   [3.2, 3.3, 3.8, 4.1, 3.8, 3.4, 3.2, 3.0, 2.8, 3.0, 3.2, 3.2, 2.9, 2.3, 1.6, 1.0, 0.5],
        female: [3.0, 3.1, 3.6, 3.9, 3.7, 3.3, 3.1, 2.9, 2.8, 3.0, 3.2, 3.3, 3.1, 2.6, 2.0, 1.3, 0.8]
      },
      2000: {
        pop: 59, medianAge: 37.6, birthRate: 11, deathRate: 10,
        male:   [3.0, 3.2, 3.3, 3.2, 3.3, 3.5, 3.7, 3.8, 3.6, 3.4, 3.2, 2.8, 2.4, 2.0, 1.5, 1.0, 0.6],
        female: [2.9, 3.0, 3.1, 3.1, 3.2, 3.4, 3.6, 3.7, 3.6, 3.4, 3.2, 2.9, 2.6, 2.2, 1.7, 1.3, 0.9]
      },
      2020: {
        pop: 67, medianAge: 40.5, birthRate: 10, deathRate: 9,
        male:   [2.8, 3.0, 3.0, 2.9, 3.2, 3.5, 3.5, 3.4, 3.3, 3.4, 3.3, 3.0, 2.8, 2.4, 1.9, 1.3, 1.0],
        female: [2.7, 2.8, 2.8, 2.8, 3.1, 3.4, 3.4, 3.3, 3.3, 3.4, 3.3, 3.1, 2.9, 2.6, 2.1, 1.6, 1.4]
      }
    }
  },
  "France": {
    dtmByYear: {1960:4, 1980:4, 2000:4, 2020:4},
    data: {
      1960: {
        pop: 46, medianAge: 33.0, birthRate: 18, deathRate: 11,
        male:   [4.2, 3.8, 3.4, 3.5, 3.7, 3.3, 3.0, 2.9, 3.2, 3.3, 3.0, 2.5, 2.1, 1.6, 1.1, 0.7, 0.4],
        female: [4.0, 3.6, 3.2, 3.4, 3.6, 3.2, 2.9, 2.9, 3.2, 3.4, 3.1, 2.7, 2.3, 1.9, 1.4, 0.9, 0.6]
      },
      1980: {
        pop: 54, medianAge: 33.5, birthRate: 15, deathRate: 10,
        male:   [3.5, 3.4, 3.7, 3.8, 3.8, 3.7, 3.5, 3.2, 2.8, 2.6, 2.8, 3.0, 2.6, 2.0, 1.4, 0.9, 0.5],
        female: [3.3, 3.2, 3.5, 3.6, 3.7, 3.6, 3.4, 3.1, 2.8, 2.7, 2.9, 3.1, 2.8, 2.3, 1.7, 1.2, 0.8]
      },
      2000: {
        pop: 59, medianAge: 37.6, birthRate: 13, deathRate: 9,
        male:   [3.1, 3.1, 3.2, 3.3, 3.2, 3.3, 3.5, 3.5, 3.5, 3.3, 3.0, 2.7, 2.3, 2.0, 1.5, 1.0, 0.6],
        female: [2.9, 3.0, 3.0, 3.1, 3.1, 3.2, 3.4, 3.5, 3.5, 3.4, 3.1, 2.8, 2.5, 2.2, 1.8, 1.3, 0.9]
      },
      2020: {
        pop: 67, medianAge: 42.0, birthRate: 11, deathRate: 10,
        male:   [2.8, 3.0, 3.0, 2.9, 2.8, 3.0, 3.1, 3.2, 3.2, 3.2, 3.3, 3.2, 2.8, 2.4, 2.0, 1.5, 1.1],
        female: [2.7, 2.8, 2.8, 2.8, 2.7, 2.9, 3.0, 3.1, 3.2, 3.2, 3.4, 3.3, 2.9, 2.6, 2.3, 1.8, 1.6]
      }
    }
  },
  "Japan": {
    dtmByYear: {1960:4, 1980:4, 2000:5, 2020:5},
    data: {
      1960: {
        pop: 94, medianAge: 25.5, birthRate: 17, deathRate: 8,
        male:   [4.2, 4.8, 5.2, 4.4, 3.8, 3.6, 3.5, 3.4, 3.0, 2.5, 2.1, 1.7, 1.3, 1.0, 0.6, 0.3, 0.15],
        female: [4.0, 4.6, 5.0, 4.3, 3.7, 3.5, 3.5, 3.4, 3.1, 2.6, 2.2, 1.8, 1.4, 1.1, 0.7, 0.4, 0.25]
      },
      1980: {
        pop: 117, medianAge: 32.5, birthRate: 14, deathRate: 6,
        male:   [3.4, 3.5, 3.7, 3.8, 3.6, 3.5, 3.8, 4.1, 3.5, 3.2, 3.0, 2.5, 2.0, 1.5, 1.0, 0.5, 0.25],
        female: [3.2, 3.3, 3.5, 3.6, 3.5, 3.4, 3.7, 4.0, 3.5, 3.2, 3.0, 2.6, 2.1, 1.7, 1.2, 0.7, 0.4]
      },
      2000: {
        pop: 127, medianAge: 41.3, birthRate: 10, deathRate: 8,
        male:   [2.4, 2.5, 2.6, 2.8, 3.2, 3.4, 3.2, 3.0, 3.2, 3.6, 3.8, 3.4, 2.8, 2.3, 1.8, 1.2, 0.7],
        female: [2.3, 2.4, 2.5, 2.7, 3.1, 3.3, 3.1, 2.9, 3.1, 3.5, 3.8, 3.5, 3.0, 2.5, 2.1, 1.6, 1.1]
      },
      2020: {
        pop: 126, medianAge: 48.4, birthRate: 7, deathRate: 11,
        male:   [1.9, 2.0, 2.2, 2.3, 2.5, 2.7, 2.8, 3.0, 3.2, 3.2, 3.0, 3.1, 3.5, 3.6, 2.9, 2.1, 1.8],
        female: [1.8, 1.9, 2.1, 2.2, 2.4, 2.6, 2.7, 2.9, 3.1, 3.2, 3.0, 3.2, 3.6, 3.8, 3.2, 2.6, 2.6]
      }
    }
  },
  "Germany": {
    dtmByYear: {1960:4, 1980:4, 2000:5, 2020:5},
    data: {
      1960: {
        pop: 73, medianAge: 34.0, birthRate: 17, deathRate: 12,
        male:   [3.6, 3.4, 3.5, 3.8, 3.5, 3.2, 2.6, 2.0, 2.8, 3.5, 3.5, 3.2, 2.7, 2.1, 1.4, 0.8, 0.4],
        female: [3.4, 3.2, 3.3, 3.6, 3.4, 3.2, 2.6, 2.1, 3.0, 3.6, 3.6, 3.4, 3.0, 2.5, 1.8, 1.2, 0.7]
      },
      1980: {
        pop: 78, medianAge: 36.0, birthRate: 10, deathRate: 12,
        male:   [2.5, 2.8, 3.2, 3.6, 3.7, 3.4, 3.5, 3.3, 3.0, 2.5, 1.9, 2.4, 3.1, 2.9, 2.0, 1.2, 0.6],
        female: [2.4, 2.7, 3.0, 3.4, 3.6, 3.3, 3.4, 3.3, 3.0, 2.6, 2.1, 2.6, 3.3, 3.2, 2.5, 1.7, 1.0]
      },
      2000: {
        pop: 82, medianAge: 40.0, birthRate: 9, deathRate: 10,
        male:   [2.3, 2.5, 2.7, 2.8, 2.8, 3.1, 3.5, 3.6, 3.5, 3.3, 3.1, 2.8, 2.2, 1.7, 1.8, 1.5, 0.8],
        female: [2.2, 2.4, 2.5, 2.7, 2.7, 3.0, 3.4, 3.5, 3.5, 3.3, 3.2, 2.9, 2.4, 2.0, 2.2, 2.0, 1.3]
      },
      2020: {
        pop: 83, medianAge: 45.7, birthRate: 9, deathRate: 12,
        male:   [2.2, 2.2, 2.3, 2.4, 2.6, 2.8, 2.8, 2.6, 2.8, 3.2, 3.4, 3.2, 3.3, 3.0, 2.3, 1.5, 1.2],
        female: [2.1, 2.1, 2.2, 2.3, 2.4, 2.7, 2.7, 2.5, 2.7, 3.1, 3.4, 3.3, 3.4, 3.2, 2.6, 2.0, 1.8]
      }
    }
  }
};

// ─── STATE ───
let state = {
  left: { country: 'India', yearIdx: 3 },
  right: { country: 'Japan', yearIdx: 3 },
  overlayMode: false,
  showAnnotations: true,
  animating: { left: null, right: null }
};

// Interpolated data cache for smooth animation
let animState = { left: null, right: null };
let animTargets = { left: null, right: null };

// ─── INIT ───
function init() {
  const countries = Object.keys(COUNTRIES);
  ['selLeft','selRight'].forEach(id => {
    const sel = document.getElementById(id);
    countries.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c; opt.textContent = c;
      sel.appendChild(opt);
    });
  });
  document.getElementById('selLeft').value = state.left.country;
  document.getElementById('selRight').value = state.right.country;
  document.getElementById('sliderLeft').value = state.left.yearIdx;
  document.getElementById('sliderRight').value = state.right.yearIdx;

  // Set initial anim states
  animState.left = getDataForState('left');
  animState.right = getDataForState('right');
  animTargets.left = { ...animState.left };
  animTargets.right = { ...animState.right };

  updateAll();
  requestAnimationFrame(animLoop);
}

function getDataForState(side) {
  const s = state[side];
  const cData = COUNTRIES[s.country].data;
  const year = DECADES[s.yearIdx];
  const d = cData[year];
  return { male: [...d.male], female: [...d.female], pop: d.pop, medianAge: d.medianAge, birthRate: d.birthRate, deathRate: d.deathRate, country: s.country, year };
}

// ─── EVENT HANDLERS ───
function onCountryChange(side) {
  const sel = document.getElementById(side === 'left' ? 'selLeft' : 'selRight');
  state[side].country = sel.value;
  animTargets[side] = getDataForState(side);
  updateStats(side);
  updateDTM(side);
}

function onSliderChange(side) {
  const slider = document.getElementById(side === 'left' ? 'sliderLeft' : 'sliderRight');
  state[side].yearIdx = parseInt(slider.value);
  document.getElementById(side === 'left' ? 'yearLeft' : 'yearRight').textContent = DECADES[state[side].yearIdx];
  animTargets[side] = getDataForState(side);
  updateStats(side);
  updateDTM(side);
}

function swapPanels() {
  const tmp = { ...state.left };
  state.left = { ...state.right };
  state.right = tmp;

  document.getElementById('selLeft').value = state.left.country;
  document.getElementById('selRight').value = state.right.country;
  document.getElementById('sliderLeft').value = state.left.yearIdx;
  document.getElementById('sliderRight').value = state.right.yearIdx;
  document.getElementById('yearLeft').textContent = DECADES[state.left.yearIdx];
  document.getElementById('yearRight').textContent = DECADES[state.right.yearIdx];

  // Swap animated state instantly
  const tmpAnim = animState.left;
  animState.left = animState.right;
  animState.right = tmpAnim;

  animTargets.left = getDataForState('left');
  animTargets.right = getDataForState('right');

  updateStats('left');
  updateStats('right');
  updateDTM('left');
  updateDTM('right');
}

function toggleOverlay() {
  state.overlayMode = !state.overlayMode;
  document.getElementById('overlayBtn').classList.toggle('active', state.overlayMode);
  document.getElementById('panelLeft').style.display = state.overlayMode ? 'none' : '';
  document.getElementById('panelRight').style.display = state.overlayMode ? 'none' : '';
  document.getElementById('overlayPanel').classList.toggle('active', state.overlayMode);
  if (state.overlayMode) {
    document.getElementById('overlayLabelA').textContent = state.left.country + ' (' + DECADES[state.left.yearIdx] + ')';
    document.getElementById('overlayLabelB').textContent = state.right.country + ' (' + DECADES[state.right.yearIdx] + ')';
  }
}

function toggleAnnotations() {
  state.showAnnotations = !state.showAnnotations;
  document.getElementById('annotBtn').classList.toggle('active', state.showAnnotations);
}

function togglePlay(side) {
  const btn = document.getElementById(side === 'left' ? 'playLeft' : 'playRight');
  if (state.animating[side]) {
    clearInterval(state.animating[side]);
    state.animating[side] = null;
    btn.innerHTML = '&#9654;';
    btn.classList.remove('playing');
  } else {
    btn.innerHTML = '&#9646;&#9646;';
    btn.classList.add('playing');
    state.animating[side] = setInterval(() => {
      let idx = state[side].yearIdx + 1;
      if (idx > 3) idx = 0;
      state[side].yearIdx = idx;
      const slider = document.getElementById(side === 'left' ? 'sliderLeft' : 'sliderRight');
      slider.value = idx;
      document.getElementById(side === 'left' ? 'yearLeft' : 'yearRight').textContent = DECADES[idx];
      animTargets[side] = getDataForState(side);
      updateStats(side);
      updateDTM(side);
    }, 1800);
  }
}

// ─── UPDATES ───
function updateAll() {
  updateStats('left');
  updateStats('right');
  updateDTM('left');
  updateDTM('right');
  document.getElementById('yearLeft').textContent = DECADES[state.left.yearIdx];
  document.getElementById('yearRight').textContent = DECADES[state.right.yearIdx];
}

function getDTMStage(country, yearIdx) {
  const c = COUNTRIES[country];
  return c.dtmByYear[DECADES[yearIdx]];
}

function getDTMColor(stage) {
  return ['', 'var(--stage1)','var(--stage2)','var(--stage3)','var(--stage4)','var(--stage5)'][stage];
}

function getDTMLabel(stage) {
  const labels = ['', 'Stage 1 - Pre-industrial', 'Stage 2 - Early expanding', 'Stage 3 - Late expanding', 'Stage 4 - Low stationary', 'Stage 5 - Declining'];
  return labels[stage];
}

function updateDTM(side) {
  const stage = getDTMStage(state[side].country, state[side].yearIdx);
  const badge = document.getElementById(side === 'left' ? 'dtmLeft' : 'dtmRight');
  badge.style.background = getDTMColor(stage);
  badge.textContent = getDTMLabel(stage);
}

function updateStats(side) {
  const d = getDataForState(side);
  const totalMale = d.male.reduce((a,b)=>a+b,0);
  const totalFemale = d.female.reduce((a,b)=>a+b,0);
  const total = totalMale + totalFemale;

  // Dependency ratio: (0-14 + 65+) / (15-64)
  const young = (d.male[0]+d.male[1]+d.male[2]+d.female[0]+d.female[1]+d.female[2]);
  const old = (d.male[13]+d.male[14]+d.male[15]+d.male[16]+d.female[13]+d.female[14]+d.female[15]+d.female[16]);
  const working = total - young - old;
  const depRatio = working > 0 ? ((young + old) / working * 100).toFixed(0) : 0;

  const container = document.getElementById(side === 'left' ? 'statsLeft' : 'statsRight');
  container.innerHTML = `
    <div class="stat-card"><div class="stat-value">${formatPop(d.pop)}</div><div class="stat-label">Population</div></div>
    <div class="stat-card"><div class="stat-value">${d.medianAge}</div><div class="stat-label">Median Age</div></div>
    <div class="stat-card"><div class="stat-value">${depRatio}%</div><div class="stat-label">Dependency Ratio</div></div>
    <div class="stat-card"><div class="stat-value">${d.birthRate}&permil;</div><div class="stat-label">Birth Rate</div></div>
    <div class="stat-card"><div class="stat-value">${d.deathRate}&permil;</div><div class="stat-label">Death Rate</div></div>
  `;
}

function formatPop(m) {
  if (m >= 1000) return (m/1000).toFixed(2) + 'B';
  return m.toFixed(1) + 'M';
}

// ─── ANIMATION LOOP ───
const LERP_SPEED = 0.08;
function lerp(a, b, t) { return a + (b - a) * t; }

function animLoop() {
  // Lerp animated state toward targets
  ['left','right'].forEach(side => {
    const tgt = animTargets[side];
    const cur = animState[side];
    for (let i = 0; i < AGE_GROUPS.length; i++) {
      cur.male[i] = lerp(cur.male[i], tgt.male[i], LERP_SPEED);
      cur.female[i] = lerp(cur.female[i], tgt.female[i], LERP_SPEED);
    }
    cur.pop = lerp(cur.pop, tgt.pop, LERP_SPEED);
    cur.medianAge = lerp(cur.medianAge, tgt.medianAge, LERP_SPEED);
    cur.country = tgt.country;
    cur.year = tgt.year;
  });

  // Draw
  if (!state.overlayMode) {
    drawPyramid('canvasLeft', animState.left, 'left');
    drawPyramid('canvasRight', animState.right, 'right');
  } else {
    drawOverlay();
  }

  requestAnimationFrame(animLoop);
}

// ─── DRAWING ───
function setupCanvas(id) {
  const canvas = document.getElementById(id);
  const wrapper = canvas.parentElement;
  const rect = wrapper.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  return { ctx, w: rect.width, h: rect.height, canvas };
}

function drawPyramid(canvasId, data, side) {
  const { ctx, w, h } = setupCanvas(canvasId);
  ctx.clearRect(0, 0, w, h);

  const nGroups = AGE_GROUPS.length;
  const padTop = 28, padBottom = 26, padSide = 52;
  const chartH = h - padTop - padBottom;
  const chartW = w - padSide * 2;
  const barH = chartH / nGroups - 1;
  const maxVal = 12; // max percentage for scale
  const halfW = chartW / 2;
  const centerX = w / 2;

  // Background grid
  ctx.strokeStyle = '#e8edf0';
  ctx.lineWidth = 0.5;
  for (let pct = 2; pct <= maxVal; pct += 2) {
    const xOff = (pct / maxVal) * halfW;
    ctx.beginPath();
    ctx.moveTo(centerX - xOff, padTop);
    ctx.lineTo(centerX - xOff, h - padBottom);
    ctx.moveTo(centerX + xOff, padTop);
    ctx.lineTo(centerX + xOff, h - padBottom);
    ctx.stroke();
  }

  // Center axis
  ctx.strokeStyle = '#c0c8ce';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(centerX, padTop);
  ctx.lineTo(centerX, h - padBottom);
  ctx.stroke();

  // Bars
  const maleColor = getComputedStyle(document.documentElement).getPropertyValue('--male').trim();
  const femaleColor = getComputedStyle(document.documentElement).getPropertyValue('--female').trim();

  for (let i = 0; i < nGroups; i++) {
    const y = padTop + (nGroups - 1 - i) * (chartH / nGroups);
    const maleW = (data.male[i] / maxVal) * halfW;
    const femaleW = (data.female[i] / maxVal) * halfW;

    // Male (left)
    ctx.fillStyle = maleColor;
    ctx.globalAlpha = 0.85;
    const mr = roundedRect(ctx, centerX - maleW, y + 0.5, maleW, barH, 2);
    ctx.fill();

    // Female (right)
    ctx.fillStyle = femaleColor;
    roundedRect(ctx, centerX, y + 0.5, femaleW, barH, 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  // Age labels
  ctx.fillStyle = '#5f7a87';
  ctx.font = '600 10px "Segoe UI", system-ui, sans-serif';
  ctx.textAlign = 'right';
  for (let i = 0; i < nGroups; i++) {
    const y = padTop + (nGroups - 1 - i) * (chartH / nGroups) + barH / 2 + 3.5;
    ctx.fillText(AGE_GROUPS[i], padSide - 6, y);
  }

  // Scale labels
  ctx.textAlign = 'center';
  ctx.fillStyle = '#8a9aa5';
  ctx.font = '500 9px "Segoe UI", system-ui, sans-serif';
  for (let pct = 0; pct <= maxVal; pct += 4) {
    const xOff = (pct / maxVal) * halfW;
    ctx.fillText(pct + '%', centerX - xOff, h - padBottom + 14);
    if (pct > 0) ctx.fillText(pct + '%', centerX + xOff, h - padBottom + 14);
  }

  // Male / Female labels
  ctx.font = '700 11px "Segoe UI", system-ui, sans-serif';
  ctx.fillStyle = maleColor;
  ctx.textAlign = 'center';
  ctx.fillText('MALE', centerX - halfW / 2, padTop - 10);
  ctx.fillStyle = femaleColor;
  ctx.fillText('FEMALE', centerX + halfW / 2, padTop - 10);

  // Annotations
  if (state.showAnnotations && side) {
    drawAnnotations(ctx, data, centerX, halfW, padTop, chartH, nGroups, barH, maxVal, w, h);
  }
}

function roundedRect(ctx, x, y, width, height, r) {
  if (width < 0) { x += width; width = -width; }
  r = Math.min(r, width / 2, height / 2);
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + width - r, y);
  ctx.arcTo(x + width, y, x + width, y + r, r);
  ctx.lineTo(x + width, y + height - r);
  ctx.arcTo(x + width, y + height, x + width - r, y + height, r);
  ctx.lineTo(x + r, y + height);
  ctx.arcTo(x, y + height, x, y + height - r, r);
  ctx.lineTo(x, y + r);
  ctx.arcTo(x, y, x + r, y, r);
  ctx.closePath();
  return ctx;
}

function drawAnnotations(ctx, data, centerX, halfW, padTop, chartH, nGroups, barH, maxVal, w, h) {
  const stage = getDTMStage(data.country, getYearIdx(data.year));

  // Determine features
  const baseWidth = (data.male[0] + data.female[0]) / 2;
  const topWidth = (data.male[nGroups-1] + data.female[nGroups-1]) / 2;
  const midWidth = (data.male[Math.floor(nGroups/2)] + data.female[Math.floor(nGroups/2)]) / 2;

  // Find bulge
  let maxBulge = 0, bulgeIdx = -1;
  for (let i = 4; i <= 8; i++) {
    const v = data.male[i] + data.female[i];
    const prev = data.male[i-1] + data.female[i-1];
    const next = i < nGroups - 1 ? data.male[i+1] + data.female[i+1] : 0;
    if (v > prev && v > next && v > maxBulge) { maxBulge = v; bulgeIdx = i; }
  }

  ctx.font = '600 10px "Segoe UI", system-ui, sans-serif';
  const annotations = [];

  if (baseWidth > 7) {
    annotations.push({
      text: 'Wide base = High birth rate',
      row: 0, alignRight: true
    });
  }

  if (topWidth < 0.5 && stage <= 2) {
    annotations.push({
      text: 'Narrow top = Low life expectancy',
      row: nGroups - 2, alignRight: false
    });
  }

  if (topWidth > 1.5 && stage >= 4) {
    annotations.push({
      text: 'Wide top = High life expectancy',
      row: nGroups - 2, alignRight: true
    });
  }

  if (bulgeIdx >= 4 && maxBulge > midWidth * 1.1 && stage >= 3) {
    annotations.push({
      text: 'Bulge at ' + AGE_GROUPS[bulgeIdx] + ' = Larger cohort',
      row: bulgeIdx, alignRight: false
    });
  }

  if (baseWidth < 3.5 && stage >= 5) {
    annotations.push({
      text: 'Narrow base = Very low birth rate',
      row: 1, alignRight: true
    });
  }

  if (data.medianAge > 40) {
    annotations.push({
      text: 'Ageing population (median age ' + Math.round(data.medianAge) + ')',
      row: Math.floor(nGroups * 0.6), alignRight: false
    });
  } else if (data.medianAge < 20) {
    annotations.push({
      text: 'Very young population (median age ' + Math.round(data.medianAge) + ')',
      row: Math.floor(nGroups * 0.3), alignRight: true
    });
  }

  // Draw annotation callouts
  annotations.forEach((a, idx) => {
    const rowY = padTop + (nGroups - 1 - a.row) * (chartH / nGroups) + barH / 2;
    const val = a.alignRight ? data.female[a.row] : data.male[a.row];
    const barEnd = a.alignRight ? centerX + (val / maxVal) * halfW : centerX - (val / maxVal) * halfW;

    ctx.save();
    // Line
    ctx.strokeStyle = 'rgba(38,70,83,0.5)';
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 3]);
    const lineEndX = a.alignRight ? Math.min(barEnd + 60, w - 10) : Math.max(barEnd - 60, 10);
    ctx.beginPath();
    ctx.moveTo(barEnd + (a.alignRight ? 4 : -4), rowY);
    ctx.lineTo(lineEndX, rowY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Background pill
    ctx.font = '600 9.5px "Segoe UI", system-ui, sans-serif';
    const tm = ctx.measureText(a.text);
    const pillW = tm.width + 14;
    const pillH = 20;
    const pillX = a.alignRight ? lineEndX + 2 : lineEndX - pillW - 2;
    const pillY = rowY - pillH / 2;

    ctx.fillStyle = 'rgba(38,70,83,0.9)';
    roundedRect(ctx, Math.max(2, Math.min(pillX, w - pillW - 2)), pillY, pillW, pillH, 5);
    ctx.fill();

    ctx.fillStyle = '#ffffff';
    ctx.textAlign = a.alignRight ? 'left' : 'right';
    ctx.fillText(a.text, a.alignRight ? Math.max(2, pillX) + 7 : Math.min(w - 2, pillX + pillW) - 7, rowY + 3.5);
    ctx.restore();
  });
}

function getYearIdx(year) {
  return DECADES.indexOf(year);
}

function drawOverlay() {
  const { ctx, w, h } = setupCanvas('canvasOverlay');
  ctx.clearRect(0, 0, w, h);

  const dL = animState.left;
  const dR = animState.right;
  const nGroups = AGE_GROUPS.length;
  const padTop = 28, padBottom = 26, padSide = 52;
  const chartH = h - padTop - padBottom;
  const chartW = w - padSide * 2;
  const barH = chartH / nGroups - 1;
  const maxVal = 12;
  const halfW = chartW / 2;
  const centerX = w / 2;

  // Grid
  ctx.strokeStyle = '#e8edf0'; ctx.lineWidth = 0.5;
  for (let pct = 2; pct <= maxVal; pct += 2) {
    const xOff = (pct / maxVal) * halfW;
    ctx.beginPath();
    ctx.moveTo(centerX - xOff, padTop); ctx.lineTo(centerX - xOff, h - padBottom);
    ctx.moveTo(centerX + xOff, padTop); ctx.lineTo(centerX + xOff, h - padBottom);
    ctx.stroke();
  }
  ctx.strokeStyle = '#c0c8ce'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(centerX, padTop); ctx.lineTo(centerX, h - padBottom); ctx.stroke();

  // Draw both datasets
  const sets = [
    { data: dL, maleColor: 'rgba(42,157,143,0.45)', femaleColor: 'rgba(231,111,81,0.45)', borderM: '#2a9d8f', borderF: '#e76f51' },
    { data: dR, maleColor: 'rgba(38,70,83,0.45)', femaleColor: 'rgba(244,162,97,0.45)', borderM: '#264653', borderF: '#f4a261' }
  ];

  sets.forEach(set => {
    for (let i = 0; i < nGroups; i++) {
      const y = padTop + (nGroups - 1 - i) * (chartH / nGroups);
      const mW = (set.data.male[i] / maxVal) * halfW;
      const fW = (set.data.female[i] / maxVal) * halfW;

      ctx.fillStyle = set.maleColor;
      ctx.strokeStyle = set.borderM;
      ctx.lineWidth = 1.5;
      roundedRect(ctx, centerX - mW, y + 0.5, mW, barH, 2);
      ctx.fill(); ctx.stroke();

      ctx.fillStyle = set.femaleColor;
      ctx.strokeStyle = set.borderF;
      roundedRect(ctx, centerX, y + 0.5, fW, barH, 2);
      ctx.fill(); ctx.stroke();
    }
  });

  // Labels
  ctx.fillStyle = '#5f7a87';
  ctx.font = '600 10px "Segoe UI", system-ui, sans-serif';
  ctx.textAlign = 'right';
  for (let i = 0; i < nGroups; i++) {
    const y = padTop + (nGroups - 1 - i) * (chartH / nGroups) + barH / 2 + 3.5;
    ctx.fillText(AGE_GROUPS[i], padSide - 6, y);
  }

  ctx.textAlign = 'center';
  ctx.fillStyle = '#8a9aa5';
  ctx.font = '500 9px "Segoe UI", system-ui, sans-serif';
  for (let pct = 0; pct <= maxVal; pct += 4) {
    const xOff = (pct / maxVal) * halfW;
    ctx.fillText(pct + '%', centerX - xOff, h - padBottom + 14);
    if (pct > 0) ctx.fillText(pct + '%', centerX + xOff, h - padBottom + 14);
  }

  ctx.font = '700 11px "Segoe UI", system-ui, sans-serif';
  ctx.fillStyle = '#2a9d8f'; ctx.textAlign = 'center';
  ctx.fillText('MALE', centerX - halfW / 2, padTop - 10);
  ctx.fillStyle = '#e76f51';
  ctx.fillText('FEMALE', centerX + halfW / 2, padTop - 10);

  // Update overlay labels
  document.getElementById('overlayLabelA').textContent = state.left.country + ' (' + DECADES[state.left.yearIdx] + ')';
  document.getElementById('overlayLabelB').textContent = state.right.country + ' (' + DECADES[state.right.yearIdx] + ')';
}

// ─── TOOLTIP ───
function setupTooltips() {
  const tooltip = document.getElementById('tooltip');
  ['canvasLeft','canvasRight','canvasOverlay'].forEach(id => {
    const canvas = document.getElementById(id);
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;

      const padTop = 28, padBottom = 26, padSide = 52;
      const chartH = rect.height - padTop - padBottom;
      const nGroups = AGE_GROUPS.length;
      const centerX = rect.width / 2;

      // Determine which bar
      const rowIdx = Math.floor((my - padTop) / (chartH / nGroups));
      const ageIdx = nGroups - 1 - rowIdx;

      if (ageIdx < 0 || ageIdx >= nGroups || my < padTop || my > rect.height - padBottom) {
        tooltip.style.display = 'none';
        return;
      }

      const isMale = mx < centerX;
      let data;
      if (id === 'canvasLeft') data = animState.left;
      else if (id === 'canvasRight') data = animState.right;
      else {
        // In overlay, show both
        const dL = animState.left;
        const dR = animState.right;
        const sex = isMale ? 'Male' : 'Female';
        const vL = isMale ? dL.male[ageIdx] : dL.female[ageIdx];
        const vR = isMale ? dR.male[ageIdx] : dR.female[ageIdx];
        tooltip.innerHTML = `<strong>${AGE_GROUPS[ageIdx]} ${sex}</strong><br>${state.left.country}: ${vL.toFixed(1)}%<br>${state.right.country}: ${vR.toFixed(1)}%`;
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX + 14) + 'px';
        tooltip.style.top = (e.clientY - 10) + 'px';
        return;
      }

      const sex = isMale ? 'Male' : 'Female';
      const val = isMale ? data.male[ageIdx] : data.female[ageIdx];
      tooltip.innerHTML = `<strong>${AGE_GROUPS[ageIdx]}</strong><br>${sex}: ${val.toFixed(1)}% of pop.`;
      tooltip.style.display = 'block';
      tooltip.style.left = (e.clientX + 14) + 'px';
      tooltip.style.top = (e.clientY - 10) + 'px';
    });

    canvas.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });
  });
}

// ─── RESIZE ───
window.addEventListener('resize', () => {
  // Canvases are redrawn each frame so just the animation loop handles it
});

// ─── BOOT ───
init();
setupTooltips();
</script>
</body>
</html>
