<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transition Matrix</title>
<style>
:root {
  --bg: #f8f9fa;
  --surface: #ffffff;
  --border: #dee2e6;
  --text: #212529;
  --text-muted: #6c757d;
  --improve: #28a745;
  --improve-light: #d4edda;
  --improve-bg: rgba(40, 167, 69, 0.15);
  --improve-ribbon: rgba(40, 167, 69, 0.35);
  --maintain: #6c757d;
  --maintain-light: #e9ecef;
  --maintain-bg: rgba(108, 117, 125, 0.15);
  --maintain-ribbon: rgba(108, 117, 125, 0.30);
  --decline: #dc3545;
  --decline-light: #f8d7da;
  --decline-bg: rgba(220, 53, 69, 0.15);
  --decline-ribbon: rgba(220, 53, 69, 0.35);
  --accent: #0d6efd;
  --accent-light: #cfe2ff;
  --header-bg: #1a2332;
  --header-text: #ffffff;
  --radius: 6px;
  --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }

header { position: sticky; top: 0; z-index: 100; background: var(--header-bg); color: var(--header-text); padding: 14px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
header h1 { font-size: 1.35rem; font-weight: 700; letter-spacing: -0.02em; }
header p { font-size: 0.82rem; opacity: 0.8; margin-top: 2px; }

.toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; padding: 12px 24px; background: var(--surface); border-bottom: 1px solid var(--border); }
.toolbar label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
.toolbar select, .toolbar button { font-size: 0.82rem; padding: 6px 12px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); cursor: pointer; }
.toolbar select:focus { outline: 2px solid var(--accent); outline-offset: -1px; }
.toolbar button { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; transition: opacity 0.15s; }
.toolbar button:hover { opacity: 0.88; }
.toolbar button.secondary { background: var(--surface); color: var(--text); border-color: var(--border); }
.toolbar button.secondary:hover { background: var(--bg); }

.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; padding: 12px 24px; max-width: 1400px; margin: 0 auto; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 16px; box-shadow: var(--shadow); }
.stat-card .stat-label { font-size: 0.72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.stat-card .stat-value { font-size: 1.4rem; font-weight: 800; margin-top: 2px; }
.stat-card .stat-sub { font-size: 0.72rem; color: var(--text-muted); }
.stat-card .stat-value.green { color: var(--improve); }
.stat-card .stat-value.grey { color: var(--maintain); }
.stat-card .stat-value.red { color: var(--decline); }
.stat-card .stat-value.blue { color: var(--accent); }

.detail-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin: 0 auto 12px; padding: 16px; box-shadow: var(--shadow); display: none; max-width: 1352px; }
.detail-panel.visible { display: block; animation: fadeSlideIn 0.2s ease; }
@keyframes fadeSlideIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
.detail-panel h3 { font-size: 0.9rem; margin-bottom: 8px; }
.detail-panel .close-btn { float: right; cursor: pointer; background: none; border: none; font-size: 1.2rem; color: var(--text-muted); line-height: 1; }
.detail-panel .close-btn:hover { color: var(--decline); }
.student-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.student-chip { font-size: 0.78rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
.student-chip.improve-chip { background: var(--improve-light); color: var(--improve); }
.student-chip.maintain-chip { background: var(--maintain-light); color: var(--maintain); }
.student-chip.decline-chip { background: var(--decline-light); color: var(--decline); }

.main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 12px 24px 20px; max-width: 1400px; margin: 0 auto; }
.panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
.panel-title { font-size: 0.9rem; font-weight: 700; padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border); }

.matrix-wrap { overflow-x: auto; padding: 12px; }
table.matrix { border-collapse: collapse; width: 100%; font-size: 0.8rem; }
table.matrix th, table.matrix td { border: 1px solid var(--border); text-align: center; padding: 6px 4px; min-width: 38px; }
table.matrix th { background: var(--bg); font-weight: 700; font-size: 0.75rem; }
table.matrix th.row-header, table.matrix th.col-header { background: var(--header-bg); color: var(--header-text); }
table.matrix th.corner { background: var(--header-bg); color: var(--header-text); font-size: 0.65rem; }
table.matrix td { cursor: pointer; font-weight: 600; transition: transform 0.1s, box-shadow 0.1s; position: relative; }
table.matrix td:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 0 0 2px var(--accent); }
table.matrix td.improve { background: var(--improve-bg); color: var(--improve); }
table.matrix td.maintain { background: var(--maintain-bg); color: var(--maintain); }
table.matrix td.decline { background: var(--decline-bg); color: var(--decline); }
table.matrix td.empty { color: #ddd; cursor: default; }
table.matrix td.empty:hover { transform: none; box-shadow: none; }
table.matrix td.total-cell { font-weight: 700; background: var(--bg); cursor: default; }
table.matrix td.total-cell:hover { transform: none; box-shadow: none; }
table.matrix td.grand-total { font-weight: 800; background: var(--header-bg); color: var(--header-text); cursor: default; }
table.matrix td.grand-total:hover { transform: none; box-shadow: none; }

.canvas-wrap { padding: 12px; display: flex; justify-content: center; }
canvas#sankey { width: 100%; max-height: 500px; }
.legend { display: flex; gap: 16px; padding: 8px 16px; font-size: 0.75rem; align-items: center; border-top: 1px solid var(--border); }
.legend-item { display: flex; align-items: center; gap: 4px; }
.legend-swatch { width: 14px; height: 14px; border-radius: 3px; }

.tooltip { position: fixed; background: var(--header-bg); color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 0.78rem; pointer-events: none; z-index: 300; display: none; white-space: nowrap; box-shadow: var(--shadow-md); }

.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center; }
.modal-overlay.visible { display: flex; }
.modal { background: var(--surface); border-radius: var(--radius); padding: 24px; width: 90%; max-width: 500px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); animation: fadeSlideIn 0.2s ease; }
.modal h2 { font-size: 1.1rem; margin-bottom: 16px; }
.modal .form-group { margin-bottom: 12px; }
.modal label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; }
.modal input, .modal select, .modal textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.85rem; font-family: inherit; }
.modal textarea { height: 120px; resize: vertical; }
.modal .btn-row { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
.modal button { padding: 8px 18px; border-radius: var(--radius); border: 1px solid var(--border); font-size: 0.85rem; cursor: pointer; font-weight: 600; transition: opacity 0.15s; }
.modal button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.modal button.primary:hover { opacity: 0.88; }
.modal button.cancel { background: var(--surface); color: var(--text); }
.modal button.cancel:hover { background: var(--bg); }
.modal .hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

.student-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.8rem; }
.student-table th, .student-table td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; }
.student-table th { background: var(--bg); font-weight: 700; position: sticky; top: 0; }
.student-table td select { border: 1px solid var(--border); border-radius: 4px; padding: 2px 4px; font-size: 0.8rem; }
.student-table tr:hover { background: var(--accent-light); }
.student-table .del-btn { cursor: pointer; color: var(--decline); background: none; border: none; font-weight: 700; font-size: 0.9rem; }
.student-table .del-btn:hover { color: #a71d2a; }

.info-panel { max-width: 1352px; margin: 0 auto 20px; padding: 0 24px; }
.info-panel details { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
.info-panel summary { padding: 12px 16px; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
.info-panel summary:hover { color: var(--accent); }
.info-panel .info-content { padding: 0 16px 16px; font-size: 0.82rem; line-height: 1.7; color: var(--text-muted); }
.info-panel .info-content h4 { color: var(--text); margin: 14px 0 4px; font-size: 0.85rem; }
.info-panel .info-content ul { margin-left: 18px; margin-bottom: 4px; }
.info-panel .info-content li { margin-bottom: 3px; }

@media (max-width: 900px) {
  .main { grid-template-columns: 1fr; }
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .toolbar { padding: 10px 16px; }
  header { padding: 12px 16px; }
  .info-panel, .detail-panel { margin-left: 16px; margin-right: 16px; }
}
@media (max-width: 500px) {
  .stats-row { grid-template-columns: 1fr; }
  .toolbar { gap: 6px; }
  .toolbar button, .toolbar select { font-size: 0.75rem; padding: 5px 8px; }
}
</style>
</head>
<body>

<header>
  <h1>Transition Matrix</h1>
  <p>Visualise student grade movement between two assessment points</p>
</header>

<div class="toolbar">
  <label>Filter:</label>
  <select id="filterSelect">
    <option value="all">All students</option>
    <option value="improved">Improvers only</option>
    <option value="maintained">Maintained only</option>
    <option value="declined">Decliners only</option>
  </select>
  <label style="margin-left:8px;">Grade band:</label>
  <select id="gradeBand">
    <option value="all">All grades (1-9)</option>
    <option value="high">High (7-9)</option>
    <option value="mid">Mid (4-6)</option>
    <option value="low">Low (1-3)</option>
  </select>
  <button id="addStudentBtn">+ Add Student</button>
  <button class="secondary" id="bulkAddBtn">Bulk Add</button>
  <button class="secondary" id="manageBtn">Manage Students</button>
  <button class="secondary" id="exportBtn">Export Matrix</button>
  <button class="secondary" id="resetBtn">Reset Demo</button>
</div>

<div class="stats-row" id="statsRow"></div>

<div class="detail-panel" id="detailPanel">
  <button class="close-btn" id="closeDetail">&times;</button>
  <h3 id="detailTitle"></h3>
  <div class="student-list" id="detailList"></div>
</div>

<div class="main">
  <div class="panel">
    <div class="panel-title">Transition Matrix (AP1 rows, AP2 columns)</div>
    <div class="matrix-wrap" id="matrixWrap"></div>
    <div class="legend">
      <div class="legend-item"><div class="legend-swatch" style="background:var(--improve-bg);border:1px solid var(--improve);"></div> Improved</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--maintain-bg);border:1px solid var(--maintain);"></div> Maintained</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--decline-bg);border:1px solid var(--decline);"></div> Declined</div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-title">Sankey / Alluvial Diagram</div>
    <div class="canvas-wrap">
      <canvas id="sankey" width="560" height="480"></canvas>
    </div>
  </div>
</div>

<div class="info-panel">
  <details>
    <summary>About Transition Matrices: What They Show and How to Use Them</summary>
    <div class="info-content">
      <h4>What does a transition matrix show?</h4>
      <p>A transition matrix displays how students move between grade boundaries across two assessment
        points. Each cell shows the count of students who achieved a particular grade at Assessment
        Point 1 (the row) and then achieved another grade at Assessment Point 2 (the column). The
        diagonal represents students who maintained their grade. Cells above the diagonal (where the
        AP2 column grade is higher than the AP1 row grade) show improvement. Cells below the diagonal
        show decline.</p>

      <h4>Reading the Sankey diagram</h4>
      <p>The Sankey (alluvial) diagram on the right provides a visual flow representation of the same
        data. Each grade at AP1 appears as a block on the left; each grade at AP2 appears on the
        right. The ribbons connecting them are sized according to how many students transitioned
        between those grades. Green ribbons indicate improvement, grey ribbons indicate no change,
        and red ribbons indicate decline. Hover over any ribbon to see the exact count.</p>

      <h4>Using transition matrices for intervention planning</h4>
      <ul>
        <li>Identify groups of students who have declined between assessments and investigate common
          factors (attendance, behaviour, prior attainment, teacher allocation).</li>
        <li>Spot "stuck" groups: large numbers on the diagonal at lower grades may indicate students
          who need targeted support to break through to the next grade boundary.</li>
        <li>Celebrate and analyse improvers: what strategies, interventions, or support structures did
          those students receive? Can these be replicated?</li>
        <li>Compare transition patterns across different subjects, classes, teaching groups, or
          demographic groups (e.g. pupil premium, SEN, gender) to identify inequalities.</li>
        <li>Use the data to set realistic but ambitious targets for the next assessment cycle.</li>
        <li>Look for unexpected transitions (large jumps of 2+ grades) which may indicate assessment
          reliability issues or exceptional circumstances.</li>
        <li>Combine with other data sources (e.g. attendance, behaviour logs) for richer analysis.</li>
      </ul>

      <h4>Limitations to keep in mind</h4>
      <ul>
        <li>Cohort changes: if students join or leave between assessments, the matrix does not
          capture the full picture. New arrivals will only appear at AP2 without a baseline.</li>
        <li>Different assessments: AP1 and AP2 may test different content or have different grade
          boundaries, making direct comparison imperfect. A grade 5 at AP1 may not represent the
          same standard as a grade 5 at AP2.</li>
        <li>Grade boundaries compress information: a student moving from a low 5 to a high 5 shows
          as "maintained" even though meaningful progress occurred within the grade.</li>
        <li>Small cohorts can produce misleading patterns: with fewer than 15-20 students, individual
          cases can dominate cells and percentages.</li>
        <li>The matrix does not capture the reasons behind movement. A decline might reflect genuine
          difficulty, or it might reflect absence on the assessment day.</li>
        <li>Transition matrices show net movement only; they do not distinguish between a student who
          was consistently at grade 6 and one who fluctuated between 5 and 7.</li>
      </ul>
    </div>
  </details>
</div>

<!-- Add Student Modal -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h2>Add Student</h2>
    <div class="form-group">
      <label for="studentName">Student name</label>
      <input type="text" id="studentName" placeholder="e.g. Alex Turner">
    </div>
    <div class="form-group">
      <label for="ap1Grade">AP1 Grade (1-9)</label>
      <select id="ap1Grade"></select>
    </div>
    <div class="form-group">
      <label for="ap2Grade">AP2 Grade (1-9)</label>
      <select id="ap2Grade"></select>
    </div>
    <div class="btn-row">
      <button class="cancel" id="cancelAdd">Cancel</button>
      <button class="primary" id="confirmAdd">Add Student</button>
    </div>
  </div>
</div>

<!-- Bulk Add Modal -->
<div class="modal-overlay" id="bulkModal">
  <div class="modal" style="max-width:560px;">
    <h2>Bulk Add Students</h2>
    <div class="form-group">
      <label for="bulkInput">Paste student data (one per line)</label>
      <textarea id="bulkInput" placeholder="Name, AP1, AP2&#10;e.g.&#10;Alex Turner, 5, 7&#10;Jordan Lee, 6, 6&#10;Sam Blake, 4, 3"></textarea>
      <div class="hint">Format: Name, AP1 grade, AP2 grade (comma-separated, one student per line)</div>
    </div>
    <div class="btn-row">
      <button class="cancel" id="cancelBulk">Cancel</button>
      <button class="primary" id="confirmBulk">Add All</button>
    </div>
  </div>
</div>

<!-- Manage Students Modal -->
<div class="modal-overlay" id="manageModal">
  <div class="modal" style="max-width:700px;max-height:80vh;overflow-y:auto;">
    <h2>Manage Students</h2>
    <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">
      Change any grade using the dropdown selectors. All changes update the matrix and diagram
      instantly. Use the delete button to remove individual students.
    </p>
    <div id="manageTableWrap"></div>
    <div class="btn-row">
      <button class="cancel" id="closeManage">Close</button>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
(function() {
  'use strict';

  // --- CONSTANTS ---
  var GRADES = [9, 8, 7, 6, 5, 4, 3, 2, 1];
  var GRADE_MIN = 1;
  var GRADE_MAX = 9;

  // --- DEFAULT DATA: 30 demo students across grades 3-9 ---
  function defaultStudents() {
    return [
      { name: 'Amara Okafor',    ap1: 7, ap2: 8 },
      { name: 'Ben Carter',      ap1: 5, ap2: 5 },
      { name: 'Chloe Marsh',     ap1: 6, ap2: 7 },
      { name: 'Daniel Kim',      ap1: 4, ap2: 3 },
      { name: 'Emily Shaw',      ap1: 8, ap2: 9 },
      { name: 'Finn O\'Brien',   ap1: 3, ap2: 4 },
      { name: 'Grace Patel',     ap1: 5, ap2: 6 },
      { name: 'Harry Chen',      ap1: 7, ap2: 7 },
      { name: 'Isla Thompson',   ap1: 6, ap2: 5 },
      { name: 'Jack Williams',   ap1: 4, ap2: 5 },
      { name: 'Katie Brooks',    ap1: 9, ap2: 9 },
      { name: 'Liam Foster',     ap1: 3, ap2: 3 },
      { name: 'Megan Jones',     ap1: 5, ap2: 4 },
      { name: 'Nathan Cole',     ap1: 6, ap2: 7 },
      { name: 'Olivia Grant',    ap1: 8, ap2: 8 },
      { name: 'Priya Sharma',    ap1: 4, ap2: 6 },
      { name: 'Quinn Murphy',    ap1: 7, ap2: 6 },
      { name: 'Ruby Evans',      ap1: 5, ap2: 7 },
      { name: 'Sam Hughes',      ap1: 3, ap2: 5 },
      { name: 'Tara Singh',      ap1: 6, ap2: 6 },
      { name: 'Umar Ali',        ap1: 9, ap2: 8 },
      { name: 'Violet Reed',     ap1: 4, ap2: 4 },
      { name: 'Will Scott',      ap1: 7, ap2: 9 },
      { name: 'Xena Duval',      ap1: 5, ap2: 5 },
      { name: 'Yusuf Hasan',     ap1: 8, ap2: 7 },
      { name: 'Zoe Clarke',      ap1: 6, ap2: 8 },
      { name: 'Aiden Brown',     ap1: 3, ap2: 4 },
      { name: 'Bella Cross',     ap1: 4, ap2: 5 },
      { name: 'Callum Wood',     ap1: 5, ap2: 3 },
      { name: 'Daisy Hart',      ap1: 7, ap2: 7 }
    ];
  }

  var students = defaultStudents();

  // --- UTILITY: classify a transition ---
  function classify(ap1, ap2) {
    if (ap2 > ap1) return 'improved';
    if (ap2 === ap1) return 'maintained';
    return 'declined';
  }

  // --- FILTER LOGIC ---
  function getFilteredStudents() {
    var filter = document.getElementById('filterSelect').value;
    var band = document.getElementById('gradeBand').value;
    var list = students.slice();

    // Direction filter
    if (filter === 'improved') {
      list = list.filter(function(s) { return s.ap2 > s.ap1; });
    } else if (filter === 'maintained') {
      list = list.filter(function(s) { return s.ap2 === s.ap1; });
    } else if (filter === 'declined') {
      list = list.filter(function(s) { return s.ap2 < s.ap1; });
    }

    // Grade band filter
    if (band === 'high') {
      list = list.filter(function(s) { return s.ap1 >= 7 || s.ap2 >= 7; });
    } else if (band === 'mid') {
      list = list.filter(function(s) {
        return (s.ap1 >= 4 && s.ap1 <= 6) || (s.ap2 >= 4 && s.ap2 <= 6);
      });
    } else if (band === 'low') {
      list = list.filter(function(s) { return s.ap1 <= 3 || s.ap2 <= 3; });
    }

    return list;
  }

  // --- BUILD MATRIX DATA ---
  function buildMatrix(list) {
    var m = {};
    for (var r = GRADE_MIN; r <= GRADE_MAX; r++) {
      m[r] = {};
      for (var c = GRADE_MIN; c <= GRADE_MAX; c++) {
        m[r][c] = [];
      }
    }
    list.forEach(function(s) {
      m[s.ap1][s.ap2].push(s.name);
    });
    return m;
  }

  // --- RENDER MATRIX TABLE ---
  function renderMatrix() {
    var list = getFilteredStudents();
    var m = buildMatrix(list);
    var html = '<table class="matrix"><thead><tr><th class="corner">AP1 \\ AP2</th>';

    GRADES.forEach(function(g) {
      html += '<th class="col-header">' + g + '</th>';
    });
    html += '<th class="col-header" style="font-size:0.65rem;">Total</th>';
    html += '</tr></thead><tbody>';

    GRADES.forEach(function(r) {
      var rowTotal = 0;
      html += '<tr><th class="row-header">' + r + '</th>';

      GRADES.forEach(function(c) {
        var count = m[r][c].length;
        rowTotal += count;
        var cls = 'empty';
        if (count > 0) {
          if (c > r) cls = 'improve';
          else if (c === r) cls = 'maintain';
          else cls = 'decline';
        }
        html += '<td class="' + cls + '" data-r="' + r + '" data-c="' + c + '">';
        html += count || '';
        html += '</td>';
      });

      html += '<td class="total-cell">' + rowTotal + '</td></tr>';
    });

    // Column totals row
    html += '<tr><th class="row-header" style="font-size:0.65rem;">Total</th>';
    GRADES.forEach(function(c) {
      var colTotal = 0;
      GRADES.forEach(function(r) { colTotal += m[r][c].length; });
      html += '<td class="total-cell">' + colTotal + '</td>';
    });
    html += '<td class="grand-total">' + list.length + '</td></tr>';
    html += '</tbody></table>';

    document.getElementById('matrixWrap').innerHTML = html;

    // Click handlers for individual cells
    document.querySelectorAll('table.matrix td[data-r]').forEach(function(td) {
      td.addEventListener('click', function() {
        var r = +this.dataset.r;
        var c = +this.dataset.c;
        var names = m[r][c];
        if (!names.length) return;
        var dir = classify(r, c);
        var label = dir.charAt(0).toUpperCase() + dir.slice(1);
        showDetail(
          'Grade ' + r + ' to Grade ' + c + ' (' + label + '): ' +
          names.length + ' student' + (names.length > 1 ? 's' : ''),
          names,
          dir
        );
      });
    });
  }

  // --- RENDER SUMMARY STATS ---
  function renderStats() {
    var list = getFilteredStudents();
    var total = list.length;

    if (!total) {
      document.getElementById('statsRow').innerHTML =
        '<div class="stat-card"><div class="stat-label">No students match current filters</div>' +
        '<div class="stat-value grey">0</div></div>';
      return;
    }

    var improved = list.filter(function(s) { return s.ap2 > s.ap1; }).length;
    var maintained = list.filter(function(s) { return s.ap2 === s.ap1; }).length;
    var declined = list.filter(function(s) { return s.ap2 < s.ap1; }).length;

    var sumChange = list.reduce(function(a, s) { return a + (s.ap2 - s.ap1); }, 0);
    var avgChange = (sumChange / total).toFixed(2);

    // Most common transition
    var tMap = {};
    list.forEach(function(s) {
      var key = s.ap1 + ' to ' + s.ap2;
      tMap[key] = (tMap[key] || 0) + 1;
    });
    var mostCommon = '';
    var mcCount = 0;
    Object.keys(tMap).forEach(function(k) {
      if (tMap[k] > mcCount) {
        mcCount = tMap[k];
        mostCommon = k;
      }
    });

    var cards = [
      { label: 'Improved', value: Math.round((improved / total) * 100) + '%', cls: 'green', sub: improved + ' students' },
      { label: 'Maintained', value: Math.round((maintained / total) * 100) + '%', cls: 'grey', sub: maintained + ' students' },
      { label: 'Declined', value: Math.round((declined / total) * 100) + '%', cls: 'red', sub: declined + ' students' },
      { label: 'Avg Grade Change', value: (avgChange > 0 ? '+' : '') + avgChange, cls: 'blue', sub: 'across ' + total + ' students' },
      { label: 'Most Common Transition', value: 'Grade ' + mostCommon, cls: 'blue', sub: mcCount + ' students' }
    ];

    document.getElementById('statsRow').innerHTML = cards.map(function(p) {
      return '<div class="stat-card">' +
        '<div class="stat-label">' + p.label + '</div>' +
        '<div class="stat-value ' + p.cls + '">' + p.value + '</div>' +
        '<div class="stat-sub">' + p.sub + '</div>' +
        '</div>';
    }).join('');
  }

  // --- DETAIL PANEL ---
  function showDetail(title, names, direction) {
    var dp = document.getElementById('detailPanel');
    document.getElementById('detailTitle').textContent = title;
    var chipClass = direction === 'improved' ? 'improve-chip'
      : direction === 'maintained' ? 'maintain-chip'
      : 'decline-chip';
    document.getElementById('detailList').innerHTML = names.map(function(n) {
      return '<span class="student-chip ' + chipClass + '">' + n + '</span>';
    }).join('');
    dp.classList.add('visible');
    dp.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  document.getElementById('closeDetail').addEventListener('click', function() {
    document.getElementById('detailPanel').classList.remove('visible');
  });

  // --- SANKEY / ALLUVIAL DIAGRAM ---
  function renderSankey() {
    var canvas = document.getElementById('sankey');
    var ctx = canvas.getContext('2d');
    var dpr = window.devicePixelRatio || 1;
    var rect = canvas.parentElement.getBoundingClientRect();
    var W = Math.min(560, rect.width - 24);
    var H = 480;

    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, W, H);

    var list = getFilteredStudents();

    if (!list.length) {
      ctx.fillStyle = '#999';
      ctx.font = '14px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('No students match current filters', W / 2, H / 2);
      return;
    }

    var colW = 40;
    var gap = 4;
    var padTop = 24;
    var padBot = 20;
    var leftX = 30;
    var rightX = W - colW - 30;
    var usableH = H - padTop - padBot;

    // Count students per grade at each assessment point
    var ap1Counts = {};
    var ap2Counts = {};
    for (var g = GRADE_MIN; g <= GRADE_MAX; g++) {
      ap1Counts[g] = 0;
      ap2Counts[g] = 0;
    }
    list.forEach(function(s) {
      ap1Counts[s.ap1]++;
      ap2Counts[s.ap2]++;
    });

    // Compute vertical positions for grade blocks
    function computePositions(counts) {
      var total = list.length;
      var activeGrades = GRADES.filter(function(g) { return counts[g] > 0; });
      var numActive = activeGrades.length;
      var totalGap = Math.max(0, numActive - 1) * gap;
      var barH = usableH - totalGap;
      var positions = {};
      var y = padTop;
      GRADES.forEach(function(g) {
        if (counts[g] > 0) {
          var h = (counts[g] / total) * barH;
          positions[g] = { y: y, h: h };
          y += h + gap;
        }
      });
      return positions;
    }

    var leftPos = computePositions(ap1Counts);
    var rightPos = computePositions(ap2Counts);

    // Build flow counts
    var flows = {};
    list.forEach(function(s) {
      var key = s.ap1 + '-' + s.ap2;
      flows[key] = (flows[key] || 0) + 1;
    });

    // Offsets for stacking ribbons within each grade block
    var leftOff = {};
    var rightOff = {};
    GRADES.forEach(function(g) {
      leftOff[g] = 0;
      rightOff[g] = 0;
    });

    var total = list.length;
    var numAp1 = GRADES.filter(function(g) { return ap1Counts[g] > 0; }).length;
    var numAp2 = GRADES.filter(function(g) { return ap2Counts[g] > 0; }).length;
    var barH1 = usableH - Math.max(0, numAp1 - 1) * gap;
    var barH2 = usableH - Math.max(0, numAp2 - 1) * gap;

    // Store ribbon geometry for hover detection
    var ribbons = [];

    // Sort flows so larger ribbons draw first (behind smaller ones)
    var sortedFlows = Object.entries(flows).sort(function(a, b) {
      return b[1] - a[1];
    });

    // Draw each ribbon as a filled bezier path
    sortedFlows.forEach(function(entry) {
      var key = entry[0];
      var count = entry[1];
      var parts = key.split('-');
      var ap1 = +parts[0];
      var ap2 = +parts[1];

      if (!leftPos[ap1] || !rightPos[ap2]) return;

      var lH = (count / total) * barH1;
      var rH = (count / total) * barH2;
      var ly = leftPos[ap1].y + leftOff[ap1];
      var ry = rightPos[ap2].y + rightOff[ap2];

      leftOff[ap1] += lH;
      rightOff[ap2] += rH;

      // Colour by direction
      var color;
      if (ap2 > ap1) color = 'rgba(40, 167, 69, 0.35)';
      else if (ap2 === ap1) color = 'rgba(108, 117, 125, 0.30)';
      else color = 'rgba(220, 53, 69, 0.35)';

      var x0 = leftX + colW;
      var x1 = rightX;
      var cp = (x1 - x0) * 0.4;

      ctx.beginPath();
      ctx.moveTo(x0, ly);
      ctx.bezierCurveTo(x0 + cp, ly, x1 - cp, ry, x1, ry);
      ctx.lineTo(x1, ry + rH);
      ctx.bezierCurveTo(x1 - cp, ry + rH, x0 + cp, ly + lH, x0, ly + lH);
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();

      ribbons.push({
        ap1: ap1, ap2: ap2, count: count,
        x0: x0, x1: x1,
        ly: ly, lyh: ly + lH,
        ry: ry, ryh: ry + rH,
        color: color
      });
    });

    // Draw grade blocks on left and right
    function drawBlocks(pos, x, counts) {
      GRADES.forEach(function(g) {
        if (!pos[g]) return;
        var y = pos[g].y;
        var h = pos[g].h;

        // Block background
        ctx.fillStyle = '#1a2332';
        ctx.fillRect(x, y, colW, h);

        // Block border
        ctx.strokeStyle = '#0d1520';
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, colW, h);

        // Grade label
        if (h > 14) {
          ctx.fillStyle = '#ffffff';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(String(g), x + colW / 2, y + h / 2);

          // Count sublabel if space allows
          if (h > 28) {
            ctx.font = '9px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.fillText('(' + counts[g] + ')', x + colW / 2, y + h / 2 + 12);
          }
        }
      });
    }

    drawBlocks(leftPos, leftX, ap1Counts);
    drawBlocks(rightPos, rightX, ap2Counts);

    // Column labels above blocks
    ctx.fillStyle = '#555';
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText('AP1', leftX + colW / 2, padTop - 8);
    ctx.fillText('AP2', rightX + colW / 2, padTop - 8);

    // --- Hover detection for ribbons ---
    var tooltip = document.getElementById('tooltip');

    canvas.onmousemove = function(e) {
      var r = canvas.getBoundingClientRect();
      var mx = (e.clientX - r.left) * (W / r.width);
      var my = (e.clientY - r.top) * (H / r.height);

      var found = null;
      for (var i = 0; i < ribbons.length; i++) {
        var rb = ribbons[i];
        var t = (mx - rb.x0) / (rb.x1 - rb.x0);
        if (t < 0 || t > 1) continue;

        // Smoothstep interpolation to approximate bezier curve position
        var smooth = t * t * (3 - 2 * t);
        var yt = rb.ly + (rb.ry - rb.ly) * smooth;
        var yth = rb.lyh + (rb.ryh - rb.lyh) * smooth;

        if (my >= yt && my <= yth) {
          found = rb;
          break;
        }
      }

      if (found) {
        var dir = classify(found.ap1, found.ap2);
        var label = dir.charAt(0).toUpperCase() + dir.slice(1);
        tooltip.textContent = 'Grade ' + found.ap1 + ' to ' + found.ap2 +
          ': ' + found.count + ' student' + (found.count > 1 ? 's' : '') +
          ' (' + label + ')';
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX + 14) + 'px';
        tooltip.style.top = (e.clientY - 10) + 'px';
      } else {
        tooltip.style.display = 'none';
      }
    };

    canvas.onmouseleave = function() {
      tooltip.style.display = 'none';
    };
  }

  // --- ADD STUDENT MODAL ---
  function populateGradeSelects() {
    ['ap1Grade', 'ap2Grade'].forEach(function(id) {
      var sel = document.getElementById(id);
      sel.innerHTML = '';
      for (var g = 9; g >= 1; g--) {
        var opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g;
        if (g === 5) opt.selected = true;
        sel.appendChild(opt);
      }
    });
  }
  populateGradeSelects();

  document.getElementById('addStudentBtn').addEventListener('click', function() {
    document.getElementById('studentName').value = '';
    document.getElementById('addModal').classList.add('visible');
    setTimeout(function() {
      document.getElementById('studentName').focus();
    }, 100);
  });

  document.getElementById('cancelAdd').addEventListener('click', function() {
    document.getElementById('addModal').classList.remove('visible');
  });

  document.getElementById('confirmAdd').addEventListener('click', function() {
    var name = document.getElementById('studentName').value.trim();
    if (!name) {
      alert('Please enter a student name.');
      return;
    }
    var ap1 = +document.getElementById('ap1Grade').value;
    var ap2 = +document.getElementById('ap2Grade').value;
    students.push({ name: name, ap1: ap1, ap2: ap2 });
    document.getElementById('addModal').classList.remove('visible');
    refresh();
  });

  // --- BULK ADD MODAL ---
  document.getElementById('bulkAddBtn').addEventListener('click', function() {
    document.getElementById('bulkInput').value = '';
    document.getElementById('bulkModal').classList.add('visible');
    setTimeout(function() {
      document.getElementById('bulkInput').focus();
    }, 100);
  });

  document.getElementById('cancelBulk').addEventListener('click', function() {
    document.getElementById('bulkModal').classList.remove('visible');
  });

  document.getElementById('confirmBulk').addEventListener('click', function() {
    var raw = document.getElementById('bulkInput').value.trim();
    if (!raw) {
      alert('Please paste at least one line of student data.');
      return;
    }

    var lines = raw.split('\n');
    var added = 0;
    var errors = [];

    lines.forEach(function(line, idx) {
      line = line.trim();
      if (!line) return;
      var parts = line.split(',');
      if (parts.length < 3) {
        errors.push('Line ' + (idx + 1) + ': expected 3 comma-separated values');
        return;
      }
      var name = parts[0].trim();
      var ap1 = parseInt(parts[1].trim(), 10);
      var ap2 = parseInt(parts[2].trim(), 10);

      if (!name) {
        errors.push('Line ' + (idx + 1) + ': missing student name');
        return;
      }
      if (isNaN(ap1) || ap1 < GRADE_MIN || ap1 > GRADE_MAX) {
        errors.push('Line ' + (idx + 1) + ': AP1 grade must be between 1 and 9');
        return;
      }
      if (isNaN(ap2) || ap2 < GRADE_MIN || ap2 > GRADE_MAX) {
        errors.push('Line ' + (idx + 1) + ': AP2 grade must be between 1 and 9');
        return;
      }

      students.push({ name: name, ap1: ap1, ap2: ap2 });
      added++;
    });

    var msg = 'Added ' + added + ' student' + (added !== 1 ? 's' : '') + '.';
    if (errors.length) {
      msg += '\n\nSkipped ' + errors.length + ' line' + (errors.length !== 1 ? 's' : '') +
        ' with errors:\n' + errors.join('\n');
    }

    alert(msg);
    document.getElementById('bulkModal').classList.remove('visible');
    if (added > 0) refresh();
  });

  // --- MANAGE STUDENTS MODAL ---
  function renderManageTable() {
    var html = '<table class="student-table"><thead><tr>' +
      '<th>#</th><th>Name</th><th>AP1</th><th>AP2</th><th>Change</th><th></th>' +
      '</tr></thead><tbody>';

    students.forEach(function(s, i) {
      var change = s.ap2 - s.ap1;
      var cStr;
      if (change > 0) {
        cStr = '<span style="color:var(--improve);">+' + change + '</span>';
      } else if (change < 0) {
        cStr = '<span style="color:var(--decline);">' + change + '</span>';
      } else {
        cStr = '<span style="color:var(--maintain);">0</span>';
      }

      var opts1 = '';
      var opts2 = '';
      for (var g = 9; g >= 1; g--) {
        opts1 += '<option value="' + g + '"' + (g === s.ap1 ? ' selected' : '') + '>' + g + '</option>';
        opts2 += '<option value="' + g + '"' + (g === s.ap2 ? ' selected' : '') + '>' + g + '</option>';
      }

      html += '<tr>' +
        '<td>' + (i + 1) + '</td>' +
        '<td>' + s.name + '</td>' +
        '<td><select data-idx="' + i + '" data-field="ap1">' + opts1 + '</select></td>' +
        '<td><select data-idx="' + i + '" data-field="ap2">' + opts2 + '</select></td>' +
        '<td>' + cStr + '</td>' +
        '<td><button class="del-btn" data-idx="' + i + '" title="Remove student">&times;</button></td>' +
        '</tr>';
    });

    html += '</tbody></table>';
    document.getElementById('manageTableWrap').innerHTML = html;

    // Live-edit grade selects
    document.querySelectorAll('#manageTableWrap select').forEach(function(sel) {
      sel.addEventListener('change', function() {
        var idx = +this.dataset.idx;
        var field = this.dataset.field;
        students[idx][field] = +this.value;
        refresh();
        renderManageTable();
      });
    });

    // Delete buttons
    document.querySelectorAll('#manageTableWrap .del-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var idx = +this.dataset.idx;
        if (confirm('Remove ' + students[idx].name + '?')) {
          students.splice(idx, 1);
          refresh();
          renderManageTable();
        }
      });
    });
  }

  document.getElementById('manageBtn').addEventListener('click', function() {
    renderManageTable();
    document.getElementById('manageModal').classList.add('visible');
  });

  document.getElementById('closeManage').addEventListener('click', function() {
    document.getElementById('manageModal').classList.remove('visible');
  });

  // --- EXPORT: copy transition matrix as formatted text table ---
  document.getElementById('exportBtn').addEventListener('click', function() {
    var list = getFilteredStudents();
    var m = buildMatrix(list);

    var txt = 'TRANSITION MATRIX\n';
    txt += '=================\n\n';
    txt += 'AP1\\AP2\t' + GRADES.join('\t') + '\tTotal\n';

    GRADES.forEach(function(r) {
      var rowTotal = 0;
      var cells = GRADES.map(function(c) {
        var count = m[r][c].length;
        rowTotal += count;
        return count || '.';
      });
      txt += r + '\t' + cells.join('\t') + '\t' + rowTotal + '\n';
    });

    // Column totals
    txt += 'Total';
    GRADES.forEach(function(c) {
      var colTotal = 0;
      GRADES.forEach(function(r) { colTotal += m[r][c].length; });
      txt += '\t' + colTotal;
    });
    txt += '\t' + list.length + '\n';

    txt += '\nSUMMARY\n';
    txt += '-------\n';
    txt += 'Total students: ' + list.length + '\n';

    var improved = list.filter(function(s) { return s.ap2 > s.ap1; }).length;
    var maintained = list.filter(function(s) { return s.ap2 === s.ap1; }).length;
    var declined = list.filter(function(s) { return s.ap2 < s.ap1; }).length;

    txt += 'Improved: ' + improved + ' (' + Math.round((improved / list.length) * 100) + '%)\n';
    txt += 'Maintained: ' + maintained + ' (' + Math.round((maintained / list.length) * 100) + '%)\n';
    txt += 'Declined: ' + declined + ' (' + Math.round((declined / list.length) * 100) + '%)\n';

    var avg = (list.reduce(function(a, s) { return a + (s.ap2 - s.ap1); }, 0) / list.length).toFixed(2);
    txt += 'Average grade change: ' + (avg > 0 ? '+' : '') + avg + '\n';

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(txt).then(function() {
        alert('Transition matrix copied to clipboard.');
      });
    } else {
      var ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('Transition matrix copied to clipboard.');
    }
  });

  // --- RESET TO DEMO DATA ---
  document.getElementById('resetBtn').addEventListener('click', function() {
    if (confirm('Reset to demo data? All changes will be lost.')) {
      students = defaultStudents();
      document.getElementById('filterSelect').value = 'all';
      document.getElementById('gradeBand').value = 'all';
      refresh();
    }
  });

  // --- FILTER CHANGE HANDLERS ---
  document.getElementById('filterSelect').addEventListener('change', refresh);
  document.getElementById('gradeBand').addEventListener('change', refresh);

  // --- CLOSE MODALS ON OVERLAY CLICK ---
  document.querySelectorAll('.modal-overlay').forEach(function(ov) {
    ov.addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('visible');
      }
    });
  });

  // --- KEYBOARD: Escape closes modals ---
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal-overlay.visible').forEach(function(ov) {
        ov.classList.remove('visible');
      });
    }
  });

  // --- MASTER REFRESH ---
  function refresh() {
    renderMatrix();
    renderStats();
    renderSankey();
    document.getElementById('detailPanel').classList.remove('visible');
  }

  // --- RESIZE HANDLER (debounced) ---
  var resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      renderSankey();
    }, 150);
  });

  // --- INITIALISE ---
  refresh();

})();
</script>
</body>
</html>