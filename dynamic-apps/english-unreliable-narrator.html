<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unreliable Narrator Detective</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1a1a2e;--bg2:#16213e;--bg3:#0f3460;
  --gold:#e2b714;--gold-dim:#b8941a;
  --red:#c0392b;--red-light:#e74c3c;
  --green:#27ae60;--green-light:#2ecc71;
  --amber:#f39c12;--amber-light:#f1c40f;
  --text:#e8e8e8;--text-dim:#a0a0b0;
  --paper:#f5f0e1;--paper-dark:#d4c9a8;
  --cork:#8B6914;--cork-light:#a67c00;
  --pin-red:#cc3333;--pin-blue:#3366cc;
  --shadow:0 4px 24px rgba(0,0,0,.5);
  --font-serif:'Georgia','Times New Roman',serif;
  --font-mono:'Courier New',Courier,monospace;
}
html{font-size:16px;scroll-behavior:smooth}
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100vh;overflow-x:hidden;
  background-image:
    radial-gradient(ellipse at 20% 50%,rgba(15,52,96,.4) 0%,transparent 60%),
    radial-gradient(ellipse at 80% 20%,rgba(226,183,20,.05) 0%,transparent 50%);
}

/* ── Scrollbar ── */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--gold-dim)}

/* ── Header ── */
.header{
  text-align:center;padding:1.5rem 1rem .5rem;
  background:linear-gradient(180deg,rgba(0,0,0,.4) 0%,transparent 100%);
  position:relative;
}
.header h1{
  font-family:var(--font-serif);font-size:clamp(1.6rem,4vw,2.8rem);
  color:var(--gold);text-shadow:0 0 30px rgba(226,183,20,.3);
  letter-spacing:2px;margin-bottom:.25rem;
}
.header h1 .icon{font-style:normal;margin-right:.5rem}
.header .subtitle{
  font-family:var(--font-mono);font-size:clamp(.75rem,1.5vw,1rem);
  color:var(--text-dim);letter-spacing:4px;text-transform:uppercase;
}
.header-line{
  width:min(80%,600px);height:1px;margin:1rem auto 0;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
}

/* ── Layout ── */
.app-container{
  display:flex;flex-direction:column;
  max-width:1600px;margin:0 auto;padding:0 1rem 2rem;
}
.top-bar{
  display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;
  justify-content:center;padding:1rem 0;
}
.story-btn{
  font-family:var(--font-mono);font-size:.85rem;
  padding:.5rem 1.2rem;border:1px solid var(--gold-dim);
  background:transparent;color:var(--gold);border-radius:4px;
  cursor:pointer;transition:all .25s;position:relative;overflow:hidden;
}
.story-btn:hover,.story-btn.active{
  background:var(--gold);color:var(--bg);
  box-shadow:0 0 20px rgba(226,183,20,.3);
}
.story-btn::before{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);
  transition:left .5s;
}
.story-btn:hover::before{left:100%}

.main-panels{
  display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;
  min-height:500px;
}
@media(max-width:1024px){
  .main-panels{grid-template-columns:1fr;min-height:auto}
}

/* ── Reading Panel ── */
.reading-panel{
  background:var(--paper);color:#2c2c2c;border-radius:8px;
  padding:0;position:relative;box-shadow:var(--shadow);
  display:flex;flex-direction:column;overflow:hidden;
}
.reading-header{
  background:linear-gradient(135deg,#3a2a1a,#5a3a1a);
  color:var(--paper);padding:.75rem 1.2rem;
  font-family:var(--font-serif);font-size:1.1rem;
  display:flex;align-items:center;gap:.75rem;
}
.reading-header .file-tab{
  background:rgba(255,255,255,.1);padding:.25rem .75rem;
  border-radius:3px;font-size:.8rem;font-family:var(--font-mono);
}
.reading-body{
  padding:1.5rem 2rem;flex:1;overflow-y:auto;
  font-family:var(--font-serif);font-size:1.05rem;line-height:1.9;
  position:relative;user-select:text;cursor:text;
  max-height:60vh;
}
.reading-body p{margin-bottom:1rem;text-indent:1.5rem}
.reading-body p:first-child{text-indent:0}
.reading-body .story-title{
  font-size:1.25rem;font-weight:bold;text-indent:0;
  margin-bottom:.5rem;color:#3a2a1a;
  border-bottom:2px solid #3a2a1a;padding-bottom:.5rem;
}
.reading-body .story-context{
  font-style:italic;font-size:.9rem;color:#666;
  text-indent:0;margin-bottom:1.25rem;
  padding:.5rem;background:rgba(0,0,0,.04);border-radius:4px;
}

/* Highlights in text */
mark.trustworthy{
  background:rgba(46,204,113,.3);border-bottom:2px solid var(--green);
  cursor:pointer;border-radius:2px;position:relative;
  transition:background .2s;
}
mark.trustworthy:hover{background:rgba(46,204,113,.5)}
mark.suspicious{
  background:rgba(231,76,60,.25);border-bottom:2px solid var(--red);
  cursor:pointer;border-radius:2px;position:relative;
  transition:background .2s;
}
mark.suspicious:hover{background:rgba(231,76,60,.45)}
mark .hl-badge{
  position:absolute;top:-18px;right:0;font-size:.55rem;
  padding:1px 5px;border-radius:3px;font-family:sans-serif;
  pointer-events:none;white-space:nowrap;
}
mark.trustworthy .hl-badge{background:var(--green);color:#fff}
mark.suspicious .hl-badge{background:var(--red);color:#fff}

/* ── Highlight Toolbar ── */
.hl-toolbar{
  position:fixed;display:none;z-index:1000;
  background:#222;border:1px solid var(--gold);border-radius:8px;
  padding:.5rem;box-shadow:0 8px 32px rgba(0,0,0,.6);
  flex-direction:row;gap:.4rem;
  animation:fadeUp .2s ease;
}
.hl-toolbar.show{display:flex}
.hl-toolbar button{
  font-size:.75rem;padding:.35rem .7rem;border:none;border-radius:4px;
  cursor:pointer;font-weight:600;transition:all .2s;
}
.hl-toolbar .btn-sus{background:var(--red);color:#fff}
.hl-toolbar .btn-sus:hover{background:var(--red-light)}
.hl-toolbar .btn-trust{background:var(--green);color:#fff}
.hl-toolbar .btn-trust:hover{background:var(--green-light)}
.hl-toolbar .btn-cancel{background:#555;color:#ccc}
.hl-toolbar .btn-cancel:hover{background:#777}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}

/* ── Evidence Wall ── */
.evidence-panel{
  background:
    repeating-conic-gradient(#8B6914 0% 25%, #7a5c10 0% 50%) 50% / 20px 20px;
  border-radius:8px;box-shadow:var(--shadow);
  position:relative;overflow:hidden;display:flex;flex-direction:column;
  border:6px solid #5a3a1a;
}
.evidence-panel::before{
  content:'';position:absolute;inset:0;
  background:
    radial-gradient(circle at 20% 30%,rgba(0,0,0,.15),transparent 40%),
    radial-gradient(circle at 80% 70%,rgba(0,0,0,.1),transparent 40%);
  pointer-events:none;z-index:1;
}
.evidence-header{
  background:linear-gradient(135deg,#3a2a1a,#5a3a1a);
  color:var(--paper);padding:.75rem 1.2rem;
  font-family:var(--font-serif);font-size:1.1rem;
  display:flex;align-items:center;justify-content:space-between;gap:.5rem;
  z-index:2;position:relative;
}
.evidence-header .card-count{
  font-family:var(--font-mono);font-size:.8rem;
  background:rgba(255,255,255,.15);padding:.2rem .6rem;border-radius:3px;
}

.evidence-wall{
  flex:1;padding:1rem;overflow-y:auto;position:relative;z-index:2;
  min-height:300px;max-height:60vh;
}
.evidence-wall canvas{
  position:absolute;top:0;left:0;width:100%;height:100%;
  pointer-events:none;z-index:0;
}
.evidence-wall .no-evidence{
  text-align:center;color:var(--paper-dark);
  font-family:var(--font-serif);font-style:italic;
  padding:3rem 1rem;opacity:.7;
}

/* Evidence Card */
.ev-card{
  background:var(--paper);color:#2c2c2c;width:220px;
  padding:0;border-radius:2px;position:absolute;
  box-shadow:3px 3px 15px rgba(0,0,0,.4);
  cursor:grab;z-index:10;
  transform:rotate(var(--rot,0deg));
  transition:box-shadow .2s,transform .15s;
  font-size:.8rem;
}
.ev-card:hover{
  box-shadow:4px 4px 25px rgba(0,0,0,.6);
  z-index:20;
}
.ev-card.dragging{cursor:grabbing;z-index:100;opacity:.85}
.ev-card .pin{
  width:16px;height:16px;border-radius:50%;
  position:absolute;top:-6px;left:50%;transform:translateX(-50%);
  box-shadow:0 2px 4px rgba(0,0,0,.4);z-index:2;
}
.ev-card.suspicious .pin{background:var(--pin-red)}
.ev-card.trustworthy .pin{background:var(--pin-blue)}
.ev-card .card-type{
  font-family:var(--font-mono);font-size:.6rem;
  padding:.3rem .6rem;text-transform:uppercase;letter-spacing:1px;
  color:#fff;
}
.ev-card.suspicious .card-type{background:var(--red)}
.ev-card.trustworthy .card-type{background:var(--green)}
.ev-card .card-quote{
  padding:.5rem .6rem;font-family:var(--font-serif);
  font-style:italic;font-size:.78rem;line-height:1.5;
  border-bottom:1px dashed #ccc;max-height:80px;overflow-y:auto;
}
.ev-card .card-quote::before{content:'\201C'}
.ev-card .card-quote::after{content:'\201D'}
.ev-card .card-note{
  padding:.4rem .6rem;font-size:.72rem;color:#555;
  min-height:24px;
}
.ev-card .card-note em{color:#888}
.ev-card .card-actions{
  display:flex;gap:0;border-top:1px solid #ddd;
}
.ev-card .card-actions button{
  flex:1;border:none;padding:.3rem;font-size:.65rem;
  cursor:pointer;background:transparent;color:#888;
  transition:all .2s;
}
.ev-card .card-actions button:hover{background:#eee;color:#333}
.ev-card .card-actions button.connect-btn.active{
  background:var(--gold);color:#333;
}

/* Connection Canvas */
#connectionCanvas{
  position:absolute;top:0;left:0;pointer-events:none;z-index:5;
}

/* ── Bottom Section ── */
.bottom-section{
  margin-top:1.5rem;display:grid;
  grid-template-columns:1fr 1fr;gap:1.5rem;
}
@media(max-width:1024px){
  .bottom-section{grid-template-columns:1fr}
}

/* Rating Panel */
.rating-panel{
  background:rgba(255,255,255,.05);border:1px solid rgba(226,183,20,.2);
  border-radius:8px;padding:1.5rem;
}
.rating-panel h3{
  font-family:var(--font-serif);color:var(--gold);margin-bottom:1rem;
  font-size:1.1rem;
}
.rating-slider-wrap{
  display:flex;align-items:center;gap:1rem;margin-bottom:1rem;
}
.rating-slider-wrap label{font-size:.85rem;color:var(--text-dim);min-width:90px}
.rating-slider{
  flex:1;-webkit-appearance:none;appearance:none;
  height:8px;border-radius:4px;outline:none;
  background:linear-gradient(90deg,var(--green),var(--amber),var(--red));
}
.rating-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:24px;height:24px;border-radius:50%;
  background:var(--gold);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.4);
  border:2px solid #fff;
}
.rating-slider::-moz-range-thumb{
  width:24px;height:24px;border-radius:50%;
  background:var(--gold);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.4);
  border:2px solid #fff;
}
.rating-value{
  font-family:var(--font-mono);font-size:2rem;color:var(--gold);
  min-width:50px;text-align:center;
  text-shadow:0 0 20px rgba(226,183,20,.4);
}
.rating-label{
  text-align:center;font-size:.8rem;color:var(--text-dim);
  margin-bottom:.75rem;
}
.justification-box{
  width:100%;min-height:80px;padding:.75rem;
  background:rgba(0,0,0,.2);border:1px solid rgba(226,183,20,.2);
  border-radius:4px;color:var(--text);font-size:.9rem;
  font-family:var(--font-serif);resize:vertical;
}
.justification-box::placeholder{color:rgba(255,255,255,.3)}

/* Submit */
.submit-panel{
  background:rgba(255,255,255,.05);border:1px solid rgba(226,183,20,.2);
  border-radius:8px;padding:1.5rem;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:1rem;
}
.submit-btn{
  font-family:var(--font-serif);font-size:1.2rem;
  padding:.85rem 2.5rem;border:2px solid var(--gold);
  background:transparent;color:var(--gold);border-radius:6px;
  cursor:pointer;transition:all .3s;letter-spacing:1px;
  position:relative;overflow:hidden;
}
.submit-btn:hover{
  background:var(--gold);color:var(--bg);
  box-shadow:0 0 40px rgba(226,183,20,.4);
  transform:scale(1.03);
}
.submit-btn:active{transform:scale(.97)}
.submit-btn::after{
  content:'';position:absolute;top:50%;left:50%;
  width:0;height:0;border-radius:50%;
  background:rgba(255,255,255,.2);
  transition:width .4s,height .4s,top .4s,left .4s;
}
.submit-btn:active::after{
  width:300px;height:300px;top:calc(50% - 150px);left:calc(50% - 150px);
}
.reset-btn{
  font-size:.8rem;padding:.4rem 1rem;border:1px solid rgba(255,255,255,.2);
  background:transparent;color:var(--text-dim);border-radius:4px;
  cursor:pointer;transition:all .2s;
}
.reset-btn:hover{border-color:var(--red);color:var(--red)}
.stats-preview{
  font-family:var(--font-mono);font-size:.8rem;color:var(--text-dim);
  text-align:center;
}

/* ── Results Overlay ── */
.results-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  z-index:9999;display:none;align-items:center;justify-content:center;
  padding:1rem;overflow-y:auto;
}
.results-overlay.show{display:flex}
.results-card{
  background:var(--bg2);border:2px solid var(--gold);border-radius:12px;
  max-width:800px;width:100%;max-height:90vh;overflow-y:auto;
  padding:2rem;position:relative;
  animation:resultSlide .6s cubic-bezier(.22,.61,.36,1);
}
@keyframes resultSlide{
  from{opacity:0;transform:translateY(40px) scale(.95)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
.results-card h2{
  font-family:var(--font-serif);color:var(--gold);text-align:center;
  font-size:1.8rem;margin-bottom:.25rem;
}
.rank-badge{
  display:block;text-align:center;font-family:var(--font-mono);
  font-size:1.1rem;color:var(--amber);margin-bottom:1.5rem;
  letter-spacing:3px;text-transform:uppercase;
}
.rank-badge .rank-icon{font-size:2rem;display:block;margin-bottom:.25rem}

.score-bar-wrap{
  margin-bottom:1.5rem;
}
.score-bar-label{
  display:flex;justify-content:space-between;font-size:.85rem;
  color:var(--text-dim);margin-bottom:.35rem;
}
.score-bar{
  height:12px;background:rgba(255,255,255,.1);border-radius:6px;overflow:hidden;
}
.score-bar-fill{
  height:100%;border-radius:6px;transition:width 1.5s cubic-bezier(.22,.61,.36,1);
  background:linear-gradient(90deg,var(--red),var(--amber),var(--green));
}

.results-section{margin-bottom:1.25rem}
.results-section h3{
  font-family:var(--font-serif);color:var(--gold);font-size:1rem;
  margin-bottom:.5rem;padding-bottom:.35rem;
  border-bottom:1px solid rgba(226,183,20,.2);
}
.results-section .evidence-item{
  padding:.5rem .75rem;margin-bottom:.4rem;border-radius:4px;
  font-size:.85rem;line-height:1.5;
}
.evidence-item.found{
  background:rgba(46,204,113,.1);border-left:3px solid var(--green);
}
.evidence-item.missed{
  background:rgba(231,76,60,.1);border-left:3px solid var(--red);
}
.evidence-item.bonus{
  background:rgba(243,156,18,.1);border-left:3px solid var(--amber);
}
.evidence-item .ev-quote{
  font-family:var(--font-serif);font-style:italic;color:var(--text);
}
.evidence-item .ev-explain{
  font-size:.8rem;color:var(--text-dim);margin-top:.25rem;
}

.close-results{
  position:absolute;top:1rem;right:1rem;background:none;border:none;
  color:var(--text-dim);font-size:1.5rem;cursor:pointer;
  transition:color .2s;
}
.close-results:hover{color:var(--gold)}

/* ── Note Modal ── */
.note-modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:5000;
  display:none;align-items:center;justify-content:center;padding:1rem;
}
.note-modal-overlay.show{display:flex}
.note-modal{
  background:var(--bg2);border:1px solid var(--gold);border-radius:8px;
  padding:1.5rem;max-width:450px;width:100%;
  animation:fadeUp .25s ease;
}
.note-modal h3{
  font-family:var(--font-serif);color:var(--gold);margin-bottom:.5rem;
}
.note-modal .quote-preview{
  font-family:var(--font-serif);font-style:italic;font-size:.85rem;
  color:var(--text-dim);padding:.5rem;margin-bottom:.75rem;
  border-left:3px solid var(--gold);background:rgba(0,0,0,.2);
  border-radius:0 4px 4px 0;max-height:80px;overflow-y:auto;
}
.note-modal textarea{
  width:100%;min-height:80px;padding:.6rem;
  background:rgba(0,0,0,.2);border:1px solid rgba(226,183,20,.3);
  border-radius:4px;color:var(--text);font-size:.9rem;
  font-family:var(--font-serif);resize:vertical;
}
.note-modal textarea::placeholder{color:rgba(255,255,255,.3)}
.note-modal .modal-btns{
  display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem;
}
.note-modal .modal-btns button{
  padding:.4rem 1rem;border-radius:4px;border:none;
  cursor:pointer;font-size:.85rem;transition:all .2s;
}
.note-modal .btn-save{background:var(--gold);color:var(--bg)}
.note-modal .btn-save:hover{background:var(--amber-light)}
.note-modal .btn-modal-cancel{background:#555;color:#ccc}
.note-modal .btn-modal-cancel:hover{background:#777}

/* ── Instructions ── */
.instructions{
  text-align:center;padding:.5rem 1rem;
  font-size:.8rem;color:var(--text-dim);
  font-family:var(--font-mono);
}
.instructions span{color:var(--gold)}

/* ── Animations ── */
.reveal-animate{animation:revealPulse .6s ease}
@keyframes revealPulse{
  0%{box-shadow:0 0 0 rgba(226,183,20,0)}
  50%{box-shadow:0 0 30px rgba(226,183,20,.5)}
  100%{box-shadow:0 0 0 rgba(226,183,20,0)}
}

/* ── Responsive ── */
@media(max-width:600px){
  .reading-body{padding:1rem;font-size:.95rem;line-height:1.7}
  .ev-card{width:170px}
  .results-card{padding:1.25rem}
  .bottom-section{gap:1rem}
}
</style>
</head>
<body>

<div class="header">
  <h1><span class="icon">&#128269;</span>Unreliable Narrator Detective</h1>
  <p class="subtitle">Can you spot the lies hidden in the story?</p>
  <div class="header-line"></div>
</div>

<div class="app-container">
  <p class="instructions">
    <span>Select a case</span> below, then <span>highlight suspicious text</span> by selecting it.
    Build your evidence wall and <span>crack the case</span>.
  </p>

  <div class="top-bar" id="storyTabs"></div>

  <div class="main-panels">
    <!-- Reading Panel -->
    <div class="reading-panel">
      <div class="reading-header">
        &#128196; Case File
        <span class="file-tab" id="fileTab">CASE #1</span>
      </div>
      <div class="reading-body" id="readingBody">
        <p style="text-align:center;color:#888;padding-top:3rem;">Select a case above to begin your investigation.</p>
      </div>
    </div>

    <!-- Evidence Wall -->
    <div class="evidence-panel">
      <div class="evidence-header">
        &#128204; Evidence Wall
        <span class="card-count" id="cardCount">0 items</span>
      </div>
      <div class="evidence-wall" id="evidenceWall">
        <canvas id="connectionCanvas"></canvas>
        <div class="no-evidence" id="noEvidence">
          Highlight passages in the text and tag them as<br>
          <strong style="color:#e74c3c">Suspicious</strong> or <strong style="color:#2ecc71">Trustworthy</strong><br>
          to pin evidence here.
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom: Rating + Submit -->
  <div class="bottom-section">
    <div class="rating-panel">
      <h3>&#9878; Narrator Reliability Rating</h3>
      <div class="rating-slider-wrap">
        <label>Unreliable</label>
        <input type="range" class="rating-slider" id="ratingSlider" min="1" max="10" value="5">
        <label style="text-align:right">Reliable</label>
        <div class="rating-value" id="ratingValue">5</div>
      </div>
      <div class="rating-label" id="ratingLabel">Somewhat Questionable</div>
      <textarea class="justification-box" id="justification"
        placeholder="Explain your reasoning: Why did you give this rating? What specific evidence from the text supports your judgement?"></textarea>
    </div>

    <div class="submit-panel">
      <div class="stats-preview" id="statsPreview">
        Highlights: 0 suspicious, 0 trustworthy
      </div>
      <button class="submit-btn" id="submitBtn" onclick="submitAnalysis()">
        &#128270; Submit Analysis
      </button>
      <button class="reset-btn" onclick="resetAnalysis()">Reset Current Case</button>
    </div>
  </div>
</div>

<!-- Highlight Toolbar -->
<div class="hl-toolbar" id="hlToolbar">
  <button class="btn-sus" onclick="applyHighlight('suspicious')">&#128308; Suspicious</button>
  <button class="btn-trust" onclick="applyHighlight('trustworthy')">&#128994; Trustworthy</button>
  <button class="btn-cancel" onclick="hideToolbar()">Cancel</button>
</div>

<!-- Note Modal -->
<div class="note-modal-overlay" id="noteModal">
  <div class="note-modal">
    <h3>&#128221; Add Evidence Note</h3>
    <div class="quote-preview" id="noteQuote"></div>
    <textarea id="noteText" placeholder="Why is this passage suspicious or trustworthy? What does it reveal about the narrator?"></textarea>
    <div class="modal-btns">
      <button class="btn-modal-cancel" onclick="closeNoteModal()">Skip</button>
      <button class="btn-save" onclick="saveNote()">Save Note</button>
    </div>
  </div>
</div>

<!-- Results Overlay -->
<div class="results-overlay" id="resultsOverlay">
  <div class="results-card" id="resultsCard"></div>
</div>

<script>
// ═══════════════════════════════════════════
//  STORY DATA
// ═══════════════════════════════════════════
const STORIES = [
  {
    id: 1,
    title: "The Playground Incident",
    tabLabel: "Case #1: The Playground",
    context: "A Year 9 student's account, written for the Head of Year after being called to a meeting about a lunchtime incident.",
    paragraphs: [
      "I don't even know why I have to write this. I was literally just standing by the picnic benches minding my own business when the whole thing started. Everyone knows that Alex has always had it in for me, ever since I accidentally got a higher mark than him on the English essay. He's never been able to handle that. So of course he had to start something at lunch.",
      "I was talking to my friends, and Alex walked past with his little group. I might have made a comment, but it was obviously a joke \u2014 everyone was laughing, so clearly it was funny. Alex is just way too sensitive. He turned around and started saying stuff to me, getting right in my face, and I told him very calmly to back off. I'm always the calm one. Ask anyone. I never raise my voice.",
      "Then he shoved me. Or maybe he didn't actually shove me, but he definitely stepped towards me in a threatening way. I had no choice but to push him back \u2014 it was self-defence, pure and simple. His water bottle fell and cracked on the ground, which honestly is his own fault for putting it there. Mrs Henderson only saw the last part, which is why she thinks I started it. She's always had a problem with me for no reason whatsoever.",
      "I don't understand why three of Alex's friends told the teacher a completely different story. They're obviously all lying to protect him. The fact that two people from my own friend group also said I started it just proves how scared everyone is of Alex. Even my own friends are too intimidated to tell the truth. I'm the real victim here and nobody ever listens to me."
    ],
    modelEvidence: [
      {
        text: "I might have made a comment, but it was obviously a joke",
        explanation: "The narrator admits to making a provocative comment but immediately minimises it as 'just a joke.' This is a classic deflection technique used by bullies to avoid responsibility."
      },
      {
        text: "everyone was laughing, so clearly it was funny",
        explanation: "The narrator uses others' laughter to justify the comment, but laughter doesn't equal consent \u2014 people often laugh uncomfortably or to avoid being the next target."
      },
      {
        text: "He turned around and started saying stuff to me",
        explanation: "The narrator is vague about what Alex said, likely because including the specifics would reveal that Alex was responding to provocation."
      },
      {
        text: "I told him very calmly to back off. I'm always the calm one. Ask anyone. I never raise my voice",
        explanation: "Excessive self-praise and absolutes like 'always' and 'never' are red flags. People who are genuinely calm rarely need to insist upon it this forcefully."
      },
      {
        text: "Then he shoved me. Or maybe he didn't actually shove me, but he definitely stepped towards me in a threatening way",
        explanation: "The narrator contradicts themselves within the same sentence \u2014 changing the story from a shove to merely a step. This revision reveals they are constructing a justification rather than reporting what happened."
      },
      {
        text: "I had no choice but to push him back",
        explanation: "Framing aggression as self-defence with 'no choice' removes personal responsibility. There are always other choices: walking away, calling a teacher, stepping back."
      },
      {
        text: "She's always had a problem with me for no reason whatsoever",
        explanation: "Claiming the teacher is biased 'for no reason' discredits a witness without providing evidence. A pattern of claiming everyone is unfair suggests the narrator may be the common factor in these conflicts."
      },
      {
        text: "They're obviously all lying to protect him",
        explanation: "Five independent witnesses (including two of the narrator's own friends) all tell the same story. The narrator dismisses all of them rather than considering that the consistent accounts might be accurate."
      },
      {
        text: "two people from my own friend group also said I started it just proves how scared everyone is of Alex",
        explanation: "The narrator's own friends contradicting their account is extremely significant. Rather than reflect on this, they construct an increasingly implausible conspiracy theory."
      }
    ],
    idealRating: 2
  },
  {
    id: 2,
    title: "A Trader's Journal, 1765",
    tabLabel: "Case #2: The Journal",
    context: "An excerpt from the fictional journal of William Hartley, a British merchant trading in colonial West Africa, written in 1765.",
    paragraphs: [
      "14th September \u2014 We arrived at the settlement this morning in fine spirits. The local chief greeted us with what I took to be great enthusiasm, though my translator seemed uneasy and would not meet my eye. I presented the chief with glass beads and two bolts of cloth, which he accepted graciously. In return he provided us with excellent provisions. It was a fair exchange, as it always is. These people understand trade and benefit greatly from our presence here.",
      "15th September \u2014 Negotiations proceeded smoothly. The chief has agreed to provide workers for the coastal warehouses. I explained that they would be well looked after and compensated fairly, and he seemed to understand. My translator spoke for a long time with the chief, far longer than my simple message required, but I assume he was merely being thorough. Some of the younger men in the village watched us from a distance with expressions I could not read. Curiosity, most likely. They have never seen Englishmen of such standing.",
      "17th September \u2014 A small misunderstanding today. Several families attempted to leave the village during the night. The chief's own guards brought them back, so clearly this was an internal matter and nothing to do with our arrangements. I noted it in the ledger simply as a minor delay. The translator has asked to be released from his contract. I refused, as we are not yet finished and I have already paid him half his fee. He is prone to dramatics.",
      "20th September \u2014 The workers have been loaded aboard and we set sail at dawn. I will record this as a successful trading mission. Everyone involved has profited. I have written to my wife that I am doing honourable work, building connections between our great nations. She worries unnecessarily. I sleep very well at night, though I have taken to keeping my cabin door locked, as some of the crew have become oddly quiet around me."
    ],
    modelEvidence: [
      {
        text: "my translator seemed uneasy and would not meet my eye",
        explanation: "The translator's discomfort is noted but immediately dismissed. A translator would understand the true nature of the negotiations \u2014 their unease is a crucial signal that the narrator ignores."
      },
      {
        text: "It was a fair exchange, as it always is",
        explanation: "Glass beads and cloth for 'excellent provisions' and later human labour \u2014 this was the deeply exploitative trade that characterised colonialism. The narrator insists on fairness without examining the power imbalance."
      },
      {
        text: "The chief has agreed to provide workers for the coastal warehouses",
        explanation: "The euphemism 'workers' and 'coastal warehouses' conceals what is almost certainly the slave trade. The narrator uses sanitised language to mask the reality of what he is arranging."
      },
      {
        text: "My translator spoke for a long time with the chief, far longer than my simple message required",
        explanation: "The translator likely had to convey \u2014 or negotiate around \u2014 a much darker reality than the narrator admits. The length of conversation suggests complexity, warnings, or resistance the narrator refuses to acknowledge."
      },
      {
        text: "Some of the younger men in the village watched us from a distance with expressions I could not read. Curiosity, most likely",
        explanation: "The narrator interprets hostility or fear as 'curiosity,' projecting innocence onto a situation that clearly involves tension and resistance."
      },
      {
        text: "Several families attempted to leave the village during the night",
        explanation: "People fleeing in the night is a sign of desperation, not a 'minor delay.' This detail alone reveals the coercive nature of the 'agreement' the narrator has brokered."
      },
      {
        text: "clearly this was an internal matter and nothing to do with our arrangements",
        explanation: "The narrator denies any connection between families fleeing and his trading deal, but the timing makes the cause obvious. This is deliberate self-deception."
      },
      {
        text: "The translator has asked to be released from his contract. I refused",
        explanation: "The translator wants to leave \u2014 another person trying to distance themselves from the narrator's activities. Rather than reflect on why, the narrator dismisses it as 'dramatics.'"
      },
      {
        text: "The workers have been loaded aboard",
        explanation: "People do not get 'loaded' \u2014 cargo does. The dehumanising language slips through despite the narrator's careful framing, revealing the true nature of this 'trade.'"
      },
      {
        text: "I sleep very well at night, though I have taken to keeping my cabin door locked",
        explanation: "A direct contradiction: someone who sleeps 'very well' does not lock their door out of fear. Even his crew's silence suggests moral judgement the narrator cannot face."
      }
    ],
    idealRating: 1
  },
  {
    id: 3,
    title: "Best Friends Forever",
    tabLabel: "Case #3: Best Friends",
    context: "A social media post by a teenager called Jordan, written the day after their best friend Priya stopped speaking to them.",
    paragraphs: [
      "I literally have no idea why Priya isn't talking to me. We've been best friends since Year 7, and I have always been there for her. Like when she didn't get into the school play, I told her it was probably because the drama teacher plays favourites, which made her feel loads better. And when she got that terrible haircut, I was the only one honest enough to tell her. Other people just let their friends walk around looking ridiculous. I care too much to do that.",
      "Last week was her birthday party, and okay, I did turn up a bit late because I was at Megan's house first. But it's not like I missed the whole thing. I got there before the cake, which is the part that actually matters. Priya seemed quiet when I arrived, but she's always been a bit moody and oversensitive. I gave her the present I'd got \u2014 a really nice journal, the exact same one I have, because mine is perfect so obviously she'd love it too.",
      "During the party I was just trying to make everyone have a good time. I told a few funny stories, and yes, some of them were about Priya, but they were hilarious and everyone was laughing. I mentioned the time she tripped in the corridor and the time she accidentally called the teacher 'Mum.' Those are classic stories. If she can't laugh at herself, that's her problem, not mine. I am always building her up. Just last month I told her she was 'actually pretty smart for someone who doesn't try very hard,' which is a genuine compliment.",
      "Now she's apparently told people I'm a bad friend, which is honestly really hurtful. I have screenshots of every nice message I've ever sent her, so I have literal proof that I'm a good friend. I think Megan has been turning her against me because Megan has always been jealous of how close Priya and I are. I texted Priya fourteen times yesterday and she hasn't replied to a single one, which just shows how immature she's being. When she finally comes to her senses, I'll forgive her, because that's the kind of friend I am."
    ],
    modelEvidence: [
      {
        text: "I told her it was probably because the drama teacher plays favourites",
        explanation: "Rather than genuinely consoling Priya, Jordan encourages bitterness. A supportive friend would help someone process disappointment, not feed conspiracy thinking."
      },
      {
        text: "when she got that terrible haircut, I was the only one honest enough to tell her",
        explanation: "Jordan frames cruelty as 'honesty.' Being the 'only one' to criticise doesn't make you brave \u2014 it often means you're the only one being unkind."
      },
      {
        text: "I did turn up a bit late because I was at Megan's house first",
        explanation: "Jordan went to someone else's house before Priya's birthday party, suggesting Priya is not actually the priority Jordan claims. The casual admission contradicts the 'best friend' framing."
      },
      {
        text: "she's always been a bit moody and oversensitive",
        explanation: "Labelling someone 'oversensitive' is a way to avoid taking their feelings seriously. Jordan uses this to dismiss Priya's valid emotional reaction to being treated as secondary."
      },
      {
        text: "the exact same one I have, because mine is perfect so obviously she'd love it too",
        explanation: "The gift wasn't chosen with Priya's interests in mind \u2014 it was chosen based on Jordan's. This reveals a self-centred approach to the friendship disguised as generosity."
      },
      {
        text: "some of them were about Priya, but they were hilarious and everyone was laughing",
        explanation: "Telling embarrassing stories about someone at their own birthday party, then using others' laughter as justification, is a pattern of humiliation dressed up as humour."
      },
      {
        text: "actually pretty smart for someone who doesn't try very hard",
        explanation: "This is a backhanded compliment \u2014 it gives with one hand and takes with the other. Jordan genuinely believes this is kind, revealing how unaware they are of their own behaviour."
      },
      {
        text: "I have screenshots of every nice message I've ever sent her, so I have literal proof",
        explanation: "Keeping 'proof' of being a good friend is deeply unusual and controlling. Genuine friendships don't require an evidence file. This suggests Jordan is more concerned with winning arguments than being caring."
      },
      {
        text: "I texted Priya fourteen times yesterday and she hasn't replied",
        explanation: "Fourteen unanswered texts is not persistence \u2014 it is a refusal to respect boundaries. Jordan frames Priya's silence as immaturity rather than recognising it as Priya setting a boundary."
      },
      {
        text: "When she finally comes to her senses, I'll forgive her",
        explanation: "Jordan concludes by positioning themselves as the generous one who will 'forgive' the wronged party. This perfect inversion of reality is the hallmark of the unreliable narrator."
      }
    ],
    idealRating: 2
  }
];

// ═══════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════
let currentStory = null;
let highlights = []; // {id, text, type, note, paraIdx, startOff, endOff}
let connections = []; // {from: id, to: id}
let connectingFrom = null;
let cardPositions = {}; // {hlId: {x, y}}
let hlIdCounter = 0;
let pendingRange = null;
let pendingNoteId = null;

// ═══════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  buildStoryTabs();
  setupSelectionListener();
  setupRatingSlider();
  window.addEventListener('resize', () => { resizeCanvas(); drawConnections(); });
});

function buildStoryTabs() {
  const container = document.getElementById('storyTabs');
  STORIES.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'story-btn';
    btn.textContent = s.tabLabel;
    btn.onclick = () => loadStory(s.id);
    btn.dataset.id = s.id;
    container.appendChild(btn);
  });
}

function loadStory(id) {
  currentStory = STORIES.find(s => s.id === id);
  if (!currentStory) return;

  // Reset analysis for this story
  highlights = [];
  connections = [];
  connectingFrom = null;
  cardPositions = {};
  hlIdCounter = 0;
  document.getElementById('ratingSlider').value = 5;
  document.getElementById('ratingValue').textContent = '5';
  document.getElementById('justification').value = '';
  updateRatingLabel(5);

  // Update tabs
  document.querySelectorAll('.story-btn').forEach(b => {
    b.classList.toggle('active', +b.dataset.id === id);
  });
  document.getElementById('fileTab').textContent = `CASE #${id}`;

  // Render text
  renderStoryText();
  renderEvidenceWall();
  updateStats();
}

function renderStoryText() {
  const body = document.getElementById('readingBody');
  let html = `<p class="story-title">${currentStory.title}</p>`;
  html += `<p class="story-context">${currentStory.context}</p>`;
  currentStory.paragraphs.forEach((p, idx) => {
    html += `<p data-para="${idx}">${applyHighlightsToText(p, idx)}</p>`;
  });
  body.innerHTML = html;

  // Re-attach click handlers for existing highlights
  body.querySelectorAll('mark').forEach(m => {
    m.addEventListener('click', e => {
      e.stopPropagation();
      const hlId = +m.dataset.hlid;
      openNoteModal(hlId);
    });
  });
}

function applyHighlightsToText(text, paraIdx) {
  const paraHL = highlights.filter(h => h.paraIdx === paraIdx)
    .sort((a, b) => a.startOff - b.startOff);
  if (paraHL.length === 0) return text;

  let result = '';
  let lastIdx = 0;
  paraHL.forEach(h => {
    if (h.startOff > lastIdx) result += text.substring(lastIdx, h.startOff);
    const label = h.type === 'suspicious' ? 'SUS' : 'OK';
    result += `<mark class="${h.type}" data-hlid="${h.id}"><span class="hl-badge">${label}</span>${text.substring(h.startOff, h.endOff)}</mark>`;
    lastIdx = h.endOff;
  });
  if (lastIdx < text.length) result += text.substring(lastIdx);
  return result;
}

// ═══════════════════════════════════════════
//  TEXT SELECTION & HIGHLIGHTING
// ═══════════════════════════════════════════
function setupSelectionListener() {
  document.addEventListener('mouseup', onMouseUp);
  document.addEventListener('touchend', onMouseUp);
}

function onMouseUp(e) {
  if (!currentStory) return;
  const toolbar = document.getElementById('hlToolbar');

  // If click is on toolbar, ignore
  if (toolbar.contains(e.target)) return;

  const sel = window.getSelection();
  if (!sel || sel.isCollapsed || !sel.rangeCount) {
    setTimeout(() => {
      if (!window.getSelection().toString().trim()) hideToolbar();
    }, 200);
    return;
  }

  const text = sel.toString().trim();
  if (text.length < 3) return;

  const range = sel.getRangeAt(0);
  const body = document.getElementById('readingBody');
  if (!body.contains(range.commonAncestorContainer)) return;

  pendingRange = { text, range: range.cloneRange() };

  // Find paragraph index and offsets
  let paraNode = range.startContainer;
  while (paraNode && paraNode.nodeName !== 'P') paraNode = paraNode.parentNode;
  if (!paraNode || !paraNode.dataset || paraNode.dataset.para === undefined) return;

  const paraIdx = +paraNode.dataset.para;
  const paraText = currentStory.paragraphs[paraIdx];

  // Find the selected text within the paragraph
  const idx = paraText.indexOf(text);
  if (idx === -1) {
    // Try finding a substring match
    const words = text.split(/\s+/);
    if (words.length < 2) return;
    const searchStr = words.slice(0, Math.min(5, words.length)).join(' ');
    const idx2 = paraText.indexOf(searchStr);
    if (idx2 === -1) return;
    pendingRange.paraIdx = paraIdx;
    pendingRange.startOff = idx2;
    pendingRange.endOff = Math.min(idx2 + text.length, paraText.length);
  } else {
    pendingRange.paraIdx = paraIdx;
    pendingRange.startOff = idx;
    pendingRange.endOff = idx + text.length;
  }

  // Check for overlap with existing highlights
  const overlaps = highlights.some(h =>
    h.paraIdx === paraIdx &&
    pendingRange.startOff < h.endOff && pendingRange.endOff > h.startOff
  );
  if (overlaps) {
    pendingRange = null;
    return;
  }

  // Show toolbar near selection
  const rect = range.getBoundingClientRect();
  toolbar.style.top = (rect.top - 50 + window.scrollY) + 'px';
  toolbar.style.left = Math.max(8, Math.min(rect.left + rect.width / 2 - 100, window.innerWidth - 250)) + 'px';
  toolbar.classList.add('show');
}

function hideToolbar() {
  document.getElementById('hlToolbar').classList.remove('show');
  pendingRange = null;
}

function applyHighlight(type) {
  if (!pendingRange) return;
  const hl = {
    id: ++hlIdCounter,
    text: pendingRange.text,
    type,
    note: '',
    paraIdx: pendingRange.paraIdx,
    startOff: pendingRange.startOff,
    endOff: pendingRange.endOff
  };
  highlights.push(hl);
  hideToolbar();
  window.getSelection().removeAllRanges();

  renderStoryText();
  renderEvidenceWall();
  updateStats();

  // Open note modal
  openNoteModal(hl.id);
}

// ═══════════════════════════════════════════
//  NOTE MODAL
// ═══════════════════════════════════════════
function openNoteModal(hlId) {
  const hl = highlights.find(h => h.id === hlId);
  if (!hl) return;
  pendingNoteId = hlId;
  document.getElementById('noteQuote').textContent = hl.text;
  document.getElementById('noteText').value = hl.note || '';
  document.getElementById('noteModal').classList.add('show');
  setTimeout(() => document.getElementById('noteText').focus(), 100);
}

function saveNote() {
  if (pendingNoteId == null) return;
  const hl = highlights.find(h => h.id === pendingNoteId);
  if (hl) hl.note = document.getElementById('noteText').value.trim();
  closeNoteModal();
  renderEvidenceWall();
}

function closeNoteModal() {
  document.getElementById('noteModal').classList.remove('show');
  pendingNoteId = null;
}

// ═══════════════════════════════════════════
//  EVIDENCE WALL
// ═══════════════════════════════════════════
function renderEvidenceWall() {
  const wall = document.getElementById('evidenceWall');
  const noEv = document.getElementById('noEvidence');

  // Remove old cards
  wall.querySelectorAll('.ev-card').forEach(c => c.remove());

  if (highlights.length === 0) {
    noEv.style.display = 'block';
    document.getElementById('cardCount').textContent = '0 items';
    resizeCanvas();
    drawConnections();
    return;
  }
  noEv.style.display = 'none';
  document.getElementById('cardCount').textContent = highlights.length + ' item' + (highlights.length !== 1 ? 's' : '');

  const wallRect = wall.getBoundingClientRect();
  const wallW = wall.scrollWidth || wallRect.width;

  highlights.forEach((hl, i) => {
    if (!cardPositions[hl.id]) {
      const cols = Math.max(1, Math.floor((wallW - 40) / 240));
      const col = i % cols;
      const row = Math.floor(i / cols);
      cardPositions[hl.id] = {
        x: 20 + col * 240 + (Math.random() * 10 - 5),
        y: 20 + row * 200 + (Math.random() * 10 - 5)
      };
    }

    const card = document.createElement('div');
    card.className = `ev-card ${hl.type}`;
    card.dataset.hlid = hl.id;
    card.style.left = cardPositions[hl.id].x + 'px';
    card.style.top = cardPositions[hl.id].y + 'px';
    card.style.setProperty('--rot', ((Math.random() * 4 - 2)).toFixed(1) + 'deg');

    card.innerHTML = `
      <div class="pin"></div>
      <div class="card-type">${hl.type}</div>
      <div class="card-quote">${hl.text}</div>
      <div class="card-note">${hl.note ? hl.note : '<em>Click to add note...</em>'}</div>
      <div class="card-actions">
        <button onclick="openNoteModal(${hl.id})" title="Edit note">&#9998; Note</button>
        <button class="connect-btn" data-hlid="${hl.id}" onclick="startConnect(${hl.id}, this)" title="Draw connection">&#128279; Link</button>
        <button onclick="removeHighlight(${hl.id})" title="Remove">&#10005;</button>
      </div>
    `;

    // Drag
    makeDraggable(card, hl.id);
    wall.appendChild(card);
  });

  resizeCanvas();
  drawConnections();
}

function makeDraggable(card, hlId) {
  let startX, startY, origX, origY;
  const onDown = e => {
    if (e.target.closest('.card-actions')) return;
    e.preventDefault();
    card.classList.add('dragging');
    const ev = e.touches ? e.touches[0] : e;
    startX = ev.clientX; startY = ev.clientY;
    origX = cardPositions[hlId].x;
    origY = cardPositions[hlId].y;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    document.addEventListener('touchmove', onMove, { passive: false });
    document.addEventListener('touchend', onUp);
  };
  const onMove = e => {
    e.preventDefault();
    const ev = e.touches ? e.touches[0] : e;
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;
    cardPositions[hlId].x = Math.max(0, origX + dx);
    cardPositions[hlId].y = Math.max(0, origY + dy);
    card.style.left = cardPositions[hlId].x + 'px';
    card.style.top = cardPositions[hlId].y + 'px';
    drawConnections();
  };
  const onUp = () => {
    card.classList.remove('dragging');
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    document.removeEventListener('touchmove', onMove);
    document.removeEventListener('touchend', onUp);
    expandWallIfNeeded();
  };
  card.addEventListener('mousedown', onDown);
  card.addEventListener('touchstart', onDown, { passive: false });
}

function expandWallIfNeeded() {
  const wall = document.getElementById('evidenceWall');
  let maxY = 300;
  highlights.forEach(hl => {
    const pos = cardPositions[hl.id];
    if (pos && pos.y + 200 > maxY) maxY = pos.y + 200;
  });
  wall.style.minHeight = maxY + 'px';
  resizeCanvas();
  drawConnections();
}

function removeHighlight(hlId) {
  highlights = highlights.filter(h => h.id !== hlId);
  connections = connections.filter(c => c.from !== hlId && c.to !== hlId);
  delete cardPositions[hlId];
  if (connectingFrom === hlId) connectingFrom = null;
  renderStoryText();
  renderEvidenceWall();
  updateStats();
}

// ═══════════════════════════════════════════
//  CONNECTIONS
// ═══════════════════════════════════════════
function startConnect(hlId, btn) {
  if (connectingFrom === hlId) {
    connectingFrom = null;
    document.querySelectorAll('.connect-btn').forEach(b => b.classList.remove('active'));
    return;
  }
  if (connectingFrom !== null) {
    // Create connection
    const exists = connections.some(c =>
      (c.from === connectingFrom && c.to === hlId) ||
      (c.from === hlId && c.to === connectingFrom)
    );
    if (!exists && connectingFrom !== hlId) {
      connections.push({ from: connectingFrom, to: hlId });
    }
    connectingFrom = null;
    document.querySelectorAll('.connect-btn').forEach(b => b.classList.remove('active'));
    drawConnections();
    return;
  }
  connectingFrom = hlId;
  document.querySelectorAll('.connect-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function resizeCanvas() {
  const wall = document.getElementById('evidenceWall');
  const canvas = document.getElementById('connectionCanvas');
  canvas.width = wall.scrollWidth;
  canvas.height = wall.scrollHeight;
}

function drawConnections() {
  const canvas = document.getElementById('connectionCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  connections.forEach(conn => {
    const posA = cardPositions[conn.from];
    const posB = cardPositions[conn.to];
    if (!posA || !posB) return;

    const ax = posA.x + 110, ay = posA.y + 60;
    const bx = posB.x + 110, by = posB.y + 60;

    // Draw string
    ctx.save();
    ctx.strokeStyle = '#cc3333';
    ctx.lineWidth = 2;
    ctx.setLineDash([8, 4]);
    ctx.shadowColor = 'rgba(204,51,51,0.4)';
    ctx.shadowBlur = 6;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    // Slight curve
    const mx = (ax + bx) / 2, my = (ay + by) / 2 - 20;
    ctx.quadraticCurveTo(mx, my, bx, by);
    ctx.stroke();
    ctx.restore();

    // Draw pins at endpoints
    [{ x: ax, y: ay }, { x: bx, y: by }].forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
      ctx.fillStyle = '#cc3333';
      ctx.fill();
    });
  });
}

// ═══════════════════════════════════════════
//  RATING SLIDER
// ═══════════════════════════════════════════
function setupRatingSlider() {
  const slider = document.getElementById('ratingSlider');
  slider.addEventListener('input', () => {
    const v = +slider.value;
    document.getElementById('ratingValue').textContent = v;
    updateRatingLabel(v);
  });
}

function updateRatingLabel(v) {
  const labels = [
    '', 'Completely Unreliable', 'Highly Unreliable', 'Mostly Unreliable',
    'Fairly Unreliable', 'Somewhat Questionable', 'Somewhat Believable',
    'Fairly Reliable', 'Mostly Reliable', 'Highly Reliable', 'Completely Reliable'
  ];
  document.getElementById('ratingLabel').textContent = labels[v] || '';
}

function updateStats() {
  const sus = highlights.filter(h => h.type === 'suspicious').length;
  const trust = highlights.filter(h => h.type === 'trustworthy').length;
  document.getElementById('statsPreview').textContent =
    `Highlights: ${sus} suspicious, ${trust} trustworthy | Connections: ${connections.length}`;
}

// ═══════════════════════════════════════════
//  SUBMIT & SCORING
// ═══════════════════════════════════════════
function submitAnalysis() {
  if (!currentStory) {
    alert('Please select a case first!');
    return;
  }
  if (highlights.length === 0) {
    alert('You haven\'t highlighted any evidence yet! Select text in the story and tag it as suspicious or trustworthy.');
    return;
  }

  const model = currentStory.modelEvidence;
  const found = [];
  const missed = [];
  const bonus = [];

  // Check each model evidence against student highlights
  model.forEach(me => {
    const meNorm = normalise(me.text);
    const match = highlights.find(h => {
      const hNorm = normalise(h.text);
      return textOverlap(hNorm, meNorm) > 0.45;
    });
    if (match) {
      found.push({ model: me, student: match });
    } else {
      missed.push(me);
    }
  });

  // Check student highlights that don't match any model evidence (bonus)
  highlights.forEach(h => {
    if (h.type !== 'suspicious') return;
    const hNorm = normalise(h.text);
    const matched = model.some(me => textOverlap(hNorm, normalise(me.text)) > 0.45);
    if (!matched) {
      bonus.push(h);
    }
  });

  // Score
  const baseScore = (found.length / model.length) * 100;
  const bonusScore = Math.min(bonus.length * 5, 15);
  const ratingVal = +document.getElementById('ratingSlider').value;
  const idealRating = currentStory.idealRating;
  const ratingDiff = Math.abs(ratingVal - idealRating);
  const ratingScore = Math.max(0, 15 - ratingDiff * 3);
  const justText = document.getElementById('justification').value.trim();
  const justScore = justText.length > 30 ? 5 : justText.length > 10 ? 2 : 0;
  const connectionScore = Math.min(connections.length * 3, 10);

  const totalRaw = baseScore * 0.6 + bonusScore + ratingScore + justScore + connectionScore;
  const total = Math.min(100, Math.round(totalRaw));

  // Rank
  let rank, rankIcon;
  if (total >= 90) { rank = 'Chief Inspector'; rankIcon = '\u2605\u2605\u2605\u2605\u2605'; }
  else if (total >= 75) { rank = 'Inspector'; rankIcon = '\u2605\u2605\u2605\u2605'; }
  else if (total >= 55) { rank = 'Detective'; rankIcon = '\u2605\u2605\u2605'; }
  else if (total >= 35) { rank = 'Constable'; rankIcon = '\u2605\u2605'; }
  else { rank = 'Rookie'; rankIcon = '\u2605'; }

  // Build results HTML
  let html = `
    <button class="close-results" onclick="closeResults()">&times;</button>
    <h2>Case Analysis Report</h2>
    <span class="rank-badge">
      <span class="rank-icon">${rankIcon}</span>
      Rank: ${rank}
    </span>

    <div class="score-bar-wrap">
      <div class="score-bar-label">
        <span>Overall Score</span>
        <span id="scoreNum">0%</span>
      </div>
      <div class="score-bar">
        <div class="score-bar-fill" id="scoreFill" style="width:0%"></div>
      </div>
    </div>

    <div class="score-bar-wrap">
      <div class="score-bar-label">
        <span>Key Evidence Found</span>
        <span>${found.length} / ${model.length} (${Math.round(found.length / model.length * 100)}%)</span>
      </div>
      <div class="score-bar">
        <div class="score-bar-fill" style="width:${found.length / model.length * 100}%"></div>
      </div>
    </div>
  `;

  if (found.length > 0) {
    html += `<div class="results-section"><h3>Evidence Found</h3>`;
    found.forEach(f => {
      html += `<div class="evidence-item found">
        <div class="ev-quote">${f.model.text}</div>
        <div class="ev-explain">${f.model.explanation}</div>
      </div>`;
    });
    html += `</div>`;
  }

  if (bonus.length > 0) {
    html += `<div class="results-section"><h3>Bonus Findings (Extra Credit)</h3>`;
    bonus.forEach(b => {
      html += `<div class="evidence-item bonus">
        <div class="ev-quote">${b.text}</div>
        <div class="ev-explain">Your note: ${b.note || '(no note added)'}</div>
      </div>`;
    });
    html += `</div>`;
  }

  if (missed.length > 0) {
    html += `<div class="results-section"><h3>Evidence Missed</h3>`;
    missed.forEach(m => {
      html += `<div class="evidence-item missed">
        <div class="ev-quote">${m.text}</div>
        <div class="ev-explain">${m.explanation}</div>
      </div>`;
    });
    html += `</div>`;
  }

  // Rating analysis
  html += `<div class="results-section"><h3>Narrator Rating Analysis</h3>`;
  html += `<div class="evidence-item ${ratingDiff <= 1 ? 'found' : ratingDiff <= 3 ? 'bonus' : 'missed'}">`;
  html += `<div class="ev-quote">You rated: ${ratingVal}/10 | Model answer: ${idealRating}/10</div>`;
  if (ratingDiff <= 1) {
    html += `<div class="ev-explain">Excellent judgement! Your rating closely matches the model assessment.</div>`;
  } else if (ratingDiff <= 3) {
    html += `<div class="ev-explain">Close, but this narrator is ${idealRating <= 3 ? 'less' : 'more'} reliable than you judged. Look at the balance of evidence more carefully.</div>`;
  } else {
    html += `<div class="ev-explain">This narrator is significantly ${idealRating <= 3 ? 'less' : 'more'} reliable than you rated. Re-read the text looking for contradictions, self-serving language, and details that don't add up.</div>`;
  }
  html += `</div></div>`;

  // Score breakdown
  html += `<div class="results-section"><h3>Score Breakdown</h3>`;
  html += `<div class="evidence-item found" style="background:rgba(255,255,255,.05);border-left-color:var(--gold)">
    <div class="ev-explain" style="color:var(--text)">
      Evidence detection: ${Math.round(baseScore * 0.6)}pts |
      Bonus findings: +${bonusScore}pts |
      Rating accuracy: +${ratingScore}pts |
      Justification: +${justScore}pts |
      Connections: +${connectionScore}pts |
      <strong>Total: ${total}%</strong>
    </div>
  </div></div>`;

  document.getElementById('resultsCard').innerHTML = html;
  document.getElementById('resultsOverlay').classList.add('show');

  // Animate score
  setTimeout(() => {
    document.getElementById('scoreFill').style.width = total + '%';
    animateNumber('scoreNum', 0, total, 1200);
  }, 400);
}

function animateNumber(elId, from, to, duration) {
  const el = document.getElementById(elId);
  const start = performance.now();
  const step = ts => {
    const progress = Math.min((ts - start) / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(from + (to - from) * eased) + '%';
    if (progress < 1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

function closeResults() {
  document.getElementById('resultsOverlay').classList.remove('show');
}

function resetAnalysis() {
  if (!currentStory) return;
  if (!confirm('Reset all highlights and notes for this case?')) return;
  loadStory(currentStory.id);
}

// ═══════════════════════════════════════════
//  UTILITIES
// ═══════════════════════════════════════════
function normalise(str) {
  return str.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ').trim();
}

function textOverlap(a, b) {
  // Compute word-level Jaccard + containment hybrid
  const wordsA = new Set(a.split(' '));
  const wordsB = new Set(b.split(' '));
  let intersection = 0;
  wordsA.forEach(w => { if (wordsB.has(w)) intersection++; });
  const smaller = Math.min(wordsA.size, wordsB.size);
  if (smaller === 0) return 0;
  // Containment ratio (how much of the smaller set is in the larger)
  const containment = intersection / smaller;
  // Jaccard similarity
  const union = new Set([...wordsA, ...wordsB]).size;
  const jaccard = intersection / union;
  return Math.max(containment * 0.8, jaccard);
}

// Close modals on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeResults();
    closeNoteModal();
    hideToolbar();
  }
});

// Close results on overlay click
document.getElementById('resultsOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('resultsOverlay')) closeResults();
});
</script>
</body>
</html>
