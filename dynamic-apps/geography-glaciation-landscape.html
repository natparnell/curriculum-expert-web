<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glaciation Landscape Sculptor</title>
<style>
:root {
  --ice-deep: #1a3a4a;
  --ice-mid: #2c7a8e;
  --ice-light: #5ab4c4;
  --ice-pale: #b8e0e8;
  --sky-light: #daeef3;
  --sky-top: #a8d8e8;
  --rock-dark: #4a3728;
  --rock-mid: #6b5240;
  --rock-light: #8d7460;
  --earth-warm: #a0845c;
  --earth-green: #5a7a4a;
  --moraine-brown: #7a6344;
  --moraine-light: #9e8a6c;
  --snow-white: #f0f6f8;
  --text-primary: #1b2631;
  --text-secondary: #2c3e50;
  --text-light: #f8f9fa;
  --panel-bg: #fdfefe;
  --panel-border: #d0dde0;
  --accent: #2c7a8e;
  --accent-hover: #1e5a6a;
  --success: #27ae60;
  --danger: #c0392b;
  --warning: #d4880f;
  --label-bg: rgba(26, 58, 74, 0.92);
  --shadow: 0 2px 8px rgba(0,0,0,0.12);
  --radius: 8px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--sky-light);
  color: var(--text-primary);
  min-height: 100vh;
}

header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(135deg, var(--ice-deep), var(--ice-mid));
  color: var(--text-light);
  padding: 14px 24px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.2);
}

header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: 0.3px;
}

header p {
  font-size: 0.85rem;
  opacity: 0.85;
  margin-top: 2px;
}

.app-layout {
  max-width: 1280px;
  margin: 0 auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.canvas-wrapper {
  position: relative;
  background: var(--panel-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  border: 1px solid var(--panel-border);
}

canvas {
  display: block;
  width: 100%;
  height: auto;
}

.controls-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: stretch;
}

.control-panel {
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: var(--radius);
  padding: 14px 18px;
  box-shadow: var(--shadow);
  flex: 1;
  min-width: 200px;
}

.control-panel h3 {
  font-size: 0.82rem;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--ice-deep);
  margin-bottom: 10px;
  border-bottom: 2px solid var(--ice-light);
  padding-bottom: 6px;
}

.btn-group {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.btn {
  padding: 7px 16px;
  border: none;
  border-radius: 5px;
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-play { background: var(--success); color: white; }
.btn-play:hover { background: #219a52; }
.btn-pause { background: var(--warning); color: white; }
.btn-pause:hover { background: #b8760c; }
.btn-reset { background: var(--danger); color: white; }
.btn-reset:hover { background: #a93226; }
.btn-toggle { background: var(--accent); color: white; }
.btn-toggle:hover { background: var(--accent-hover); }
.btn-toggle.active { background: var(--ice-deep); }

.slider-group {
  margin-top: 10px;
}

.slider-group label {
  display: flex;
  justify-content: space-between;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.slider-group input[type="range"] {
  width: 100%;
  accent-color: var(--ice-mid);
}

.stats-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.stat-card {
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: var(--radius);
  padding: 12px 16px;
  box-shadow: var(--shadow);
  flex: 1;
  min-width: 150px;
  text-align: center;
}

.stat-card .stat-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--ice-mid);
  font-weight: 700;
}

.stat-card .stat-value {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--ice-deep);
  margin-top: 2px;
}

.stat-card .stat-unit {
  font-size: 0.72rem;
  color: var(--text-secondary);
}

.process-indicators {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.process-tag {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.74rem;
  font-weight: 600;
  background: var(--sky-light);
  color: var(--text-secondary);
  border: 1px solid var(--panel-border);
  transition: all 0.3s;
}

.process-tag.active {
  background: var(--ice-mid);
  color: white;
  border-color: var(--ice-mid);
}

.process-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--panel-border);
  transition: background 0.3s;
}

.process-tag.active .process-dot {
  background: #7dffb3;
}

.legend-row {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  padding: 10px 16px;
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.76rem;
  font-weight: 600;
  color: var(--text-secondary);
}

.legend-swatch {
  width: 16px;
  height: 12px;
  border-radius: 3px;
  border: 1px solid rgba(0,0,0,0.15);
}

.info-panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.info-panel {
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: var(--radius);
  padding: 16px 20px;
  box-shadow: var(--shadow);
}

.info-panel h3 {
  font-size: 0.88rem;
  color: var(--ice-deep);
  margin-bottom: 10px;
  border-bottom: 2px solid var(--ice-light);
  padding-bottom: 6px;
}

.info-panel h4 {
  font-size: 0.82rem;
  color: var(--ice-mid);
  margin: 10px 0 4px;
}

.info-panel p, .info-panel li {
  font-size: 0.8rem;
  line-height: 1.55;
  color: var(--text-secondary);
}

.info-panel ul {
  padding-left: 18px;
  margin-top: 4px;
}

.info-panel li {
  margin-bottom: 3px;
}

.example-tag {
  display: inline-block;
  background: var(--ice-pale);
  color: var(--ice-deep);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.74rem;
  font-weight: 600;
  margin: 2px 2px 2px 0;
}

.view-tabs {
  display: flex;
  gap: 4px;
  margin-top: 8px;
}

.view-tab {
  padding: 6px 14px;
  border: 2px solid var(--ice-mid);
  border-radius: 5px;
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
  background: transparent;
  color: var(--ice-mid);
  transition: all 0.2s;
}

.view-tab.active {
  background: var(--ice-mid);
  color: white;
}

.view-tab:hover:not(.active) {
  background: var(--ice-pale);
}

@media (max-width: 768px) {
  header { padding: 12px 16px; }
  header h1 { font-size: 1.2rem; }
  .app-layout { padding: 10px; gap: 10px; }
  .controls-row { flex-direction: column; }
  .control-panel { min-width: unset; }
  .stats-row { flex-direction: column; }
  .stat-card { min-width: unset; }
  .info-panels { grid-template-columns: 1fr; }
  .legend-row { flex-wrap: wrap; gap: 8px; }
}
</style>
</head>
<body>

<header>
  <h1>Glaciation Landscape Sculptor</h1>
  <p>Control a glacier's advance and retreat to carve corries, aretes, U-shaped valleys, and moraines</p>
</header>

<div class="app-layout">

  <div class="controls-row">
    <div class="control-panel">
      <h3>Playback</h3>
      <div class="btn-group">
        <button class="btn btn-play" id="btnPlay" onclick="togglePlay()">&#9654; Play</button>
        <button class="btn btn-reset" onclick="resetSim()">&#8634; Reset</button>
      </div>
      <div class="slider-group" style="margin-top:12px">
        <label><span>Speed</span><span id="speedVal">1x</span></label>
        <input type="range" id="speedSlider" min="1" max="5" value="1" step="1" oninput="updateSpeed()">
      </div>
    </div>
    <div class="control-panel">
      <h3>Temperature</h3>
      <div class="slider-group">
        <label><span>Global Temperature</span><span id="tempVal">-8&#176;C</span></label>
        <input type="range" id="tempSlider" min="-20" max="10" value="-8" step="1" oninput="updateTemp()">
      </div>
      <p style="font-size:0.74rem;color:var(--text-secondary);margin-top:6px">
        Lower temperatures cause glacier advance; higher temperatures cause retreat.
      </p>
    </div>
    <div class="control-panel">
      <h3>View Mode</h3>
      <div class="view-tabs">
        <button class="view-tab active" id="tabAnim" onclick="setView('animation')">Animation</button>
        <button class="view-tab" id="tabBefore" onclick="setView('before')">Before (V-shape)</button>
        <button class="view-tab" id="tabAfter" onclick="setView('after')">After (U-shape)</button>
      </div>
    </div>
  </div>

  <div class="canvas-wrapper">
    <canvas id="mainCanvas" width="1200" height="520"></canvas>
  </div>

  <div class="legend-row">
    <div class="legend-item"><div class="legend-swatch" style="background:#6b8fc7"></div>Glacier ice</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#e8e4df"></div>Snow/firn</div>
    <div class="legend-item"><div class="legend-swatch" style="background:var(--rock-mid)"></div>Bedrock</div>
    <div class="legend-item"><div class="legend-swatch" style="background:var(--moraine-brown)"></div>Moraine</div>
    <div class="legend-item"><div class="legend-swatch" style="background:var(--earth-green)"></div>Vegetation</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#4a90c4"></div>Meltwater</div>
  </div>

  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">Geological Time</div>
      <div class="stat-value" id="statTime">0</div>
      <div class="stat-unit">thousand years</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Glacier Length</div>
      <div class="stat-value" id="statLength">0</div>
      <div class="stat-unit">metres</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Ice Thickness</div>
      <div class="stat-value" id="statThickness">0</div>
      <div class="stat-unit">metres</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Erosion Depth</div>
      <div class="stat-value" id="statErosion">0</div>
      <div class="stat-unit">metres</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Phase</div>
      <div class="stat-value" id="statPhase" style="font-size:1rem">Idle</div>
      <div class="stat-unit">&nbsp;</div>
    </div>
  </div>

  <div class="controls-row">
    <div class="control-panel">
      <h3>Active Processes</h3>
      <div class="process-indicators">
        <span class="process-tag" id="procPlucking"><span class="process-dot"></span>Plucking</span>
        <span class="process-tag" id="procAbrasion"><span class="process-dot"></span>Abrasion</span>
        <span class="process-tag" id="procFreezeThaw"><span class="process-dot"></span>Freeze-thaw</span>
        <span class="process-tag" id="procRotational"><span class="process-dot"></span>Rotational slip</span>
        <span class="process-tag" id="procDeposition"><span class="process-dot"></span>Deposition</span>
      </div>
    </div>
    <div class="control-panel">
      <h3>Formed Landforms</h3>
      <div class="process-indicators" id="landformTags">
        <span class="process-tag" id="lfCorrie"><span class="process-dot"></span>Corrie</span>
        <span class="process-tag" id="lfArete"><span class="process-dot"></span>Arete</span>
        <span class="process-tag" id="lfUValley"><span class="process-dot"></span>U-shaped valley</span>
        <span class="process-tag" id="lfTruncSpur"><span class="process-dot"></span>Truncated spur</span>
        <span class="process-tag" id="lfHangVal"><span class="process-dot"></span>Hanging valley</span>
        <span class="process-tag" id="lfTermMoraine"><span class="process-dot"></span>Terminal moraine</span>
        <span class="process-tag" id="lfLatMoraine"><span class="process-dot"></span>Lateral moraine</span>
        <span class="process-tag" id="lfMedMoraine"><span class="process-dot"></span>Medial moraine</span>
      </div>
    </div>
  </div>

  <div class="info-panels">
    <div class="info-panel">
      <h3>Erosion Processes</h3>
      <h4>Plucking</h4>
      <p>Meltwater at the base of the glacier seeps into cracks in the bedrock and refreezes. As the glacier moves, it tears away chunks of rock, leaving a rough, jagged surface behind.</p>
      <h4>Abrasion</h4>
      <p>Rocks and debris frozen into the base of the glacier scrape across the bedrock like sandpaper, smoothing and scratching the valley floor. This creates striations (grooves) in the rock surface.</p>
      <h4>Freeze-thaw Weathering</h4>
      <p>Water enters cracks in exposed rock above the glacier. It freezes, expands by roughly 9%, and widens the crack. Repeated cycles shatter the rock, producing angular fragments that fall onto the glacier surface.</p>
      <h4>Rotational Slip</h4>
      <p>In the corrie (cirque), the glacier moves in a circular motion, deepening the hollow. The weight of accumulated ice causes it to rotate, scooping out the basin and creating a steep back wall.</p>
    </div>
    <div class="info-panel">
      <h3>Landforms</h3>
      <h4>Corrie (Cirque)</h4>
      <p>An armchair-shaped hollow on a mountainside where snow accumulates and compresses into ice. The glacier erodes the hollow through rotational slip, plucking, and abrasion.</p>
      <span class="example-tag">Red Tarn, Lake District</span>
      <span class="example-tag">Cwm Idwal, Snowdonia</span>
      <h4>Arete</h4>
      <p>A narrow, knife-edge ridge formed when two corries erode back-to-back on either side of a mountain.</p>
      <span class="example-tag">Striding Edge, Helvellyn</span>
      <span class="example-tag">Crib Goch, Snowdonia</span>
      <h4>U-shaped Valley</h4>
      <p>A valley with steep sides and a wide, flat floor, carved by a glacier as it moves downhill. Originally a V-shaped river valley, the glacier straightens, widens, and deepens it.</p>
      <span class="example-tag">Great Langdale, Lake District</span>
      <h4>Moraines</h4>
      <p>Deposits of rock debris carried and left behind by a glacier. Lateral moraines form along the sides; medial moraines where two glaciers merge; terminal moraines mark the furthest advance.</p>
      <span class="example-tag">Llyn Idwal terminal moraine</span>
    </div>
    <div class="info-panel">
      <h3>Deposition Features</h3>
      <h4>Terminal Moraine</h4>
      <p>A ridge of unsorted material (till) deposited at the snout of the glacier, marking its maximum advance. These crescent-shaped ridges often dam water to form ribbon lakes.</p>
      <h4>Lateral Moraine</h4>
      <p>Material carried along the edges of a glacier, deposited as long ridges when the ice melts. Formed from freeze-thaw debris falling from the valley sides onto the glacier surface.</p>
      <h4>Medial Moraine</h4>
      <p>A line of debris running along the centre of a glacier, formed where two lateral moraines merge when tributary glaciers join. Visible as a dark stripe on the ice surface.</p>
      <h4>Erratics</h4>
      <p>Large boulders transported by a glacier and deposited in an area of different rock type, providing evidence of past glacial movement and direction.</p>
      <span class="example-tag">Norber Erratics, Yorkshire Dales</span>
    </div>
    <div class="info-panel">
      <h3>UK Case Studies</h3>
      <h4>Lake District, Cumbria</h4>
      <p>England's most dramatic glaciated landscape. Features include corries (Red Tarn below Helvellyn), aretes (Striding Edge), ribbon lakes (Windermere, Ullswater), and U-shaped valleys (Borrowdale, Great Langdale).</p>
      <h4>Snowdonia, North Wales</h4>
      <p>Cwm Idwal is a textbook corrie with a terminal moraine damming Llyn Idwal. Crib Goch provides a famous example of an arete. The Nant Ffrancon valley shows a classic U-shaped profile.</p>
      <h4>Scottish Highlands</h4>
      <p>Glen Coe is one of the finest examples of a glacial trough in the UK. Ben Nevis features large north-facing corries. The Cairngorms show evidence of extensive ice sheet glaciation during the last ice age.</p>
      <h4>Evidence of Past Glaciation</h4>
      <ul>
        <li>Striations on exposed bedrock (scratches from abrasion)</li>
        <li>Erratics (transported boulders of foreign rock)</li>
        <li>Till deposits (unsorted glacial sediment)</li>
        <li>Roches moutonnees (smooth upstream, rough downstream faces)</li>
      </ul>
    </div>
  </div>

</div>

<script>
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const W = 1200, H = 520;

let playing = false;
let speed = 1;
let temperature = -8;
let viewMode = 'animation';
let time = 0;
let animFrame = null;

/* Simulation state */
let glacier = {
  length: 0,
  maxLength: 800,
  thickness: 0,
  maxThickness: 180,
  erosionDepth: 0,
  maxErosion: 120,
  retreating: false,
  snoutX: 200,
  moraineDeposited: 0,
  terminalMoraineX: 0,
  terminalMoraineH: 0,
  phase: 'Idle'
};

/* Valley profile: array of y-values representing the valley cross-section that evolves */
const VALLEY_RES = 120;
let valleyProfile = [];
let originalProfile = [];
let targetUProfile = [];

function initProfiles() {
  valleyProfile = [];
  originalProfile = [];
  targetUProfile = [];
  for (let i = 0; i < VALLEY_RES; i++) {
    const t = i / (VALLEY_RES - 1);
    /* V-shape: steep sides meeting at a point */
    const vY = Math.abs(t - 0.5) * 2;
    const vHeight = 100 + vY * 220;
    originalProfile.push(vHeight);
    valleyProfile.push(vHeight);
    /* U-shape: flat floor with steep sides */
    const uT = (t - 0.5) * 2;
    const uHeight = 100 + Math.pow(Math.abs(uT), 2.8) * 240;
    targetUProfile.push(uHeight);
  }
}

initProfiles();

function resetSim() {
  playing = false;
  time = 0;
  speed = 1;
  temperature = -8;
  document.getElementById('tempSlider').value = -8;
  document.getElementById('speedSlider').value = 1;
  document.getElementById('btnPlay').innerHTML = '&#9654; Play';
  document.getElementById('btnPlay').className = 'btn btn-play';
  updateTemp();
  updateSpeed();
  glacier = {
    length: 0, maxLength: 800, thickness: 0, maxThickness: 180,
    erosionDepth: 0, maxErosion: 120, retreating: false, snoutX: 200,
    moraineDeposited: 0, terminalMoraineX: 0, terminalMoraineH: 0, phase: 'Idle'
  };
  initProfiles();
  updateProcesses();
  updateLandforms();
  updateStats();
  if (animFrame) cancelAnimationFrame(animFrame);
  draw();
}

function togglePlay() {
  playing = !playing;
  const btn = document.getElementById('btnPlay');
  if (playing) {
    btn.innerHTML = '&#10074;&#10074; Pause';
    btn.className = 'btn btn-pause';
    if (!animFrame) tick();
  } else {
    btn.innerHTML = '&#9654; Play';
    btn.className = 'btn btn-play';
  }
}

function updateSpeed() {
  speed = parseInt(document.getElementById('speedSlider').value);
  document.getElementById('speedVal').textContent = speed + 'x';
}

function updateTemp() {
  temperature = parseInt(document.getElementById('tempSlider').value);
  document.getElementById('tempVal').innerHTML = temperature + '&#176;C';
}

function setView(mode) {
  viewMode = mode;
  document.getElementById('tabAnim').className = 'view-tab' + (mode === 'animation' ? ' active' : '');
  document.getElementById('tabBefore').className = 'view-tab' + (mode === 'before' ? ' active' : '');
  document.getElementById('tabAfter').className = 'view-tab' + (mode === 'after' ? ' active' : '');
  draw();
}

/* Simulation tick */
function tick() {
  if (playing) {
    const dt = speed * 0.016;
    time += dt * 2.5;

    const advanceRate = temperature < 0 ? Math.abs(temperature) / 20 : 0;
    const retreatRate = temperature > 0 ? temperature / 10 : 0;
    const meltFactor = temperature >= 0 ? 1 + temperature / 15 : 0;

    if (temperature < 0) {
      glacier.phase = 'Advancing';
      glacier.retreating = false;
      glacier.length = Math.min(glacier.maxLength, glacier.length + advanceRate * dt * 60);
      glacier.thickness = Math.min(glacier.maxThickness, glacier.thickness + advanceRate * dt * 30);

      /* Erode valley profile towards U-shape */
      const erosionRate = (glacier.thickness / glacier.maxThickness) * dt * 0.8;
      for (let i = 0; i < VALLEY_RES; i++) {
        const glacierCoverage = glacier.length / glacier.maxLength;
        const t = i / (VALLEY_RES - 1);
        const centreDist = Math.abs(t - 0.5) * 2;
        if (centreDist < 0.4 + glacierCoverage * 0.3) {
          const diff = valleyProfile[i] - targetUProfile[i];
          if (diff > 0) {
            valleyProfile[i] -= diff * erosionRate * (1 - centreDist * 0.5);
          }
        }
      }
      glacier.erosionDepth = Math.min(glacier.maxErosion,
        glacier.erosionDepth + erosionRate * 2);
      glacier.snoutX = 200 + glacier.length;
    } else if (temperature > 0) {
      glacier.phase = glacier.length > 10 ? 'Retreating' : 'Melted';
      glacier.retreating = true;

      /* Deposit terminal moraine at furthest extent */
      if (glacier.length > 10 && glacier.terminalMoraineX < glacier.snoutX) {
        glacier.terminalMoraineX = glacier.snoutX;
        glacier.terminalMoraineH = Math.min(30, glacier.moraineDeposited + 8);
      }

      glacier.length = Math.max(0, glacier.length - retreatRate * dt * 80);
      glacier.thickness = Math.max(0, glacier.thickness - meltFactor * dt * 25);
      glacier.moraineDeposited = Math.min(40, glacier.moraineDeposited + retreatRate * dt * 5);
      glacier.snoutX = 200 + glacier.length;

      if (glacier.length <= 0) {
        glacier.length = 0;
        glacier.thickness = 0;
      }
    } else {
      glacier.phase = glacier.length > 0 ? 'Stable' : 'Idle';
    }

    updateProcesses();
    updateLandforms();
    updateStats();
  }

  draw();
  animFrame = requestAnimationFrame(tick);
}

function updateStats() {
  document.getElementById('statTime').textContent = Math.floor(time);
  document.getElementById('statLength').textContent = Math.floor(glacier.length * 3);
  document.getElementById('statThickness').textContent = Math.floor(glacier.thickness * 2);
  document.getElementById('statErosion').textContent = Math.floor(glacier.erosionDepth);
  document.getElementById('statPhase').textContent = glacier.phase;
}

function updateProcesses() {
  const advancing = glacier.length > 10 && !glacier.retreating;
  const hasIce = glacier.length > 10;
  setTag('procPlucking', advancing && glacier.thickness > 20);
  setTag('procAbrasion', advancing && glacier.thickness > 30);
  setTag('procFreezeThaw', hasIce);
  setTag('procRotational', advancing && glacier.erosionDepth > 15);
  setTag('procDeposition', glacier.retreating && glacier.length > 0);
}

function updateLandforms() {
  const e = glacier.erosionDepth;
  const hasMoraine = glacier.moraineDeposited > 5;
  setTag('lfCorrie', e > 15);
  setTag('lfArete', e > 30);
  setTag('lfUValley', e > 50);
  setTag('lfTruncSpur', e > 40);
  setTag('lfHangVal', e > 60);
  setTag('lfTermMoraine', glacier.terminalMoraineH > 5);
  setTag('lfLatMoraine', hasMoraine);
  setTag('lfMedMoraine', e > 45 && hasMoraine);
}

function setTag(id, active) {
  const el = document.getElementById(id);
  if (el) el.className = 'process-tag' + (active ? ' active' : '');
}

/* ======= DRAWING ======= */

function draw() {
  ctx.clearRect(0, 0, W, H);

  if (viewMode === 'before') {
    drawStaticValley(originalProfile, false);
    drawLabels('before');
  } else if (viewMode === 'after') {
    drawStaticValley(targetUProfile, true);
    drawLabels('after');
  } else {
    drawAnimatedScene();
  }
}

function drawSky() {
  const grad = ctx.createLinearGradient(0, 0, 0, 180);
  grad.addColorStop(0, '#8bbbd4');
  grad.addColorStop(1, '#c8e2ee');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, 180);
}

function drawMountains(profile, yOffset, showSnow) {
  const baseY = 320;
  /* Left mountain */
  ctx.beginPath();
  ctx.moveTo(0, baseY);
  for (let i = 0; i <= 30; i++) {
    const t = i / 30;
    const x = t * 200;
    const peakH = 250 + Math.sin(t * Math.PI) * 100;
    ctx.lineTo(x, baseY - peakH + yOffset);
  }
  ctx.lineTo(200, baseY);
  ctx.closePath();
  const lGrad = ctx.createLinearGradient(0, baseY - 340, 0, baseY);
  lGrad.addColorStop(0, '#5a4a38');
  lGrad.addColorStop(0.4, '#6b5a48');
  lGrad.addColorStop(1, '#4a6a3a');
  ctx.fillStyle = lGrad;
  ctx.fill();

  /* Right mountain */
  ctx.beginPath();
  ctx.moveTo(W, baseY);
  for (let i = 0; i <= 30; i++) {
    const t = i / 30;
    const x = W - t * 200;
    const peakH = 230 + Math.sin(t * Math.PI) * 90;
    ctx.lineTo(x, baseY - peakH + yOffset);
  }
  ctx.lineTo(W - 200, baseY);
  ctx.closePath();
  const rGrad = ctx.createLinearGradient(W, baseY - 310, W, baseY);
  rGrad.addColorStop(0, '#5a4a38');
  rGrad.addColorStop(0.4, '#6b5a48');
  rGrad.addColorStop(1, '#4a6a3a');
  ctx.fillStyle = rGrad;
  ctx.fill();

  /* Snow caps */
  if (showSnow) {
    ctx.fillStyle = 'rgba(240,246,248,0.7)';
    ctx.beginPath();
    ctx.moveTo(60, baseY - 300 + yOffset);
    ctx.lineTo(100, baseY - 340 + yOffset);
    ctx.lineTo(140, baseY - 295 + yOffset);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(W - 60, baseY - 280 + yOffset);
    ctx.lineTo(W - 100, baseY - 310 + yOffset);
    ctx.lineTo(W - 140, baseY - 275 + yOffset);
    ctx.closePath();
    ctx.fill();
  }
}

function drawValleyFromProfile(profile, baseY, fill) {
  ctx.beginPath();
  ctx.moveTo(200, baseY - 180);
  for (let i = 0; i < VALLEY_RES; i++) {
    const t = i / (VALLEY_RES - 1);
    const x = 200 + t * 800;
    const y = baseY - 180 + profile[i];
    ctx.lineTo(x, y);
  }
  ctx.lineTo(1000, baseY - 180);
  ctx.lineTo(1000, H + 20);
  ctx.lineTo(200, H + 20);
  ctx.closePath();
  ctx.fillStyle = fill;
  ctx.fill();
}

function drawValleySides(profile, baseY) {
  /* Draw rock texture on valley walls */
  const grad = ctx.createLinearGradient(200, baseY - 80, 200, H);
  grad.addColorStop(0, '#6b5a48');
  grad.addColorStop(0.3, '#7a6855');
  grad.addColorStop(0.7, '#5a4a38');
  grad.addColorStop(1, '#4a3a28');
  drawValleyFromProfile(profile, baseY, grad);

  /* Vegetation on upper slopes */
  ctx.save();
  ctx.globalAlpha = 0.35;
  for (let i = 0; i < VALLEY_RES; i += 3) {
    const t = i / (VALLEY_RES - 1);
    const x = 200 + t * 800;
    const y = baseY - 180 + profile[i];
    const centreDist = Math.abs(t - 0.5) * 2;
    if (centreDist > 0.35 && y < baseY + 60) {
      ctx.fillStyle = '#4a7a3a';
      ctx.fillRect(x - 3, y - 4, 6, 4);
    }
  }
  ctx.restore();
}

function drawStaticValley(profile, isAfter) {
  drawSky();
  const showSnow = isAfter;
  drawMountains(profile, 0, showSnow);

  const baseY = 320;
  drawValleySides(profile, baseY);

  /* River at bottom for V-shape, flat floor + lake for U-shape */
  if (!isAfter) {
    ctx.strokeStyle = '#4a90c4';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(580, baseY + 30);
    ctx.lineTo(620, baseY + 40);
    ctx.lineTo(660, baseY + 38);
    ctx.lineTo(700, baseY + 42);
    ctx.stroke();
  } else {
    /* Tarn/ribbon lake on U-shaped floor */
    const lakeGrad = ctx.createRadialGradient(600, baseY + 10, 10, 600, baseY + 10, 120);
    lakeGrad.addColorStop(0, '#3a7ab4');
    lakeGrad.addColorStop(1, '#5a9ad4');
    ctx.fillStyle = lakeGrad;
    ctx.beginPath();
    ctx.ellipse(600, baseY + 10, 100, 18, 0, 0, Math.PI * 2);
    ctx.fill();

    /* Terminal moraine ridge */
    ctx.fillStyle = '#7a6344';
    ctx.beginPath();
    ctx.moveTo(700, baseY + 20);
    ctx.quadraticCurveTo(730, baseY - 10, 760, baseY + 20);
    ctx.closePath();
    ctx.fill();
  }

  /* Valley floor fill */
  ctx.fillStyle = isAfter ? '#5a7a4a' : '#4a6a3a';
  ctx.fillRect(200, baseY + 80, 800, H - baseY - 80);
}

function drawLabels(mode) {
  ctx.font = 'bold 12px -apple-system, sans-serif';
  if (mode === 'before') {
    drawLabel('V-shaped valley', 600, 380);
    drawLabel('Interlocking spurs', 350, 300);
    drawLabel('River channel', 620, 355);
    drawLabel('Steep valley sides', 800, 280);
  } else {
    drawLabel('U-shaped valley', 600, 380);
    drawLabel('Steep back wall', 280, 260);
    drawLabel('Flat valley floor', 550, 345);
    drawLabel('Ribbon lake/tarn', 600, 325);
    drawLabel('Terminal moraine', 730, 310);
    drawLabel('Truncated spur', 850, 270);
    drawLabel('Hanging valley', 920, 240);
  }
}

function drawLabel(text, x, y) {
  ctx.font = 'bold 11px -apple-system, sans-serif';
  const m = ctx.measureText(text);
  const pw = m.width + 12;
  const ph = 20;
  ctx.fillStyle = 'rgba(26,58,74,0.9)';
  roundRect(ctx, x - pw / 2, y - ph / 2, pw, ph, 4);
  ctx.fill();
  ctx.fillStyle = '#f0f6f8';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, x, y);
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.arcTo(x + w, y, x + w, y + r, r);
  ctx.lineTo(x + w, y + h - r);
  ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
  ctx.lineTo(x + r, y + h);
  ctx.arcTo(x, y + h, x, y + h - r, r);
  ctx.lineTo(x, y + r);
  ctx.arcTo(x, y, x + r, y, r);
  ctx.closePath();
}

function drawAnimatedScene() {
  drawSky();

  const hasIce = glacier.length > 10;
  const snowCaps = hasIce || glacier.erosionDepth > 20;
  drawMountains(valleyProfile, 0, snowCaps);

  const baseY = 320;
  drawValleySides(valleyProfile, baseY);

  /* Draw glacier ice */
  if (hasIce) {
    drawGlacier(baseY);
  }

  /* Draw moraines */
  drawMoraines(baseY);

  /* Meltwater stream when retreating */
  if (glacier.retreating && glacier.length > 0) {
    ctx.strokeStyle = '#4a90c4';
    ctx.lineWidth = 2;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    const snoutX = glacier.snoutX;
    ctx.moveTo(snoutX, baseY + 20);
    ctx.lineTo(snoutX + 40, baseY + 30);
    ctx.lineTo(snoutX + 80, baseY + 28);
    ctx.lineTo(snoutX + 120, baseY + 35);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  /* Tarn when glacier has fully melted and erosion is significant */
  if (glacier.length <= 0 && glacier.erosionDepth > 40) {
    const lakeGrad = ctx.createRadialGradient(400, baseY + 5, 5, 400, baseY + 5, 70);
    lakeGrad.addColorStop(0, '#3a7ab4');
    lakeGrad.addColorStop(1, '#5a9ad4');
    ctx.fillStyle = lakeGrad;
    ctx.beginPath();
    ctx.ellipse(400, baseY + 5, 60 * (glacier.erosionDepth / glacier.maxErosion), 14, 0, 0, Math.PI * 2);
    ctx.fill();
  }

  drawAnimLabels(baseY);
}

function drawGlacier(baseY) {
  const startX = 200;
  const endX = glacier.snoutX;
  const thickness = glacier.thickness;
  const progress = glacier.length / glacier.maxLength;

  /* Corrie/accumulation zone at the top */
  const corrieW = 140;
  const corrieDepth = Math.min(40, glacier.erosionDepth * 0.6);

  ctx.save();

  /* Main glacier body */
  ctx.beginPath();
  ctx.moveTo(startX, baseY - 60);

  /* Top surface of glacier, following valley contour slightly raised */
  for (let i = 0; i < VALLEY_RES; i++) {
    const t = i / (VALLEY_RES - 1);
    const x = 200 + t * 800;
    if (x > endX) break;
    const valY = baseY - 180 + valleyProfile[i];
    const centreDist = Math.abs(t - 0.5) * 2;
    const iceHeight = thickness * (1 - centreDist * 0.8) * (1 - t * 0.4);
    if (iceHeight > 5 && centreDist < 0.5) {
      ctx.lineTo(x, valY - iceHeight);
    }
  }

  /* Snout */
  ctx.lineTo(endX, baseY + 30);

  /* Bottom surface along valley floor */
  for (let i = VALLEY_RES - 1; i >= 0; i--) {
    const t = i / (VALLEY_RES - 1);
    const x = 200 + t * 800;
    if (x > endX) continue;
    const valY = baseY - 180 + valleyProfile[i];
    const centreDist = Math.abs(t - 0.5) * 2;
    if (centreDist < 0.5) {
      ctx.lineTo(x, valY);
    }
  }

  ctx.closePath();

  /* Ice gradient */
  const iceGrad = ctx.createLinearGradient(startX, baseY - thickness, endX, baseY + 30);
  iceGrad.addColorStop(0, 'rgba(180,210,235,0.85)');
  iceGrad.addColorStop(0.3, 'rgba(130,180,215,0.8)');
  iceGrad.addColorStop(0.6, 'rgba(100,155,200,0.75)');
  iceGrad.addColorStop(1, 'rgba(80,130,180,0.7)');
  ctx.fillStyle = iceGrad;
  ctx.fill();

  /* Crevasses */
  ctx.strokeStyle = 'rgba(60,100,150,0.3)';
  ctx.lineWidth = 1;
  for (let cx = startX + 80; cx < endX - 40; cx += 55) {
    const jitter = Math.sin(cx * 0.05 + time * 0.1) * 8;
    ctx.beginPath();
    ctx.moveTo(cx + jitter, baseY - thickness * 0.3);
    ctx.lineTo(cx + 5 + jitter, baseY - thickness * 0.1);
    ctx.stroke();
  }

  /* Medial moraine line on glacier */
  if (glacier.erosionDepth > 45 && glacier.moraineDeposited > 5) {
    ctx.strokeStyle = 'rgba(100,80,55,0.5)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(startX + 60, baseY - thickness * 0.3);
    for (let mx = startX + 80; mx < endX - 20; mx += 20) {
      const my = baseY - thickness * 0.25 * (1 - (mx - startX) / (endX - startX) * 0.5);
      ctx.lineTo(mx, my + Math.sin(mx * 0.03) * 3);
    }
    ctx.stroke();
  }

  /* Snow/firn at accumulation zone */
  ctx.fillStyle = 'rgba(235,242,248,0.6)';
  ctx.beginPath();
  ctx.ellipse(startX + 80, baseY - thickness * 0.6, 70, 25, -0.2, 0, Math.PI * 2);
  ctx.fill();

  ctx.restore();

  /* Lateral moraine ridges along edges */
  if (glacier.moraineDeposited > 3) {
    const morH = Math.min(15, glacier.moraineDeposited * 0.5);
    ctx.fillStyle = 'rgba(122,99,68,0.7)';
    /* Left lateral */
    for (let lx = startX + 30; lx < endX; lx += 30) {
      const ly = baseY - thickness * 0.05;
      ctx.beginPath();
      ctx.arc(lx, ly + 40, morH * 0.7, 0, Math.PI * 2);
      ctx.fill();
    }
    /* Right lateral */
    for (let rx = startX + 50; rx < endX; rx += 30) {
      const ry = baseY - thickness * 0.05;
      ctx.beginPath();
      ctx.arc(rx + 300, ry + 40, morH * 0.6, 0, Math.PI * 2);
      ctx.fill();
    }
  }
}

function drawMoraines(baseY) {
  /* Terminal moraine */
  if (glacier.terminalMoraineH > 3) {
    const tmx = glacier.terminalMoraineX;
    const tmh = glacier.terminalMoraineH;
    const grad = ctx.createLinearGradient(tmx - 30, baseY - tmh, tmx + 30, baseY + 10);
    grad.addColorStop(0, '#8a7354');
    grad.addColorStop(1, '#6a5334');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.moveTo(tmx - 35, baseY + 20);
    ctx.quadraticCurveTo(tmx - 10, baseY - tmh, tmx, baseY - tmh - 5);
    ctx.quadraticCurveTo(tmx + 10, baseY - tmh, tmx + 35, baseY + 20);
    ctx.closePath();
    ctx.fill();

    /* Small rocks/debris on moraine */
    ctx.fillStyle = '#5a4a34';
    for (let r = 0; r < 6; r++) {
      const rx = tmx - 20 + r * 8;
      const ry = baseY - tmh + 5 + Math.sin(r * 2.3) * 5;
      ctx.fillRect(rx, ry, 4, 3);
    }
  }

  /* Deposited lateral moraines (visible when glacier retreated) */
  if (glacier.retreating && glacier.moraineDeposited > 8) {
    ctx.fillStyle = 'rgba(122,99,68,0.5)';
    const depositEnd = glacier.terminalMoraineX || glacier.snoutX;
    for (let dx = 250; dx < depositEnd; dx += 40) {
      /* Left side deposit */
      ctx.beginPath();
      ctx.ellipse(dx, baseY + 35, 12, 5, 0, 0, Math.PI * 2);
      ctx.fill();
      /* Right side deposit */
      ctx.beginPath();
      ctx.ellipse(dx + 280, baseY + 35, 10, 4, 0, 0, Math.PI * 2);
      ctx.fill();
    }
  }
}

function drawAnimLabels(baseY) {
  const e = glacier.erosionDepth;
  const hasIce = glacier.length > 10;

  if (hasIce) {
    drawLabel('Glacier', (200 + glacier.snoutX) / 2, baseY - glacier.thickness * 0.4);
    if (glacier.thickness > 40) {
      drawLabel('Accumulation zone', 280, baseY - glacier.thickness * 0.7);
    }
    if (glacier.length > 200) {
      drawLabel('Ablation zone', glacier.snoutX - 80, baseY - 10);
    }
    if (glacier.length > 100) {
      drawLabel('Snout', glacier.snoutX + 5, baseY + 45);
    }
  }

  if (e > 15) {
    drawLabel('Corrie forming', 260, baseY - glacier.thickness * 0.8 - 20);
  }
  if (e > 30) {
    drawLabel('Arete', 130, baseY - 180);
  }
  if (e > 50 && !hasIce) {
    drawLabel('U-shaped valley', 600, baseY + 60);
  }
  if (e > 40) {
    drawLabel('Truncated spur', 850, baseY - 40);
  }
  if (glacier.terminalMoraineH > 5) {
    drawLabel('Terminal moraine', glacier.terminalMoraineX, baseY - glacier.terminalMoraineH - 18);
  }
  if (glacier.moraineDeposited > 5 && hasIce) {
    drawLabel('Lateral moraine', 300, baseY + 55);
  }
  if (glacier.erosionDepth > 45 && glacier.moraineDeposited > 5 && hasIce) {
    drawLabel('Medial moraine', 420, baseY - glacier.thickness * 0.2);
  }
  if (glacier.length <= 0 && e > 40) {
    drawLabel('Tarn', 400, baseY - 10);
  }

  /* Process annotations when active */
  if (hasIce && !glacier.retreating) {
    if (glacier.thickness > 30) {
      drawSmallLabel('Abrasion', 450, baseY + 25, '#c0392b');
      drawSmallLabel('Plucking', 550, baseY + 25, '#8e44ad');
    }
    drawSmallLabel('Freeze-thaw', 180, baseY - 120, '#2980b9');
  }
}

function drawSmallLabel(text, x, y, colour) {
  ctx.font = 'bold 9px -apple-system, sans-serif';
  const m = ctx.measureText(text);
  const pw = m.width + 8;
  const ph = 16;
  ctx.fillStyle = colour || 'rgba(26,58,74,0.85)';
  ctx.globalAlpha = 0.85;
  roundRect(ctx, x - pw / 2, y - ph / 2, pw, ph, 3);
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.fillStyle = '#fff';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, x, y);
}

/* Initial draw */
draw();
</script>
</body>
</html>
