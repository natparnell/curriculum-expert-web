<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhetoric Autopsy</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --deep-blue: #1a2744;
  --navy: #233155;
  --royal-blue: #2c4a7c;
  --gold: #d4a843;
  --bright-gold: #f0c75e;
  --cream: #faf6ed;
  --warm-cream: #f5efe0;
  --parchment: #ede4d0;
  --text-dark: #1e1e2a;
  --text-medium: #3d3d50;
  --text-light: #6b6b80;
  --shadow: rgba(26, 39, 68, 0.15);
  --shadow-heavy: rgba(26, 39, 68, 0.25);

  /* Device colours */
  --c-anaphora: #e8735a;
  --c-tricolon: #5b9bd5;
  --c-metaphor: #8e6bbf;
  --c-alliteration: #4db890;
  --c-emotive: #e0527e;
  --c-rhetorical-q: #d49b3d;
  --c-hyperbole: #cf6840;
  --c-antithesis: #3d8fa6;
  --c-parallelism: #7ead54;
  --c-imagery: #b8698a;
  --c-imperative: #6b83c4;
  --c-inclusive: #9c7a4f;
  --c-repetition: #c95d5d;
  --c-juxtaposition: #508a8a;

  /* Device backgrounds (lighter) */
  --cb-anaphora: rgba(232, 115, 90, 0.22);
  --cb-tricolon: rgba(91, 155, 213, 0.22);
  --cb-metaphor: rgba(142, 107, 191, 0.22);
  --cb-alliteration: rgba(77, 184, 144, 0.22);
  --cb-emotive: rgba(224, 82, 126, 0.22);
  --cb-rhetorical-q: rgba(212, 155, 61, 0.22);
  --cb-hyperbole: rgba(207, 104, 64, 0.22);
  --cb-antithesis: rgba(61, 143, 166, 0.22);
  --cb-parallelism: rgba(126, 173, 84, 0.22);
  --cb-imagery: rgba(184, 105, 138, 0.22);
  --cb-imperative: rgba(107, 131, 196, 0.22);
  --cb-inclusive: rgba(156, 122, 79, 0.22);
  --cb-repetition: rgba(201, 93, 93, 0.22);
  --cb-juxtaposition: rgba(80, 138, 138, 0.22);
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideInRight {
  from { opacity: 0; transform: translateX(40px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 0 0 rgba(212, 168, 67, 0.3); }
  50% { box-shadow: 0 0 20px 5px rgba(212, 168, 67, 0.15); }
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
@keyframes popIn {
  0% { transform: scale(0.8); opacity: 0; }
  70% { transform: scale(1.05); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes correctFlash {
  0% { background: rgba(77, 184, 144, 0.4); }
  100% { background: rgba(77, 184, 144, 0.1); }
}
@keyframes incorrectFlash {
  0% { background: rgba(220, 80, 80, 0.4); }
  100% { background: rgba(220, 80, 80, 0.05); }
}

html { font-size: 16px; scroll-behavior: smooth; }

body {
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  background: var(--cream);
  color: var(--text-dark);
  min-height: 100vh;
  line-height: 1.6;
}

/* =========== HEADER =========== */
header {
  background: linear-gradient(135deg, var(--deep-blue) 0%, var(--navy) 50%, var(--royal-blue) 100%);
  color: var(--cream);
  padding: 1.5rem 2rem;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 20px var(--shadow-heavy);
}
header .header-inner {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
}
header h1 {
  font-size: 1.8rem;
  font-weight: 700;
  letter-spacing: 0.02em;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
header h1 .icon {
  font-size: 1.5rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 42px;
  height: 42px;
  background: rgba(212, 168, 67, 0.15);
  border: 2px solid var(--gold);
  border-radius: 10px;
}
header h1 .subtitle {
  display: block;
  font-size: 0.75rem;
  font-weight: 400;
  opacity: 0.7;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-top: -2px;
}
.header-controls {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  flex-wrap: wrap;
}
.mode-toggle {
  background: rgba(255,255,255,0.1);
  border: 2px solid var(--gold);
  color: var(--bright-gold);
  padding: 0.55rem 1.2rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  letter-spacing: 0.02em;
}
.mode-toggle:hover {
  background: var(--gold);
  color: var(--deep-blue);
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(212, 168, 67, 0.3);
}
.mode-toggle.active {
  background: var(--gold);
  color: var(--deep-blue);
  animation: pulseGlow 2s ease-in-out infinite;
}

/* =========== SPEECH SELECTOR =========== */
.speech-selector {
  max-width: 1400px;
  margin: 1.5rem auto;
  padding: 0 1.5rem;
  display: flex;
  gap: 0.8rem;
  flex-wrap: wrap;
}
.speech-btn {
  flex: 1;
  min-width: 200px;
  background: white;
  border: 2px solid transparent;
  border-radius: 12px;
  padding: 1rem 1.2rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px var(--shadow);
  text-align: left;
}
.speech-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px var(--shadow-heavy);
  border-color: var(--gold);
}
.speech-btn.active {
  border-color: var(--gold);
  background: linear-gradient(135deg, #fffdf5 0%, #fff8e7 100%);
  box-shadow: 0 4px 15px rgba(212, 168, 67, 0.2);
}
.speech-btn .speaker {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--deep-blue);
  margin-bottom: 0.15rem;
}
.speech-btn .title {
  font-size: 0.8rem;
  color: var(--text-light);
  font-style: italic;
}
.speech-btn .year {
  font-size: 0.7rem;
  color: var(--gold);
  font-weight: 600;
  margin-top: 0.25rem;
}

/* =========== MAIN LAYOUT =========== */
.main-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem 2rem;
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 1.5rem;
  animation: fadeInUp 0.6s ease;
}

/* =========== SPEECH PANEL =========== */
.speech-panel {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px var(--shadow);
  overflow: hidden;
}
.speech-header {
  background: linear-gradient(135deg, var(--deep-blue), var(--navy));
  color: var(--cream);
  padding: 1.2rem 1.5rem;
}
.speech-header h2 {
  font-size: 1.3rem;
  font-weight: 700;
}
.speech-header .meta {
  font-size: 0.8rem;
  opacity: 0.7;
  margin-top: 0.2rem;
}
.speech-text {
  padding: 2rem;
  font-size: 1.15rem;
  line-height: 2;
  color: var(--text-dark);
  font-family: 'Georgia', 'Times New Roman', serif;
  min-height: 300px;
  position: relative;
}
.speech-text .line {
  margin-bottom: 0.3rem;
}

/* Highlighted spans */
.device-highlight {
  padding: 2px 4px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 2px solid transparent;
  position: relative;
}
.device-highlight:hover {
  filter: brightness(0.95);
  transform: scale(1.02);
  display: inline-block;
}
.device-highlight.selected {
  outline: 2px solid var(--gold);
  outline-offset: 2px;
  border-radius: 4px;
}

/* Device type specific styles */
.dh-anaphora { background: var(--cb-anaphora); border-bottom-color: var(--c-anaphora); }
.dh-tricolon { background: var(--cb-tricolon); border-bottom-color: var(--c-tricolon); }
.dh-metaphor { background: var(--cb-metaphor); border-bottom-color: var(--c-metaphor); }
.dh-alliteration { background: var(--cb-alliteration); border-bottom-color: var(--c-alliteration); }
.dh-emotive { background: var(--cb-emotive); border-bottom-color: var(--c-emotive); }
.dh-rhetorical-q { background: var(--cb-rhetorical-q); border-bottom-color: var(--c-rhetorical-q); }
.dh-hyperbole { background: var(--cb-hyperbole); border-bottom-color: var(--c-hyperbole); }
.dh-antithesis { background: var(--cb-antithesis); border-bottom-color: var(--c-antithesis); }
.dh-parallelism { background: var(--cb-parallelism); border-bottom-color: var(--c-parallelism); }
.dh-imagery { background: var(--cb-imagery); border-bottom-color: var(--c-imagery); }
.dh-imperative { background: var(--cb-imperative); border-bottom-color: var(--c-imperative); }
.dh-inclusive { background: var(--cb-inclusive); border-bottom-color: var(--c-inclusive); }
.dh-repetition { background: var(--cb-repetition); border-bottom-color: var(--c-repetition); }
.dh-juxtaposition { background: var(--cb-juxtaposition); border-bottom-color: var(--c-juxtaposition); }

/* Challenge mode: hidden highlights */
.challenge-mode .device-highlight {
  background: transparent !important;
  border-bottom-color: transparent !important;
  cursor: crosshair;
}
.challenge-mode .device-highlight.revealed-correct {
  animation: correctFlash 1s ease forwards;
  border-bottom-color: #4db890 !important;
}
.challenge-mode .device-highlight.revealed-incorrect {
  animation: incorrectFlash 1s ease forwards;
}
.challenge-mode .speech-text {
  cursor: crosshair;
}

/* =========== SIDEBAR =========== */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
}

/* Device Info Card */
.device-info-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px var(--shadow);
  overflow: hidden;
  transition: all 0.3s ease;
}
.device-info-card.has-content {
  animation: slideInRight 0.4s ease;
}
.device-info-header {
  padding: 1.2rem 1.3rem 0.8rem;
  background: linear-gradient(135deg, var(--deep-blue), var(--royal-blue));
  color: var(--cream);
}
.device-info-header h3 {
  font-size: 1.1rem;
  margin-bottom: 0.15rem;
}
.device-info-header .device-category {
  display: inline-block;
  font-size: 0.7rem;
  padding: 0.2rem 0.6rem;
  border-radius: 20px;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}
.cat-pathos { background: rgba(224, 82, 126, 0.3); color: #ffb8cc; }
.cat-ethos { background: rgba(91, 155, 213, 0.3); color: #b8d8f8; }
.cat-logos { background: rgba(126, 173, 84, 0.3); color: #c5e8a5; }
.device-info-body {
  padding: 1.2rem 1.3rem;
}
.device-info-body .phrase-quoted {
  font-family: Georgia, serif;
  font-style: italic;
  font-size: 1rem;
  color: var(--royal-blue);
  padding: 0.8rem;
  background: var(--warm-cream);
  border-left: 3px solid var(--gold);
  border-radius: 0 8px 8px 0;
  margin-bottom: 1rem;
  line-height: 1.5;
}
.device-info-body .info-section {
  margin-bottom: 0.9rem;
}
.device-info-body .info-section h4 {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-light);
  margin-bottom: 0.3rem;
}
.device-info-body .info-section p {
  font-size: 0.9rem;
  color: var(--text-medium);
  line-height: 1.5;
}
.device-info-placeholder {
  padding: 2.5rem 1.5rem;
  text-align: center;
  color: var(--text-light);
}
.device-info-placeholder .placeholder-icon {
  font-size: 2.5rem;
  margin-bottom: 0.8rem;
  opacity: 0.4;
}
.device-info-placeholder p {
  font-size: 0.9rem;
  line-height: 1.5;
}

/* Stats Panel */
.stats-panel {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px var(--shadow);
  overflow: hidden;
}
.stats-header {
  background: linear-gradient(135deg, var(--deep-blue), var(--navy));
  color: var(--cream);
  padding: 0.9rem 1.3rem;
  font-weight: 700;
  font-size: 0.95rem;
}
.stats-body {
  padding: 1rem 1.3rem;
}
.stat-row {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.4rem 0;
  font-size: 0.82rem;
}
.stat-dot {
  width: 12px;
  height: 12px;
  border-radius: 3px;
  flex-shrink: 0;
}
.stat-name {
  flex: 1;
  color: var(--text-medium);
}
.stat-count {
  font-weight: 700;
  color: var(--deep-blue);
  min-width: 20px;
  text-align: right;
}
.stat-bar-bg {
  width: 50px;
  height: 6px;
  background: var(--warm-cream);
  border-radius: 3px;
  overflow: hidden;
}
.stat-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
}

/* Legend Panel */
.legend-panel {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px var(--shadow);
  overflow: hidden;
}
.legend-header {
  background: linear-gradient(135deg, var(--deep-blue), var(--navy));
  color: var(--cream);
  padding: 0.9rem 1.3rem;
  font-weight: 700;
  font-size: 0.95rem;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.legend-header .toggle-arrow {
  transition: transform 0.3s ease;
  font-size: 0.8rem;
}
.legend-header .toggle-arrow.collapsed {
  transform: rotate(-90deg);
}
.legend-body {
  padding: 0.8rem 1.3rem;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.3rem 0.8rem;
  max-height: 500px;
  overflow: hidden;
  transition: max-height 0.3s ease, padding 0.3s ease;
}
.legend-body.collapsed {
  max-height: 0;
  padding: 0 1.3rem;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.78rem;
  color: var(--text-medium);
  padding: 0.25rem 0;
}
.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 3px;
  flex-shrink: 0;
}

/* =========== CHALLENGE MODE OVERLAY =========== */
.challenge-banner {
  display: none;
  max-width: 1400px;
  margin: 0 auto 1rem;
  padding: 0 1.5rem;
}
.challenge-banner.visible {
  display: block;
  animation: fadeInUp 0.4s ease;
}
.challenge-banner-inner {
  background: linear-gradient(135deg, #2c4a7c, #1a2744);
  color: var(--cream);
  border-radius: 12px;
  padding: 1rem 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
  box-shadow: 0 4px 20px var(--shadow-heavy);
}
.challenge-info {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.challenge-info h3 {
  font-size: 1rem;
  color: var(--bright-gold);
}
.challenge-info p {
  font-size: 0.82rem;
  opacity: 0.8;
}
.challenge-score {
  display: flex;
  gap: 1.5rem;
  align-items: center;
}
.score-item {
  text-align: center;
}
.score-item .score-num {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--bright-gold);
}
.score-item .score-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  opacity: 0.7;
}
.challenge-actions {
  display: flex;
  gap: 0.6rem;
}
.btn-reveal, .btn-reset-challenge {
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.2s ease;
}
.btn-reveal {
  background: var(--gold);
  color: var(--deep-blue);
}
.btn-reveal:hover {
  background: var(--bright-gold);
  transform: translateY(-1px);
}
.btn-reset-challenge {
  background: rgba(255,255,255,0.15);
  color: var(--cream);
  border: 1px solid rgba(255,255,255,0.3);
}
.btn-reset-challenge:hover {
  background: rgba(255,255,255,0.25);
}

/* =========== POPUP TOOLTIP (for small screens) =========== */
.device-popup {
  display: none;
  position: fixed;
  z-index: 200;
  background: white;
  border-radius: 14px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25);
  max-width: 340px;
  width: 90vw;
  animation: popIn 0.25s ease;
  overflow: hidden;
}
.device-popup.visible {
  display: block;
}
.popup-close {
  position: absolute;
  top: 0.6rem;
  right: 0.8rem;
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  z-index: 5;
}
.popup-close:hover {
  background: rgba(255,255,255,0.35);
}

/* =========== RESPONSIVE =========== */
@media (max-width: 900px) {
  .main-container {
    grid-template-columns: 1fr;
  }
  .sidebar {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  .device-info-card {
    grid-column: 1 / -1;
  }
  header h1 { font-size: 1.4rem; }
  .speech-text { font-size: 1.05rem; padding: 1.5rem; }
}
@media (max-width: 600px) {
  .sidebar {
    grid-template-columns: 1fr;
  }
  .speech-selector {
    flex-direction: column;
  }
  .speech-btn { min-width: unset; }
  header { padding: 1rem; }
  .speech-text { font-size: 0.95rem; padding: 1.2rem; }
  .challenge-banner-inner {
    flex-direction: column;
    text-align: center;
  }
}

/* Projector-friendly: larger text at wide screens */
@media (min-width: 1600px) {
  .speech-text { font-size: 1.35rem; line-height: 2.2; }
  header h1 { font-size: 2rem; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <h1>
      <span class="icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      </span>
      <span>
        Rhetoric Autopsy
        <span class="subtitle">Dissecting the Art of Persuasion</span>
      </span>
    </h1>
    <div class="header-controls">
      <button class="mode-toggle" id="challengeToggle" onclick="toggleChallengeMode()">
        <svg style="vertical-align:-2px;margin-right:4px" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Device Spotter Challenge
      </button>
    </div>
  </div>
</header>

<!-- Speech Selector -->
<div class="speech-selector" id="speechSelector"></div>

<!-- Challenge Banner -->
<div class="challenge-banner" id="challengeBanner">
  <div class="challenge-banner-inner">
    <div class="challenge-info">
      <div>
        <h3>Device Spotter Challenge</h3>
        <p>Click on words or phrases you think contain a rhetorical device. Can you find them all?</p>
      </div>
    </div>
    <div class="challenge-score">
      <div class="score-item">
        <div class="score-num" id="scoreCorrect">0</div>
        <div class="score-label">Found</div>
      </div>
      <div class="score-item">
        <div class="score-num" id="scoreTotal">0</div>
        <div class="score-label">Total</div>
      </div>
      <div class="score-item">
        <div class="score-num" id="scorePercent">0%</div>
        <div class="score-label">Score</div>
      </div>
    </div>
    <div class="challenge-actions">
      <button class="btn-reveal" onclick="revealAll()">Reveal All</button>
      <button class="btn-reset-challenge" onclick="resetChallenge()">Reset</button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="main-container">
  <!-- Speech Text -->
  <div class="speech-panel">
    <div class="speech-header" id="speechHeaderArea">
      <h2 id="speechTitle">Select a speech</h2>
      <div class="meta" id="speechMeta"></div>
    </div>
    <div class="speech-text" id="speechText">
      <div class="device-info-placeholder">
        <div class="placeholder-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        </div>
        <p>Choose a speech above to begin your rhetoric autopsy.</p>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Device Info -->
    <div class="device-info-card" id="deviceInfoCard">
      <div class="device-info-placeholder" id="devicePlaceholder">
        <div class="placeholder-icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </div>
        <p>Click a highlighted phrase to dissect the rhetorical device used.</p>
      </div>
      <div id="deviceInfoContent" style="display:none;">
        <div class="device-info-header" id="deviceInfoHeader">
          <h3 id="deviceName"></h3>
          <span class="device-category" id="deviceCategory"></span>
        </div>
        <div class="device-info-body">
          <div class="phrase-quoted" id="devicePhrase"></div>
          <div class="info-section">
            <h4>Definition</h4>
            <p id="deviceDefinition"></p>
          </div>
          <div class="info-section">
            <h4>Why It Works Here</h4>
            <p id="deviceEffect"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-panel" id="statsPanel">
      <div class="stats-header">Device Statistics</div>
      <div class="stats-body" id="statsBody">
        <div style="padding:1rem;text-align:center;color:var(--text-light);font-size:0.85rem;">
          Select a speech to see statistics.
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend-panel">
      <div class="legend-header" onclick="toggleLegend()">
        <span>Colour Key</span>
        <span class="toggle-arrow" id="legendArrow">&#9662;</span>
      </div>
      <div class="legend-body" id="legendBody"></div>
    </div>
  </div>
</div>

<!-- Mobile Popup -->
<div class="device-popup" id="devicePopup">
  <button class="popup-close" onclick="closePopup()">&times;</button>
  <div class="device-info-header" id="popupHeader">
    <h3 id="popupName"></h3>
    <span class="device-category" id="popupCategory"></span>
  </div>
  <div class="device-info-body">
    <div class="phrase-quoted" id="popupPhrase"></div>
    <div class="info-section">
      <h4>Definition</h4>
      <p id="popupDefinition"></p>
    </div>
    <div class="info-section">
      <h4>Why It Works Here</h4>
      <p id="popupEffect"></p>
    </div>
  </div>
</div>

<script>
// ========================================================================
// DEVICE DEFINITIONS
// ========================================================================
const DEVICES = {
  anaphora: {
    name: "Anaphora",
    color: "#e8735a",
    cssClass: "dh-anaphora",
    definition: "The deliberate repetition of a word or phrase at the beginning of successive clauses or sentences, building rhythmic momentum and emphasis.",
    category: "Pathos"
  },
  tricolon: {
    name: "Tricolon",
    color: "#5b9bd5",
    cssClass: "dh-tricolon",
    definition: "A series of three parallel words, phrases, or clauses. The 'rule of three' creates a sense of completeness and satisfying rhythm.",
    category: "Logos"
  },
  metaphor: {
    name: "Metaphor",
    color: "#8e6bbf",
    cssClass: "dh-metaphor",
    definition: "A direct comparison between two unlike things without using 'like' or 'as', creating a vivid image and deeper meaning.",
    category: "Pathos"
  },
  alliteration: {
    name: "Alliteration",
    color: "#4db890",
    cssClass: "dh-alliteration",
    definition: "The repetition of initial consonant sounds in closely connected words, creating a musical quality that aids memorability.",
    category: "Pathos"
  },
  emotive: {
    name: "Emotive Language",
    color: "#e0527e",
    cssClass: "dh-emotive",
    definition: "Words deliberately chosen to provoke an emotional response in the audience, appealing to feelings rather than reason.",
    category: "Pathos"
  },
  "rhetorical-q": {
    name: "Rhetorical Question",
    color: "#d49b3d",
    cssClass: "dh-rhetorical-q",
    definition: "A question asked for effect rather than to receive an answer, engaging the audience and guiding them toward a particular conclusion.",
    category: "Logos"
  },
  hyperbole: {
    name: "Hyperbole",
    color: "#cf6840",
    cssClass: "dh-hyperbole",
    definition: "Exaggeration used for emphasis or dramatic effect, not intended to be taken literally but to stress the magnitude of an idea.",
    category: "Pathos"
  },
  antithesis: {
    name: "Antithesis",
    color: "#3d8fa6",
    cssClass: "dh-antithesis",
    definition: "The juxtaposition of contrasting ideas in balanced phrases or clauses, creating a sharp and memorable contrast.",
    category: "Logos"
  },
  parallelism: {
    name: "Parallelism",
    color: "#7ead54",
    cssClass: "dh-parallelism",
    definition: "The use of similar grammatical structures in related words, phrases, or clauses, creating balance and rhythm.",
    category: "Logos"
  },
  imagery: {
    name: "Imagery",
    color: "#b8698a",
    cssClass: "dh-imagery",
    definition: "Vivid descriptive language that appeals to the senses, painting a mental picture to make abstract ideas tangible.",
    category: "Pathos"
  },
  imperative: {
    name: "Imperative",
    color: "#6b83c4",
    cssClass: "dh-imperative",
    definition: "A command or instruction directed at the audience, creating a sense of urgency and a direct call to action.",
    category: "Ethos"
  },
  inclusive: {
    name: "Inclusive Language",
    color: "#9c7a4f",
    cssClass: "dh-inclusive",
    definition: "The use of pronouns like 'we', 'us', and 'our' to create unity between speaker and audience, fostering shared identity.",
    category: "Ethos"
  },
  repetition: {
    name: "Repetition",
    color: "#c95d5d",
    cssClass: "dh-repetition",
    definition: "Repeating a key word or phrase for emphasis, reinforcing an idea and making it linger in the audience's mind.",
    category: "Pathos"
  },
  juxtaposition: {
    name: "Juxtaposition",
    color: "#508a8a",
    cssClass: "dh-juxtaposition",
    definition: "Placing two contrasting elements close together to highlight their differences and create a dramatic effect.",
    category: "Logos"
  }
};

// ========================================================================
// SPEECH DATA
// ========================================================================
const SPEECHES = [
  {
    id: "mlk",
    speaker: "Martin Luther King Jr.",
    title: "\"I Have a Dream\"",
    year: "1963",
    meta: "Washington D.C., August 28, 1963",
    lines: [
      {
        text: "I say to you today, my friends, so even though we face the difficulties of today and tomorrow, ",
        devices: []
      },
      {
        text: "",
        devices: [],
        segments: [
          { text: "I still have a dream", device: "anaphora", effect: "The repetition of 'I have a dream' at the start of successive clauses builds powerful momentum, each new vision layering upon the last, creating an incantation-like rhythm that carries the audience forward with hope." },
          { text: ". It is a dream deeply rooted in the American Dream." }
        ]
      },
      {
        text: "",
        devices: [],
        segments: [
          { text: "I have a dream", device: "anaphora", effect: "Repeating this phrase anchors the entire speech, making it the central motif. Each repetition intensifies the emotional weight and makes the vision feel both personal and universal." },
          { text: " that one day this nation will rise up and live out the true meaning of its creed: " },
          { text: "\"We hold these truths to be self-evident, that all men are created equal.\"", device: "ethos-quote", skip: true }
        ]
      },
      {
        text: "",
        segments: [
          { text: "I have a dream", device: "anaphora", effect: "The relentless repetition transforms a personal vision into a collective one, each iteration adding a new dimension of the dream that builds toward a crescendo of hope." },
          { text: " that one day on the " },
          { text: "red hills of Georgia", device: "imagery", effect: "The specific, sensory image of Georgia's red clay hills grounds the abstract dream in a real, physical landscape that listeners can picture vividly." },
          { text: ", the " },
          { text: "sons of former slaves and the sons of former slave owners", device: "antithesis", effect: "This powerful contrast between the descendants of the oppressed and the oppressors sitting together dramatises the scale of the reconciliation King envisions, making the dream feel both radical and necessary." },
          { text: " will be able to sit down together at the table of brotherhood." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "I have a dream", device: "anaphora", effect: "Now applied to Mississippi -- often considered the most oppressive state for Black Americans at the time -- the repetition directly confronts the worst injustice with the boldest hope." },
          { text: " that one day even the state of Mississippi, a state " },
          { text: "sweltering with the heat of injustice, sweltering with the heat of oppression", device: "metaphor", effect: "The metaphor of oppressive summer heat makes injustice physically felt, turning an abstract concept into a sensory experience the audience can relate to viscerally." },
          { text: ", will be transformed into an " },
          { text: "oasis of freedom and justice", device: "metaphor", effect: "The oasis metaphor contrasts powerfully with the preceding 'sweltering heat', offering relief and hope -- a vivid promise that even the harshest conditions can give way to liberation." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "I have a dream", device: "anaphora", effect: "Here the dream becomes personal and intimate -- about King's own children -- making the grand political vision deeply human and relatable to every parent in the audience." },
          { text: " that my four little children will one day live in a nation where they will " },
          { text: "not be judged by the colour of their skin but by the content of their character", device: "antithesis", effect: "This antithesis distils the entire civil rights movement into one perfectly balanced phrase, contrasting the superficial (skin colour) with the substantive (character) in a way that is instantly memorable." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "I have a dream today!", device: "anaphora", effect: "The short, emphatic exclamation punctuates the sequence of longer visions, creating a rhythmic climax that releases the building emotional tension." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "I have a dream", device: "anaphora", effect: "This penultimate repetition reaches for the universal, invoking 'every valley' and 'every hill' from the book of Isaiah, elevating the dream to biblical, prophetic proportions." },
          { text: " that one day " },
          { text: "every valley shall be exalted, and every hill and mountain shall be made low", device: "imagery", effect: "This biblical allusion (Isaiah 40:4) paints a transformative landscape where the natural world itself reshapes to reflect justice, giving the dream cosmic scope and spiritual authority." },
          { text: ", the rough places will be made plain, and the crooked places will be made straight, " },
          { text: "and the glory of the Lord shall be revealed and all flesh shall see it together", device: "inclusive", effect: "'All flesh shall see it together' brings every human being into the vision, using inclusive language to promise that the transformation will be universal, not partial." },
          { text: "." }
        ]
      }
    ]
  },
  {
    id: "shakespeare",
    speaker: "Shakespeare (Mark Antony)",
    title: "\"Friends, Romans, Countrymen\"",
    year: "~1599",
    meta: "Julius Caesar, Act III, Scene 2",
    lines: [
      {
        text: "",
        segments: [
          { text: "Friends, Romans, countrymen", device: "tricolon", effect: "Antony opens with a tricolon that moves from the personal ('friends') to the civic ('Romans') to the national ('countrymen'), strategically widening his appeal with each word to capture the entire crowd." },
          { text: ", " },
          { text: "lend me your ears", device: "metaphor", effect: "This vivid metaphor asks the crowd to 'lend' their attention as if it were a physical object, creating an intimate, transactional relationship between speaker and audience from the very first line." },
          { text: ";" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "I come to bury Caesar, not to praise him", device: "antithesis", effect: "The sharp contrast between 'bury' and 'praise' is deliberately ironic -- Antony claims humility while his entire speech will do the opposite. This misdirection disarms the hostile crowd." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "The evil that men do lives after them; The good is oft interred with their bones", device: "antithesis", effect: "This balanced antithesis (evil/good, lives/interred) appears to accept a harsh truth but actually plants a seed of sympathy for Caesar, making the audience consider what 'good' they might be forgetting." },
          { text: ";" }
        ]
      },
      {
        text: "So let it be with Caesar. The noble Brutus",
        segments: []
      },
      {
        text: "",
        segments: [
          { text: "Hath told you Caesar was ambitious", device: "repetition", effect: "By attributing the accusation to Brutus rather than stating it as fact, Antony begins to subtly distance himself from the claim, each repetition making 'ambitious' sound more like an accusation than a truth." },
          { text: ":" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "If it were so, it was a grievous fault", device: "antithesis", effect: "The conditional 'if' casts doubt on whether the ambition was real at all, while 'grievous fault' momentarily appears to concede -- a masterful rhetorical feint that keeps the conspirators' supporters at ease." },
          { text: "," }
        ]
      },
      {
        text: "And grievously hath Caesar answered it.",
        segments: []
      },
      {
        text: "",
        segments: [
          { text: "Here, under leave of Brutus and the rest \u2014", device: "ethos-ref", skip: true },
          { text: "" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "For Brutus is an honourable man", device: "repetition", effect: "This phrase, repeated throughout the speech, is Antony's most devastating weapon. Each repetition drips with increasing irony until 'honourable' becomes synonymous with 'treacherous' in the audience's mind." },
          { text: ";" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "So are they all, all honourable men", device: "repetition", effect: "Extending the ironic 'honourable' label to all the conspirators amplifies the sarcasm. The doubling of 'all' hammers the point home, daring the crowd to question whether this honour is genuine." },
          { text: " \u2014" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "Come I to speak in Caesar's funeral", device: "emotive", effect: "The word 'funeral' is loaded with grief and solemnity, reminding the crowd of the visceral reality of death and loss, countering Brutus's rational justifications with raw emotion." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "He was my friend, faithful and just to me", device: "tricolon", effect: "The three qualities -- friend, faithful, just -- build a personal testimony of Caesar's character, using the intimate 'to me' to make the abstract virtues feel authentically witnessed." },
          { text: ":" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "But Brutus says he was ambitious", device: "repetition", effect: "Again attributing the claim to Brutus creates a growing tension between what the audience is told to believe and what they are being shown through Antony's evidence. The repetition erodes Brutus's credibility with each cycle." },
          { text: ";" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "And Brutus is an honourable man", device: "repetition", effect: "By this fourth repetition, the word 'honourable' has become unmistakably sarcastic. The crowd can hear the venom beneath the polite surface, and Antony has destroyed Brutus's reputation without ever directly attacking him." },
          { text: "." }
        ]
      }
    ]
  },
  {
    id: "churchill",
    speaker: "Winston Churchill",
    title: "\"We Shall Fight on the Beaches\"",
    year: "1940",
    meta: "House of Commons, June 4, 1940",
    lines: [
      {
        text: "",
        segments: [
          { text: "We shall go on to the end.", device: "imperative", effect: "This blunt, declarative opening establishes an unshakeable resolve. The simplicity of 'to the end' leaves no room for doubt or negotiation -- it is a statement of absolute commitment." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "We shall fight in France", device: "anaphora", effect: "The repeated 'we shall fight' creates a relentless drumbeat of defiance. Beginning with France -- already falling -- shows Churchill confronting the worst reality head-on rather than avoiding it." },
          { text: "," }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall fight on the seas and oceans", device: "anaphora", effect: "Extending the fight to seas and oceans expands the scope from land to water, suggesting that no theatre of war will be conceded. The repetition maintains the speech's relentless forward momentum." },
          { text: "," }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall fight with growing confidence and growing strength in the air", device: "anaphora", effect: "The addition of 'growing confidence and growing strength' introduces an upward trajectory within the repeated structure, subtly shifting from mere resistance to the promise of increasing power." },
          { text: "," }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall defend our island, whatever the cost may be", device: "hyperbole", effect: "'Whatever the cost' is deliberately limitless -- Churchill signals that no sacrifice is too great, rallying the nation with the totality of the commitment and forestalling any argument about the price of resistance." },
          { text: "," }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall fight on the beaches", device: "anaphora", effect: "The beaches were where invasion was most feared. By naming this specific and terrifying location, Churchill transforms the place of greatest vulnerability into a site of defiance." },
          { text: "," }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall fight on the landing grounds", device: "anaphora", effect: "Each successive location moves the fight further inland, showing the audience that even if one line falls, the next stands ready. The cumulative effect is of limitless, layered resistance." },
          { text: "," }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall fight in the fields and in the streets", device: "anaphora", effect: "Moving from military terrain (beaches, landing grounds) to everyday spaces (fields, streets) makes the war personal and local, telling every citizen that they are part of the defence." },
          { text: "," }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall fight in the hills", device: "anaphora", effect: "The hills represent the final high ground -- a last stand. Placing this near the end of the sequence suggests retreat but never surrender, building to an emotional crescendo." },
          { text: ";" }
        ]
      },
      {
        text: "",
        segments: [
          { text: "we shall never surrender", device: "emotive", effect: "After nine repetitions of 'we shall fight', the sudden shift to 'never surrender' breaks the pattern with devastating force. The change in rhythm makes these three words land like a hammer blow, becoming the speech's most memorable line." },
          { text: ", and even if, which I do not for a moment believe, this island or a large part of it were " },
          { text: "subjugated and starving", device: "alliteration", effect: "The sibilant alliteration of 'subjugated and starving' creates a hissing, menacing sound that makes the hypothetical scenario vivid and repellent, strengthening the audience's resolve to prevent it." },
          { text: ", then " },
          { text: "our Empire beyond the seas", device: "inclusive", effect: "Invoking the wider Empire reminds the audience they are not alone in this fight, expanding 'we' from the island nation to a global community of allies and dominions." },
          { text: ", armed and guarded by the British Fleet, would " },
          { text: "carry on the struggle", device: "emotive", effect: "Even in the darkest hypothetical -- the island fallen -- Churchill insists the fight continues elsewhere. This refuses the audience any scenario in which defeat is final, making surrender psychologically impossible." },
          { text: ", until, in God's good time, the New World, with all its power and might, steps forth to the " },
          { text: "rescue and the liberation of the old", device: "antithesis", effect: "The contrast between 'New World' and 'old' creates a narrative arc: the child (America) saving the parent (Britain/Europe). This antithesis carries both hope and a subtle call to the United States for assistance." },
          { text: "." }
        ]
      }
    ]
  },
  {
    id: "obama",
    speaker: "Barack Obama",
    title: "\"Yes We Can\"",
    year: "2008",
    meta: "New Hampshire Primary, January 8, 2008",
    lines: [
      {
        text: "",
        segments: [
          { text: "It was a creed written into the founding documents that declared the destiny of a nation:", device: "emotive", effect: "Opening with 'creed' and 'destiny' frames the speech in almost religious and historic terms, elevating a political campaign into something larger -- a continuation of America's founding story." },
          { text: " " },
          { text: "Yes, we can", device: "repetition", effect: "This three-word phrase becomes the speech's heartbeat. Its simplicity makes it universal, its brevity makes it memorable, and its affirmative tone makes it empowering." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "It was whispered by slaves and abolitionists as they blazed a trail towards freedom through the darkest of nights", device: "imagery", effect: "The imagery of whispering in darkness transforms 'Yes we can' from a slogan into a sacred inheritance, passed down through suffering. The 'trail' and 'darkest nights' create a vivid picture of courage under oppression." },
          { text: ": " },
          { text: "Yes, we can", device: "repetition", effect: "Attached now to the struggle against slavery, the phrase gains historical weight. Each repetition anchors the slogan to a different era, building layers of meaning." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "It was sung by immigrants as they struck out from distant shores", device: "imagery", effect: "The image of immigrants singing as they cross oceans is both cinematic and deeply moving, adding another chapter to the evolving story and connecting the audience to the broader American immigrant narrative." },
          { text: " and " },
          { text: "pioneers who pushed westward against an unforgiving wilderness", device: "imagery", effect: "'Unforgiving wilderness' personifies the landscape as an adversary, making the pioneers' determination tangible and connecting westward expansion to the same spirit of 'Yes we can'." },
          { text: ": " },
          { text: "Yes, we can", device: "repetition", effect: "The repetition now encompasses immigration and frontier expansion, widening the phrase's historical scope with each iteration." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "It was the call of workers who organised, women who reached for the ballot, a President who chose the moon as our new frontier", device: "tricolon", effect: "This tricolon compresses three great American achievements -- labour rights, women's suffrage, and the space race -- into one breathless sentence, creating a sense of unstoppable progress across different domains." },
          { text: ": " },
          { text: "Yes, we can", device: "repetition", effect: "By this point, the repetition has accumulated enormous historical force. The phrase now carries the weight of workers, suffragists, and astronauts, making the current moment feel like the next chapter in an epic story." },
          { text: "." }
        ]
      },
      {
        text: "",
        segments: [
          { text: "For when we have faced down impossible odds", device: "inclusive", effect: "The pronoun 'we' dissolves the boundary between speaker, audience, and the historical figures just invoked, creating a single unbroken chain of American determination that includes everyone present." },
          { text: ", when we've been told that " },
          { text: "we're not ready or that we shouldn't try or that we can't", device: "tricolon", effect: "This tricolon of negatives -- not ready, shouldn't try, can't -- builds a crescendo of doubt that the speech is about to shatter, making the coming affirmation feel all the more triumphant." },
          { text: ", " },
          { text: "generations of Americans have responded with a simple creed that sums up the spirit of a people", device: "emotive", effect: "'Spirit of a people' elevates the slogan from politics to national identity, making it feel timeless and essential rather than partisan." },
          { text: ": " },
          { text: "Yes, we can", device: "repetition", effect: "The final repetition lands with the cumulative force of every historical example that preceded it, transforming a campaign slogan into a statement of national character." },
          { text: "." }
        ]
      }
    ]
  }
];

// ========================================================================
// STATE
// ========================================================================
let currentSpeechId = null;
let challengeMode = false;
let challengeFound = new Set();
let allDeviceSpans = [];

// ========================================================================
// INIT
// ========================================================================
function init() {
  buildSpeechSelector();
  buildLegend();
  loadSpeech(SPEECHES[0].id);
}

function buildSpeechSelector() {
  const container = document.getElementById('speechSelector');
  SPEECHES.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'speech-btn';
    btn.dataset.id = s.id;
    btn.innerHTML = `
      <div class="speaker">${s.speaker}</div>
      <div class="title">${s.title}</div>
      <div class="year">${s.year}</div>
    `;
    btn.addEventListener('click', () => loadSpeech(s.id));
    container.appendChild(btn);
  });
}

function buildLegend() {
  const body = document.getElementById('legendBody');
  for (const [key, dev] of Object.entries(DEVICES)) {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<span class="legend-dot" style="background:${dev.color}"></span>${dev.name}`;
    body.appendChild(item);
  }
}

// ========================================================================
// LOAD SPEECH
// ========================================================================
function loadSpeech(id) {
  const speech = SPEECHES.find(s => s.id === id);
  if (!speech) return;
  currentSpeechId = id;

  // Update selector buttons
  document.querySelectorAll('.speech-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.id === id);
  });

  // Update header
  document.getElementById('speechTitle').textContent = speech.speaker + ' \u2014 ' + speech.title;
  document.getElementById('speechMeta').textContent = speech.meta;

  // Build speech text
  const textEl = document.getElementById('speechText');
  textEl.innerHTML = '';
  allDeviceSpans = [];
  let deviceIndex = 0;

  speech.lines.forEach(line => {
    const lineDiv = document.createElement('div');
    lineDiv.className = 'line';

    if (line.segments && line.segments.length > 0) {
      line.segments.forEach(seg => {
        if (seg.skip) {
          // Non-device styled text
          const span = document.createElement('span');
          span.textContent = seg.text;
          lineDiv.appendChild(span);
          return;
        }
        if (seg.device && DEVICES[seg.device]) {
          const span = document.createElement('span');
          span.className = `device-highlight ${DEVICES[seg.device].cssClass}`;
          span.textContent = seg.text;
          span.dataset.deviceKey = seg.device;
          span.dataset.effect = seg.effect || '';
          span.dataset.index = deviceIndex++;
          span.addEventListener('click', (e) => handleDeviceClick(e, span));
          lineDiv.appendChild(span);
          allDeviceSpans.push(span);
        } else {
          const span = document.createElement('span');
          span.textContent = seg.text;
          lineDiv.appendChild(span);
        }
      });
    } else {
      lineDiv.textContent = line.text;
    }

    textEl.appendChild(lineDiv);
  });

  // Update stats
  updateStats();

  // Reset device info
  resetDeviceInfo();

  // If challenge mode, reset
  if (challengeMode) {
    resetChallenge();
  }

  // Animate
  textEl.style.animation = 'none';
  textEl.offsetHeight; // reflow
  textEl.style.animation = 'fadeIn 0.5s ease';
}

// ========================================================================
// DEVICE INFO
// ========================================================================
function handleDeviceClick(e, span) {
  e.stopPropagation();

  if (challengeMode) {
    handleChallengeClick(span);
    return;
  }

  // Deselect previous
  document.querySelectorAll('.device-highlight.selected').forEach(el => el.classList.remove('selected'));
  span.classList.add('selected');

  const key = span.dataset.deviceKey;
  const dev = DEVICES[key];
  if (!dev) return;

  const phrase = span.textContent;
  const effect = span.dataset.effect;
  const catClass = dev.category === 'Pathos' ? 'cat-pathos' : dev.category === 'Ethos' ? 'cat-ethos' : 'cat-logos';

  // Check if mobile
  if (window.innerWidth < 900) {
    showPopup(dev, phrase, effect, catClass, e);
  } else {
    showSidebarInfo(dev, phrase, effect, catClass);
  }
}

function showSidebarInfo(dev, phrase, effect, catClass) {
  document.getElementById('devicePlaceholder').style.display = 'none';
  const content = document.getElementById('deviceInfoContent');
  content.style.display = 'block';

  document.getElementById('deviceName').textContent = dev.name;
  const catEl = document.getElementById('deviceCategory');
  catEl.textContent = dev.category;
  catEl.className = 'device-category ' + catClass;

  document.getElementById('devicePhrase').textContent = '"' + phrase + '"';
  document.getElementById('deviceDefinition').textContent = dev.definition;
  document.getElementById('deviceEffect').textContent = effect;

  const card = document.getElementById('deviceInfoCard');
  card.classList.add('has-content');
  card.style.animation = 'none';
  card.offsetHeight;
  card.style.animation = 'slideInRight 0.4s ease';
}

function showPopup(dev, phrase, effect, catClass, e) {
  const popup = document.getElementById('devicePopup');
  document.getElementById('popupName').textContent = dev.name;
  const catEl = document.getElementById('popupCategory');
  catEl.textContent = dev.category;
  catEl.className = 'device-category ' + catClass;
  document.getElementById('popupPhrase').textContent = '"' + phrase + '"';
  document.getElementById('popupDefinition').textContent = dev.definition;
  document.getElementById('popupEffect').textContent = effect;

  popup.classList.add('visible');

  // Position near click
  const rect = popup.getBoundingClientRect();
  let top = e.clientY - 20;
  let left = e.clientX - 170;
  if (left < 10) left = 10;
  if (left + 340 > window.innerWidth) left = window.innerWidth - 350;
  if (top + 300 > window.innerHeight) top = e.clientY - 320;
  if (top < 10) top = 10;
  popup.style.top = top + 'px';
  popup.style.left = left + 'px';
}

function closePopup() {
  document.getElementById('devicePopup').classList.remove('visible');
}

function resetDeviceInfo() {
  document.getElementById('devicePlaceholder').style.display = '';
  document.getElementById('deviceInfoContent').style.display = 'none';
  document.getElementById('deviceInfoCard').classList.remove('has-content');
  closePopup();
}

// Click outside to deselect
document.addEventListener('click', (e) => {
  if (!e.target.closest('.device-highlight') && !e.target.closest('.device-popup') && !e.target.closest('.device-info-card')) {
    document.querySelectorAll('.device-highlight.selected').forEach(el => el.classList.remove('selected'));
    if (!challengeMode) resetDeviceInfo();
    closePopup();
  }
});

// ========================================================================
// STATISTICS
// ========================================================================
function updateStats() {
  const counts = {};
  allDeviceSpans.forEach(span => {
    const key = span.dataset.deviceKey;
    counts[key] = (counts[key] || 0) + 1;
  });

  const maxCount = Math.max(...Object.values(counts), 1);
  const body = document.getElementById('statsBody');
  body.innerHTML = '';

  // Sort by count descending
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

  if (sorted.length === 0) {
    body.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-light);font-size:0.85rem;">No devices found.</div>';
    return;
  }

  sorted.forEach(([key, count]) => {
    const dev = DEVICES[key];
    if (!dev) return;
    const pct = (count / maxCount) * 100;
    const row = document.createElement('div');
    row.className = 'stat-row';
    row.innerHTML = `
      <span class="stat-dot" style="background:${dev.color}"></span>
      <span class="stat-name">${dev.name}</span>
      <span class="stat-count">${count}</span>
      <span class="stat-bar-bg"><span class="stat-bar-fill" style="width:${pct}%;background:${dev.color}"></span></span>
    `;
    body.appendChild(row);
  });
}

// ========================================================================
// CHALLENGE MODE
// ========================================================================
function toggleChallengeMode() {
  challengeMode = !challengeMode;
  const btn = document.getElementById('challengeToggle');
  const banner = document.getElementById('challengeBanner');
  const textEl = document.getElementById('speechText');

  btn.classList.toggle('active', challengeMode);
  banner.classList.toggle('visible', challengeMode);
  textEl.classList.toggle('challenge-mode', challengeMode);

  if (challengeMode) {
    resetChallenge();
  } else {
    // Restore highlights
    allDeviceSpans.forEach(span => {
      span.classList.remove('revealed-correct', 'revealed-incorrect');
    });
    resetDeviceInfo();
  }
}

function handleChallengeClick(span) {
  const idx = span.dataset.index;
  if (challengeFound.has(idx)) return; // already found

  challengeFound.add(idx);
  span.classList.add('revealed-correct');

  // Briefly show the device info
  const key = span.dataset.deviceKey;
  const dev = DEVICES[key];
  if (dev) {
    const catClass = dev.category === 'Pathos' ? 'cat-pathos' : dev.category === 'Ethos' ? 'cat-ethos' : 'cat-logos';
    if (window.innerWidth < 900) {
      showPopup(dev, span.textContent, span.dataset.effect, catClass, event);
    } else {
      showSidebarInfo(dev, span.textContent, span.dataset.effect, catClass);
    }
  }

  updateChallengeScore();
}

function updateChallengeScore() {
  const total = allDeviceSpans.length;
  const found = challengeFound.size;
  const pct = total > 0 ? Math.round((found / total) * 100) : 0;

  document.getElementById('scoreCorrect').textContent = found;
  document.getElementById('scoreTotal').textContent = total;
  document.getElementById('scorePercent').textContent = pct + '%';
}

function revealAll() {
  allDeviceSpans.forEach(span => {
    const idx = span.dataset.index;
    if (!challengeFound.has(idx)) {
      span.classList.add('revealed-incorrect');
    }
    challengeFound.add(idx);
  });
  updateChallengeScore();
}

function resetChallenge() {
  challengeFound = new Set();
  allDeviceSpans.forEach(span => {
    span.classList.remove('revealed-correct', 'revealed-incorrect');
  });
  updateChallengeScore();
  resetDeviceInfo();
}

// ========================================================================
// LEGEND TOGGLE
// ========================================================================
function toggleLegend() {
  const body = document.getElementById('legendBody');
  const arrow = document.getElementById('legendArrow');
  body.classList.toggle('collapsed');
  arrow.classList.toggle('collapsed');
}

// ========================================================================
// BOOT
// ========================================================================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
