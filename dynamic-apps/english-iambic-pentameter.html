<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iambic Pentameter Scanner</title>
<style>
  :root {
    --bg-parchment: #f5f0e8;
    --bg-parchment-dark: #ece5d8;
    --bg-card: #fffdf7;
    --text-ink: #1a1a2e;
    --text-secondary: #4a4a5e;
    --text-muted: #7a7a8e;
    --accent-burgundy: #7b2d3b;
    --accent-burgundy-light: #a3465a;
    --accent-burgundy-pale: #f0dde1;
    --accent-gold: #c4973b;
    --accent-gold-light: #e8c86a;
    --accent-gold-pale: #faf0d4;
    --success: #2e7d4f;
    --success-pale: #d4edda;
    --error: #a33030;
    --error-pale: #f5d5d5;
    --border: #d4cfc4;
    --border-light: #e8e3d8;
    --shadow: rgba(26, 26, 46, 0.08);
    --shadow-md: rgba(26, 26, 46, 0.12);
    --radius: 8px;
    --radius-lg: 12px;
    --font-serif: 'Georgia', 'Times New Roman', serif;
    --font-sans: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --font-mono: 'Consolas', 'Courier New', monospace;
    --header-height: 80px;
    --max-width: 900px;
    --transition: 0.2s ease;
  }

  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html {
    scroll-behavior: smooth;
    scroll-padding-top: calc(var(--header-height) + 16px);
  }

  body {
    font-family: var(--font-sans);
    background: var(--bg-parchment);
    color: var(--text-ink);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ── Sticky Header ── */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: linear-gradient(135deg, var(--accent-burgundy) 0%, #5a1e2c 100%);
    color: #fff;
    padding: 14px 24px;
    box-shadow: 0 2px 12px var(--shadow-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    min-height: var(--header-height);
  }

  .header-text h1 {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    line-height: 1.2;
  }

  .header-text p {
    font-size: 0.85rem;
    opacity: 0.85;
    margin-top: 2px;
    font-style: italic;
  }

  .header-score {
    text-align: right;
    flex-shrink: 0;
  }

  .header-score .score-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.8;
  }

  .header-score .score-value {
    font-family: var(--font-serif);
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--accent-gold-light);
  }

  /* ── Layout ── */
  .container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 24px 16px 64px;
  }

  /* ── Info Panel ── */
  .info-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent-gold);
    border-radius: var(--radius);
    padding: 0;
    margin-bottom: 28px;
    box-shadow: 0 1px 4px var(--shadow);
    overflow: hidden;
  }

  .info-toggle {
    width: 100%;
    background: none;
    border: none;
    padding: 14px 20px;
    font-family: var(--font-serif);
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--accent-burgundy);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background var(--transition);
  }

  .info-toggle:hover {
    background: var(--accent-gold-pale);
  }

  .info-toggle .chevron {
    font-size: 0.8rem;
    transition: transform var(--transition);
  }

  .info-toggle[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .info-content {
    padding: 0 20px 18px;
    display: none;
  }

  .info-content.open {
    display: block;
  }

  .info-content h3 {
    font-family: var(--font-serif);
    font-size: 1rem;
    color: var(--accent-burgundy);
    margin: 12px 0 6px;
  }

  .info-content h3:first-child {
    margin-top: 0;
  }

  .info-content p, .info-content ul {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }

  .info-content ul {
    padding-left: 20px;
  }

  .info-content li {
    margin-bottom: 4px;
  }

  .info-content code {
    font-family: var(--font-mono);
    background: var(--accent-gold-pale);
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 0.88em;
    color: var(--accent-burgundy);
  }

  .rhythm-example {
    display: flex;
    align-items: center;
    gap: 4px;
    margin: 10px 0;
    flex-wrap: wrap;
  }

  .rhythm-example .foot {
    display: inline-flex;
    align-items: baseline;
    gap: 3px;
    padding: 4px 8px;
    background: var(--bg-parchment);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.9rem;
  }

  .rhythm-example .foot .unstressed {
    color: var(--text-muted);
    font-size: 0.85em;
  }

  .rhythm-example .foot .stressed {
    color: var(--accent-burgundy);
    font-weight: 700;
    font-size: 1.1em;
  }

  .rhythm-example .pipe {
    color: var(--border);
    font-weight: 300;
  }

  /* ── Instructions Bar ── */
  .instructions-bar {
    background: var(--accent-burgundy-pale);
    border: 1px solid #d4b0b8;
    border-radius: var(--radius);
    padding: 12px 18px;
    margin-bottom: 24px;
    font-size: 0.88rem;
    color: var(--accent-burgundy);
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .instructions-bar .icon {
    font-size: 1.2rem;
    flex-shrink: 0;
    margin-top: 1px;
  }

  /* ── Poetry Lines ── */
  .line-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 1px 6px var(--shadow);
    transition: border-color var(--transition), box-shadow var(--transition);
  }

  .line-card.checked-correct {
    border-color: var(--success);
    box-shadow: 0 1px 8px rgba(46, 125, 79, 0.15);
  }

  .line-card.checked-incorrect {
    border-color: var(--error);
    box-shadow: 0 1px 8px rgba(163, 48, 48, 0.12);
  }

  .line-meta {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 8px;
    flex-wrap: wrap;
    gap: 4px 12px;
  }

  .line-number {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .line-source {
    font-size: 0.8rem;
    color: var(--text-muted);
    font-style: italic;
  }

  .line-text {
    font-family: var(--font-serif);
    font-size: 0.95rem;
    color: var(--text-muted);
    margin-bottom: 14px;
    font-style: italic;
    line-height: 1.5;
  }

  /* ── Syllable Grid ── */
  .syllable-row {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 6px;
    align-items: flex-end;
  }

  .syllable-btn {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 6px 7px 4px;
    border: 2px solid var(--border);
    border-radius: 6px;
    background: var(--bg-parchment);
    cursor: pointer;
    transition: all var(--transition);
    user-select: none;
    min-width: 38px;
    position: relative;
    font-family: var(--font-serif);
  }

  .syllable-btn:hover {
    border-color: var(--accent-burgundy-light);
    background: var(--accent-burgundy-pale);
  }

  .syllable-btn:active {
    transform: scale(0.95);
  }

  .syllable-btn .syl-text {
    font-size: 0.88rem;
    color: var(--text-ink);
    line-height: 1.2;
  }

  .syllable-btn .syl-mark {
    font-family: var(--font-mono);
    font-size: 0.92rem;
    font-weight: 700;
    min-height: 1.1em;
    line-height: 1;
    color: var(--text-muted);
  }

  .syllable-btn.stressed {
    border-color: var(--accent-burgundy);
    background: var(--accent-burgundy-pale);
  }

  .syllable-btn.stressed .syl-mark {
    color: var(--accent-burgundy);
  }

  .syllable-btn.unstressed {
    border-color: var(--accent-gold);
    background: var(--accent-gold-pale);
  }

  .syllable-btn.unstressed .syl-mark {
    color: var(--accent-gold);
  }

  /* Feedback states */
  .syllable-btn.correct {
    border-color: var(--success);
    background: var(--success-pale);
  }

  .syllable-btn.correct .syl-mark {
    color: var(--success);
  }

  .syllable-btn.incorrect {
    border-color: var(--error);
    background: var(--error-pale);
  }

  .syllable-btn.incorrect .syl-mark {
    color: var(--error);
  }

  .syllable-btn.answer-shown {
    opacity: 0.85;
    cursor: default;
  }

  /* Word separator */
  .word-gap {
    width: 10px;
    flex-shrink: 0;
  }

  /* ── Waveform Canvas ── */
  .waveform-container {
    margin: 14px 0 12px;
    background: var(--bg-parchment);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    overflow: hidden;
    position: relative;
  }

  .waveform-container canvas {
    display: block;
    width: 100%;
    height: 70px;
  }

  .waveform-label {
    position: absolute;
    top: 4px;
    right: 8px;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    opacity: 0.6;
  }

  /* ── Buttons ── */
  .line-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 4px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-family: var(--font-sans);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    letter-spacing: 0.02em;
  }

  .btn:active {
    transform: scale(0.97);
  }

  .btn-check {
    background: var(--accent-burgundy);
    color: #fff;
  }

  .btn-check:hover {
    background: var(--accent-burgundy-light);
  }

  .btn-check:disabled {
    background: var(--border);
    color: var(--text-muted);
    cursor: not-allowed;
  }

  .btn-show {
    background: transparent;
    color: var(--accent-gold);
    border: 1.5px solid var(--accent-gold);
  }

  .btn-show:hover {
    background: var(--accent-gold-pale);
  }

  .btn-reset {
    background: transparent;
    color: var(--text-muted);
    border: 1.5px solid var(--border);
  }

  .btn-reset:hover {
    background: var(--bg-parchment-dark);
    color: var(--text-secondary);
  }

  /* ── Feedback Message ── */
  .feedback {
    margin-top: 10px;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    display: none;
  }

  .feedback.visible {
    display: block;
  }

  .feedback.perfect {
    background: var(--success-pale);
    color: var(--success);
    border: 1px solid #a8d5b8;
  }

  .feedback.partial {
    background: #fef3d4;
    color: #7a6520;
    border: 1px solid #e0d0a0;
  }

  .feedback.wrong {
    background: var(--error-pale);
    color: var(--error);
    border: 1px solid #daa;
  }

  /* ── Global Actions ── */
  .global-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 32px;
    flex-wrap: wrap;
  }

  .btn-global {
    padding: 12px 28px;
    font-size: 0.95rem;
  }

  /* ── Footer ── */
  .footer {
    text-align: center;
    padding: 24px 16px 20px;
    font-size: 0.78rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border-light);
    margin-top: 12px;
  }

  /* ── Responsive ── */
  @media (max-width: 600px) {
    .header {
      padding: 12px 16px;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      min-height: auto;
    }

    .header-score {
      text-align: left;
    }

    .header-score .score-value {
      font-size: 1.3rem;
    }

    .header-text h1 {
      font-size: 1.25rem;
    }

    .container {
      padding: 16px 12px 48px;
    }

    .line-card {
      padding: 14px;
    }

    .syllable-btn {
      padding: 5px 5px 3px;
      min-width: 32px;
    }

    .syllable-btn .syl-text {
      font-size: 0.8rem;
    }

    .syllable-btn .syl-mark {
      font-size: 0.82rem;
    }

    .word-gap {
      width: 6px;
    }

    .waveform-container canvas {
      height: 55px;
    }
  }

  @media (min-width: 601px) and (max-width: 900px) {
    .syllable-btn {
      min-width: 36px;
    }
  }

  /* ── Accessibility ── */
  .syllable-btn:focus-visible {
    outline: 2px solid var(--accent-burgundy);
    outline-offset: 2px;
  }

  .btn:focus-visible {
    outline: 2px solid var(--accent-burgundy);
    outline-offset: 2px;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    border: 0;
  }

  /* ── Progress Section ── */
  .progress-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 24px;
    box-shadow: 0 1px 4px var(--shadow);
  }

  .progress-bar-track {
    width: 100%;
    height: 8px;
    background: var(--bg-parchment-dark);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 8px;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-burgundy), var(--accent-gold));
    border-radius: 4px;
    transition: width 0.4s ease;
    width: 0%;
  }

  .progress-text {
    font-size: 0.82rem;
    color: var(--text-secondary);
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  .progress-text .progress-detail {
    color: var(--text-muted);
    font-size: 0.78rem;
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-text">
    <h1>Iambic Pentameter Scanner</h1>
    <p>Mark the stressed and unstressed syllables</p>
  </div>
  <div class="header-score">
    <div class="score-label">Lines Correct</div>
    <div class="score-value" id="globalScore">0 / 0</div>
  </div>
</header>

<div class="container">

  <!-- Info Panel -->
  <div class="info-panel">
    <button class="info-toggle" id="infoToggle" aria-expanded="false" aria-controls="infoContent">
      <span>What is iambic pentameter?</span>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="info-content" id="infoContent" role="region">
      <h3>The Basics</h3>
      <p>
        Iambic pentameter is the most common metre in English poetry. Each line consists
        of <strong>five metrical feet</strong> (penta = five), and each foot is an
        <strong>iamb</strong>: one unstressed syllable followed by one stressed syllable.
      </p>

      <h3>The Pattern</h3>
      <p>An iamb sounds like <code>da-DUM</code>. Five iambs give us:</p>
      <div class="rhythm-example">
        <span class="foot"><span class="unstressed">u</span> <span class="stressed">/</span></span>
        <span class="pipe">|</span>
        <span class="foot"><span class="unstressed">u</span> <span class="stressed">/</span></span>
        <span class="pipe">|</span>
        <span class="foot"><span class="unstressed">u</span> <span class="stressed">/</span></span>
        <span class="pipe">|</span>
        <span class="foot"><span class="unstressed">u</span> <span class="stressed">/</span></span>
        <span class="pipe">|</span>
        <span class="foot"><span class="unstressed">u</span> <span class="stressed">/</span></span>
      </div>
      <p>That is: <code>da-DUM da-DUM da-DUM da-DUM da-DUM</code> (ten syllables total).</p>

      <h3>How to Scan</h3>
      <ul>
        <li>Read the line aloud. Listen for the natural rhythm of stressed and unstressed syllables.</li>
        <li>Click each syllable to mark it as <strong>unstressed</strong> (<code>u</code>) or <strong>stressed</strong> (<code>/</code>).</li>
        <li>In perfect iambic pentameter, the pattern alternates: u / u / u / u / u /</li>
        <li>Watch the waveform below each line to visualise your scansion.</li>
      </ul>

      <h3>Tips</h3>
      <ul>
        <li>Stressed syllables are louder, longer, or higher in pitch.</li>
        <li>Content words (nouns, verbs, adjectives) tend to be stressed.</li>
        <li>Function words (the, of, and, to) tend to be unstressed.</li>
        <li>Some lines have subtle variations; focus on the dominant pattern.</li>
      </ul>
    </div>
  </div>

  <!-- Instructions -->
  <div class="instructions-bar">
    <span class="icon" aria-hidden="true">&#9998;</span>
    <span>Click each syllable to cycle through: <strong>unmarked</strong> &rarr; <strong>unstressed (u)</strong> &rarr; <strong>stressed (/)</strong>. Then press <strong>Check</strong> to see how you did.</span>
  </div>

  <!-- Progress -->
  <div class="progress-section">
    <div class="progress-text">
      <span id="progressLabel">0 of 10 lines attempted</span>
      <span class="progress-detail" id="progressDetail"></span>
    </div>
    <div class="progress-bar-track">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Lines Container -->
  <div id="linesContainer"></div>

  <!-- Global Actions -->
  <div class="global-actions">
    <button class="btn btn-check btn-global" id="checkAllBtn" onclick="checkAll()">Check All Lines</button>
    <button class="btn btn-show btn-global" id="showAllBtn" onclick="showAllAnswers()">Show All Answers</button>
    <button class="btn btn-reset btn-global" id="resetAllBtn" onclick="resetAll()">Reset All</button>
  </div>

  <footer class="footer">
    Iambic Pentameter Scanner. An educational tool for studying English verse metre.
  </footer>
</div>

<script>
(function() {
  'use strict';

  // ═══════════════════════════════════════════════
  //  POETRY DATA
  //  Each line: text, syllables with stress pattern
  //  Stress: 1 = stressed, 0 = unstressed
  // ═══════════════════════════════════════════════

  const POETRY_LINES = [
    {
      text: "Shall I compare thee to a summer's day?",
      source: "Shakespeare, Sonnet 18",
      syllables: [
        { text: "Shall", stress: 0 },
        { text: "I", stress: 1 },
        { text: "com", stress: 0 },
        { text: "pare", stress: 1 },
        { text: "thee", stress: 0 },
        { text: "to", stress: 1 },
        { text: "a", stress: 0 },
        { text: "sum", stress: 1 },
        { text: "mer's", stress: 0 },
        { text: "day?", stress: 1 }
      ]
    },
    {
      text: "But soft, what light through yonder window breaks?",
      source: "Shakespeare, Romeo and Juliet",
      syllables: [
        { text: "But", stress: 0 },
        { text: "soft,", stress: 1 },
        { text: "what", stress: 0 },
        { text: "light", stress: 1 },
        { text: "through", stress: 0 },
        { text: "yon", stress: 1 },
        { text: "der", stress: 0 },
        { text: "win", stress: 1 },
        { text: "dow", stress: 0 },
        { text: "breaks?", stress: 1 }
      ]
    },
    {
      text: "When I do count the clock that tells the time",
      source: "Shakespeare, Sonnet 12",
      syllables: [
        { text: "When", stress: 0 },
        { text: "I", stress: 1 },
        { text: "do", stress: 0 },
        { text: "count", stress: 1 },
        { text: "the", stress: 0 },
        { text: "clock", stress: 1 },
        { text: "that", stress: 0 },
        { text: "tells", stress: 1 },
        { text: "the", stress: 0 },
        { text: "time", stress: 1 }
      ]
    },
    {
      text: "Of man's first disobedience, and the fruit",
      source: "Milton, Paradise Lost",
      syllables: [
        { text: "Of", stress: 0 },
        { text: "man's", stress: 1 },
        { text: "first", stress: 0 },
        { text: "dis", stress: 1 },
        { text: "o", stress: 0 },
        { text: "be", stress: 1 },
        { text: "di", stress: 0 },
        { text: "ence,", stress: 1 },
        { text: "and", stress: 0 },
        { text: "the", stress: 0 },
        { text: "fruit", stress: 1 }
      ]
    },
    {
      text: "A thing of beauty is a joy for ever",
      source: "Keats, Endymion",
      syllables: [
        { text: "A", stress: 0 },
        { text: "thing", stress: 1 },
        { text: "of", stress: 0 },
        { text: "beau", stress: 1 },
        { text: "ty", stress: 0 },
        { text: "is", stress: 1 },
        { text: "a", stress: 0 },
        { text: "joy", stress: 1 },
        { text: "for", stress: 0 },
        { text: "ev", stress: 1 },
        { text: "er", stress: 0 }
      ]
    },
    {
      text: "My mistress' eyes are nothing like the sun",
      source: "Shakespeare, Sonnet 130",
      syllables: [
        { text: "My", stress: 0 },
        { text: "mis", stress: 1 },
        { text: "tress'", stress: 0 },
        { text: "eyes", stress: 1 },
        { text: "are", stress: 0 },
        { text: "noth", stress: 1 },
        { text: "ing", stress: 0 },
        { text: "like", stress: 1 },
        { text: "the", stress: 0 },
        { text: "sun", stress: 1 }
      ]
    },
    {
      text: "To be, or not to be: that is the question",
      source: "Shakespeare, Hamlet",
      syllables: [
        { text: "To", stress: 0 },
        { text: "be,", stress: 1 },
        { text: "or", stress: 0 },
        { text: "not", stress: 1 },
        { text: "to", stress: 0 },
        { text: "be:", stress: 1 },
        { text: "that", stress: 0 },
        { text: "is", stress: 1 },
        { text: "the", stress: 0 },
        { text: "ques", stress: 1 },
        { text: "tion", stress: 0 }
      ]
    },
    {
      text: "Let me not to the marriage of true minds",
      source: "Shakespeare, Sonnet 116",
      syllables: [
        { text: "Let", stress: 0 },
        { text: "me", stress: 1 },
        { text: "not", stress: 0 },
        { text: "to", stress: 1 },
        { text: "the", stress: 0 },
        { text: "mar", stress: 1 },
        { text: "riage", stress: 0 },
        { text: "of", stress: 1 },
        { text: "true", stress: 0 },
        { text: "minds", stress: 1 }
      ]
    },
    {
      text: "If music be the food of love, play on",
      source: "Shakespeare, Twelfth Night",
      syllables: [
        { text: "If", stress: 0 },
        { text: "mu", stress: 1 },
        { text: "sic", stress: 0 },
        { text: "be", stress: 1 },
        { text: "the", stress: 0 },
        { text: "food", stress: 1 },
        { text: "of", stress: 0 },
        { text: "love,", stress: 1 },
        { text: "play", stress: 0 },
        { text: "on", stress: 1 }
      ]
    },
    {
      text: "How do I love thee? Let me count the ways",
      source: "Browning, Sonnet 43",
      syllables: [
        { text: "How", stress: 0 },
        { text: "do", stress: 1 },
        { text: "I", stress: 0 },
        { text: "love", stress: 1 },
        { text: "thee?", stress: 0 },
        { text: "Let", stress: 1 },
        { text: "me", stress: 0 },
        { text: "count", stress: 1 },
        { text: "the", stress: 0 },
        { text: "ways", stress: 1 }
      ]
    }
  ];

  // ═══════════════════════════════════════════════
  //  STATE
  // ═══════════════════════════════════════════════

  // For each line, store the user's markings
  // null = unmarked, 0 = unstressed, 1 = stressed
  const lineStates = POETRY_LINES.map(line => ({
    markings: new Array(line.syllables.length).fill(null),
    checked: false,
    revealed: false,
    correct: false
  }));

  let linesCorrect = 0;
  let linesAttempted = 0;

  // ═══════════════════════════════════════════════
  //  RENDER
  // ═══════════════════════════════════════════════

  function buildUI() {
    const container = document.getElementById('linesContainer');
    container.innerHTML = '';

    POETRY_LINES.forEach((line, lineIdx) => {
      const card = document.createElement('div');
      card.className = 'line-card';
      card.id = 'line-' + lineIdx;

      // Meta
      const meta = document.createElement('div');
      meta.className = 'line-meta';
      meta.innerHTML =
        '<span class="line-number">Line ' + (lineIdx + 1) + '</span>' +
        '<span class="line-source">' + escapeHtml(line.source) + '</span>';
      card.appendChild(meta);

      // Full text
      const textEl = document.createElement('div');
      textEl.className = 'line-text';
      textEl.textContent = line.text;
      card.appendChild(textEl);

      // Syllable buttons
      const sylRow = document.createElement('div');
      sylRow.className = 'syllable-row';
      sylRow.setAttribute('role', 'group');
      sylRow.setAttribute('aria-label', 'Syllables for line ' + (lineIdx + 1));

      // Figure out word boundaries for spacing
      const wordBoundaries = computeWordBoundaries(line);

      line.syllables.forEach((syl, sylIdx) => {
        // Insert word gap before this syllable if it starts a new word
        if (sylIdx > 0 && wordBoundaries[sylIdx]) {
          const gap = document.createElement('span');
          gap.className = 'word-gap';
          gap.setAttribute('aria-hidden', 'true');
          sylRow.appendChild(gap);
        }

        const btn = document.createElement('button');
        btn.className = 'syllable-btn';
        btn.type = 'button';
        btn.id = 'syl-' + lineIdx + '-' + sylIdx;
        btn.setAttribute('aria-label', syl.text + ', unmarked');
        btn.onclick = function() { toggleSyllable(lineIdx, sylIdx); };

        const markSpan = document.createElement('span');
        markSpan.className = 'syl-mark';
        markSpan.id = 'mark-' + lineIdx + '-' + sylIdx;
        markSpan.textContent = '\u00A0';
        markSpan.setAttribute('aria-hidden', 'true');

        const textSpan = document.createElement('span');
        textSpan.className = 'syl-text';
        textSpan.textContent = syl.text;

        btn.appendChild(markSpan);
        btn.appendChild(textSpan);
        sylRow.appendChild(btn);
      });

      card.appendChild(sylRow);

      // Waveform
      const waveContainer = document.createElement('div');
      waveContainer.className = 'waveform-container';

      const canvas = document.createElement('canvas');
      canvas.id = 'wave-' + lineIdx;
      canvas.width = 800;
      canvas.height = 70;
      waveContainer.appendChild(canvas);

      const waveLabel = document.createElement('span');
      waveLabel.className = 'waveform-label';
      waveLabel.textContent = 'rhythm';
      waveContainer.appendChild(waveLabel);

      card.appendChild(waveContainer);

      // Feedback
      const feedback = document.createElement('div');
      feedback.className = 'feedback';
      feedback.id = 'feedback-' + lineIdx;
      card.appendChild(feedback);

      // Action buttons
      const actions = document.createElement('div');
      actions.className = 'line-actions';

      const checkBtn = document.createElement('button');
      checkBtn.className = 'btn btn-check';
      checkBtn.id = 'checkBtn-' + lineIdx;
      checkBtn.textContent = 'Check';
      checkBtn.onclick = function() { checkLine(lineIdx); };

      const showBtn = document.createElement('button');
      showBtn.className = 'btn btn-show';
      showBtn.id = 'showBtn-' + lineIdx;
      showBtn.textContent = 'Show Answer';
      showBtn.onclick = function() { showAnswer(lineIdx); };

      const resetBtn = document.createElement('button');
      resetBtn.className = 'btn btn-reset';
      resetBtn.id = 'resetBtn-' + lineIdx;
      resetBtn.textContent = 'Reset';
      resetBtn.onclick = function() { resetLine(lineIdx); };

      actions.appendChild(checkBtn);
      actions.appendChild(showBtn);
      actions.appendChild(resetBtn);
      card.appendChild(actions);

      container.appendChild(card);
    });

    // Draw initial (empty) waveforms
    POETRY_LINES.forEach((_, i) => drawWaveform(i));
    updateGlobalScore();
    updateProgress();
  }

  /**
   * Determine which syllables begin a new word.
   * We rebuild the original text from syllables to find word splits.
   */
  function computeWordBoundaries(line) {
    const words = line.text.replace(/[^a-zA-Z'\u2019 ]/g, ' ').split(/\s+/).filter(Boolean);
    const boundaries = new Array(line.syllables.length).fill(false);
    let sylIndex = 0;

    for (let w = 0; w < words.length; w++) {
      if (w > 0 && sylIndex < boundaries.length) {
        boundaries[sylIndex] = true;
      }
      // Count how many syllables belong to this word
      const wordClean = words[w].toLowerCase().replace(/[^a-z']/g, '');
      let consumed = '';
      while (sylIndex < line.syllables.length) {
        const sylClean = line.syllables[sylIndex].text.toLowerCase().replace(/[^a-z']/g, '');
        consumed += sylClean;
        sylIndex++;
        if (consumed.length >= wordClean.length) break;
      }
    }

    return boundaries;
  }

  // ═══════════════════════════════════════════════
  //  INTERACTION
  // ═══════════════════════════════════════════════

  function toggleSyllable(lineIdx, sylIdx) {
    const state = lineStates[lineIdx];

    // Don't allow changes if already checked or revealed
    if (state.checked || state.revealed) return;

    const current = state.markings[sylIdx];
    // Cycle: null -> 0 (unstressed) -> 1 (stressed) -> null
    let next;
    if (current === null) {
      next = 0;
    } else if (current === 0) {
      next = 1;
    } else {
      next = null;
    }
    state.markings[sylIdx] = next;

    updateSyllableDisplay(lineIdx, sylIdx);
    drawWaveform(lineIdx);
  }

  function updateSyllableDisplay(lineIdx, sylIdx) {
    const state = lineStates[lineIdx];
    const marking = state.markings[sylIdx];
    const btn = document.getElementById('syl-' + lineIdx + '-' + sylIdx);
    const mark = document.getElementById('mark-' + lineIdx + '-' + sylIdx);

    // Clear classes
    btn.classList.remove('stressed', 'unstressed', 'correct', 'incorrect', 'answer-shown');

    if (marking === null) {
      mark.textContent = '\u00A0';
      btn.setAttribute('aria-label', POETRY_LINES[lineIdx].syllables[sylIdx].text + ', unmarked');
    } else if (marking === 0) {
      mark.textContent = 'u';
      btn.classList.add('unstressed');
      btn.setAttribute('aria-label', POETRY_LINES[lineIdx].syllables[sylIdx].text + ', unstressed');
    } else {
      mark.textContent = '/';
      btn.classList.add('stressed');
      btn.setAttribute('aria-label', POETRY_LINES[lineIdx].syllables[sylIdx].text + ', stressed');
    }
  }

  // ═══════════════════════════════════════════════
  //  CHECK / SHOW / RESET
  // ═══════════════════════════════════════════════

  function checkLine(lineIdx) {
    const state = lineStates[lineIdx];
    const line = POETRY_LINES[lineIdx];

    // Must have all syllables marked
    const allMarked = state.markings.every(m => m !== null);
    if (!allMarked) {
      showFeedback(lineIdx, 'Please mark all syllables before checking.', 'partial');
      return;
    }

    if (state.checked) return;

    state.checked = true;
    let correctCount = 0;

    line.syllables.forEach((syl, sylIdx) => {
      const btn = document.getElementById('syl-' + lineIdx + '-' + sylIdx);
      btn.classList.remove('stressed', 'unstressed');

      if (state.markings[sylIdx] === syl.stress) {
        btn.classList.add('correct');
        correctCount++;
      } else {
        btn.classList.add('incorrect');
      }
    });

    const total = line.syllables.length;
    state.correct = correctCount === total;

    const card = document.getElementById('line-' + lineIdx);
    card.classList.remove('checked-correct', 'checked-incorrect');

    if (correctCount === total) {
      showFeedback(lineIdx, 'Perfect! All ' + total + ' syllables correctly scanned.', 'perfect');
      card.classList.add('checked-correct');
    } else if (correctCount >= total * 0.7) {
      showFeedback(lineIdx, correctCount + ' of ' + total + ' syllables correct. Close! Check the red syllables.', 'partial');
      card.classList.add('checked-incorrect');
    } else {
      showFeedback(lineIdx, correctCount + ' of ' + total + ' syllables correct. Try the "Show Answer" button to study the pattern.', 'wrong');
      card.classList.add('checked-incorrect');
    }

    // Disable check button
    document.getElementById('checkBtn-' + lineIdx).disabled = true;

    updateGlobalScore();
    updateProgress();
  }

  function showAnswer(lineIdx) {
    const state = lineStates[lineIdx];
    const line = POETRY_LINES[lineIdx];

    state.revealed = true;

    line.syllables.forEach((syl, sylIdx) => {
      state.markings[sylIdx] = syl.stress;
      const btn = document.getElementById('syl-' + lineIdx + '-' + sylIdx);
      const mark = document.getElementById('mark-' + lineIdx + '-' + sylIdx);

      btn.classList.remove('stressed', 'unstressed', 'correct', 'incorrect');
      btn.classList.add('answer-shown');

      if (syl.stress === 1) {
        btn.classList.add('stressed');
        mark.textContent = '/';
      } else {
        btn.classList.add('unstressed');
        mark.textContent = 'u';
      }
    });

    if (!state.checked) {
      showFeedback(lineIdx, 'Answer revealed. Study the pattern, then try resetting to attempt it yourself.', 'partial');
    }

    document.getElementById('checkBtn-' + lineIdx).disabled = true;
    drawWaveform(lineIdx);

    const card = document.getElementById('line-' + lineIdx);
    card.classList.remove('checked-correct', 'checked-incorrect');

    updateProgress();
  }

  function resetLine(lineIdx) {
    const state = lineStates[lineIdx];
    const line = POETRY_LINES[lineIdx];
    const wasChecked = state.checked;

    state.markings = new Array(line.syllables.length).fill(null);
    state.checked = false;
    state.revealed = false;
    state.correct = false;

    line.syllables.forEach((_, sylIdx) => {
      updateSyllableDisplay(lineIdx, sylIdx);
    });

    const card = document.getElementById('line-' + lineIdx);
    card.classList.remove('checked-correct', 'checked-incorrect');

    hideFeedback(lineIdx);
    document.getElementById('checkBtn-' + lineIdx).disabled = false;
    drawWaveform(lineIdx);

    if (wasChecked) {
      updateGlobalScore();
      updateProgress();
    }
  }

  function showFeedback(lineIdx, message, type) {
    const el = document.getElementById('feedback-' + lineIdx);
    el.textContent = message;
    el.className = 'feedback visible ' + type;
  }

  function hideFeedback(lineIdx) {
    const el = document.getElementById('feedback-' + lineIdx);
    el.className = 'feedback';
  }

  // ═══════════════════════════════════════════════
  //  GLOBAL ACTIONS
  // ═══════════════════════════════════════════════

  window.checkAll = function() {
    POETRY_LINES.forEach((_, i) => {
      if (!lineStates[i].checked && !lineStates[i].revealed) {
        checkLine(i);
      }
    });
  };

  window.showAllAnswers = function() {
    POETRY_LINES.forEach((_, i) => {
      if (!lineStates[i].revealed) {
        showAnswer(i);
      }
    });
  };

  window.resetAll = function() {
    POETRY_LINES.forEach((_, i) => resetLine(i));
  };

  // ═══════════════════════════════════════════════
  //  SCORING & PROGRESS
  // ═══════════════════════════════════════════════

  function updateGlobalScore() {
    linesCorrect = 0;
    linesAttempted = 0;

    lineStates.forEach(state => {
      if (state.checked) {
        linesAttempted++;
        if (state.correct) linesCorrect++;
      }
    });

    document.getElementById('globalScore').textContent =
      linesCorrect + ' / ' + linesAttempted;
  }

  function updateProgress() {
    const total = POETRY_LINES.length;
    let attempted = 0;
    lineStates.forEach(state => {
      if (state.checked || state.revealed) attempted++;
    });

    const pct = total > 0 ? Math.round((attempted / total) * 100) : 0;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressLabel').textContent =
      attempted + ' of ' + total + ' lines attempted';

    if (attempted > 0 && linesAttempted > 0) {
      document.getElementById('progressDetail').textContent =
        Math.round((linesCorrect / linesAttempted) * 100) + '% accuracy';
    } else {
      document.getElementById('progressDetail').textContent = '';
    }
  }

  // ═══════════════════════════════════════════════
  //  WAVEFORM DRAWING
  // ═══════════════════════════════════════════════

  function drawWaveform(lineIdx) {
    const canvas = document.getElementById('wave-' + lineIdx);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const state = lineStates[lineIdx];
    const syls = POETRY_LINES[lineIdx].syllables;
    const n = syls.length;

    // Get display dimensions
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const displayWidth = Math.floor(rect.width);
    const displayHeight = 70;

    canvas.width = displayWidth * dpr;
    canvas.height = displayHeight * dpr;
    canvas.style.width = displayWidth + 'px';
    canvas.style.height = displayHeight + 'px';
    ctx.scale(dpr, dpr);

    // Clear
    ctx.clearRect(0, 0, displayWidth, displayHeight);

    const midY = displayHeight / 2;
    const amplitude = 18;
    const padX = 24;
    const usableWidth = displayWidth - padX * 2;
    const stepWidth = n > 1 ? usableWidth / (n - 1) : usableWidth;

    // Draw centre line
    ctx.beginPath();
    ctx.strokeStyle = '#d4cfc4';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.moveTo(padX, midY);
    ctx.lineTo(padX + usableWidth, midY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Collect points
    const points = [];
    let hasAnyMarking = false;

    for (let i = 0; i < n; i++) {
      const x = n > 1 ? padX + i * stepWidth : padX + usableWidth / 2;
      const marking = state.markings[i];
      let y;

      if (marking === null) {
        y = midY;
      } else if (marking === 1) {
        y = midY - amplitude;
        hasAnyMarking = true;
      } else {
        y = midY + amplitude;
        hasAnyMarking = true;
      }

      points.push({ x, y, marking });
    }

    if (!hasAnyMarking) {
      // Draw placeholder dots
      ctx.fillStyle = '#c4c0b6';
      points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
        ctx.fill();
      });
      return;
    }

    // Draw smooth curve
    ctx.beginPath();
    ctx.strokeStyle = 'var(--accent-burgundy)';
    ctx.lineWidth = 2.5;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';

    // Use the CSS variable properly
    const burgundy = getComputedStyle(document.documentElement).getPropertyValue('--accent-burgundy').trim();
    const gold = getComputedStyle(document.documentElement).getPropertyValue('--accent-gold').trim();
    ctx.strokeStyle = burgundy;

    if (points.length === 1) {
      ctx.beginPath();
      ctx.arc(points[0].x, points[0].y, 4, 0, Math.PI * 2);
      ctx.fillStyle = burgundy;
      ctx.fill();
    } else {
      // Draw smooth curve using cubic bezier
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);

      for (let i = 0; i < points.length - 1; i++) {
        const curr = points[i];
        const next = points[i + 1];
        const cpx = (curr.x + next.x) / 2;
        ctx.bezierCurveTo(cpx, curr.y, cpx, next.y, next.x, next.y);
      }

      ctx.stroke();

      // Fill area under/above midline
      const gradient = ctx.createLinearGradient(0, midY - amplitude, 0, midY + amplitude);
      gradient.addColorStop(0, 'rgba(123, 45, 59, 0.12)');
      gradient.addColorStop(0.5, 'rgba(123, 45, 59, 0.02)');
      gradient.addColorStop(1, 'rgba(196, 151, 59, 0.12)');

      ctx.beginPath();
      ctx.moveTo(points[0].x, midY);
      ctx.lineTo(points[0].x, points[0].y);

      for (let i = 0; i < points.length - 1; i++) {
        const curr = points[i];
        const next = points[i + 1];
        const cpx = (curr.x + next.x) / 2;
        ctx.bezierCurveTo(cpx, curr.y, cpx, next.y, next.x, next.y);
      }

      ctx.lineTo(points[points.length - 1].x, midY);
      ctx.closePath();
      ctx.fillStyle = gradient;
      ctx.fill();
    }

    // Draw dots at each point
    points.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);

      if (p.marking === 1) {
        ctx.fillStyle = burgundy;
      } else if (p.marking === 0) {
        ctx.fillStyle = gold;
      } else {
        ctx.fillStyle = '#c4c0b6';
      }
      ctx.fill();

      // White inner ring
      ctx.beginPath();
      ctx.arc(p.x, p.y, 1.5, 0, Math.PI * 2);
      ctx.fillStyle = '#fff';
      ctx.fill();
    });

    // Draw "stressed" / "unstressed" labels at extremes
    ctx.font = '9px ' + getComputedStyle(document.documentElement).getPropertyValue('--font-sans').trim();
    ctx.textAlign = 'center';

    const topLabel = midY - amplitude - 8;
    const botLabel = midY + amplitude + 12;

    if (topLabel > 2) {
      ctx.fillStyle = 'rgba(123, 45, 59, 0.4)';
      ctx.fillText('stressed', displayWidth / 2, topLabel);
    }
    if (botLabel < displayHeight - 2) {
      ctx.fillStyle = 'rgba(196, 151, 59, 0.4)';
      ctx.fillText('unstressed', displayWidth / 2, botLabel);
    }
  }

  // Redraw all waveforms on resize
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      POETRY_LINES.forEach((_, i) => drawWaveform(i));
    }, 100);
  });

  // ═══════════════════════════════════════════════
  //  INFO PANEL TOGGLE
  // ═══════════════════════════════════════════════

  document.getElementById('infoToggle').addEventListener('click', function() {
    const content = document.getElementById('infoContent');
    const expanded = this.getAttribute('aria-expanded') === 'true';
    this.setAttribute('aria-expanded', !expanded);
    content.classList.toggle('open');
  });

  // ═══════════════════════════════════════════════
  //  UTILITIES
  // ═══════════════════════════════════════════════

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ═══════════════════════════════════════════════
  //  INITIALISE
  // ═══════════════════════════════════════════════

  buildUI();

})();
</script>
</body>
</html>
