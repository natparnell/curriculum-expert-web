<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Friendship Network Mapper</title>
<style>
    :root {
        --orange-50: #fff7ed;
        --orange-400: #fb923c;
        --orange-500: #f97316;
        --orange-600: #ea580c;
        --orange-700: #c2410c;
        --teal-50: #f0fdfa;
        --teal-400: #2dd4bf;
        --teal-500: #14b8a6;
        --teal-600: #0d9488;
        --teal-700: #0f766e;
        --teal-800: #115e59;
        --blue-card: #3b82f6;
        --green-card: #22c55e;
        --orange-card: #f97316;
        --purple-card: #a855f7;
        --grey-100: #f3f4f6;
        --grey-200: #e5e7eb;
        --grey-300: #d1d5db;
        --grey-400: #9ca3af;
        --grey-500: #6b7280;
        --grey-600: #4b5563;
        --grey-700: #374151;
        --grey-800: #1f2937;
        --radius: 10px;
        --shadow: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--grey-100);
        color: var(--grey-800);
        line-height: 1.5;
        min-height: 100vh;
    }

    header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: linear-gradient(135deg, var(--teal-700), var(--teal-600));
        color: white;
        padding: 14px 24px;
        box-shadow: var(--shadow-lg);
    }

    header h1 {
        font-size: 1.35rem;
        font-weight: 700;
        letter-spacing: -0.3px;
    }

    header p {
        font-size: 0.82rem;
        opacity: 0.88;
        margin-top: 2px;
    }

    .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
    }

    .header-actions {
        display: flex;
        gap: 8px;
    }

    .btn {
        padding: 7px 16px;
        border: none;
        border-radius: var(--radius);
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-white {
        background: white;
        color: var(--teal-700);
    }

    .btn-white:hover { background: var(--teal-50); }

    .btn-orange {
        background: var(--orange-500);
        color: white;
    }

    .btn-orange:hover { background: var(--orange-600); }

    .btn-outline {
        background: transparent;
        color: white;
        border: 1.5px solid rgba(255,255,255,0.5);
    }

    .btn-outline:hover { background: rgba(255,255,255,0.15); }

    .btn-sm {
        padding: 5px 12px;
        font-size: 0.78rem;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover { background: #dc2626; }

    .layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 0;
        min-height: calc(100vh - 70px);
    }

    .sidebar {
        background: white;
        border-right: 1px solid var(--grey-200);
        overflow-y: auto;
        max-height: calc(100vh - 70px);
    }

    .sidebar-section {
        padding: 18px;
        border-bottom: 1px solid var(--grey-200);
    }

    .sidebar-section h3 {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--grey-500);
        margin-bottom: 12px;
    }

    .add-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .add-form input, .add-form select {
        padding: 8px 12px;
        border: 1.5px solid var(--grey-300);
        border-radius: var(--radius);
        font-size: 0.88rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .add-form input:focus, .add-form select:focus {
        border-color: var(--teal-500);
    }

    .add-form .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .card-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 8px;
    }

    .person-card {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: var(--radius);
        background: var(--grey-50, #f9fafb);
        border: 1.5px solid var(--grey-200);
        cursor: grab;
        transition: all 0.2s;
        font-size: 0.85rem;
        user-select: none;
    }

    .person-card:hover {
        border-color: var(--teal-400);
        box-shadow: var(--shadow);
    }

    .person-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .person-card .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .person-card .name { flex: 1; font-weight: 500; }

    .person-card .ring-label {
        font-size: 0.72rem;
        color: var(--grey-400);
        background: var(--grey-200);
        padding: 1px 6px;
        border-radius: 4px;
    }

    .person-card .remove-btn {
        background: none;
        border: none;
        color: var(--grey-400);
        cursor: pointer;
        font-size: 1rem;
        padding: 0 2px;
        line-height: 1;
    }

    .person-card .remove-btn:hover { color: #ef4444; }

    .dot-family { background: var(--blue-card); }
    .dot-school { background: var(--green-card); }
    .dot-outside { background: var(--orange-card); }
    .dot-adult { background: var(--purple-card); }

    .legend {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.78rem;
        color: var(--grey-600);
    }

    .legend-item .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .score-panel {
        background: linear-gradient(135deg, var(--teal-50), var(--orange-50));
        border-radius: var(--radius);
        padding: 14px;
    }

    .score-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--teal-700);
    }

    .score-label {
        font-size: 0.78rem;
        color: var(--grey-500);
        margin-bottom: 8px;
    }

    .score-bar {
        height: 8px;
        background: var(--grey-200);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 6px;
    }

    .score-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
        background: linear-gradient(90deg, var(--teal-500), var(--orange-400));
    }

    .score-details {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .score-detail {
        display: flex;
        justify-content: space-between;
        font-size: 0.78rem;
        color: var(--grey-600);
    }

    .reflection-box {
        background: var(--orange-50);
        border-left: 3px solid var(--orange-400);
        padding: 12px;
        border-radius: 0 var(--radius) var(--radius) 0;
        font-size: 0.82rem;
        color: var(--grey-700);
        line-height: 1.6;
    }

    .tips-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .tips-list li {
        font-size: 0.82rem;
        padding-left: 20px;
        position: relative;
        color: var(--grey-600);
    }

    .tips-list li::before {
        content: '\2713';
        position: absolute;
        left: 0;
        color: var(--teal-500);
        font-weight: 700;
    }

    .canvas-area {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--grey-100);
        overflow: hidden;
        min-height: 500px;
    }

    .canvas-area svg {
        width: 100%;
        height: 100%;
        max-width: 620px;
        max-height: 620px;
    }

    .ring-label-text { font-size: 11px; fill: var(--grey-400); text-anchor: middle; pointer-events: none; }
    .svg-person { cursor: grab; }
    .svg-person:active { cursor: grabbing; }
    .svg-person circle { transition: r 0.15s; }
    .svg-person:hover circle { r: 22; }
    .svg-person text { font-size: 10px; fill: var(--grey-800); text-anchor: middle; pointer-events: none; font-weight: 600; }
    .connection-line { stroke: var(--grey-300); stroke-width: 1; stroke-dasharray: 4 3; opacity: 0.5; }

    .drop-zone-indicator { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    .drop-zone-indicator.active { opacity: 0.15; }

    .info-panel {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 200;
        background: rgba(0,0,0,0.4);
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .info-panel.open { display: flex; }

    .info-content {
        background: white;
        border-radius: 14px;
        max-width: 600px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        padding: 28px;
        box-shadow: var(--shadow-lg);
    }

    .info-content h2 {
        font-size: 1.2rem;
        color: var(--teal-700);
        margin-bottom: 16px;
    }

    .info-content h4 {
        font-size: 0.92rem;
        color: var(--orange-600);
        margin: 16px 0 6px;
    }

    .info-content p, .info-content li {
        font-size: 0.88rem;
        color: var(--grey-600);
        line-height: 1.7;
    }

    .info-content ul {
        padding-left: 20px;
        margin: 6px 0;
    }

    .info-close {
        float: right;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--grey-400);
        line-height: 1;
    }

    .info-close:hover { color: var(--grey-700); }

    .empty-state {
        text-align: center;
        color: var(--grey-400);
        font-size: 0.88rem;
        padding: 40px 20px;
        pointer-events: none;
    }

    .empty-state p { margin-top: 8px; }

    @media (max-width: 768px) {
        .layout {
            grid-template-columns: 1fr;
        }

        .sidebar {
            max-height: none;
            border-right: none;
            border-bottom: 2px solid var(--grey-200);
        }

        .canvas-area {
            min-height: 420px;
            padding: 10px;
        }

        header h1 { font-size: 1.15rem; }

        .sidebar-section { padding: 14px; }
    }
</style>
</head>
<body>

<header>
    <div class="header-row">
        <div>
            <h1>Friendship Network Mapper</h1>
            <p>Build and reflect on your social support network</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="openInfo()">About</button>
            <button class="btn btn-white" onclick="resetAll()">Reset</button>
        </div>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <!-- Add person -->
        <div class="sidebar-section">
            <h3>Add a person</h3>
            <div class="add-form">
                <input type="text" id="nameInput" placeholder="Name (e.g. Mum, Jake, Mrs Patel)" maxlength="20">
                <div class="form-row">
                    <select id="typeSelect">
                        <option value="family">Family</option>
                        <option value="school">School friend</option>
                        <option value="outside">Out-of-school friend</option>
                        <option value="adult">Trusted adult</option>
                    </select>
                    <select id="ringSelect">
                        <option value="inner">Close friends</option>
                        <option value="middle">Wider circle</option>
                        <option value="outer">Trusted adults</option>
                    </select>
                </div>
                <button class="btn btn-orange" onclick="addPerson()">Add to network</button>
            </div>
        </div>

        <!-- Legend -->
        <div class="sidebar-section">
            <h3>Colour key</h3>
            <div class="legend">
                <div class="legend-item"><span class="dot dot-family"></span> Family</div>
                <div class="legend-item"><span class="dot dot-school"></span> School friend</div>
                <div class="legend-item"><span class="dot dot-outside"></span> Out-of-school friend</div>
                <div class="legend-item"><span class="dot dot-adult"></span> Trusted adult</div>
            </div>
        </div>

        <!-- Network health -->
        <div class="sidebar-section">
            <h3>Network health</h3>
            <div class="score-panel">
                <div class="score-label">Overall score</div>
                <div class="score-value" id="scoreValue">0<span style="font-size:1rem;font-weight:400;color:var(--grey-500)">/100</span></div>
                <div class="score-bar"><div class="score-bar-fill" id="scoreBar" style="width:0%"></div></div>
                <div class="score-details" id="scoreDetails"></div>
            </div>
        </div>

        <!-- Reflection -->
        <div class="sidebar-section">
            <h3>Reflection</h3>
            <div class="reflection-box" id="reflectionBox">
                Add some people to your network to see personalised reflection prompts about your support system.
            </div>
        </div>

        <!-- People list -->
        <div class="sidebar-section">
            <h3>Your network <span id="personCount" style="color:var(--grey-400);font-weight:400">(0)</span></h3>
            <div class="card-list" id="cardList">
                <div style="color:var(--grey-400);font-size:0.82rem;">No people added yet.</div>
            </div>
        </div>

        <!-- Tips -->
        <div class="sidebar-section">
            <h3>Tips for building connections</h3>
            <ul class="tips-list">
                <li>Join a club or group activity to meet people outside school</li>
                <li>Keep in regular contact: a quick message or check-in goes a long way</li>
                <li>Be a good listener; ask questions and show genuine interest</li>
                <li>Make sure you have at least one trusted adult you can talk to</li>
                <li>Friendships need variety: try to connect with different types of people</li>
                <li>Quality matters more than quantity; a few strong bonds are valuable</li>
                <li>Offer help and support to others; reciprocity builds trust</li>
                <li>It is okay if your network is small; what matters is that you feel supported</li>
            </ul>
        </div>
    </aside>

    <div class="canvas-area" id="canvasArea">
        <svg id="networkSvg" viewBox="0 0 620 620" xmlns="http://www.w3.org/2000/svg">
            <!-- Rings -->
            <circle cx="310" cy="310" r="280" fill="none" stroke="#e5e7eb" stroke-width="1.5" stroke-dasharray="6 4"/>
            <circle cx="310" cy="310" r="190" fill="none" stroke="#e5e7eb" stroke-width="1.5" stroke-dasharray="6 4"/>
            <circle cx="310" cy="310" r="100" fill="none" stroke="#e5e7eb" stroke-width="1.5" stroke-dasharray="6 4"/>

            <!-- Drop zone indicators -->
            <circle class="drop-zone-indicator" id="dropInner" cx="310" cy="310" r="100" fill="#14b8a6"/>
            <circle class="drop-zone-indicator" id="dropMiddle" cx="310" cy="310" r="190" fill="#f97316"/>
            <circle class="drop-zone-indicator" id="dropOuter" cx="310" cy="310" r="280" fill="#a855f7"/>

            <!-- Ring labels -->
            <text class="ring-label-text" x="310" y="225">Close friends</text>
            <text class="ring-label-text" x="310" y="132">Wider circle</text>
            <text class="ring-label-text" x="310" y="42">Trusted adults</text>

            <!-- Centre "You" marker -->
            <circle cx="310" cy="310" r="24" fill="var(--teal-600)" opacity="0.9"/>
            <text x="310" y="314" text-anchor="middle" fill="white" font-size="11" font-weight="700">You</text>

            <!-- Connection lines group -->
            <g id="linesGroup"></g>

            <!-- People group -->
            <g id="peopleGroup"></g>
        </svg>

        <div class="empty-state" id="emptyState">
            <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/>
            </svg>
            <p>Add people using the form to build your network map</p>
        </div>
    </div>
</div>

<!-- Info panel -->
<div class="info-panel" id="infoPanel">
    <div class="info-content">
        <button class="info-close" onclick="closeInfo()">&times;</button>
        <h2>About the Friendship Network Mapper</h2>
        <p>This tool helps you visualise and reflect on your social support network. Everyone needs people around them who they can rely on, talk to, and share experiences with.</p>

        <h4>Why social networks matter</h4>
        <p>Research consistently shows that having a diverse, supportive social network is one of the strongest predictors of wellbeing and resilience in young people. Your network acts as a safety net during difficult times and a source of joy during good ones.</p>

        <h4>The three circles</h4>
        <ul>
            <li><strong>Close friends (inner ring):</strong> The people you trust most deeply. You feel comfortable being yourself around them and can share personal thoughts and feelings.</li>
            <li><strong>Wider circle (middle ring):</strong> People you enjoy spending time with and feel comfortable around, though you may not share everything with them.</li>
            <li><strong>Trusted adults (outer ring):</strong> Adults you can turn to for guidance, support, or help. These might be parents, teachers, coaches, or family friends.</li>
        </ul>

        <h4>How to use this tool</h4>
        <ul>
            <li>Add people by entering their name and choosing a relationship type and circle</li>
            <li>Drag people around the map to reposition them</li>
            <li>Watch your network health score change as you add variety</li>
            <li>Read the reflection prompts to think about your network's strengths and gaps</li>
            <li>Use the tips to consider ways to strengthen your connections</li>
        </ul>

        <h4>Building resilience</h4>
        <p>A healthy network includes different types of relationships across all three circles. Having support from family, friends, and trusted adults means you have people to turn to in different situations. If one area of your life is challenging, other parts of your network can provide stability and comfort.</p>

        <h4>Remember</h4>
        <p>There is no "perfect" network. Some people prefer a small group of close connections, while others thrive with a larger circle. What matters most is that you feel genuinely supported and that you know who to turn to when you need help.</p>
    </div>
</div>

<script>
(function() {
    'use strict';

    const CX = 310, CY = 310;
    const RING_R = { inner: 100, middle: 190, outer: 280 };
    const TYPE_COLOURS = {
        family: '#3b82f6',
        school: '#22c55e',
        outside: '#f97316',
        adult: '#a855f7'
    };
    const TYPE_LABELS = {
        family: 'Family',
        school: 'School friend',
        outside: 'Out-of-school',
        adult: 'Trusted adult'
    };
    const RING_LABELS = {
        inner: 'Close',
        middle: 'Wider',
        outer: 'Trusted adults'
    };

    let people = [];
    let nextId = 1;
    let dragTarget = null;
    let dragOffset = { x: 0, y: 0 };

    const svg = document.getElementById('networkSvg');
    const peopleGroup = document.getElementById('peopleGroup');
    const linesGroup = document.getElementById('linesGroup');
    const cardList = document.getElementById('cardList');
    const nameInput = document.getElementById('nameInput');
    const typeSelect = document.getElementById('typeSelect');
    const ringSelect = document.getElementById('ringSelect');
    const emptyState = document.getElementById('emptyState');

    // Utility: get SVG point from mouse/touch event
    function getSVGPoint(evt) {
        const pt = svg.createSVGPoint();
        const e = evt.touches ? evt.touches[0] : evt;
        pt.x = e.clientX;
        pt.y = e.clientY;
        const ctm = svg.getScreenCTM().inverse();
        return pt.matrixTransform(ctm);
    }

    // Determine which ring a point falls in
    function getRingForPoint(x, y) {
        const dist = Math.sqrt((x - CX) ** 2 + (y - CY) ** 2);
        if (dist <= RING_R.inner) return 'inner';
        if (dist <= RING_R.middle) return 'middle';
        if (dist <= RING_R.outer) return 'outer';
        return null;
    }

    // Generate a position within a ring
    function getRandomPositionInRing(ring) {
        const minR = ring === 'inner' ? 30 : (ring === 'middle' ? RING_R.inner + 15 : RING_R.middle + 15);
        const maxR = RING_R[ring] - 15;
        const angle = Math.random() * Math.PI * 2;
        const r = minR + Math.random() * (maxR - minR);
        return {
            x: CX + Math.cos(angle) * r,
            y: CY + Math.sin(angle) * r
        };
    }

    // Constrain position to within the outer ring
    function constrainToMap(x, y) {
        const dx = x - CX, dy = y - CY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const maxDist = RING_R.outer - 10;
        if (dist > maxDist) {
            const ratio = maxDist / dist;
            return { x: CX + dx * ratio, y: CY + dy * ratio };
        }
        return { x, y };
    }

    function addPerson() {
        const name = nameInput.value.trim();
        if (!name) {
            nameInput.focus();
            return;
        }
        if (people.length >= 20) {
            alert('Maximum of 20 people reached. Remove someone before adding more.');
            return;
        }

        const type = typeSelect.value;
        const ring = ringSelect.value;
        const pos = getRandomPositionInRing(ring);

        const person = {
            id: nextId++,
            name: name,
            type: type,
            ring: ring,
            x: pos.x,
            y: pos.y
        };

        people.push(person);
        nameInput.value = '';
        nameInput.focus();

        render();
    }

    function removePerson(id) {
        people = people.filter(p => p.id !== id);
        render();
    }

    function render() {
        renderSVG();
        renderCards();
        updateScore();
        updateReflection();
        emptyState.style.display = people.length === 0 ? 'block' : 'none';
    }

    function renderSVG() {
        // Clear
        linesGroup.innerHTML = '';
        peopleGroup.innerHTML = '';

        // Draw connection lines from centre to each person
        people.forEach(p => {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', CX);
            line.setAttribute('y1', CY);
            line.setAttribute('x2', p.x);
            line.setAttribute('y2', p.y);
            line.setAttribute('class', 'connection-line');
            line.setAttribute('stroke', TYPE_COLOURS[p.type]);
            line.setAttribute('data-id', p.id);
            linesGroup.appendChild(line);
        });

        // Draw people nodes
        people.forEach(p => {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'svg-person');
            g.setAttribute('data-id', p.id);
            g.setAttribute('transform', `translate(${p.x}, ${p.y})`);

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', 0);
            circle.setAttribute('cy', 0);
            circle.setAttribute('r', 18);
            circle.setAttribute('fill', TYPE_COLOURS[p.type]);
            circle.setAttribute('opacity', '0.85');

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', 0);
            text.setAttribute('y', 4);
            text.setAttribute('fill', 'white');
            const displayName = p.name.length > 8 ? p.name.substring(0, 7) + '\u2026' : p.name;
            text.textContent = displayName;

            // Tooltip via title
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
            title.textContent = `${p.name} (${TYPE_LABELS[p.type]})`;
            g.appendChild(title);

            g.appendChild(circle);
            g.appendChild(text);
            peopleGroup.appendChild(g);

            // Drag handlers
            g.addEventListener('mousedown', startDrag);
            g.addEventListener('touchstart', startDrag, { passive: false });
        });
    }

    function renderCards() {
        const count = document.getElementById('personCount');
        count.textContent = `(${people.length})`;

        if (people.length === 0) {
            cardList.innerHTML = '<div style="color:var(--grey-400);font-size:0.82rem;">No people added yet.</div>';
            return;
        }

        cardList.innerHTML = '';
        people.forEach(p => {
            const card = document.createElement('div');
            card.className = 'person-card';
            card.setAttribute('draggable', 'true');
            card.setAttribute('data-id', p.id);

            card.innerHTML = `
                <span class="dot dot-${p.type}"></span>
                <span class="name">${escapeHtml(p.name)}</span>
                <span class="ring-label">${RING_LABELS[p.ring]}</span>
                <button class="remove-btn" title="Remove">&times;</button>
            `;

            card.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                removePerson(p.id);
            });

            cardList.appendChild(card);
        });
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // SVG drag
    function startDrag(evt) {
        evt.preventDefault();
        const g = evt.currentTarget;
        const id = parseInt(g.getAttribute('data-id'));
        const person = people.find(p => p.id === id);
        if (!person) return;

        dragTarget = person;
        const pt = getSVGPoint(evt);
        dragOffset.x = pt.x - person.x;
        dragOffset.y = pt.y - person.y;

        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('touchend', endDrag);
    }

    function onDrag(evt) {
        if (!dragTarget) return;
        evt.preventDefault();

        const pt = getSVGPoint(evt);
        let nx = pt.x - dragOffset.x;
        let ny = pt.y - dragOffset.y;

        const constrained = constrainToMap(nx, ny);
        dragTarget.x = constrained.x;
        dragTarget.y = constrained.y;

        // Update ring based on new position
        const newRing = getRingForPoint(constrained.x, constrained.y);
        if (newRing) {
            dragTarget.ring = newRing;
        }

        // Highlight drop zones
        highlightDropZone(constrained.x, constrained.y);

        // Update SVG element position
        const g = peopleGroup.querySelector(`[data-id="${dragTarget.id}"]`);
        if (g) {
            g.setAttribute('transform', `translate(${constrained.x}, ${constrained.y})`);
        }

        // Update connection line
        const line = linesGroup.querySelector(`[data-id="${dragTarget.id}"]`);
        if (line) {
            line.setAttribute('x2', constrained.x);
            line.setAttribute('y2', constrained.y);
        }
    }

    function endDrag() {
        if (dragTarget) {
            dragTarget = null;
            clearDropZoneHighlights();
            renderCards();
            updateScore();
            updateReflection();
        }
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('touchend', endDrag);
    }

    function highlightDropZone(x, y) {
        clearDropZoneHighlights();
        const ring = getRingForPoint(x, y);
        if (ring === 'inner') document.getElementById('dropInner').classList.add('active');
        else if (ring === 'middle') document.getElementById('dropMiddle').classList.add('active');
        else if (ring === 'outer') document.getElementById('dropOuter').classList.add('active');
    }

    function clearDropZoneHighlights() {
        document.getElementById('dropInner').classList.remove('active');
        document.getElementById('dropMiddle').classList.remove('active');
        document.getElementById('dropOuter').classList.remove('active');
    }

    // Scoring
    function updateScore() {
        const total = people.length;
        const details = document.getElementById('scoreDetails');
        const scoreEl = document.getElementById('scoreValue');
        const barEl = document.getElementById('scoreBar');

        if (total === 0) {
            scoreEl.innerHTML = '0<span style="font-size:1rem;font-weight:400;color:var(--grey-500)">/100</span>';
            barEl.style.width = '0%';
            details.innerHTML = '';
            return;
        }

        // Count by type
        const typeCounts = { family: 0, school: 0, outside: 0, adult: 0 };
        people.forEach(p => typeCounts[p.type]++);

        // Count by ring
        const ringCounts = { inner: 0, middle: 0, outer: 0 };
        people.forEach(p => ringCounts[p.ring]++);

        // Diversity score (max 30): how many different types present
        const typesPresent = Object.values(typeCounts).filter(c => c > 0).length;
        const diversityScore = Math.round((typesPresent / 4) * 30);

        // Distribution score (max 30): how evenly spread across rings
        const ringsUsed = Object.values(ringCounts).filter(c => c > 0).length;
        const distributionScore = Math.round((ringsUsed / 3) * 30);

        // Size score (max 20): having a reasonable number (ideal 6-12)
        let sizeScore = 0;
        if (total >= 6 && total <= 12) sizeScore = 20;
        else if (total >= 3 && total <= 15) sizeScore = 15;
        else if (total >= 1) sizeScore = 8;

        // Trusted adults score (max 20): having at least one adult-type or outer-ring person
        const hasAdult = typeCounts.adult > 0 || ringCounts.outer > 0;
        const adultScore = hasAdult ? 20 : 0;

        const score = diversityScore + distributionScore + sizeScore + adultScore;

        scoreEl.innerHTML = `${score}<span style="font-size:1rem;font-weight:400;color:var(--grey-500)">/100</span>`;
        barEl.style.width = `${score}%`;

        details.innerHTML = `
            <div class="score-detail"><span>Diversity (types)</span><span>${diversityScore}/30</span></div>
            <div class="score-detail"><span>Distribution (rings)</span><span>${distributionScore}/30</span></div>
            <div class="score-detail"><span>Network size</span><span>${sizeScore}/20</span></div>
            <div class="score-detail"><span>Trusted adults</span><span>${adultScore}/20</span></div>
        `;
    }

    // Reflection prompts
    function updateReflection() {
        const box = document.getElementById('reflectionBox');
        const total = people.length;

        if (total === 0) {
            box.textContent = 'Add some people to your network to see personalised reflection prompts about your support system.';
            return;
        }

        const typeCounts = { family: 0, school: 0, outside: 0, adult: 0 };
        people.forEach(p => typeCounts[p.type]++);
        const ringCounts = { inner: 0, middle: 0, outer: 0 };
        people.forEach(p => ringCounts[p.ring]++);

        const prompts = [];

        if (typeCounts.adult === 0 && ringCounts.outer === 0) {
            prompts.push('You have not added any trusted adults. Think about whether there is a teacher, family member, coach, or other adult you could talk to if you needed help.');
        }

        if (typeCounts.family === 0) {
            prompts.push('No family members appear in your network. Is there a family member you feel close to or could build a stronger connection with?');
        }

        if (typeCounts.outside === 0 && total >= 3) {
            prompts.push('All your connections seem to be from school or family. Having friends from different settings (clubs, sports, neighbourhood) can broaden your support.');
        }

        if (ringCounts.inner === 0 && total >= 2) {
            prompts.push('Your close friends ring is empty. Consider whether there is someone you trust enough to place in your inner circle.');
        }

        if (ringCounts.inner > 0 && ringCounts.middle === 0 && ringCounts.outer === 0) {
            prompts.push('Your network is concentrated in the close friends ring. A wider circle and trusted adults can offer different types of support.');
        }

        const typesPresent = Object.values(typeCounts).filter(c => c > 0).length;
        if (typesPresent === 1 && total >= 3) {
            prompts.push('All your connections are the same type. Think about whether you could add people from different parts of your life for a more varied support system.');
        }

        if (total >= 6 && typesPresent >= 3) {
            prompts.push('Well done: your network includes a good variety of relationship types. This gives you different people to turn to in different situations.');
        }

        if (total >= 4 && ringCounts.inner > 0 && ringCounts.outer > 0) {
            prompts.push('You have people in both your close circle and your trusted adults ring. This is a strong foundation for support.');
        }

        if (total === 1) {
            prompts.push('You have made a start by adding one person. Keep going: think about who else is part of your world.');
        }

        if (total >= 8 && Object.values(ringCounts).filter(c => c > 0).length === 3) {
            prompts.push('Excellent spread across all three circles. You seem to have a well-rounded network with close bonds and broader support.');
        }

        if (prompts.length === 0) {
            prompts.push('Keep building your network. Think about who supports you in different areas of your life.');
        }

        // Show up to 3 prompts
        box.innerHTML = prompts.slice(0, 3).map(p => `<p style="margin-bottom:8px">${p}</p>`).join('');
    }

    function resetAll() {
        if (people.length === 0) return;
        if (!confirm('This will remove everyone from your network. Are you sure?')) return;
        people = [];
        nextId = 1;
        render();
    }

    // Enter key support
    nameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') addPerson();
    });

    // Info panel
    window.openInfo = function() {
        document.getElementById('infoPanel').classList.add('open');
    };
    window.closeInfo = function() {
        document.getElementById('infoPanel').classList.remove('open');
    };
    document.getElementById('infoPanel').addEventListener('click', function(e) {
        if (e.target === this) closeInfo();
    });

    // Expose functions
    window.addPerson = addPerson;
    window.resetAll = resetAll;

    // Initial render
    render();
})();
</script>
</body>
</html>