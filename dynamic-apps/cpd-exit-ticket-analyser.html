<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exit Ticket Response Analyser</title>
<style>
  :root {
    --primary:        #4f46e5;
    --primary-dark:   #3730a3;
    --primary-light:  #818cf8;
    --primary-bg:     #eef2ff;
    --accent:         #7c3aed;
    --accent-light:   #c4b5fd;
    --surface:        #ffffff;
    --surface-alt:    #f8f7ff;
    --border:         #e0e7ff;
    --text:           #1e1b4b;
    --text-muted:     #6b7280;
    --text-light:     #9ca3af;

    --correct:        #059669;
    --correct-bg:     #d1fae5;
    --correct-border: #6ee7b7;

    --misc-a:         #dc2626;
    --misc-a-bg:      #fee2e2;
    --misc-a-border:  #fca5a5;

    --misc-b:         #d97706;
    --misc-b-bg:      #fef3c7;
    --misc-b-border:  #fcd34d;

    --misc-c:         #7c3aed;
    --misc-c-bg:      #ede9fe;
    --misc-c-border:  #c4b5fd;

    --blank:          #6b7280;
    --blank-bg:       #f3f4f6;
    --blank-border:   #d1d5db;

    --shadow-sm:      0 1px 3px rgba(79,70,229,0.08);
    --shadow:         0 4px 16px rgba(79,70,229,0.12);
    --shadow-lg:      0 8px 32px rgba(79,70,229,0.18);
    --radius:         10px;
    --radius-lg:      16px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
    background: var(--surface-alt);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }

  /* ── Header ── */
  .app-header {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--accent) 100%);
    color: #fff;
    padding: 1.25rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .app-header svg { flex-shrink: 0; }
  .app-header-text h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.01em; }
  .app-header-text p { font-size: 0.8rem; opacity: 0.85; margin-top: 0.1rem; }
  .header-actions { margin-left: auto; display: flex; gap: 0.5rem; }
  .btn-header {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    padding: 0.4rem 0.9rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: background 0.15s;
  }
  .btn-header:hover { background: rgba(255,255,255,0.25); }

  /* ── Layout ── */
  .app-body { display: grid; grid-template-columns: 340px 1fr; gap: 1.25rem; padding: 1.25rem; max-width: 1400px; margin: 0 auto; }
  @media (max-width: 1024px) { .app-body { grid-template-columns: 300px 1fr; } }
  @media (max-width: 768px) { .app-body { grid-template-columns: 1fr; } }

  /* ── Cards ── */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .card-header {
    background: var(--primary-bg);
    padding: 0.85rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .card-header h2 { font-size: 0.9rem; font-weight: 700; color: var(--primary-dark); }
  .card-header .badge {
    background: var(--primary);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    margin-left: auto;
  }
  .card-body { padding: 1.25rem; }
  .card-body-sm { padding: 1rem; }

  /* ── Left panel ── */
  .left-panel { display: flex; flex-direction: column; gap: 1.25rem; }

  /* ── Question tabs ── */
  .q-tabs { display: flex; gap: 0.35rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .q-tab {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }
  .q-tab.active { background: var(--primary); border-color: var(--primary); color: #fff; }
  .q-tab:hover:not(.active) { border-color: var(--primary-light); color: var(--primary); }

  /* ── Form elements ── */
  label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.3rem; }
  input[type="text"], textarea, select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1.5px solid var(--border);
    border-radius: 7px;
    font-size: 0.85rem;
    color: var(--text);
    background: var(--surface);
    transition: border-color 0.15s, box-shadow 0.15s;
    font-family: inherit;
  }
  input[type="text"]:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
  }
  textarea { resize: vertical; min-height: 56px; }
  .form-group { margin-bottom: 0.85rem; }

  .misc-input-row { display: grid; grid-template-columns: auto 1fr; gap: 0.4rem; align-items: start; margin-bottom: 0.5rem; }
  .misc-label-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.35rem 0.55rem;
    border-radius: 6px;
    font-size: 0.72rem;
    font-weight: 700;
    white-space: nowrap;
    margin-top: 0.1rem;
  }
  .misc-label-pill.a { background: var(--misc-a-bg); color: var(--misc-a); border: 1px solid var(--misc-a-border); }
  .misc-label-pill.b { background: var(--misc-b-bg); color: var(--misc-b); border: 1px solid var(--misc-b-border); }
  .misc-label-pill.c { background: var(--misc-c-bg); color: var(--misc-c); border: 1px solid var(--misc-c-border); }

  .divider { border: none; border-top: 1px solid var(--border); margin: 0.85rem 0; }

  /* ── Buttons ── */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 7px;
    border: none;
    cursor: pointer;
    font-size: 0.82rem;
    font-weight: 600;
    font-family: inherit;
    transition: all 0.15s;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-primary:hover { background: var(--primary-dark); }
  .btn-secondary { background: var(--primary-bg); color: var(--primary); border: 1.5px solid var(--primary-light); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: #fee2e2; color: #dc2626; border: 1.5px solid #fca5a5; }
  .btn-danger:hover { background: #fca5a5; }
  .btn-sm { padding: 0.3rem 0.65rem; font-size: 0.75rem; }
  .btn-block { width: 100%; justify-content: center; }

  /* ── Preset selector ── */
  .preset-row { display: flex; gap: 0.5rem; align-items: flex-end; }
  .preset-row select { flex: 1; }

  /* ── Right panel ── */
  .right-panel { display: flex; flex-direction: column; gap: 1.25rem; }

  /* ── Quick-entry grid ── */
  .grid-controls { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.85rem; }
  .grid-legend { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 0.3rem; font-size: 0.73rem; font-weight: 600; cursor: pointer; }
  .legend-dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
  .legend-dot.correct { background: var(--correct); }
  .legend-dot.misc-a   { background: var(--misc-a); }
  .legend-dot.misc-b   { background: var(--misc-b); }
  .legend-dot.misc-c   { background: var(--misc-c); }
  .legend-dot.blank    { background: var(--blank); }

  .pupil-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 0.5rem;
  }
  @media (max-width: 900px) { .pupil-grid { grid-template-columns: repeat(5, 1fr); } }
  @media (max-width: 600px) { .pupil-grid { grid-template-columns: repeat(4, 1fr); } }

  .pupil-slot {
    position: relative;
    aspect-ratio: 1;
    border-radius: var(--radius);
    border: 2px solid var(--border);
    background: var(--surface-alt);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.15rem;
    transition: all 0.12s;
    user-select: none;
    min-height: 64px;
  }
  .pupil-slot:hover { border-color: var(--primary-light); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
  .pupil-slot .pupil-num { font-size: 0.62rem; font-weight: 700; color: var(--text-muted); }
  .pupil-slot .pupil-name-tag { font-size: 0.58rem; color: var(--text-muted); text-align: center; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .pupil-slot .pupil-status-icon { font-size: 1.1rem; line-height: 1; }

  .pupil-slot.correct  { background: var(--correct-bg);  border-color: var(--correct-border);  }
  .pupil-slot.misc-a   { background: var(--misc-a-bg);   border-color: var(--misc-a-border);   }
  .pupil-slot.misc-b   { background: var(--misc-b-bg);   border-color: var(--misc-b-border);   }
  .pupil-slot.misc-c   { background: var(--misc-c-bg);   border-color: var(--misc-c-border);   }
  .pupil-slot.blank    { background: var(--blank-bg);    border-color: var(--blank-border);     }

  /* cycle indicator */
  .pupil-slot .cycle-hint {
    position: absolute;
    bottom: 2px;
    right: 4px;
    font-size: 0.5rem;
    color: var(--text-light);
    pointer-events: none;
  }

  /* ── Name editor ── */
  .name-editor-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
  .name-editor-row input { flex: 1; }
  .names-hint { font-size: 0.75rem; color: var(--text-muted); }

  /* ── Charts section ── */
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

  canvas { display: block; width: 100% !important; }

  /* ── Summary stats ── */
  .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; }
  @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 600px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }

  .stat-card {
    border-radius: var(--radius);
    padding: 0.85rem 0.75rem;
    text-align: center;
    border: 1.5px solid;
  }
  .stat-card.correct  { background: var(--correct-bg);  border-color: var(--correct-border);  color: var(--correct); }
  .stat-card.misc-a   { background: var(--misc-a-bg);   border-color: var(--misc-a-border);   color: var(--misc-a); }
  .stat-card.misc-b   { background: var(--misc-b-bg);   border-color: var(--misc-b-border);   color: var(--misc-b); }
  .stat-card.misc-c   { background: var(--misc-c-bg);   border-color: var(--misc-c-border);   color: var(--misc-c); }
  .stat-card.blank    { background: var(--blank-bg);    border-color: var(--blank-border);     color: var(--blank); }
  .stat-val { font-size: 1.6rem; font-weight: 800; line-height: 1; }
  .stat-label { font-size: 0.68rem; font-weight: 600; margin-top: 0.25rem; opacity: 0.85; }
  .stat-pct { font-size: 0.78rem; font-weight: 700; opacity: 0.75; }

  /* ── Grouping & Intervention ── */
  .group-block {
    border-radius: var(--radius);
    border: 1.5px solid var(--border);
    margin-bottom: 0.75rem;
    overflow: hidden;
  }
  .group-header {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.6rem 0.85rem;
    font-size: 0.82rem;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
  }
  .group-header.correct { background: var(--correct-bg); color: var(--correct); border-bottom: 1.5px solid var(--correct-border); }
  .group-header.misc-a  { background: var(--misc-a-bg);  color: var(--misc-a);  border-bottom: 1.5px solid var(--misc-a-border); }
  .group-header.misc-b  { background: var(--misc-b-bg);  color: var(--misc-b);  border-bottom: 1.5px solid var(--misc-b-border); }
  .group-header.misc-c  { background: var(--misc-c-bg);  color: var(--misc-c);  border-bottom: 1.5px solid var(--misc-c-border); }
  .group-header.blank   { background: var(--blank-bg);   color: var(--blank);   border-bottom: 1.5px solid var(--blank-border); }
  .group-count { margin-left: auto; font-size: 0.72rem; background: rgba(0,0,0,0.08); padding: 0.1rem 0.4rem; border-radius: 999px; }
  .group-chevron { margin-left: 0.2rem; transition: transform 0.2s; }
  .group-chevron.open { transform: rotate(90deg); }
  .group-body { padding: 0.75rem; background: var(--surface); }
  .group-names { display: flex; flex-wrap: wrap; gap: 0.3rem; }
  .name-chip { background: var(--primary-bg); color: var(--primary-dark); border: 1px solid var(--border); padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.72rem; font-weight: 600; }
  .group-intervention { margin-top: 0.6rem; font-size: 0.78rem; color: var(--text-muted); background: var(--surface-alt); border-radius: 7px; padding: 0.5rem 0.75rem; border-left: 3px solid var(--primary-light); }
  .group-intervention strong { color: var(--text); }

  /* ── Pedagogy panel ── */
  .pedagogy-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.85rem; }
  @media (max-width: 900px) { .pedagogy-grid { grid-template-columns: 1fr 1fr; } }
  @media (max-width: 600px) { .pedagogy-grid { grid-template-columns: 1fr; } }
  .peda-card {
    background: var(--primary-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.85rem;
  }
  .peda-card h3 { font-size: 0.82rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.4rem; }
  .peda-card p { font-size: 0.75rem; color: var(--text-muted); line-height: 1.55; }

  /* ── Print ── */
  @media print {
    .app-header { position: static; }
    .btn-header, .btn, .grid-controls .btn, .name-editor-row { display: none; }
    .app-body { display: block; }
    .left-panel, .right-panel { gap: 1rem; }
    .card { break-inside: avoid; margin-bottom: 1rem; box-shadow: none; border: 1px solid #ccc; }
  }

  /* ── Misc utilities ── */
  .flex-row  { display: flex; gap: 0.5rem; align-items: center; }
  .flex-end  { justify-content: flex-end; }
  .mt-1      { margin-top: 0.5rem; }
  .mt-2      { margin-top: 1rem; }
  .text-muted { color: var(--text-muted); font-size: 0.78rem; }
  .section-title { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--primary); margin-bottom: 0.5rem; }
  .hidden { display: none !important; }

  /* ── Toast ── */
  .toast {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    background: var(--primary-dark);
    color: #fff;
    padding: 0.65rem 1.1rem;
    border-radius: 8px;
    font-size: 0.82rem;
    font-weight: 600;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 0.25s, transform 0.25s;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  /* ── No-data placeholder ── */
  .no-data { text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: 0.82rem; }
  .no-data svg { display: block; margin: 0 auto 0.75rem; opacity: 0.3; }
</style>
</head>
<body>

<!-- ══ HEADER ══════════════════════════════════════════════════════════════ -->
<header class="app-header">
  <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="36" height="36" rx="9" fill="rgba(255,255,255,0.15)"/>
    <rect x="7" y="9" width="22" height="3" rx="1.5" fill="white"/>
    <rect x="7" y="15" width="16" height="3" rx="1.5" fill="white" opacity="0.7"/>
    <rect x="7" y="21" width="19" height="3" rx="1.5" fill="white" opacity="0.5"/>
    <circle cx="28" cy="25" r="5" fill="#a78bfa"/>
    <path d="M26 25l1.5 1.5L30 23" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <div class="app-header-text">
    <h1>Exit Ticket Response Analyser</h1>
    <p>Enter pupil responses and see live analysis with misconception grouping</p>
  </div>
  <div class="header-actions">
    <button class="btn-header" onclick="printSummary()">Print summary</button>
    <button class="btn-header" onclick="resetAll()">Reset</button>
  </div>
</header>

<div class="app-body">

  <!-- ══ LEFT PANEL ══════════════════════════════════════════════════════ -->
  <div class="left-panel">

    <!-- Question Setup -->
    <div class="card">
      <div class="card-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <h2>Question Setup</h2>
        <span class="badge" id="q-count-badge">Q1 of 5</span>
      </div>
      <div class="card-body-sm">

        <!-- preset selector -->
        <div class="form-group">
          <label>Load a preset</label>
          <div class="preset-row">
            <select id="preset-select" onchange="loadPreset()">
              <option value="">-- Choose a subject preset --</option>
              <option value="maths-fractions">Maths: Fractions</option>
              <option value="science-forces">Science: Forces</option>
              <option value="english-apostrophes">English: Apostrophes</option>
              <option value="history-causation">History: Causation</option>
            </select>
            <button class="btn btn-secondary btn-sm" onclick="clearPreset()">Clear</button>
          </div>
        </div>

        <hr class="divider">

        <!-- question tabs -->
        <div class="section-title">Select question to configure</div>
        <div class="q-tabs" id="q-tabs"></div>

        <!-- question editor -->
        <div class="form-group">
          <label>Question text</label>
          <textarea id="q-text" rows="2" placeholder="e.g. What is 3/4 + 1/2?" oninput="saveQuestion()"></textarea>
        </div>
        <div class="form-group">
          <label>Correct answer / expected response</label>
          <input type="text" id="q-correct" placeholder="e.g. 5/4 or 1 and 1/4" oninput="saveQuestion()">
        </div>
        <hr class="divider">
        <div class="section-title">Common misconceptions</div>
        <div class="misc-input-row">
          <span class="misc-label-pill a">Misc A</span>
          <input type="text" id="misc-a" placeholder="e.g. Adds both numerators and denominators: 4/6" oninput="saveQuestion()">
        </div>
        <div class="misc-input-row">
          <span class="misc-label-pill b">Misc B</span>
          <input type="text" id="misc-b" placeholder="e.g. Only converts one fraction: answer is 3/8" oninput="saveQuestion()">
        </div>
        <div class="misc-input-row">
          <span class="misc-label-pill c">Misc C</span>
          <input type="text" id="misc-c" placeholder="Optional third misconception" oninput="saveQuestion()">
        </div>

      </div>
    </div>

    <!-- Pedagogy panel -->
    <div class="card">
      <div class="card-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        <h2>Exit Ticket Pedagogy</h2>
      </div>
      <div class="card-body-sm">
        <div class="pedagogy-grid">
          <div class="peda-card">
            <h3>What are exit tickets?</h3>
            <p>Brief formative checks at the end of a lesson. They surface understanding (or gaps) while you can still act on the information for the next session.</p>
          </div>
          <div class="peda-card">
            <h3>Using data for next-lesson planning</h3>
            <p>Sort pupils into three groups: ready to move on, holding a specific misconception, or requiring foundational support. Plan three short opening activities accordingly.</p>
          </div>
          <div class="peda-card">
            <h3>Responsive teaching</h3>
            <p>Analyse patterns before the pupils arrive. If over 30% share a misconception, address it whole-class. Below that, use targeted group work or a 1-to-1 intervention prompt.</p>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /left-panel -->

  <!-- ══ RIGHT PANEL ═══════════════════════════════════════════════════════ -->
  <div class="right-panel">

    <!-- Quick-entry grid -->
    <div class="card">
      <div class="card-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        <h2>Pupil Response Grid</h2>
        <span class="badge" id="q-label-badge">Q1</span>
      </div>
      <div class="card-body-sm">

        <!-- name editor -->
        <details class="mb-2">
          <summary style="cursor:pointer;font-size:0.78rem;font-weight:600;color:var(--primary);margin-bottom:0.5rem;">Edit pupil names (optional)</summary>
          <div style="margin-top:0.5rem;">
            <p class="names-hint">Paste a newline-separated list, or edit names individually by clicking the labels below.</p>
            <div class="flex-row mt-1">
              <textarea id="bulk-names" rows="4" style="flex:1;" placeholder="Pupil 1&#10;Pupil 2&#10;Pupil 3..."></textarea>
            </div>
            <button class="btn btn-secondary btn-sm mt-1" onclick="applyBulkNames()">Apply names</button>
          </div>
        </details>

        <!-- legend / controls -->
        <div class="grid-controls">
          <div class="grid-legend">
            <div class="legend-item"><span class="legend-dot correct"></span>Correct</div>
            <div class="legend-item"><span class="legend-dot misc-a"></span>Misc A</div>
            <div class="legend-item"><span class="legend-dot misc-b"></span>Misc B</div>
            <div class="legend-item"><span class="legend-dot misc-c"></span>Misc C</div>
            <div class="legend-item"><span class="legend-dot blank"></span>Blank</div>
          </div>
          <button class="btn btn-danger btn-sm" style="margin-left:auto;" onclick="clearGridForCurrentQ()">Clear this question</button>
        </div>
        <p class="text-muted" style="margin-bottom:0.75rem;">Click each pupil slot to cycle: Unset &rarr; Correct &rarr; Misc A &rarr; Misc B &rarr; Misc C &rarr; Blank &rarr; Unset</p>

        <div class="pupil-grid" id="pupil-grid"></div>

      </div>
    </div>

    <!-- Summary stats -->
    <div class="card">
      <div class="card-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <h2>Class Summary</h2>
        <span class="badge" id="summary-q-badge">Q1</span>
      </div>
      <div class="card-body-sm">
        <div class="stats-grid" id="stats-grid">
          <div class="stat-card correct"><div class="stat-val" id="stat-correct">0</div><div class="stat-pct" id="stat-correct-pct">0%</div><div class="stat-label">Correct</div></div>
          <div class="stat-card misc-a"><div class="stat-val" id="stat-misc-a">0</div><div class="stat-pct" id="stat-misc-a-pct">0%</div><div class="stat-label">Misconception A</div></div>
          <div class="stat-card misc-b"><div class="stat-val" id="stat-misc-b">0</div><div class="stat-pct" id="stat-misc-b-pct">0%</div><div class="stat-label">Misconception B</div></div>
          <div class="stat-card misc-c"><div class="stat-val" id="stat-misc-c">0</div><div class="stat-pct" id="stat-misc-c-pct">0%</div><div class="stat-label">Misconception C</div></div>
          <div class="stat-card blank"><div class="stat-val" id="stat-blank">0</div><div class="stat-pct" id="stat-blank-pct">0%</div><div class="stat-label">Blank / No response</div></div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="card">
        <div class="card-header">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/></svg>
          <h2>Response distribution</h2>
        </div>
        <div class="card-body" style="position:relative;min-height:220px;">
          <canvas id="pie-chart" height="200"></canvas>
          <div class="no-data hidden" id="pie-no-data">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
            No responses recorded yet
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          <h2>All questions comparison</h2>
        </div>
        <div class="card-body" style="min-height:220px;">
          <canvas id="bar-chart" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- Misconception grouping and intervention -->
    <div class="card">
      <div class="card-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <h2>Misconception Grouping and Intervention</h2>
        <span class="badge" id="groups-q-badge">Q1</span>
      </div>
      <div class="card-body-sm" id="groups-container">
        <div class="no-data">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          Record responses in the grid above to see pupil groups and suggested interventions.
        </div>
      </div>
    </div>

  </div><!-- /right-panel -->
</div><!-- /app-body -->

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ════════════════════════════════════════════════════════════════
   STATE
   ════════════════════════════════════════════════════════════════ */
const NUM_QUESTIONS = 5;
const NUM_PUPILS    = 30;

// responses[q][pupil] = 'correct'|'misc-a'|'misc-b'|'misc-c'|'blank'|null
const responses = Array.from({ length: NUM_QUESTIONS }, () => Array(NUM_PUPILS).fill(null));

// questions[q] = { text, correct, miscA, miscB, miscC }
const questions = Array.from({ length: NUM_QUESTIONS }, () => ({
  text: '', correct: '', miscA: '', miscB: '', miscC: ''
}));

// pupil names
const pupilNames = Array.from({ length: NUM_PUPILS }, (_, i) => `Pupil ${i + 1}`);

let currentQ = 0;

const CYCLE = [null, 'correct', 'misc-a', 'misc-b', 'misc-c', 'blank'];

const RESPONSE_META = {
  'correct': { label: 'Correct',          icon: '&#10003;', cls: 'correct', color: '#059669' },
  'misc-a':  { label: 'Misconception A',  icon: 'A',        cls: 'misc-a',  color: '#dc2626' },
  'misc-b':  { label: 'Misconception B',  icon: 'B',        cls: 'misc-b',  color: '#d97706' },
  'misc-c':  { label: 'Misconception C',  icon: 'C',        cls: 'misc-c',  color: '#7c3aed' },
  'blank':   { label: 'Blank / No resp.', icon: '&#8212;',  cls: 'blank',   color: '#6b7280' },
};

/* ════════════════════════════════════════════════════════════════
   PRESETS
   ════════════════════════════════════════════════════════════════ */
const PRESETS = {
  'maths-fractions': [
    {
      text: 'What is 3/4 + 1/2?',
      correct: '5/4 or 1 and 1/4',
      miscA: 'Adds numerators and denominators: 4/6',
      miscB: 'Converts incorrectly: 3/8 + 4/8 = 7/8',
      miscC: 'Gives 3/4 as the answer (ignores the 1/2)'
    },
    {
      text: 'Simplify 8/12 to its lowest terms.',
      correct: '2/3',
      miscA: 'Divides only numerator: 4/12',
      miscB: 'Divides only denominator: 8/6',
      miscC: 'Gives 4/6 (stops half-way)'
    },
    {
      text: 'What is 2/5 of 30?',
      correct: '12',
      miscA: 'Divides by 2 only: 15',
      miscB: 'Multiplies 30 by 2/5 incorrectly: 60/5 = 12... but writes 60',
      miscC: 'Divides by 5 only: 6'
    },
    {
      text: 'Order from smallest to largest: 3/4, 2/3, 5/6.',
      correct: '2/3, 3/4, 5/6',
      miscA: 'Orders by numerator only: 2/3, 3/4, 5/6 (coincidentally correct reasoning)',
      miscB: 'Reverses the order: 5/6, 3/4, 2/3',
      miscC: 'Puts 3/4 first because "4 is bigger"'
    },
    {
      text: 'A pizza is cut into 8 slices. Jamie eats 3 slices. What fraction is left?',
      correct: '5/8',
      miscA: '3/8 (gives fraction eaten rather than remaining)',
      miscB: '5/5 or 1 (subtracts from numerator and denominator)',
      miscC: '5/11 (adds instead of subtracts)'
    }
  ],
  'science-forces': [
    {
      text: 'A book sits still on a table. What can you say about the forces acting on it?',
      correct: 'The forces are balanced (weight down, normal force up, both equal).',
      miscA: 'There are no forces because it is not moving.',
      miscB: 'The table pushes up harder than gravity pulls down.',
      miscC: 'Only gravity acts on it.'
    },
    {
      text: 'A car speeds up from 0 to 30 mph. What does this tell you about the forces on it?',
      correct: 'There is a resultant (unbalanced) force in the direction of motion.',
      miscA: 'The engine creates force but there is no resultant force.',
      miscB: 'Speed and force are the same thing.',
      miscC: 'Friction causes the car to speed up.'
    },
    {
      text: 'You push a shopping trolley and let go. It slows down. Why?',
      correct: 'Friction and air resistance provide an unbalanced force opposing motion.',
      miscA: 'The force you applied runs out.',
      miscB: 'The trolley wants to stop because it has no engine.',
      miscC: 'Gravity slows it down.'
    },
    {
      text: 'What is the unit of force?',
      correct: 'Newton (N)',
      miscA: 'Kilogram (kg)',
      miscB: 'Joule (J)',
      miscC: 'Watt (W)'
    },
    {
      text: 'Two teams in a tug-of-war pull with equal force. What happens?',
      correct: 'The rope does not move because the forces are balanced.',
      miscA: 'The stronger team always wins, so one side must be stronger.',
      miscB: 'The rope stretches until it breaks.',
      miscC: 'Both teams speed up towards each other.'
    }
  ],
  'english-apostrophes': [
    {
      text: 'Rewrite with an apostrophe: "the coat belonging to the girl".',
      correct: "The girl's coat",
      miscA: "The girls coat (omits apostrophe)",
      miscB: "The girls' coat (treats as plural possessive)",
      miscC: "The girl's' coat (double apostrophe)"
    },
    {
      text: "Which is correct: \"It's raining\" or \"Its raining\"?",
      correct: "It's raining (contraction of 'it is')",
      miscA: "Its raining (confuses possessive its with the contraction)",
      miscB: "Both are correct depending on context.",
      miscC: "Neither, it should be 'Its' raining with a capital."
    },
    {
      text: "Write the contraction for 'they are'.",
      correct: "They're",
      miscA: "Their (homophone confusion)",
      miscB: "There (homophone confusion)",
      miscC: "Theyre (omits apostrophe)"
    },
    {
      text: "Correct or not: \"The dog's are barking.\"",
      correct: "Not correct. Remove the apostrophe: 'The dogs are barking.' (plural, not possessive)",
      miscA: "Correct, because dogs own the barking.",
      miscB: "Change to 'The dog is barking.'",
      miscC: "Change to 'The dogs' are barking.'"
    },
    {
      text: "The books belonging to the teachers: write using an apostrophe.",
      correct: "The teachers' books (plural possessive: apostrophe after the s)",
      miscA: "The teacher's books (treats as singular possessive)",
      miscB: "The teachers's books (adds 's after the plural)",
      miscC: "The teachers books (omits apostrophe entirely)"
    }
  ],
  'history-causation': [
    {
      text: 'What is the difference between a cause and a trigger in history?',
      correct: 'A cause is a longer-term condition; a trigger is the immediate event that starts something.',
      miscA: 'They mean the same thing.',
      miscB: 'A trigger is more important than a cause.',
      miscC: 'Causes happen after events; triggers happen before.'
    },
    {
      text: 'Give one long-term cause of World War One.',
      correct: 'Any of: militarism, alliance systems, imperialism, nationalism (MAIN).',
      miscA: 'The assassination of Franz Ferdinand (that is the trigger, not a long-term cause).',
      miscB: 'Germany invaded Belgium (that is a consequence, not a cause).',
      miscC: 'The Treaty of Versailles (that ended WW1, not caused it).'
    },
    {
      text: 'Why do historians disagree about the importance of causes?',
      correct: 'Evidence can be interpreted differently; historians focus on different aspects or time periods.',
      miscA: 'One of them must be wrong.',
      miscB: 'Some historians have not read all the sources.',
      miscC: 'Causes change over time so both can be right at different moments.'
    },
    {
      text: 'What does "consequence" mean in historical study?',
      correct: 'An outcome or result of an event or decision.',
      miscA: 'A decision made by a leader.',
      miscB: 'A punishment given after a battle.',
      miscC: 'Another word for cause.'
    },
    {
      text: 'Which of these is the best word for why the Norman Conquest succeeded: "cause", "factor", or "reason"?',
      correct: 'All three can be used; "factor" is most neutral and avoids implying a single explanation.',
      miscA: '"Cause" is always the correct term in history.',
      miscB: '"Reason" implies it was planned, so it is always wrong.',
      miscC: 'Only "factor" is acceptable in formal writing.'
    }
  ]
};

/* ════════════════════════════════════════════════════════════════
   INIT
   ════════════════════════════════════════════════════════════════ */
function init() {
  buildQTabs();
  buildGrid();
  switchQuestion(0);
}

/* ════════════════════════════════════════════════════════════════
   QUESTION TABS
   ════════════════════════════════════════════════════════════════ */
function buildQTabs() {
  const el = document.getElementById('q-tabs');
  el.innerHTML = '';
  for (let i = 0; i < NUM_QUESTIONS; i++) {
    const btn = document.createElement('button');
    btn.className = 'q-tab' + (i === currentQ ? ' active' : '');
    btn.textContent = `Q${i + 1}`;
    btn.onclick = () => switchQuestion(i);
    el.appendChild(btn);
  }
}

function switchQuestion(idx) {
  currentQ = idx;
  buildQTabs();
  loadQuestionEditor();
  renderGrid();
  updateAll();
  // update badges
  document.getElementById('q-count-badge').textContent  = `Q${idx+1} of ${NUM_QUESTIONS}`;
  document.getElementById('q-label-badge').textContent   = `Q${idx+1}`;
  document.getElementById('summary-q-badge').textContent = `Q${idx+1}`;
  document.getElementById('groups-q-badge').textContent  = `Q${idx+1}`;
}

/* ════════════════════════════════════════════════════════════════
   QUESTION EDITOR
   ════════════════════════════════════════════════════════════════ */
function loadQuestionEditor() {
  const q = questions[currentQ];
  document.getElementById('q-text').value    = q.text;
  document.getElementById('q-correct').value = q.correct;
  document.getElementById('misc-a').value    = q.miscA;
  document.getElementById('misc-b').value    = q.miscB;
  document.getElementById('misc-c').value    = q.miscC;
}

function saveQuestion() {
  questions[currentQ] = {
    text:    document.getElementById('q-text').value,
    correct: document.getElementById('q-correct').value,
    miscA:   document.getElementById('misc-a').value,
    miscB:   document.getElementById('misc-b').value,
    miscC:   document.getElementById('misc-c').value,
  };
  updateAll();
}

/* ════════════════════════════════════════════════════════════════
   PUPIL GRID
   ════════════════════════════════════════════════════════════════ */
function buildGrid() {
  const grid = document.getElementById('pupil-grid');
  grid.innerHTML = '';
  for (let i = 0; i < NUM_PUPILS; i++) {
    const slot = document.createElement('div');
    slot.className = 'pupil-slot';
    slot.id = `slot-${i}`;
    slot.innerHTML = `
      <span class="pupil-num">${i + 1}</span>
      <span class="pupil-status-icon" id="icon-${i}">&#9675;</span>
      <span class="pupil-name-tag" id="nametag-${i}">${pupilNames[i]}</span>
      <span class="cycle-hint">click</span>
    `;
    slot.onclick = () => cycleResponse(i);
    grid.appendChild(slot);
  }
}

function renderGrid() {
  for (let i = 0; i < NUM_PUPILS; i++) {
    const slot = document.getElementById(`slot-${i}`);
    const iconEl = document.getElementById(`icon-${i}`);
    const r = responses[currentQ][i];
    // remove all status classes
    slot.className = 'pupil-slot';
    if (r) {
      slot.classList.add(RESPONSE_META[r].cls);
      iconEl.innerHTML = RESPONSE_META[r].icon;
    } else {
      iconEl.innerHTML = '&#9675;';
    }
    document.getElementById(`nametag-${i}`).textContent = pupilNames[i];
  }
}

function cycleResponse(pupilIdx) {
  const cur = responses[currentQ][pupilIdx];
  const idx = CYCLE.indexOf(cur);
  responses[currentQ][pupilIdx] = CYCLE[(idx + 1) % CYCLE.length];
  renderGrid();
  updateAll();
}

function clearGridForCurrentQ() {
  responses[currentQ].fill(null);
  renderGrid();
  updateAll();
  showToast(`Question ${currentQ + 1} cleared.`);
}

/* ════════════════════════════════════════════════════════════════
   BULK NAMES
   ════════════════════════════════════════════════════════════════ */
function applyBulkNames() {
  const raw = document.getElementById('bulk-names').value.trim();
  if (!raw) return;
  const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
  for (let i = 0; i < NUM_PUPILS; i++) {
    if (lines[i]) pupilNames[i] = lines[i];
  }
  renderGrid();
  updateAll();
  showToast('Pupil names updated.');
}

/* ════════════════════════════════════════════════════════════════
   STATS
   ════════════════════════════════════════════════════════════════ */
function countForQ(qIdx) {
  const counts = { correct: 0, 'misc-a': 0, 'misc-b': 0, 'misc-c': 0, blank: 0, unset: 0 };
  responses[qIdx].forEach(r => { if (r) counts[r]++; else counts.unset++; });
  return counts;
}

function updateStats() {
  const c = countForQ(currentQ);
  const responded = NUM_PUPILS - c.unset;
  const total = responded || 1;

  const set = (id, val, denom) => {
    document.getElementById(id).textContent = val;
    document.getElementById(id + '-pct').textContent = Math.round(val / denom * 100) + '%';
  };
  set('stat-correct', c.correct, total);
  set('stat-misc-a',  c['misc-a'], total);
  set('stat-misc-b',  c['misc-b'], total);
  set('stat-misc-c',  c['misc-c'], total);
  set('stat-blank',   c.blank, total);
}

/* ════════════════════════════════════════════════════════════════
   CHARTS  (vanilla canvas, no dependencies)
   ════════════════════════════════════════════════════════════════ */
let pieCtx, barCtx;

function getCtx() {
  if (!pieCtx) pieCtx = document.getElementById('pie-chart').getContext('2d');
  if (!barCtx) barCtx = document.getElementById('bar-chart').getContext('2d');
}

function drawPie() {
  getCtx();
  const canvas = document.getElementById('pie-chart');
  const noData = document.getElementById('pie-no-data');
  const c = countForQ(currentQ);
  const responded = NUM_PUPILS - c.unset;

  if (responded === 0) {
    canvas.classList.add('hidden');
    noData.classList.remove('hidden');
    return;
  }
  canvas.classList.remove('hidden');
  noData.classList.add('hidden');

  const w = canvas.offsetWidth || 300;
  const h = 200;
  canvas.width  = w * devicePixelRatio;
  canvas.height = h * devicePixelRatio;
  canvas.style.height = h + 'px';
  const ctx = pieCtx;
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  ctx.clearRect(0, 0, w, h);

  const slices = [
    { key: 'correct', val: c.correct,      color: '#059669' },
    { key: 'misc-a',  val: c['misc-a'],    color: '#dc2626' },
    { key: 'misc-b',  val: c['misc-b'],    color: '#d97706' },
    { key: 'misc-c',  val: c['misc-c'],    color: '#7c3aed' },
    { key: 'blank',   val: c.blank,        color: '#9ca3af' },
  ].filter(s => s.val > 0);

  const cx = w * 0.38, cy = h / 2, r = Math.min(cx, cy) - 12;
  let angle = -Math.PI / 2;

  slices.forEach(s => {
    const sweep = (s.val / responded) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, angle, angle + sweep);
    ctx.closePath();
    ctx.fillStyle = s.color;
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    angle += sweep;
  });

  // legend
  const lx = w * 0.68, ly0 = h / 2 - (slices.length * 18) / 2;
  slices.forEach((s, i) => {
    const ly = ly0 + i * 22;
    ctx.fillStyle = s.color;
    ctx.beginPath();
    ctx.arc(lx, ly + 6, 6, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#374151';
    ctx.font = `600 11px system-ui, sans-serif`;
    const label = RESPONSE_META[s.key].label;
    ctx.fillText(`${label} (${s.val})`, lx + 12, ly + 10);
  });

  // centre text
  ctx.fillStyle = '#1e1b4b';
  ctx.font = `700 20px system-ui, sans-serif`;
  ctx.textAlign = 'center';
  ctx.fillText(responded, cx, cy + 4);
  ctx.font = `500 10px system-ui, sans-serif`;
  ctx.fillStyle = '#6b7280';
  ctx.fillText('responded', cx, cy + 17);
  ctx.textAlign = 'left';
}

function drawBar() {
  getCtx();
  const canvas = document.getElementById('bar-chart');
  const w = canvas.offsetWidth || 300;
  const h = 200;
  canvas.width  = w * devicePixelRatio;
  canvas.height = h * devicePixelRatio;
  canvas.style.height = h + 'px';
  const ctx = barCtx;
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  ctx.clearRect(0, 0, w, h);

  const pad = { top: 16, right: 12, bottom: 32, left: 32 };
  const chartW = w - pad.left - pad.right;
  const chartH = h - pad.top - pad.bottom;

  // grid lines
  ctx.strokeStyle = '#e0e7ff';
  ctx.lineWidth = 1;
  [0, 25, 50, 75, 100].forEach(pct => {
    const y = pad.top + chartH - (pct / 100 * chartH);
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(pad.left + chartW, y);
    ctx.stroke();
    ctx.fillStyle = '#9ca3af';
    ctx.font = '9px system-ui, sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(pct + '%', pad.left - 4, y + 3);
  });

  const stacks = ['correct', 'misc-a', 'misc-b', 'misc-c', 'blank'];
  const colors = { correct: '#059669', 'misc-a': '#dc2626', 'misc-b': '#d97706', 'misc-c': '#7c3aed', blank: '#9ca3af' };
  const barW = Math.min(chartW / NUM_QUESTIONS - 8, 48);

  for (let q = 0; q < NUM_QUESTIONS; q++) {
    const c = countForQ(q);
    const responded = NUM_PUPILS - c.unset || 1;
    const x = pad.left + (q + 0.5) / NUM_QUESTIONS * chartW - barW / 2;

    let yBase = pad.top + chartH;
    stacks.forEach(key => {
      const val = key === 'misc-a' ? c['misc-a'] : key === 'misc-b' ? c['misc-b'] : key === 'misc-c' ? c['misc-c'] : c[key];
      if (val === 0) return;
      const pct = val / responded;
      const bh  = pct * chartH;
      ctx.fillStyle = colors[key];
      ctx.fillRect(x, yBase - bh, barW, bh);
      yBase -= bh;
    });

    // x label
    ctx.fillStyle = q === currentQ ? '#4f46e5' : '#6b7280';
    ctx.font = `${q === currentQ ? '700' : '500'} 10px system-ui, sans-serif`;
    ctx.textAlign = 'center';
    ctx.fillText(`Q${q + 1}`, pad.left + (q + 0.5) / NUM_QUESTIONS * chartW, pad.top + chartH + 14);
  }
  ctx.textAlign = 'left';
}

/* ════════════════════════════════════════════════════════════════
   GROUPING AND INTERVENTIONS
   ════════════════════════════════════════════════════════════════ */
function updateGroups() {
  const q = questions[currentQ];
  const container = document.getElementById('groups-container');

  const groups = {
    correct:  [],
    'misc-a': [],
    'misc-b': [],
    'misc-c': [],
    blank:    [],
  };
  responses[currentQ].forEach((r, i) => { if (r) groups[r].push(i); });

  const anyData = Object.values(groups).some(g => g.length > 0);
  if (!anyData) {
    container.innerHTML = `<div class="no-data">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
      Record responses in the grid above to see pupil groups and suggested interventions.
    </div>`;
    return;
  }

  const interventions = {
    correct:  `These pupils have demonstrated understanding. They are ready to extend their thinking. Consider: a challenge problem, peer-tutoring a partner, or a deeper-application task.`,
    'misc-a': `Pupils with Misconception A: <strong>${q.miscA || 'not specified'}</strong>. Suggested approach: targeted re-teaching of the underlying concept using a concrete or visual representation before returning to the abstract.`,
    'misc-b': `Pupils with Misconception B: <strong>${q.miscB || 'not specified'}</strong>. Suggested approach: provide a worked example that explicitly addresses this error and ask pupils to identify where the mistake occurs.`,
    'misc-c': `Pupils with Misconception C: <strong>${q.miscC || 'not specified'}</strong>. Suggested approach: 1-to-1 or small-group discussion to explore the pupil's reasoning before correcting.`,
    blank:    `No response recorded. Possible reasons: absent, disengaged, or struggling to access the question. Consider: a brief conversation at the start of the next lesson to diagnose understanding before introducing new content.`
  };

  const ORDER = ['correct', 'misc-a', 'misc-b', 'misc-c', 'blank'];
  container.innerHTML = ORDER.map(key => {
    const pupils = groups[key];
    if (pupils.length === 0) return '';
    const meta = RESPONSE_META[key];
    const names = pupils.map(i => `<span class="name-chip">${pupilNames[i]}</span>`).join('');
    const chevron = `<span class="group-chevron open">&#9654;</span>`;
    return `<div class="group-block">
      <div class="group-header ${meta.cls}" onclick="toggleGroup(this)">
        ${chevron} ${meta.label}
        <span class="group-count">${pupils.length} pupil${pupils.length !== 1 ? 's' : ''}</span>
      </div>
      <div class="group-body">
        <div class="group-names">${names}</div>
        <div class="group-intervention">${interventions[key]}</div>
      </div>
    </div>`;
  }).join('');
}

function toggleGroup(headerEl) {
  const body = headerEl.nextElementSibling;
  const chevron = headerEl.querySelector('.group-chevron');
  if (body.style.display === 'none') {
    body.style.display = '';
    chevron.classList.add('open');
  } else {
    body.style.display = 'none';
    chevron.classList.remove('open');
  }
}

/* ════════════════════════════════════════════════════════════════
   MASTER UPDATE
   ════════════════════════════════════════════════════════════════ */
function updateAll() {
  updateStats();
  drawPie();
  drawBar();
  updateGroups();
}

/* ════════════════════════════════════════════════════════════════
   PRESETS
   ════════════════════════════════════════════════════════════════ */
function loadPreset() {
  const key = document.getElementById('preset-select').value;
  if (!key) return;
  const qs = PRESETS[key];
  if (!qs) return;
  qs.forEach((p, i) => {
    if (i < NUM_QUESTIONS) {
      questions[i] = { text: p.text, correct: p.correct, miscA: p.miscA, miscB: p.miscB, miscC: p.miscC || '' };
    }
  });
  // clear responses when loading new preset
  for (let q = 0; q < NUM_QUESTIONS; q++) responses[q].fill(null);
  loadQuestionEditor();
  renderGrid();
  updateAll();
  showToast(`Preset loaded: ${document.getElementById('preset-select').options[document.getElementById('preset-select').selectedIndex].text}`);
}

function clearPreset() {
  document.getElementById('preset-select').value = '';
  for (let q = 0; q < NUM_QUESTIONS; q++) {
    questions[q] = { text: '', correct: '', miscA: '', miscB: '', miscC: '' };
    responses[q].fill(null);
  }
  loadQuestionEditor();
  renderGrid();
  updateAll();
  showToast('All questions cleared.');
}

/* ════════════════════════════════════════════════════════════════
   RESET
   ════════════════════════════════════════════════════════════════ */
function resetAll() {
  if (!confirm('Reset everything? All questions and responses will be cleared.')) return;
  document.getElementById('preset-select').value = '';
  for (let q = 0; q < NUM_QUESTIONS; q++) {
    questions[q] = { text: '', correct: '', miscA: '', miscB: '', miscC: '' };
    responses[q].fill(null);
  }
  for (let i = 0; i < NUM_PUPILS; i++) pupilNames[i] = `Pupil ${i + 1}`;
  document.getElementById('bulk-names').value = '';
  switchQuestion(0);
  showToast('All data reset.');
}

/* ════════════════════════════════════════════════════════════════
   PRINT
   ════════════════════════════════════════════════════════════════ */
function printSummary() {
  window.print();
}

/* ════════════════════════════════════════════════════════════════
   TOAST
   ════════════════════════════════════════════════════════════════ */
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2400);
}

/* ════════════════════════════════════════════════════════════════
   RESIZE: redraw charts
   ════════════════════════════════════════════════════════════════ */
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => { drawPie(); drawBar(); }, 120);
});

/* ════════════════════════════════════════════════════════════════
   BOOT
   ════════════════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
