<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Persuasive Techniques Spotter</title>
<style>
  :root {
    --bg: #ffffff;
    --text: #1a1a2e;
    --header-bg: #1a1a2e;
    --header-text: #ffffff;
    --border: #d1d5db;
    --panel-bg: #f8f9fa;
    --alliteration: #e63946;
    --facts: #457b9d;
    --opinions: #e9c46a;
    --rhetorical: #2a9d8f;
    --emotive: #f4a261;
    --statistics: #264653;
    --triples: #9b5de5;
    --correct: #22c55e;
    --incorrect: #ef4444;
    --alliteration-bg: rgba(230, 57, 70, 0.18);
    --facts-bg: rgba(69, 123, 157, 0.18);
    --opinions-bg: rgba(233, 196, 106, 0.25);
    --rhetorical-bg: rgba(42, 157, 143, 0.18);
    --emotive-bg: rgba(244, 162, 97, 0.22);
    --statistics-bg: rgba(38, 70, 83, 0.18);
    --triples-bg: rgba(155, 93, 229, 0.18);
    --radius: 6px;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--header-bg);
    color: var(--header-text);
    padding: 16px 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
  }
  header h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
  header p { font-size: 0.85rem; opacity: 0.8; margin-top: 2px; }

  .app-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
  }

  .main-col { min-width: 0; }

  /* Passage selector */
  .passage-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .passage-btn {
    padding: 8px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  .passage-btn:hover { border-color: var(--header-bg); }
  .passage-btn.active {
    background: var(--header-bg);
    color: var(--header-text);
    border-color: var(--header-bg);
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--panel-bg);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    align-items: center;
  }
  .toolbar-label {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: 4px;
    color: #666;
  }
  .tech-btn {
    padding: 6px 14px;
    border: 2px solid transparent;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 700;
    transition: all 0.2s;
    letter-spacing: 0.02em;
  }
  .tech-btn[data-tech="alliteration"] { background: var(--alliteration-bg); color: var(--alliteration); border-color: var(--alliteration); }
  .tech-btn[data-tech="facts"] { background: var(--facts-bg); color: var(--facts); border-color: var(--facts); }
  .tech-btn[data-tech="opinions"] { background: var(--opinions-bg); color: #8a6d00; border-color: var(--opinions); }
  .tech-btn[data-tech="rhetorical"] { background: var(--rhetorical-bg); color: var(--rhetorical); border-color: var(--rhetorical); }
  .tech-btn[data-tech="emotive"] { background: var(--emotive-bg); color: #c47a30; border-color: var(--emotive); }
  .tech-btn[data-tech="statistics"] { background: var(--statistics-bg); color: var(--statistics); border-color: var(--statistics); }
  .tech-btn[data-tech="triples"] { background: var(--triples-bg); color: var(--triples); border-color: var(--triples); }
  .tech-btn.active { transform: scale(1.08); box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
  .tech-btn:hover { transform: scale(1.05); }
  .eraser-btn {
    padding: 6px 14px;
    border: 2px solid var(--border);
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 700;
    background: #fff;
    color: #666;
    margin-left: auto;
  }
  .eraser-btn.active { background: #333; color: #fff; border-color: #333; }

  /* Passage display */
  .passage-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    margin-bottom: 16px;
  }
  .passage-title {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--header-bg);
  }
  .passage-source {
    font-size: 0.78rem;
    color: #888;
    margin-bottom: 16px;
    font-style: italic;
  }
  .passage-text {
    font-size: 1.05rem;
    line-height: 2;
    cursor: crosshair;
  }
  .passage-text .word {
    padding: 2px 1px;
    border-radius: 3px;
    transition: background 0.15s, outline 0.15s;
    cursor: pointer;
    position: relative;
  }
  .passage-text .word:hover { outline: 2px solid rgba(0,0,0,0.15); }

  .word.hl-alliteration { background: var(--alliteration-bg); outline: 2px solid var(--alliteration); }
  .word.hl-facts { background: var(--facts-bg); outline: 2px solid var(--facts); }
  .word.hl-opinions { background: var(--opinions-bg); outline: 2px solid var(--opinions); }
  .word.hl-rhetorical { background: var(--rhetorical-bg); outline: 2px solid var(--rhetorical); }
  .word.hl-emotive { background: var(--emotive-bg); outline: 2px solid var(--emotive); }
  .word.hl-statistics { background: var(--statistics-bg); outline: 2px solid var(--statistics); }
  .word.hl-triples { background: var(--triples-bg); outline: 2px solid var(--triples); }

  /* Check mode markers */
  .word .marker {
    display: none;
    position: absolute;
    top: -10px;
    right: -6px;
    font-size: 0.65rem;
    width: 16px;
    height: 16px;
    line-height: 16px;
    text-align: center;
    border-radius: 50%;
    font-weight: 700;
    pointer-events: none;
  }
  .word .marker.correct { display: block; background: var(--correct); color: #fff; }
  .word .marker.missed { display: block; background: var(--incorrect); color: #fff; }
  .word.answer-shown { outline: 2px dashed; }

  /* Action buttons */
  .action-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .action-btn {
    padding: 10px 22px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 700;
    transition: all 0.2s;
  }
  .check-btn { background: var(--header-bg); color: #fff; }
  .check-btn:hover { opacity: 0.9; }
  .reset-btn { background: var(--panel-bg); color: var(--text); border: 1px solid var(--border); }
  .reset-btn:hover { background: #e8e8e8; }

  /* Score display */
  .score-box {
    display: none;
    padding: 14px 20px;
    border-radius: var(--radius);
    background: var(--panel-bg);
    border: 2px solid var(--correct);
    margin-bottom: 16px;
    font-size: 0.95rem;
  }
  .score-box.visible { display: block; }
  .score-box strong { font-size: 1.2rem; }

  /* Right panel */
  .side-col {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .panel {
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
  }
  .panel h3 {
    font-size: 0.9rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 12px;
    color: var(--header-bg);
  }

  /* Tally */
  .tally-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 0.82rem;
    font-weight: 600;
  }
  .tally-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .tally-label { flex: 1; }
  .tally-count { font-weight: 800; min-width: 20px; text-align: right; }

  /* Bar chart */
  .chart-area { margin-top: 10px; }
  .chart-bar-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }
  .chart-bar-label {
    font-size: 0.7rem;
    font-weight: 700;
    width: 16px;
    text-align: center;
    flex-shrink: 0;
  }
  .chart-bar-track {
    flex: 1;
    height: 18px;
    background: #e5e7eb;
    border-radius: 9px;
    overflow: hidden;
  }
  .chart-bar-fill {
    height: 100%;
    border-radius: 9px;
    transition: width 0.3s ease;
    min-width: 0;
  }
  .chart-bar-val {
    font-size: 0.72rem;
    font-weight: 700;
    width: 20px;
    text-align: right;
    flex-shrink: 0;
  }

  /* Info panel */
  .info-item {
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }
  .info-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .info-letter {
    display: inline-block;
    width: 24px;
    height: 24px;
    line-height: 24px;
    text-align: center;
    border-radius: 50%;
    font-weight: 800;
    font-size: 0.75rem;
    color: #fff;
    margin-right: 6px;
    vertical-align: middle;
  }
  .info-name { font-weight: 700; font-size: 0.85rem; }
  .info-desc { font-size: 0.78rem; color: #555; margin-top: 3px; line-height: 1.5; }
  .info-example { font-size: 0.75rem; color: #888; margin-top: 2px; font-style: italic; }

  /* Responsive */
  @media (max-width: 900px) {
    .app-container {
      grid-template-columns: 1fr;
    }
    .side-col { order: -1; }
  }
  @media (max-width: 600px) {
    header { padding: 12px 16px; }
    header h1 { font-size: 1.2rem; }
    .app-container { padding: 12px; }
    .passage-card { padding: 16px; }
    .passage-text { font-size: 0.95rem; }
    .toolbar { padding: 8px; gap: 4px; }
    .tech-btn { padding: 5px 10px; font-size: 0.72rem; }
  }
</style>
</head>
<body>

<header>
  <h1>Persuasive Techniques Spotter</h1>
  <p>Annotate passages to identify AFOREST persuasive devices</p>
</header>

<div class="app-container">
  <div class="main-col">
    <div class="passage-selector" id="passageSelector"></div>

    <div class="toolbar" id="toolbar">
      <span class="toolbar-label">Technique:</span>
      <button class="tech-btn" data-tech="alliteration">A - Alliteration</button>
      <button class="tech-btn" data-tech="facts">F - Facts</button>
      <button class="tech-btn" data-tech="opinions">O - Opinions</button>
      <button class="tech-btn" data-tech="rhetorical">R - Rhetorical Q</button>
      <button class="tech-btn" data-tech="emotive">E - Emotive</button>
      <button class="tech-btn" data-tech="statistics">S - Statistics</button>
      <button class="tech-btn" data-tech="triples">T - Triples</button>
      <button class="eraser-btn" id="eraserBtn">Eraser</button>
    </div>

    <div class="passage-card">
      <div class="passage-title" id="passageTitle"></div>
      <div class="passage-source" id="passageSource"></div>
      <div class="passage-text" id="passageText"></div>
    </div>

    <div class="action-bar">
      <button class="action-btn check-btn" id="checkBtn">Check Answers</button>
      <button class="action-btn reset-btn" id="resetBtn">Reset Annotations</button>
    </div>

    <div class="score-box" id="scoreBox"></div>
  </div>

  <div class="side-col">
    <div class="panel">
      <h3>Your Annotations</h3>
      <div id="tallyArea"></div>
      <div class="chart-area" id="chartArea"></div>
    </div>

    <div class="panel">
      <h3>AFOREST Techniques</h3>
      <div id="infoPanel"></div>
    </div>
  </div>
</div>

<script>
(function() {
  "use strict";

  /* ====== TECHNIQUE DEFINITIONS ====== */
  var TECHNIQUES = {
    alliteration: { key: "A", name: "Alliteration", color: "#e63946", desc: "Repetition of the same consonant sound at the start of nearby words to create a memorable, rhythmic effect.", example: "e.g. \"Peter Piper picked a peck of pickled peppers\"" },
    facts:        { key: "F", name: "Facts", color: "#457b9d", desc: "Verifiable statements used to build credibility and support an argument with evidence.", example: "e.g. \"The Earth orbits the Sun every 365.25 days\"" },
    opinions:     { key: "O", name: "Opinions", color: "#b8960a", desc: "Personal beliefs or viewpoints presented to persuade the audience to share the writer's perspective.", example: "e.g. \"This is the greatest challenge of our generation\"" },
    rhetorical:   { key: "R", name: "Rhetorical Questions", color: "#2a9d8f", desc: "Questions asked for effect rather than to receive an answer, prompting the audience to think.", example: "e.g. \"How can we stand by and do nothing?\"" },
    emotive:      { key: "E", name: "Emotive Language", color: "#c47a30", desc: "Words deliberately chosen to provoke an emotional response in the reader or listener.", example: "e.g. \"innocent\", \"heartbreaking\", \"devastating\"" },
    statistics:   { key: "S", name: "Statistics", color: "#264653", desc: "Numerical data and percentages used to add authority and factual weight to an argument.", example: "e.g. \"73% of students agreed\"" },
    triples:      { key: "T", name: "Triples (Rule of Three)", color: "#9b5de5", desc: "A list of three words, phrases, or ideas used together for emphasis and rhythm.", example: "e.g. \"stronger, safer, fairer\"" }
  };

  /* ====== PASSAGE DATA ======
     Each passage has:
       - title, source, text (string)
       - annotations: array of { words: [indices], tech: technique-key }
         where indices refer to zero-based word positions in the text
  */
  var PASSAGES = [
    {
      id: "speech",
      label: "Inspiring Speech",
      title: "Address to Young People",
      source: "Fictional graduation ceremony speech",
      text: "You stand at the start of something extraordinary. Brilliant, brave, bold: that is what you are. Did you know that 89% of graduates who follow their passion report higher life satisfaction? Can you really afford to waste your precious potential on a path that leaves you empty? I believe this generation will be the greatest force for good the world has ever seen. Your dreams deserve dedication, determination and drive. Every single heartbreaking setback you face will forge you into someone unstoppable. Together, we will build a brighter, bolder, better future.",
      annotations: [
        { words: [7,8,9], tech: "opinions" },
        { words: [10,11,12], tech: "triples" },
        { words: [10], tech: "alliteration" },
        { words: [11], tech: "alliteration" },
        { words: [12], tech: "alliteration" },
        { words: [22,23,24,25,26,27,28,29,30,31,32], tech: "statistics" },
        { words: [33,34,35,36,37,38,39,40,41,42,43,44,45], tech: "rhetorical" },
        { words: [38], tech: "emotive" },
        { words: [46,47,48,49,50,51,52,53,54,55,56,57,58,59], tech: "opinions" },
        { words: [62,63], tech: "alliteration" },
        { words: [61,62,63], tech: "triples" },
        { words: [66,67], tech: "emotive" },
        { words: [78,79,80], tech: "triples" },
        { words: [78], tech: "alliteration" },
        { words: [79], tech: "alliteration" },
        { words: [80], tech: "alliteration" }
      ]
    },
    {
      id: "newspaper",
      label: "Opinion Column",
      title: "Screen Time is Stealing Our Children's Childhood",
      source: "Fictional newspaper opinion column",
      text: "Our children are drowning in a digital sea of distraction. Research confirms that the average teenager spends over seven hours a day glued to screens. Seven wasted, squandered, stolen hours. Is it any wonder that anxiety among young people has risen by 40% in the last decade? We must act now. These vulnerable, innocent young minds deserve protection, not exploitation. The simple, shocking, scandalous truth is that tech companies profit from addiction. Every parent knows this is wrong. We need stricter regulations, stronger safeguards and smarter solutions before an entire generation is lost.",
      annotations: [
        { words: [3,4], tech: "emotive" },
        { words: [8,9,10], tech: "alliteration" },
        { words: [12,13,14,15,16,17,18,19,20,21,22,23,24], tech: "facts" },
        { words: [25,26,27,28], tech: "triples" },
        { words: [30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45], tech: "rhetorical" },
        { words: [40,41,42], tech: "statistics" },
        { words: [51,52,53], tech: "emotive" },
        { words: [55], tech: "emotive" },
        { words: [58], tech: "emotive" },
        { words: [60,61,62], tech: "triples" },
        { words: [60], tech: "alliteration" },
        { words: [61], tech: "alliteration" },
        { words: [62], tech: "alliteration" },
        { words: [66,67,68], tech: "emotive" },
        { words: [70,71], tech: "opinions" },
        { words: [78,79,80,81], tech: "triples" },
        { words: [78], tech: "alliteration" },
        { words: [79], tech: "alliteration" },
        { words: [80], tech: "alliteration" }
      ]
    },
    {
      id: "advert",
      label: "Advertisement",
      title: "PureWater: Refreshment Redefined",
      source: "Fictional bottled water advertisement",
      text: "Pure, pristine, perfect. That is the promise of PureWater. Sourced from natural mountain springs tested over 200 times for quality, our water is the cleanest you will ever taste. Why would you settle for anything less than the best? PureWater is trusted by 3 million families across the country. It is crisp, clean and completely refreshing. Leading nutritionists agree that proper hydration boosts energy, sharpens focus and improves wellbeing. Do you not deserve to feel fantastic every single day? Choose PureWater. Choose life. Choose brilliance.",
      annotations: [
        { words: [0,1,2], tech: "triples" },
        { words: [0], tech: "alliteration" },
        { words: [1], tech: "alliteration" },
        { words: [2], tech: "alliteration" },
        { words: [10,11,12,13,14,15], tech: "statistics" },
        { words: [20,21,22,23,24], tech: "opinions" },
        { words: [25,26,27,28,29,30,31,32,33], tech: "rhetorical" },
        { words: [35,36,37,38,39,40,41,42], tech: "statistics" },
        { words: [47,48,49], tech: "triples" },
        { words: [47], tech: "alliteration" },
        { words: [48], tech: "alliteration" },
        { words: [51,52,53,54,55,56,57,58,59,60,61], tech: "facts" },
        { words: [62,63,64,65,66,67,68,69,70], tech: "rhetorical" },
        { words: [65], tech: "emotive" },
        { words: [73,74,75], tech: "triples" }
      ]
    },
    {
      id: "charity",
      label: "Charity Appeal",
      title: "Give Hope, Give Life",
      source: "Fictional charity fundraising letter",
      text: "Right now, a child is going to bed hungry, cold and alone. Every six seconds, a child dies from hunger-related causes. This is not a distant problem. This is happening here, happening now, happening to real families. Can you honestly look away while innocent children suffer? Your donation of just five pounds could provide meals for a week. Caring, compassionate, committed people like you are the difference between life and death. We believe no child should ever go to sleep frightened and forgotten. Together we can turn tragedy into triumph, tears into hope.",
      annotations: [
        { words: [5,6,7,8,9,10,11], tech: "emotive" },
        { words: [8,9,10], tech: "triples" },
        { words: [12,13,14,15,16,17,18,19], tech: "statistics" },
        { words: [26,27,28,29], tech: "triples" },
        { words: [33,34,35,36,37,38,39,40,41], tech: "rhetorical" },
        { words: [38], tech: "emotive" },
        { words: [39], tech: "emotive" },
        { words: [40], tech: "emotive" },
        { words: [44,45,46,47,48,49,50,51,52,53], tech: "statistics" },
        { words: [54,55,56], tech: "triples" },
        { words: [54], tech: "alliteration" },
        { words: [55], tech: "alliteration" },
        { words: [56], tech: "alliteration" },
        { words: [66,67,68,69,70,71,72,73,74], tech: "opinions" },
        { words: [73], tech: "emotive" },
        { words: [74], tech: "emotive" },
        { words: [77,78,79], tech: "alliteration" },
        { words: [80,81,82], tech: "alliteration" }
      ]
    },
    {
      id: "political",
      label: "Political Speech",
      title: "A Nation Ready for Change",
      source: "Fictional political campaign address",
      text: "Friends, the time for talk is over. Sixty-two percent of people in this country feel let down by broken promises. Are we going to accept more of the same tired excuses? I say no. We need policies that are fair, funded and forward-thinking. Poverty, pollution and poor services plague our communities. Families are struggling, suffering and losing hope. This magnificent country deserves decisive, dynamic, dedicated leadership. Together we will rebuild trust, restore pride and renew purpose. The future belongs not to the fearful but to the faithful, the bold and the brave.",
      annotations: [
        { words: [2,3,4,5,6], tech: "opinions" },
        { words: [7,8,9,10,11,12,13,14,15,16,17], tech: "statistics" },
        { words: [18,19,20,21,22,23,24,25,26,27], tech: "rhetorical" },
        { words: [34,35,36], tech: "triples" },
        { words: [34], tech: "alliteration" },
        { words: [35], tech: "alliteration" },
        { words: [36], tech: "alliteration" },
        { words: [37,38,39], tech: "triples" },
        { words: [37], tech: "alliteration" },
        { words: [38], tech: "alliteration" },
        { words: [43,44,45], tech: "triples" },
        { words: [43], tech: "emotive" },
        { words: [44], tech: "emotive" },
        { words: [47], tech: "emotive" },
        { words: [48], tech: "opinions" },
        { words: [50,51,52], tech: "triples" },
        { words: [50], tech: "alliteration" },
        { words: [51], tech: "alliteration" },
        { words: [52], tech: "alliteration" },
        { words: [55,56,57,58,59,60,61], tech: "triples" },
        { words: [67,68,69,70,71,72,73,74,75], tech: "triples" }
      ]
    }
  ];

  /* ====== STATE ====== */
  var currentPassageIdx = 0;
  var activeTech = null;
  var eraserMode = false;
  var userAnnotations = {};   // { wordIdx: techKey }
  var checked = false;
  var wordSpans = [];

  /* ====== DOM REFS ====== */
  var passageSelector = document.getElementById("passageSelector");
  var passageTitle = document.getElementById("passageTitle");
  var passageSource = document.getElementById("passageSource");
  var passageText = document.getElementById("passageText");
  var tallyArea = document.getElementById("tallyArea");
  var chartArea = document.getElementById("chartArea");
  var infoPanel = document.getElementById("infoPanel");
  var scoreBox = document.getElementById("scoreBox");
  var checkBtn = document.getElementById("checkBtn");
  var resetBtn = document.getElementById("resetBtn");
  var eraserBtn = document.getElementById("eraserBtn");
  var toolbar = document.getElementById("toolbar");

  /* ====== INIT ====== */
  buildPassageButtons();
  buildInfoPanel();
  bindToolbar();
  loadPassage(0);

  /* ====== PASSAGE BUTTONS ====== */
  function buildPassageButtons() {
    PASSAGES.forEach(function(p, i) {
      var btn = document.createElement("button");
      btn.className = "passage-btn";
      btn.textContent = p.label;
      btn.addEventListener("click", function() { loadPassage(i); });
      passageSelector.appendChild(btn);
    });
  }

  /* ====== INFO PANEL ====== */
  function buildInfoPanel() {
    var html = "";
    var keys = ["alliteration","facts","opinions","rhetorical","emotive","statistics","triples"];
    keys.forEach(function(k) {
      var t = TECHNIQUES[k];
      html += '<div class="info-item">';
      html += '<span class="info-letter" style="background:' + t.color + '">' + t.key + '</span>';
      html += '<span class="info-name">' + t.name + '</span>';
      html += '<div class="info-desc">' + t.desc + '</div>';
      html += '<div class="info-example">' + t.example + '</div>';
      html += '</div>';
    });
    infoPanel.innerHTML = html;
  }

  /* ====== TOOLBAR ====== */
  function bindToolbar() {
    var techBtns = toolbar.querySelectorAll(".tech-btn");
    techBtns.forEach(function(btn) {
      btn.addEventListener("click", function() {
        if (checked) return;
        var tech = btn.getAttribute("data-tech");
        if (activeTech === tech) {
          activeTech = null;
          btn.classList.remove("active");
        } else {
          techBtns.forEach(function(b) { b.classList.remove("active"); });
          eraserBtn.classList.remove("active");
          eraserMode = false;
          activeTech = tech;
          btn.classList.add("active");
        }
      });
    });
    eraserBtn.addEventListener("click", function() {
      if (checked) return;
      eraserMode = !eraserMode;
      if (eraserMode) {
        activeTech = null;
        techBtns.forEach(function(b) { b.classList.remove("active"); });
        eraserBtn.classList.add("active");
      } else {
        eraserBtn.classList.remove("active");
      }
    });
    checkBtn.addEventListener("click", checkAnswers);
    resetBtn.addEventListener("click", resetAnnotations);
  }

  /* ====== LOAD PASSAGE ====== */
  function loadPassage(idx) {
    currentPassageIdx = idx;
    checked = false;
    userAnnotations = {};
    activeTech = null;
    eraserMode = false;
    scoreBox.classList.remove("visible");

    // Update toolbar visuals
    toolbar.querySelectorAll(".tech-btn").forEach(function(b) { b.classList.remove("active"); });
    eraserBtn.classList.remove("active");

    // Update selector buttons
    var btns = passageSelector.querySelectorAll(".passage-btn");
    btns.forEach(function(b, i) {
      b.classList.toggle("active", i === idx);
    });

    var p = PASSAGES[idx];
    passageTitle.textContent = p.title;
    passageSource.textContent = p.source;

    // Build word spans
    var words = p.text.split(/\s+/);
    passageText.innerHTML = "";
    wordSpans = [];
    words.forEach(function(w, i) {
      var span = document.createElement("span");
      span.className = "word";
      span.textContent = w;
      span.setAttribute("data-idx", i);
      span.addEventListener("click", function() { onWordClick(i); });
      passageText.appendChild(span);
      if (i < words.length - 1) {
        passageText.appendChild(document.createTextNode(" "));
      }
      wordSpans.push(span);
    });

    updateTally();
  }

  /* ====== WORD CLICK ====== */
  function onWordClick(idx) {
    if (checked) return;

    if (eraserMode) {
      if (userAnnotations[idx]) {
        delete userAnnotations[idx];
        renderHighlights();
        updateTally();
      }
      return;
    }

    if (!activeTech) return;

    // Toggle: if same technique, remove; if different, overwrite
    if (userAnnotations[idx] === activeTech) {
      delete userAnnotations[idx];
    } else {
      userAnnotations[idx] = activeTech;
    }
    renderHighlights();
    updateTally();
  }

  /* ====== RENDER HIGHLIGHTS ====== */
  function renderHighlights() {
    wordSpans.forEach(function(span, i) {
      // Remove all highlight classes
      span.className = "word";
      // Remove any markers
      var existing = span.querySelector(".marker");
      if (existing) existing.remove();

      if (userAnnotations[i]) {
        span.classList.add("hl-" + userAnnotations[i]);
      }
    });
  }

  /* ====== UPDATE TALLY + CHART ====== */
  function updateTally() {
    var counts = {};
    var keys = ["alliteration","facts","opinions","rhetorical","emotive","statistics","triples"];
    keys.forEach(function(k) { counts[k] = 0; });
    for (var idx in userAnnotations) {
      if (userAnnotations.hasOwnProperty(idx)) {
        var t = userAnnotations[idx];
        if (counts[t] !== undefined) counts[t]++;
      }
    }

    var maxCount = 1;
    keys.forEach(function(k) { if (counts[k] > maxCount) maxCount = counts[k]; });

    var tallyHtml = "";
    var chartHtml = "";
    keys.forEach(function(k) {
      var t = TECHNIQUES[k];
      tallyHtml += '<div class="tally-row">';
      tallyHtml += '<span class="tally-dot" style="background:' + t.color + '"></span>';
      tallyHtml += '<span class="tally-label">' + t.name + '</span>';
      tallyHtml += '<span class="tally-count">' + counts[k] + '</span>';
      tallyHtml += '</div>';

      var pct = Math.round((counts[k] / maxCount) * 100);
      chartHtml += '<div class="chart-bar-row">';
      chartHtml += '<span class="chart-bar-label" style="color:' + t.color + '">' + t.key + '</span>';
      chartHtml += '<div class="chart-bar-track"><div class="chart-bar-fill" style="width:' + pct + '%;background:' + t.color + '"></div></div>';
      chartHtml += '<span class="chart-bar-val">' + counts[k] + '</span>';
      chartHtml += '</div>';
    });

    tallyArea.innerHTML = tallyHtml;
    chartArea.innerHTML = chartHtml;
  }

  /* ====== CHECK ANSWERS ====== */
  function checkAnswers() {
    if (checked) return;
    checked = true;

    var p = PASSAGES[currentPassageIdx];

    // Build expected map: wordIdx -> Set of techniques
    var expected = {};
    p.annotations.forEach(function(ann) {
      ann.words.forEach(function(w) {
        if (!expected[w]) expected[w] = new Set();
        expected[w].add(ann.tech);
      });
    });

    // Count unique expected word-technique pairs
    var totalExpected = 0;
    for (var key in expected) {
      if (expected.hasOwnProperty(key)) {
        totalExpected += expected[key].size;
      }
    }

    var correctCount = 0;
    var userCount = 0;

    // Check user annotations
    for (var idx in userAnnotations) {
      if (!userAnnotations.hasOwnProperty(idx)) continue;
      userCount++;
      var userTech = userAnnotations[idx];
      var i = parseInt(idx);
      if (expected[i] && expected[i].has(userTech)) {
        correctCount++;
        addMarker(wordSpans[i], "correct", "\u2713");
      }
    }

    // Show missed annotations
    for (var wIdx in expected) {
      if (!expected.hasOwnProperty(wIdx)) continue;
      var w = parseInt(wIdx);
      expected[w].forEach(function(tech) {
        if (userAnnotations[w] !== tech) {
          // Only show the first missed technique per word visually
          if (!wordSpans[w].querySelector(".marker")) {
            wordSpans[w].classList.add("answer-shown");
            wordSpans[w].classList.add("hl-" + tech);
            wordSpans[w].style.outlineColor = "var(--" + tech + ")";
            addMarker(wordSpans[w], "missed", "\u2717");
          }
        }
      });
    }

    // Score
    scoreBox.innerHTML = "Score: <strong>" + correctCount + " / " + totalExpected + "</strong> technique annotations correctly identified." +
      (correctCount === totalExpected ? " Excellent work!" : correctCount > totalExpected * 0.6 ? " Good effort! Review the missed items above." : " Keep practising! Study the AFOREST guide on the right.");
    scoreBox.classList.add("visible");
  }

  function addMarker(span, cls, symbol) {
    var m = document.createElement("span");
    m.className = "marker " + cls;
    m.textContent = symbol;
    span.appendChild(m);
  }

  /* ====== RESET ====== */
  function resetAnnotations() {
    userAnnotations = {};
    checked = false;
    activeTech = null;
    eraserMode = false;
    toolbar.querySelectorAll(".tech-btn").forEach(function(b) { b.classList.remove("active"); });
    eraserBtn.classList.remove("active");
    scoreBox.classList.remove("visible");

    wordSpans.forEach(function(span) {
      span.className = "word";
      span.style.outlineColor = "";
      var m = span.querySelector(".marker");
      if (m) m.remove();
    });
    updateTally();
  }

})();
</script>
</body>
</html>