<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Value Added Scatter Plot</title>
<style>
  :root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #1e293b;
    --bg-panel: #162032;
    --border: #334155;
    --border-light: #475569;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --teal: #14b8a6;
    --teal-light: #2dd4bf;
    --teal-dark: #0d9488;
    --teal-dim: rgba(20,184,166,0.15);
    --teal-dim2: rgba(20,184,166,0.08);
    --slate: #334155;
    --positive: #22c55e;
    --positive-dim: rgba(34,197,94,0.18);
    --negative: #f43f5e;
    --negative-dim: rgba(244,63,94,0.18);
    --warning: #f59e0b;
    --info: #38bdf8;
    --col-pp: #f59e0b;
    --col-nonpp: #14b8a6;
    --col-sen: #a78bfa;
    --col-eal: #fb923c;
    --col-outlier-ring: #f43f5e;
    --radius: 8px;
    --radius-sm: 4px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* ---- Header ---- */
  header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .header-icon {
    width: 40px; height: 40px;
    background: var(--teal-dim);
    border: 1px solid var(--teal);
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }
  header h1 {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--teal-light);
    letter-spacing: -0.02em;
  }
  header p {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* ---- Layout ---- */
  .app-layout {
    display: grid;
    grid-template-columns: 220px 1fr 260px;
    grid-template-rows: auto 1fr;
    gap: 0;
    height: calc(100vh - 73px);
  }

  /* ---- Info Banner ---- */
  .info-banner {
    grid-column: 1 / -1;
    background: var(--teal-dim2);
    border-bottom: 1px solid var(--border);
    padding: 10px 24px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 0.78rem;
    color: var(--text-secondary);
  }
  .info-banner .icon { color: var(--teal); font-size: 1rem; margin-top: 1px; flex-shrink: 0; }
  .info-banner strong { color: var(--teal-light); }

  /* ---- Left Panel ---- */
  .left-panel {
    background: var(--bg-panel);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .panel-section h3 {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  /* ---- Filter checkboxes ---- */
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .filter-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 5px 8px;
    border-radius: var(--radius-sm);
    transition: background 0.15s;
    font-size: 0.82rem;
  }
  .filter-item:hover { background: var(--border); }
  .filter-item input[type="checkbox"] { display: none; }
  .filter-dot {
    width: 14px; height: 14px;
    border-radius: 50%;
    border: 2px solid transparent;
    flex-shrink: 0;
    transition: opacity 0.2s;
  }
  .filter-item.active .filter-dot { opacity: 1; }
  .filter-item.inactive .filter-dot { opacity: 0.35; }
  .filter-count {
    margin-left: auto;
    font-size: 0.7rem;
    color: var(--text-muted);
    background: var(--bg-secondary);
    padding: 1px 5px;
    border-radius: 10px;
  }

  /* ---- Display toggles ---- */
  .toggle-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .toggle-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 0.82rem;
    color: var(--text-secondary);
    cursor: pointer;
  }
  .toggle-item:hover { color: var(--text-primary); }
  .toggle-switch {
    width: 32px; height: 17px;
    background: var(--border);
    border-radius: 9px;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle-switch.on { background: var(--teal-dark); }
  .toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px; left: 2px;
    width: 13px; height: 13px;
    background: var(--text-primary);
    border-radius: 50%;
    transition: transform 0.2s;
  }
  .toggle-switch.on::after { transform: translateX(15px); }

  /* ---- Concept box ---- */
  .concept-box {
    background: var(--teal-dim2);
    border: 1px solid var(--teal-dark);
    border-radius: var(--radius-sm);
    padding: 10px;
    font-size: 0.76rem;
    color: var(--text-secondary);
    line-height: 1.6;
  }
  .concept-box .concept-title {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--teal-light);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 5px;
  }

  /* ---- Main chart area ---- */
  .chart-area {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-primary);
    position: relative;
  }
  .chart-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .chart-toolbar-label {
    font-size: 0.72rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-right: 4px;
  }
  .btn {
    padding: 5px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-primary);
    color: var(--text-secondary);
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.15s;
    font-family: var(--font);
  }
  .btn:hover { border-color: var(--teal); color: var(--teal-light); }
  .btn.active { background: var(--teal-dim); border-color: var(--teal); color: var(--teal-light); }
  .btn.primary { background: var(--teal-dark); border-color: var(--teal); color: #fff; }
  .btn.primary:hover { background: var(--teal); }
  .spacer { flex: 1; }

  .chart-wrapper {
    flex: 1;
    position: relative;
    overflow: hidden;
    padding: 8px;
  }
  #scatter-svg {
    width: 100%;
    height: 100%;
    cursor: crosshair;
    display: block;
  }

  /* SVG elements */
  .grid-line { stroke: var(--border); stroke-width: 0.5; }
  .axis-line { stroke: var(--border-light); stroke-width: 1; }
  .axis-label { fill: var(--text-muted); font-size: 11px; font-family: var(--font); }
  .axis-title { fill: var(--text-secondary); font-size: 12px; font-family: var(--font); font-weight: 600; }
  .regression-line { stroke: var(--teal); stroke-width: 2; stroke-dasharray: none; }
  .whatif-line { stroke: var(--warning); stroke-width: 2; stroke-dasharray: 6 3; }
  .residual-bar { stroke-width: 1.5; opacity: 0.55; }
  .residual-bar.pos { stroke: var(--positive); }
  .residual-bar.neg { stroke: var(--negative); }
  .data-point { stroke-width: 1.5; cursor: pointer; transition: r 0.15s; }
  .data-point:hover { filter: brightness(1.3); }
  .outlier-ring { stroke: var(--col-outlier-ring); stroke-width: 2; fill: none; stroke-dasharray: 3 2; }
  .confband { fill: rgba(20,184,166,0.06); }
  .legend-text { fill: var(--text-secondary); font-size: 11px; font-family: var(--font); }

  /* ---- Tooltip ---- */
  #tooltip {
    position: fixed;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 10px 13px;
    font-size: 0.78rem;
    pointer-events: none;
    box-shadow: var(--shadow);
    z-index: 9999;
    display: none;
    min-width: 180px;
    max-width: 220px;
  }
  #tooltip .tt-name {
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--text-primary);
    margin-bottom: 5px;
  }
  #tooltip .tt-group {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 7px;
  }
  #tooltip .tt-row {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 2px;
    color: var(--text-secondary);
  }
  #tooltip .tt-row span:last-child { color: var(--text-primary); font-weight: 600; }
  #tooltip .tt-residual {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid var(--border);
    font-size: 0.75rem;
  }
  #tooltip .tt-residual.pos { color: var(--positive); }
  #tooltip .tt-residual.neg { color: var(--negative); }
  #tooltip .tt-outlier {
    margin-top: 4px;
    font-size: 0.7rem;
    color: var(--col-outlier-ring);
    font-weight: 700;
  }

  /* ---- What-if instructions overlay ---- */
  .whatif-hint {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(245,158,11,0.12);
    border: 1px solid var(--warning);
    border-radius: var(--radius-sm);
    padding: 5px 12px;
    font-size: 0.74rem;
    color: var(--warning);
    pointer-events: none;
    display: none;
    white-space: nowrap;
  }
  .whatif-hint.visible { display: block; }

  /* ---- Right panel ---- */
  .right-panel {
    background: var(--bg-panel);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  /* ---- Stats cards ---- */
  .stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
  }
  .stat-card h4 {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 8px;
    font-weight: 700;
  }
  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.8rem;
  }
  .stat-row:last-child { border-bottom: none; }
  .stat-label { color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
  .stat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .stat-value { font-weight: 700; font-size: 0.85rem; }
  .stat-value.pos { color: var(--positive); }
  .stat-value.neg { color: var(--negative); }
  .stat-value.neu { color: var(--text-primary); }

  .model-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .model-stat-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 10px;
  }
  .model-stat-item .msi-label {
    font-size: 0.68rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 3px;
  }
  .model-stat-item .msi-value {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--teal-light);
  }

  /* ---- Outlier list ---- */
  .outlier-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 180px;
    overflow-y: auto;
  }
  .outlier-item {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 5px 8px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.76rem;
    border: 1px solid transparent;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .outlier-item:hover { border-color: var(--border-light); }
  .outlier-item .oi-name { color: var(--text-primary); font-weight: 600; flex: 1; }
  .outlier-item .oi-res { font-weight: 700; font-size: 0.78rem; }
  .outlier-item .oi-res.pos { color: var(--positive); }
  .outlier-item .oi-res.neg { color: var(--negative); }

  /* ---- Export ---- */
  #export-output {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px;
    font-size: 0.72rem;
    color: var(--text-secondary);
    line-height: 1.6;
    white-space: pre-wrap;
    font-family: 'Cascadia Code', 'Consolas', monospace;
    display: none;
    max-height: 220px;
    overflow-y: auto;
  }
  #export-output.visible { display: block; }

  /* ---- Responsive ---- */
  @media (max-width: 1100px) {
    .app-layout {
      grid-template-columns: 190px 1fr 220px;
    }
  }
  @media (max-width: 900px) {
    .app-layout {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto auto;
      height: auto;
    }
    .left-panel, .right-panel {
      border: none;
      border-top: 1px solid var(--border);
    }
    .chart-area { height: 420px; }
    .info-banner { flex-direction: column; gap: 6px; }
  }
  @media (max-width: 768px) {
    header { padding: 12px 16px; }
    header h1 { font-size: 1.05rem; }
    .chart-area { height: 360px; }
    .chart-toolbar { padding: 8px 10px; gap: 5px; }
    .btn { padding: 4px 9px; font-size: 0.74rem; }
    .left-panel, .right-panel { padding: 12px; }
    .model-stats { grid-template-columns: 1fr 1fr; }
  }

  /* ---- Scrollbar ---- */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--teal-dark); }
</style>
</head>
<body>

<header>
  <div class="header-icon">&#x1F4CA;</div>
  <div>
    <h1>Value Added Scatter Plot</h1>
    <p>Prior attainment vs outcomes with regression line and residuals</p>
  </div>
</header>

<div class="app-layout">

  <!-- Info banner -->
  <div class="info-banner">
    <span class="icon">&#9432;</span>
    <span>
      <strong>Value added</strong> measures pupil progress beyond what their prior attainment would predict.
      The regression line sets the expectation: pupils <strong>above</strong> the line made more progress than expected (positive residual), those <strong>below</strong> made less.
      Drag the amber dashed line to model alternative expectations. Hover any point for detail.
    </span>
  </div>

  <!-- Left panel -->
  <aside class="left-panel">

    <div class="panel-section">
      <h3>Filter Groups</h3>
      <div class="filter-group" id="filter-group">
        <label class="filter-item active" data-group="PP" title="Pupil Premium">
          <input type="checkbox" checked>
          <span class="filter-dot" style="background:var(--col-pp);border-color:var(--col-pp)"></span>
          Pupil Premium
          <span class="filter-count" id="count-PP">0</span>
        </label>
        <label class="filter-item active" data-group="Non-PP" title="Non-Pupil Premium">
          <input type="checkbox" checked>
          <span class="filter-dot" style="background:var(--col-nonpp);border-color:var(--col-nonpp)"></span>
          Non-PP
          <span class="filter-count" id="count-Non-PP">0</span>
        </label>
        <label class="filter-item active" data-group="SEN" title="Special Educational Needs">
          <input type="checkbox" checked>
          <span class="filter-dot" style="background:var(--col-sen);border-color:var(--col-sen)"></span>
          SEN
          <span class="filter-count" id="count-SEN">0</span>
        </label>
        <label class="filter-item active" data-group="EAL" title="English as Additional Language">
          <input type="checkbox" checked>
          <span class="filter-dot" style="background:var(--col-eal);border-color:var(--col-eal)"></span>
          EAL
          <span class="filter-count" id="count-EAL">0</span>
        </label>
      </div>
    </div>

    <div class="panel-section">
      <h3>Display</h3>
      <div class="toggle-list">
        <div class="toggle-item" id="toggle-residuals" data-key="showResiduals">
          <span>Residual bars</span>
          <span class="toggle-switch on" id="sw-residuals"></span>
        </div>
        <div class="toggle-item" id="toggle-confband" data-key="showConfBand">
          <span>Confidence band</span>
          <span class="toggle-switch on" id="sw-confband"></span>
        </div>
        <div class="toggle-item" id="toggle-outliers" data-key="showOutliers">
          <span>Outlier markers</span>
          <span class="toggle-switch on" id="sw-outliers"></span>
        </div>
        <div class="toggle-item" id="toggle-labels" data-key="showLabels">
          <span>Student labels</span>
          <span class="toggle-switch" id="sw-labels"></span>
        </div>
        <div class="toggle-item" id="toggle-whatif" data-key="showWhatIf">
          <span>What-if line</span>
          <span class="toggle-switch" id="sw-whatif"></span>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <h3>Residual Concept</h3>
      <div class="concept-box">
        <div class="concept-title">What is a residual?</div>
        A <strong style="color:var(--teal-light)">residual</strong> is the vertical distance between a pupil's actual outcome and the regression line's prediction for their prior attainment.
        <br><br>
        Positive residual (above line): the pupil exceeded expectations. Negative residual (below line): the pupil fell short of expectations.
        <br><br>
        Large residuals flag pupils who may need investigation: why did they over- or under-perform?
      </div>
    </div>

    <div class="panel-section">
      <h3>Intervention Guide</h3>
      <div class="concept-box">
        <div class="concept-title">Using this chart</div>
        1. Pupils in the <strong style="color:var(--negative)">bottom-left</strong> with large negative residuals: high priority for support.<br><br>
        2. Pupils in the <strong style="color:var(--positive)">top area</strong> with high prior attainment and positive residuals: evidence of strong teaching.<br><br>
        3. Compare group mean residuals in the stats panel to identify systemic gaps.
      </div>
    </div>

  </aside>

  <!-- Main chart -->
  <main class="chart-area">
    <div class="chart-toolbar">
      <span class="chart-toolbar-label">Axis:</span>
      <button class="btn active" id="btn-axis-ks2" onclick="setAxis('ks2')">KS2 Score</button>
      <button class="btn" id="btn-axis-raw" onclick="setAxis('raw')">Raw Score</button>
      <div class="spacer"></div>
      <button class="btn" id="btn-reset-whatif" onclick="resetWhatIf()" style="display:none">Reset What-If</button>
      <button class="btn primary" onclick="doExport()">Export Summary</button>
    </div>
    <div class="chart-wrapper">
      <svg id="scatter-svg" xmlns="http://www.w3.org/2000/svg"></svg>
      <div class="whatif-hint" id="whatif-hint">Drag the amber line up or down to model alternative expectations</div>
    </div>
  </main>

  <!-- Right panel -->
  <aside class="right-panel">

    <div>
      <div class="panel-section" style="margin-bottom:8px">
        <h3>Model Fit</h3>
      </div>
      <div class="model-stats">
        <div class="model-stat-item">
          <div class="msi-label">R&#178; (fit)</div>
          <div class="msi-value" id="stat-r2">--</div>
        </div>
        <div class="model-stat-item">
          <div class="msi-label">Correlation r</div>
          <div class="msi-value" id="stat-r">--</div>
        </div>
        <div class="model-stat-item">
          <div class="msi-label">Slope</div>
          <div class="msi-value" id="stat-slope">--</div>
        </div>
        <div class="model-stat-item">
          <div class="msi-label">Intercept</div>
          <div class="msi-value" id="stat-intercept">--</div>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <h4>Mean Residual by Group</h4>
      <div class="stat-row">
        <span class="stat-label"><span class="stat-dot" style="background:var(--col-pp)"></span>Pupil Premium</span>
        <span class="stat-value" id="mr-PP">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label"><span class="stat-dot" style="background:var(--col-nonpp)"></span>Non-PP</span>
        <span class="stat-value" id="mr-Non-PP">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label"><span class="stat-dot" style="background:var(--col-sen)"></span>SEN</span>
        <span class="stat-value" id="mr-SEN">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label"><span class="stat-dot" style="background:var(--col-eal)"></span>EAL</span>
        <span class="stat-value" id="mr-EAL">--</span>
      </div>
    </div>

    <div class="stat-card">
      <h4>Visible Pupils</h4>
      <div class="stat-row">
        <span class="stat-label">Total visible</span>
        <span class="stat-value neu" id="st-total">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Above line</span>
        <span class="stat-value pos" id="st-above">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Below line</span>
        <span class="stat-value neg" id="st-below">--</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Outliers (&gt;1.5 SD)</span>
        <span class="stat-value" style="color:var(--col-outlier-ring)" id="st-outliers">--</span>
      </div>
    </div>

    <div>
      <div class="panel-section" style="margin-bottom:8px">
        <h3>Outlier Pupils</h3>
      </div>
      <div class="outlier-list" id="outlier-list">
        <div style="font-size:0.75rem;color:var(--text-muted);padding:4px">Calculating...</div>
      </div>
    </div>

    <div>
      <div class="panel-section" style="margin-bottom:8px">
        <h3>Export</h3>
      </div>
      <pre id="export-output"></pre>
    </div>

  </aside>

</div>

<div id="tooltip">
  <div class="tt-name" id="tt-name"></div>
  <div><span class="tt-group" id="tt-group"></span></div>
  <div class="tt-row"><span>Prior attainment:</span><span id="tt-prior"></span></div>
  <div class="tt-row"><span>Outcome:</span><span id="tt-outcome"></span></div>
  <div class="tt-row"><span>Predicted:</span><span id="tt-predicted"></span></div>
  <div class="tt-residual" id="tt-residual"></div>
  <div class="tt-outlier" id="tt-outlier"></div>
</div>

<script>
// ================================================================
//  DATA
// ================================================================
const STUDENTS_RAW = [
  // name, ks2ScaledScore, rawScore, outcome, group
  // KS2 scaled: 80-120, rawScore: 0-100, outcome: 0-100
  { name: 'Amara Johnson',    ks2: 95,  raw: 42, outcome: 48, group: 'PP' },
  { name: 'Callum Reid',      ks2: 103, raw: 61, outcome: 66, group: 'Non-PP' },
  { name: 'Fatima Osei',      ks2: 88,  raw: 30, outcome: 38, group: 'EAL' },
  { name: 'Joshua Clarke',    ks2: 112, raw: 78, outcome: 80, group: 'Non-PP' },
  { name: 'Priya Sharma',     ks2: 99,  raw: 53, outcome: 71, group: 'EAL' },
  { name: 'Dylan Peters',     ks2: 84,  raw: 24, outcome: 22, group: 'SEN' },
  { name: 'Mei-Ling Wu',      ks2: 108, raw: 70, outcome: 82, group: 'Non-PP' },
  { name: 'Marcus Okafor',    ks2: 93,  raw: 38, outcome: 30, group: 'PP' },
  { name: 'Isla MacGregor',   ks2: 116, raw: 88, outcome: 91, group: 'Non-PP' },
  { name: 'Leo Brennan',      ks2: 80,  raw: 16, outcome: 28, group: 'SEN' },
  { name: 'Sophie Nguyen',    ks2: 101, raw: 58, outcome: 62, group: 'EAL' },
  { name: 'Kofi Asante',      ks2: 97,  raw: 47, outcome: 56, group: 'PP' },
  { name: 'Hannah Williams',  ks2: 106, raw: 67, outcome: 60, group: 'Non-PP' },
  { name: 'Reuben Cohen',     ks2: 91,  raw: 34, outcome: 45, group: 'PP' },
  { name: 'Zara Ahmed',       ks2: 110, raw: 75, outcome: 78, group: 'EAL' },
  { name: 'Tom Fitzgerald',   ks2: 86,  raw: 28, outcome: 20, group: 'SEN' },
  { name: 'Niamh Kelly',      ks2: 104, raw: 63, outcome: 68, group: 'Non-PP' },
  { name: 'Devon Richards',   ks2: 92,  raw: 37, outcome: 52, group: 'PP' },
  { name: 'Yuki Tanaka',      ks2: 118, raw: 92, outcome: 95, group: 'Non-PP' },
  { name: 'Blessing Eze',     ks2: 82,  raw: 20, outcome: 15, group: 'PP' },
  { name: 'Sam Thornton',     ks2: 100, raw: 55, outcome: 50, group: 'Non-PP' },
  { name: 'Aaliya Khan',      ks2: 98,  raw: 51, outcome: 63, group: 'EAL' },
  { name: 'Freddie Lawson',   ks2: 89,  raw: 32, outcome: 36, group: 'Non-PP' },
  { name: 'Grace Osei',       ks2: 113, raw: 81, outcome: 73, group: 'Non-PP' },
  { name: 'Kieran Walsh',     ks2: 85,  raw: 26, outcome: 41, group: 'SEN' },
  { name: 'Imani Dube',       ks2: 96,  raw: 45, outcome: 42, group: 'PP' },
  { name: 'Chloe Barton',     ks2: 107, raw: 69, outcome: 77, group: 'Non-PP' },
  { name: 'Arjun Patel',      ks2: 94,  raw: 41, outcome: 58, group: 'EAL' },
];

// ================================================================
//  STATE
// ================================================================
const state = {
  axis: 'ks2',
  filters: { PP: true, 'Non-PP': true, SEN: true, EAL: true },
  showResiduals: true,
  showConfBand: true,
  showOutliers: true,
  showLabels: false,
  showWhatIf: false,
  whatIfOffset: 0,     // vertical pixel offset from the regression line
  draggingWhatIf: false,
  dragStartY: 0,
  dragStartOffset: 0,
  regression: null,
  residualSD: 0,
  highlightedStudent: null,
};

const GROUP_COLOURS = {
  'PP': 'var(--col-pp)',
  'Non-PP': 'var(--col-nonpp)',
  'SEN': 'var(--col-sen)',
  'EAL': 'var(--col-eal)',
};
const GROUP_COLORS_HEX = {
  'PP': '#f59e0b',
  'Non-PP': '#14b8a6',
  'SEN': '#a78bfa',
  'EAL': '#fb923c',
};

// ================================================================
//  MATH HELPERS
// ================================================================
function linearRegression(xs, ys) {
  const n = xs.length;
  if (n < 2) return { slope: 0, intercept: 0, r: 0, r2: 0 };
  const mx = xs.reduce((a, b) => a + b, 0) / n;
  const my = ys.reduce((a, b) => a + b, 0) / n;
  let ssxy = 0, ssx = 0, ssy = 0;
  for (let i = 0; i < n; i++) {
    ssxy += (xs[i] - mx) * (ys[i] - my);
    ssx  += (xs[i] - mx) ** 2;
    ssy  += (ys[i] - my) ** 2;
  }
  const slope = ssx === 0 ? 0 : ssxy / ssx;
  const intercept = my - slope * mx;
  const r = (ssx === 0 || ssy === 0) ? 0 : ssxy / Math.sqrt(ssx * ssy);
  const r2 = r * r;
  return { slope, intercept, r, r2 };
}

function predict(reg, x) { return reg.slope * x + reg.intercept; }

function sd(arr) {
  if (arr.length < 2) return 0;
  const m = arr.reduce((a, b) => a + b, 0) / arr.length;
  return Math.sqrt(arr.reduce((a, b) => a + (b - m) ** 2, 0) / arr.length);
}

// ================================================================
//  AXIS ACCESSOR
// ================================================================
function getX(s) { return state.axis === 'ks2' ? s.ks2 : s.raw; }
function xLabel() { return state.axis === 'ks2' ? 'KS2 Scaled Score' : 'Raw Prior Score'; }
function xUnit() { return state.axis === 'ks2' ? '' : '%'; }

// ================================================================
//  FILTERED DATA
// ================================================================
function visibleStudents() {
  return STUDENTS_RAW.filter(s => state.filters[s.group]);
}

// ================================================================
//  SVG DRAWING
// ================================================================
const svg = document.getElementById('scatter-svg');
const NS = 'http://www.w3.org/2000/svg';

function el(tag, attrs, parent) {
  const e = document.createElementNS(NS, tag);
  for (const [k, v] of Object.entries(attrs || {})) e.setAttribute(k, v);
  if (parent) parent.appendChild(e);
  return e;
}

function txt(str, attrs, parent) {
  const t = el('text', attrs, parent);
  t.textContent = str;
  return t;
}

// Margins
const M = { top: 30, right: 30, bottom: 55, left: 60 };

function getChartDims() {
  const w = svg.clientWidth || svg.getBoundingClientRect().width || 600;
  const h = svg.clientHeight || svg.getBoundingClientRect().height || 400;
  return {
    W: w,
    H: h,
    pw: w - M.left - M.right,
    ph: h - M.top - M.bottom,
  };
}

function niceTicks(min, max, count = 6) {
  const range = max - min;
  const step = Math.pow(10, Math.floor(Math.log10(range / count)));
  const nice = [1, 2, 2.5, 5, 10];
  let best = step;
  for (const n of nice) {
    const s = n * step;
    if (range / s <= count) { best = s; break; }
  }
  const ticks = [];
  let t = Math.ceil(min / best) * best;
  while (t <= max) { ticks.push(parseFloat(t.toFixed(10))); t += best; }
  return ticks;
}

function drawChart() {
  // Clear
  while (svg.firstChild) svg.removeChild(svg.lastChild);

  const students = visibleStudents();
  const { W, H, pw, ph } = getChartDims();

  if (pw <= 0 || ph <= 0) return;

  // Data ranges
  const allX = STUDENTS_RAW.map(getX);
  const allY = STUDENTS_RAW.map(s => s.outcome);
  const xMin = Math.min(...allX);
  const xMax = Math.max(...allX);
  const yMin = Math.min(...allY);
  const yMax = Math.max(...allY);
  const xPad = (xMax - xMin) * 0.08;
  const yPad = (yMax - yMin) * 0.12;
  const xDomain = [xMin - xPad, xMax + xPad];
  const yDomain = [yMin - yPad, yMax + yPad];

  function scX(v) { return M.left + ((v - xDomain[0]) / (xDomain[1] - xDomain[0])) * pw; }
  function scY(v) { return M.top + ph - ((v - yDomain[0]) / (yDomain[1] - yDomain[0])) * ph; }
  function invY(py) { return yDomain[0] + (1 - (py - M.top) / ph) * (yDomain[1] - yDomain[0]); }

  // Store scale functions for later use
  state._scX = scX;
  state._scY = scY;
  state._invY = invY;
  state._xDomain = xDomain;
  state._yDomain = yDomain;

  // Regression on visible data
  const visX = students.map(getX);
  const visY = students.map(s => s.outcome);
  const reg = students.length >= 2 ? linearRegression(visX, visY) : { slope: 0, intercept: 0, r: 0, r2: 0 };
  state.regression = reg;

  // Residuals
  const residuals = students.map(s => s.outcome - predict(reg, getX(s)));
  const resSd = sd(residuals);
  state.residualSD = resSd;

  // Update stats panel
  updateStats(students, reg, residuals, resSd);

  // SVG background group
  const g = el('g', {}, svg);

  // ---- Grid ----
  const xTicks = niceTicks(xDomain[0], xDomain[1], 7);
  const yTicks = niceTicks(yDomain[0], yDomain[1], 7);

  for (const t of xTicks) {
    el('line', { class: 'grid-line', x1: scX(t), y1: M.top, x2: scX(t), y2: M.top + ph }, g);
    txt((state.axis === 'ks2' ? Math.round(t) : Math.round(t)), {
      class: 'axis-label',
      x: scX(t), y: M.top + ph + 16,
      'text-anchor': 'middle',
    }, g);
  }
  for (const t of yTicks) {
    if (t < yDomain[0] || t > yDomain[1]) continue;
    el('line', { class: 'grid-line', x1: M.left, y1: scY(t), x2: M.left + pw, y2: scY(t) }, g);
    txt(Math.round(t), {
      class: 'axis-label',
      x: M.left - 8, y: scY(t) + 4,
      'text-anchor': 'end',
    }, g);
  }

  // ---- Axes ----
  el('line', { class: 'axis-line', x1: M.left, y1: M.top + ph, x2: M.left + pw, y2: M.top + ph }, g);
  el('line', { class: 'axis-line', x1: M.left, y1: M.top, x2: M.left, y2: M.top + ph }, g);

  // Axis titles
  txt(xLabel(), {
    class: 'axis-title',
    x: M.left + pw / 2, y: H - 8,
    'text-anchor': 'middle',
  }, g);
  const ytEl = txt('Outcome (%)', {
    class: 'axis-title',
    x: 14, y: M.top + ph / 2,
    'text-anchor': 'middle',
    transform: `rotate(-90, 14, ${M.top + ph / 2})`,
  }, g);

  // ---- Confidence band ----
  if (state.showConfBand && students.length >= 2) {
    const se = resSd;
    const confPath = [];
    const steps = 60;
    for (let i = 0; i <= steps; i++) {
      const x = xDomain[0] + (xDomain[1] - xDomain[0]) * (i / steps);
      const y = predict(reg, x) + se;
      confPath.push((i === 0 ? 'M' : 'L') + scX(x).toFixed(1) + ' ' + scY(y).toFixed(1));
    }
    for (let i = steps; i >= 0; i--) {
      const x = xDomain[0] + (xDomain[1] - xDomain[0]) * (i / steps);
      const y = predict(reg, x) - se;
      confPath.push('L' + scX(x).toFixed(1) + ' ' + scY(y).toFixed(1));
    }
    confPath.push('Z');
    el('path', { class: 'confband', d: confPath.join(' ') }, g);
  }

  // ---- Regression line ----
  if (students.length >= 2) {
    el('line', {
      class: 'regression-line',
      x1: scX(xDomain[0]), y1: scY(predict(reg, xDomain[0])),
      x2: scX(xDomain[1]), y2: scY(predict(reg, xDomain[1])),
    }, g);

    // Label
    const lx = scX(xDomain[1]) - 4;
    const ly = scY(predict(reg, xDomain[1])) - 6;
    txt('Expected', {
      class: 'legend-text',
      x: lx, y: ly,
      'text-anchor': 'end',
      fill: 'var(--teal-light)',
      'font-size': '10',
    }, g);
  }

  // ---- What-if line ----
  if (state.showWhatIf && students.length >= 2) {
    const wOffset = state.whatIfOffset;
    el('line', {
      class: 'whatif-line',
      id: 'whatif-line-el',
      x1: scX(xDomain[0]), y1: scY(predict(reg, xDomain[0])) + wOffset,
      x2: scX(xDomain[1]), y2: scY(predict(reg, xDomain[1])) + wOffset,
      style: 'cursor: ns-resize;',
    }, g);
    const wiLX = scX(xDomain[1]) - 4;
    const wiLY = scY(predict(reg, xDomain[1])) + wOffset - 5;
    txt('What-if', {
      class: 'legend-text',
      x: wiLX, y: wiLY,
      'text-anchor': 'end',
      fill: 'var(--warning)',
      'font-size': '10',
    }, g);
  }

  // ---- Residual bars ----
  if (state.showResiduals) {
    students.forEach((s, i) => {
      const sx = scX(getX(s));
      const sy = scY(s.outcome);
      const ry = scY(predict(reg, getX(s)));
      const cls = residuals[i] >= 0 ? 'pos' : 'neg';
      el('line', {
        class: 'residual-bar ' + cls,
        x1: sx, y1: sy, x2: sx, y2: ry,
      }, g);
    });
  }

  // ---- Data points ----
  const pointEls = [];
  students.forEach((s, i) => {
    const sx = scX(getX(s));
    const sy = scY(s.outcome);
    const isOutlier = Math.abs(residuals[i]) > 1.5 * resSd;

    if (state.showOutliers && isOutlier) {
      el('circle', {
        class: 'outlier-ring',
        cx: sx, cy: sy, r: 11,
      }, g);
    }

    const circle = el('circle', {
      class: 'data-point',
      cx: sx, cy: sy, r: 7,
      fill: GROUP_COLORS_HEX[s.group],
      stroke: '#0f172a',
      'data-index': i,
    }, g);

    // Labels
    if (state.showLabels) {
      const firstName = s.name.split(' ')[0];
      txt(firstName, {
        class: 'axis-label',
        x: sx + 9, y: sy + 4,
        'font-size': '9',
        fill: 'var(--text-secondary)',
      }, g);
    }

    circle.addEventListener('mouseenter', (e) => showTooltip(e, s, i, reg, residuals, resSd));
    circle.addEventListener('mousemove', (e) => moveTooltip(e));
    circle.addEventListener('mouseleave', hideTooltip);
    circle.addEventListener('click', () => {
      state.highlightedStudent = s.name;
    });

    pointEls.push(circle);
  });

  // ---- Legend ----
  const legendGroups = ['PP', 'Non-PP', 'SEN', 'EAL'];
  const lxBase = M.left + 6;
  const lyBase = M.top + 6;
  legendGroups.forEach((gp, i) => {
    if (!state.filters[gp]) return;
    const lx = lxBase + i * 68;
    el('circle', {
      cx: lx + 5, cy: lyBase + 5,
      r: 4.5,
      fill: GROUP_COLORS_HEX[gp],
      stroke: '#0f172a',
      'stroke-width': '1',
    }, g);
    txt(gp, {
      class: 'legend-text',
      x: lx + 13, y: lyBase + 9,
    }, g);
  });

  // ---- Regression annotation ----
  if (students.length >= 2) {
    const annoX = M.left + 6;
    const annoY = M.top + ph - 6;
    txt(`r = ${reg.r.toFixed(3)}   R\u00B2 = ${reg.r2.toFixed(3)}`, {
      class: 'legend-text',
      x: annoX, y: annoY,
      'font-size': '10',
      fill: 'var(--teal)',
    }, g);
  }

  // ---- What-if drag zone ----
  if (state.showWhatIf) {
    // Invisible wider hit area for the what-if line
    const wOffset = state.whatIfOffset;
    const hitLine = el('line', {
      x1: scX(xDomain[0]), y1: scY(predict(reg, xDomain[0])) + wOffset,
      x2: scX(xDomain[1]), y2: scY(predict(reg, xDomain[1])) + wOffset,
      stroke: 'transparent',
      'stroke-width': '16',
      style: 'cursor: ns-resize;',
    }, g);
    hitLine.addEventListener('mousedown', startWhatIfDrag);
  }

  // Update filter counts
  updateFilterCounts();
}

// ================================================================
//  TOOLTIP
// ================================================================
const tooltip = document.getElementById('tooltip');

function showTooltip(e, s, i, reg, residuals, resSd) {
  const res = residuals[i];
  const pred = predict(reg, getX(s));
  const isOutlier = Math.abs(res) > 1.5 * resSd;

  document.getElementById('tt-name').textContent = s.name;
  const grpEl = document.getElementById('tt-group');
  grpEl.textContent = s.group;
  grpEl.style.background = GROUP_COLORS_HEX[s.group] + '33';
  grpEl.style.color = GROUP_COLORS_HEX[s.group];

  document.getElementById('tt-prior').textContent =
    state.axis === 'ks2' ? s.ks2 : s.raw + '%';
  document.getElementById('tt-outcome').textContent = s.outcome + '%';
  document.getElementById('tt-predicted').textContent = pred.toFixed(1) + '%';

  const resEl = document.getElementById('tt-residual');
  const sign = res >= 0 ? '+' : '';
  resEl.textContent = `Residual: ${sign}${res.toFixed(1)}%`;
  resEl.className = 'tt-residual ' + (res >= 0 ? 'pos' : 'neg');

  const outEl = document.getElementById('tt-outlier');
  if (isOutlier) {
    outEl.textContent = res > 0 ? '** Positive outlier (>1.5 SD above)' : '** Negative outlier (>1.5 SD below)';
    outEl.style.display = 'block';
  } else {
    outEl.style.display = 'none';
  }

  tooltip.style.display = 'block';
  moveTooltip(e);
}

function moveTooltip(e) {
  const x = e.clientX + 14;
  const y = e.clientY - 10;
  const w = tooltip.offsetWidth;
  const h = tooltip.offsetHeight;
  tooltip.style.left = (x + w > window.innerWidth ? e.clientX - w - 14 : x) + 'px';
  tooltip.style.top = (y + h > window.innerHeight ? e.clientY - h - 10 : y) + 'px';
}

function hideTooltip() {
  tooltip.style.display = 'none';
}

// ================================================================
//  WHAT-IF DRAG
// ================================================================
function startWhatIfDrag(e) {
  state.draggingWhatIf = true;
  state.dragStartY = e.clientY;
  state.dragStartOffset = state.whatIfOffset;
  e.preventDefault();
}

document.addEventListener('mousemove', (e) => {
  if (!state.draggingWhatIf) return;
  const delta = e.clientY - state.dragStartY;
  state.whatIfOffset = state.dragStartOffset + delta;
  drawChart();
});

document.addEventListener('mouseup', () => {
  if (state.draggingWhatIf) {
    state.draggingWhatIf = false;
  }
});

// ================================================================
//  STATS PANEL
// ================================================================
function updateStats(students, reg, residuals, resSd) {
  // Model fit
  document.getElementById('stat-r2').textContent = reg.r2.toFixed(3);
  document.getElementById('stat-r').textContent = reg.r.toFixed(3);
  document.getElementById('stat-slope').textContent = reg.slope.toFixed(3);
  document.getElementById('stat-intercept').textContent = reg.intercept.toFixed(1);

  // Mean residuals per group
  const groups = ['PP', 'Non-PP', 'SEN', 'EAL'];
  groups.forEach(gp => {
    const gpStudents = students.filter(s => s.group === gp);
    const gpResiduals = gpStudents.map(s => s.outcome - predict(reg, getX(s)));
    const mean = gpResiduals.length > 0 ? gpResiduals.reduce((a, b) => a + b, 0) / gpResiduals.length : null;
    const el = document.getElementById('mr-' + gp);
    if (mean === null) {
      el.textContent = 'n/a';
      el.className = 'stat-value neu';
    } else {
      const sign = mean >= 0 ? '+' : '';
      el.textContent = sign + mean.toFixed(1);
      el.className = 'stat-value ' + (mean >= 0.5 ? 'pos' : mean <= -0.5 ? 'neg' : 'neu');
    }
  });

  // Summary counts
  const above = residuals.filter(r => r > 0).length;
  const below = residuals.filter(r => r < 0).length;
  const outliers = residuals.filter(r => Math.abs(r) > 1.5 * resSd).length;
  document.getElementById('st-total').textContent = students.length;
  document.getElementById('st-above').textContent = above;
  document.getElementById('st-below').textContent = below;
  document.getElementById('st-outliers').textContent = outliers;

  // Outlier list
  const outlierList = document.getElementById('outlier-list');
  outlierList.innerHTML = '';
  const outlierData = students
    .map((s, i) => ({ s, res: residuals[i] }))
    .filter(d => Math.abs(d.res) > 1.5 * resSd)
    .sort((a, b) => Math.abs(b.res) - Math.abs(a.res));

  if (outlierData.length === 0) {
    outlierList.innerHTML = '<div style="font-size:0.75rem;color:var(--text-muted);padding:4px">No outliers detected</div>';
  } else {
    outlierData.forEach(({ s, res }) => {
      const item = document.createElement('div');
      item.className = 'outlier-item';
      const sign = res >= 0 ? '+' : '';
      item.innerHTML = `
        <span class="stat-dot" style="background:${GROUP_COLORS_HEX[s.group]}"></span>
        <span class="oi-name">${s.name}</span>
        <span class="oi-res ${res >= 0 ? 'pos' : 'neg'}">${sign}${res.toFixed(1)}</span>
      `;
      outlierList.appendChild(item);
    });
  }
}

// ================================================================
//  FILTER COUNTS
// ================================================================
function updateFilterCounts() {
  const groups = ['PP', 'Non-PP', 'SEN', 'EAL'];
  groups.forEach(gp => {
    const count = STUDENTS_RAW.filter(s => s.group === gp).length;
    const el = document.getElementById('count-' + gp);
    if (el) el.textContent = count;
  });
}

// ================================================================
//  CONTROLS
// ================================================================
// Filter checkboxes
document.querySelectorAll('#filter-group .filter-item').forEach(label => {
  label.addEventListener('click', () => {
    const gp = label.dataset.group;
    state.filters[gp] = !state.filters[gp];
    const cb = label.querySelector('input[type="checkbox"]');
    cb.checked = state.filters[gp];
    label.classList.toggle('active', state.filters[gp]);
    label.classList.toggle('inactive', !state.filters[gp]);
    drawChart();
  });
});

// Display toggles
document.querySelectorAll('.toggle-item').forEach(item => {
  item.addEventListener('click', () => {
    const key = item.dataset.key;
    state[key] = !state[key];
    const sw = item.querySelector('.toggle-switch');
    sw.classList.toggle('on', state[key]);

    if (key === 'showWhatIf') {
      const hint = document.getElementById('whatif-hint');
      hint.classList.toggle('visible', state[key]);
      const resetBtn = document.getElementById('btn-reset-whatif');
      resetBtn.style.display = state[key] ? 'inline-block' : 'none';
      if (!state[key]) state.whatIfOffset = 0;
    }
    drawChart();
  });
});

// Axis buttons
function setAxis(axis) {
  state.axis = axis;
  document.getElementById('btn-axis-ks2').classList.toggle('active', axis === 'ks2');
  document.getElementById('btn-axis-raw').classList.toggle('active', axis === 'raw');
  drawChart();
}

// Reset what-if
function resetWhatIf() {
  state.whatIfOffset = 0;
  drawChart();
}

// ================================================================
//  EXPORT
// ================================================================
function doExport() {
  const students = visibleStudents();
  const reg = state.regression;
  if (!reg) return;

  const residuals = students.map(s => s.outcome - predict(reg, getX(s)));
  const resSd = sd(residuals);

  let out = `VALUE ADDED SCATTER PLOT - SUMMARY REPORT\n`;
  out += `Generated: ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })}\n`;
  out += `Axis: ${xLabel()}\n`;
  out += `Visible pupils: ${students.length}\n\n`;

  out += `MODEL FIT\n`;
  out += `---------\n`;
  out += `Correlation coefficient (r): ${reg.r.toFixed(3)}\n`;
  out += `R-squared: ${reg.r2.toFixed(3)}\n`;
  out += `Slope: ${reg.slope.toFixed(3)}\n`;
  out += `Intercept: ${reg.intercept.toFixed(2)}\n\n`;

  out += `GROUP MEAN RESIDUALS\n`;
  out += `--------------------\n`;
  ['PP', 'Non-PP', 'SEN', 'EAL'].forEach(gp => {
    const gpRes = students.filter(s => s.group === gp).map(s => s.outcome - predict(reg, getX(s)));
    if (gpRes.length > 0) {
      const mean = gpRes.reduce((a, b) => a + b, 0) / gpRes.length;
      const sign = mean >= 0 ? '+' : '';
      out += `${gp.padEnd(8)}: ${sign}${mean.toFixed(2)}\n`;
    }
  });

  out += `\nOUTLIER PUPILS (|residual| > 1.5 SD)\n`;
  out += `-------------------------------------\n`;
  const outlierData = students
    .map((s, i) => ({ s, res: residuals[i] }))
    .filter(d => Math.abs(d.res) > 1.5 * resSd)
    .sort((a, b) => Math.abs(b.res) - Math.abs(a.res));

  if (outlierData.length === 0) {
    out += `No outliers detected\n`;
  } else {
    outlierData.forEach(({ s, res }) => {
      const sign = res >= 0 ? '+' : '';
      out += `${s.name.padEnd(20)} ${s.group.padEnd(8)} residual: ${sign}${res.toFixed(2)}\n`;
    });
  }

  out += `\nALL VISIBLE PUPILS\n`;
  out += `------------------\n`;
  out += `${'Name'.padEnd(20)}${'Group'.padEnd(8)}${'Prior'.padEnd(8)}${'Outcome'.padEnd(10)}${'Predicted'.padEnd(12)}Residual\n`;
  students.forEach((s, i) => {
    const pred = predict(reg, getX(s));
    const res = residuals[i];
    const sign = res >= 0 ? '+' : '';
    const prior = state.axis === 'ks2' ? String(s.ks2) : String(s.raw) + '%';
    out += `${s.name.padEnd(20)}${s.group.padEnd(8)}${prior.padEnd(8)}${(s.outcome + '%').padEnd(10)}${(pred.toFixed(1) + '%').padEnd(12)}${sign}${res.toFixed(2)}\n`;
  });

  const expEl = document.getElementById('export-output');
  expEl.textContent = out;
  expEl.classList.add('visible');
  expEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ================================================================
//  RESIZE OBSERVER
// ================================================================
const ro = new ResizeObserver(() => drawChart());
ro.observe(svg.parentElement);

// ================================================================
//  INIT
// ================================================================
updateFilterCounts();

// Initial draw (defer so layout is settled)
setTimeout(() => {
  drawChart();
}, 60);

// Redraw on window resize just in case
window.addEventListener('resize', drawChart);
</script>
</body>
</html>
