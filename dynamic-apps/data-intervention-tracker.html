<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intervention Impact Tracker</title>
<style>
  :root {
    --slate-50:  #f8fafc;
    --slate-100: #f1f5f9;
    --slate-200: #e2e8f0;
    --slate-300: #cbd5e1;
    --slate-400: #94a3b8;
    --slate-500: #64748b;
    --slate-600: #475569;
    --slate-700: #334155;
    --slate-800: #1e293b;
    --slate-900: #0f172a;
    --teal-50:   #f0fdfa;
    --teal-100:  #ccfbf1;
    --teal-200:  #99f6e4;
    --teal-300:  #5eead4;
    --teal-400:  #2dd4bf;
    --teal-500:  #14b8a6;
    --teal-600:  #0d9488;
    --teal-700:  #0f766e;
    --teal-800:  #115e59;
    --teal-900:  #134e4a;
    --amber-400: #fbbf24;
    --amber-500: #f59e0b;
    --rose-400:  #fb7185;
    --rose-500:  #f43f5e;
    --green-400: #4ade80;
    --green-500: #22c55e;
    --violet-400:#a78bfa;
    --violet-500:#8b5cf6;
    --sky-400:   #38bdf8;
    --sky-500:   #0ea5e9;
    --bg:        var(--slate-900);
    --surface:   var(--slate-800);
    --surface2:  var(--slate-700);
    --border:    var(--slate-600);
    --text:      var(--slate-50);
    --text-muted:var(--slate-400);
    --accent:    var(--teal-500);
    --accent-lt: var(--teal-400);
    --radius:    8px;
    --radius-lg: 12px;
    --shadow:    0 4px 16px rgba(0,0,0,0.4);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 2px solid var(--teal-700);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow);
  }
  .header-icon {
    width: 38px; height: 38px;
    background: linear-gradient(135deg, var(--teal-600), var(--teal-400));
    border-radius: var(--radius);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  header h1 { font-size: 18px; font-weight: 700; color: var(--text); }
  header p  { font-size: 12px; color: var(--text-muted); }
  .header-actions { margin-left: auto; display: flex; gap: 8px; }

  /* LAYOUT */
  .app-body {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 0;
    min-height: calc(100vh - 67px);
  }
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 20px;
    overflow-y: auto;
    max-height: calc(100vh - 67px);
    position: sticky;
    top: 67px;
  }
  .main-content {
    padding: 24px;
    overflow-y: auto;
  }

  /* TABS */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    background: var(--surface);
    border-radius: var(--radius);
    padding: 4px;
  }
  .tab-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    text-align: center;
  }
  .tab-btn:hover { background: var(--surface2); color: var(--text); }
  .tab-btn.active {
    background: var(--teal-700);
    color: var(--teal-100);
    font-weight: 600;
  }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 20px;
  }
  .card-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--accent-lt);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-title .icon { font-size: 16px; }

  /* FORM ELEMENTS */
  .form-group { margin-bottom: 14px; }
  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 5px;
  }
  input, select, textarea {
    width: 100%;
    background: var(--slate-900);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    padding: 9px 12px;
    font-size: 13px;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-family: inherit;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--teal-500);
    box-shadow: 0 0 0 3px rgba(20,184,166,0.15);
  }
  select option { background: var(--slate-800); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px;
    padding: 9px 16px;
    border-radius: var(--radius);
    border: none;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-primary { background: var(--teal-600); color: white; }
  .btn-primary:hover { background: var(--teal-500); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--slate-600); }
  .btn-danger { background: transparent; color: var(--rose-400); border: 1px solid var(--rose-500); }
  .btn-danger:hover { background: var(--rose-500); color: white; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-full { width: 100%; }

  /* INTERVENTION LIST */
  .intervention-list { list-style: none; }
  .intervention-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    border: 1px solid transparent;
    margin-bottom: 6px;
    transition: all 0.2s;
  }
  .intervention-item:hover { background: var(--surface2); }
  .intervention-item.selected {
    background: rgba(13, 148, 136, 0.15);
    border-color: var(--teal-700);
  }
  .intervention-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .intervention-item-info { flex: 1; min-width: 0; }
  .intervention-item-name {
    font-weight: 600; font-size: 13px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .intervention-item-meta { font-size: 11px; color: var(--text-muted); }
  .effect-badge {
    font-size: 11px; font-weight: 700;
    padding: 2px 7px; border-radius: 20px; flex-shrink: 0;
  }

  /* STATS STRIP */
  .stats-strip {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    text-align: center;
  }
  .stat-value { font-size: 26px; font-weight: 700; color: var(--accent-lt); line-height: 1.1; }
  .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

  /* CANVAS CHARTS */
  .chart-container { position: relative; width: 100%; overflow: hidden; }
  canvas { display: block; max-width: 100%; border-radius: var(--radius); }

  /* SCORE TABLE */
  .score-table { width: 100%; border-collapse: collapse; }
  .score-table th {
    text-align: left; font-size: 11px; font-weight: 600;
    color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;
    padding: 8px 10px; border-bottom: 1px solid var(--border);
  }
  .score-table td {
    padding: 8px 10px; border-bottom: 1px solid rgba(100,116,139,0.2);
    font-size: 13px; vertical-align: middle;
  }
  .score-table tr:last-child td { border-bottom: none; }
  .score-table input[type="number"] { width: 70px; padding: 5px 8px; font-size: 13px; }
  .gain-positive { color: var(--green-400); font-weight: 600; }
  .gain-negative { color: var(--rose-400); font-weight: 600; }

  /* EFFECT SIZE PANEL */
  .effect-panel {
    background: linear-gradient(135deg, rgba(13,148,136,0.12), rgba(8,145,178,0.08));
    border: 1px solid var(--teal-800);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-top: 20px;
  }
  .effect-d { font-size: 48px; font-weight: 800; color: var(--teal-300); line-height: 1; }
  .effect-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-top: 4px; }
  .effect-interp { font-size: 18px; font-weight: 700; margin-top: 6px; }
  .effect-bar-track { height: 8px; background: var(--surface2); border-radius: 4px; margin-top: 12px; overflow: hidden; }
  .effect-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--teal-600), var(--teal-400)); transition: width 0.6s ease; }
  .effect-scale { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-top: 3px; }
  .eef-note { font-size: 11px; color: var(--text-muted); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
  .eef-note a { color: var(--teal-400); text-decoration: none; }

  /* TIMELINE */
  .timeline-wrap { overflow-x: auto; padding-bottom: 8px; }
  #timelineCanvas { min-width: 600px; }

  /* COMPARISON */
  .type-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .legend-pill { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-muted); background: var(--surface2); padding: 3px 10px; border-radius: 20px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

  /* REPORT */
  .report-section { margin-bottom: 20px; }
  .report-section h3 { font-size: 14px; font-weight: 700; color: var(--accent-lt); margin-bottom: 10px; }
  .report-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid rgba(100,116,139,0.2); font-size: 13px; }
  .report-row:last-child { border-bottom: none; }

  /* STUDENT BUILDER */
  .student-rows { margin-top: 10px; }
  .student-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
  .student-row input { flex: 1; }
  .student-row .btn { flex-shrink: 0; }

  /* EMPTY STATE */
  .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
  .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* PILL/BADGE */
  .type-pill { display: inline-block; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; padding: 2px 8px; border-radius: 20px; }

  /* DIVIDER */
  .section-divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

  /* INFO BOX */
  .info-box { background: rgba(20,184,166,0.08); border: 1px solid var(--teal-800); border-radius: var(--radius); padding: 12px 14px; font-size: 12px; color: var(--teal-200); margin-bottom: 14px; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .app-body { grid-template-columns: 1fr; }
    .sidebar { position: static; max-height: none; border-right: none; border-bottom: 1px solid var(--border); }
    .stats-strip { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
    .tabs { flex-wrap: wrap; }
    .tab-btn { flex: none; width: calc(50% - 2px); }
    header h1 { font-size: 15px; }
    .effect-d { font-size: 36px; }
  }

  @media print {
    header, .sidebar, .tabs, .header-actions, .btn, #addStudentBtn { display: none !important; }
    .app-body { display: block; }
    .main-content { padding: 0; }
    .tab-panel { display: block !important; }
    .card { border: 1px solid #ccc; break-inside: avoid; }
    body { background: white; color: black; }
    .effect-panel { background: #f0f0f0; }
    .effect-d { color: #0d9488; }
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="header-icon">&#128202;</div>
  <div>
    <h1>Intervention Impact Tracker</h1>
    <p>Evidence-based intervention monitoring with effect size analysis</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" onclick="printReport()">&#128424; Print Report</button>
    <button class="btn btn-primary btn-sm" onclick="exportCSV()">&#8659; Export CSV</button>
  </div>
</header>

<div class="app-body">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="card-title" style="margin-bottom:12px;">
      <span class="icon">&#128203;</span> Interventions
      <button class="btn btn-primary btn-sm" style="margin-left:auto;" onclick="openAddModal()">+ Add</button>
    </div>

    <ul class="intervention-list" id="interventionList"></ul>

    <hr class="section-divider">

    <div class="info-box">
      <strong>About effect sizes (Cohen's d):</strong><br>
      Small: 0.2 &nbsp;|&nbsp; Medium: 0.5 &nbsp;|&nbsp; Large: 0.8+<br>
      An effect size of 0.5 equals roughly 6 months of additional progress.
    </div>

    <div style="font-size:11px; color:var(--text-muted); line-height:1.6;">
      <strong style="color:var(--teal-400);">EEF Toolkit</strong> rates interventions using months of additional progress. Effect sizes underpin this framework. Interventions above 0.4 typically represent strong evidence of impact.
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-content">

    <div class="stats-strip">
      <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Interventions logged</div></div>
      <div class="stat-card"><div class="stat-value" id="statStudents">0</div><div class="stat-label">Students involved</div></div>
      <div class="stat-card"><div class="stat-value" id="statAvgEffect">--</div><div class="stat-label">Average effect size</div></div>
      <div class="stat-card"><div class="stat-value" id="statBest">--</div><div class="stat-label">Highest effect size</div></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview', this)">Overview</button>
      <button class="tab-btn" data-tab="scores" onclick="switchTab('scores', this)">Before / After Scores</button>
      <button class="tab-btn" data-tab="timeline" onclick="switchTab('timeline', this)">Timeline</button>
      <button class="tab-btn" data-tab="compare" onclick="switchTab('compare', this)">Compare</button>
      <button class="tab-btn" data-tab="report" onclick="switchTab('report', this)">Summary Report</button>
    </div>

    <!-- TAB: OVERVIEW -->
    <div class="tab-panel active" id="tab-overview">
      <div id="overviewEmpty" class="empty-state" style="display:none;">
        <div class="icon">&#128202;</div>
        <p>No intervention selected. Choose one from the sidebar or add a new one.</p>
      </div>
      <div id="overviewContent">
        <div class="card" id="overviewDetails">
          <div class="card-title"><span class="icon">&#128203;</span> <span id="ov-name">--</span></div>
          <div class="form-row" style="row-gap:12px;">
            <div><label>Type</label><div id="ov-type" style="margin-top:4px;"></div></div>
            <div><label>Dates</label><p id="ov-dates" style="font-size:13px;margin-top:4px;color:var(--text);"></p></div>
            <div><label>Students</label><p id="ov-students" style="font-size:13px;margin-top:4px;color:var(--text);"></p></div>
            <div><label>Duration</label><p id="ov-duration" style="font-size:13px;margin-top:4px;color:var(--text);"></p></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title"><span class="icon">&#128200;</span> Before vs After Scores</div>
          <div class="chart-container">
            <canvas id="barChart" height="260"></canvas>
          </div>
        </div>

        <div class="effect-panel">
          <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
            <div>
              <div class="effect-d" id="effectD">--</div>
              <div class="effect-label">Cohen's d</div>
              <div class="effect-interp" id="effectInterp" style="color:var(--teal-300);">--</div>
            </div>
            <div style="flex:1; min-width:200px;">
              <div style="font-size:12px; color:var(--text-muted); margin-bottom:6px;">Effect size scale</div>
              <div class="effect-bar-track">
                <div class="effect-bar-fill" id="effectBarFill" style="width:0%;"></div>
              </div>
              <div class="effect-scale">
                <span>0</span><span>Small (0.2)</span><span>Medium (0.5)</span><span>Large (0.8)</span><span>1.0+</span>
              </div>
              <div style="margin-top:12px; font-size:12px; color:var(--text-muted);">
                <strong style="color:var(--text);">EEF approximate months of progress:</strong>
                <span id="eefMonths" style="color:var(--teal-400); font-weight:700;"> -- months</span>
              </div>
              <div style="font-size:12px; color:var(--text-muted); margin-top:6px;" id="effectNote"></div>
            </div>
          </div>
          <div class="eef-note">
            Effect sizes are calculated using Cohen's d (mean difference divided by pooled standard deviation).
            Reference: the <a href="https://educationendowmentfoundation.org.uk/education-evidence/teaching-learning-toolkit" target="_blank">EEF Teaching and Learning Toolkit</a>.
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: SCORES -->
    <div class="tab-panel" id="tab-scores">
      <div class="card">
        <div class="card-title"><span class="icon">&#9998;</span> Enter Before / After Scores</div>
        <div style="margin-bottom:14px;">
          <label>Select Intervention</label>
          <select id="scoreIntSelect" onchange="renderScoreTable()">
            <option value="">-- Choose an intervention --</option>
          </select>
        </div>
        <div id="scoreTableWrap">
          <div class="empty-state" style="padding:24px;"><p>Select an intervention to enter scores.</p></div>
        </div>
      </div>
    </div>

    <!-- TAB: TIMELINE -->
    <div class="tab-panel" id="tab-timeline">
      <div class="card">
        <div class="card-title"><span class="icon">&#128337;</span> Intervention Timeline</div>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:16px;">
          Each bar represents the duration of an intervention.
        </p>
        <div class="timeline-wrap">
          <canvas id="timelineCanvas" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- TAB: COMPARE -->
    <div class="tab-panel" id="tab-compare">
      <div class="card">
        <div class="card-title"><span class="icon">&#9878;</span> Effect Size Comparison</div>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:16px;">
          Comparing Cohen's d across all logged interventions. Higher values indicate greater measured impact.
        </p>
        <div class="type-legend" id="typeLegend"></div>
        <div class="chart-container">
          <canvas id="compareChart" height="280"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span class="icon">&#128179;</span> Cost-Effectiveness Framing</div>
        <div class="info-box" style="margin-bottom:10px;">
          Effect size alone does not capture value. Consider time, staffing cost, and sustainability alongside Cohen's d.
          The EEF Toolkit rates interventions on both impact (months of progress) and cost (1-5 padlocks).
        </div>
        <div id="roiTable"></div>
      </div>
    </div>

    <!-- TAB: REPORT -->
    <div class="tab-panel" id="tab-report">
      <div class="card">
        <div class="card-title"><span class="icon">&#128196;</span> Summary Report</div>
        <div id="reportContent">
          <div class="empty-state" style="padding:24px;"><p>Add and score interventions to generate a report.</p></div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- MODAL -->
<div id="modalOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; align-items:center; justify-content:center;">
  <div style="background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg); padding:28px; width:560px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:var(--shadow);">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
      <h2 style="font-size:16px; font-weight:700; color:var(--accent-lt);">Add New Intervention</h2>
      <button class="btn btn-secondary btn-sm" onclick="closeModal()">&#10005;</button>
    </div>

    <div class="form-group">
      <label>Intervention Name *</label>
      <input type="text" id="formName" placeholder="e.g. Reading Recovery - Year 3">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Type *</label>
        <select id="formType">
          <option value="reading">Reading</option>
          <option value="numeracy">Numeracy</option>
          <option value="behaviour">Behaviour</option>
          <option value="attendance">Attendance</option>
          <option value="semh">SEMH</option>
          <option value="eal">EAL</option>
        </select>
      </div>
      <div class="form-group">
        <label>Delivery Model</label>
        <select id="formDelivery">
          <option value="1:1">1-to-1 tuition</option>
          <option value="small group">Small group (2-5)</option>
          <option value="class">Whole class</option>
          <option value="parent/carer">Parent/carer programme</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Start Date *</label>
        <input type="date" id="formStart">
      </div>
      <div class="form-group">
        <label>End Date *</label>
        <input type="date" id="formEnd">
      </div>
    </div>

    <div class="form-group">
      <label>Lead Practitioner (optional)</label>
      <input type="text" id="formLead" placeholder="e.g. Mrs Ahmed, TA">
    </div>

    <div class="form-group">
      <label>Approximate weekly cost (optional, &pound;)</label>
      <input type="number" id="formCost" placeholder="e.g. 120" min="0" step="1">
    </div>

    <hr class="section-divider">

    <div class="form-group">
      <label>Students in this intervention *</label>
      <div class="student-rows" id="studentRows"></div>
      <button class="btn btn-secondary btn-sm" id="addStudentBtn" onclick="addStudentRow()" style="margin-top:6px;">+ Add Student</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:20px;">
      <button class="btn btn-primary btn-full" onclick="saveIntervention()">Save Intervention</button>
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const TYPE_META = {
  reading:    { label: 'Reading',    colour: '#38bdf8' },
  numeracy:   { label: 'Numeracy',   colour: '#a78bfa' },
  behaviour:  { label: 'Behaviour',  colour: '#fb7185' },
  attendance: { label: 'Attendance', colour: '#fbbf24' },
  semh:       { label: 'SEMH',       colour: '#4ade80' },
  eal:        { label: 'EAL',        colour: '#f97316' },
};
const typeColour = t => (TYPE_META[t] && TYPE_META[t].colour) || '#94a3b8';
const typeLabel  = t => (TYPE_META[t] && TYPE_META[t].label)  || t;

let interventions = [];
let selectedId    = null;

// ============================================================
// DEMO DATA
// ============================================================
function seedDemo() {
  interventions = [
    {
      id: 'int-001', name: 'Reading Recovery - Year 3', type: 'reading',
      delivery: 'small group', start: '2025-09-08', end: '2025-12-13',
      lead: 'Mrs Ahmed', weeklyCost: 90,
      students: [
        { name: 'Amara O.',  before: 42, after: 61 },
        { name: 'Ben T.',    before: 38, after: 55 },
        { name: 'Chloe W.', before: 45, after: 67 },
        { name: 'Daniel P.', before: 31, after: 50 },
        { name: 'Ellie M.', before: 40, after: 58 },
      ]
    },
    {
      id: 'int-002', name: 'Maths Mastery - Year 5 Booster', type: 'numeracy',
      delivery: '1:1', start: '2025-10-06', end: '2026-02-13',
      lead: 'Mr Singh', weeklyCost: 120,
      students: [
        { name: 'Finn R.',  before: 55, after: 72 },
        { name: 'Grace L.', before: 48, after: 63 },
        { name: 'Harry B.', before: 60, after: 74 },
        { name: 'Isla C.',  before: 52, after: 68 },
      ]
    },
    {
      id: 'int-003', name: 'Wellbeing Check-In (SEMH)', type: 'semh',
      delivery: 'small group', start: '2025-11-03', end: '2026-03-27',
      lead: 'School Counsellor', weeklyCost: 150,
      students: [
        { name: 'Jasmine K.', before: 28, after: 44 },
        { name: 'Kai N.',     before: 33, after: 47 },
        { name: 'Lily S.',    before: 25, after: 38 },
        { name: 'Marcus D.', before: 30, after: 51 },
        { name: 'Nia F.',    before: 22, after: 36 },
        { name: 'Owen B.',   before: 35, after: 50 },
      ]
    }
  ];
  selectedId = 'int-001';
}

// ============================================================
// COHEN'S D
// ============================================================
function calcCohenD(students) {
  const pairs = students.filter(s => s.before != null && s.after != null);
  if (pairs.length < 2) return null;
  const n = pairs.length;
  const before = pairs.map(s => s.before);
  const after  = pairs.map(s => s.after);
  const meanB  = before.reduce((a, b) => a + b, 0) / n;
  const meanA  = after.reduce((a,  b) => a + b, 0) / n;
  const varB   = before.reduce((acc, v) => acc + Math.pow(v - meanB, 2), 0) / (n - 1);
  const varA   = after.reduce((acc,  v) => acc + Math.pow(v - meanA, 2), 0) / (n - 1);
  const pooled = Math.sqrt((varB + varA) / 2);
  if (pooled === 0) return null;
  return (meanA - meanB) / pooled;
}

function interpretEffect(d) {
  if (d === null) return { label: 'Insufficient data', colour: '#94a3b8', months: null };
  const a = Math.abs(d);
  if (a < 0.1)  return { label: 'Negligible',  colour: '#94a3b8', months: 0 };
  if (a < 0.2)  return { label: 'Very small',  colour: '#fbbf24', months: 1 };
  if (a < 0.5)  return { label: 'Small',       colour: '#f97316', months: Math.round(a * 10) };
  if (a < 0.8)  return { label: 'Medium',      colour: '#4ade80', months: Math.round(a * 12) };
  return              { label: 'Large',        colour: '#2dd4bf', months: Math.round(a * 14) };
}

function effectBadgeCSS(d) {
  const i = interpretEffect(d);
  return `background:${i.colour}22; color:${i.colour}; border:1px solid ${i.colour}66;`;
}

// ============================================================
// TABS
// ============================================================
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'scores')   { populateScoreSelect(); renderScoreTable(); }
  if (name === 'timeline') renderTimeline();
  if (name === 'compare')  renderCompare();
  if (name === 'report')   renderReport();
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar() {
  const list = document.getElementById('interventionList');
  if (!interventions.length) {
    list.innerHTML = '<li style="color:var(--text-muted);font-size:12px;padding:8px;">No interventions yet. Click + Add to begin.</li>';
    return;
  }
  list.innerHTML = interventions.map(iv => {
    const d    = calcCohenD(iv.students);
    const dStr = d !== null ? d.toFixed(2) : '--';
    const sel  = iv.id === selectedId ? ' selected' : '';
    return `
      <li class="intervention-item${sel}" onclick="selectIntervention('${iv.id}')">
        <div class="intervention-dot" style="background:${typeColour(iv.type)};"></div>
        <div class="intervention-item-info">
          <div class="intervention-item-name">${iv.name}</div>
          <div class="intervention-item-meta">${typeLabel(iv.type)} &bull; ${iv.students.length} students</div>
        </div>
        <span class="effect-badge" style="${effectBadgeCSS(d)}">d=${dStr}</span>
      </li>`;
  }).join('');
}

// ============================================================
// STATS
// ============================================================
function renderStats() {
  const total   = interventions.length;
  const students = interventions.reduce((a, iv) => a + iv.students.length, 0);
  const effects  = interventions.map(iv => calcCohenD(iv.students)).filter(d => d !== null);
  const avgE = effects.length ? (effects.reduce((a, b) => a + b, 0) / effects.length).toFixed(2) : '--';
  const bestE = effects.length ? Math.max(...effects).toFixed(2) : '--';
  document.getElementById('statTotal').textContent   = total;
  document.getElementById('statStudents').textContent = students;
  document.getElementById('statAvgEffect').textContent = avgE;
  document.getElementById('statBest').textContent     = bestE;
}

// ============================================================
// SELECT
// ============================================================
function selectIntervention(id) {
  selectedId = id;
  renderSidebar();
  renderOverview();
  const ss = document.getElementById('scoreIntSelect');
  if (ss) ss.value = id;
}

// ============================================================
// OVERVIEW
// ============================================================
function renderOverview() {
  const iv      = interventions.find(i => i.id === selectedId);
  const empty   = document.getElementById('overviewEmpty');
  const content = document.getElementById('overviewContent');
  if (!iv) { empty.style.display = 'block'; content.style.display = 'none'; return; }
  empty.style.display = 'none'; content.style.display = 'block';

  document.getElementById('ov-name').textContent = iv.name;
  document.getElementById('ov-type').innerHTML  = typePill(iv.type);
  document.getElementById('ov-dates').textContent    = `${fmtDate(iv.start)} to ${fmtDate(iv.end)}`;
  document.getElementById('ov-students').textContent = `${iv.students.length} students`;
  document.getElementById('ov-duration').textContent = weeksBetween(iv.start, iv.end) + ' weeks';

  drawBarChart(iv);

  const d      = calcCohenD(iv.students);
  const interp = interpretEffect(d);
  document.getElementById('effectD').textContent      = d !== null ? d.toFixed(2) : '--';
  document.getElementById('effectD').style.color      = interp.colour;
  document.getElementById('effectInterp').textContent = interp.label;
  document.getElementById('effectInterp').style.color = interp.colour;

  const pct = d !== null ? Math.min(Math.abs(d) / 1.2 * 100, 100) : 0;
  const bar  = document.getElementById('effectBarFill');
  bar.style.width      = pct + '%';
  bar.style.background = `linear-gradient(90deg, ${interp.colour}88, ${interp.colour})`;

  document.getElementById('eefMonths').textContent = interp.months !== null ? ` ~${interp.months} months of additional progress` : ' -- months';

  let note = '';
  if (d !== null) {
    if (d < 0)       note = 'Note: the effect is negative, indicating scores declined on average.';
    else if (d >= 0.8) note = 'This is a large effect. Triangulate with other evidence before drawing firm conclusions.';
    else if (d >= 0.5) note = 'A medium effect. This is consistent with EEF Toolkit high-impact interventions.';
    else if (d >= 0.2) note = 'A small effect. Consider whether implementation fidelity could be improved.';
    else               note = 'Effect size is very small. The intervention may need review.';
  }
  document.getElementById('effectNote').textContent = note;
}

// ============================================================
// BAR CHART
// ============================================================
function drawBarChart(iv) {
  const canvas = document.getElementById('barChart');
  const ctx    = canvas.getContext('2d');
  const dpr    = window.devicePixelRatio || 1;
  const W      = canvas.parentElement.clientWidth || 600;
  const H      = 260;
  canvas.width  = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const students = iv.students.filter(s => s.before != null && s.after != null);
  if (!students.length) {
    ctx.fillStyle = '#64748b'; ctx.font = '13px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText('No scores entered yet. Use the Before / After Scores tab.', W / 2, H / 2);
    return;
  }

  const padL = 40, padR = 20, padT = 20, padB = 55;
  const chartW = W - padL - padR;
  const chartH = H - padT - padB;
  const allVals = students.flatMap(s => [s.before, s.after]);
  const maxVal  = Math.max(...allVals);
  const minVal  = Math.min(0, ...allVals);
  const range   = maxVal - minVal || 1;
  const n       = students.length;
  const groupW  = chartW / n;
  const barW    = Math.min(groupW * 0.35, 28);
  const gap     = 4;

  // Gridlines
  ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
  [0, 0.25, 0.5, 0.75, 1].forEach(f => {
    const y   = padT + chartH - f * chartH;
    const val = Math.round(minVal + f * range);
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL + chartW, y); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = '10px Segoe UI'; ctx.textAlign = 'right';
    ctx.fillText(val, padL - 4, y + 3);
  });

  students.forEach((s, i) => {
    const cx = padL + i * groupW + groupW / 2;

    const bH  = ((s.before - minVal) / range) * chartH;
    const bY  = padT + chartH - bH;
    ctx.fillStyle = '#0ea5e9';
    ctx.fillRect(cx - barW - gap / 2, bY, barW, bH);

    const aH  = ((s.after - minVal) / range) * chartH;
    const aY  = padT + chartH - aH;
    ctx.fillStyle = s.after >= s.before ? '#4ade80' : '#fb7185';
    ctx.fillRect(cx + gap / 2, aY, barW, aH);

    ctx.fillStyle = '#94a3b8'; ctx.font = '10px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText(s.name.split(' ')[0], cx, padT + chartH + 14);

    ctx.fillStyle = '#cbd5e1'; ctx.font = 'bold 10px Segoe UI';
    ctx.fillText(s.before, cx - barW / 2 - gap / 2, bY - 3);
    ctx.fillText(s.after,  cx + barW / 2 + gap / 2, aY - 3);
  });

  ctx.strokeStyle = '#475569'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, padT + chartH); ctx.lineTo(padL + chartW, padT + chartH); ctx.stroke();

  const lx = padL, ly = H - 16;
  ctx.fillStyle = '#0ea5e9'; ctx.fillRect(lx, ly, 12, 8);
  ctx.fillStyle = '#94a3b8'; ctx.font = '11px Segoe UI'; ctx.textAlign = 'left';
  ctx.fillText('Before', lx + 15, ly + 7);
  ctx.fillStyle = '#4ade80'; ctx.fillRect(lx + 70, ly, 12, 8);
  ctx.fillStyle = '#94a3b8';
  ctx.fillText('After', lx + 85, ly + 7);
}

// ============================================================
// SCORE TABLE
// ============================================================
function populateScoreSelect() {
  const sel = document.getElementById('scoreIntSelect');
  const cur = sel.value;
  sel.innerHTML = '<option value="">-- Choose an intervention --</option>';
  interventions.forEach(iv => {
    const o = document.createElement('option');
    o.value = iv.id; o.textContent = iv.name;
    sel.appendChild(o);
  });
  if (cur) sel.value = cur;
}

function renderScoreTable() {
  const id   = document.getElementById('scoreIntSelect').value;
  const wrap = document.getElementById('scoreTableWrap');
  if (!id) {
    wrap.innerHTML = '<div class="empty-state" style="padding:24px;"><p>Select an intervention to enter scores.</p></div>';
    return;
  }
  const iv = interventions.find(i => i.id === id);
  if (!iv) return;

  const rows = iv.students.map((s, idx) => {
    const gain    = (s.before != null && s.after != null) ? (s.after - s.before) : null;
    const gainCls = gain === null ? '' : gain >= 0 ? 'gain-positive' : 'gain-negative';
    const gainStr = gain === null ? '--' : (gain > 0 ? '+' + gain : gain);
    return `<tr>
      <td><strong>${s.name}</strong></td>
      <td><input type="number" min="0" max="200" value="${s.before ?? ''}" placeholder="--"
          oninput="liveScore('${id}',${idx},'before',this.value)"></td>
      <td><input type="number" min="0" max="200" value="${s.after ?? ''}" placeholder="--"
          oninput="liveScore('${id}',${idx},'after',this.value)"></td>
      <td class="${gainCls}">${gainStr}</td>
    </tr>`;
  }).join('');

  wrap.innerHTML = `
    <div class="info-box" style="margin-bottom:12px;">
      Enter raw scores (e.g. standardised scores, percentages, reading ages in months). Scores must use a consistent scale within each intervention.
    </div>
    <table class="score-table">
      <thead><tr><th>Student</th><th>Before score</th><th>After score</th><th>Gain</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div style="margin-top:16px; text-align:right;">
      <button class="btn btn-primary" onclick="commitScores('${id}', this)">&#10003; Save &amp; Recalculate</button>
    </div>`;
}

function liveScore(id, idx, field, val) {
  const iv = interventions.find(i => i.id === id);
  if (iv) iv.students[idx][field] = val === '' ? null : Number(val);
}

function commitScores(id, btn) {
  renderSidebar();
  renderStats();
  if (selectedId === id) renderOverview();
  renderScoreTable();
  if (btn) {
    const orig = btn.textContent;
    btn.textContent = 'Saved!'; btn.style.background = '#22c55e';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 1500);
  }
}

// ============================================================
// TIMELINE
// ============================================================
function renderTimeline() {
  const canvas = document.getElementById('timelineCanvas');
  const ctx    = canvas.getContext('2d');
  const dpr    = window.devicePixelRatio || 1;
  const W      = canvas.parentElement.clientWidth || 700;

  if (!interventions.length) {
    canvas.width = W * dpr; canvas.height = 80 * dpr;
    canvas.style.width = W + 'px'; canvas.style.height = '80px';
    ctx.scale(dpr, dpr);
    ctx.fillStyle = '#64748b'; ctx.font = '13px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText('No interventions to display.', W / 2, 40);
    return;
  }

  const rowH = 44;
  const padL = 130, padR = 20, padT = 30, padB = 30;
  const H    = padT + padB + interventions.length * rowH;
  canvas.width  = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const allStarts = interventions.map(iv => new Date(iv.start));
  const allEnds   = interventions.map(iv => new Date(iv.end));
  const minDate   = new Date(Math.min(...allStarts));
  const maxDate   = new Date(Math.max(...allEnds));
  minDate.setDate(minDate.getDate() - 7);
  maxDate.setDate(maxDate.getDate() + 7);
  const totalMs = maxDate - minDate;
  const chartW  = W - padL - padR;

  const xOf = dateStr => padL + ((new Date(dateStr) - minDate) / totalMs) * chartW;

  // Month gridlines
  ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
  ctx.fillStyle   = '#475569'; ctx.font = '10px Segoe UI'; ctx.textAlign = 'center';
  let cur = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
  while (cur <= maxDate) {
    const x = padL + ((cur - minDate) / totalMs) * chartW;
    ctx.beginPath(); ctx.moveTo(x, padT - 8); ctx.lineTo(x, padT + interventions.length * rowH); ctx.stroke();
    ctx.fillText(cur.toLocaleString('en-GB', { month: 'short' }) + ' ' + String(cur.getFullYear()).slice(2), x, padT - 12);
    cur.setMonth(cur.getMonth() + 1);
  }

  interventions.forEach((iv, i) => {
    const y   = padT + i * rowH;
    const x1  = xOf(iv.start);
    const x2  = xOf(iv.end);
    const barH = 22;
    const by  = y + (rowH - barH) / 2;
    const col = typeColour(iv.type);

    if (i % 2 === 0) { ctx.fillStyle = 'rgba(30,41,59,0.4)'; ctx.fillRect(padL, y, chartW, rowH); }

    ctx.fillStyle = col + 'cc';
    roundRect(ctx, x1, by, Math.max(x2 - x1, 6), barH, 4);
    ctx.fill();
    ctx.strokeStyle = col; ctx.lineWidth = 1.5;
    roundRect(ctx, x1, by, Math.max(x2 - x1, 6), barH, 4);
    ctx.stroke();

    if (x2 - x1 > 40) {
      ctx.fillStyle = 'white'; ctx.font = 'bold 10px Segoe UI'; ctx.textAlign = 'left';
      ctx.fillText(iv.name.slice(0, 28), x1 + 6, by + barH / 2 + 4);
    }

    ctx.fillStyle = '#cbd5e1'; ctx.font = '11px Segoe UI'; ctx.textAlign = 'right';
    const label = iv.name.length > 18 ? iv.name.slice(0, 17) + '...' : iv.name;
    ctx.fillText(label, padL - 6, by + barH / 2 + 4);
  });
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// ============================================================
// COMPARE
// ============================================================
function renderCompare() {
  const canvas = document.getElementById('compareChart');
  const ctx    = canvas.getContext('2d');
  const dpr    = window.devicePixelRatio || 1;
  const W      = canvas.parentElement.clientWidth || 600;
  const H      = 280;
  canvas.width  = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const data = interventions
    .map(iv => ({ name: iv.name, type: iv.type, d: calcCohenD(iv.students) }))
    .filter(x => x.d !== null);

  if (!data.length) {
    ctx.fillStyle = '#64748b'; ctx.font = '13px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText('Score at least one intervention to see comparison.', W / 2, H / 2);
    renderROITable([]);
    return;
  }

  const padL = 40, padR = 20, padT = 20, padB = 65;
  const chartW = W - padL - padR;
  const chartH = H - padT - padB;
  const maxD   = Math.max(...data.map(x => Math.abs(x.d)), 1);
  const barW   = Math.min((chartW / data.length) * 0.55, 60);
  const groupW = chartW / data.length;

  [0.2, 0.5, 0.8].forEach(threshold => {
    if (threshold > maxD * 1.1) return;
    const y = padT + chartH - (threshold / (maxD * 1.1)) * chartH;
    ctx.strokeStyle = '#475569'; ctx.setLineDash([4, 4]); ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL + chartW, y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#64748b'; ctx.font = '9px Segoe UI'; ctx.textAlign = 'left';
    const lbl = threshold === 0.2 ? 'small' : threshold === 0.5 ? 'medium' : 'large';
    ctx.fillText(`${threshold} (${lbl})`, padL + 2, y - 2);
  });

  [0, 0.25, 0.5, 0.75, 1].forEach(f => {
    const y   = padT + chartH - f * chartH;
    const val = (f * maxD * 1.1).toFixed(1);
    ctx.fillStyle = '#64748b'; ctx.font = '10px Segoe UI'; ctx.textAlign = 'right';
    ctx.fillText(val, padL - 4, y + 3);
  });

  data.forEach((item, i) => {
    const cx  = padL + i * groupW + groupW / 2;
    const col = typeColour(item.type);
    const bH  = (Math.abs(item.d) / (maxD * 1.1)) * chartH;
    const by  = padT + chartH - bH;

    ctx.fillStyle = col + 'cc';
    roundRect(ctx, cx - barW / 2, by, barW, bH, 4);
    ctx.fill();
    ctx.strokeStyle = col; ctx.lineWidth = 1.5;
    roundRect(ctx, cx - barW / 2, by, barW, bH, 4);
    ctx.stroke();

    ctx.fillStyle = '#e2e8f0'; ctx.font = 'bold 11px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText('d=' + item.d.toFixed(2), cx, by - 5);

    const words = item.name.split(' ');
    let l1 = '', l2 = '';
    words.forEach(w => { if ((l1 + ' ' + w).trim().length <= 14) l1 = (l1 + ' ' + w).trim(); else l2 = (l2 + ' ' + w).trim(); });
    ctx.fillStyle = '#94a3b8'; ctx.font = '10px Segoe UI';
    ctx.fillText(l1, cx, padT + chartH + 14);
    if (l2) ctx.fillText(l2.slice(0, 14), cx, padT + chartH + 25);
  });

  ctx.strokeStyle = '#475569'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, padT + chartH); ctx.lineTo(padL + chartW, padT + chartH); ctx.stroke();

  const seenTypes = [...new Set(interventions.map(iv => iv.type))];
  document.getElementById('typeLegend').innerHTML = seenTypes.map(t => `
    <div class="legend-pill">
      <span class="legend-dot" style="background:${typeColour(t)};"></span>${typeLabel(t)}
    </div>`).join('');

  renderROITable(data);
}

function renderROITable(data) {
  const wrap = document.getElementById('roiTable');
  if (!data.length) {
    wrap.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No scored interventions yet.</p>';
    return;
  }
  const sorted = [...data].sort((a, b) => b.d - a.d);
  wrap.innerHTML = `
    <table class="score-table">
      <thead><tr><th>Intervention</th><th>Type</th><th>Effect size (d)</th><th>Interpretation</th><th>EEF approx. months</th></tr></thead>
      <tbody>${sorted.map(item => {
        const iv     = interventions.find(i => i.name === item.name);
        const interp = interpretEffect(item.d);
        const weeks  = iv ? weeksBetween(iv.start, iv.end) : null;
        const costTxt = (iv && iv.weeklyCost && weeks) ? `&pound;${(iv.weeklyCost * weeks).toLocaleString()}` : '--';
        return `<tr>
          <td><strong>${item.name}</strong><br><span style="font-size:11px;color:var(--text-muted);">Total est. cost: ${costTxt}</span></td>
          <td>${typePill(item.type)}</td>
          <td><strong style="color:${interp.colour};">${item.d.toFixed(3)}</strong></td>
          <td style="color:${interp.colour};">${interp.label}</td>
          <td>${interp.months !== null ? '~' + interp.months + ' months' : '--'}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
}

// ============================================================
// REPORT
// ============================================================
function renderReport() {
  const wrap = document.getElementById('reportContent');
  if (!interventions.length) {
    wrap.innerHTML = '<div class="empty-state" style="padding:24px;"><p>Add and score interventions to generate a report.</p></div>';
    return;
  }

  const today    = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  const totalStu = interventions.reduce((a, iv) => a + iv.students.length, 0);
  const effects  = interventions.map(iv => calcCohenD(iv.students)).filter(d => d !== null);
  const avgD     = effects.length ? (effects.reduce((a, b) => a + b, 0) / effects.length) : null;
  const bestD    = effects.length ? Math.max(...effects) : null;
  const bestIv   = bestD !== null ? interventions.find(iv => {
    const d = calcCohenD(iv.students);
    return d !== null && Math.abs(d - bestD) < 0.001;
  }) : null;

  let html = `
    <div class="report-section">
      <h3>School Intervention Impact Summary</h3>
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Generated ${today} &bull; Intervention Impact Tracker</div>
      <div class="report-row"><span>Total interventions logged</span><strong>${interventions.length}</strong></div>
      <div class="report-row"><span>Total students involved</span><strong>${totalStu}</strong></div>
      <div class="report-row"><span>Average effect size (Cohen's d)</span><strong>${avgD !== null ? avgD.toFixed(3) : '--'}</strong></div>
      ${bestIv ? `<div class="report-row"><span>Highest effect size intervention</span><strong>${bestIv.name} (d=${bestD.toFixed(3)})</strong></div>` : ''}
    </div>
    <hr class="section-divider">
    <div class="report-section"><h3>Intervention Details</h3>`;

  interventions.forEach(iv => {
    const d      = calcCohenD(iv.students);
    const interp = interpretEffect(d);
    const scored = iv.students.filter(s => s.before != null && s.after != null);
    const n      = scored.length;
    const avgB   = n ? (scored.reduce((a, s) => a + s.before, 0) / n).toFixed(1) : '--';
    const avgA   = n ? (scored.reduce((a, s) => a + s.after,  0) / n).toFixed(1) : '--';
    const weeks  = weeksBetween(iv.start, iv.end);
    const costTot = (iv.weeklyCost && weeks) ? `&pound;${(iv.weeklyCost * weeks).toLocaleString()}` : '--';

    html += `
      <div style="background:var(--surface2);border-radius:var(--radius);padding:14px;margin-bottom:10px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
          ${typePill(iv.type)}
          <strong>${iv.name}</strong>
          ${d !== null ? `<span class="effect-badge" style="${effectBadgeCSS(d)};margin-left:auto;">d = ${d.toFixed(3)} (${interp.label})</span>` : ''}
        </div>
        <div class="report-row"><span>Dates</span><span>${fmtDate(iv.start)} to ${fmtDate(iv.end)} (${weeks} weeks)</span></div>
        <div class="report-row"><span>Delivery model</span><span>${iv.delivery || '--'}</span></div>
        <div class="report-row"><span>Lead practitioner</span><span>${iv.lead || '--'}</span></div>
        <div class="report-row"><span>Estimated total cost</span><span>${costTot}</span></div>
        <div class="report-row"><span>Students (n)</span><span>${iv.students.length} enrolled, ${n} scored</span></div>
        <div class="report-row"><span>Mean score before</span><span>${avgB}</span></div>
        <div class="report-row"><span>Mean score after</span><span>${avgA}</span></div>
        ${d !== null ? `<div class="report-row"><span>EEF approximate additional progress</span><span>~${interp.months} months</span></div>` : ''}
      </div>`;
  });

  html += `</div>
    <hr class="section-divider">
    <div class="report-section">
      <h3>Methodology Note</h3>
      <p style="font-size:12px;color:var(--text-muted);line-height:1.7;">
        Effect sizes are calculated using Cohen's d: the difference between group means divided by the pooled standard
        deviation of before and after scores. This approach is consistent with the methodology used in the EEF
        Teaching and Learning Toolkit. An effect size of 0.2 is considered small, 0.5 medium, and 0.8 large.
        These figures should be interpreted alongside implementation quality, context, and cost-effectiveness.<br><br>
        Reference: Education Endowment Foundation Teaching and Learning Toolkit (educationendowmentfoundation.org.uk).
      </p>
    </div>`;

  wrap.innerHTML = html;
}

// ============================================================
// MODAL
// ============================================================
function openAddModal() {
  ['formName','formLead','formStart','formEnd'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('formType').value     = 'reading';
  document.getElementById('formDelivery').value = '1:1';
  document.getElementById('formCost').value     = '';
  const rows = document.getElementById('studentRows');
  rows.innerHTML = '';
  addStudentRow(); addStudentRow(); addStudentRow();
  document.getElementById('modalOverlay').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
}

function addStudentRow() {
  const rows = document.getElementById('studentRows');
  const div  = document.createElement('div');
  div.className = 'student-row';
  div.innerHTML = `<input type="text" placeholder="Student name or anonymised ID">
    <button class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()">&#10005;</button>`;
  rows.appendChild(div);
}

function saveIntervention() {
  const name  = document.getElementById('formName').value.trim();
  const type  = document.getElementById('formType').value;
  const del   = document.getElementById('formDelivery').value;
  const start = document.getElementById('formStart').value;
  const end   = document.getElementById('formEnd').value;
  const lead  = document.getElementById('formLead').value.trim();
  const cost  = document.getElementById('formCost').value;

  if (!name)                              { alert('Please enter an intervention name.'); return; }
  if (!start || !end)                     { alert('Please enter start and end dates.'); return; }
  if (new Date(end) <= new Date(start))   { alert('End date must be after start date.'); return; }

  const studentInputs = document.querySelectorAll('#studentRows .student-row input');
  const students = [];
  studentInputs.forEach(inp => {
    const n = inp.value.trim();
    if (n) students.push({ name: n, before: null, after: null });
  });
  if (!students.length) { alert('Please add at least one student.'); return; }

  const iv = {
    id: 'int-' + Date.now(),
    name, type, delivery: del, start, end, lead,
    weeklyCost: cost ? Number(cost) : null,
    students
  };
  interventions.push(iv);
  selectedId = iv.id;
  closeModal();
  refresh();

  // Switch to scores tab
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const scoresBtn = document.querySelector('[data-tab="scores"]');
  if (scoresBtn) scoresBtn.classList.add('active');
  document.getElementById('tab-scores').classList.add('active');
  populateScoreSelect();
  document.getElementById('scoreIntSelect').value = iv.id;
  renderScoreTable();
}

// ============================================================
// EXPORT / PRINT
// ============================================================
function exportCSV() {
  const rows = [['Intervention','Type','Delivery','Start','End','Lead','Weekly Cost','Students (n)','Students scored','Mean Before','Mean After','Cohen d','Interpretation','EEF Months']];
  interventions.forEach(iv => {
    const scored = iv.students.filter(s => s.before != null && s.after != null);
    const n      = scored.length;
    const avgB   = n ? (scored.reduce((a, s) => a + s.before, 0) / n).toFixed(1) : '';
    const avgA   = n ? (scored.reduce((a, s) => a + s.after,  0) / n).toFixed(1) : '';
    const d      = calcCohenD(iv.students);
    const interp = interpretEffect(d);
    rows.push([
      iv.name, typeLabel(iv.type), iv.delivery, iv.start, iv.end, iv.lead || '',
      iv.weeklyCost || '', iv.students.length, n, avgB, avgA,
      d !== null ? d.toFixed(3) : '',
      d !== null ? interp.label : '',
      interp.months !== null ? interp.months : ''
    ]);
  });
  const csv  = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = 'intervention-impact-report.csv';
  a.click();
}

function printReport() {
  renderReport();
  window.print();
}

// ============================================================
// HELPERS
// ============================================================
function fmtDate(str) {
  if (!str) return '--';
  return new Date(str).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

function weeksBetween(s, e) {
  return Math.round((new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24 * 7));
}

function typePill(t) {
  const c = typeColour(t);
  return `<span class="type-pill" style="background:${c}22;color:${c};border:1px solid ${c}55;">${typeLabel(t)}</span>`;
}

// ============================================================
// FULL REFRESH
// ============================================================
function refresh() {
  renderSidebar();
  renderStats();
  populateScoreSelect();
  renderOverview();
}

// Redraw active canvas on resize
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    const active = document.querySelector('.tab-panel.active');
    if (!active) return;
    if (active.id === 'tab-overview') {
      const iv = interventions.find(i => i.id === selectedId);
      if (iv) drawBarChart(iv);
    } else if (active.id === 'tab-timeline') {
      renderTimeline();
    } else if (active.id === 'tab-compare') {
      renderCompare();
    }
  }, 200);
});

// Close modal on overlay click
document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
});

// ============================================================
// INIT
// ============================================================
seedDemo();
refresh();
</script>
</body>
</html>
