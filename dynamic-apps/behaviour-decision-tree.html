<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consequence Decision Tree</title>
<style>
:root {
    --orange-dark: #d45b07;
    --orange-mid: #e8740a;
    --orange-light: #f5a623;
    --orange-pale: #fef3e2;
    --teal-dark: #0d7377;
    --teal-mid: #14919b;
    --teal-light: #45b7bf;
    --teal-pale: #e0f5f5;
    --green: #27ae60;
    --green-light: #d4efdf;
    --amber: #f39c12;
    --amber-light: #fef5e7;
    --red: #c0392b;
    --red-light: #fadbd8;
    --grey-900: #1a1a2e;
    --grey-700: #4a4a5a;
    --grey-500: #7a7a8a;
    --grey-200: #e8e8ee;
    --grey-100: #f4f4f8;
    --white: #ffffff;
    --radius: 10px;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 4px 24px rgba(0,0,0,0.12);
    --transition: 0.3s ease;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--grey-100);
    color: var(--grey-900);
    line-height: 1.6;
    min-height: 100vh;
}
header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: linear-gradient(135deg, var(--teal-dark), var(--teal-mid));
    color: var(--white);
    padding: 0.8rem 1.5rem;
    box-shadow: var(--shadow-lg);
}
.header-inner {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.5rem;
}
header h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
header p { font-size: 0.8rem; opacity: 0.9; }
.header-controls { display: flex; gap: 0.5rem; align-items: center; }
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: var(--radius);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    text-decoration: none;
}
.btn-primary { background: var(--orange-mid); color: var(--white); }
.btn-primary:hover { background: var(--orange-dark); transform: translateY(-1px); }
.btn-secondary { background: rgba(255,255,255,0.2); color: var(--white); }
.btn-secondary:hover { background: rgba(255,255,255,0.35); }
.btn-outline { background: var(--white); color: var(--teal-dark); border: 2px solid var(--teal-light); }
.btn-outline:hover { background: var(--teal-pale); }
.btn-small { padding: 0.35rem 0.7rem; font-size: 0.8rem; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
main { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
.info-panel {
    background: linear-gradient(135deg, var(--teal-pale), var(--white));
    border: 2px solid var(--teal-light);
    border-radius: var(--radius);
    padding: 1.2rem 1.5rem;
    margin-bottom: 1.5rem;
}
.info-panel h2 { color: var(--teal-dark); font-size: 1.05rem; margin-bottom: 0.5rem; }
.info-panel p { font-size: 0.88rem; color: var(--grey-700); margin-bottom: 0.4rem; }
.info-toggle {
    background: none; border: none; color: var(--teal-dark); font-weight: 600;
    cursor: pointer; font-size: 0.85rem; padding: 0; text-decoration: underline;
}
.info-detail { display: none; margin-top: 0.6rem; }
.info-detail.open { display: block; }
.info-columns { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem; margin-top: 0.6rem; }
.info-card {
    background: var(--white);
    padding: 0.8rem;
    border-radius: 8px;
    border-left: 3px solid var(--teal-mid);
}
.info-card h3 { font-size: 0.82rem; color: var(--teal-dark); margin-bottom: 0.3rem; }
.info-card p { font-size: 0.78rem; }
/* Scenario selector */
.scenario-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.scenario-card {
    background: var(--white);
    border: 2px solid var(--grey-200);
    border-radius: var(--radius);
    padding: 1.2rem;
    cursor: pointer;
    transition: all var(--transition);
    text-align: centre;
}
.scenario-card:hover { border-color: var(--orange-mid); transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.scenario-card.active { border-color: var(--orange-mid); background: var(--orange-pale); }
.scenario-icon { font-size: 2rem; margin-bottom: 0.5rem; }
.scenario-card h3 { font-size: 0.95rem; color: var(--grey-900); margin-bottom: 0.3rem; }
.scenario-card p { font-size: 0.78rem; color: var(--grey-500); }
/* Tree area */
.tree-container {
    position: relative;
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 1.5rem;
    min-height: 400px;
    overflow-x: auto;
}
.tree-svg {
    width: 100%;
    min-height: 350px;
}
.tree-node {
    cursor: pointer;
    transition: all var(--transition);
}
.tree-node:hover .node-rect { filter: brightness(0.95); }
.node-rect {
    rx: 10;
    ry: 10;
    stroke-width: 2;
    transition: all var(--transition);
}
.node-text {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    font-size: 13px;
    fill: var(--grey-900);
    text-anchor: middle;
    pointer-events: none;
}
.node-label {
    font-size: 10px;
    fill: var(--grey-500);
    text-anchor: middle;
    pointer-events: none;
}
.branch-line {
    stroke-width: 2.5;
    fill: none;
    stroke-linecap: round;
    transition: all var(--transition);
}
@keyframes growBranch {
    from { stroke-dashoffset: 200; }
    to { stroke-dashoffset: 0; }
}
.branch-animate {
    stroke-dasharray: 200;
    animation: growBranch 0.6s ease forwards;
}
@keyframes nodeAppear {
    from { opacity: 0; transform: scale(0.7); }
    to { opacity: 1; transform: scale(1); }
}
.node-animate { animation: nodeAppear 0.4s ease forwards; }
.node-green .node-rect { fill: var(--green-light); stroke: var(--green); }
.node-amber .node-rect { fill: var(--amber-light); stroke: var(--amber); }
.node-red .node-rect { fill: var(--red-light); stroke: var(--red); }
.node-neutral .node-rect { fill: var(--grey-100); stroke: var(--grey-500); }
.node-start .node-rect { fill: var(--teal-pale); stroke: var(--teal-mid); }
.node-selected .node-rect { stroke-width: 3; filter: drop-shadow(0 0 6px rgba(0,0,0,0.15)); }
/* Decision panel */
.decision-panel {
    margin-top: 1.5rem;
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 1.5rem;
}
.decision-panel h3 { font-size: 1rem; color: var(--teal-dark); margin-bottom: 0.3rem; }
.decision-context { font-size: 0.88rem; color: var(--grey-700); margin-bottom: 1rem; }
.choices { display: flex; flex-direction: column; gap: 0.6rem; }
.choice-btn {
    background: var(--grey-100);
    border: 2px solid var(--grey-200);
    border-radius: var(--radius);
    padding: 0.8rem 1rem;
    text-align: left;
    cursor: pointer;
    transition: all var(--transition);
    font-size: 0.88rem;
    color: var(--grey-900);
}
.choice-btn:hover { border-color: var(--orange-mid); background: var(--orange-pale); }
.choice-btn .choice-label {
    font-weight: 600;
    display: block;
    margin-bottom: 0.15rem;
}
.choice-btn .choice-desc { font-size: 0.8rem; color: var(--grey-500); }
/* Consequence display */
.consequence-box {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: var(--radius);
    font-size: 0.88rem;
}
.consequence-box.green { background: var(--green-light); border-left: 4px solid var(--green); }
.consequence-box.amber { background: var(--amber-light); border-left: 4px solid var(--amber); }
.consequence-box.red { background: var(--red-light); border-left: 4px solid var(--red); }
.consequence-box h4 { margin-bottom: 0.3rem; }
.consequence-box p { margin-bottom: 0.2rem; }
/* Summary / results */
.summary-panel {
    margin-top: 1.5rem;
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 1.5rem;
}
.summary-panel h3 { color: var(--teal-dark); margin-bottom: 0.5rem; }
.score-display {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}
.score-circle {
    width: 70px; height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--white);
}
.score-circle.high { background: var(--green); }
.score-circle.mid { background: var(--amber); }
.score-circle.low { background: var(--red); }
.path-review { margin-top: 1rem; }
.path-step {
    display: flex;
    gap: 0.8rem;
    padding: 0.6rem 0;
    border-bottom: 1px solid var(--grey-200);
    font-size: 0.85rem;
}
.path-step:last-child { border-bottom: none; }
.step-number {
    width: 26px; height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--white);
    flex-shrink: 0;
}
.step-number.green { background: var(--green); }
.step-number.amber { background: var(--amber); }
.step-number.red { background: var(--red); }
.learning-points {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--teal-pale);
    border-radius: var(--radius);
}
.learning-points h4 { color: var(--teal-dark); margin-bottom: 0.4rem; font-size: 0.9rem; }
.learning-points li { font-size: 0.82rem; margin-bottom: 0.3rem; margin-left: 1.2rem; color: var(--grey-700); }
.controls-bar {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}
.hidden { display: none !important; }
@media (max-width: 768px) {
    header h1 { font-size: 1.1rem; }
    main { padding: 1rem; }
    .scenario-grid { grid-template-columns: 1fr; }
    .info-columns { grid-template-columns: 1fr; }
    .tree-container { padding: 1rem; }
    .decision-panel { padding: 1rem; }
    .score-display { flex-direction: column; text-align: center; }
}
</style>
</head>
<body>

<header>
    <div class="header-inner">
        <div>
            <h1>Consequence Decision Tree</h1>
            <p>Explore choices, discover consequences</p>
        </div>
        <div class="header-controls">
            <button class="btn btn-secondary btn-small" id="btnInfo" onclick="toggleInfoPanel()">About</button>
            <button class="btn btn-primary btn-small hidden" id="btnRewind" onclick="rewind()">Rewind</button>
            <button class="btn btn-secondary btn-small hidden" id="btnReset" onclick="resetScenario()">New Path</button>
        </div>
    </div>
</header>

<main>
    <div class="info-panel" id="infoPanel">
        <h2>Understanding Decision-Making and Consequences</h2>
        <p>Every choice we make leads to consequences, both in the short term and long term. This tool helps you explore common scenarios and see how different decisions play out.</p>
        <button class="info-toggle" onclick="toggleInfoDetail()">Learn more about decision-making</button>
        <div class="info-detail" id="infoDetail">
            <div class="info-columns">
                <div class="info-card">
                    <h3>Decision-Making</h3>
                    <p>Good decisions involve pausing, thinking about options, and considering who might be affected. Impulsive reactions often lead to poorer outcomes.</p>
                </div>
                <div class="info-card">
                    <h3>Consequences</h3>
                    <p>Every action has short-term and long-term consequences. A choice that feels good now might cause problems later, and a harder choice now can lead to better outcomes.</p>
                </div>
                <div class="info-card">
                    <h3>Risk Assessment</h3>
                    <p>Assessing risk means weighing up the likelihood and severity of negative outcomes. The higher the stakes, the more carefully we should think before acting.</p>
                </div>
                <div class="info-card">
                    <h3>Colour Key</h3>
                    <p><span style="color:var(--green);font-weight:600;">Green</span> = positive outcome. <span style="color:var(--amber);font-weight:600;">Amber</span> = mixed or uncertain. <span style="color:var(--red);font-weight:600;">Red</span> = negative or risky outcome.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="scenarioSelect">
        <h2 style="font-size:1rem;margin-bottom:0.8rem;color:var(--grey-700);">Choose a scenario to explore:</h2>
        <div class="scenario-grid" id="scenarioGrid"></div>
    </div>

    <div id="gameArea" class="hidden">
        <div class="tree-container">
            <svg class="tree-svg" id="treeSvg"></svg>
        </div>

        <div class="decision-panel" id="decisionPanel">
            <h3 id="decisionTitle"></h3>
            <p class="decision-context" id="decisionContext"></p>
            <div class="choices" id="choicesContainer"></div>
            <div id="consequenceArea"></div>
        </div>

        <div class="summary-panel hidden" id="summaryPanel">
            <h3>Outcome Summary</h3>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="path-review" id="pathReview"></div>
            <div class="learning-points" id="learningPoints"></div>
            <div class="controls-bar">
                <button class="btn btn-primary" onclick="rewind()">Explore Different Path</button>
                <button class="btn btn-outline" onclick="selectScenario(null)">Choose New Scenario</button>
            </div>
        </div>
    </div>
</main>

<script>
/* ── Scenario Data ── */
const scenarios = [
    {
        id: 'peer-pressure',
        title: 'Peer Pressure',
        icon: '\ud83d\udc65',
        desc: 'Friends want you to do something you are unsure about.',
        learningPoints: [
            'True friends respect your boundaries and will not pressure you.',
            'Saying no can feel difficult but often earns respect in the long run.',
            'You can remove yourself from a situation if you feel uncomfortable.',
            'Having a trusted adult to talk to makes difficult situations easier.'
        ],
        steps: [
            {
                title: 'The Situation',
                context: 'Your friend group is hanging out after school. Someone suggests going to a part of town your parents have told you to avoid. Everyone seems keen and they are looking at you expectantly.',
                choices: [
                    {
                        label: 'Go along with the group',
                        desc: 'You do not want to seem boring or be left out.',
                        colour: 'red',
                        shortTerm: 'You feel included and part of the group for now.',
                        longTerm: 'You have gone against your own judgement and your parents\u2019 guidance. This makes it harder to say no next time.'
                    },
                    {
                        label: 'Suggest an alternative',
                        desc: 'Propose something else the group could do instead.',
                        colour: 'green',
                        shortTerm: 'Some friends agree; the group mood stays positive.',
                        longTerm: 'You learn that offering alternatives is an effective way to redirect without conflict.'
                    },
                    {
                        label: 'Say no and leave',
                        desc: 'Tell them honestly that you are not comfortable.',
                        colour: 'amber',
                        shortTerm: 'It feels awkward. A couple of people make comments.',
                        longTerm: 'You feel proud for standing by your values. Real friends will respect this.'
                    }
                ]
            },
            {
                title: 'The Escalation',
                context: 'The next day at school, the same group is talking about what happened. They start planning something similar for the weekend and one friend says, "You are coming this time, right?"',
                choices: [
                    {
                        label: 'Agree to keep the peace',
                        desc: 'Nod along and hope the plan falls through.',
                        colour: 'red',
                        shortTerm: 'The pressure eases, but you feel anxious all week.',
                        longTerm: 'Avoiding honest conversations leads to more stress and repeated pressure.'
                    },
                    {
                        label: 'Be honest about your feelings',
                        desc: 'Explain calmly why you would rather not go.',
                        colour: 'green',
                        shortTerm: 'The conversation is a little uncomfortable but you feel relieved after.',
                        longTerm: 'Being honest builds trust and shows maturity. Others may privately agree with you.'
                    },
                    {
                        label: 'Make an excuse',
                        desc: 'Say you are busy even though you are not.',
                        colour: 'amber',
                        shortTerm: 'They accept it for now and the situation passes.',
                        longTerm: 'Making excuses works short-term but does not address the underlying issue.'
                    }
                ]
            },
            {
                title: 'The Turning Point',
                context: 'One of your closer friends messages you privately and says they actually felt the same way but did not want to speak up. They ask what you think they should both do.',
                choices: [
                    {
                        label: 'Support each other and set boundaries',
                        desc: 'Agree to back each other up when the group suggests risky activities.',
                        colour: 'green',
                        shortTerm: 'You both feel stronger knowing you are not alone.',
                        longTerm: 'Having an ally makes it much easier to handle peer pressure. Your friendship deepens.'
                    },
                    {
                        label: 'Ignore the message',
                        desc: 'You do not want to get involved or seem like you are causing drama.',
                        colour: 'red',
                        shortTerm: 'Your friend feels let down and stops reaching out.',
                        longTerm: 'A missed opportunity to build a genuine, supportive friendship.'
                    },
                    {
                        label: 'Talk to a trusted adult together',
                        desc: 'Suggest speaking to a parent or teacher about the pressure you both feel.',
                        colour: 'green',
                        shortTerm: 'It takes courage but the adult gives helpful, non-judgemental advice.',
                        longTerm: 'You learn strategies for handling pressure and build a support network.'
                    }
                ]
            }
        ]
    },
    {
        id: 'online-safety',
        title: 'Online Safety',
        icon: '\ud83d\udcf1',
        desc: 'Navigating a tricky situation involving social media.',
        learningPoints: [
            'Anything shared online can be screenshotted and spread beyond your control.',
            'Blocking and reporting are powerful tools, not signs of weakness.',
            'A trusted adult can help you handle online situations safely.',
            'Your digital footprint lasts far longer than the moment.'
        ],
        steps: [
            {
                title: 'The Message',
                context: 'Someone you have been chatting with online (a friend of a friend) sends you a direct message asking you to share a photo of yourself. They say everyone in the group chat is sharing theirs.',
                choices: [
                    {
                        label: 'Send a photo',
                        desc: 'They seem trustworthy and you do not want to seem unfriendly.',
                        colour: 'red',
                        shortTerm: 'They respond positively, but you feel slightly uneasy.',
                        longTerm: 'You have no control over where that image ends up. Once sent, it cannot be unsent.'
                    },
                    {
                        label: 'Politely decline',
                        desc: 'Say you would rather not share photos with people you do not know well.',
                        colour: 'green',
                        shortTerm: 'They seem a bit annoyed but you feel in control.',
                        longTerm: 'You have protected your privacy and set a clear boundary.'
                    },
                    {
                        label: 'Ignore and change the subject',
                        desc: 'Just move the conversation on without directly addressing it.',
                        colour: 'amber',
                        shortTerm: 'The pressure eases for now.',
                        longTerm: 'They may ask again. The underlying issue is not resolved.'
                    }
                ]
            },
            {
                title: 'The Pressure',
                context: 'The person persists over the next few days, messaging more frequently. They start saying things like "I thought we were friends" and "everyone else has done it." You also notice they have started following your other social accounts.',
                choices: [
                    {
                        label: 'Block and report',
                        desc: 'This behaviour feels manipulative. Block them and report the account.',
                        colour: 'green',
                        shortTerm: 'The messages stop immediately. You feel safer.',
                        longTerm: 'You have protected yourself and potentially helped others by reporting concerning behaviour.'
                    },
                    {
                        label: 'Tell a trusted adult',
                        desc: 'Show the messages to a parent, carer, or teacher.',
                        colour: 'green',
                        shortTerm: 'The adult takes it seriously and helps you handle the situation.',
                        longTerm: 'You learn that seeking help is a sign of strength, not weakness.'
                    },
                    {
                        label: 'Keep chatting but set limits',
                        desc: 'Try to maintain the friendship but refuse the photo requests.',
                        colour: 'amber',
                        shortTerm: 'The pressure continues in subtle ways.',
                        longTerm: 'Persistent pressure from someone you barely know is a warning sign that should not be ignored.'
                    }
                ]
            },
            {
                title: 'The Aftermath',
                context: 'A few weeks later, you discover that the person was not who they claimed to be. Other students at different schools had similar experiences. A friend who did share a photo is now very upset.',
                choices: [
                    {
                        label: 'Support your friend and help them report it',
                        desc: 'Be there for them and encourage them to talk to an adult.',
                        colour: 'green',
                        shortTerm: 'Your friend feels less alone and takes action.',
                        longTerm: 'You strengthen your friendship and help prevent further harm.'
                    },
                    {
                        label: 'Share what happened as a warning',
                        desc: 'Tell others at school what happened so they can protect themselves.',
                        colour: 'amber',
                        shortTerm: 'People are more aware, but your friend feels exposed.',
                        longTerm: 'Good intentions, but sharing without your friend\u2019s consent could make things worse for them.'
                    },
                    {
                        label: 'Stay out of it',
                        desc: 'It is not your problem. You kept yourself safe.',
                        colour: 'red',
                        shortTerm: 'You avoid any involvement.',
                        longTerm: 'Your friend needed support and you were not there. Bystanders play a crucial role in these situations.'
                    }
                ]
            }
        ]
    },
    {
        id: 'anger-response',
        title: 'Anger Responses',
        icon: '\ud83d\udca2',
        desc: 'Managing strong emotions when things go wrong.',
        learningPoints: [
            'Anger is a normal emotion; how we respond to it is what matters.',
            'Taking a pause before reacting almost always leads to better outcomes.',
            'Physical responses to anger (raised heart rate, tension) are signals to slow down.',
            'Communicating how you feel using "I" statements prevents escalation.'
        ],
        steps: [
            {
                title: 'The Trigger',
                context: 'During a group project in class, a classmate takes credit for your idea in front of the teacher. The teacher praises them while you sit there feeling angry and humiliated.',
                choices: [
                    {
                        label: 'Call them out loudly in front of everyone',
                        desc: 'Stand up and tell the class it was your idea.',
                        colour: 'red',
                        shortTerm: 'The confrontation disrupts the lesson. You both get into trouble.',
                        longTerm: 'Public confrontations rarely solve problems and can damage relationships with classmates and teachers.'
                    },
                    {
                        label: 'Take a deep breath and wait',
                        desc: 'You are furious but you decide to pause before acting.',
                        colour: 'green',
                        shortTerm: 'The anger is still there but you keep control of the situation.',
                        longTerm: 'Pausing prevents regrettable reactions and gives you time to plan a better response.'
                    },
                    {
                        label: 'Shut down and say nothing',
                        desc: 'Stay silent, bottle up the frustration, and stew on it.',
                        colour: 'amber',
                        shortTerm: 'The moment passes but you feel worse as the lesson goes on.',
                        longTerm: 'Bottling up emotions can lead to outbursts later or affect your wellbeing.'
                    }
                ]
            },
            {
                title: 'After Class',
                context: 'The lesson has ended. You are still upset. The classmate who took credit is chatting with friends in the corridor as if nothing happened.',
                choices: [
                    {
                        label: 'Speak to them calmly and privately',
                        desc: 'Pull them aside and explain how you feel using "I" statements.',
                        colour: 'green',
                        shortTerm: 'They seem surprised but listen. They apologise.',
                        longTerm: 'Direct, calm communication resolves conflicts effectively and builds respect.'
                    },
                    {
                        label: 'Speak to the teacher',
                        desc: 'Explain what happened and ask the teacher to help resolve it.',
                        colour: 'green',
                        shortTerm: 'The teacher appreciates you coming to them and addresses it fairly.',
                        longTerm: 'Seeking appropriate help is a mature strategy that prevents escalation.'
                    },
                    {
                        label: 'Send an angry message on social media',
                        desc: 'Post about it or message them something harsh.',
                        colour: 'red',
                        shortTerm: 'You feel a brief release but regret it almost immediately.',
                        longTerm: 'Written words in anger are permanent. Screenshots spread. The situation escalates.'
                    }
                ]
            },
            {
                title: 'The Resolution',
                context: 'A day has passed. Regardless of what happened, you still have to work with this classmate on the project. The teacher has asked you both to meet to discuss the next stage.',
                choices: [
                    {
                        label: 'Approach it professionally',
                        desc: 'Focus on the project, agree clear roles, and move forward.',
                        colour: 'green',
                        shortTerm: 'The meeting goes well. You agree on who does what.',
                        longTerm: 'You demonstrate maturity and leadership. These skills transfer to the workplace.'
                    },
                    {
                        label: 'Refuse to cooperate',
                        desc: 'Tell the teacher you cannot work with them.',
                        colour: 'red',
                        shortTerm: 'The teacher is disappointed. You may be marked down for teamwork.',
                        longTerm: 'In life, you will often need to work with people you find difficult. Avoidance is not a long-term strategy.'
                    },
                    {
                        label: 'Cooperate but stay guarded',
                        desc: 'Do the minimum required and keep your best ideas to yourself.',
                        colour: 'amber',
                        shortTerm: 'The project progresses but the quality suffers.',
                        longTerm: 'Holding back hurts the outcome for everyone, including yourself.'
                    }
                ]
            }
        ]
    },
    {
        id: 'substance-refusal',
        title: 'Substance Refusal',
        icon: '\ud83d\udeab',
        desc: 'Handling situations involving alcohol, vaping, or other substances.',
        learningPoints: [
            'Refusing substances is a sign of confidence, not weakness.',
            'Having prepared responses makes it easier to say no in the moment.',
            'The short-term social cost of saying no is almost always less than the long-term risks.',
            'You have the right to make choices about your own body without justifying them.'
        ],
        steps: [
            {
                title: 'The Offer',
                context: 'You are at a house party. An older student offers you a vape, saying "Everyone does it, it is not a big deal." Several people are watching to see what you will do.',
                choices: [
                    {
                        label: 'Accept the vape',
                        desc: 'Take it to fit in and avoid the attention.',
                        colour: 'red',
                        shortTerm: 'The group moves on. You cough and feel lightheaded.',
                        longTerm: 'Nicotine is highly addictive. One try can lead to a habit that is extremely difficult to break.'
                    },
                    {
                        label: 'Say "No thanks, I am good"',
                        desc: 'Decline confidently without making a fuss.',
                        colour: 'green',
                        shortTerm: 'Someone might comment, but most people move on quickly.',
                        longTerm: 'A simple, confident no is the most effective refusal. It gets easier each time.'
                    },
                    {
                        label: 'Use humour to deflect',
                        desc: '"No thanks, I prefer breathing!" and change the subject.',
                        colour: 'green',
                        shortTerm: 'People laugh. The tension breaks and the moment passes.',
                        longTerm: 'Humour is a powerful social tool for navigating awkward situations without conflict.'
                    }
                ]
            },
            {
                title: 'The Follow-Up',
                context: 'Later that evening, the same group is now passing around alcohol. The atmosphere has shifted and people are getting louder. Someone pushes a drink into your hand.',
                choices: [
                    {
                        label: 'Put the drink down and step away',
                        desc: 'Set it aside and move to a different part of the room.',
                        colour: 'green',
                        shortTerm: 'You create physical distance from the pressure.',
                        longTerm: 'Removing yourself from pressured situations is a key life skill.'
                    },
                    {
                        label: 'Take a sip to avoid attention',
                        desc: 'Just a small sip to stop people commenting.',
                        colour: 'red',
                        shortTerm: 'One sip leads to encouragement to have more.',
                        longTerm: 'Small compromises on boundaries make bigger compromises easier next time.'
                    },
                    {
                        label: 'Text a parent or trusted person',
                        desc: 'Quietly message someone to come and collect you.',
                        colour: 'green',
                        shortTerm: 'You have an exit strategy. You feel safer immediately.',
                        longTerm: 'Having a pre-arranged signal or code word with a parent is an excellent safety net.'
                    }
                ]
            },
            {
                title: 'The Next Week',
                context: 'At school on Monday, people are talking about the party. Someone you know was unwell after drinking too much and another student was caught vaping on school premises. People are asking where you were and what you did.',
                choices: [
                    {
                        label: 'Be honest that you chose not to participate',
                        desc: 'Tell people straightforwardly that it is not for you.',
                        colour: 'green',
                        shortTerm: 'Some people respect it; a few might tease, but it passes.',
                        longTerm: 'Owning your choices openly builds a reputation for integrity and self-confidence.'
                    },
                    {
                        label: 'Check in on the friend who was unwell',
                        desc: 'Make sure they are okay and let them know you are there.',
                        colour: 'green',
                        shortTerm: 'Your friend appreciates the kindness.',
                        longTerm: 'Being a caring friend in difficult moments strengthens genuine relationships.'
                    },
                    {
                        label: 'Exaggerate what you did to fit in',
                        desc: 'Pretend you drank or vaped so people do not question you.',
                        colour: 'red',
                        shortTerm: 'People accept the story and move on.',
                        longTerm: 'Lying about substance use creates a false reputation that becomes harder to escape.'
                    }
                ]
            }
        ]
    }
];

/* ── State ── */
let currentScenario = null;
let currentStep = 0;
let decisions = [];
let treeNodes = [];
let treeLines = [];
let svgWidth = 0;
let svgHeight = 0;

/* ── Initialise ── */
function init() {
    const grid = document.getElementById('scenarioGrid');
    grid.innerHTML = '';
    scenarios.forEach((s, i) => {
        const card = document.createElement('div');
        card.className = 'scenario-card';
        card.onclick = () => selectScenario(i);
        card.innerHTML = `
            <div class="scenario-icon">${s.icon}</div>
            <h3>${s.title}</h3>
            <p>${s.desc}</p>
        `;
        grid.appendChild(card);
    });
}

function selectScenario(index) {
    if (index === null) {
        document.getElementById('scenarioSelect').classList.remove('hidden');
        document.getElementById('gameArea').classList.add('hidden');
        document.getElementById('btnRewind').classList.add('hidden');
        document.getElementById('btnReset').classList.add('hidden');
        currentScenario = null;
        return;
    }
    currentScenario = scenarios[index];
    currentStep = 0;
    decisions = [];
    treeNodes = [];
    treeLines = [];
    document.getElementById('scenarioSelect').classList.add('hidden');
    document.getElementById('gameArea').classList.remove('hidden');
    document.getElementById('summaryPanel').classList.add('hidden');
    document.getElementById('decisionPanel').classList.remove('hidden');
    document.getElementById('btnRewind').classList.remove('hidden');
    document.getElementById('btnReset').classList.remove('hidden');
    buildTree();
    showStep();
}

/* ── Tree Drawing ── */
function buildTree() {
    const svg = document.getElementById('treeSvg');
    svg.innerHTML = '';
    const container = svg.parentElement;
    svgWidth = Math.max(container.clientWidth - 30, 500);
    const steps = currentScenario.steps;
    const maxChoices = Math.max(...steps.map(s => s.choices.length));
    svgHeight = (steps.length + 1) * 110 + 40;
    svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
    svg.style.minHeight = svgHeight + 'px';

    // Draw start node
    const startX = svgWidth / 2;
    const startY = 35;
    drawNode(svg, startX, startY, currentScenario.title, 'start', 'start-node', true);
    treeNodes.push({ id: 'start', x: startX, y: startY, step: -1 });
}

function drawNode(svg, x, y, text, colorClass, id, animate) {
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('class', `tree-node node-${colorClass}${animate ? ' node-animate' : ''}`);
    g.setAttribute('id', id);

    const words = wrapText(text, 18);
    const rectH = Math.max(36, words.length * 16 + 12);
    const rectW = Math.min(160, Math.max(100, text.length * 7 + 20));

    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', x - rectW / 2);
    rect.setAttribute('y', y - rectH / 2);
    rect.setAttribute('width', rectW);
    rect.setAttribute('height', rectH);
    rect.setAttribute('class', 'node-rect');
    g.appendChild(rect);

    words.forEach((line, i) => {
        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        txt.setAttribute('x', x);
        txt.setAttribute('y', y - ((words.length - 1) * 8) + i * 16 + 4);
        txt.setAttribute('class', 'node-text');
        txt.textContent = line;
        g.appendChild(txt);
    });

    svg.appendChild(g);
    return { x, y, w: rectW, h: rectH };
}

function drawLine(svg, x1, y1, x2, y2, colour, animate) {
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const midY = (y1 + y2) / 2;
    const d = `M${x1},${y1} C${x1},${midY} ${x2},${midY} ${x2},${y2}`;
    path.setAttribute('d', d);
    path.setAttribute('class', `branch-line${animate ? ' branch-animate' : ''}`);
    path.setAttribute('stroke', colour);
    svg.appendChild(path);
}

function wrapText(text, maxChars) {
    if (text.length <= maxChars) return [text];
    const words = text.split(' ');
    const lines = [];
    let line = '';
    words.forEach(w => {
        if ((line + ' ' + w).trim().length > maxChars && line) {
            lines.push(line.trim());
            line = w;
        } else {
            line = (line + ' ' + w).trim();
        }
    });
    if (line) lines.push(line.trim());
    return lines.slice(0, 3);
}

function getColourHex(colour) {
    const map = { green: '#27ae60', amber: '#f39c12', red: '#c0392b', start: '#14919b', neutral: '#7a7a8a' };
    return map[colour] || map.neutral;
}

/* ── Step Logic ── */
function showStep() {
    const step = currentScenario.steps[currentStep];
    document.getElementById('decisionTitle').textContent = `Step ${currentStep + 1}: ${step.title}`;
    document.getElementById('decisionContext').textContent = step.context;
    document.getElementById('consequenceArea').innerHTML = '';

    const container = document.getElementById('choicesContainer');
    container.innerHTML = '';
    step.choices.forEach((choice, i) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.innerHTML = `<span class="choice-label">${String.fromCharCode(65 + i)}. ${choice.label}</span><span class="choice-desc">${choice.desc}</span>`;
        btn.onclick = () => makeChoice(i);
        container.appendChild(btn);
    });
}

function makeChoice(choiceIndex) {
    const step = currentScenario.steps[currentStep];
    const choice = step.choices[choiceIndex];
    decisions.push({ step: currentStep, choiceIndex, choice });

    // Disable choice buttons
    const btns = document.querySelectorAll('.choice-btn');
    btns.forEach(b => b.disabled = true);
    btns[choiceIndex].style.borderColor = getColourHex(choice.colour);
    btns[choiceIndex].style.background = choice.colour === 'green' ? 'var(--green-light)' : choice.colour === 'amber' ? 'var(--amber-light)' : 'var(--red-light)';

    // Show consequence
    const area = document.getElementById('consequenceArea');
    area.innerHTML = `
        <div class="consequence-box ${choice.colour}">
            <h4>Consequence</h4>
            <p><strong>Short-term:</strong> ${choice.shortTerm}</p>
            <p><strong>Long-term:</strong> ${choice.longTerm}</p>
        </div>
    `;

    // Update tree
    updateTree(choiceIndex);

    // Next step or summary
    setTimeout(() => {
        if (currentStep < currentScenario.steps.length - 1) {
            currentStep++;
            showStep();
        } else {
            showSummary();
        }
    }, 2200);
}

function updateTree(choiceIndex) {
    const svg = document.getElementById('treeSvg');
    const step = currentScenario.steps[currentStep];
    const choices = step.choices;
    const parentNode = treeNodes[treeNodes.length - 1];
    const yLevel = (currentStep + 1) * 110 + 35;
    const totalWidth = Math.min(svgWidth * 0.85, choices.length * 180);
    const startX = (svgWidth - totalWidth) / 2 + totalWidth / (choices.length * 2);
    const spacing = choices.length > 1 ? totalWidth / choices.length : 0;

    choices.forEach((c, i) => {
        const x = startX + i * spacing;
        const isSelected = i === choiceIndex;
        const colClass = isSelected ? c.colour : 'neutral';

        drawLine(svg, parentNode.x, parentNode.y + 18, x, yLevel - 18, isSelected ? getColourHex(c.colour) : '#d0d0d0', isSelected);
        const nodeId = `node-${currentStep}-${i}`;
        drawNode(svg, x, yLevel, c.label, colClass, nodeId, isSelected);

        if (isSelected) {
            treeNodes.push({ id: nodeId, x, y: yLevel, step: currentStep, choiceIndex: i });
            // Add selected class
            setTimeout(() => {
                const el = document.getElementById(nodeId);
                if (el) el.classList.add('node-selected');
            }, 50);
        }
    });

    // Update SVG height if needed
    const newH = yLevel + 60;
    if (newH > svgHeight) {
        svgHeight = newH;
        svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
        svg.style.minHeight = svgHeight + 'px';
    }
}

/* ── Summary ── */
function showSummary() {
    document.getElementById('decisionPanel').classList.add('hidden');
    document.getElementById('summaryPanel').classList.remove('hidden');

    const scores = { green: 3, amber: 2, red: 1 };
    let total = 0;
    const maxScore = decisions.length * 3;
    decisions.forEach(d => { total += scores[d.choice.colour] || 0; });
    const pct = Math.round((total / maxScore) * 100);
    const tier = pct >= 75 ? 'high' : pct >= 45 ? 'mid' : 'low';
    const tierLabel = pct >= 75 ? 'Excellent choices' : pct >= 45 ? 'Mixed outcomes' : 'Risky path';

    document.getElementById('scoreDisplay').innerHTML = `
        <div class="score-circle ${tier}">${pct}%</div>
        <div>
            <strong style="font-size:1.1rem;">${tierLabel}</strong>
            <p style="font-size:0.85rem;color:var(--grey-500);">You scored ${total} out of ${maxScore} across ${decisions.length} decisions.</p>
        </div>
    `;

    const review = document.getElementById('pathReview');
    review.innerHTML = '<h4 style="font-size:0.9rem;margin-bottom:0.5rem;">Your Path</h4>';
    decisions.forEach((d, i) => {
        review.innerHTML += `
            <div class="path-step">
                <div class="step-number ${d.choice.colour}">${i + 1}</div>
                <div>
                    <strong>${currentScenario.steps[d.step].title}:</strong> ${d.choice.label}
                    <br><span style="font-size:0.78rem;color:var(--grey-500);">${d.choice.longTerm}</span>
                </div>
            </div>
        `;
    });

    const lp = document.getElementById('learningPoints');
    lp.innerHTML = '<h4>Key Learning Points</h4><ul>' +
        currentScenario.learningPoints.map(p => `<li>${p}</li>`).join('') +
        '</ul>';
}

/* ── Controls ── */
function rewind() {
    if (!currentScenario || decisions.length === 0) return;
    decisions.pop();
    currentStep = decisions.length;
    treeNodes.splice(decisions.length + 1);
    document.getElementById('summaryPanel').classList.add('hidden');
    document.getElementById('decisionPanel').classList.remove('hidden');
    buildTree();

    // Redraw previous decisions
    decisions.forEach((d, i) => {
        const step = currentScenario.steps[i];
        const choices = step.choices;
        const parentNode = treeNodes[i];
        const yLevel = (i + 1) * 110 + 35;
        const totalWidth = Math.min(svgWidth * 0.85, choices.length * 180);
        const startX = (svgWidth - totalWidth) / 2 + totalWidth / (choices.length * 2);
        const spacing = choices.length > 1 ? totalWidth / choices.length : 0;
        const svg = document.getElementById('treeSvg');

        choices.forEach((c, ci) => {
            const x = startX + ci * spacing;
            const isSelected = ci === d.choiceIndex;
            drawLine(svg, parentNode.x, parentNode.y + 18, x, yLevel - 18, isSelected ? getColourHex(c.colour) : '#d0d0d0', false);
            drawNode(svg, x, yLevel, c.label, isSelected ? c.colour : 'neutral', `node-${i}-${ci}`, false);
            if (isSelected) {
                treeNodes.push({ id: `node-${i}-${ci}`, x, y: yLevel, step: i, choiceIndex: ci });
            }
        });
    });

    showStep();
}

function resetScenario() {
    if (!currentScenario) return;
    const idx = scenarios.indexOf(currentScenario);
    selectScenario(idx);
}

function toggleInfoPanel() {
    const panel = document.getElementById('infoPanel');
    panel.classList.toggle('hidden');
}

function toggleInfoDetail() {
    document.getElementById('infoDetail').classList.toggle('open');
}

/* ── Responsive SVG ── */
window.addEventListener('resize', () => {
    if (currentScenario) {
        const container = document.getElementById('treeSvg').parentElement;
        svgWidth = Math.max(container.clientWidth - 30, 500);
        // Rebuild tree on resize
        buildTree();
        decisions.forEach((d, i) => {
            const step = currentScenario.steps[i];
            const choices = step.choices;
            const parentNode = treeNodes[i];
            const yLevel = (i + 1) * 110 + 35;
            const totalWidth = Math.min(svgWidth * 0.85, choices.length * 180);
            const startX = (svgWidth - totalWidth) / 2 + totalWidth / (choices.length * 2);
            const spacing = choices.length > 1 ? totalWidth / choices.length : 0;
            const svg = document.getElementById('treeSvg');
            choices.forEach((c, ci) => {
                const x = startX + ci * spacing;
                const isSelected = ci === d.choiceIndex;
                drawLine(svg, parentNode.x, parentNode.y + 18, x, yLevel - 18, isSelected ? getColourHex(c.colour) : '#d0d0d0', false);
                drawNode(svg, x, yLevel, c.label, isSelected ? c.colour : 'neutral', `node-${i}-${ci}`, false);
                if (isSelected) treeNodes.push({ id: `node-${i}-${ci}`, x, y: yLevel, step: i, choiceIndex: ci });
            });
        });
    }
});

init();
</script>
</body>
</html>