<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seating Plan Builder</title>
<style>
/* ===== CSS CUSTOM PROPERTIES ===== */
:root {
  --clr-primary:       #4f46e5;
  --clr-primary-dark:  #3730a3;
  --clr-primary-light: #818cf8;
  --clr-primary-pale:  #eef2ff;
  --clr-accent:        #7c3aed;
  --clr-accent-light:  #c4b5fd;
  --clr-surface:       #ffffff;
  --clr-bg:            #f5f3ff;
  --clr-border:        #ddd6fe;
  --clr-text:          #1e1b4b;
  --clr-text-muted:    #6b7280;
  --clr-danger:        #dc2626;
  --clr-success:       #16a34a;

  /* Overlay palette - gender */
  --clr-male:          #60a5fa;
  --clr-female:        #f472b6;
  --clr-other:         #a78bfa;

  /* Overlay palette - attainment */
  --clr-att1:          #ef4444;
  --clr-att2:          #f97316;
  --clr-att3:          #eab308;
  --clr-att4:          #22c55e;
  --clr-att5:          #14b8a6;

  /* Overlay palette - flags */
  --clr-sen:           #f59e0b;
  --clr-pp:            #8b5cf6;
  --clr-eal:           #06b6d4;
  --clr-none:          #e5e7eb;

  --radius:            8px;
  --radius-sm:         4px;
  --shadow:            0 2px 8px rgba(79,70,229,0.12);
  --shadow-lg:         0 4px 20px rgba(79,70,229,0.18);

  --panel-width:       300px;
  --stats-width:       260px;
  --header-h:          56px;
}

/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; font-family: system-ui, -apple-system, 'Segoe UI', sans-serif; }
body { background: var(--clr-bg); color: var(--clr-text); display: flex; flex-direction: column; overflow: hidden; }

button { cursor: pointer; font-family: inherit; }
input, select, textarea { font-family: inherit; }

/* ===== HEADER ===== */
.app-header {
  height: var(--header-h);
  background: var(--clr-primary);
  color: #fff;
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 12px;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 100;
}
.app-header h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: 0.02em; }
.app-header .subtitle { font-size: 0.75rem; opacity: 0.75; margin-left: 4px; }
.header-spacer { flex: 1; }
.header-btn {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.3);
  color: #fff;
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  font-size: 0.78rem;
  font-weight: 500;
  transition: background 0.15s;
}
.header-btn:hover { background: rgba(255,255,255,0.25); }
.header-btn.danger { background: rgba(220,38,38,0.7); border-color: rgba(220,38,38,0.5); }
.header-btn.danger:hover { background: rgba(220,38,38,0.9); }

/* ===== MAIN LAYOUT ===== */
.app-body {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ===== LEFT PANEL (Roster) ===== */
.panel-roster {
  width: var(--panel-width);
  background: var(--clr-surface);
  border-right: 1px solid var(--clr-border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}
.panel-section-title {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--clr-primary);
  padding: 10px 14px 6px;
  border-bottom: 1px solid var(--clr-border);
  background: var(--clr-primary-pale);
}
.add-pupil-form {
  padding: 10px 12px;
  border-bottom: 1px solid var(--clr-border);
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.add-pupil-form input[type="text"] {
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 5px 8px;
  font-size: 0.82rem;
  width: 100%;
  outline: none;
  transition: border-color 0.15s;
}
.add-pupil-form input[type="text"]:focus { border-color: var(--clr-primary-light); }
.attr-row {
  display: flex;
  gap: 5px;
  align-items: center;
  flex-wrap: wrap;
}
.attr-row select {
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 4px 6px;
  font-size: 0.75rem;
  flex: 1;
  min-width: 60px;
  outline: none;
  background: #fff;
}
.flag-toggles {
  display: flex;
  gap: 4px;
}
.flag-toggle {
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 3px 7px;
  font-size: 0.68rem;
  font-weight: 700;
  background: #f9f9f9;
  color: var(--clr-text-muted);
  transition: background 0.15s, color 0.15s, border-color 0.15s;
}
.flag-toggle.active-sen { background: var(--clr-sen); color: #fff; border-color: var(--clr-sen); }
.flag-toggle.active-pp  { background: var(--clr-pp);  color: #fff; border-color: var(--clr-pp);  }
.flag-toggle.active-eal { background: var(--clr-eal); color: #fff; border-color: var(--clr-eal); }
.add-btn {
  background: var(--clr-primary);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  padding: 6px 10px;
  font-size: 0.78rem;
  font-weight: 600;
  transition: background 0.15s;
  width: 100%;
}
.add-btn:hover { background: var(--clr-primary-dark); }
.demo-btn {
  background: transparent;
  border: 1px dashed var(--clr-primary-light);
  color: var(--clr-primary);
  border-radius: var(--radius-sm);
  padding: 5px;
  font-size: 0.73rem;
  width: 100%;
  transition: background 0.15s;
}
.demo-btn:hover { background: var(--clr-primary-pale); }

/* Roster list */
.roster-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.roster-pupil {
  background: var(--clr-bg);
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 6px 8px;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: grab;
  user-select: none;
  font-size: 0.8rem;
  transition: box-shadow 0.15s, border-color 0.15s;
  position: relative;
}
.roster-pupil:hover { border-color: var(--clr-primary-light); box-shadow: var(--shadow); }
.roster-pupil.dragging { opacity: 0.4; }
.roster-pupil.seated { opacity: 0.45; cursor: default; }
.roster-pupil .pname { flex: 1; font-weight: 500; }
.roster-pupil .ptags {
  display: flex;
  gap: 2px;
  flex-wrap: wrap;
}
.ptag {
  font-size: 0.6rem;
  font-weight: 700;
  padding: 1px 4px;
  border-radius: 3px;
  color: #fff;
}
.ptag-sen { background: var(--clr-sen); }
.ptag-pp  { background: var(--clr-pp);  }
.ptag-eal { background: var(--clr-eal); }
.ptag-att { background: var(--clr-primary-dark); }
.ptag-m   { background: var(--clr-male); color: #fff; }
.ptag-f   { background: var(--clr-female); color: #fff; }
.ptag-o   { background: var(--clr-other); color: #fff; }
.roster-pupil .del-pupil {
  background: none;
  border: none;
  color: var(--clr-text-muted);
  font-size: 0.85rem;
  padding: 0 2px;
  line-height: 1;
  opacity: 0.5;
  transition: opacity 0.15s, color 0.15s;
}
.roster-pupil .del-pupil:hover { opacity: 1; color: var(--clr-danger); }
.roster-empty {
  color: var(--clr-text-muted);
  font-size: 0.78rem;
  text-align: center;
  padding: 20px 10px;
}

/* ===== CENTRE: Classroom Canvas ===== */
.canvas-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--clr-bg);
}
.canvas-toolbar {
  padding: 8px 12px;
  background: var(--clr-surface);
  border-bottom: 1px solid var(--clr-border);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  flex-shrink: 0;
}
.toolbar-label {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--clr-text-muted);
  margin-right: 2px;
}
.tb-btn {
  background: var(--clr-bg);
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 5px 10px;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--clr-text);
  transition: background 0.15s, border-color 0.15s, color 0.15s;
}
.tb-btn:hover { background: var(--clr-primary-pale); border-color: var(--clr-primary-light); color: var(--clr-primary); }
.tb-btn.active { background: var(--clr-primary); color: #fff; border-color: var(--clr-primary-dark); }
.tb-sep { width: 1px; height: 24px; background: var(--clr-border); }
.overlay-btns { display: flex; gap: 4px; }

.canvas-scroll {
  flex: 1;
  overflow: auto;
  padding: 20px;
  display: flex;
  align-items: flex-start;
  justify-content: center;
}
.classroom-svg-wrap {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  border: 2px solid var(--clr-border);
  display: inline-block;
  min-width: 500px;
}
#classroom-svg {
  display: block;
}

/* Desk/seat elements inside SVG via foreignObject or rects */
.desk-tile {
  cursor: pointer;
  transition: filter 0.15s;
}
.desk-tile:hover { filter: brightness(1.08); }
.drag-over-desk { filter: brightness(0.9); }

/* ===== RIGHT PANEL: Stats + Legend ===== */
.panel-stats {
  width: var(--stats-width);
  background: var(--clr-surface);
  border-left: 1px solid var(--clr-border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow-y: auto;
}
.stats-block {
  padding: 10px 14px;
  border-bottom: 1px solid var(--clr-border);
}
.stats-block h3 {
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--clr-primary);
  margin-bottom: 8px;
}
.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.77rem;
  margin-bottom: 5px;
  color: var(--clr-text);
}
.stat-row .val {
  font-weight: 700;
  color: var(--clr-primary-dark);
}
.stat-bar-wrap {
  background: var(--clr-bg);
  border-radius: 999px;
  height: 6px;
  overflow: hidden;
  margin-bottom: 4px;
}
.stat-bar {
  height: 100%;
  border-radius: 999px;
  background: var(--clr-primary-light);
  transition: width 0.3s;
}
.legend-list {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 7px;
  font-size: 0.77rem;
}
.legend-swatch {
  width: 14px;
  height: 14px;
  border-radius: 3px;
  flex-shrink: 0;
  border: 1px solid rgba(0,0,0,0.1);
}
.plan-actions {
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.plan-actions .plan-btn {
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 7px 10px;
  font-size: 0.78rem;
  font-weight: 500;
  background: var(--clr-bg);
  color: var(--clr-text);
  text-align: left;
  transition: background 0.15s, border-color 0.15s;
}
.plan-actions .plan-btn:hover { background: var(--clr-primary-pale); border-color: var(--clr-primary-light); color: var(--clr-primary); }
.plan-actions .plan-btn.primary { background: var(--clr-primary); color: #fff; border-color: var(--clr-primary-dark); }
.plan-actions .plan-btn.primary:hover { background: var(--clr-primary-dark); }
.plan-name-row { display: flex; gap: 6px; align-items: center; }
.plan-name-row input {
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 5px 7px;
  font-size: 0.78rem;
  flex: 1;
  outline: none;
}
.plan-name-row input:focus { border-color: var(--clr-primary-light); }
.saved-plans { padding: 0 12px 10px; }
.saved-plans h3 { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--clr-primary); margin-bottom: 6px; }
.saved-plan-item {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-bottom: 4px;
  font-size: 0.76rem;
  background: var(--clr-bg);
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 4px 8px;
}
.saved-plan-item .pname-load { flex: 1; font-weight: 500; }
.saved-plan-item button {
  border: none;
  background: none;
  font-size: 0.72rem;
  color: var(--clr-primary);
  padding: 0 2px;
  cursor: pointer;
}
.saved-plan-item button.del-plan { color: var(--clr-danger); }

/* ===== MODAL (edit pupil) ===== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(30,27,75,0.4);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-backdrop.hidden { display: none; }
.modal {
  background: var(--clr-surface);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  padding: 20px 24px;
  width: 100%;
  max-width: 360px;
  border: 1px solid var(--clr-border);
}
.modal h2 { font-size: 0.95rem; font-weight: 700; color: var(--clr-primary-dark); margin-bottom: 14px; }
.modal-field { margin-bottom: 10px; }
.modal-field label { display: block; font-size: 0.73rem; font-weight: 600; color: var(--clr-text-muted); margin-bottom: 3px; }
.modal-field input[type="text"],
.modal-field select {
  border: 1px solid var(--clr-border);
  border-radius: var(--radius-sm);
  padding: 6px 8px;
  font-size: 0.82rem;
  width: 100%;
  outline: none;
}
.modal-field input[type="text"]:focus,
.modal-field select:focus { border-color: var(--clr-primary-light); }
.modal-flags { display: flex; gap: 8px; }
.modal-flag-label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.78rem;
  cursor: pointer;
}
.modal-btns { display: flex; gap: 8px; margin-top: 16px; }
.modal-btns button {
  flex: 1;
  padding: 8px;
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-weight: 600;
  border: 1px solid var(--clr-border);
  background: var(--clr-bg);
  color: var(--clr-text);
  transition: background 0.15s;
}
.modal-btns .modal-save { background: var(--clr-primary); color: #fff; border-color: var(--clr-primary-dark); }
.modal-btns .modal-save:hover { background: var(--clr-primary-dark); }
.modal-btns .modal-unseat { background: #fee2e2; color: var(--clr-danger); border-color: #fca5a5; }
.modal-btns .modal-unseat:hover { background: #fecaca; }
.modal-btns .modal-cancel:hover { background: var(--clr-primary-pale); }

/* ===== PRINT VIEW ===== */
@media print {
  .app-header, .panel-roster, .panel-stats, .canvas-toolbar { display: none !important; }
  .app-body { display: block; }
  .canvas-area { overflow: visible; }
  .canvas-scroll { overflow: visible; padding: 0; }
  body { background: white; }
  .classroom-svg-wrap { box-shadow: none; border: 1px solid #ccc; }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  :root { --panel-width: 100%; --stats-width: 100%; }
  .app-body { flex-direction: column; overflow: auto; }
  .panel-roster, .panel-stats { width: 100%; border: none; border-bottom: 1px solid var(--clr-border); max-height: 220px; }
  .canvas-area { min-height: 400px; }
  .canvas-scroll { padding: 10px; }
}

/* ===== DESK LABELS (via SVG text, styled inline) ===== */
.no-desk-msg {
  padding: 40px;
  text-align: center;
  color: var(--clr-text-muted);
  font-size: 0.85rem;
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="3" width="18" height="12" rx="2"/>
    <path d="M3 15h18M7 19h10M9 15v4M15 15v4"/>
  </svg>
  <h1>Seating Plan Builder <span class="subtitle">CPD Tool</span></h1>
  <div class="header-spacer"></div>
  <button class="header-btn" onclick="printView()">Print View</button>
  <button class="header-btn danger" onclick="clearAllSeats()">Clear Seats</button>
</header>

<!-- MAIN BODY -->
<div class="app-body">

  <!-- LEFT: Roster Panel -->
  <aside class="panel-roster">
    <div class="panel-section-title">Pupil Roster</div>

    <form class="add-pupil-form" onsubmit="addPupil(event)">
      <input type="text" id="new-pupil-name" placeholder="Pupil name" autocomplete="off" required>
      <div class="attr-row">
        <select id="new-pupil-gender" title="Gender">
          <option value="">Gender</option>
          <option value="M">M</option>
          <option value="F">F</option>
          <option value="O">Other</option>
        </select>
        <select id="new-pupil-att" title="Attainment level">
          <option value="">Att.</option>
          <option value="1">Att 1</option>
          <option value="2">Att 2</option>
          <option value="3">Att 3</option>
          <option value="4">Att 4</option>
          <option value="5">Att 5</option>
        </select>
        <div class="flag-toggles">
          <button type="button" class="flag-toggle" id="toggle-sen" onclick="toggleFlag('sen')">SEN</button>
          <button type="button" class="flag-toggle" id="toggle-pp"  onclick="toggleFlag('pp')">PP</button>
          <button type="button" class="flag-toggle" id="toggle-eal" onclick="toggleFlag('eal')">EAL</button>
        </div>
      </div>
      <button type="submit" class="add-btn">+ Add Pupil</button>
      <button type="button" class="demo-btn" onclick="loadDemoRoster()">Load demo class (30 pupils)</button>
    </form>

    <div id="roster-list" class="roster-list">
      <p class="roster-empty">No pupils yet. Add pupils above or load a demo class.</p>
    </div>
  </aside>

  <!-- CENTRE: Classroom Canvas -->
  <main class="canvas-area">
    <div class="canvas-toolbar">
      <span class="toolbar-label">Layout</span>
      <button class="tb-btn" onclick="applyLayout('rows')">Rows</button>
      <button class="tb-btn" onclick="applyLayout('pairs')">Pairs</button>
      <button class="tb-btn" onclick="applyLayout('groups4')">Groups of 4</button>
      <button class="tb-btn" onclick="applyLayout('horseshoe')">Horseshoe</button>
      <div class="tb-sep"></div>
      <span class="toolbar-label">Overlay</span>
      <div class="overlay-btns">
        <button class="tb-btn" id="ov-none"    onclick="setOverlay('none')">None</button>
        <button class="tb-btn" id="ov-gender"  onclick="setOverlay('gender')">Gender</button>
        <button class="tb-btn" id="ov-att"     onclick="setOverlay('att')">Attainment</button>
        <button class="tb-btn" id="ov-sen"     onclick="setOverlay('sen')">SEN</button>
        <button class="tb-btn" id="ov-pp"      onclick="setOverlay('pp')">PP</button>
        <button class="tb-btn" id="ov-eal"     onclick="setOverlay('eal')">EAL</button>
      </div>
      <div class="tb-sep"></div>
      <button class="tb-btn" onclick="addDesk()">+ Desk</button>
      <button class="tb-btn" onclick="removeLastDesk()">- Desk</button>
    </div>
    <div class="canvas-scroll" id="canvas-scroll">
      <div class="classroom-svg-wrap" id="svg-wrap">
        <svg id="classroom-svg" width="720" height="520"
             ondragover="svgDragOver(event)"
             ondrop="svgDrop(event)"
             ondragleave="svgDragLeave(event)">
          <!-- Board at top -->
          <rect x="60" y="12" width="600" height="22" rx="4"
                fill="#e0e7ff" stroke="#818cf8" stroke-width="1.5"/>
          <text x="360" y="27" text-anchor="middle" fill="#3730a3"
                font-size="11" font-weight="700" font-family="system-ui,sans-serif">BOARD / DISPLAY</text>
          <!-- Desks rendered here by JS -->
          <g id="desks-group"></g>
        </svg>
      </div>
    </div>
  </main>

  <!-- RIGHT: Stats Panel -->
  <aside class="panel-stats">
    <div class="stats-block">
      <h3>Class Composition</h3>
      <div class="stat-row"><span>Total pupils</span><span class="val" id="stat-total">0</span></div>
      <div class="stat-row"><span>Seated</span><span class="val" id="stat-seated">0</span></div>
      <div class="stat-row"><span>Unseated</span><span class="val" id="stat-unseated">0</span></div>
      <div class="stat-row"><span>Desks</span><span class="val" id="stat-desks">0</span></div>
    </div>

    <div class="stats-block">
      <h3>Pupil Premium (PP)</h3>
      <div class="stat-row"><span>Count</span><span class="val" id="stat-pp-n">0</span></div>
      <div class="stat-row"><span>Percentage</span><span class="val" id="stat-pp-pct">0%</span></div>
      <div class="stat-bar-wrap"><div class="stat-bar" id="bar-pp" style="width:0%;background:var(--clr-pp)"></div></div>
    </div>

    <div class="stats-block">
      <h3>SEN Support</h3>
      <div class="stat-row"><span>Count</span><span class="val" id="stat-sen-n">0</span></div>
      <div class="stat-row"><span>Percentage</span><span class="val" id="stat-sen-pct">0%</span></div>
      <div class="stat-bar-wrap"><div class="stat-bar" id="bar-sen" style="width:0%;background:var(--clr-sen)"></div></div>
    </div>

    <div class="stats-block">
      <h3>EAL Learners</h3>
      <div class="stat-row"><span>Count</span><span class="val" id="stat-eal-n">0</span></div>
      <div class="stat-row"><span>Percentage</span><span class="val" id="stat-eal-pct">0%</span></div>
      <div class="stat-bar-wrap"><div class="stat-bar" id="bar-eal" style="width:0%;background:var(--clr-eal)"></div></div>
    </div>

    <div class="stats-block">
      <h3>Gender Split</h3>
      <div class="stat-row"><span>Male</span><span class="val" id="stat-m">0</span></div>
      <div class="stat-row"><span>Female</span><span class="val" id="stat-f">0</span></div>
      <div class="stat-row"><span>Other/Not stated</span><span class="val" id="stat-o">0</span></div>
    </div>

    <div class="stats-block">
      <h3>Attainment Profile</h3>
      <div id="att-profile"></div>
    </div>

    <div class="stats-block">
      <h3>Colour Legend</h3>
      <div class="legend-list" id="legend-list">
        <div class="legend-item"><div class="legend-swatch" style="background:#e5e7eb"></div><span>No overlay active</span></div>
      </div>
    </div>

    <div class="stats-block plan-actions">
      <h3 style="margin-bottom:6px">Save / Load Plan</h3>
      <div class="plan-name-row">
        <input type="text" id="plan-name-input" placeholder="Plan name..." value="My Seating Plan">
        <button class="plan-btn primary" onclick="savePlan()">Save</button>
      </div>
      <button class="plan-btn" onclick="exportPlanJSON()">Export JSON</button>
      <button class="plan-btn" onclick="document.getElementById('import-json').click()">Import JSON</button>
      <input type="file" id="import-json" accept=".json" style="display:none" onchange="importPlanJSON(event)">
    </div>

    <div class="saved-plans" id="saved-plans-section">
      <h3>Saved Plans</h3>
      <div id="saved-plans-list"></div>
    </div>
  </aside>
</div>

<!-- EDIT PUPIL MODAL -->
<div class="modal-backdrop hidden" id="modal-backdrop" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h2 id="modal-title">Edit Pupil</h2>
    <div class="modal-field">
      <label>Name</label>
      <input type="text" id="modal-name">
    </div>
    <div class="modal-field">
      <label>Gender</label>
      <select id="modal-gender">
        <option value="">Not stated</option>
        <option value="M">Male</option>
        <option value="F">Female</option>
        <option value="O">Other</option>
      </select>
    </div>
    <div class="modal-field">
      <label>Attainment Level (1=lowest, 5=highest)</label>
      <select id="modal-att">
        <option value="">Not set</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>
    <div class="modal-field">
      <label>Flags</label>
      <div class="modal-flags">
        <label class="modal-flag-label"><input type="checkbox" id="modal-sen"> SEN</label>
        <label class="modal-flag-label"><input type="checkbox" id="modal-pp"> PP</label>
        <label class="modal-flag-label"><input type="checkbox" id="modal-eal"> EAL</label>
      </div>
    </div>
    <div class="modal-btns">
      <button class="modal-save" onclick="saveModal()">Save</button>
      <button class="modal-unseat" onclick="unseatFromModal()">Unseat</button>
      <button class="modal-cancel" onclick="document.getElementById('modal-backdrop').classList.add('hidden')">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ===================================================
   STATE
=================================================== */
let pupils    = [];   // { id, name, gender, att, sen, pp, eal }
let desks     = [];   // { id, x, y, seatId }  seatId = pupil id or null
let nextPupilId = 1;
let nextDeskId  = 1;
let currentOverlay = 'none';
let dragPupilId  = null;  // id of pupil being dragged
let dragDeskId   = null;  // desk being dragged over
let newFlags = { sen: false, pp: false, eal: false };
let modalContext = null;  // { type: 'seated', deskId } | { type: 'roster', pupilId }

/* ===================================================
   DEMO DATA
=================================================== */
const DEMO_NAMES = [
  ['Aisha','F','4',true,false,true],
  ['Ben','M','3',false,false,false],
  ['Chloe','F','5',false,false,false],
  ['Daniel','M','2',true,true,false],
  ['Ellie','F','4',false,true,false],
  ['Finn','M','1',true,true,false],
  ['Grace','F','3',false,false,false],
  ['Harry','M','4',false,false,false],
  ['Isla','F','2',false,true,true],
  ['Jake','M','5',false,false,false],
  ['Katie','F','3',true,false,false],
  ['Liam','M','2',false,true,false],
  ['Mia','F','4',false,false,true],
  ['Noah','M','3',false,false,false],
  ['Olivia','F','5',false,false,false],
  ['Phoebe','F','1',true,true,false],
  ['Quinn','O','3',false,false,true],
  ['Reuben','M','4',false,false,false],
  ['Sophia','F','2',false,true,false],
  ['Thomas','M','3',false,false,false],
  ['Uma','F','4',true,false,true],
  ['Victor','M','1',true,true,false],
  ['Willow','F','5',false,false,false],
  ['Xavier','M','3',false,false,true],
  ['Yasmin','F','2',false,true,false],
  ['Zara','F','4',false,false,false],
  ['Alfie','M','3',true,false,false],
  ['Bella','F','2',false,true,false],
  ['Callum','M','5',false,false,false],
  ['Daisy','F','3',false,false,true]
];

function loadDemoRoster() {
  if (pupils.length > 0 && !confirm('This will replace the current roster. Continue?')) return;
  pupils = [];
  nextPupilId = 1;
  // Clear seats
  desks.forEach(d => d.seatId = null);
  DEMO_NAMES.forEach(([name, gender, att, sen, pp, eal]) => {
    pupils.push({ id: nextPupilId++, name, gender, att, sen, pp, eal });
  });
  renderRoster();
  renderDesks();
  updateStats();
}

/* ===================================================
   LAYOUT PRESETS
=================================================== */
function applyLayout(type) {
  if (desks.some(d => d.seatId) &&
      !confirm('Applying a new layout will clear all seat assignments. Continue?')) return;

  desks = [];
  nextDeskId = 1;
  const W = 720, H = 520;
  const DW = 74, DH = 44, GAP = 10;

  if (type === 'rows') {
    // 5 rows x 6 cols
    const cols = 6, rows = 5;
    const totalW = cols * DW + (cols-1) * GAP;
    const startX = (W - totalW) / 2;
    const startY = 55;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        desks.push({ id: nextDeskId++, x: startX + c*(DW+GAP), y: startY + r*(DH+GAP+6), seatId: null });
      }
    }
  } else if (type === 'pairs') {
    // Pairs: 2 desks side by side with aisle
    const pairW = DW*2 + 4;
    const cols = 3, rows = 5;
    const aisle = 24;
    const totalW = cols * pairW + (cols-1) * aisle;
    const startX = (W - totalW) / 2;
    const startY = 55;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const bx = startX + c*(pairW + aisle);
        desks.push({ id: nextDeskId++, x: bx,       y: startY + r*(DH+14), seatId: null });
        desks.push({ id: nextDeskId++, x: bx + DW + 4, y: startY + r*(DH+14), seatId: null });
      }
    }
  } else if (type === 'groups4') {
    // Groups of 4: 2x2 clusters
    const clusters = [[1,0],[2,0],[0,1],[1,1],[2,1]];
    const clW = DW*2 + 6, clH = DH*2 + 6;
    const clGapX = 18, clGapY = 20;
    const cols = 3;
    const startX = (W - (cols * clW + (cols-1)*clGapX)) / 2;
    const startY = 55;
    let idx = 0;
    for (let r = 0; r < 2; r++) {
      for (let c = 0; c < cols; c++) {
        const bx = startX + c*(clW+clGapX);
        const by = startY + r*(clH+clGapY);
        // 2x2
        for (let dr = 0; dr < 2; dr++) {
          for (let dc = 0; dc < 2; dc++) {
            desks.push({ id: nextDeskId++, x: bx + dc*(DW+6), y: by + dr*(DH+6), seatId: null });
          }
        }
      }
    }
  } else if (type === 'horseshoe') {
    // U-shape: bottom row + two side columns
    const bottomY = H - DH - 20;
    const sideTop  = 55;
    const innerCols = 6;
    const totalW2 = innerCols * DW + (innerCols-1) * GAP;
    const startX2 = (W - totalW2) / 2;

    // bottom row
    for (let c = 0; c < innerCols; c++) {
      desks.push({ id: nextDeskId++, x: startX2 + c*(DW+GAP), y: bottomY, seatId: null });
    }
    // left column (upward)
    for (let r = 0; r < 4; r++) {
      desks.push({ id: nextDeskId++, x: startX2 - DW - 14, y: sideTop + r*(DH+GAP+2), seatId: null });
    }
    // right column (upward)
    for (let r = 0; r < 4; r++) {
      desks.push({ id: nextDeskId++, x: startX2 + totalW2 + 14, y: sideTop + r*(DH+GAP+2), seatId: null });
    }
    // top row (joining U)
    for (let c = 0; c < innerCols; c++) {
      desks.push({ id: nextDeskId++, x: startX2 + c*(DW+GAP), y: sideTop, seatId: null });
    }
  }

  renderDesks();
  renderRoster();
  updateStats();
}

/* ===================================================
   ADD / REMOVE DESKS MANUALLY
=================================================== */
function addDesk() {
  const W = 720, H = 520;
  const x = 60 + Math.floor(Math.random() * (W-180));
  const y = 55 + Math.floor(Math.random() * (H-120));
  desks.push({ id: nextDeskId++, x, y, seatId: null });
  renderDesks();
  updateStats();
}
function removeLastDesk() {
  if (!desks.length) return;
  const last = desks[desks.length-1];
  if (last.seatId) {
    if (!confirm('This desk has a seated pupil. Remove it anyway?')) return;
  }
  desks.pop();
  renderDesks();
  renderRoster();
  updateStats();
}

/* ===================================================
   RENDER ROSTER
=================================================== */
function renderRoster() {
  const list = document.getElementById('roster-list');
  if (!pupils.length) {
    list.innerHTML = '<p class="roster-empty">No pupils yet. Add pupils above or load a demo class.</p>';
    return;
  }
  const seatedIds = new Set(desks.filter(d => d.seatId).map(d => d.seatId));
  list.innerHTML = pupils.map(p => {
    const seated = seatedIds.has(p.id);
    const tags = buildTagsHTML(p);
    return `<div class="roster-pupil ${seated ? 'seated' : ''}"
                 id="roster-${p.id}"
                 draggable="${!seated}"
                 ondragstart="rosterDragStart(event,${p.id})"
                 ondragend="rosterDragEnd(event)">
      <span class="pname">${escHtml(p.name)}</span>
      <span class="ptags">${tags}</span>
      <button class="del-pupil" onclick="deletePupil(${p.id})" title="Remove pupil">&#x2715;</button>
    </div>`;
  }).join('');
}

function buildTagsHTML(p) {
  let t = '';
  if (p.gender === 'M') t += '<span class="ptag ptag-m">M</span>';
  if (p.gender === 'F') t += '<span class="ptag ptag-f">F</span>';
  if (p.gender === 'O') t += '<span class="ptag ptag-o">O</span>';
  if (p.att)  t += `<span class="ptag ptag-att">A${p.att}</span>`;
  if (p.sen)  t += '<span class="ptag ptag-sen">SEN</span>';
  if (p.pp)   t += '<span class="ptag ptag-pp">PP</span>';
  if (p.eal)  t += '<span class="ptag ptag-eal">EAL</span>';
  return t;
}

/* ===================================================
   RENDER DESKS (SVG)
=================================================== */
const DW = 74, DH = 44;

function getDeskColour(desk) {
  if (!desk.seatId) return '#f1f5f9'; // empty
  const p = pupils.find(x => x.id === desk.seatId);
  if (!p) return '#f1f5f9';
  switch (currentOverlay) {
    case 'gender':
      if (p.gender === 'M') return '#93c5fd';
      if (p.gender === 'F') return '#f9a8d4';
      if (p.gender === 'O') return '#c4b5fd';
      return '#e5e7eb';
    case 'att':
      const attClrs = ['','#fca5a5','#fdba74','#fde68a','#86efac','#5eead4'];
      return attClrs[parseInt(p.att)||0] || '#e5e7eb';
    case 'sen':
      return p.sen ? '#fcd34d' : '#e5e7eb';
    case 'pp':
      return p.pp ? '#c4b5fd' : '#e5e7eb';
    case 'eal':
      return p.eal ? '#67e8f9' : '#e5e7eb';
    default:
      return desk.seatId ? '#dde4ff' : '#f1f5f9';
  }
}

function getDeskStroke(desk) {
  if (!desk.seatId) return '#cbd5e1';
  switch (currentOverlay) {
    case 'gender':
      const p = pupils.find(x => x.id === desk.seatId);
      if (!p) return '#94a3b8';
      if (p.gender === 'M') return '#60a5fa';
      if (p.gender === 'F') return '#f472b6';
      if (p.gender === 'O') return '#a78bfa';
      return '#94a3b8';
    default:
      return '#818cf8';
  }
}

function renderDesks() {
  const g = document.getElementById('desks-group');
  const seatedIds = new Set(desks.filter(d => d.seatId).map(d => d.seatId));

  g.innerHTML = desks.map(desk => {
    const fill   = getDeskColour(desk);
    const stroke = getDeskStroke(desk);
    const p = desk.seatId ? pupils.find(x => x.id === desk.seatId) : null;
    const label  = p ? p.name : '';
    const sublabel = p ? buildSublabel(p) : '';
    const shortLabel = truncate(label, 11);

    return `<g class="desk-tile"
               data-desk="${desk.id}"
               ondragover="deskDragOver(event,${desk.id})"
               ondrop="deskDrop(event,${desk.id})"
               ondragleave="deskDragLeave(event,${desk.id})"
               onclick="deskClick(${desk.id})">
      <rect x="${desk.x}" y="${desk.y}" width="${DW}" height="${DH}"
            rx="5" fill="${fill}" stroke="${stroke}" stroke-width="1.8"/>
      ${p
        ? `<text x="${desk.x + DW/2}" y="${desk.y + 17}" text-anchor="middle"
                 fill="#1e1b4b" font-size="10.5" font-weight="600"
                 font-family="system-ui,sans-serif">${escSvg(shortLabel)}</text>
           <text x="${desk.x + DW/2}" y="${desk.y + 30}" text-anchor="middle"
                 fill="#6b7280" font-size="8.5"
                 font-family="system-ui,sans-serif">${escSvg(sublabel)}</text>`
        : `<text x="${desk.x + DW/2}" y="${desk.y + DH/2 + 4}" text-anchor="middle"
                 fill="#cbd5e1" font-size="11"
                 font-family="system-ui,sans-serif">Empty</text>`
      }
    </g>`;
  }).join('');

  updateStats();
}

function buildSublabel(p) {
  const parts = [];
  if (p.gender) parts.push(p.gender);
  if (p.att)    parts.push('A' + p.att);
  if (p.sen)    parts.push('SEN');
  if (p.pp)     parts.push('PP');
  if (p.eal)    parts.push('EAL');
  return parts.join(' ');
}

function truncate(str, n) {
  return str.length > n ? str.slice(0, n-1) + '\u2026' : str;
}

/* ===================================================
   DRAG FROM ROSTER
=================================================== */
function rosterDragStart(e, pupilId) {
  dragPupilId = pupilId;
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => {
    const el = document.getElementById('roster-' + pupilId);
    if (el) el.classList.add('dragging');
  }, 0);
}
function rosterDragEnd(e) {
  if (dragPupilId) {
    const el = document.getElementById('roster-' + dragPupilId);
    if (el) el.classList.remove('dragging');
  }
}

/* ===================================================
   DRAG OVER / DROP ON DESK
=================================================== */
function deskDragOver(e, deskId) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  dragDeskId = deskId;
  const g = document.querySelector(`[data-desk="${deskId}"] rect`);
  if (g) g.classList.add('drag-over-desk');
}
function deskDragLeave(e, deskId) {
  const g = document.querySelector(`[data-desk="${deskId}"] rect`);
  if (g) g.classList.remove('drag-over-desk');
}
function deskDrop(e, deskId) {
  e.preventDefault();
  e.stopPropagation();
  const desk = desks.find(d => d.id === deskId);
  if (!desk || !dragPupilId) return;

  // If desk already has someone, swap them to roster (unseat)
  if (desk.seatId && desk.seatId !== dragPupilId) {
    // Put previous pupil back to unseated (already roster - just clear)
    const prevDesk = desks.find(d => d.id === deskId);
    prevDesk.seatId = null;
  }

  // Unseat pupil from any other desk they may occupy
  desks.forEach(d => { if (d.seatId === dragPupilId) d.seatId = null; });

  desk.seatId = dragPupilId;
  dragPupilId = null;
  dragDeskId  = null;
  renderDesks();
  renderRoster();
}
function svgDragOver(e) { e.preventDefault(); }
function svgDragLeave(e) {}
function svgDrop(e) {
  // Dropped on SVG background = unseat
  e.preventDefault();
  if (dragPupilId) {
    desks.forEach(d => { if (d.seatId === dragPupilId) d.seatId = null; });
    dragPupilId = null;
    renderDesks();
    renderRoster();
  }
}

/* ===================================================
   CLICK DESK = EDIT MODAL
=================================================== */
function deskClick(deskId) {
  const desk = desks.find(d => d.id === deskId);
  if (!desk || !desk.seatId) return;
  const p = pupils.find(x => x.id === desk.seatId);
  if (!p) return;
  modalContext = { type: 'seated', deskId };
  openModal(p);
}

function openModal(p) {
  document.getElementById('modal-title').textContent = 'Edit Pupil: ' + p.name;
  document.getElementById('modal-name').value   = p.name;
  document.getElementById('modal-gender').value = p.gender || '';
  document.getElementById('modal-att').value    = p.att    || '';
  document.getElementById('modal-sen').checked  = !!p.sen;
  document.getElementById('modal-pp').checked   = !!p.pp;
  document.getElementById('modal-eal').checked  = !!p.eal;
  document.getElementById('modal-backdrop').classList.remove('hidden');
}
function closeModal(e) {
  if (e.target === document.getElementById('modal-backdrop')) {
    document.getElementById('modal-backdrop').classList.add('hidden');
  }
}
function saveModal() {
  if (!modalContext) return;
  let p;
  if (modalContext.type === 'seated') {
    const desk = desks.find(d => d.id === modalContext.deskId);
    p = pupils.find(x => x.id === desk.seatId);
  }
  if (!p) return;
  p.name   = document.getElementById('modal-name').value.trim() || p.name;
  p.gender = document.getElementById('modal-gender').value;
  p.att    = document.getElementById('modal-att').value;
  p.sen    = document.getElementById('modal-sen').checked;
  p.pp     = document.getElementById('modal-pp').checked;
  p.eal    = document.getElementById('modal-eal').checked;
  document.getElementById('modal-backdrop').classList.add('hidden');
  renderDesks();
  renderRoster();
  updateStats();
}
function unseatFromModal() {
  if (!modalContext) return;
  if (modalContext.type === 'seated') {
    const desk = desks.find(d => d.id === modalContext.deskId);
    if (desk) desk.seatId = null;
  }
  document.getElementById('modal-backdrop').classList.add('hidden');
  renderDesks();
  renderRoster();
  updateStats();
}

/* ===================================================
   ADD PUPIL FROM FORM
=================================================== */
function addPupil(e) {
  e.preventDefault();
  const name = document.getElementById('new-pupil-name').value.trim();
  if (!name) return;
  const gender = document.getElementById('new-pupil-gender').value;
  const att    = document.getElementById('new-pupil-att').value;
  pupils.push({
    id: nextPupilId++,
    name, gender, att,
    sen: newFlags.sen,
    pp:  newFlags.pp,
    eal: newFlags.eal
  });
  document.getElementById('new-pupil-name').value = '';
  document.getElementById('new-pupil-gender').value = '';
  document.getElementById('new-pupil-att').value = '';
  newFlags = { sen: false, pp: false, eal: false };
  ['sen','pp','eal'].forEach(f => {
    document.getElementById('toggle-' + f).className = 'flag-toggle';
  });
  renderRoster();
  updateStats();
}

function toggleFlag(flag) {
  newFlags[flag] = !newFlags[flag];
  const btn = document.getElementById('toggle-' + flag);
  btn.className = 'flag-toggle' + (newFlags[flag] ? (' active-' + flag) : '');
}

function deletePupil(id) {
  desks.forEach(d => { if (d.seatId === id) d.seatId = null; });
  pupils = pupils.filter(p => p.id !== id);
  renderRoster();
  renderDesks();
  updateStats();
}

/* ===================================================
   CLEAR ALL SEATS
=================================================== */
function clearAllSeats() {
  if (!confirm('Remove all pupils from desks?')) return;
  desks.forEach(d => d.seatId = null);
  renderDesks();
  renderRoster();
}

/* ===================================================
   OVERLAY
=================================================== */
function setOverlay(mode) {
  currentOverlay = mode;
  document.querySelectorAll('.overlay-btns .tb-btn').forEach(btn => btn.classList.remove('active'));
  const activeBtn = document.getElementById('ov-' + mode);
  if (activeBtn) activeBtn.classList.add('active');
  renderDesks();
  updateLegend();
}

function updateLegend() {
  const l = document.getElementById('legend-list');
  const legends = {
    none: [{ colour: '#dde4ff', label: 'Pupil seated' }, { colour: '#f1f5f9', label: 'Empty desk' }],
    gender: [
      { colour: '#93c5fd', label: 'Male' },
      { colour: '#f9a8d4', label: 'Female' },
      { colour: '#c4b5fd', label: 'Other / not stated' },
      { colour: '#e5e7eb', label: 'Not recorded' }
    ],
    att: [
      { colour: '#fca5a5', label: 'Attainment 1 (lowest)' },
      { colour: '#fdba74', label: 'Attainment 2' },
      { colour: '#fde68a', label: 'Attainment 3' },
      { colour: '#86efac', label: 'Attainment 4' },
      { colour: '#5eead4', label: 'Attainment 5 (highest)' },
      { colour: '#e5e7eb', label: 'Not recorded' }
    ],
    sen: [
      { colour: '#fcd34d', label: 'SEN support' },
      { colour: '#e5e7eb', label: 'No SEN' }
    ],
    pp: [
      { colour: '#c4b5fd', label: 'Pupil Premium' },
      { colour: '#e5e7eb', label: 'Non-PP' }
    ],
    eal: [
      { colour: '#67e8f9', label: 'EAL learner' },
      { colour: '#e5e7eb', label: 'Non-EAL' }
    ]
  };
  const items = legends[currentOverlay] || legends.none;
  l.innerHTML = items.map(it =>
    `<div class="legend-item">
      <div class="legend-swatch" style="background:${it.colour}"></div>
      <span>${it.label}</span>
    </div>`
  ).join('');
}

/* ===================================================
   STATS
=================================================== */
function updateStats() {
  const total    = pupils.length;
  const seated   = desks.filter(d => d.seatId).length;
  const unseated = total - seated;

  function setEl(id, val) {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  }
  function pct(n, t) { return t ? Math.round(n/t*100) + '%' : '0%'; }
  function pctNum(n, t) { return t ? Math.round(n/t*100) : 0; }

  setEl('stat-total',    total);
  setEl('stat-seated',   seated);
  setEl('stat-unseated', unseated);
  setEl('stat-desks',    desks.length);

  const ppN  = pupils.filter(p => p.pp).length;
  const senN = pupils.filter(p => p.sen).length;
  const ealN = pupils.filter(p => p.eal).length;

  setEl('stat-pp-n',    ppN);
  setEl('stat-pp-pct',  pct(ppN, total));
  setEl('stat-sen-n',   senN);
  setEl('stat-sen-pct', pct(senN, total));
  setEl('stat-eal-n',   ealN);
  setEl('stat-eal-pct', pct(ealN, total));

  const barPP  = document.getElementById('bar-pp');
  const barSEN = document.getElementById('bar-sen');
  const barEAL = document.getElementById('bar-eal');
  if (barPP)  barPP.style.width  = pctNum(ppN,  total) + '%';
  if (barSEN) barSEN.style.width = pctNum(senN, total) + '%';
  if (barEAL) barEAL.style.width = pctNum(ealN, total) + '%';

  const maleN   = pupils.filter(p => p.gender === 'M').length;
  const femaleN = pupils.filter(p => p.gender === 'F').length;
  const otherN  = pupils.filter(p => p.gender === 'O' || !p.gender).length;
  setEl('stat-m', maleN);
  setEl('stat-f', femaleN);
  setEl('stat-o', otherN);

  // Attainment profile
  const attDiv = document.getElementById('att-profile');
  if (attDiv) {
    const attCounts = [0,0,0,0,0];
    pupils.forEach(p => { if (p.att) attCounts[parseInt(p.att)-1]++; });
    attDiv.innerHTML = attCounts.map((c,i) =>
      `<div class="stat-row">
        <span>Level ${i+1}</span>
        <span class="val">${c} <span style="font-weight:400;color:var(--clr-text-muted)">(${pct(c,total)})</span></span>
      </div>`
    ).join('');
  }

  renderSavedPlansList();
}

/* ===================================================
   SAVE / LOAD / EXPORT
=================================================== */
function getPlanData() {
  return { pupils, desks, nextPupilId, nextDeskId, currentOverlay };
}
function applyPlanData(data) {
  pupils         = data.pupils         || [];
  desks          = data.desks          || [];
  nextPupilId    = data.nextPupilId    || (pupils.length + 1);
  nextDeskId     = data.nextDeskId     || (desks.length + 1);
  currentOverlay = data.currentOverlay || 'none';
}

function savePlan() {
  const name = document.getElementById('plan-name-input').value.trim() || 'Unnamed Plan';
  const stored = JSON.parse(localStorage.getItem('seatingPlans') || '{}');
  stored[name] = { name, savedAt: new Date().toISOString(), data: getPlanData() };
  localStorage.setItem('seatingPlans', JSON.stringify(stored));
  renderSavedPlansList();
  showToast('Plan "' + name + '" saved.');
}

function loadPlan(name) {
  const stored = JSON.parse(localStorage.getItem('seatingPlans') || '{}');
  if (!stored[name]) return;
  applyPlanData(stored[name].data);
  setOverlay(currentOverlay);
  renderRoster();
  renderDesks();
  updateStats();
  showToast('Plan "' + name + '" loaded.');
}

function deleteSavedPlan(name) {
  if (!confirm('Delete saved plan "' + name + '"?')) return;
  const stored = JSON.parse(localStorage.getItem('seatingPlans') || '{}');
  delete stored[name];
  localStorage.setItem('seatingPlans', JSON.stringify(stored));
  renderSavedPlansList();
}

function renderSavedPlansList() {
  const stored = JSON.parse(localStorage.getItem('seatingPlans') || '{}');
  const el = document.getElementById('saved-plans-list');
  const keys = Object.keys(stored);
  if (!keys.length) {
    el.innerHTML = '<p style="font-size:0.73rem;color:var(--clr-text-muted)">No saved plans yet.</p>';
    return;
  }
  el.innerHTML = keys.map(name => {
    const s = stored[name];
    const date = s.savedAt ? new Date(s.savedAt).toLocaleDateString('en-GB', { day:'2-digit', month:'short' }) : '';
    return `<div class="saved-plan-item">
      <span class="pname-load">${escHtml(name)}</span>
      <span style="color:var(--clr-text-muted);font-size:0.68rem">${date}</span>
      <button onclick="loadPlan('${escAttr(name)}')">Load</button>
      <button class="del-plan" onclick="deleteSavedPlan('${escAttr(name)}')">&#x2715;</button>
    </div>`;
  }).join('');
}

function exportPlanJSON() {
  const name = document.getElementById('plan-name-input').value.trim() || 'seating-plan';
  const json = JSON.stringify({ name, exportedAt: new Date().toISOString(), data: getPlanData() }, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = name.replace(/\s+/g, '-').toLowerCase() + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importPlanJSON(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const obj = JSON.parse(ev.target.result);
      if (!obj.data) throw new Error('Invalid plan file.');
      applyPlanData(obj.data);
      if (obj.name) document.getElementById('plan-name-input').value = obj.name;
      setOverlay(currentOverlay);
      renderRoster();
      renderDesks();
      updateStats();
      showToast('Plan imported successfully.');
    } catch (err) {
      alert('Could not import plan: ' + err.message);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

/* ===================================================
   PRINT
=================================================== */
function printView() {
  window.print();
}

/* ===================================================
   UTILITY
=================================================== */
function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
function escSvg(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}
function escAttr(str) {
  return String(str).replace(/'/g, "\\'");
}

let toastTimer;
function showToast(msg) {
  let t = document.getElementById('toast-el');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast-el';
    Object.assign(t.style, {
      position:'fixed', bottom:'20px', left:'50%', transform:'translateX(-50%)',
      background:'var(--clr-primary-dark)', color:'#fff', padding:'8px 18px',
      borderRadius:'6px', fontSize:'0.8rem', zIndex:'9999',
      boxShadow:'0 2px 10px rgba(0,0,0,0.2)', transition:'opacity 0.3s'
    });
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.style.opacity = '0'; }, 2400);
}

/* ===================================================
   INIT
=================================================== */
(function init() {
  applyLayout('rows');
  setOverlay('none');
  updateStats();
  updateLegend();
  renderSavedPlansList();
})();
</script>
</body>
</html>
