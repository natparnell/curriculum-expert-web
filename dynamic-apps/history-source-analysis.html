<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Source Analysis Workbench</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600&family=IM+Fell+English:ital@0;1&display=swap');

  :root {
    --parchment: #f5e6c8;
    --parchment-light: #faf3e3;
    --parchment-dark: #e8d5a8;
    --wood-dark: #3e2723;
    --wood-medium: #5d4037;
    --wood-light: #6d4c41;
    --sepia: #704214;
    --sepia-light: #8b6914;
    --ink-black: #1a1a1a;
    --ink-brown: #3e2723;
    --gold: #c9a84c;
    --gold-light: #dfc06f;
    --red-wax: #8b1a1a;
    --tag-content: #2e7d32;
    --tag-provenance: #1565c0;
    --tag-bias: #e65100;
    --tag-tone: #6a1b9a;
    --tag-reliability: #00838f;
    --tag-utility: #ad1457;
    --shadow: rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Crimson Text', Georgia, serif;
    background:
      linear-gradient(135deg, #2c1810 0%, #3e2723 30%, #4e342e 60%, #3e2723 100%);
    color: var(--ink-black);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Wood grain texture overlay */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background:
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.03) 2px,
        rgba(0,0,0,0.03) 4px
      ),
      repeating-linear-gradient(
        85deg,
        transparent,
        transparent 8px,
        rgba(139,105,63,0.05) 8px,
        rgba(139,105,63,0.05) 10px
      );
    pointer-events: none;
    z-index: 0;
  }

  /* Header */
  .header {
    background: linear-gradient(180deg, var(--wood-dark) 0%, var(--wood-medium) 100%);
    border-bottom: 4px solid var(--gold);
    padding: 18px 30px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }

  .header::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, var(--gold-light), transparent);
  }

  .header-content {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .title-section {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .title-icon {
    font-size: 32px;
    color: var(--gold);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    line-height: 1;
  }

  h1 {
    font-family: 'Cinzel', serif;
    font-size: 28px;
    color: var(--parchment);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    letter-spacing: 2px;
  }

  h1 small {
    display: block;
    font-family: 'IM Fell English', serif;
    font-size: 13px;
    color: var(--gold-light);
    font-weight: 400;
    letter-spacing: 1px;
    margin-top: 2px;
  }

  .header-controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .header-btn {
    font-family: 'Cinzel', serif;
    font-size: 13px;
    padding: 8px 18px;
    border: 1px solid var(--gold);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    letter-spacing: 1px;
    background: transparent;
    color: var(--gold);
  }

  .header-btn:hover {
    background: var(--gold);
    color: var(--wood-dark);
  }

  .header-btn.primary {
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    color: var(--wood-dark);
    font-weight: 700;
    border-color: var(--gold-light);
  }

  .header-btn.primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(201,168,76,0.4);
  }

  /* Enquiry Question Banner */
  .enquiry-banner {
    background: linear-gradient(135deg, var(--parchment-dark) 0%, var(--parchment) 50%, var(--parchment-dark) 100%);
    border-bottom: 2px solid var(--gold);
    padding: 16px 30px;
    position: relative;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
  }

  .enquiry-banner::before,
  .enquiry-banner::after {
    content: '\2766';
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    font-size: 20px;
  }

  .enquiry-banner::before { left: 14px; }
  .enquiry-banner::after { right: 14px; }

  .enquiry-content {
    max-width: 1600px;
    margin: 0 auto;
    text-align: center;
  }

  .enquiry-label {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--sepia);
    margin-bottom: 4px;
  }

  .enquiry-question {
    font-family: 'IM Fell English', serif;
    font-size: 19px;
    color: var(--ink-brown);
    font-style: italic;
    line-height: 1.4;
  }

  /* Main Layout */
  .main-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 20px;
    position: relative;
    z-index: 1;
  }

  /* Source Selector Tabs */
  .source-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .source-tab {
    font-family: 'Cinzel', serif;
    font-size: 13px;
    padding: 10px 20px;
    background: var(--wood-medium);
    color: var(--parchment-dark);
    border: none;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    transition: all 0.3s;
    letter-spacing: 1px;
    position: relative;
  }

  .source-tab:hover {
    background: var(--wood-light);
    color: var(--parchment);
  }

  .source-tab.active {
    background: var(--parchment);
    color: var(--sepia);
    font-weight: 700;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
  }

  .source-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0; right: 0;
    height: 3px;
    background: var(--gold);
  }

  .source-tab .tab-type {
    display: block;
    font-family: 'Crimson Text', serif;
    font-size: 10px;
    opacity: 0.7;
    margin-top: 2px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Source Display Panel */
  .source-panel {
    background:
      linear-gradient(135deg, var(--parchment-light) 0%, var(--parchment) 40%, var(--parchment-dark) 100%);
    border-radius: 8px;
    box-shadow:
      0 4px 20px rgba(0,0,0,0.3),
      inset 0 1px 0 rgba(255,255,255,0.3),
      0 0 0 1px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
  }

  /* Parchment texture */
  .source-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background:
      radial-gradient(ellipse at 20% 50%, rgba(139,105,63,0.06) 0%, transparent 70%),
      radial-gradient(ellipse at 80% 20%, rgba(139,105,63,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 50% 80%, rgba(139,105,63,0.05) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .source-header {
    background: linear-gradient(135deg, var(--wood-dark), var(--wood-medium));
    padding: 16px 24px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }

  .source-title-area h2 {
    font-family: 'Cinzel', serif;
    font-size: 20px;
    color: var(--parchment);
    margin-bottom: 4px;
  }

  .source-title-area .source-type-badge {
    display: inline-block;
    font-family: 'Crimson Text', serif;
    font-size: 12px;
    padding: 2px 12px;
    border-radius: 12px;
    background: rgba(201,168,76,0.2);
    color: var(--gold-light);
    border: 1px solid rgba(201,168,76,0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .source-metadata {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .meta-item {
    font-family: 'Crimson Text', serif;
    font-size: 13px;
    color: var(--parchment-dark);
  }

  .meta-item strong {
    color: var(--gold-light);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: block;
    margin-bottom: 1px;
  }

  .source-body {
    padding: 28px;
    position: relative;
    z-index: 1;
    min-height: 300px;
  }

  .source-text {
    font-family: 'IM Fell English', serif;
    font-size: 17px;
    line-height: 1.85;
    color: var(--ink-brown);
    white-space: pre-wrap;
    cursor: text;
    position: relative;
  }

  .source-text .selectable-line {
    display: inline;
    border-radius: 2px;
    transition: background 0.15s;
  }

  /* Visual source (poster / cartoon description) */
  .visual-source {
    border: 3px double var(--sepia);
    padding: 20px;
    margin: 0 auto;
    max-width: 650px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
  }

  .visual-source .poster-frame {
    border: 2px solid var(--sepia);
    padding: 16px;
    text-align: center;
    background: linear-gradient(180deg, rgba(245,230,200,0.5), rgba(232,213,168,0.5));
  }

  .visual-source .ascii-art {
    font-family: 'Courier New', monospace;
    font-size: 11px;
    line-height: 1.2;
    color: var(--sepia);
    white-space: pre;
    margin: 12px 0;
    display: inline-block;
    text-align: left;
  }

  .visual-source .poster-text {
    font-family: 'Cinzel', serif;
    font-size: 20px;
    color: var(--red-wax);
    margin: 10px 0;
    text-transform: uppercase;
    letter-spacing: 3px;
    font-weight: 700;
  }

  .visual-source .poster-subtext {
    font-family: 'Crimson Text', serif;
    font-size: 15px;
    color: var(--sepia);
    font-style: italic;
  }

  .visual-desc {
    font-family: 'Crimson Text', serif;
    font-size: 14px;
    color: var(--sepia);
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid rgba(112,66,20,0.2);
    line-height: 1.6;
    font-style: italic;
  }

  /* Highlight colours for tags */
  .highlight-content { background: rgba(46,125,50,0.22); border-bottom: 2px solid var(--tag-content); }
  .highlight-provenance { background: rgba(21,101,192,0.18); border-bottom: 2px solid var(--tag-provenance); }
  .highlight-bias { background: rgba(230,81,0,0.18); border-bottom: 2px solid var(--tag-bias); }
  .highlight-tone { background: rgba(106,27,154,0.18); border-bottom: 2px solid var(--tag-tone); }
  .highlight-reliability { background: rgba(0,131,143,0.18); border-bottom: 2px solid var(--tag-reliability); }
  .highlight-utility { background: rgba(173,20,87,0.18); border-bottom: 2px solid var(--tag-utility); }

  /* Annotation Tag Context Menu */
  .tag-menu {
    position: absolute;
    background: var(--wood-dark);
    border: 1px solid var(--gold);
    border-radius: 8px;
    padding: 8px;
    z-index: 200;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    display: none;
    min-width: 220px;
  }

  .tag-menu.visible { display: block; }

  .tag-menu-title {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 2px;
    padding: 4px 8px 8px;
    border-bottom: 1px solid rgba(201,168,76,0.3);
    margin-bottom: 6px;
  }

  .tag-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
  }

  .tag-option:hover { background: rgba(255,255,255,0.1); }

  .tag-color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .tag-option-label {
    font-family: 'Crimson Text', serif;
    font-size: 14px;
    color: var(--parchment);
  }

  .tag-option-desc {
    font-size: 11px;
    color: var(--parchment-dark);
    opacity: 0.7;
  }

  /* Annotations list below source */
  .annotations-section {
    padding: 16px 28px 24px;
    border-top: 1px solid rgba(112,66,20,0.15);
    position: relative;
    z-index: 1;
  }

  .annotations-title {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    color: var(--sepia);
    margin-bottom: 10px;
    letter-spacing: 1px;
  }

  .annotation-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 200px;
    overflow-y: auto;
  }

  .annotation-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    background: rgba(255,255,255,0.4);
    border-left: 3px solid;
    font-size: 14px;
  }

  .annotation-item .ann-tag {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 2px 8px;
    border-radius: 3px;
    color: #fff;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .annotation-item .ann-text {
    font-family: 'Crimson Text', serif;
    color: var(--ink-brown);
    line-height: 1.4;
    flex: 1;
  }

  .annotation-item .ann-remove {
    background: none;
    border: none;
    color: var(--red-wax);
    cursor: pointer;
    font-size: 16px;
    padding: 0 4px;
    opacity: 0.5;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }

  .annotation-item .ann-remove:hover { opacity: 1; }

  .ann-empty {
    font-family: 'IM Fell English', serif;
    font-style: italic;
    color: var(--sepia);
    opacity: 0.5;
    font-size: 14px;
    padding: 8px;
  }

  /* Instruction hint */
  .highlight-hint {
    font-family: 'Crimson Text', serif;
    font-size: 13px;
    color: var(--sepia);
    text-align: center;
    padding: 10px;
    opacity: 0.7;
    font-style: italic;
    border-top: 1px solid rgba(112,66,20,0.1);
    position: relative;
    z-index: 1;
  }

  /* Tag Legend */
  .tag-legend {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding: 12px 28px;
    border-top: 1px solid rgba(112,66,20,0.1);
    position: relative;
    z-index: 1;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    font-family: 'Crimson Text', serif;
    color: var(--sepia);
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Side Panel - Analysis Scaffold */
  .side-panel {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .scaffold-panel {
    background: linear-gradient(135deg, var(--parchment-light), var(--parchment));
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    overflow: hidden;
    border: 1px solid rgba(112,66,20,0.15);
  }

  .scaffold-header {
    background: linear-gradient(135deg, var(--wood-dark), var(--wood-medium));
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .scaffold-header h3 {
    font-family: 'Cinzel', serif;
    font-size: 15px;
    color: var(--parchment);
    letter-spacing: 1px;
  }

  .scaffold-header .scaffold-icon {
    color: var(--gold);
    font-size: 18px;
  }

  .scaffold-body {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    max-height: calc(100vh - 320px);
    overflow-y: auto;
  }

  .scaffold-section {
    border: 1px solid rgba(112,66,20,0.15);
    border-radius: 6px;
    overflow: hidden;
    background: rgba(255,255,255,0.3);
  }

  .scaffold-section-header {
    background: rgba(112,66,20,0.08);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
  }

  .scaffold-section-header h4 {
    font-family: 'Cinzel', serif;
    font-size: 13px;
    color: var(--sepia);
    letter-spacing: 1px;
  }

  .scaffold-prompt {
    font-family: 'IM Fell English', serif;
    font-size: 12px;
    color: var(--sepia);
    opacity: 0.7;
    font-style: italic;
    padding: 4px 12px 0;
  }

  .scaffold-section textarea {
    width: 100%;
    min-height: 70px;
    padding: 10px 12px;
    border: none;
    background: transparent;
    font-family: 'Crimson Text', serif;
    font-size: 14px;
    line-height: 1.5;
    color: var(--ink-brown);
    resize: vertical;
  }

  .scaffold-section textarea:focus {
    outline: none;
    background: rgba(201,168,76,0.06);
  }

  .scaffold-section textarea::placeholder {
    color: var(--sepia);
    opacity: 0.35;
    font-style: italic;
  }

  .scaffold-section .section-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(112,66,20,0.2);
    transition: background 0.3s;
    flex-shrink: 0;
  }

  .scaffold-section .section-status.filled {
    background: var(--tag-content);
    box-shadow: 0 0 6px rgba(46,125,50,0.4);
  }

  /* Check Analysis Button */
  .check-btn-container {
    padding: 0 16px 16px;
  }

  .check-btn {
    width: 100%;
    font-family: 'Cinzel', serif;
    font-size: 15px;
    letter-spacing: 2px;
    padding: 14px;
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    color: var(--wood-dark);
    border: 2px solid var(--gold);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s;
    text-transform: uppercase;
  }

  .check-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(201,168,76,0.4);
  }

  .check-btn:active { transform: translateY(0); }

  /* Results Modal */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow-y: auto;
  }

  .modal-overlay.visible {
    display: flex;
  }

  .modal {
    background: linear-gradient(135deg, var(--parchment-light), var(--parchment));
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 2px solid var(--gold);
  }

  .modal-header {
    background: linear-gradient(135deg, var(--wood-dark), var(--wood-medium));
    padding: 20px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .modal-header h2 {
    font-family: 'Cinzel', serif;
    font-size: 22px;
    color: var(--parchment);
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--parchment);
    font-size: 28px;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
    padding: 0 4px;
  }

  .modal-close:hover { opacity: 1; }

  .modal-body {
    padding: 24px 28px;
  }

  /* Overall Score */
  .overall-score {
    text-align: center;
    padding: 24px;
    margin-bottom: 24px;
    border: 2px solid var(--gold);
    border-radius: 10px;
    background: rgba(255,255,255,0.3);
  }

  .score-number {
    font-family: 'Cinzel', serif;
    font-size: 56px;
    font-weight: 700;
    color: var(--sepia);
    line-height: 1;
  }

  .score-percent {
    font-family: 'Cinzel', serif;
    font-size: 24px;
    color: var(--sepia);
  }

  .score-rank {
    font-family: 'Cinzel', serif;
    font-size: 20px;
    color: var(--gold);
    margin-top: 8px;
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .rank-desc {
    font-family: 'IM Fell English', serif;
    font-style: italic;
    color: var(--sepia);
    margin-top: 6px;
    font-size: 15px;
  }

  /* Category Scores */
  .category-scores {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .cat-score-item {
    border: 1px solid rgba(112,66,20,0.15);
    border-radius: 8px;
    overflow: hidden;
    background: rgba(255,255,255,0.3);
  }

  .cat-score-header {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(112,66,20,0.06);
    cursor: pointer;
  }

  .cat-score-header h4 {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    color: var(--sepia);
  }

  .cat-score-bar-bg {
    width: 120px;
    height: 8px;
    background: rgba(112,66,20,0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .cat-score-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 1s ease;
    background: linear-gradient(90deg, var(--gold), var(--tag-content));
  }

  .cat-score-pct {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--sepia);
    min-width: 40px;
    text-align: right;
  }

  .cat-score-detail {
    padding: 12px 16px;
    display: none;
  }

  .cat-score-detail.open { display: block; }

  .key-point {
    padding: 6px 0;
    font-family: 'Crimson Text', serif;
    font-size: 14px;
    color: var(--ink-brown);
    line-height: 1.5;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .key-point .kp-icon {
    flex-shrink: 0;
    font-size: 14px;
    margin-top: 2px;
  }

  .key-point.matched { color: var(--tag-content); }
  .key-point.missed { color: var(--tag-bias); }

  .kp-label {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 1px 6px;
    border-radius: 3px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .kp-label.found { background: rgba(46,125,50,0.15); color: var(--tag-content); }
  .kp-label.missed { background: rgba(230,81,0,0.15); color: var(--tag-bias); }

  /* Responsive */
  @media (max-width: 1024px) {
    .main-container {
      grid-template-columns: 1fr;
    }
    .scaffold-body {
      max-height: none;
    }
  }

  @media (max-width: 600px) {
    h1 { font-size: 20px; }
    .enquiry-question { font-size: 16px; }
    .source-body { padding: 16px; }
    .source-text { font-size: 15px; }
    .modal-body { padding: 16px; }
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: rgba(112,66,20,0.05); }
  ::-webkit-scrollbar-thumb {
    background: rgba(112,66,20,0.2);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover { background: rgba(112,66,20,0.35); }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-in { animation: fadeIn 0.4s ease forwards; }

  /* Progress dots for scaffold completion */
  .progress-dots {
    display: flex;
    gap: 4px;
    padding: 8px 16px;
    justify-content: center;
  }

  .progress-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(112,66,20,0.15);
    transition: all 0.3s;
  }

  .progress-dot.filled {
    background: var(--gold);
    box-shadow: 0 0 8px rgba(201,168,76,0.4);
  }

  /* Notebook style lines */
  .source-text-lined {
    background-image: repeating-linear-gradient(
      transparent,
      transparent 28px,
      rgba(112,66,20,0.06) 28px,
      rgba(112,66,20,0.06) 29px
    );
    padding-top: 6px;
  }
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="header-content">
    <div class="title-section">
      <div class="title-icon">&#9998;</div>
      <h1>Source Analysis Workbench<small>Historical Evidence & Critical Thinking</small></h1>
    </div>
    <div class="header-controls">
      <button class="header-btn" onclick="clearAllWork()" title="Clear all annotations and notes">Clear All</button>
      <button class="header-btn" onclick="exportWork()" title="Export your analysis as text">Export</button>
      <button class="header-btn primary" onclick="checkAnalysis()">Check Analysis</button>
    </div>
  </div>
</header>

<!-- Enquiry Question Banner -->
<div class="enquiry-banner">
  <div class="enquiry-content">
    <div class="enquiry-label">Enquiry Question</div>
    <div class="enquiry-question" id="enquiryQuestion">
      "How far do Sources A&ndash;E suggest that ordinary people's lives were affected by major political events in 20th-century Britain?"
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="main-container">
  <!-- Left: Source Display -->
  <div class="source-area">
    <!-- Source Tabs -->
    <div class="source-tabs" id="sourceTabs"></div>

    <!-- Source Panel -->
    <div class="source-panel" id="sourcePanel">
      <div class="source-header" id="sourceHeader"></div>
      <div class="source-body" id="sourceBody"></div>
      <div class="tag-legend" id="tagLegend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--tag-content)"></div>Content</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--tag-provenance)"></div>Provenance</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--tag-bias)"></div>Bias</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--tag-tone)"></div>Tone</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--tag-reliability)"></div>Reliability</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--tag-utility)"></div>Utility</div>
      </div>
      <div class="highlight-hint">Select any text in the source above, then choose an annotation tag to highlight it.</div>
      <div class="annotations-section">
        <div class="annotations-title">Your Annotations</div>
        <div class="annotation-list" id="annotationList">
          <div class="ann-empty">No annotations yet. Select text above to begin your analysis.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Analysis Scaffold -->
  <div class="side-panel">
    <div class="scaffold-panel">
      <div class="scaffold-header">
        <span class="scaffold-icon">&#128220;</span>
        <h3>Analysis Scaffold</h3>
      </div>
      <div class="progress-dots" id="progressDots"></div>
      <div class="scaffold-body" id="scaffoldBody"></div>
      <div class="check-btn-container">
        <button class="check-btn" onclick="checkAnalysis()">Check My Analysis</button>
      </div>
    </div>
  </div>
</div>

<!-- Tag context menu -->
<div class="tag-menu" id="tagMenu">
  <div class="tag-menu-title">Annotate Selection</div>
</div>

<!-- Results Modal -->
<div class="modal-overlay" id="resultsModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Analysis Feedback</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
// ============================================================
// DATA: Sources
// ============================================================
const TAG_CATEGORIES = [
  { id: 'content', label: 'Content', desc: 'What does it say/show?', color: '#2e7d32' },
  { id: 'provenance', label: 'Provenance', desc: 'Who made it? When? Why?', color: '#1565c0' },
  { id: 'bias', label: 'Bias Indicator', desc: 'What perspective/agenda?', color: '#e65100' },
  { id: 'tone', label: 'Tone', desc: 'What language/emotion?', color: '#6a1b9a' },
  { id: 'reliability', label: 'Reliability', desc: 'Can we trust this? Why/why not?', color: '#00838f' },
  { id: 'utility', label: 'Utility', desc: 'How useful for studying the question?', color: '#ad1457' }
];

const SCAFFOLD_SECTIONS = [
  { id: 'nature', title: 'Nature', prompt: 'What type of source is this? (e.g. letter, poster, report, newspaper article, cartoon)', placeholder: 'Describe the type and format of this source...' },
  { id: 'origin', title: 'Origin', prompt: 'Who created it? When? Where was it produced or published?', placeholder: 'Author, date, place of publication...' },
  { id: 'purpose', title: 'Purpose', prompt: 'Why was this source created? Who was the intended audience?', placeholder: 'The purpose of this source was to...' },
  { id: 'content_analysis', title: 'Content', prompt: 'What information does it contain? What does it tell us?', placeholder: 'The source tells us that...' },
  { id: 'reliability', title: 'Reliability', prompt: 'How trustworthy is this source? What might make it biased or unreliable?', placeholder: 'This source is/is not reliable because...' },
  { id: 'utility', title: 'Utility', prompt: 'How useful is this source for answering the enquiry question?', placeholder: 'This source is useful/limited because...' }
];

const sources = [
  {
    id: 'A',
    title: 'Source A: WW1 Recruitment Poster',
    type: 'Propaganda Poster',
    date: '1914',
    author: 'Parliamentary Recruiting Committee',
    origin: 'London, published by the Parliamentary Recruiting Committee for public display across Britain',
    isVisual: true,
    visualContent: {
      asciiArt:
`        ___________________________
       |                           |
       |    .---------.            |
       |   /   .-"-.   \\           |
       |  |   /     \\   |          |
       |  |  | O   O |  |          |
       |  |  |   ^   |  |          |
       |  |  |  '-'  |  |          |
       |   \\  \\_____/  /           |
       |    '---------'            |
       |      [FIGURE OF           |
       |    LORD KITCHENER         |
       |     IN MILITARY           |
       |      UNIFORM,             |
       |   RIGHT HAND POINTING     |
       |    DIRECTLY FORWARD       |
       |     AT THE VIEWER]        |
       |                           |
       |___________________________|`,
      posterText: 'YOUR COUNTRY NEEDS YOU',
      posterSubtext: 'GOD SAVE THE KING',
      description: 'This iconic recruitment poster depicts Field Marshal Lord Kitchener, Secretary of State for War, shown from the chest upwards in full military dress uniform with peaked cap, medals, and red collar tabs. His thick moustache is prominently displayed. His right arm extends forward with index finger pointing directly at the viewer in an accusatory, personal gesture. The background is a stark, bold design. The lettering is large, capitalised, and commanding. The poster was produced in its millions and displayed on walls, hoardings, and in shop windows across Britain from August 1914. Beneath Kitchener, a large crown sits above the words "GOD SAVE THE KING," linking duty to King and country. The colour scheme uses red, white and blue \u2014 the patriotic colours of the Union Flag.'
    },
    textContent: '[This is a visual source \u2014 see the poster display above. For annotation, consider the following textual elements and visual descriptions:]\n\nMain text: "YOUR COUNTRY NEEDS YOU"\nSubtext: "GOD SAVE THE KING"\n\nVisual elements: Lord Kitchener in military uniform points directly at the viewer. His expression is stern and commanding. The pointing finger creates a direct, personal address to every individual who sees it. Bold patriotic colours of red, white and blue are used throughout. The image is designed to be seen from a distance on billboards and walls. A crown symbol reinforces the connection between military service and loyalty to the monarchy.\n\nThe poster uses the second person "YOU" to make the message feel personally directed at each viewer, creating a sense of individual duty and moral obligation to enlist. Kitchener was already a national hero from his campaigns in Sudan and the Boer War, lending authority and trust to the appeal.',
    modelAnswers: {
      nature: ['propaganda poster', 'recruitment poster', 'visual source', 'government-produced', 'printed poster', 'public display'],
      origin: ['1914', 'Parliamentary Recruiting Committee', 'London', 'British government', 'beginning of WW1', 'displayed across Britain', 'mass produced'],
      purpose: ['recruit soldiers', 'encourage men to enlist', 'voluntary recruitment', 'persuade', 'sense of duty', 'patriotic obligation', 'appeal to loyalty', 'aimed at young men of fighting age'],
      content_analysis: ['Kitchener pointing', 'YOUR COUNTRY NEEDS YOU', 'personal address', 'military uniform', 'stern expression', 'patriotic colours', 'crown', 'God Save the King', 'direct eye contact', 'duty to King and country'],
      reliability: ['government propaganda', 'one-sided', 'not balanced view', 'designed to persuade not inform', 'does not show reality of war', 'emotional manipulation', 'does not represent anti-war views', 'useful for showing government messaging', 'biased by design'],
      utility: ['shows government efforts to recruit', 'suggests public needed persuading', 'evidence of propaganda techniques', 'cannot tell us if people actually supported war', 'only shows official view', 'useful for understanding how government tried to build support', 'limited because it is propaganda']
    }
  },
  {
    id: 'B',
    title: 'Source B: WW2 Evacuee Diary',
    type: 'Personal Diary Extract',
    date: '3rd September 1939',
    author: 'Margaret Wilkinson, aged 11',
    origin: 'Written in a school exercise book in Shropshire, England. Margaret was evacuated from Birmingham. Now held in the Imperial War Museum archives.',
    isVisual: false,
    textContent: `3rd September 1939

Dear Diary,

Today has been the most frightful day of my whole life. Mum woke us before dawn and we had to put on our best clothes even though it was still dark outside. She pinned the brown label to my coat with my name and school on it, and I felt like a parcel being posted somewhere.

At the station there were hundreds of us, all with our gas masks in cardboard boxes bumping against our legs. Some of the little ones were crying something awful but I told myself I would be brave for Mum's sake. She squeezed my hand so tight it hurt and said "Be good, Maggie, and mind your manners." Her eyes were all red but she didn't cry, not in front of us.

The train journey took forever and we didn't know where we were going. Billy Potts was sick twice because of the swaying. When we finally arrived at the village hall, the local people came and picked children like choosing apples at a market. A thin woman in a green hat looked at me and my brother and said "I'll take the girl but not the boy \u2014 I've no room for two." I held Tommy's hand and said we came together and must stay together. She tutted and walked away.

Finally a farmer's wife called Mrs. Davies took us both. She seems kind enough but the house smells of sheep and there is no indoor lavatory. Tommy cried himself to sleep. I did not cry. But I am writing this under the blankets by torchlight and I do not think I shall sleep tonight.

I wonder if Mum is looking at the same moon.`,
    modelAnswers: {
      nature: ['diary entry', 'personal account', 'private writing', 'primary source', 'first-hand account', 'written by a child', 'exercise book'],
      origin: ['3 September 1939', 'Margaret Wilkinson', 'aged 11', 'child evacuee', 'Shropshire', 'evacuated from Birmingham', 'Imperial War Museum', 'day war broke out', 'start of WW2'],
      purpose: ['personal record', 'private diary', 'not written for audience', 'express feelings', 'cope with experience', 'record events of the day', 'not intended to be published'],
      content_analysis: ['labelling of children', 'gas masks', 'separation from mother', 'children chosen like goods', 'siblings separated', 'billeting process', 'emotional distress', 'culture shock', 'rural life different from city', 'no indoor lavatory', 'crying', 'trying to be brave', 'journey into unknown'],
      reliability: ['first-hand account', 'written on the day', 'genuine emotions', 'child perspective', 'private not public', 'may exaggerate', 'limited understanding', 'subjective', 'one person experience', 'not representative of all evacuees', 'unfiltered by censorship', 'honest because private'],
      utility: ['shows personal impact on ordinary people', 'evidence of evacuation experience', 'emotional reality', 'limited to one perspective', 'cannot generalise from one diary', 'very useful for understanding children experience', 'shows how political events affected families', 'answers enquiry question directly']
    }
  },
  {
    id: 'C',
    title: 'Source C: NHS Formation Report',
    type: 'Government Report Extract',
    date: 'July 1948',
    author: 'Ministry of Health',
    origin: 'Official government White Paper published by HMSO (His Majesty\'s Stationery Office), London. Written by civil servants in the Ministry of Health under Aneurin Bevan.',
    isVisual: false,
    textContent: `MINISTRY OF HEALTH

Report on the Establishment of the National Health Service
July 5th, 1948

SUMMARY OF PROVISIONS

1. From the appointed day, every man, woman and child in this country may use the National Health Service without charge. No insurance qualifications are needed. The Service is available to all, regardless of means, age, sex, or occupation. It is not a charity. You are all entitled to it.

2. The Service provides: hospital treatment, specialist services, the services of a family doctor, dental and ophthalmic treatment, drugs and medicines, midwifery, health visiting, home nursing, and ambulance services.

3. Prior to this Act, it is noted that an estimated 50% of the population had no regular access to medical care. Hospital treatment was frequently beyond the means of working families. Mothers and children were particularly ill-served. Many workers relied upon inadequate "panel" arrangements which did not cover their dependents.

4. The cost shall be met principally from general taxation and National Insurance contributions. No direct charge shall be made to the patient at the point of use, save for certain exceptions which may be determined hereafter.

5. It is the expectation of this Ministry that the establishment of a comprehensive health service, free at the point of delivery, shall result in a healthier and more productive nation. The burden of ill-health has for too long fallen most heavily upon those least able to bear it.

6. All hospitals, both voluntary and municipal, shall be brought under the administration of Regional Hospital Boards, thereby creating a unified national system where none existed before.

APPROVED: Aneurin Bevan, Minister of Health`,
    modelAnswers: {
      nature: ['government report', 'official document', 'White Paper', 'ministry publication', 'formal report', 'policy document', 'legal document'],
      origin: ['July 1948', 'Ministry of Health', 'HMSO', 'civil servants', 'Aneurin Bevan', 'government publication', 'London', 'Labour government'],
      purpose: ['explain NHS to public', 'inform about new service', 'justify the policy', 'set out provisions', 'announce entitlements', 'government communication', 'promote the NHS'],
      content_analysis: ['free healthcare for all', 'no charge', 'no insurance needed', 'universal service', '50% had no access before', 'hospitals dental drugs', 'paid from taxation', 'working families couldn\'t afford', 'mothers and children ill-served', 'unified hospital system', 'free at point of delivery'],
      reliability: ['official government source', 'factual in many ways', 'but also promotional', 'likely to present NHS positively', 'government justifying own policy', 'statistics may be selected', 'does not mention opposition', 'formal language suggests authority', 'approved by Bevan who championed NHS'],
      utility: ['very useful for understanding NHS creation', 'shows what government provided', 'shows problems before NHS', 'official perspective', 'does not show opposition from doctors', 'limited because one-sided', 'useful for showing impact on ordinary people', 'shows how government tried to help', 'directly relevant to enquiry']
    }
  },
  {
    id: 'D',
    title: 'Source D: Suffragette Newspaper Article',
    type: 'Newspaper Article',
    date: '19th June 1913',
    author: 'The Daily Herald (sympathetic to the suffragette cause)',
    origin: 'Published in The Daily Herald, a left-leaning British newspaper, London. Reporting on the death of Emily Davison at the Epsom Derby, 4th June 1913.',
    isVisual: false,
    textContent: `THE DAILY HERALD
Thursday, 19th June 1913

THE GLORIOUS MARTYR OF EPSOM
Funeral Procession Honours the Sacrifice of Miss Emily Wilding Davison

Yesterday the streets of London witnessed a sight that no person present shall ever forget. The funeral procession of Miss Emily Wilding Davison, who gave her life for the cause of Women's Suffrage at the Epsom Derby on the 4th of June, passed through the capital in a display of solemn and magnificent tribute.

Thousands upon thousands of women, dressed in the colours of the Women's Social and Political Union \u2014 purple for dignity, white for purity, and green for hope \u2014 marched in disciplined ranks through streets lined with silent onlookers. Many a hardened gentleman was observed to remove his hat in respect.

Miss Davison, a graduate of London University and a woman of exceptional courage and intellect, stepped before the King's horse Anmer at Tattenham Corner. Whether she intended to seize the bridle or to make the ultimate sacrifice remains a matter of debate, but none can doubt the extraordinary bravery of her act.

The procession was led by a young girl bearing a cross draped in purple cloth, followed by hundreds carrying wreaths of white flowers. The coffin, borne on an open carriage, was covered in a purple pall embroidered with silver arrows \u2014 the symbol adopted by those brave women who have endured imprisonment and forcible feeding for the cause.

We say plainly: no Government that calls itself just can continue to deny the franchise to one half of its citizens. Miss Davison's blood calls out for justice. How many more must suffer before this monstrous wrong is put right?

Let her epitaph read: "Deeds Not Words."`,
    modelAnswers: {
      nature: ['newspaper article', 'press report', 'journalism', 'printed media', 'published article', 'news report', 'sympathetic newspaper'],
      origin: ['19 June 1913', 'Daily Herald', 'London', 'left-leaning newspaper', 'sympathetic to suffragettes', 'reporting on Emily Davison funeral', 'two weeks after Derby'],
      purpose: ['report on funeral', 'honour Emily Davison', 'promote suffragette cause', 'persuade readers', 'build sympathy', 'criticise government', 'call for women\'s suffrage', 'shape public opinion'],
      content_analysis: ['funeral procession', 'thousands of women', 'WSPU colours', 'purple white green', 'Emily Davison', 'Epsom Derby', 'King\'s horse', 'London University graduate', 'bravery', 'imprisonment', 'forcible feeding', 'Deeds Not Words', 'silver arrows', 'men removing hats', 'solemn tribute'],
      reliability: ['biased in favour of suffragettes', 'sympathetic newspaper', 'emotionally charged language', 'calls her martyr and glorious', 'one-sided', 'does not give anti-suffrage view', 'but provides eyewitness detail', 'useful despite bias', 'reflects how some people viewed events', 'language reveals agenda'],
      utility: ['shows impact of suffragette actions', 'evidence of public reaction', 'shows how media shaped opinion', 'limited by bias', 'useful for understanding suffragette perspective', 'shows political events affecting lives', 'not representative of all newspapers', 'useful for showing divided opinion']
    }
  },
  {
    id: 'E',
    title: 'Source E: Tudor Political Cartoon',
    type: 'Political Cartoon (Woodcut Print)',
    date: 'c. 1534',
    author: 'Unknown artist, believed to be commissioned by supporters of King Henry VIII',
    origin: 'Woodcut print circulated as a pamphlet in London and the South East of England during the English Reformation. Now held in the British Library.',
    isVisual: true,
    visualContent: {
      asciiArt:
`      ________________________________
     |                                |
     |    [LEFT SIDE]    [RIGHT SIDE] |
     |                                |
     |    KING HENRY     THE POPE     |
     |    enthroned,     depicted     |
     |    crowned with   as small,    |
     |    majesty,       crouching,   |
     |    holding the    tangled in   |
     |    Bible in       chains and   |
     |    English,       serpents,    |
     |    light rays     darkness     |
     |    behind him.    surrounds    |
     |                   him.         |
     |    English        Latin text   |
     |    clergy kneel   is shown as  |
     |    obediently.    broken and   |
     |                   crumbling.   |
     |    "TRUTH"        "TYRANNY"    |
     |________________________________|`,
      posterText: 'THE KING SUPREME HEAD',
      posterSubtext: 'Of the Church of England, by Act of Parliament, Anno 1534',
      description: 'This woodcut print is divided into two contrasting halves. On the left, King Henry VIII sits enthroned in majesty, wearing the crown and royal robes, holding an English-language Bible aloft. Rays of light emanate from behind him, suggesting divine approval. Below him, English bishops and clergy kneel in orderly submission. The word "TRUTH" is carved into a banner above. On the right, the Pope is depicted as a small, grotesque figure cowering on a crumbling throne. He is entangled in chains and serpents, symbols of deceit and corruption. Monks surround him hoarding gold coins. The word "TYRANNY" appears above in fractured lettering. Latin text crumbles into dust. The overall message is stark: Henry represents God\'s true authority, light, and the English language; the Pope represents foreign corruption, darkness, and oppression. The woodcut would have been distributed as a cheap pamphlet to literate townspeople and read aloud in marketplaces.'
    },
    textContent: '[This is a visual source \u2014 see the cartoon display above. For annotation, consider the following textual and visual elements:]\n\nMain text: "THE KING SUPREME HEAD \u2014 Of the Church of England, by Act of Parliament, Anno 1534"\nBanners: "TRUTH" (above Henry) / "TYRANNY" (above the Pope)\n\nLeft side \u2014 Henry VIII: Enthroned in majesty. Crowned and robed. Holding an English Bible aloft. Rays of divine light behind him. English clergy kneel in orderly obedience below. Clean, bright imagery. Association with God, truth, and the English language.\n\nRight side \u2014 The Pope: Small, grotesque, crouching figure. Sitting on a crumbling throne. Entangled in chains and serpents (symbols of deceit). Surrounded by monks hoarding gold coins. Latin text shown as broken and crumbling. Dark, chaotic imagery. Association with corruption, greed, foreign tyranny.\n\nThe cartoon presents a stark black-and-white contrast between English royal authority (good) and Papal authority (evil). It was designed to be understood even by those who could not read, through its powerful visual symbolism. Distributed as a cheap printed pamphlet in towns and read aloud in public places.',
    modelAnswers: {
      nature: ['political cartoon', 'woodcut print', 'pamphlet', 'propaganda', 'visual source', 'printed image', 'Tudor woodcut'],
      origin: ['c.1534', 'unknown artist', 'supporters of Henry VIII', 'English Reformation', 'London', 'British Library', 'Act of Supremacy period', 'circulated as pamphlet'],
      purpose: ['support Henry VIII', 'attack the Pope', 'justify the Reformation', 'propaganda for royal supremacy', 'persuade public to support break with Rome', 'demonise Catholic Church', 'legitimise Act of Supremacy'],
      content_analysis: ['Henry shown as majestic', 'Pope shown as grotesque', 'contrast between truth and tyranny', 'English Bible', 'divine light', 'serpents and chains', 'monks hoarding gold', 'crumbling Latin', 'obedient clergy', 'good vs evil', 'visual propaganda'],
      reliability: ['extremely biased', 'one-sided propaganda', 'commissioned by Henry\'s supporters', 'demonises opposition', 'no balanced view', 'designed to manipulate', 'historically useful for understanding propaganda', 'cannot trust as factual account', 'tells us about attitudes not facts'],
      utility: ['shows how political events were presented to public', 'evidence of propaganda techniques', 'shows government trying to control opinion', 'limited because extremely biased', 'useful for understanding Reformation', 'shows how ordinary people were targeted', 'relevant to enquiry about political impact']
    }
  }
];

// ============================================================
// STATE
// ============================================================
let currentSourceIndex = 0;
let annotations = {}; // { sourceId: [ {text, tag, id} ] }
let scaffoldData = {}; // { sourceId: { sectionId: text } }

sources.forEach(s => {
  annotations[s.id] = [];
  scaffoldData[s.id] = {};
  SCAFFOLD_SECTIONS.forEach(sec => {
    scaffoldData[s.id][sec.id] = '';
  });
});

// ============================================================
// RENDER FUNCTIONS
// ============================================================
function renderTabs() {
  const container = document.getElementById('sourceTabs');
  container.innerHTML = sources.map((s, i) => `
    <button class="source-tab ${i === currentSourceIndex ? 'active' : ''}" onclick="switchSource(${i})">
      Source ${s.id}
      <span class="tab-type">${s.type}</span>
    </button>
  `).join('');
}

function renderSource() {
  const s = sources[currentSourceIndex];

  // Header
  const header = document.getElementById('sourceHeader');
  header.innerHTML = `
    <div class="source-title-area">
      <h2>${s.title}</h2>
      <span class="source-type-badge">${s.type}</span>
    </div>
    <div class="source-metadata">
      <div class="meta-item"><strong>Date</strong>${s.date}</div>
      <div class="meta-item"><strong>Author</strong>${s.author}</div>
      <div class="meta-item"><strong>Origin</strong>${s.origin}</div>
    </div>
  `;

  // Body
  const body = document.getElementById('sourceBody');
  let html = '';

  if (s.isVisual) {
    html += `<div class="visual-source">
      <div class="poster-frame">
        <pre class="ascii-art">${s.visualContent.asciiArt}</pre>
        <div class="poster-text">${s.visualContent.posterText}</div>
        <div class="poster-subtext">${s.visualContent.posterSubtext}</div>
      </div>
      <div class="visual-desc">${s.visualContent.description}</div>
    </div>
    <div style="height:20px"></div>`;
  }

  // Render text content with highlights
  html += `<div class="source-text source-text-lined" id="sourceText">${applyHighlights(s.id, s.textContent)}</div>`;
  body.innerHTML = html;

  renderAnnotations();
}

function applyHighlights(sourceId, text) {
  const anns = annotations[sourceId];
  if (!anns || anns.length === 0) return escapeHtml(text);

  // Build a list of highlight ranges
  let segments = [];
  let lowerText = text.toLowerCase();

  // Sort annotations by position (first occurrence)
  let annotated = anns.map(a => {
    let idx = lowerText.indexOf(a.text.toLowerCase());
    return { ...a, startIdx: idx };
  }).filter(a => a.startIdx >= 0).sort((a, b) => a.startIdx - b.startIdx);

  let result = '';
  let pos = 0;

  annotated.forEach(a => {
    let start = a.startIdx;
    let end = start + a.text.length;
    if (start < pos) return; // overlap, skip

    result += escapeHtml(text.substring(pos, start));
    result += `<span class="highlight-${a.tag}" title="${TAG_CATEGORIES.find(t=>t.id===a.tag).label}: ${escapeHtml(a.text).substring(0,50)}...">${escapeHtml(text.substring(start, end))}</span>`;
    pos = end;
  });

  result += escapeHtml(text.substring(pos));
  return result;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function renderAnnotations() {
  const s = sources[currentSourceIndex];
  const list = document.getElementById('annotationList');
  const anns = annotations[s.id];

  if (anns.length === 0) {
    list.innerHTML = '<div class="ann-empty">No annotations yet. Select text above to begin your analysis.</div>';
    return;
  }

  list.innerHTML = anns.map((a, i) => {
    const cat = TAG_CATEGORIES.find(t => t.id === a.tag);
    return `<div class="annotation-item" style="border-left-color: ${cat.color}">
      <span class="ann-tag" style="background: ${cat.color}">${cat.label}</span>
      <span class="ann-text">"${escapeHtml(a.text.length > 80 ? a.text.substring(0, 80) + '...' : a.text)}"</span>
      <button class="ann-remove" onclick="removeAnnotation(${i})" title="Remove annotation">&times;</button>
    </div>`;
  }).join('');
}

function renderScaffold() {
  const s = sources[currentSourceIndex];
  const body = document.getElementById('scaffoldBody');

  body.innerHTML = SCAFFOLD_SECTIONS.map(sec => {
    const val = scaffoldData[s.id][sec.id] || '';
    return `<div class="scaffold-section">
      <div class="scaffold-section-header">
        <h4>${sec.title}</h4>
        <div class="section-status ${val.trim().length > 10 ? 'filled' : ''}"></div>
      </div>
      <div class="scaffold-prompt">${sec.prompt}</div>
      <textarea
        placeholder="${sec.placeholder}"
        data-section="${sec.id}"
        oninput="updateScaffold(this)"
      >${val}</textarea>
    </div>`;
  }).join('');

  renderProgressDots();
}

function renderProgressDots() {
  const s = sources[currentSourceIndex];
  const dots = document.getElementById('progressDots');
  dots.innerHTML = SCAFFOLD_SECTIONS.map(sec => {
    const filled = (scaffoldData[s.id][sec.id] || '').trim().length > 10;
    return `<div class="progress-dot ${filled ? 'filled' : ''}" title="${sec.title}"></div>`;
  }).join('');
}

// ============================================================
// INTERACTIONS
// ============================================================
function switchSource(index) {
  currentSourceIndex = index;
  renderTabs();
  renderSource();
  renderScaffold();
}

function updateScaffold(textarea) {
  const s = sources[currentSourceIndex];
  const sectionId = textarea.dataset.section;
  scaffoldData[s.id][sectionId] = textarea.value;
  // Update status dot
  const section = textarea.closest('.scaffold-section');
  const dot = section.querySelector('.section-status');
  dot.classList.toggle('filled', textarea.value.trim().length > 10);
  renderProgressDots();
}

function removeAnnotation(index) {
  const s = sources[currentSourceIndex];
  annotations[s.id].splice(index, 1);
  renderSource();
}

// Tag menu
function showTagMenu(x, y, selectedText) {
  const menu = document.getElementById('tagMenu');
  // Build tag options
  let optionsHtml = '<div class="tag-menu-title">Annotate Selection</div>';
  TAG_CATEGORIES.forEach(cat => {
    optionsHtml += `<button class="tag-option" onclick="applyTag('${cat.id}')">
      <div class="tag-color-dot" style="background: ${cat.color}"></div>
      <div>
        <div class="tag-option-label">${cat.label}</div>
        <div class="tag-option-desc">${cat.desc}</div>
      </div>
    </button>`;
  });
  menu.innerHTML = optionsHtml;

  // Position
  const rect = document.querySelector('.source-panel').getBoundingClientRect();
  let left = x - rect.left;
  let top = y - rect.top;

  // Ensure menu stays in viewport
  menu.style.left = Math.min(left, rect.width - 240) + 'px';
  menu.style.top = top + 'px';
  menu.classList.add('visible');
  menu._selectedText = selectedText;
}

function hideTagMenu() {
  document.getElementById('tagMenu').classList.remove('visible');
}

function applyTag(tagId) {
  const menu = document.getElementById('tagMenu');
  const text = menu._selectedText;
  if (!text) return;

  const s = sources[currentSourceIndex];
  annotations[s.id].push({
    text: text,
    tag: tagId,
    id: Date.now()
  });

  hideTagMenu();
  window.getSelection().removeAllRanges();
  renderSource();
}

// Listen for text selection on source panel
document.addEventListener('mouseup', function(e) {
  const sourceText = document.getElementById('sourceText');
  const visualDesc = document.querySelector('.visual-desc');
  const sourcePanel = document.querySelector('.source-panel');

  if (!sourcePanel) return;

  // Check if click is on tag menu
  if (document.getElementById('tagMenu').contains(e.target)) return;

  const sel = window.getSelection();
  const selectedText = sel.toString().trim();

  if (selectedText.length > 2 && sourcePanel.contains(sel.anchorNode)) {
    showTagMenu(e.pageX, e.pageY, selectedText);
  } else {
    hideTagMenu();
  }
});

// ============================================================
// ANALYSIS CHECKING
// ============================================================
function checkAnalysis() {
  const s = sources[currentSourceIndex];
  const answers = s.modelAnswers;
  const studentData = scaffoldData[s.id];
  const studentAnnotations = annotations[s.id];

  let categoryResults = [];
  let totalScore = 0;
  let totalMax = 0;

  SCAFFOLD_SECTIONS.forEach(sec => {
    const modelKey = sec.id;
    const keywords = answers[modelKey] || [];
    const studentText = (studentData[sec.id] || '').toLowerCase();

    // Also count annotations of related type
    let annotationText = '';
    const relatedTags = {
      'nature': [],
      'origin': ['provenance'],
      'purpose': ['bias'],
      'content_analysis': ['content'],
      'reliability': ['reliability'],
      'utility': ['utility']
    };

    const relTags = relatedTags[modelKey] || [];
    studentAnnotations.forEach(ann => {
      if (relTags.includes(ann.tag)) {
        annotationText += ' ' + ann.text.toLowerCase();
      }
    });

    const combinedText = studentText + ' ' + annotationText;

    let matched = [];
    let missed = [];

    keywords.forEach(kw => {
      // Check for partial keyword match (handle phrases)
      const kwWords = kw.toLowerCase().split(/\s+/);
      let found = false;

      if (kwWords.length <= 2) {
        // For short keywords, check if any word appears
        found = kwWords.some(w => combinedText.includes(w));
      } else {
        // For phrases, check if at least half the words appear
        const matchCount = kwWords.filter(w => w.length > 3 && combinedText.includes(w)).length;
        const significantWords = kwWords.filter(w => w.length > 3).length;
        found = significantWords > 0 && matchCount >= Math.ceil(significantWords * 0.5);
      }

      if (found) {
        matched.push(kw);
      } else {
        missed.push(kw);
      }
    });

    const pct = keywords.length > 0 ? Math.round((matched.length / keywords.length) * 100) : 0;
    totalScore += matched.length;
    totalMax += keywords.length;

    categoryResults.push({
      section: sec,
      matched,
      missed,
      percentage: pct
    });
  });

  const overallPct = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0;

  // Determine rank
  let rank, rankDesc;
  if (overallPct >= 85) {
    rank = 'Professor';
    rankDesc = 'Outstanding analysis! You demonstrate expert-level source evaluation skills.';
  } else if (overallPct >= 65) {
    rank = 'Historian';
    rankDesc = 'Very strong analysis. You identify most key features and evaluate the source well.';
  } else if (overallPct >= 40) {
    rank = 'Scholar';
    rankDesc = 'Good progress! You have identified several important points. Review the missed areas to strengthen your analysis.';
  } else {
    rank = 'Apprentice';
    rankDesc = 'A solid start. Read through the feedback carefully and try to develop your analysis further using the hints provided.';
  }

  // Build modal
  const modalBody = document.getElementById('modalBody');
  modalBody.innerHTML = `
    <div class="overall-score fade-in">
      <div class="score-number">${overallPct}<span class="score-percent">%</span></div>
      <div class="score-rank">${rank}</div>
      <div class="rank-desc">${rankDesc}</div>
    </div>
    <h3 style="font-family:'Cinzel',serif;color:var(--sepia);margin-bottom:16px;font-size:16px;letter-spacing:1px;">
      Category Breakdown &mdash; Source ${s.id}
    </h3>
    <div class="category-scores">
      ${categoryResults.map((cr, idx) => `
        <div class="cat-score-item fade-in" style="animation-delay:${idx * 0.1}s">
          <div class="cat-score-header" onclick="toggleCatDetail(${idx})">
            <h4>${cr.section.title}</h4>
            <div style="display:flex;align-items:center;gap:12px;">
              <div class="cat-score-bar-bg">
                <div class="cat-score-bar" style="width:${cr.percentage}%;background:${cr.percentage >= 65 ? 'linear-gradient(90deg,#c9a84c,#2e7d32)' : cr.percentage >= 35 ? 'linear-gradient(90deg,#c9a84c,#e65100)' : 'linear-gradient(90deg,#c9a84c,#8b1a1a)'}"></div>
              </div>
              <div class="cat-score-pct">${cr.percentage}%</div>
            </div>
          </div>
          <div class="cat-score-detail" id="catDetail${idx}">
            ${cr.matched.length > 0 ? `
              <div style="margin-bottom:8px;font-family:'Cinzel',serif;font-size:11px;color:var(--tag-content);text-transform:uppercase;letter-spacing:1px;">Points Identified</div>
              ${cr.matched.map(m => `
                <div class="key-point matched">
                  <span class="kp-label found">Found</span>
                  <span>${escapeHtml(m)}</span>
                </div>
              `).join('')}
            ` : ''}
            ${cr.missed.length > 0 ? `
              <div style="margin:${cr.matched.length > 0 ? '12px' : '0'} 0 8px;font-family:'Cinzel',serif;font-size:11px;color:var(--tag-bias);text-transform:uppercase;letter-spacing:1px;">Points to Consider</div>
              ${cr.missed.map(m => `
                <div class="key-point missed">
                  <span class="kp-label missed">Missed</span>
                  <span>${escapeHtml(m)}</span>
                </div>
              `).join('')}
            ` : ''}
          </div>
        </div>
      `).join('')}
    </div>
    <div style="margin-top:24px;padding:16px;background:rgba(201,168,76,0.1);border-radius:8px;border:1px solid rgba(201,168,76,0.3);">
      <div style="font-family:'Cinzel',serif;font-size:12px;color:var(--gold);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">Next Steps</div>
      <p style="font-family:'Crimson Text',serif;font-size:15px;color:var(--ink-brown);line-height:1.6;">
        ${overallPct >= 85 ? 'Excellent work! Try applying this same level of analysis to the other sources. Consider how the sources relate to each other and how they collectively help answer the enquiry question.' :
          overallPct >= 65 ? 'Strong analysis. Look at the points you missed and consider how they would strengthen your evaluation. Try to be more specific in your comments about reliability and utility.' :
          overallPct >= 40 ? 'You are on the right track. Focus on developing your answers with more specific detail. For each point, try to explain WHY or give an example. Think carefully about the purpose and audience of the source.' :
          'Start by reading the source carefully. Ask yourself: Who wrote this? When? Why? What does it tell us? Then think about whether you can trust it and how useful it is for the enquiry question. Use the annotation tool to mark key features.'}
      </p>
    </div>
  `;

  document.getElementById('resultsModal').classList.add('visible');
}

function toggleCatDetail(idx) {
  const el = document.getElementById('catDetail' + idx);
  el.classList.toggle('open');
}

function closeModal() {
  document.getElementById('resultsModal').classList.remove('visible');
}

// Close modal on overlay click
document.getElementById('resultsModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// Close modal on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
    hideTagMenu();
  }
});

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
function clearAllWork() {
  if (!confirm('Are you sure you want to clear all annotations and analysis notes for this source? This cannot be undone.')) return;
  const s = sources[currentSourceIndex];
  annotations[s.id] = [];
  SCAFFOLD_SECTIONS.forEach(sec => {
    scaffoldData[s.id][sec.id] = '';
  });
  renderSource();
  renderScaffold();
}

function exportWork() {
  const s = sources[currentSourceIndex];
  let text = `SOURCE ANALYSIS WORKBENCH - EXPORT\n`;
  text += `${'='.repeat(50)}\n\n`;
  text += `Source: ${s.title}\n`;
  text += `Type: ${s.type}\n`;
  text += `Date: ${s.date}\n`;
  text += `Author: ${s.author}\n`;
  text += `Origin: ${s.origin}\n\n`;

  text += `ANNOTATIONS\n${'-'.repeat(30)}\n`;
  const anns = annotations[s.id];
  if (anns.length === 0) {
    text += 'No annotations made.\n';
  } else {
    anns.forEach(a => {
      const cat = TAG_CATEGORIES.find(t => t.id === a.tag);
      text += `[${cat.label}] "${a.text}"\n`;
    });
  }

  text += `\nANALYSIS SCAFFOLD\n${'-'.repeat(30)}\n`;
  SCAFFOLD_SECTIONS.forEach(sec => {
    const val = scaffoldData[s.id][sec.id] || '(not completed)';
    text += `\n${sec.title.toUpperCase()}:\n${val}\n`;
  });

  // Download as file
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `source-analysis-${s.id}-${new Date().toISOString().slice(0,10)}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ============================================================
// INIT
// ============================================================
function init() {
  renderTabs();
  renderSource();
  renderScaffold();

  // Build tag menu options
  const menu = document.getElementById('tagMenu');
  let optionsHtml = '<div class="tag-menu-title">Annotate Selection</div>';
  TAG_CATEGORIES.forEach(cat => {
    optionsHtml += `<button class="tag-option" onclick="applyTag('${cat.id}')">
      <div class="tag-color-dot" style="background: ${cat.color}"></div>
      <div>
        <div class="tag-option-label">${cat.label}</div>
        <div class="tag-option-desc">${cat.desc}</div>
      </div>
    </button>`;
  });
  menu.innerHTML = optionsHtml;
}

init();
</script>
</body>
</html>
