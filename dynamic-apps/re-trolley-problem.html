<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trolley Problem Variations</title>
<style>
:root {
  --pink-50: #fdf2f8;
  --pink-100: #fce7f3;
  --pink-200: #fbcfe8;
  --pink-300: #f9a8d4;
  --pink-400: #f472b6;
  --pink-500: #ec4899;
  --pink-600: #db2777;
  --pink-700: #be185d;
  --pink-800: #9d174d;
  --pink-900: #831843;
  --magenta-500: #d946ef;
  --magenta-600: #c026d3;
  --magenta-700: #a21caf;
  --slate-50: #f8fafc;
  --slate-100: #f1f5f9;
  --slate-200: #e2e8f0;
  --slate-300: #cbd5e1;
  --slate-600: #475569;
  --slate-700: #334155;
  --slate-800: #1e293b;
  --slate-900: #0f172a;
  --radius: 10px;
  --shadow: 0 4px 20px rgba(219,39,119,0.12);
  --shadow-lg: 0 8px 30px rgba(219,39,119,0.18);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--pink-50);
  color: var(--slate-800);
  line-height: 1.6;
  min-height: 100vh;
}

header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(135deg, var(--pink-700), var(--magenta-600));
  color: white;
  padding: 14px 24px;
  box-shadow: var(--shadow-lg);
}

.header-inner {
  max-width: 1100px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 8px;
}

header h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
header h1 span { opacity: 0.85; font-weight: 400; font-size: 0.85rem; margin-left: 8px; }

.progress-bar {
  display: flex;
  gap: 6px;
  align-items: center;
}

.progress-dot {
  width: 12px; height: 12px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transition: all 0.3s;
  cursor: pointer;
}

.progress-dot.completed { background: rgba(255,255,255,0.7); }
.progress-dot.active { background: white; transform: scale(1.3); box-shadow: 0 0 8px rgba(255,255,255,0.5); }

.header-btns { display: flex; gap: 8px; }

.btn-header {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-header:hover { background: rgba(255,255,255,0.35); }

main {
  max-width: 1100px;
  margin: 0 auto;
  padding: 24px 16px 60px;
}

/* Intro / Welcome screen */
.screen { display: none; }
.screen.active { display: block; }

.intro-card {
  background: white;
  border-radius: var(--radius);
  padding: 40px 32px;
  box-shadow: var(--shadow);
  text-align: center;
  max-width: 720px;
  margin: 0 auto;
}

.intro-card h2 { font-size: 1.8rem; color: var(--pink-700); margin-bottom: 12px; }
.intro-card p { color: var(--slate-600); margin-bottom: 20px; font-size: 1.05rem; }

.btn-primary {
  display: inline-block;
  background: linear-gradient(135deg, var(--pink-600), var(--magenta-600));
  color: white;
  border: none;
  padding: 12px 32px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s;
  box-shadow: 0 4px 14px rgba(219,39,119,0.3);
}

.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(219,39,119,0.4); }

/* Scenario screen */
.scenario-layout {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

.scenario-header {
  background: white;
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
}

.scenario-header h2 { color: var(--pink-700); font-size: 1.4rem; margin-bottom: 4px; }
.scenario-number { font-size: 0.8rem; color: var(--magenta-600); font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }
.scenario-desc { color: var(--slate-600); margin-top: 10px; }

.canvas-wrap {
  background: white;
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  text-align: center;
}

canvas#sceneCanvas {
  width: 100%;
  max-width: 700px;
  border-radius: 8px;
  background: var(--slate-100);
}

.decision-panel {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn-decision {
  flex: 1;
  min-width: 200px;
  max-width: 340px;
  padding: 18px 20px;
  border-radius: var(--radius);
  border: 2px solid var(--pink-300);
  background: white;
  cursor: pointer;
  transition: all 0.25s;
  text-align: left;
}

.btn-decision:hover { border-color: var(--pink-500); background: var(--pink-50); transform: translateY(-2px); box-shadow: var(--shadow); }
.btn-decision h4 { color: var(--pink-700); margin-bottom: 4px; font-size: 1rem; }
.btn-decision p { color: var(--slate-600); font-size: 0.85rem; line-height: 1.4; }

.btn-decision.chosen-a { border-color: var(--pink-600); background: var(--pink-100); }
.btn-decision.chosen-b { border-color: var(--magenta-600); background: #faf0ff; }

/* Framework panel */
.framework-panel {
  display: none;
  background: white;
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-top: 8px;
}

.framework-panel.visible { display: block; animation: fadeSlide 0.4s ease; }

@keyframes fadeSlide { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

.framework-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 14px;
  margin-top: 16px;
}

.framework-card {
  padding: 16px;
  border-radius: 8px;
  border-left: 4px solid;
}

.framework-card.util { background: #fef3c7; border-color: #f59e0b; }
.framework-card.deont { background: #dbeafe; border-color: #3b82f6; }
.framework-card.virtue { background: #d1fae5; border-color: #10b981; }
.framework-card.situation { background: #fce7f3; border-color: var(--pink-500); }

.framework-card h4 { font-size: 0.9rem; margin-bottom: 6px; }
.framework-card p { font-size: 0.82rem; color: var(--slate-700); line-height: 1.45; }

.fw-verdict { font-weight: 600; display: inline-block; margin-top: 6px; font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; }
.fw-verdict.for { background: #bbf7d0; color: #166534; }
.fw-verdict.against { background: #fecaca; color: #991b1b; }
.fw-verdict.mixed { background: #fef08a; color: #854d0e; }

.btn-next {
  display: inline-block;
  margin-top: 20px;
  background: linear-gradient(135deg, var(--pink-600), var(--magenta-600));
  color: white;
  border: none;
  padding: 10px 28px;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-next:hover { transform: translateY(-1px); }

/* Tally bar */
.tally-bar {
  background: white;
  border-radius: var(--radius);
  padding: 16px 20px;
  box-shadow: var(--shadow);
  margin-top: 20px;
}

.tally-bar h3 { font-size: 0.9rem; color: var(--slate-700); margin-bottom: 10px; }

.tally-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}

.tally-label { width: 90px; font-size: 0.78rem; font-weight: 600; color: var(--slate-600); text-align: right; }

.tally-track {
  flex: 1;
  height: 10px;
  background: var(--slate-100);
  border-radius: 5px;
  overflow: hidden;
}

.tally-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 0.5s ease;
}

.tally-fill.util { background: #f59e0b; }
.tally-fill.deont { background: #3b82f6; }
.tally-fill.virtue { background: #10b981; }
.tally-fill.situation { background: var(--pink-500); }

.tally-count { width: 20px; font-size: 0.78rem; color: var(--slate-600); }

/* Results screen */
.results-card {
  background: white;
  border-radius: var(--radius);
  padding: 32px;
  box-shadow: var(--shadow);
  max-width: 800px;
  margin: 0 auto;
}

.results-card h2 { color: var(--pink-700); font-size: 1.6rem; text-align: center; margin-bottom: 6px; }

.profile-badge {
  text-align: center;
  margin: 20px 0;
  padding: 20px;
  background: linear-gradient(135deg, var(--pink-100), #f3e8ff);
  border-radius: var(--radius);
}

.profile-badge h3 { font-size: 1.3rem; color: var(--magenta-700); }
.profile-badge p { color: var(--slate-600); margin-top: 6px; font-size: 0.95rem; }

.results-breakdown { margin-top: 24px; }
.results-breakdown h3 { font-size: 1rem; color: var(--slate-700); margin-bottom: 14px; }

.result-scenario {
  padding: 14px 16px;
  border-left: 3px solid var(--pink-300);
  margin-bottom: 10px;
  background: var(--pink-50);
  border-radius: 0 8px 8px 0;
}

.result-scenario strong { color: var(--pink-700); }
.result-scenario span { display: block; font-size: 0.85rem; color: var(--slate-600); margin-top: 2px; }

/* Info panel (overlay) */
.info-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  padding: 40px 16px;
  overflow-y: auto;
}

.info-overlay.open { display: flex; justify-content: center; align-items: flex-start; }

.info-content {
  background: white;
  border-radius: var(--radius);
  padding: 32px;
  max-width: 700px;
  width: 100%;
  box-shadow: var(--shadow-lg);
  position: relative;
}

.info-content h2 { color: var(--pink-700); margin-bottom: 16px; }

.info-content h3 { color: var(--magenta-600); margin-top: 18px; margin-bottom: 6px; font-size: 1.05rem; }
.info-content p { color: var(--slate-600); margin-bottom: 10px; font-size: 0.92rem; }

.btn-close-info {
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--slate-200);
  border: none;
  width: 32px; height: 32px;
  border-radius: 50%;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Branching path mini visual */
.branch-visual {
  text-align: center;
  margin: 12px 0;
  padding: 12px;
  background: var(--slate-50);
  border-radius: 8px;
}

.branch-visual svg { max-width: 320px; width: 100%; }

@media (max-width: 768px) {
  header { padding: 10px 14px; }
  header h1 { font-size: 1.1rem; }
  header h1 span { display: block; margin-left: 0; margin-top: 2px; }
  .intro-card { padding: 28px 20px; }
  .intro-card h2 { font-size: 1.4rem; }
  .scenario-header { padding: 18px; }
  .scenario-header h2 { font-size: 1.2rem; }
  .btn-decision { min-width: 100%; }
  .framework-grid { grid-template-columns: 1fr; }
  .results-card { padding: 22px 16px; }
  .info-content { padding: 24px 18px; }
  .tally-label { width: 70px; font-size: 0.72rem; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <h1>Trolley Problem Variations <span>Ethical Thought Experiments</span></h1>
    <div class="progress-bar" id="progressBar"></div>
    <div class="header-btns">
      <button class="btn-header" onclick="openInfo()">Frameworks</button>
      <button class="btn-header" onclick="resetApp()">Restart</button>
    </div>
  </div>
</header>

<main>
  <!-- INTRO -->
  <div class="screen active" id="screenIntro">
    <div class="intro-card">
      <h2>The Trolley Problem</h2>
      <p>You are about to face six classic ethical dilemmas. Each one presents a variation of the famous trolley problem, forcing you to weigh competing moral principles.</p>
      <p>After each choice, you will see how four major ethical frameworks evaluate your decision. At the end, discover your ethical profile based on your pattern of choices.</p>
      <p style="font-size:0.88rem; color:var(--slate-600); margin-top:16px;">There are no right or wrong answers. The purpose is to explore how we reason about difficult moral questions.</p>
      <br>
      <button class="btn-primary" onclick="startScenarios()">Begin the Dilemmas</button>
    </div>
  </div>

  <!-- SCENARIO -->
  <div class="screen" id="screenScenario">
    <div class="scenario-layout">
      <div class="scenario-header">
        <div class="scenario-number" id="scenarioNumber"></div>
        <h2 id="scenarioTitle"></h2>
        <p class="scenario-desc" id="scenarioDesc"></p>
      </div>

      <div class="canvas-wrap">
        <canvas id="sceneCanvas" width="700" height="340"></canvas>
      </div>

      <div class="branch-visual" id="branchVisual"></div>

      <div class="decision-panel" id="decisionPanel"></div>

      <div class="framework-panel" id="frameworkPanel">
        <h3 style="color:var(--pink-700);">How the Frameworks See Your Choice</h3>
        <div class="framework-grid" id="frameworkGrid"></div>
        <div style="text-align:center;">
          <button class="btn-next" id="btnNext" onclick="nextScenario()">Next Dilemma</button>
        </div>
      </div>

      <div class="tally-bar" id="tallyBar">
        <h3>Your Ethical Leanings So Far</h3>
        <div id="tallyRows"></div>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="screen" id="screenResults">
    <div class="results-card">
      <h2>Your Ethical Profile</h2>
      <div class="profile-badge" id="profileBadge"></div>
      <div class="tally-bar" style="box-shadow:none; padding:0;">
        <h3>Final Scores</h3>
        <div id="finalTally"></div>
      </div>
      <div class="results-breakdown" id="resultsBreakdown">
        <h3>Your Choices</h3>
      </div>
      <div style="text-align:center; margin-top:24px;">
        <button class="btn-primary" onclick="resetApp()">Try Again</button>
      </div>
    </div>
  </div>
</main>

<!-- INFO OVERLAY -->
<div class="info-overlay" id="infoOverlay">
  <div class="info-content">
    <button class="btn-close-info" onclick="closeInfo()">&times;</button>
    <h2>Ethical Frameworks</h2>

    <h3>Utilitarianism (Consequentialism)</h3>
    <p>Founded by Jeremy Bentham and John Stuart Mill. The right action is the one that produces the greatest happiness for the greatest number. It focuses purely on outcomes: if pulling the lever saves more lives, it is the morally correct choice regardless of how it feels.</p>

    <h3>Deontological Ethics (Kantianism)</h3>
    <p>Developed by Immanuel Kant. Morality is about following universal rules and duties, not about outcomes. The key test is the Categorical Imperative: could you will your action to become a universal law? Using someone merely as a means to an end is always wrong, even if the consequences would be better.</p>

    <h3>Virtue Ethics</h3>
    <p>Rooted in Aristotle's philosophy. Rather than asking "what should I do?", it asks "what kind of person should I be?" A virtuous person cultivates character traits like courage, compassion, justice, and practical wisdom. The right action is what a person of good character would do.</p>

    <h3>Situation Ethics</h3>
    <p>Proposed by Joseph Fletcher. The most loving thing to do in each unique situation is the right action. There are no fixed rules; instead, each dilemma must be judged on its own circumstances. The guiding principle is agape (selfless, unconditional love).</p>
  </div>
</div>

<script>
// ---- DATA ----
const scenarios = [
  {
    id: 'classic',
    title: 'The Classic Trolley Problem',
    desc: 'A runaway trolley is hurtling down the track towards five workers who cannot escape. You are standing next to a lever. If you pull it, the trolley will switch to a side track, where one worker is standing. That person will be killed instead.',
    optionA: { label: 'Pull the Lever', detail: 'Divert the trolley to the side track, killing one person to save five.' },
    optionB: { label: 'Do Nothing', detail: 'Allow the trolley to continue, killing five people.' },
    scene: 'classic',
    frameworks: {
      a: {
        util: { verdict: 'for', text: 'Saving five lives at the cost of one maximises overall welfare. The numbers clearly favour pulling the lever.' },
        deont: { verdict: 'mixed', text: 'You are actively choosing to redirect harm, which treats the one person as a means to save others. However, you are not directly using them as a tool.' },
        virtue: { verdict: 'mixed', text: 'Courage suggests acting, but a compassionate person would struggle with deliberately causing a death. Practical wisdom weighs both sides.' },
        situation: { verdict: 'for', text: 'The most loving outcome overall is to save five lives. The context demands action despite its difficulty.' }
      },
      b: {
        util: { verdict: 'against', text: 'Allowing five deaths when you could prevent them fails to maximise welfare. Inaction produces worse consequences.' },
        deont: { verdict: 'mixed', text: 'You are not actively causing harm, which respects the duty not to kill. However, some Kantians would argue you have a duty to prevent avoidable deaths.' },
        virtue: { verdict: 'mixed', text: 'Choosing not to act may show respect for moral boundaries, but could also reflect cowardice or indifference to suffering.' },
        situation: { verdict: 'against', text: 'Failing to act when you could save lives is not the most loving response to the situation.' }
      }
    },
    leanings: { a: { util: 2, situation: 1 }, b: { deont: 2, virtue: 1 } }
  },
  {
    id: 'footbridge',
    title: 'The Footbridge Dilemma',
    desc: 'A trolley is heading towards five people. You are standing on a footbridge above the tracks next to a very large stranger. The only way to stop the trolley is to push this person off the bridge onto the tracks. Their body will stop the trolley, but they will die.',
    optionA: { label: 'Push the Stranger', detail: 'Push the large person off the bridge to stop the trolley and save five lives.' },
    optionB: { label: 'Do Not Push', detail: 'Refuse to push anyone. The trolley kills five people.' },
    scene: 'footbridge',
    frameworks: {
      a: {
        util: { verdict: 'for', text: 'The arithmetic is the same: one death versus five. A strict utilitarian would support this action.' },
        deont: { verdict: 'against', text: 'This directly uses another person as a physical tool to stop the trolley. It clearly violates the principle of never using someone merely as a means.' },
        virtue: { verdict: 'against', text: 'Physically pushing someone to their death is a violent act that most people of good character would find deeply troubling, regardless of the outcome.' },
        situation: { verdict: 'mixed', text: 'The loving thing may be to save five, but the intimate violence of pushing someone introduces a dimension that pure love must weigh carefully.' }
      },
      b: {
        util: { verdict: 'against', text: 'Five deaths instead of one is a worse outcome by utilitarian calculation.' },
        deont: { verdict: 'for', text: 'You respect the absolute dignity of the person beside you. No one should be used as a mere instrument, regardless of the outcome.' },
        virtue: { verdict: 'for', text: 'Refusing to commit an act of personal violence reflects integrity and respect for human dignity, key virtues in character ethics.' },
        situation: { verdict: 'mixed', text: 'Not acting allows greater harm, but the personal nature of the violence makes this a genuinely agonising judgement call.' }
      }
    },
    leanings: { a: { util: 2, situation: 1 }, b: { deont: 2, virtue: 2 } }
  },
  {
    id: 'loop',
    title: 'The Loop Variant',
    desc: 'The trolley is heading for five people. You can divert it onto a side track that loops back to the main track. However, there is a large person on the loop track whose body would stop the trolley before it loops back. Without that person there, the diversion would be pointless.',
    optionA: { label: 'Divert to the Loop', detail: 'Switch the trolley to the loop track, knowing it will be stopped only because it hits the one person.' },
    optionB: { label: 'Do Not Divert', detail: 'Let the trolley continue to the five workers.' },
    scene: 'loop',
    frameworks: {
      a: {
        util: { verdict: 'for', text: 'Five saved for one lost. The outcome is identical to the classic case and is supported on consequentialist grounds.' },
        deont: { verdict: 'against', text: 'The person on the loop is essential to the plan. You are deliberately using their body to stop the trolley, making them a means to your end.' },
        virtue: { verdict: 'mixed', text: 'This sits uncomfortably between the classic and footbridge cases. The intent to use someone as a barrier raises concerns, even through a lever.' },
        situation: { verdict: 'for', text: 'The loving response is to minimise suffering. The mechanism matters less than the outcome in this framework.' }
      },
      b: {
        util: { verdict: 'against', text: 'Allowing five deaths is a worse outcome than one death.' },
        deont: { verdict: 'for', text: 'By not diverting, you avoid deliberately using the person on the loop as a tool. You respect their dignity as an end in themselves.' },
        virtue: { verdict: 'mixed', text: 'Not acting avoids complicity but allows greater suffering. A virtuous person would feel the weight of both options.' },
        situation: { verdict: 'against', text: 'Inaction here lets more people die when a loving, if painful, alternative exists.' }
      }
    },
    leanings: { a: { util: 2, situation: 1 }, b: { deont: 2, virtue: 1 } }
  },
  {
    id: 'organ',
    title: 'The Transplant Surgeon',
    desc: 'You are a surgeon with five patients who will die without organ transplants (each needing a different organ). A healthy visitor comes in for a check-up. You could secretly harvest their organs to save all five patients. No one would ever find out.',
    optionA: { label: 'Harvest the Organs', detail: 'Sacrifice the healthy visitor to save five patients who will otherwise die.' },
    optionB: { label: 'Refuse to Harvest', detail: 'Allow the five patients to die rather than kill an innocent person.' },
    scene: 'organ',
    frameworks: {
      a: {
        util: { verdict: 'mixed', text: 'Simple arithmetic favours this, but rule utilitarians note that a society where doctors kill patients would cause immense fear and destroy trust in medicine.' },
        deont: { verdict: 'against', text: 'This is a textbook violation of the categorical imperative. The visitor is used purely as a means. It could never be willed as a universal law.' },
        virtue: { verdict: 'against', text: 'A virtuous doctor values trust, honesty, and the sanctity of the doctor-patient relationship. This act betrays every medical virtue.' },
        situation: { verdict: 'against', text: 'Even situation ethics, focused on love, would struggle here. The betrayal of trust and the secrecy are deeply unloving acts towards the visitor.' }
      },
      b: {
        util: { verdict: 'mixed', text: 'Five die instead of one, which is worse by numbers. But preserving medical trust prevents countless future deaths from people avoiding hospitals.' },
        deont: { verdict: 'for', text: 'The visitor has an absolute right not to be used as a resource. Respecting their autonomy and dignity is a fundamental duty.' },
        virtue: { verdict: 'for', text: 'Maintaining integrity, trustworthiness, and professional ethics reflects the character of a truly good doctor.' },
        situation: { verdict: 'for', text: 'The most loving thing, considering all relationships and trust, is to not betray the visitor. Love is not just about numbers.' }
      }
    },
    leanings: { a: { util: 1 }, b: { deont: 2, virtue: 2, situation: 1 } }
  },
  {
    id: 'bystander',
    title: 'The Informed Bystander',
    desc: 'You witness a trolley heading for five people. You can shout a warning and one of the five will run onto a side track to flag the driver, but they will certainly be killed by the trolley when it is diverted. The other four will survive because the trolley follows the person who ran.',
    optionA: { label: 'Shout the Warning', detail: 'Alert the group. One person sacrifices themselves voluntarily to save the other four.' },
    optionB: { label: 'Stay Silent', detail: 'Do not intervene. All five face the trolley together.' },
    scene: 'bystander',
    frameworks: {
      a: {
        util: { verdict: 'for', text: 'Four saved is better than zero. The person who runs makes an autonomous choice, improving the utilitarian calculus further.' },
        deont: { verdict: 'for', text: 'The person on the track chooses freely to sacrifice themselves. No one is used as a mere means; their autonomy and dignity are respected.' },
        virtue: { verdict: 'for', text: 'Both the shouter and the volunteer display courage and selflessness. This scenario allows virtue to flourish on all sides.' },
        situation: { verdict: 'for', text: 'Giving someone the chance to make a loving sacrifice, rather than imposing it, is deeply aligned with agape.' }
      },
      b: {
        util: { verdict: 'against', text: 'Five potential deaths versus four saved. Silence produces a worse outcome.' },
        deont: { verdict: 'mixed', text: 'You avoid any causal involvement, but withholding information could itself be seen as a failure of duty to warn.' },
        virtue: { verdict: 'against', text: 'Remaining silent when you could help shows a lack of courage and compassion, both core virtues.' },
        situation: { verdict: 'against', text: 'Silence here is not the loving response. You have information that could save lives.' }
      }
    },
    leanings: { a: { util: 1, deont: 1, virtue: 1, situation: 1 }, b: {} }
  },
  {
    id: 'selfsacrifice',
    title: 'The Self-Sacrifice',
    desc: 'A trolley is heading for five people. You realise that if you jump onto the tracks yourself, your body would be large enough to stop the trolley. You will certainly die, but all five will survive. There is no other option available.',
    optionA: { label: 'Jump onto the Tracks', detail: 'Sacrifice your own life to save five people.' },
    optionB: { label: 'Do Not Jump', detail: 'Preserve your own life. The five people will die.' },
    scene: 'selfsacrifice',
    frameworks: {
      a: {
        util: { verdict: 'for', text: 'Five lives saved for one lost: the utilitarian calculus clearly supports this, and there is no issue of using another person.' },
        deont: { verdict: 'for', text: 'You are choosing to sacrifice yourself, not using another person as a means. Self-sacrifice can be universalised as a moral law without contradiction.' },
        virtue: { verdict: 'for', text: 'This is the ultimate expression of courage and selflessness. Many virtue traditions hold self-sacrifice as the highest moral act.' },
        situation: { verdict: 'for', text: 'Laying down your life for others is the purest form of agape: unconditional, selfless love in action.' }
      },
      b: {
        util: { verdict: 'against', text: 'Five deaths instead of one is a worse outcome. However, some utilitarians would weigh your future contributions to society.' },
        deont: { verdict: 'mixed', text: 'Kant argued we also have duties to ourselves, including self-preservation. Sacrificing yourself may violate your duty to your own rational nature.' },
        virtue: { verdict: 'mixed', text: 'Self-preservation is not cowardice. A virtuous person may consider their obligations to family and others who depend on them.' },
        situation: { verdict: 'mixed', text: 'Love extends to yourself too. Whether jumping is the most loving act depends on your wider web of relationships and responsibilities.' }
      }
    },
    leanings: { a: { util: 1, deont: 1, virtue: 2, situation: 1 }, b: { deont: 1, situation: 1 } }
  }
];

// ---- STATE ----
let currentIdx = -1;
let choices = [];
let tally = { util: 0, deont: 0, virtue: 0, situation: 0 };
let animFrame = null;

// ---- DOM REFS ----
const $ = id => document.getElementById(id);
const screens = { intro: $('screenIntro'), scenario: $('screenScenario'), results: $('screenResults') };

// ---- NAVIGATION ----
function showScreen(name) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[name].classList.add('active');
}

function buildProgressDots() {
  const bar = $('progressBar');
  bar.innerHTML = '';
  scenarios.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = 'progress-dot';
    if (i < currentIdx) dot.classList.add('completed');
    if (i === currentIdx) dot.classList.add('active');
    bar.appendChild(dot);
  });
}

function startScenarios() {
  currentIdx = 0;
  choices = [];
  tally = { util: 0, deont: 0, virtue: 0, situation: 0 };
  loadScenario();
  showScreen('scenario');
}

function loadScenario() {
  const s = scenarios[currentIdx];
  buildProgressDots();
  $('scenarioNumber').textContent = `Dilemma ${currentIdx + 1} of ${scenarios.length}`;
  $('scenarioTitle').textContent = s.title;
  $('scenarioDesc').textContent = s.desc;

  // Decision buttons
  const dp = $('decisionPanel');
  dp.innerHTML = '';
  ['a', 'b'].forEach(key => {
    const opt = key === 'a' ? s.optionA : s.optionB;
    const btn = document.createElement('button');
    btn.className = 'btn-decision';
    btn.innerHTML = `<h4>${opt.label}</h4><p>${opt.detail}</p>`;
    btn.onclick = () => makeChoice(key);
    dp.appendChild(btn);
  });

  // Hide framework panel
  $('frameworkPanel').classList.remove('visible');
  $('btnNext').textContent = currentIdx < scenarios.length - 1 ? 'Next Dilemma' : 'See Your Results';

  // Build branch visual
  buildBranchVisual(s);

  // Draw canvas
  drawScene(s.scene, null);

  // Update tally display
  renderTally($('tallyRows'));

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function makeChoice(key) {
  const s = scenarios[currentIdx];
  choices.push({ scenario: s.id, choice: key, title: s.title, label: key === 'a' ? s.optionA.label : s.optionB.label });

  // Update tally
  const lean = s.leanings[key];
  for (const fw in lean) tally[fw] += lean[fw];

  // Highlight chosen button
  const btns = $('decisionPanel').querySelectorAll('.btn-decision');
  btns.forEach(b => { b.style.pointerEvents = 'none'; b.style.opacity = '0.6'; });
  btns[key === 'a' ? 0 : 1].style.opacity = '1';
  btns[key === 'a' ? 0 : 1].classList.add(key === 'a' ? 'chosen-a' : 'chosen-b');

  // Show frameworks
  const fp = $('frameworkPanel');
  const fg = $('frameworkGrid');
  fg.innerHTML = '';
  const fws = s.frameworks[key];
  const fwNames = { util: 'Utilitarianism', deont: 'Deontological (Kantian)', virtue: 'Virtue Ethics', situation: 'Situation Ethics' };
  const verdictLabels = { for: 'Supports', against: 'Opposes', mixed: 'Mixed' };
  for (const fw in fws) {
    const card = document.createElement('div');
    card.className = `framework-card ${fw}`;
    card.innerHTML = `<h4>${fwNames[fw]}</h4><p>${fws[fw].text}</p><span class="fw-verdict ${fws[fw].verdict}">${verdictLabels[fws[fw].verdict]}</span>`;
    fg.appendChild(card);
  }
  fp.classList.add('visible');

  // Animate canvas
  drawScene(s.scene, key);

  // Update tally
  renderTally($('tallyRows'));

  // Update branch visual
  highlightBranch(key);
}

function nextScenario() {
  currentIdx++;
  if (currentIdx >= scenarios.length) {
    showResults();
  } else {
    loadScenario();
  }
}

function renderTally(container) {
  const maxVal = Math.max(1, ...Object.values(tally));
  const fwNames = { util: 'Utilitarian', deont: 'Kantian', virtue: 'Virtue', situation: 'Situation' };
  container.innerHTML = '';
  for (const fw in tally) {
    const pct = (tally[fw] / maxVal) * 100;
    container.innerHTML += `
      <div class="tally-row">
        <div class="tally-label">${fwNames[fw]}</div>
        <div class="tally-track"><div class="tally-fill ${fw}" style="width:${pct}%"></div></div>
        <div class="tally-count">${tally[fw]}</div>
      </div>`;
  }
}

// ---- RESULTS ----
function showResults() {
  showScreen('results');
  buildProgressDots();

  const sorted = Object.entries(tally).sort((a, b) => b[1] - a[1]);
  const top = sorted[0];
  const profiles = {
    util: { name: 'The Consequentialist', desc: 'You consistently prioritise outcomes and the greater good. You believe the right action is the one that produces the most benefit, even when the means are uncomfortable.' },
    deont: { name: 'The Principled Thinker', desc: 'You follow moral rules and duties regardless of consequences. You believe some actions are inherently right or wrong, and that people must never be treated merely as tools.' },
    virtue: { name: 'The Character-Focused Ethicist', desc: 'You focus on what a person of good character would do. You value integrity, compassion, and courage, and judge actions by the kind of person they reflect.' },
    situation: { name: 'The Contextual Ethicist', desc: 'You judge each situation on its own merits, guided by love and compassion. You resist rigid rules in favour of responding to the unique demands of each moment.' }
  };

  const tied = sorted.filter(s => s[1] === top[1]);
  let profile;
  if (tied.length > 1 && top[1] > 0) {
    profile = { name: 'The Balanced Thinker', desc: 'You draw on multiple ethical traditions rather than favouring one. You weigh rules, outcomes, character, and context, reflecting a nuanced and flexible moral outlook.' };
  } else if (top[1] === 0) {
    profile = { name: 'The Independent Thinker', desc: 'Your choices did not align strongly with any single framework. You may be guided by instinct, personal values, or a moral perspective all your own.' };
  } else {
    profile = profiles[top[0]];
  }

  $('profileBadge').innerHTML = `<h3>${profile.name}</h3><p>${profile.desc}</p>`;
  renderTally($('finalTally'));

  const bd = $('resultsBreakdown');
  bd.innerHTML = '<h3>Your Choices</h3>';
  choices.forEach(c => {
    const div = document.createElement('div');
    div.className = 'result-scenario';
    div.innerHTML = `<strong>${c.title}</strong><span>You chose: ${c.label}</span>`;
    bd.appendChild(div);
  });
}

function resetApp() {
  currentIdx = -1;
  choices = [];
  tally = { util: 0, deont: 0, virtue: 0, situation: 0 };
  $('progressBar').innerHTML = '';
  showScreen('intro');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ---- INFO OVERLAY ----
function openInfo() { $('infoOverlay').classList.add('open'); }
function closeInfo() { $('infoOverlay').classList.remove('open'); }
$('infoOverlay').addEventListener('click', e => { if (e.target === $('infoOverlay')) closeInfo(); });

// ---- BRANCH VISUAL (SVG) ----
function buildBranchVisual(s) {
  const bv = $('branchVisual');
  const aLabel = s.optionA.label;
  const bLabel = s.optionB.label;
  bv.innerHTML = `
    <svg viewBox="0 0 320 120" xmlns="http://www.w3.org/2000/svg">
      <line x1="160" y1="10" x2="160" y2="45" stroke="#cbd5e1" stroke-width="2"/>
      <circle cx="160" cy="50" r="6" fill="#db2777"/>
      <text x="160" y="50" dy="-14" text-anchor="middle" font-size="10" fill="#64748b">Your Choice</text>
      <line x1="160" y1="56" x2="80" y2="90" stroke="#cbd5e1" stroke-width="2" id="branchLineA"/>
      <line x1="160" y1="56" x2="240" y2="90" stroke="#cbd5e1" stroke-width="2" id="branchLineB"/>
      <rect x="20" y="85" width="120" height="28" rx="6" fill="#fce7f3" stroke="#f9a8d4" stroke-width="1" id="branchBoxA"/>
      <text x="80" y="103" text-anchor="middle" font-size="9.5" fill="#9d174d" id="branchTextA">${aLabel}</text>
      <rect x="180" y="85" width="120" height="28" rx="6" fill="#f3e8ff" stroke="#d8b4fe" stroke-width="1" id="branchBoxB"/>
      <text x="240" y="103" text-anchor="middle" font-size="9.5" fill="#7e22ce" id="branchTextB">${bLabel}</text>
    </svg>`;
}

function highlightBranch(key) {
  const bv = $('branchVisual');
  if (key === 'a') {
    const box = bv.querySelector('#branchBoxA');
    const line = bv.querySelector('#branchLineA');
    if (box) { box.setAttribute('fill', '#fbcfe8'); box.setAttribute('stroke', '#db2777'); box.setAttribute('stroke-width', '2.5'); }
    if (line) { line.setAttribute('stroke', '#db2777'); line.setAttribute('stroke-width', '3'); }
  } else {
    const box = bv.querySelector('#branchBoxB');
    const line = bv.querySelector('#branchLineB');
    if (box) { box.setAttribute('fill', '#e9d5ff'); box.setAttribute('stroke', '#a855f7'); box.setAttribute('stroke-width', '2.5'); }
    if (line) { line.setAttribute('stroke', '#a855f7'); line.setAttribute('stroke-width', '3'); }
  }
}

// ---- CANVAS DRAWING ----
function drawScene(sceneType, choice) {
  const canvas = $('sceneCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width;
  const H = canvas.height;

  if (animFrame) cancelAnimationFrame(animFrame);
  ctx.clearRect(0, 0, W, H);

  // Shared colours
  const trackCol = '#94a3b8';
  const trolleyCol = '#be185d';
  const personCol = '#1e293b';
  const groundCol = '#f1f5f9';
  const grassCol = '#d1fae5';

  // Draw ground
  ctx.fillStyle = groundCol;
  ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = grassCol;
  ctx.fillRect(0, H - 40, W, 40);

  function drawTrack(x1, y1, x2, y2, highlight) {
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = highlight ? trolleyCol : trackCol;
    ctx.lineWidth = highlight ? 5 : 4;
    ctx.stroke();
    // Sleepers
    const dx = x2 - x1, dy = y2 - y1;
    const len = Math.sqrt(dx * dx + dy * dy);
    const steps = Math.floor(len / 20);
    const nx = -dy / len * 8, ny = dx / len * 8;
    ctx.strokeStyle = highlight ? '#f9a8d4' : '#cbd5e1';
    ctx.lineWidth = 2;
    for (let i = 1; i < steps; i++) {
      const t = i / steps;
      const px = x1 + dx * t, py = y1 + dy * t;
      ctx.beginPath();
      ctx.moveTo(px - nx, py - ny);
      ctx.lineTo(px + nx, py + ny);
      ctx.stroke();
    }
  }

  function drawPerson(x, y, alive, label) {
    ctx.fillStyle = alive ? personCol : '#ef4444';
    // Head
    ctx.beginPath();
    ctx.arc(x, y - 20, 6, 0, Math.PI * 2);
    ctx.fill();
    // Body
    ctx.beginPath();
    ctx.moveTo(x, y - 14);
    ctx.lineTo(x, y + 2);
    ctx.strokeStyle = alive ? personCol : '#ef4444';
    ctx.lineWidth = 2;
    ctx.stroke();
    // Arms
    ctx.beginPath();
    ctx.moveTo(x - 8, y - 8);
    ctx.lineTo(x + 8, y - 8);
    ctx.stroke();
    // Legs
    ctx.beginPath();
    ctx.moveTo(x, y + 2);
    ctx.lineTo(x - 6, y + 14);
    ctx.moveTo(x, y + 2);
    ctx.lineTo(x + 6, y + 14);
    ctx.stroke();
    if (label) {
      ctx.fillStyle = '#64748b';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(label, x, y + 28);
    }
  }

  function drawTrolley(x, y) {
    ctx.fillStyle = trolleyCol;
    ctx.fillRect(x - 18, y - 14, 36, 20);
    ctx.fillStyle = '#fda4af';
    ctx.fillRect(x - 14, y - 10, 10, 10);
    ctx.fillRect(x + 4, y - 10, 10, 10);
    // Wheels
    ctx.fillStyle = '#1e293b';
    ctx.beginPath();
    ctx.arc(x - 10, y + 8, 4, 0, Math.PI * 2);
    ctx.arc(x + 10, y + 8, 4, 0, Math.PI * 2);
    ctx.fill();
  }

  function drawLever(x, y, pulled) {
    ctx.fillStyle = '#78716c';
    ctx.fillRect(x - 3, y - 20, 6, 30);
    ctx.beginPath();
    ctx.arc(x, y - 20, 5, 0, Math.PI * 2);
    ctx.fillStyle = pulled ? '#22c55e' : '#ef4444';
    ctx.fill();
    ctx.fillStyle = '#64748b';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Lever', x, y + 20);
  }

  function drawFiveGroup(startX, y, alive) {
    for (let i = 0; i < 5; i++) drawPerson(startX + i * 22, y, alive);
    ctx.fillStyle = '#64748b';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('5 people', startX + 44, y + 28);
  }

  const choiceA = choice === 'a';
  const choiceB = choice === 'b';
  const decided = choice !== null;

  if (sceneType === 'classic') {
    // Main track
    drawTrack(50, 180, 650, 180, decided && choiceB);
    // Side track
    drawTrack(300, 180, 550, 260, decided && choiceA);
    // Trolley
    drawTrolley(100, 172);
    // Lever
    drawLever(290, 210, choiceA);
    // 5 people on main track
    drawFiveGroup(460, 162, !(decided && choiceB));
    // 1 person on side track
    drawPerson(500, 242, !(decided && choiceA), '1 person');
    if (decided) {
      ctx.fillStyle = choiceA ? '#16a34a' : '#dc2626';
      ctx.font = 'bold 13px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(choiceA ? 'Lever pulled: trolley diverted' : 'Trolley continues: 5 killed', W / 2, 30);
    }
  } else if (sceneType === 'footbridge') {
    // Track
    drawTrack(50, 240, 650, 240, true);
    // Bridge
    ctx.fillStyle = '#a8a29e';
    ctx.fillRect(260, 120, 130, 12);
    ctx.fillRect(265, 132, 8, 108);
    ctx.fillRect(377, 132, 8, 108);
    // Trolley
    drawTrolley(120, 232);
    // 5 people on track
    drawFiveGroup(460, 222, !(decided && choiceB));
    // Stranger on bridge
    if (!(decided && choiceA)) {
      drawPerson(340, 105, true, 'Stranger');
    } else {
      drawPerson(340, 222, false, 'Stranger');
    }
    // You on bridge
    drawPerson(295, 105, true, 'You');
    if (decided) {
      ctx.fillStyle = choiceA ? '#16a34a' : '#dc2626';
      ctx.font = 'bold 13px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(choiceA ? 'Stranger pushed: trolley stopped' : 'No push: 5 killed', W / 2, 30);
    }
  } else if (sceneType === 'loop') {
    // Main track
    drawTrack(50, 180, 400, 180, decided && choiceB);
    // Loop out
    drawTrack(300, 180, 500, 260, decided && choiceA);
    // Loop back
    drawTrack(500, 260, 650, 180, decided && choiceA);
    drawTrack(400, 180, 650, 180, false);
    // Trolley
    drawTrolley(100, 172);
    // Lever
    drawLever(290, 210, choiceA);
    // 5 people on main track
    drawFiveGroup(440, 162, !(decided && choiceB));
    // 1 person on loop
    drawPerson(500, 242, !(decided && choiceA), '1 person');
    // Loop label
    ctx.fillStyle = '#a855f7';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('loop track', 540, 280);
    if (decided) {
      ctx.fillStyle = choiceA ? '#16a34a' : '#dc2626';
      ctx.font = 'bold 13px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(choiceA ? 'Diverted to loop: 1 killed, 5 saved' : 'No diversion: 5 killed', W / 2, 30);
    }
  } else if (sceneType === 'organ') {
    // Hospital room
    ctx.fillStyle = '#e0f2fe';
    ctx.fillRect(50, 60, 280, 220);
    ctx.strokeStyle = '#93c5fd';
    ctx.lineWidth = 2;
    ctx.strokeRect(50, 60, 280, 220);
    ctx.fillStyle = '#3b82f6';
    ctx.font = 'bold 12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Hospital Ward', 190, 55);
    // 5 patients
    for (let i = 0; i < 5; i++) {
      const px = 90 + i * 48;
      drawPerson(px, 140, !(decided && choiceB), '');
      // Bed
      ctx.fillStyle = '#bfdbfe';
      ctx.fillRect(px - 12, 160, 24, 6);
    }
    ctx.fillStyle = '#64748b';
    ctx.font = '10px sans-serif';
    ctx.fillText('5 patients', 190, 190);
    // Check-up room
    ctx.fillStyle = '#fef3c7';
    ctx.fillRect(400, 100, 200, 160);
    ctx.strokeStyle = '#fbbf24';
    ctx.lineWidth = 2;
    ctx.strokeRect(400, 100, 200, 160);
    ctx.fillStyle = '#d97706';
    ctx.font = 'bold 12px sans-serif';
    ctx.fillText('Check-up Room', 500, 95);
    // Visitor
    drawPerson(500, 170, !(decided && choiceA), 'Healthy visitor');
    // Surgeon (you)
    drawPerson(370, 200, true, 'You (surgeon)');
    if (decided) {
      ctx.fillStyle = choiceA ? '#dc2626' : '#16a34a';
      ctx.font = 'bold 13px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(choiceA ? 'Organs harvested: 5 saved, visitor killed' : 'Visitor spared: 5 patients die', W / 2, 30);
    }
  } else if (sceneType === 'bystander') {
    // Track
    drawTrack(50, 200, 650, 200, true);
    // Side track
    drawTrack(350, 200, 550, 280, decided && choiceA);
    // Trolley
    drawTrolley(100, 192);
    // 5 people on main track (one runs if choice A)
    for (let i = 0; i < 5; i++) {
      if (i === 0 && decided && choiceA) {
        drawPerson(460, 262, false, 'Volunteer');
      } else {
        const alive = decided && choiceA ? true : !(decided && choiceB);
        drawPerson(440 + i * 22, 182, alive);
      }
    }
    if (!decided || choiceB) {
      ctx.fillStyle = '#64748b';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('5 people', 484, 210);
    } else {
      ctx.fillStyle = '#64748b';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('4 saved', 495, 210);
    }
    // You (bystander)
    drawPerson(200, 130, true, 'You (bystander)');
    if (decided) {
      ctx.fillStyle = choiceA ? '#16a34a' : '#dc2626';
      ctx.font = 'bold 13px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(choiceA ? 'Warning shouted: 1 volunteers, 4 saved' : 'Silence: all 5 face the trolley', W / 2, 30);
    }
  } else if (sceneType === 'selfsacrifice') {
    // Track
    drawTrack(50, 200, 650, 200, true);
    // Trolley
    drawTrolley(100, 192);
    // 5 people
    drawFiveGroup(460, 182, !(decided && choiceB));
    // You beside track
    if (!(decided && choiceA)) {
      drawPerson(300, 140, true, 'You');
    } else {
      drawPerson(300, 182, false, 'You');
    }
    if (decided) {
      ctx.fillStyle = choiceA ? '#16a34a' : '#dc2626';
      ctx.font = 'bold 13px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(choiceA ? 'You jump: trolley stopped, 5 saved' : 'You stay: 5 killed', W / 2, 30);
    }
  }
}
</script>
</body>
</html>