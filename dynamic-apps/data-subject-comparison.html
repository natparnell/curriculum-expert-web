<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subject Comparison Radar</title>
  <style>
    /* =====================================================================
       ROOT VARIABLES
    ===================================================================== */
    :root {
      --bg-primary:       #0f172a;
      --bg-secondary:     #1e293b;
      --bg-card:          #243347;
      --bg-panel:         #1a2a3a;
      --border:           #334155;
      --border-light:     #475569;

      --teal-400:         #2dd4bf;
      --teal-500:         #14b8a6;
      --teal-600:         #0d9488;
      --teal-700:         #0f766e;

      --slate-300:        #cbd5e1;
      --slate-400:        #94a3b8;
      --slate-500:        #64748b;
      --slate-600:        #475569;

      --text-primary:     #f1f5f9;
      --text-secondary:   #94a3b8;
      --text-muted:       #64748b;

      --entity-1:         #14b8a6;
      --entity-2:         #f59e0b;
      --entity-3:         #a78bfa;

      --entity-1-fill:    rgba(20, 184, 166, 0.18);
      --entity-2-fill:    rgba(245, 158, 11, 0.18);
      --entity-3-fill:    rgba(167, 139, 250, 0.18);

      --accent-positive:  #34d399;
      --accent-negative:  #f87171;

      --radius-sm:        6px;
      --radius-md:        10px;
      --radius-lg:        16px;

      --shadow-card:      0 4px 24px rgba(0,0,0,0.4);
      --shadow-panel:     0 2px 12px rgba(0,0,0,0.3);

      --font-mono:        'Courier New', Courier, monospace;
      --transition:       0.2s ease;
    }

    /* =====================================================================
       RESET & BASE
    ===================================================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html { font-size: 16px; }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      line-height: 1.5;
    }

    button {
      font-family: inherit;
      cursor: pointer;
      border: none;
      outline: none;
    }

    select, input {
      font-family: inherit;
      outline: none;
    }

    h1, h2, h3, h4 {
      line-height: 1.2;
      font-weight: 600;
    }

    /* =====================================================================
       LAYOUT
    ===================================================================== */
    .app-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .app-header__icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--teal-600), var(--teal-400));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .app-header__title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .app-header__subtitle {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .app-header__badge {
      margin-left: auto;
      background: var(--teal-700);
      color: var(--teal-400);
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      padding: 3px 10px;
      border-radius: 20px;
      text-transform: uppercase;
    }

    .app-body {
      display: grid;
      grid-template-columns: 280px 1fr 260px;
      grid-template-rows: 1fr;
      height: calc(100vh - 69px);
      overflow: hidden;
    }

    /* =====================================================================
       LEFT PANEL: ENTITY SELECTOR
    ===================================================================== */
    .left-panel {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .panel-section__header {
      padding: 10px 14px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--teal-400);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-section__body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Entity slots */
    .entity-slot {
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .entity-slot__header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
    }

    .entity-slot__dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .entity-slot__label {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    .entity-slot__toggle {
      margin-left: auto;
      width: 28px;
      height: 16px;
      border-radius: 8px;
      background: var(--border);
      position: relative;
      transition: background var(--transition);
      flex-shrink: 0;
    }

    .entity-slot__toggle.active {
      background: var(--teal-600);
    }

    .entity-slot__toggle::after {
      content: '';
      position: absolute;
      left: 2px;
      top: 2px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: white;
      transition: left var(--transition);
    }

    .entity-slot__toggle.active::after {
      left: 14px;
    }

    .entity-slot__body {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .entity-slot__select {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 0.8rem;
      padding: 6px 10px;
    }

    .entity-slot__name {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
      min-height: 18px;
    }

    /* Mode tabs */
    .mode-tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      padding: 8px;
    }

    .mode-tab {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.72rem;
      font-weight: 600;
      padding: 7px 6px;
      text-align: center;
      transition: all var(--transition);
    }

    .mode-tab.active {
      background: var(--teal-700);
      border-color: var(--teal-500);
      color: var(--teal-400);
    }

    /* Group comparison */
    .group-btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .group-btn {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.72rem;
      font-weight: 600;
      padding: 8px 6px;
      text-align: center;
      transition: all var(--transition);
    }

    .group-btn:hover {
      border-color: var(--teal-600);
      color: var(--teal-400);
    }

    .group-btn.active {
      background: var(--teal-700);
      border-color: var(--teal-500);
      color: var(--teal-400);
    }

    /* Whatif toggle */
    .whatif-info {
      font-size: 0.72rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .whatif-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .whatif-toggle-row span {
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    /* =====================================================================
       CENTRE: CHART AREA
    ===================================================================== */
    .centre-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chart-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      position: relative;
      overflow: hidden;
    }

    #radarSvg {
      max-width: 100%;
      max-height: 100%;
      overflow: visible;
    }

    /* Axis labels in SVG */
    .axis-label {
      cursor: pointer;
      user-select: none;
      transition: fill 0.15s;
    }

    .axis-label:hover { fill: var(--teal-400) !important; }

    /* Chart toolbar */
    .chart-toolbar {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chart-toolbar__label {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    .chart-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.75rem;
      padding: 5px 12px;
      transition: all var(--transition);
    }

    .chart-btn:hover {
      border-color: var(--teal-500);
      color: var(--teal-400);
    }

    .chart-btn.active {
      background: var(--teal-700);
      border-color: var(--teal-500);
      color: var(--teal-400);
    }

    /* Drill-down panel (slides up) */
    .drilldown-panel {
      background: var(--bg-secondary);
      border-top: 2px solid var(--teal-600);
      height: 0;
      overflow: hidden;
      transition: height 0.3s ease;
    }

    .drilldown-panel.open {
      height: 220px;
    }

    .drilldown-inner {
      padding: 14px 20px;
      height: 220px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .drilldown-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .drilldown-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--teal-400);
    }

    .drilldown-close {
      background: var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.75rem;
      padding: 3px 10px;
    }

    .drilldown-close:hover {
      background: var(--accent-negative);
      color: white;
    }

    #drilldownSvg {
      flex: 1;
      width: 100%;
    }

    /* =====================================================================
       RIGHT PANEL: STATS
    ===================================================================== */
    .right-panel {
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .stats-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .stats-card__header {
      padding: 9px 14px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--teal-400);
    }

    .stats-card__body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stat-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 7px 8px;
      background: var(--bg-panel);
      border-radius: var(--radius-sm);
    }

    .stat-row__icon {
      font-size: 1rem;
      flex-shrink: 0;
      line-height: 1.3;
    }

    .stat-row__content {}

    .stat-row__label {
      font-size: 0.68rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 700;
    }

    .stat-row__value {
      font-size: 0.82rem;
      color: var(--text-primary);
      font-weight: 600;
      margin-top: 2px;
    }

    .stat-row__sub {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .stat-pill {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .stat-pill.positive {
      background: rgba(52,211,153,0.15);
      color: var(--accent-positive);
    }

    .stat-pill.negative {
      background: rgba(248,113,113,0.15);
      color: var(--accent-negative);
    }

    /* Subject scores mini table */
    .subject-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }

    .subject-table th {
      text-align: left;
      color: var(--text-muted);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 6px;
      border-bottom: 1px solid var(--border);
    }

    .subject-table td {
      padding: 5px 6px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .subject-table tr:last-child td { border-bottom: none; }

    .subject-table td:last-child {
      text-align: right;
    }

    .mini-bar-wrap {
      width: 60px;
      height: 6px;
      background: var(--bg-primary);
      border-radius: 3px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: 4px;
    }

    .mini-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--teal-500);
    }

    /* Legend */
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 8px;
      border-radius: var(--radius-sm);
      background: var(--bg-panel);
      cursor: pointer;
      transition: background var(--transition);
    }

    .legend-item:hover { background: var(--bg-primary); }

    .legend-item.hidden { opacity: 0.45; }

    .legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .legend-text {
      flex: 1;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .legend-avg {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    /* Educational framing */
    .edu-section {
      background: rgba(20,184,166,0.06);
      border: 1px solid rgba(20,184,166,0.2);
      border-radius: var(--radius-md);
      padding: 12px;
    }

    .edu-section__title {
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--teal-400);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }

    .edu-insight {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.5;
      padding: 5px 0;
      border-bottom: 1px solid var(--border);
    }

    .edu-insight:last-child { border-bottom: none; }

    .edu-insight strong {
      color: var(--text-primary);
    }

    /* Whatif mode indicator */
    .whatif-banner {
      background: rgba(167,139,250,0.12);
      border: 1px solid rgba(167,139,250,0.3);
      border-radius: var(--radius-sm);
      padding: 7px 12px;
      font-size: 0.75rem;
      color: #a78bfa;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .whatif-banner.visible { display: flex; }

    /* =====================================================================
       SCROLLBAR
    ===================================================================== */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

    /* =====================================================================
       RESPONSIVE
    ===================================================================== */
    @media (max-width: 1100px) {
      .app-body {
        grid-template-columns: 240px 1fr 220px;
      }
    }

    @media (max-width: 900px) {
      .app-body {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        height: auto;
        overflow: auto;
      }

      .left-panel, .right-panel {
        border-right: none;
        border-left: none;
        border-bottom: 1px solid var(--border);
        max-height: none;
      }

      .centre-panel {
        min-height: 520px;
      }

      .chart-container {
        min-height: 420px;
      }

      .app-header__badge { display: none; }
    }

    @media (max-width: 600px) {
      .app-header { padding: 10px 14px; }
      .app-header__title { font-size: 1rem; }
      .group-btn-grid { grid-template-columns: 1fr 1fr; }
    }

    /* =====================================================================
       TOOLTIP
    ===================================================================== */
    #tooltip {
      position: fixed;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 7px 12px;
      font-size: 0.75rem;
      color: var(--text-primary);
      pointer-events: none;
      z-index: 1000;
      display: none;
      box-shadow: var(--shadow-panel);
      white-space: nowrap;
    }

    #tooltip.visible { display: block; }

    /* =====================================================================
       ANIMATIONS
    ===================================================================== */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.97); }
      to   { opacity: 1; transform: scale(1); }
    }

    .fade-in { animation: fadeIn 0.25s ease; }
  </style>
</head>
<body>

<!-- TOOLTIP -->
<div id="tooltip"></div>

<!-- HEADER -->
<header class="app-header">
  <div class="app-header__icon">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#2dd4bf" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5"/>
      <line x1="12" y1="2" x2="12" y2="22"/>
      <line x1="2" y1="8.5" x2="22" y2="8.5"/>
      <line x1="2" y1="15.5" x2="22" y2="15.5"/>
    </svg>
  </div>
  <div>
    <div class="app-header__title">Subject Comparison Radar</div>
    <div class="app-header__subtitle">Cross-subject performance analysis across 8 areas of the curriculum</div>
  </div>
  <div class="app-header__badge">WeST Analytics</div>
</header>

<!-- BODY -->
<div class="app-body">

  <!-- ===== LEFT PANEL ===== -->
  <aside class="left-panel">

    <!-- Mode selector -->
    <div class="panel-section">
      <div class="panel-section__header">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4"/><path d="M16 11h6m-3-3v6"/></svg>
        Comparison Mode
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" id="modeStudent" onclick="setMode('student')">Individual</button>
        <button class="mode-tab" id="modeGroup" onclick="setMode('group')">Group</button>
      </div>
    </div>

    <!-- Entity slots -->
    <div class="panel-section">
      <div class="panel-section__header">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Entities (up to 3)
      </div>
      <div class="panel-section__body">

        <!-- Entity 1 -->
        <div class="entity-slot">
          <div class="entity-slot__header">
            <div class="entity-slot__dot" style="background:var(--entity-1)"></div>
            <div class="entity-slot__label">Entity A</div>
            <div class="entity-slot__toggle active" id="toggle0" onclick="toggleEntity(0)"></div>
          </div>
          <div class="entity-slot__body">
            <select class="entity-slot__select" id="select0" onchange="onEntityChange(0)">
              <option value="">-- Select --</option>
            </select>
            <div class="entity-slot__name" id="name0"></div>
          </div>
        </div>

        <!-- Entity 2 -->
        <div class="entity-slot">
          <div class="entity-slot__header">
            <div class="entity-slot__dot" style="background:var(--entity-2)"></div>
            <div class="entity-slot__label">Entity B</div>
            <div class="entity-slot__toggle active" id="toggle1" onclick="toggleEntity(1)"></div>
          </div>
          <div class="entity-slot__body">
            <select class="entity-slot__select" id="select1" onchange="onEntityChange(1)">
              <option value="">-- Select --</option>
            </select>
            <div class="entity-slot__name" id="name1"></div>
          </div>
        </div>

        <!-- Entity 3 -->
        <div class="entity-slot">
          <div class="entity-slot__header">
            <div class="entity-slot__dot" style="background:var(--entity-3)"></div>
            <div class="entity-slot__label">Entity C</div>
            <div class="entity-slot__toggle active" id="toggle2" onclick="toggleEntity(2)"></div>
          </div>
          <div class="entity-slot__body">
            <select class="entity-slot__select" id="select2" onchange="onEntityChange(2)">
              <option value="">-- Select --</option>
            </select>
            <div class="entity-slot__name" id="name2"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- Group quick-load (student mode only) -->
    <div class="panel-section" id="groupQuickSection">
      <div class="panel-section__header">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Group Comparison
      </div>
      <div class="panel-section__body">
        <div class="group-btn-grid">
          <button class="group-btn" onclick="loadGroupComparison('boys','girls','national')">Boys / Girls / Natl</button>
          <button class="group-btn" onclick="loadGroupComparison('pp','nonpp','national')">PP / Non-PP / Natl</button>
          <button class="group-btn" onclick="loadGroupComparison('class','year','national')">Class / Year / Natl</button>
          <button class="group-btn" onclick="loadGroupComparison('top','mid','lower')">Top / Mid / Lower</button>
        </div>
      </div>
    </div>

    <!-- Whatif mode -->
    <div class="panel-section">
      <div class="panel-section__header">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/><circle cx="12" cy="12" r="10"/></svg>
        What-If Exploration
      </div>
      <div class="panel-section__body">
        <div class="whatif-toggle-row">
          <span>Enable draggable vertices</span>
          <div class="entity-slot__toggle" id="whatifToggle" onclick="toggleWhatif()"></div>
        </div>
        <div class="whatif-info">Drag any vertex on the radar to simulate target scores. Only applies to Entity A.</div>
      </div>
    </div>

  </aside>

  <!-- ===== CENTRE PANEL ===== -->
  <main class="centre-panel">

    <!-- Whatif banner -->
    <div class="whatif-banner" id="whatifBanner">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      What-If mode active: drag vertices on Entity A to explore target scenarios
    </div>

    <!-- Radar chart -->
    <div class="chart-container">
      <svg id="radarSvg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>

    <!-- Toolbar -->
    <div class="chart-toolbar">
      <span class="chart-toolbar__label">Scale:</span>
      <button class="chart-btn active" onclick="setScale('0-9')" id="scaleBtn09">0&ndash;9 grades</button>
      <button class="chart-btn" onclick="setScale('percent')" id="scaleBtnPct">Percentage</button>
      <span class="chart-toolbar__label" style="margin-left:10px">Grid:</span>
      <button class="chart-btn active" id="gridBtn" onclick="toggleGrid()">Show</button>
      <button class="chart-btn" id="labelsBtn" onclick="toggleValueLabels()">Values</button>
      <button class="chart-btn" id="resetBtn" onclick="resetWhatif()" style="margin-left:auto">Reset What-If</button>
    </div>

    <!-- Drill-down panel -->
    <div class="drilldown-panel" id="drilldownPanel">
      <div class="drilldown-inner">
        <div class="drilldown-header">
          <div class="drilldown-title" id="drilldownTitle">Subject Drill-Down</div>
          <button class="drilldown-close" onclick="closeDrilldown()">Close</button>
        </div>
        <svg id="drilldownSvg" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>
    </div>

  </main>

  <!-- ===== RIGHT PANEL ===== -->
  <aside class="right-panel">

    <!-- Legend -->
    <div class="stats-card">
      <div class="stats-card__header">Legend</div>
      <div class="stats-card__body" id="legendBody"></div>
    </div>

    <!-- Summary stats -->
    <div class="stats-card">
      <div class="stats-card__header">Summary Statistics</div>
      <div class="stats-card__body" id="summaryStats"></div>
    </div>

    <!-- Subject breakdown -->
    <div class="stats-card">
      <div class="stats-card__header">Subject Scores (Entity A)</div>
      <div class="stats-card__body" id="subjectTable"></div>
    </div>

    <!-- Educational framing -->
    <div class="edu-section">
      <div class="edu-section__title">Analytical Insights</div>
      <div class="edu-insight"><strong>Breadth vs Depth:</strong> A large radar area indicates broad competency across the curriculum. A narrow, pointed shape suggests concentrated strengths.</div>
      <div class="edu-insight"><strong>Subject Gaps:</strong> Long gaps between entity polygons on a single spoke reveal where targeted intervention or extension may be needed.</div>
      <div class="edu-insight"><strong>Profile Shape:</strong> Compare the overall shape across groups; similar shapes suggest shared patterns, whilst divergence highlights distinct learning profiles.</div>
    </div>

  </aside>

</div>

<script>
/* ===================================================================
   DATA DEFINITIONS
=================================================================== */

const SUBJECTS = ['English','Maths','Science','History','Geography','MFL','Art','PE'];
const NUM_SUBJECTS = 8;

// Demo student profiles (grades 0-9)
const STUDENTS = [
  { id:'s1', name:'Amara Johnson',   group:'girls', pp:false, attainment:'top',
    scores:[7,6,8,7,6,5,8,7] },
  { id:'s2', name:'Ben Okafor',      group:'boys',  pp:true,  attainment:'mid',
    scores:[5,4,6,5,4,3,6,7] },
  { id:'s3', name:'Chloe Patel',     group:'girls', pp:false, attainment:'top',
    scores:[8,9,7,8,9,8,6,5] },
  { id:'s4', name:'Daniel Hughes',   group:'boys',  pp:false, attainment:'mid',
    scores:[6,7,5,5,6,4,5,8] },
  { id:'s5', name:'Esme Tremblay',   group:'girls', pp:true,  attainment:'lower',
    scores:[4,3,4,5,4,3,7,6] },
  { id:'s6', name:'Finn McCarthy',   group:'boys',  pp:false, attainment:'top',
    scores:[7,8,8,6,7,7,5,6] },
  { id:'s7', name:'Grace Adeyemi',   group:'girls', pp:true,  attainment:'mid',
    scores:[5,5,6,7,5,6,8,5] },
  { id:'s8', name:'Hassan Mousa',    group:'boys',  pp:false, attainment:'lower',
    scores:[4,4,3,4,3,3,5,8] },
];

// Individual raw scores for drill-down (each student's individual score per subject, as given)
const DRILLDOWN_STUDENTS = STUDENTS.map(s => ({ name: s.name, scores: s.scores }));

// Cohort group averages
function avg(arr) { return arr.reduce((a,b)=>a+b,0)/arr.length; }
function subjectAvg(students) {
  return SUBJECTS.map((_,i) => +avg(students.map(s=>s.scores[i])).toFixed(2));
}

const GROUPS = {
  boys:     { name:'Boys Average',          scores: subjectAvg(STUDENTS.filter(s=>s.group==='boys')) },
  girls:    { name:'Girls Average',         scores: subjectAvg(STUDENTS.filter(s=>s.group==='girls')) },
  pp:       { name:'PP Average',            scores: subjectAvg(STUDENTS.filter(s=>s.pp)) },
  nonpp:    { name:'Non-PP Average',        scores: subjectAvg(STUDENTS.filter(s=>!s.pp)) },
  class:    { name:'Class Average',         scores: subjectAvg(STUDENTS) },
  year:     { name:'Year Group Average',    scores: [6.1,5.9,6.3,5.8,6.0,5.4,6.2,6.5] },
  national: { name:'National Average',      scores: [5.8,5.6,5.9,5.5,5.7,5.1,5.8,6.2] },
  top:      { name:'Top Attainers',         scores: subjectAvg(STUDENTS.filter(s=>s.attainment==='top')) },
  mid:      { name:'Middle Attainers',      scores: subjectAvg(STUDENTS.filter(s=>s.attainment==='mid')) },
  lower:    { name:'Lower Attainers',       scores: subjectAvg(STUDENTS.filter(s=>s.attainment==='lower')) },
};

const ENTITY_COLORS = ['#14b8a6','#f59e0b','#a78bfa'];
const ENTITY_FILLS  = ['rgba(20,184,166,0.18)','rgba(245,158,11,0.18)','rgba(167,139,250,0.18)'];

/* ===================================================================
   STATE
=================================================================== */
let currentMode = 'student'; // 'student' | 'group'
let entities = [
  { id: 's1', visible: true, whatifScores: null },
  { id: 'national', visible: true, whatifScores: null },
  { id: null, visible: true, whatifScores: null },
];
let showGrid = true;
let showValueLabels = false;
let whatifEnabled = false;
let scaleMode = '0-9'; // '0-9' | 'percent'
let drilldownSubject = null;

// For dragging
let draggingVertex = null; // { entityIdx, subjectIdx }

/* ===================================================================
   UTILITY
=================================================================== */
function getEntityData(entityState) {
  if (!entityState.id) return null;
  if (currentMode === 'student') {
    const s = STUDENTS.find(x => x.id === entityState.id);
    if (!s) return null;
    return {
      name: s.name,
      scores: entityState.whatifScores ? entityState.whatifScores : [...s.scores],
      originalScores: [...s.scores],
      description: `${s.group === 'boys' ? 'Male' : 'Female'}, PP: ${s.pp ? 'Yes' : 'No'}, Attainment: ${s.attainment}`,
    };
  } else {
    const g = GROUPS[entityState.id];
    if (!g) return null;
    return {
      name: g.name,
      scores: entityState.whatifScores ? entityState.whatifScores : [...g.scores],
      originalScores: [...g.scores],
      description: 'Cohort group average',
    };
  }
}

function scoreToDisplay(v) {
  if (scaleMode === 'percent') return Math.round((v / 9) * 100) + '%';
  return v.toFixed ? v.toFixed(1) : v;
}

/* ===================================================================
   RADAR GEOMETRY
=================================================================== */
const CX = 260, CY = 260, R = 200;

function angleForSpoke(i) {
  // Start at top (-PI/2), go clockwise
  return (2 * Math.PI * i / NUM_SUBJECTS) - Math.PI / 2;
}

function spokePoint(i, value, maxVal) {
  const frac = Math.max(0, Math.min(1, value / maxVal));
  const angle = angleForSpoke(i);
  return {
    x: CX + frac * R * Math.cos(angle),
    y: CY + frac * R * Math.sin(angle),
  };
}

function spokeEnd(i) {
  const angle = angleForSpoke(i);
  return {
    x: CX + R * Math.cos(angle),
    y: CY + R * Math.sin(angle),
  };
}

function labelPos(i) {
  const angle = angleForSpoke(i);
  const dist = R + 30;
  return {
    x: CX + dist * Math.cos(angle),
    y: CY + dist * Math.sin(angle),
  };
}

function polygonPoints(scores, maxVal) {
  return scores.map((v, i) => {
    const pt = spokePoint(i, v, maxVal);
    return `${pt.x},${pt.y}`;
  }).join(' ');
}

/* ===================================================================
   SVG HELPERS
=================================================================== */
function svgEl(tag, attrs, parent) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k, v] of Object.entries(attrs || {})) {
    el.setAttribute(k, v);
  }
  if (parent) parent.appendChild(el);
  return el;
}

function svgText(content, attrs, parent) {
  const el = svgEl('text', attrs, parent);
  el.textContent = content;
  return el;
}

/* ===================================================================
   DRAW RADAR
=================================================================== */
function drawRadar() {
  const svg = document.getElementById('radarSvg');
  svg.innerHTML = '';

  const maxVal = scaleMode === 'percent' ? 100 : 9;

  // Defs for gradients/filters
  const defs = svgEl('defs', {}, svg);

  // ---- GRID RINGS ----
  if (showGrid) {
    const numRings = scaleMode === 'percent' ? 5 : 9;
    for (let ring = 1; ring <= numRings; ring++) {
      const frac = ring / numRings;
      const pts = SUBJECTS.map((_,i) => {
        const angle = angleForSpoke(i);
        const rx = CX + frac * R * Math.cos(angle);
        const ry = CY + frac * R * Math.sin(angle);
        return `${rx},${ry}`;
      }).join(' ');
      svgEl('polygon', {
        points: pts,
        fill: 'none',
        stroke: ring === numRings ? '#475569' : '#253347',
        'stroke-width': ring === numRings ? '1.5' : '1',
        'stroke-dasharray': ring === numRings ? 'none' : '3,4',
      }, svg);

      // Ring label (on the English spoke = spoke 0)
      const angle0 = angleForSpoke(0);
      const lx = CX + frac * R * Math.cos(angle0) + 5;
      const ly = CY + frac * R * Math.sin(angle0) + 1;
      const labelVal = scaleMode === 'percent'
        ? (ring * 20) + '%'
        : ring.toString();
      svgText(labelVal, {
        x: lx, y: ly,
        fill: '#475569',
        'font-size': '9',
        'font-family': 'Courier New, monospace',
        'text-anchor': 'start',
      }, svg);
    }
  }

  // ---- SPOKES ----
  for (let i = 0; i < NUM_SUBJECTS; i++) {
    const end = spokeEnd(i);
    svgEl('line', {
      x1: CX, y1: CY,
      x2: end.x, y2: end.y,
      stroke: '#334155',
      'stroke-width': '1.5',
    }, svg);
  }

  // ---- ENTITY POLYGONS ----
  const entityData = entities.map(e => getEntityData(e));

  // Draw filled polygons back to front (reversed so entity A is on top)
  for (let idx = 2; idx >= 0; idx--) {
    const e = entities[idx];
    const d = entityData[idx];
    if (!d || !e.visible) continue;

    const scores = scaleMode === 'percent'
      ? d.scores.map(v => (v / 9) * 100)
      : d.scores;

    svgEl('polygon', {
      points: polygonPoints(scores, maxVal),
      fill: ENTITY_FILLS[idx],
      stroke: ENTITY_COLORS[idx],
      'stroke-width': '2.5',
      'stroke-linejoin': 'round',
      class: 'fade-in',
    }, svg);
  }

  // ---- VERTEX DOTS ----
  for (let idx = 0; idx < 3; idx++) {
    const e = entities[idx];
    const d = entityData[idx];
    if (!d || !e.visible) continue;

    const scores = scaleMode === 'percent'
      ? d.scores.map(v => (v / 9) * 100)
      : d.scores;

    for (let i = 0; i < NUM_SUBJECTS; i++) {
      const pt = spokePoint(i, scores[i], maxVal);
      const dot = svgEl('circle', {
        cx: pt.x, cy: pt.y,
        r: whatifEnabled && idx === 0 ? '7' : '5',
        fill: ENTITY_COLORS[idx],
        stroke: '#0f172a',
        'stroke-width': '2',
        style: whatifEnabled && idx === 0 ? 'cursor:grab' : 'cursor:default',
        'data-entity': idx,
        'data-subject': i,
      }, svg);

      // Tooltip on hover
      dot.addEventListener('mouseenter', ev => {
        const rawScore = d.scores[i];
        showTooltip(ev,
          `${SUBJECTS[i]}: ${scoreToDisplay(rawScore)}`
          + (d.name ? ` (${d.name})` : '')
        );
      });
      dot.addEventListener('mouseleave', hideTooltip);

      // Drag handlers
      if (whatifEnabled && idx === 0) {
        dot.addEventListener('mousedown', ev => {
          ev.preventDefault();
          draggingVertex = { entityIdx: idx, subjectIdx: i };
          document.body.style.cursor = 'grabbing';
        });
      }
    }

    // Value labels
    if (showValueLabels) {
      for (let i = 0; i < NUM_SUBJECTS; i++) {
        const rawScore = d.scores[i];
        const dispScore = scaleMode === 'percent'
          ? (rawScore / 9 * 100).toFixed(0) + '%'
          : rawScore.toFixed(1);
        const pt = spokePoint(i, scores[i], maxVal);
        svgText(dispScore, {
          x: pt.x + 7, y: pt.y - 5,
          fill: ENTITY_COLORS[idx],
          'font-size': '9',
          'font-family': 'Courier New, monospace',
          'font-weight': 'bold',
        }, svg);
      }
    }
  }

  // ---- AXIS LABELS ----
  for (let i = 0; i < NUM_SUBJECTS; i++) {
    const pos = labelPos(i);
    const angle = angleForSpoke(i);

    // Align text based on position
    let anchor = 'middle';
    if (Math.cos(angle) > 0.3) anchor = 'start';
    else if (Math.cos(angle) < -0.3) anchor = 'end';

    let dy = '0.35em';
    if (Math.sin(angle) < -0.5) dy = '-0.5em';
    else if (Math.sin(angle) > 0.5) dy = '1em';

    const lbl = svgText(SUBJECTS[i], {
      x: pos.x, y: pos.y,
      fill: '#94a3b8',
      'font-size': '13',
      'font-weight': '700',
      'font-family': 'Segoe UI, system-ui, sans-serif',
      'text-anchor': anchor,
      'dominant-baseline': 'middle',
      dy: dy,
      class: 'axis-label',
      'data-subject': i,
    }, svg);

    lbl.addEventListener('click', () => openDrilldown(i));
    lbl.addEventListener('mouseenter', ev => {
      showTooltip(ev, `Click to drill down into ${SUBJECTS[i]}`);
      lbl.setAttribute('fill', '#2dd4bf');
    });
    lbl.addEventListener('mouseleave', () => {
      hideTooltip();
      lbl.setAttribute('fill', '#94a3b8');
    });
  }

  // ---- CENTRE DOT ----
  svgEl('circle', { cx: CX, cy: CY, r: '3', fill: '#475569' }, svg);

  updateLegend();
  updateStats();
  updateSubjectTable();
}

/* ===================================================================
   DRAG INTERACTIONS (What-If)
=================================================================== */
document.addEventListener('mousemove', ev => {
  if (!draggingVertex) return;
  const { entityIdx, subjectIdx } = draggingVertex;

  const svg = document.getElementById('radarSvg');
  const rect = svg.getBoundingClientRect();

  // Convert screen coords to SVG coords
  const scaleX = 520 / rect.width;
  const scaleY = 520 / rect.height;
  const svgX = (ev.clientX - rect.left) * scaleX;
  const svgY = (ev.clientY - rect.top) * scaleY;

  // Project onto the spoke axis
  const angle = angleForSpoke(subjectIdx);
  const dx = svgX - CX;
  const dy = svgY - CY;

  // Dot product with unit spoke vector
  const spokeVx = Math.cos(angle);
  const spokeVy = Math.sin(angle);
  const proj = dx * spokeVx + dy * spokeVy;
  const frac = Math.max(0, Math.min(1, proj / R));

  const newVal = scaleMode === 'percent'
    ? frac * 100
    : frac * 9;

  // Ensure whatifScores exists
  const e = entities[entityIdx];
  const d = getEntityData(e);
  if (!d) return;

  if (!e.whatifScores) {
    e.whatifScores = [...d.originalScores];
  }

  e.whatifScores[subjectIdx] = scaleMode === 'percent'
    ? newVal / 100 * 9
    : newVal;

  drawRadar();
});

document.addEventListener('mouseup', () => {
  if (draggingVertex) {
    draggingVertex = null;
    document.body.style.cursor = '';
    drawRadar();
  }
});

/* ===================================================================
   DRILL-DOWN BAR CHART
=================================================================== */
function openDrilldown(subjectIdx) {
  drilldownSubject = subjectIdx;
  const panel = document.getElementById('drilldownPanel');
  panel.classList.add('open');
  document.getElementById('drilldownTitle').textContent =
    `${SUBJECTS[subjectIdx]}: Individual Student Scores`;
  drawDrilldown(subjectIdx);
}

function closeDrilldown() {
  document.getElementById('drilldownPanel').classList.remove('open');
  drilldownSubject = null;
}

function drawDrilldown(subjectIdx) {
  const svg = document.getElementById('drilldownSvg');
  svg.innerHTML = '';

  const scores = DRILLDOWN_STUDENTS.map(s => ({
    name: s.name.split(' ')[0],
    val: s.scores[subjectIdx],
  }));

  const W = svg.clientWidth || 600;
  const H = 120;
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  const barW = Math.floor((W - 20) / scores.length) - 4;
  const maxH = H - 30;

  scores.forEach((s, i) => {
    const frac = s.val / 9;
    const bh = Math.max(4, frac * maxH);
    const bx = 10 + i * (barW + 4);
    const by = maxH - bh + 10;

    // Bar
    svgEl('rect', {
      x: bx, y: by, width: barW, height: bh,
      fill: '#14b8a6', rx: '3',
      opacity: '0.85',
    }, svg);

    // Value label
    svgText(s.val.toFixed(0), {
      x: bx + barW / 2, y: by - 3,
      fill: '#94a3b8',
      'font-size': '10',
      'text-anchor': 'middle',
      'font-family': 'Courier New, monospace',
    }, svg);

    // Name label
    svgText(s.name, {
      x: bx + barW / 2, y: H - 4,
      fill: '#64748b',
      'font-size': '9',
      'text-anchor': 'middle',
      'font-family': 'Segoe UI, system-ui, sans-serif',
    }, svg);
  });

  // National average line
  const natAvg = GROUPS.national.scores[subjectIdx];
  const lineY = maxH - (natAvg / 9 * maxH) + 10;
  svgEl('line', {
    x1: 8, y1: lineY, x2: W - 8, y2: lineY,
    stroke: '#f59e0b', 'stroke-width': '1.5', 'stroke-dasharray': '4,3',
  }, svg);
  svgText(`Natl avg: ${natAvg.toFixed(1)}`, {
    x: W - 10, y: lineY - 3,
    fill: '#f59e0b',
    'font-size': '9',
    'text-anchor': 'end',
    'font-family': 'Courier New, monospace',
  }, svg);
}

/* ===================================================================
   LEGEND
=================================================================== */
function updateLegend() {
  const body = document.getElementById('legendBody');
  body.innerHTML = '';

  entities.forEach((e, idx) => {
    const d = getEntityData(e);
    if (!d) return;

    const scores = d.scores;
    const avg = (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1);

    const item = document.createElement('div');
    item.className = 'legend-item' + (!e.visible ? ' hidden' : '');
    item.title = 'Click to show/hide';
    item.onclick = () => toggleEntity(idx);
    item.innerHTML = `
      <div class="legend-swatch" style="background:${ENTITY_COLORS[idx]}"></div>
      <div class="legend-text">${d.name}</div>
      <div class="legend-avg">avg: ${avg}</div>
    `;
    body.appendChild(item);
  });

  if (!body.children.length) {
    body.innerHTML = '<div style="font-size:0.75rem;color:var(--text-muted);text-align:center;padding:8px">Select entities to compare</div>';
  }
}

/* ===================================================================
   STATS
=================================================================== */
function updateStats() {
  const summaryEl = document.getElementById('summaryStats');
  summaryEl.innerHTML = '';

  const activeEntities = entities
    .map((e, i) => ({ e, i, d: getEntityData(e) }))
    .filter(x => x.d && x.e.visible);

  if (!activeEntities.length) {
    summaryEl.innerHTML = '<div style="font-size:0.75rem;color:var(--text-muted);text-align:center;padding:8px">No entities selected</div>';
    return;
  }

  // Subject averages across all active entities
  const subjectMeans = SUBJECTS.map((_, si) => {
    const vals = activeEntities.map(x => x.d.scores[si]);
    return avg(vals);
  });

  const highestIdx = subjectMeans.indexOf(Math.max(...subjectMeans));
  const lowestIdx  = subjectMeans.indexOf(Math.min(...subjectMeans));

  addStatRow(summaryEl, 'ðŸ†', 'Highest (combined avg)',
    SUBJECTS[highestIdx],
    `avg ${subjectMeans[highestIdx].toFixed(1)} across entities`);

  addStatRow(summaryEl, 'ðŸ“‰', 'Lowest (combined avg)',
    SUBJECTS[lowestIdx],
    `avg ${subjectMeans[lowestIdx].toFixed(1)} across entities`);

  // Gap between entities (if 2+)
  if (activeEntities.length >= 2) {
    const e0 = activeEntities[0];
    const e1 = activeEntities[1];
    const gaps = SUBJECTS.map((_, si) =>
      Math.abs(e0.d.scores[si] - e1.d.scores[si])
    );
    const maxGapIdx = gaps.indexOf(Math.max(...gaps));
    addStatRow(summaryEl, 'â†”', 'Biggest gap (A vs B)',
      SUBJECTS[maxGapIdx],
      `gap of ${gaps[maxGapIdx].toFixed(1)} grade points`);

    // Overall averages per entity
    activeEntities.forEach(({ e, i, d }) => {
      const mean = avg(d.scores).toFixed(1);
      addStatRow(summaryEl, 'â—†', `${d.name} overall avg`,
        mean,
        `across all 8 subjects`,
        ENTITY_COLORS[i]);
    });
  }

  // Radar area approximation for entity 0
  if (activeEntities.length > 0) {
    const d0 = activeEntities[0].d;
    const area = radarArea(d0.scores, 9);
    const maxArea = radarArea([9,9,9,9,9,9,9,9], 9);
    const pct = Math.round((area / maxArea) * 100);
    addStatRow(summaryEl, 'â¬¡', 'Curriculum coverage (A)',
      `${pct}%`,
      'of maximum possible radar area');
  }
}

function radarArea(scores, maxVal) {
  let area = 0;
  const n = scores.length;
  for (let i = 0; i < n; i++) {
    const j = (i + 1) % n;
    const ai = angleForSpoke(i);
    const aj = angleForSpoke(j);
    const ri = scores[i] / maxVal;
    const rj = scores[j] / maxVal;
    const xi = ri * Math.cos(ai), yi = ri * Math.sin(ai);
    const xj = rj * Math.cos(aj), yj = rj * Math.sin(aj);
    area += Math.abs(xi * yj - xj * yi);
  }
  return area * 0.5;
}

function addStatRow(parent, icon, label, value, sub, color) {
  const row = document.createElement('div');
  row.className = 'stat-row';
  row.innerHTML = `
    <div class="stat-row__icon">${icon}</div>
    <div class="stat-row__content">
      <div class="stat-row__label">${label}</div>
      <div class="stat-row__value" style="${color ? 'color:' + color : ''}">${value}</div>
      <div class="stat-row__sub">${sub}</div>
    </div>
  `;
  parent.appendChild(row);
}

/* ===================================================================
   SUBJECT TABLE
=================================================================== */
function updateSubjectTable() {
  const body = document.getElementById('subjectTable');
  body.innerHTML = '';

  const d = getEntityData(entities[0]);
  if (!d) {
    body.innerHTML = '<div style="font-size:0.75rem;color:var(--text-muted);text-align:center;padding:8px">Select Entity A</div>';
    return;
  }

  const natD = GROUPS.national;

  const table = document.createElement('table');
  table.className = 'subject-table';

  const thead = table.createTHead();
  const hrow = thead.insertRow();
  ['Subject','Score','vs Natl'].forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    hrow.appendChild(th);
  });

  const tbody = table.createTBody();
  SUBJECTS.forEach((subj, i) => {
    const score = d.scores[i];
    const nat   = natD.scores[i];
    const diff  = score - nat;
    const barPct = Math.round((score / 9) * 100);

    const row = tbody.insertRow();
    row.style.cursor = 'pointer';
    row.title = `Click to drill down into ${subj}`;
    row.addEventListener('click', () => openDrilldown(i));

    const c1 = row.insertCell(); c1.textContent = subj;
    c1.style.color = 'var(--text-primary)';

    const c2 = row.insertCell();
    c2.innerHTML = `
      <div style="display:flex;align-items:center;gap:4px">
        <span class="mini-bar-wrap"><span class="mini-bar" style="width:${barPct}%;background:${ENTITY_COLORS[0]}"></span></span>
        <span style="font-family:var(--font-mono);font-size:0.72rem;color:var(--text-primary)">${score.toFixed(1)}</span>
      </div>`;

    const c3 = row.insertCell();
    const sign = diff >= 0 ? '+' : '';
    c3.innerHTML = `<span class="stat-pill ${diff >= 0 ? 'positive' : 'negative'}">${sign}${diff.toFixed(1)}</span>`;
  });

  body.appendChild(table);
}

/* ===================================================================
   SELECTS POPULATION
=================================================================== */
function populateSelects() {
  for (let i = 0; i < 3; i++) {
    const sel = document.getElementById(`select${i}`);
    const current = sel.value;
    sel.innerHTML = '<option value="">-- Select --</option>';

    if (currentMode === 'student') {
      STUDENTS.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        sel.appendChild(opt);
      });
      // Add cohort options under a group
      const grpOpts = [
        ['class','Class Average'],
        ['year','Year Group Average'],
        ['national','National Average'],
        ['boys','Boys Average'],
        ['girls','Girls Average'],
        ['pp','PP Average'],
        ['nonpp','Non-PP Average'],
        ['top','Top Attainers'],
        ['mid','Middle Attainers'],
        ['lower','Lower Attainers'],
      ];
      const og = document.createElement('optgroup');
      og.label = 'Cohort Groups';
      grpOpts.forEach(([id, name]) => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name;
        og.appendChild(opt);
      });
      sel.appendChild(og);
    } else {
      const grpOpts = [
        ['class','Class Average'],
        ['year','Year Group Average'],
        ['national','National Average'],
        ['boys','Boys Average'],
        ['girls','Girls Average'],
        ['pp','PP Average'],
        ['nonpp','Non-PP Average'],
        ['top','Top Attainers'],
        ['mid','Middle Attainers'],
        ['lower','Lower Attainers'],
      ];
      grpOpts.forEach(([id, name]) => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    }

    // Restore selection if possible
    sel.value = entities[i].id || '';
  }
  updateEntityNames();
}

function updateEntityNames() {
  for (let i = 0; i < 3; i++) {
    const nameEl = document.getElementById(`name${i}`);
    const d = getEntityData(entities[i]);
    if (d) {
      nameEl.textContent = d.description || '';
    } else {
      nameEl.textContent = '';
    }
  }
}

function onEntityChange(idx) {
  const sel = document.getElementById(`select${idx}`);
  entities[idx].id = sel.value || null;
  entities[idx].whatifScores = null;
  updateEntityNames();
  drawRadar();
  if (drilldownSubject !== null) drawDrilldown(drilldownSubject);
}

/* ===================================================================
   MODE SWITCHING
=================================================================== */
function setMode(mode) {
  currentMode = mode;
  document.getElementById('modeStudent').classList.toggle('active', mode === 'student');
  document.getElementById('modeGroup').classList.toggle('active', mode === 'group');

  // Reset entities
  if (mode === 'student') {
    entities[0].id = 's1';
    entities[1].id = 'national';
    entities[2].id = null;
  } else {
    entities[0].id = 'class';
    entities[1].id = 'national';
    entities[2].id = null;
  }
  entities.forEach(e => { e.whatifScores = null; });
  populateSelects();
  drawRadar();
}

/* ===================================================================
   TOGGLE ENTITY VISIBILITY
=================================================================== */
function toggleEntity(idx) {
  entities[idx].visible = !entities[idx].visible;
  const toggle = document.getElementById(`toggle${idx}`);
  toggle.classList.toggle('active', entities[idx].visible);
  drawRadar();
}

/* ===================================================================
   WHAT-IF MODE
=================================================================== */
function toggleWhatif() {
  whatifEnabled = !whatifEnabled;
  document.getElementById('whatifToggle').classList.toggle('active', whatifEnabled);
  document.getElementById('whatifBanner').classList.toggle('visible', whatifEnabled);
  drawRadar();
}

function resetWhatif() {
  entities.forEach(e => { e.whatifScores = null; });
  drawRadar();
}

/* ===================================================================
   SCALE & GRID
=================================================================== */
function setScale(mode) {
  scaleMode = mode;
  document.getElementById('scaleBtn09').classList.toggle('active', mode === '0-9');
  document.getElementById('scaleBtnPct').classList.toggle('active', mode === 'percent');
  // Reset whatif on scale change
  entities.forEach(e => { e.whatifScores = null; });
  drawRadar();
  if (drilldownSubject !== null) drawDrilldown(drilldownSubject);
}

function toggleGrid() {
  showGrid = !showGrid;
  document.getElementById('gridBtn').textContent = showGrid ? 'Show' : 'Hide';
  document.getElementById('gridBtn').classList.toggle('active', showGrid);
  drawRadar();
}

function toggleValueLabels() {
  showValueLabels = !showValueLabels;
  document.getElementById('labelsBtn').classList.toggle('active', showValueLabels);
  drawRadar();
}

/* ===================================================================
   GROUP QUICK LOAD
=================================================================== */
function loadGroupComparison(id0, id1, id2) {
  // Switch to student mode (selects include group IDs)
  const ids = [id0, id1, id2];
  ids.forEach((id, i) => {
    entities[i].id = id;
    entities[i].whatifScores = null;
    entities[i].visible = true;
    document.getElementById(`toggle${i}`).classList.add('active');
  });
  populateSelects();
  for (let i = 0; i < 3; i++) {
    document.getElementById(`select${i}`).value = entities[i].id;
  }
  updateEntityNames();
  drawRadar();
}

/* ===================================================================
   TOOLTIP
=================================================================== */
const tooltipEl = document.getElementById('tooltip');

function showTooltip(ev, text) {
  tooltipEl.textContent = text;
  tooltipEl.classList.add('visible');
  positionTooltip(ev);
}

function hideTooltip() {
  tooltipEl.classList.remove('visible');
}

document.addEventListener('mousemove', ev => {
  if (tooltipEl.classList.contains('visible')) {
    positionTooltip(ev);
  }
});

function positionTooltip(ev) {
  const x = ev.clientX + 14;
  const y = ev.clientY - 28;
  tooltipEl.style.left = Math.min(x, window.innerWidth - 180) + 'px';
  tooltipEl.style.top  = Math.max(y, 8) + 'px';
}

/* ===================================================================
   RESIZE HANDLER
=================================================================== */
function onResize() {
  drawRadar();
  if (drilldownSubject !== null) drawDrilldown(drilldownSubject);
}

window.addEventListener('resize', debounce(onResize, 120));

function debounce(fn, delay) {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
}

/* ===================================================================
   INIT
=================================================================== */
function init() {
  populateSelects();

  // Set initial select values
  document.getElementById('select0').value = 's1';
  document.getElementById('select1').value = 'national';

  drawRadar();
}

init();
</script>
</body>
</html>
