<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Pattern Visualiser</title>
<style>
  :root {
    --sl-50:  #f8fafc;
    --sl-100: #f1f5f9;
    --sl-200: #e2e8f0;
    --sl-300: #cbd5e1;
    --sl-400: #94a3b8;
    --sl-500: #64748b;
    --sl-600: #475569;
    --sl-700: #334155;
    --sl-800: #1e293b;
    --sl-900: #0f172a;
    --teal-50:  #f0fdfa;
    --teal-100: #ccfbf1;
    --teal-200: #99f6e4;
    --teal-400: #2dd4bf;
    --teal-500: #14b8a6;
    --teal-600: #0d9488;
    --teal-700: #0f766e;
    --green:    #22c55e;
    --green-dk: #16a34a;
    --amber:    #f59e0b;
    --amber-dk: #92400e;
    --red:      #ef4444;
    --red-dk:   #dc2626;
    --purple:   #a855f7;
    --font: 'Segoe UI', system-ui, sans-serif;
    --r:  6px;
    --rl: 10px;
    --sh:  0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.08);
    --shm: 0 4px 6px rgba(0,0,0,.10), 0 2px 4px rgba(0,0,0,.06);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: var(--sl-100);
    color: var(--sl-800);
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* Header */
  .hdr {
    background: var(--sl-800);
    color: #fff;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    box-shadow: var(--shm);
  }
  .hdr svg { flex-shrink: 0; }
  .hdr h1  { font-size: 1.15rem; font-weight: 700; letter-spacing: -.01em; }
  .hdr p   { font-size: .78rem; color: var(--sl-300); margin-top: 1px; }

  /* Layout */
  .app-body {
    display: grid;
    grid-template-columns: 252px 1fr;
    min-height: calc(100vh - 58px);
  }

  /* Sidebar */
  .sidebar {
    background: var(--sl-800);
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    border-right: 1px solid var(--sl-700);
  }
  .s-lbl {
    font-size: .67rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .07em;
    color: var(--teal-400);
    margin-bottom: 2px;
  }
  .s-sec { display: flex; flex-direction: column; gap: 7px; }

  /* Student buttons */
  .stu-btn {
    background: var(--sl-700);
    border: 2px solid transparent;
    border-radius: var(--r);
    padding: 9px 11px;
    text-align: left;
    cursor: pointer;
    color: #fff;
    transition: all .15s;
    position: relative;
    font-family: var(--font);
  }
  .stu-btn:hover { background: var(--sl-600); }
  .stu-btn.active { background: var(--teal-700); border-color: var(--teal-400); }
  .stu-btn.cmp-active { background: #312e81; border-color: var(--purple); }
  .stu-btn .sn { font-weight: 600; font-size: .87rem; }
  .stu-btn .sd { font-size: .72rem; color: var(--sl-300); margin-top: 2px; }
  .stu-btn .sp { position: absolute; top: 9px; right: 9px; font-size: .77rem; font-weight: 700; }
  .sp.pa { color: #f87171; }
  .sp.ok { color: #4ade80; }

  /* Control buttons */
  .ctrl-btn {
    background: var(--sl-700);
    border: 1px solid var(--sl-600);
    border-radius: var(--r);
    padding: 8px 12px;
    color: #fff;
    cursor: pointer;
    font-size: .82rem;
    text-align: center;
    transition: all .15s;
    font-family: var(--font);
  }
  .ctrl-btn:hover { background: var(--sl-600); }
  .ctrl-btn.on { background: var(--teal-700); border-color: var(--teal-500); color: var(--teal-100); }

  /* Legend */
  .leg { display: flex; flex-direction: column; gap: 5px; }
  .li { display: flex; align-items: center; gap: 8px; font-size: .76rem; color: var(--sl-300); }
  .ls { width: 13px; height: 13px; border-radius: 3px; flex-shrink: 0; }
  .li-head { font-size: .76rem; color: var(--sl-400); font-weight: 600; margin-bottom: 2px; }

  /* Main content */
  .main {
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    overflow-x: auto;
  }

  /* Stat cards */
  .stat-row { display: flex; gap: 10px; flex-wrap: wrap; }
  .stat {
    background: #fff;
    border-radius: var(--rl);
    padding: 12px 16px;
    box-shadow: var(--sh);
    flex: 1;
    min-width: 110px;
  }
  .sv {
    font-size: 1.55rem;
    font-weight: 800;
    line-height: 1;
    letter-spacing: -.02em;
  }
  .sv.red    { color: var(--red); }
  .sv.amber  { color: var(--amber); }
  .sv.green  { color: var(--green-dk); }
  .sv.teal   { color: var(--teal-600); }
  .sv.purple { color: var(--purple); }
  .sl {
    font-size: .71rem;
    color: var(--sl-500);
    margin-top: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .04em;
  }

  /* Panels */
  .panel { background: #fff; border-radius: var(--rl); box-shadow: var(--sh); overflow: hidden; }
  .ph {
    padding: 11px 15px;
    background: var(--sl-50);
    border-bottom: 1px solid var(--sl-200);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .ph h2 { font-size: .87rem; font-weight: 700; color: var(--sl-700); flex: 1; }
  .badge {
    background: var(--teal-100);
    color: var(--teal-700);
    font-size: .68rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: .05em;
    white-space: nowrap;
  }
  .badge.red   { background: #fee2e2; color: var(--red-dk); }
  .badge.amber { background: #fef3c7; color: var(--amber-dk); }
  .pb { padding: 15px; }

  /* Heatmap */
  .hm-wrap { overflow-x: auto; padding-bottom: 6px; }
  #heatmap-svg { display: block; }
  .hm-tip {
    font-size: .73rem;
    color: var(--sl-400);
    margin-top: 7px;
    text-align: right;
    font-style: italic;
  }

  /* Compare grid */
  .cmp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .cmp-panel { background: #fff; border-radius: var(--rl); box-shadow: var(--sh); overflow: hidden; }
  .cmp-hdr {
    padding: 9px 13px;
    font-weight: 700;
    font-size: .84rem;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .cmp-hdr.teal   { background: var(--teal-700); }
  .cmp-hdr.purple { background: #4c1d95; }
  .cmp-body { padding: 12px; overflow-x: auto; }

  /* Chart row */
  .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  svg text { font-family: var(--font); }

  /* Pattern alerts */
  .pat-list { display: flex; flex-direction: column; gap: 8px; }
  .pat {
    padding: 9px 12px;
    border-radius: var(--r);
    border-left: 4px solid;
    font-size: .81rem;
    line-height: 1.55;
  }
  .pat.warning { background: #fef3c7; border-color: var(--amber); color: #78350f; }
  .pat.danger  { background: #fee2e2; border-color: var(--red);   color: #7f1d1d; }
  .pat.info    { background: var(--teal-50); border-color: var(--teal-500); color: var(--teal-700); }
  .pat strong  { display: block; font-weight: 700; margin-bottom: 2px; }
  .no-pat { color: var(--sl-400); font-size: .81rem; font-style: italic; }

  /* Educational info box */
  .edu {
    background: var(--teal-50);
    border: 1px solid var(--teal-200);
    border-radius: var(--rl);
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
  }
  .edu h3 { font-size: .81rem; font-weight: 700; color: var(--teal-700); margin-bottom: 4px; }
  .edu p  { font-size: .77rem; color: var(--sl-600); line-height: 1.55; }

  /* Tooltip */
  #tt {
    position: fixed;
    background: var(--sl-800);
    color: #fff;
    padding: 8px 12px;
    border-radius: var(--r);
    font-size: .77rem;
    pointer-events: none;
    z-index: 999;
    box-shadow: var(--shm);
    max-width: 200px;
    display: none;
  }
  #tt .td  { font-weight: 700; margin-bottom: 3px; }
  #tt .ts  { display: flex; align-items: center; gap: 6px; }
  #tt .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* Responsive */
  @media (max-width: 768px) {
    .app-body { grid-template-columns: 1fr; }
    .sidebar  { flex-direction: row; flex-wrap: wrap; overflow-x: auto; }
    .s-sec    { min-width: 130px; }
    .chart-row, .cmp-grid, .edu { grid-template-columns: 1fr; }
    .main  { padding: 12px; }
    .stat  { min-width: 90px; }
  }
  @media (max-width: 480px) {
    .hdr h1 { font-size: 1rem; }
    .sv     { font-size: 1.25rem; }
  }
</style>
</head>
<body>

<!-- Header -->
<header class="hdr">
  <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
    <rect width="32" height="32" rx="7" fill="#0d9488"/>
    <rect x="6"  y="18" width="4" height="9"  rx="1" fill="#ccfbf1"/>
    <rect x="12" y="13" width="4" height="14" rx="1" fill="#5eead4"/>
    <rect x="18" y="8"  width="4" height="19" rx="1" fill="#2dd4bf"/>
    <rect x="24" y="4"  width="2" height="23" rx="1" fill="#99f6e4"/>
    <line x1="6" y1="15" x2="26" y2="15" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="2 2"/>
  </svg>
  <div>
    <h1>Attendance Pattern Visualiser</h1>
    <p>Calendar heatmap and day/period matrix for identifying absence patterns</p>
  </div>
</header>

<div class="app-body">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="s-sec">
      <div class="s-lbl">Student Profiles</div>
      <div id="student-list"></div>
    </div>

    <div class="s-sec">
      <div class="s-lbl">Controls</div>
      <button class="ctrl-btn" id="btn-compare">Compare Mode</button>
      <button class="ctrl-btn" id="btn-reset">Reset Demo Data</button>
      <button class="ctrl-btn on" id="btn-pa">90% PA Line: ON</button>
    </div>

    <div class="s-sec">
      <div class="s-lbl">Click a Day to Cycle</div>
      <div class="leg">
        <div class="li">
          <div class="ls" style="background:#22c55e"></div>Present
        </div>
        <div class="li">
          <div class="ls" style="background:#ef4444"></div>Unauthorised absence
        </div>
        <div class="li">
          <div class="ls" style="background:#f59e0b"></div>Authorised absence
        </div>
        <div class="li">
          <div class="ls" style="background:#a855f7"></div>Holiday in term time
        </div>
        <div class="li">
          <div class="ls" style="background:#e2e8f0;border:1px solid #cbd5e1"></div>School holiday
        </div>
      </div>
    </div>

    <div class="s-sec">
      <div class="s-lbl">Intervention Thresholds</div>
      <div class="leg">
        <div class="li-head">Absence rate triggers:</div>
        <div class="li"><div class="ls" style="background:#ef4444"></div>&lt;85%: Serious concern</div>
        <div class="li"><div class="ls" style="background:#f59e0b"></div>85-89%: Persistent absence</div>
        <div class="li"><div class="ls" style="background:#22c55e"></div>90%+: Expected attendance</div>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="main">

    <!-- Stat cards -->
    <div class="stat-row" id="stat-row"></div>

    <!-- Heatmap panel -->
    <div class="panel" id="hm-panel">
      <div class="ph">
        <h2 id="hm-title">Academic Year Calendar Heatmap</h2>
        <span class="badge" id="hm-badge">2025/26</span>
        <span class="badge red" id="pa-badge" style="display:none">Persistent Absence</span>
      </div>
      <div class="pb">
        <div class="hm-wrap">
          <svg id="heatmap-svg"></svg>
        </div>
        <p class="hm-tip">Click any school day to cycle: present &rarr; unauthorised &rarr; authorised &rarr; holiday in term &rarr; present</p>
      </div>
    </div>

    <!-- Compare grid (hidden by default) -->
    <div class="cmp-grid" id="cmp-grid" style="display:none">
      <div class="cmp-panel">
        <div class="cmp-hdr teal">
          <span id="cmp-na">Student A</span>
          <span id="cmp-pa">--</span>
        </div>
        <div class="cmp-body"><svg id="cmp-svg-a"></svg></div>
      </div>
      <div class="cmp-panel">
        <div class="cmp-hdr purple">
          <span id="cmp-nb">Student B</span>
          <span id="cmp-pb">--</span>
        </div>
        <div class="cmp-body"><svg id="cmp-svg-b"></svg></div>
      </div>
    </div>

    <!-- Day-of-week and session charts -->
    <div class="chart-row">
      <div class="panel">
        <div class="ph"><h2>Day-of-Week Absence Frequency</h2></div>
        <div class="pb"><svg id="dow-svg" width="100%" height="190"></svg></div>
      </div>
      <div class="panel">
        <div class="ph"><h2>Morning vs Afternoon Sessions</h2></div>
        <div class="pb"><svg id="ses-svg" width="100%" height="190"></svg></div>
      </div>
    </div>

    <!-- Period matrix -->
    <div class="panel">
      <div class="ph">
        <h2>Period/Session Absence Matrix (by term week)</h2>
        <span class="badge">AM / PM heatmap</span>
      </div>
      <div class="pb"><svg id="mat-svg" width="100%" height="106"></svg></div>
    </div>

    <!-- Detected patterns -->
    <div class="panel">
      <div class="ph"><h2>Detected Patterns</h2></div>
      <div class="pb"><div class="pat-list" id="pat-list"></div></div>
    </div>

    <!-- Educational framing -->
    <div class="edu">
      <div>
        <h3>Persistent Absence (PA)</h3>
        <p>A pupil is classed as persistently absent when their attendance falls below 90% of possible sessions. At 190 school days this means missing 19 or more days across the year.</p>
      </div>
      <div>
        <h3>Pattern Recognition for Safeguarding</h3>
        <p>Regular Monday or Friday absences can indicate family difficulties or disengagement. Post-holiday spikes may signal extended holidays. Afternoon-only patterns can suggest bullying or anxiety triggers.</p>
      </div>
      <div>
        <h3>Intervention Trigger Points</h3>
        <p>First contact at 95% or below. Formal support plan at the 90% PA threshold. Referral consideration below 85%. Fixed-penalty notice consideration below 80% for unauthorised absences.</p>
      </div>
    </div>

  </main>
</div>

<!-- Tooltip -->
<div id="tt">
  <div class="td" id="tt-d"></div>
  <div class="ts">
    <div class="dot" id="tt-dot"></div>
    <span id="tt-l"></span>
  </div>
</div>

<script>
// ===================================================
// CONFIG
// ===================================================

const CELL_SIZE = 13;
const CELL_GAP  = 2;
const CELL_STEP = CELL_SIZE + CELL_GAP;
const MONTH_H   = 18;
const DOW_W     = 22;

// Status identifiers
const S = {
  P:  'present',
  U:  'unauthorised',
  A:  'authorised',
  HT: 'holiday_term',
  SH: 'school_hol',
  WE: 'weekend',
};

// Colours for each status
const COL = {
  present:      '#22c55e',
  unauthorised: '#ef4444',
  authorised:   '#f59e0b',
  holiday_term: '#a855f7',
  school_hol:   '#e2e8f0',
  weekend:      '#f8fafc',
};

// Labels for tooltip
const LBL = {
  present:      'Present',
  unauthorised: 'Unauthorised absence',
  authorised:   'Authorised absence',
  holiday_term: 'Holiday in term time',
  school_hol:   'School holiday',
  weekend:      'Weekend',
};

// Cycling order when a day is clicked
const CYCLE = [S.P, S.U, S.A, S.HT];

// ===================================================
// HOLIDAY PERIODS (approximate national averages)
// ===================================================

const HOLIDAYS = [
  [new Date(2025,  9, 27), new Date(2025, 10,  2)],  // Autumn half-term
  [new Date(2025, 11, 22), new Date(2026,  0,  4)],  // Christmas
  [new Date(2026,  1, 16), new Date(2026,  1, 22)],  // February half-term
  [new Date(2026,  2, 30), new Date(2026,  3, 12)],  // Easter
  [new Date(2026,  4,  4), new Date(2026,  4,  4)],  // May Bank Holiday
  [new Date(2026,  4, 25), new Date(2026,  4, 31)],  // Whitsun
  [new Date(2026,  6, 21), new Date(2026,  6, 31)],  // Summer end
];

function isSchoolHol(d) {
  return HOLIDAYS.some(([f, t]) => d >= f && d <= t);
}

function isWeekend(d) {
  const w = d.getDay();
  return w === 0 || w === 6;
}

// ===================================================
// BUILD BASE CALENDAR (Sept 2025 - Jul 2026)
// ===================================================

function buildBase() {
  const days = [];
  const cur  = new Date(2025, 8, 1);
  const end  = new Date(2026, 6, 31);
  while (cur <= end) {
    const dow = cur.getDay();
    let def;
    if (isWeekend(cur)) {
      def = S.WE;
    } else if (isSchoolHol(cur)) {
      def = S.SH;
    } else {
      def = S.P;
    }
    days.push({ date: new Date(cur), dow, status: def, def });
    cur.setDate(cur.getDate() + 1);
  }
  return days;
}

// ===================================================
// SEEDED RNG (reproducible demo data)
// ===================================================

function makeRng(seed) {
  let s = seed;
  return function () {
    s = (s * 1664525 + 1013904223) & 0xffffffff;
    return (s >>> 0) / 0xffffffff;
  };
}

// ===================================================
// STUDENT PATTERN GENERATORS
// ===================================================

function applyModel(days) {
  const r = makeRng(42);
  let n = 0;
  days.forEach(function (d) {
    if (d.def === S.P && r() > 0.97 && n < 5) {
      d.status = S.A;
      n++;
    }
  });
}

function applyPersist(days) {
  const r = makeRng(7);
  days.forEach(function (d) {
    if (d.def === S.P) {
      const v = r();
      if (v < 0.12) {
        d.status = S.U;
      } else if (v < 0.20) {
        d.status = S.A;
      }
    }
  });
}

function applyMonday(days) {
  const r = makeRng(13);
  days.forEach(function (d) {
    if (d.def === S.P) {
      if (d.dow === 1 && r() < 0.75) {
        d.status = S.U;
      } else if (r() < 0.03) {
        d.status = S.A;
      }
    }
  });
}

function applyPostHol(days) {
  const r = makeRng(19);
  const spikes = [
    [new Date(2025, 11, 1), new Date(2025, 11, 5)],
    [new Date(2026,  0, 5), new Date(2026,  0, 9)],
    [new Date(2026,  3,13), new Date(2026,  3,17)],
    [new Date(2026,  4,18), new Date(2026,  4,22)],
    [new Date(2026,  5, 1), new Date(2026,  5, 5)],
  ];
  days.forEach(function (d) {
    if (d.def === S.P) {
      const inSpike = spikes.some(function ([f, t]) { return d.date >= f && d.date <= t; });
      if (inSpike && r() < 0.55) {
        d.status = S.U;
      } else if (r() < 0.02) {
        d.status = S.A;
      }
    }
  });
}

function applyTermHol(days) {
  const r = makeRng(31);
  const blocks = [
    [new Date(2025, 9, 20), new Date(2025, 9, 24)],
    [new Date(2026, 2, 16), new Date(2026, 2, 20)],
  ];
  blocks.forEach(function ([f, t]) {
    days.forEach(function (d) {
      if (d.date >= f && d.date <= t && d.def === S.P) {
        d.status = S.HT;
      }
    });
  });
  days.forEach(function (d) {
    if (d.def === S.P && d.status === S.P && r() < 0.04) {
      d.status = S.U;
    }
  });
}

// ===================================================
// BUILD ALL STUDENTS
// ===================================================

function buildStudents() {
  function fresh(fn) {
    const d = buildBase();
    fn(d);
    return d;
  }
  return [
    { id: 0, name: 'Amara S.',    desc: 'Model attendance',    pat: 'model',   days: fresh(applyModel)   },
    { id: 1, name: 'Dylan W.',    desc: 'Persistent absence',  pat: 'persist', days: fresh(applyPersist) },
    { id: 2, name: 'Kezia P.',    desc: 'Monday pattern',      pat: 'monday',  days: fresh(applyMonday)  },
    { id: 3, name: 'Rowan B.',    desc: 'Post-holiday spikes', pat: 'postHol', days: fresh(applyPostHol) },
    { id: 4, name: 'Scarlett H.', desc: 'Term-time holidays',  pat: 'termHol', days: fresh(applyTermHol) },
  ];
}

// ===================================================
// STATISTICS
// ===================================================

function calcStats(days) {
  let poss = 0, pres = 0, unauth = 0, auth = 0, ht = 0;
  days.forEach(function (d) {
    if (d.def !== S.P) return;
    poss++;
    if      (d.status === S.P)  pres++;
    else if (d.status === S.U)  unauth++;
    else if (d.status === S.A)  auth++;
    else if (d.status === S.HT) ht++;
  });
  const pct = poss > 0 ? parseFloat(((pres / poss) * 100).toFixed(1)) : 0;
  return { poss, pres, unauth, auth, ht, absent: poss - pres, pct };
}

function dowAbsence(days) {
  const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
  const dows   = [1, 2, 3, 4, 5];
  const tot    = [0, 0, 0, 0, 0];
  const abs    = [0, 0, 0, 0, 0];
  days.forEach(function (d) {
    if (d.def !== S.P) return;
    const i = dows.indexOf(d.dow);
    if (i < 0) return;
    tot[i]++;
    if (d.status !== S.P) abs[i]++;
  });
  return labels.map(function (l, i) {
    return { label: l, pct: tot[i] > 0 ? abs[i] / tot[i] : 0, abs: abs[i], tot: tot[i] };
  });
}

function sessionAbsence(days) {
  let amA = 0, amT = 0, pmA = 0, pmT = 0, idx = 0;
  days.forEach(function (d) {
    if (d.def !== S.P) return;
    amT++;
    pmT++;
    if (d.status !== S.P) {
      amA++;
      if (d.status === S.A || d.status === S.HT) {
        pmA++;
      } else if (idx % 3 !== 0) {
        pmA++;
      }
    }
    idx++;
  });
  return {
    amPct: amT > 0 ? amA / amT : 0,
    pmPct: pmT > 0 ? pmA / pmT : 0,
  };
}

// ===================================================
// PATTERN DETECTION
// ===================================================

function detectPatterns(days, pat) {
  const patterns = [];
  const st  = calcStats(days);
  const dow = dowAbsence(days);
  const mon = dow[0].pct;
  const fri = dow[4].pct;
  const mid = dow[2].pct;

  if (st.pct < 85) {
    patterns.push({
      type: 'danger',
      title: 'Serious attendance concern',
      desc: 'Attendance at ' + st.pct + '% is significantly below the persistent absence threshold of 90%. Urgent intervention is required.',
    });
  } else if (st.pct < 90) {
    patterns.push({
      type: 'warning',
      title: 'Persistent absence threshold breached',
      desc: 'Attendance at ' + st.pct + '% falls below the 90% PA threshold. A formal support plan should be considered.',
    });
  }

  if (mon > 0.15 && mon > mid * 1.8) {
    patterns.push({
      type: 'warning',
      title: 'Monday pattern detected',
      desc: Math.round(mon * 100) + '% of Mondays are missed, significantly above the mid-week average. This may indicate weekend-related difficulties or gradual disengagement.',
    });
  }

  if (fri > 0.15 && fri > mid * 1.8) {
    patterns.push({
      type: 'warning',
      title: 'Friday pattern detected',
      desc: Math.round(fri * 100) + '% of Fridays are missed. This can indicate deliberate early holiday departure or recurring family commitments.',
    });
  }

  if (st.ht >= 5) {
    patterns.push({
      type: 'danger',
      title: 'Repeated holiday in term time',
      desc: st.ht + ' days are recorded as holiday taken in term time. Parents may be liable for a fixed-penalty notice where more than 5 sessions are unauthorised.',
    });
  }

  if (pat === 'postHol') {
    patterns.push({
      type: 'info',
      title: 'Post-holiday spike pattern',
      desc: 'Absences cluster in the first 1-2 weeks after school holidays, suggesting difficulty re-engaging after breaks. A structured reintegration plan may help.',
    });
    patterns.push({
      type: 'info',
      title: 'Pre-holiday pattern',
      desc: 'Absences also appear in the final days before holiday periods, indicating early departure or rising anxiety around school transitions.',
    });
  }

  if (st.auth > 15) {
    patterns.push({
      type: 'warning',
      title: 'High authorised absence volume',
      desc: st.auth + ' authorised absences are recorded. Whilst individually legitimate, cumulative learning loss warrants a pastoral review.',
    });
  }

  if (patterns.length === 0) {
    patterns.push({
      type: 'info',
      title: 'No significant patterns detected',
      desc: 'Attendance is within the expected range with no consistent day-of-week or temporal patterns identified.',
    });
  }

  return patterns;
}

// ===================================================
// SVG UTILITY
// ===================================================

const NS = 'http://www.w3.org/2000/svg';

function mkEl(tag, attrs, text) {
  const el = document.createElementNS(NS, tag);
  Object.entries(attrs).forEach(function ([k, v]) {
    el.setAttribute(k, v);
  });
  if (text !== undefined) el.textContent = text;
  return el;
}

// ===================================================
// HEATMAP RENDERER
// ===================================================

function weekNum(date, start) {
  return Math.floor((date - start) / (7 * 86400000));
}

function renderHeatmap(svgEl, days, interactive, onClickDay) {
  const calStart = new Date(days[0].date);
  const sd = calStart.getDay();
  const shift = sd === 0 ? 1 : sd === 1 ? 0 : -(sd - 1);
  calStart.setDate(calStart.getDate() + shift);

  const totalWks = weekNum(days[days.length - 1].date, calStart) + 2;
  const W = DOW_W + totalWks * CELL_STEP + 10;
  const H = MONTH_H + 5 * CELL_STEP + 16;

  svgEl.setAttribute('width',  W);
  svgEl.setAttribute('height', H);
  svgEl.innerHTML = '';

  // Day-of-week labels
  const DOW_LABELS = ['M', 'T', 'W', 'T', 'F'];
  DOW_LABELS.forEach(function (l, i) {
    svgEl.appendChild(mkEl('text', {
      x: DOW_W - 4,
      y: MONTH_H + i * CELL_STEP + CELL_SIZE - 2,
      'text-anchor': 'end',
      'font-size': '9',
      fill: '#94a3b8',
    }, l));
  });

  // Month labels
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let lastM = -1;
  days.forEach(function (day) {
    const m = day.date.getMonth();
    if (m === lastM) return;
    lastM = m;
    const wk = weekNum(day.date, calStart);
    svgEl.appendChild(mkEl('text', {
      x: DOW_W + wk * CELL_STEP + 1,
      y: MONTH_H - 5,
      'font-size': '9',
      fill: '#64748b',
      'font-weight': '600',
    }, MONTHS[m]));
  });

  // Day cells
  days.forEach(function (day) {
    if (day.dow === 0 || day.dow === 6) return;
    const wk  = weekNum(day.date, calStart);
    const row = day.dow - 1;
    const x   = DOW_W + wk * CELL_STEP;
    const y   = MONTH_H + row * CELL_STEP;
    const clickable = day.def === S.P && interactive;

    const rect = mkEl('rect', {
      x, y,
      width:  CELL_SIZE,
      height: CELL_SIZE,
      rx: 2,
      fill: COL[day.status] || '#e2e8f0',
      stroke: day.status === S.P ? 'none' : 'rgba(0,0,0,.1)',
      'stroke-width': '0.5',
      style: clickable ? 'cursor:pointer' : 'cursor:default',
    });

    if (clickable && onClickDay) {
      rect.addEventListener('click', function () {
        onClickDay(day, rect);
      });
    }

    rect.addEventListener('mouseenter', function (e) { showTT(e, day); });
    rect.addEventListener('mousemove',  moveTT);
    rect.addEventListener('mouseleave', hideTT);
    svgEl.appendChild(rect);
  });

  // PA annotation
  if (showPA && interactive) {
    const st = calcStats(days);
    svgEl.appendChild(mkEl('text', {
      x: DOW_W + 2,
      y: H - 4,
      'font-size': '8',
      fill: st.pct < 90 ? '#ef4444' : '#22c55e',
    }, 'Current: ' + st.pct + '%  |  PA threshold: 90%'));
  }
}

// ===================================================
// DAY-OF-WEEK BAR CHART
// ===================================================

function renderDow(svgEl, days) {
  svgEl.innerHTML = '';
  const data = dowAbsence(days);
  const W    = svgEl.parentElement ? svgEl.parentElement.clientWidth - 30 : 300;
  const H    = 170;
  svgEl.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');

  const pL = 34, pR = 8, pT = 10, pB = 28;
  const cW = W - pL - pR;
  const cH = H - pT - pB;
  const maxP = Math.max.apply(null, data.map(function (d) { return d.pct; }).concat([0.20]));
  const bW   = (cW / data.length) * 0.5;
  const bGap = cW / data.length;

  // PA 10% line
  if (showPA) {
    const py = pT + cH - (0.10 / maxP) * cH;
    svgEl.appendChild(mkEl('line', { x1: pL, y1: py, x2: pL + cW, y2: py, stroke: '#ef4444', 'stroke-width': '1', 'stroke-dasharray': '4 3' }));
    svgEl.appendChild(mkEl('text', { x: pL + cW - 2, y: py - 3, 'font-size': '8', fill: '#ef4444', 'text-anchor': 'end' }, '10% = PA'));
  }

  // Grid lines
  [0, 0.05, 0.10, 0.15, 0.20].forEach(function (v) {
    if (v > maxP * 1.05) return;
    const gy = pT + cH - (v / maxP) * cH;
    svgEl.appendChild(mkEl('line', { x1: pL, y1: gy, x2: pL + cW, y2: gy, stroke: '#e2e8f0', 'stroke-width': '1' }));
    svgEl.appendChild(mkEl('text', { x: pL - 3, y: gy + 3, 'font-size': '8', fill: '#94a3b8', 'text-anchor': 'end' }, Math.round(v * 100) + '%'));
  });

  // Bars
  data.forEach(function (d, i) {
    const cx  = pL + i * bGap + bGap / 2;
    const bh  = (d.pct / maxP) * cH;
    const by  = pT + cH - bh;
    const col = d.pct > 0.15 ? '#ef4444' : d.pct > 0.10 ? '#f59e0b' : '#0d9488';

    svgEl.appendChild(mkEl('rect', { x: cx - bW / 2, y: by, width: bW, height: bh, fill: col, rx: 2 }));
    svgEl.appendChild(mkEl('text', { x: cx, y: pT + cH + 12, 'text-anchor': 'middle', 'font-size': '10', fill: '#475569', 'font-weight': '600' }, d.label));
    if (d.pct > 0) {
      svgEl.appendChild(mkEl('text', { x: cx, y: by - 2, 'text-anchor': 'middle', 'font-size': '8', fill: col }, Math.round(d.pct * 100) + '%'));
    }
  });
}

// ===================================================
// SESSION (AM/PM) BAR CHART
// ===================================================

function renderSession(svgEl, days) {
  svgEl.innerHTML = '';
  const { amPct, pmPct } = sessionAbsence(days);
  const W = svgEl.parentElement ? svgEl.parentElement.clientWidth - 30 : 300;
  const H = 170;
  svgEl.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
  svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');

  const pL = 34, pR = 8, pT = 10, pB = 28;
  const cW = W - pL - pR;
  const cH = H - pT - pB;
  const maxP = Math.max(amPct, pmPct, 0.15);

  [0, 0.05, 0.10, 0.15].forEach(function (v) {
    if (v > maxP * 1.1) return;
    const gy = pT + cH - (v / maxP) * cH;
    svgEl.appendChild(mkEl('line', { x1: pL, y1: gy, x2: pL + cW, y2: gy, stroke: '#e2e8f0', 'stroke-width': '1' }));
    svgEl.appendChild(mkEl('text', { x: pL - 3, y: gy + 3, 'font-size': '8', fill: '#94a3b8', 'text-anchor': 'end' }, Math.round(v * 100) + '%'));
  });

  const bars = [
    { label: 'Morning (AM)', pct: amPct, col: '#0d9488' },
    { label: 'Afternoon (PM)', pct: pmPct, col: '#f59e0b' },
  ];
  const bW = cW * 0.18;

  bars.forEach(function (b, i) {
    const cx = pL + cW * (i + 1) / 3;
    const bh = (b.pct / maxP) * cH;
    const by = pT + cH - bh;
    svgEl.appendChild(mkEl('rect', { x: cx - bW / 2, y: by, width: bW, height: bh, fill: b.col, rx: 3 }));
    svgEl.appendChild(mkEl('text', { x: cx, y: pT + cH + 12, 'text-anchor': 'middle', 'font-size': '9', fill: '#475569', 'font-weight': '600' }, b.label));
    svgEl.appendChild(mkEl('text', { x: cx, y: by - 3, 'text-anchor': 'middle', 'font-size': '9', fill: b.col, 'font-weight': '700' }, (b.pct * 100).toFixed(1) + '%'));
  });
}

// ===================================================
// PERIOD / SESSION MATRIX
// ===================================================

function renderMatrix(svgEl, days) {
  svgEl.innerHTML = '';
  const wkMap = {};
  const origin = new Date(2025, 8, 1);

  days.forEach(function (d) {
    if (d.def !== S.P) return;
    const wk = Math.floor((d.date - origin) / (7 * 86400000));
    if (!wkMap[wk]) wkMap[wk] = { a: 0, t: 0 };
    wkMap[wk].t++;
    if (d.status !== S.P) wkMap[wk].a++;
  });

  const wks = Object.keys(wkMap).map(Number).sort(function (a, b) { return a - b; });
  if (!wks.length) return;

  const pW  = svgEl.parentElement ? svgEl.parentElement.clientWidth - 30 : 600;
  const cW  = Math.max(8, Math.floor((pW - 38) / wks.length));
  const cH  = 34;
  const rows = ['AM', 'PM'];

  svgEl.setAttribute('width',  Math.max(38 + wks.length * (cW + 1), pW));
  svgEl.setAttribute('height', 106);

  // Row labels
  rows.forEach(function (l, r) {
    svgEl.appendChild(mkEl('text', {
      x: 28,
      y: 14 + r * (cH + 4) + cH / 2 + 4,
      'text-anchor': 'end',
      'font-size': '10',
      fill: '#475569',
      'font-weight': '700',
    }, l));
  });

  // Cells
  wks.forEach(function (wk, col) {
    const { a, t } = wkMap[wk];
    const base = t > 0 ? a / t : 0;

    rows.forEach(function (_, r) {
      const rate = r === 0 ? base * 0.85 : base * 1.15;
      const x    = 34 + col * (cW + 1);
      const y    = 14 + r * (cH + 4);
      const fill = rate === 0 ? '#dcfce7' : rate < 0.10 ? '#fef9c3' : rate < 0.20 ? '#fed7aa' : '#fecaca';
      svgEl.appendChild(mkEl('rect', { x, y, width: cW, height: cH, fill, rx: 2 }));
      if (rate > 0.05 && cW > 14) {
        svgEl.appendChild(mkEl('text', {
          x: x + cW / 2,
          y: y + cH / 2 + 4,
          'text-anchor': 'middle',
          'font-size': '8',
          fill: '#374151',
        }, Math.round(rate * 100) + '%'));
      }
    });

    // Term break divider
    if (col > 0 && wks[col] - wks[col - 1] > 2) {
      const lx = 34 + col * (cW + 1) - 2;
      svgEl.appendChild(mkEl('line', { x1: lx, y1: 10, x2: lx, y2: 10 + 2 * cH + 4, stroke: '#334155', 'stroke-width': '1.5' }));
    }
  });

  // Colour key
  const keyItems = [
    { fill: '#dcfce7', label: '0%' },
    { fill: '#fef9c3', label: '<10%' },
    { fill: '#fed7aa', label: '<20%' },
    { fill: '#fecaca', label: '20%+' },
  ];
  const ky = 14 + 2 * (cH + 4) + 6;
  keyItems.forEach(function (k, i) {
    const kx = 34 + i * 60;
    svgEl.appendChild(mkEl('rect', { x: kx, y: ky, width: 10, height: 10, fill: k.fill, stroke: '#e5e7eb', 'stroke-width': '0.5', rx: 2 }));
    svgEl.appendChild(mkEl('text', { x: kx + 13, y: ky + 9, 'font-size': '9', fill: '#64748b' }, k.label));
  });
}

// ===================================================
// TOOLTIP
// ===================================================

const ttEl  = document.getElementById('tt');
const ttD   = document.getElementById('tt-d');
const ttDot = document.getElementById('tt-dot');
const ttL   = document.getElementById('tt-l');

const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAY_NAMES   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

function showTT(e, day) {
  ttD.textContent = DAY_NAMES[day.date.getDay()] + ' ' + day.date.getDate() + ' ' + MONTH_NAMES[day.date.getMonth()] + ' ' + day.date.getFullYear();
  ttDot.style.background = COL[day.status];
  ttL.textContent = LBL[day.status];
  ttEl.style.display = 'block';
  moveTT(e);
}

function moveTT(e) {
  let x = e.clientX + 12;
  let y = e.clientY - 10;
  if (x + 210 > window.innerWidth)  x = e.clientX - 215;
  if (y + 60  > window.innerHeight) y = e.clientY - 65;
  ttEl.style.left = x + 'px';
  ttEl.style.top  = y + 'px';
}

function hideTT() {
  ttEl.style.display = 'none';
}

// ===================================================
// APPLICATION STATE
// ===================================================

let students    = buildStudents();
let activeIdx   = 0;
let cmpIdx      = 1;
let compareMode = false;
let showPA      = true;

// ===================================================
// RENDER FUNCTIONS
// ===================================================

function renderStats(days) {
  const st = calcStats(days);
  const c  = st.pct >= 97 ? 'green' : st.pct >= 90 ? 'teal' : st.pct >= 85 ? 'amber' : 'red';
  document.getElementById('stat-row').innerHTML =
    '<div class="stat"><div class="sv ' + c + '">' + st.pct + '%</div><div class="sl">Attendance rate</div></div>' +
    '<div class="stat"><div class="sv ' + (st.absent > 19 ? 'red' : 'amber') + '">' + st.absent + '</div><div class="sl">Days absent</div></div>' +
    '<div class="stat"><div class="sv red">' + st.unauth + '</div><div class="sl">Unauthorised</div></div>' +
    '<div class="stat"><div class="sv amber">' + st.auth + '</div><div class="sl">Authorised</div></div>' +
    '<div class="stat"><div class="sv purple">' + st.ht + '</div><div class="sl">Holiday in term</div></div>' +
    '<div class="stat"><div class="sv teal">' + st.poss + '</div><div class="sl">Possible days</div></div>';
}

function renderPatterns(days, student) {
  const pats = detectPatterns(days, student.pat);
  if (!pats.length) {
    document.getElementById('pat-list').innerHTML = '<p class="no-pat">No significant absence patterns detected.</p>';
    return;
  }
  document.getElementById('pat-list').innerHTML = pats.map(function (p) {
    return '<div class="pat ' + p.type + '"><strong>' + p.title + '</strong>' + p.desc + '</div>';
  }).join('');
}

function renderStudentList() {
  document.getElementById('student-list').innerHTML = students.map(function (s, i) {
    const st = calcStats(s.days);
    let cls  = 'stu-btn';
    if (i === activeIdx) cls += ' active';
    if (compareMode && i === cmpIdx) cls += ' cmp-active';
    return '<button class="' + cls + '" onclick="selStudent(' + i + ')">' +
      '<div class="sn">' + s.name + '</div>' +
      '<div class="sd">' + s.desc + '</div>' +
      '<div class="sp ' + (st.pct < 90 ? 'pa' : 'ok') + '">' + st.pct + '%</div>' +
      '</button>';
  }).join('');
}

function renderCompare() {
  const sa = students[activeIdx];
  const sb = students[cmpIdx];
  document.getElementById('cmp-na').textContent = sa.name;
  document.getElementById('cmp-pa').textContent = calcStats(sa.days).pct + '%';
  document.getElementById('cmp-nb').textContent = sb.name;
  document.getElementById('cmp-pb').textContent = calcStats(sb.days).pct + '%';
  renderHeatmap(document.getElementById('cmp-svg-a'), sa.days, false, null);
  renderHeatmap(document.getElementById('cmp-svg-b'), sb.days, false, null);
}

function fullRender() {
  const stu  = students[activeIdx];
  const days = stu.days;
  const st   = calcStats(days);

  renderStudentList();
  renderStats(days);

  // PA badge visibility
  document.getElementById('pa-badge').style.display = st.pct < 90 ? '' : 'none';
  document.getElementById('hm-title').textContent   = stu.name + ' - Academic Year 2025/26';
  const hb = document.getElementById('hm-badge');
  hb.className = 'badge' + (st.pct < 85 ? ' red' : st.pct < 90 ? ' amber' : '');

  // Heatmap with click cycling
  renderHeatmap(document.getElementById('heatmap-svg'), days, true, function (day, rect) {
    const ci  = CYCLE.indexOf(day.status);
    day.status = CYCLE[(ci + 1) % CYCLE.length];
    rect.setAttribute('fill',   COL[day.status]);
    rect.setAttribute('stroke', day.status === S.P ? 'none' : 'rgba(0,0,0,.1)');
    fullRender();
  });

  // Compare / single toggle
  const cmpGrid = document.getElementById('cmp-grid');
  const hmPanel = document.getElementById('hm-panel');
  if (compareMode) {
    cmpGrid.style.display = '';
    hmPanel.style.display = 'none';
    renderCompare();
  } else {
    cmpGrid.style.display = 'none';
    hmPanel.style.display = '';
  }

  // Charts and matrix
  renderDow(document.getElementById('dow-svg'), days);
  renderSession(document.getElementById('ses-svg'), days);
  renderMatrix(document.getElementById('mat-svg'), days);
  renderPatterns(days, stu);
}

// ===================================================
// EVENT HANDLERS
// ===================================================

function selStudent(idx) {
  if (compareMode) {
    if (idx !== activeIdx) cmpIdx = idx;
  } else {
    activeIdx = idx;
  }
  fullRender();
}

document.getElementById('btn-compare').addEventListener('click', function () {
  compareMode = !compareMode;
  const btn = document.getElementById('btn-compare');
  btn.classList.toggle('on', compareMode);
  btn.textContent = compareMode ? 'Exit Compare Mode' : 'Compare Mode';
  if (compareMode && cmpIdx === activeIdx) {
    cmpIdx = (activeIdx + 1) % students.length;
  }
  fullRender();
});

document.getElementById('btn-reset').addEventListener('click', function () {
  students = buildStudents();
  fullRender();
});

document.getElementById('btn-pa').addEventListener('click', function () {
  showPA = !showPA;
  const btn = document.getElementById('btn-pa');
  btn.textContent = '90% PA Line: ' + (showPA ? 'ON' : 'OFF');
  btn.classList.toggle('on', showPA);
  fullRender();
});

// Redraw charts on resize
let resizeTimer;
window.addEventListener('resize', function () {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(fullRender, 130);
});

// ===================================================
// INITIALISE
// ===================================================

fullRender();
</script>
</body>
</html>
