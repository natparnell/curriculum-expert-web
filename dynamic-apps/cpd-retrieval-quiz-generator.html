<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retrieval Practice Quiz Generator</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--pri:#6C5CE7;--pri-light:#a29bfe;--pri-dark:#5a4bd1;
--acc:#00CECE;--acc-light:#81ecec;--acc-dark:#00b5b5;
--hot:#FF6B6B;--hot-light:#ff9f9f;
--sun:#FDCB6E;--sun-light:#ffeaa7;
--grn:#00B894;--grn-light:#55efc4;
--bg:#f8f9fd;--card:#fff;--txt:#2d3436;--txt2:#636e72;--brd:#e0e3eb;
--radius:14px;--shadow:0 4px 24px rgba(108,92,231,.10);
--font:'Segoe UI',system-ui,-apple-system,sans-serif;
}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--txt);min-height:100vh;line-height:1.6}
a{color:var(--pri);text-decoration:none}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
input,textarea,select{font-family:inherit;outline:none}

/* ── HEADER ── */
.app-header{background:linear-gradient(135deg,var(--pri),#8b7cf8);padding:20px 32px;color:#fff;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(108,92,231,.25)}
.app-header h1{font-size:1.55rem;font-weight:800;letter-spacing:-.3px;display:flex;align-items:center;gap:10px}
.app-header h1 .icon{width:36px;height:36px;background:rgba(255,255,255,.2);border-radius:10px;display:grid;place-items:center;font-size:1.2rem}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border-radius:10px;font-size:.875rem;font-weight:600;transition:all .2s}
.btn-white{background:rgba(255,255,255,.2);color:#fff;backdrop-filter:blur(4px)}
.btn-white:hover{background:rgba(255,255,255,.35)}
.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--pri-dark)}
.btn-acc{background:var(--acc);color:#fff}.btn-acc:hover{background:var(--acc-dark)}
.btn-hot{background:var(--hot);color:#fff}.btn-hot:hover{background:#e05555}
.btn-grn{background:var(--grn);color:#fff}.btn-grn:hover{background:#00a381}
.btn-sun{background:var(--sun);color:var(--txt)}.btn-sun:hover{background:#f0be5e}
.btn-outline{background:transparent;border:2px solid var(--brd);color:var(--txt2)}.btn-outline:hover{border-color:var(--pri);color:var(--pri)}
.btn-lg{padding:14px 28px;font-size:1rem;border-radius:12px}
.btn-sm{padding:6px 12px;font-size:.8rem;border-radius:8px}
.btn-icon{width:38px;height:38px;padding:0;display:grid;place-items:center;border-radius:10px}

/* ── LAYOUT ── */
.container{max-width:1200px;margin:0 auto;padding:24px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--brd);overflow:hidden}
.card-header{padding:18px 24px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.card-header h2{font-size:1.15rem;font-weight:700;display:flex;align-items:center;gap:8px}
.card-body{padding:24px}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:700}
.badge-pri{background:rgba(108,92,231,.12);color:var(--pri)}
.badge-acc{background:rgba(0,206,206,.12);color:var(--acc-dark)}
.badge-hot{background:rgba(255,107,107,.12);color:var(--hot)}
.badge-grn{background:rgba(0,184,148,.12);color:var(--grn)}

/* ── FORM ── */
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:.875rem;font-weight:700;margin-bottom:6px;color:var(--txt)}
.form-group .hint{font-size:.78rem;color:var(--txt2);margin-bottom:6px}
input[type=text],input[type=number],select,textarea{width:100%;padding:11px 14px;border:2px solid var(--brd);border-radius:10px;font-size:.95rem;transition:border-color .2s;background:#fff}
input:focus,select:focus,textarea:focus{border-color:var(--pri)}
textarea{resize:vertical;min-height:120px;line-height:1.7}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}

/* ── TABS ── */
.tabs{display:flex;gap:4px;padding:4px;background:var(--bg);border-radius:12px;overflow-x:auto;flex-wrap:nowrap}
.tab{padding:10px 18px;border-radius:10px;font-size:.85rem;font-weight:600;color:var(--txt2);white-space:nowrap;transition:all .2s;flex-shrink:0}
.tab:hover{color:var(--pri);background:rgba(108,92,231,.06)}
.tab.active{background:var(--pri);color:#fff;box-shadow:0 2px 12px rgba(108,92,231,.25)}
.tab-panel{display:none}.tab-panel.active{display:block}

/* ── FLASHCARDS ── */
.fc-container{display:flex;flex-direction:column;align-items:center;gap:20px;padding:20px}
.fc-card-wrap{perspective:800px;width:100%;max-width:600px;height:320px;cursor:pointer}
.fc-card{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .5s}
.fc-card.flipped{transform:rotateY(180deg)}
.fc-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;text-align:center;font-size:1.35rem;font-weight:600;line-height:1.5}
.fc-front{background:linear-gradient(135deg,var(--pri),#8b7cf8);color:#fff}
.fc-back{background:linear-gradient(135deg,var(--acc),#5be8e8);color:#fff;transform:rotateY(180deg)}
.fc-label{position:absolute;top:16px;left:20px;font-size:.75rem;font-weight:700;opacity:.7;text-transform:uppercase;letter-spacing:1px}
.fc-counter{font-size:.9rem;font-weight:600;color:var(--txt2)}
.fc-nav{display:flex;gap:10px;align-items:center}
.fc-mode{display:flex;align-items:center;gap:8px;font-size:.85rem;color:var(--txt2)}
.fc-mode label{cursor:pointer;font-weight:600}

/* ── FILL THE GAP ── */
.ftg-item{background:var(--bg);border-radius:12px;padding:18px 20px;margin-bottom:14px;border:2px solid transparent;transition:border-color .2s}
.ftg-item.correct{border-color:var(--grn);background:rgba(0,184,148,.06)}
.ftg-item.wrong{border-color:var(--hot);background:rgba(255,107,107,.06)}
.ftg-text{font-size:1.05rem;line-height:1.8;margin-bottom:10px}
.ftg-text .gap{display:inline-flex;align-items:center;border-bottom:2px dashed var(--pri);min-width:100px;padding:2px 4px;margin:0 2px}
.ftg-text .gap input{border:none;background:transparent;font-size:1rem;font-weight:600;color:var(--pri);width:100%;outline:none;text-align:center}
.ftg-text .gap.correct-gap{border-color:var(--grn)}.ftg-text .gap.correct-gap input{color:var(--grn)}
.ftg-text .gap.wrong-gap{border-color:var(--hot)}.ftg-text .gap.wrong-gap input{color:var(--hot)}
.ftg-answer{font-size:.85rem;color:var(--grn);font-weight:600;margin-top:6px;display:none}
.ftg-item.checked .ftg-answer{display:block}
.score-bar{display:flex;align-items:center;gap:12px;padding:14px 20px;background:var(--bg);border-radius:12px;margin-bottom:16px}
.score-bar .score-num{font-size:1.4rem;font-weight:800;color:var(--pri)}
.score-bar .score-label{font-size:.85rem;color:var(--txt2)}
.score-fill{flex:1;height:8px;background:var(--brd);border-radius:4px;overflow:hidden}
.score-fill-inner{height:100%;background:linear-gradient(90deg,var(--pri),var(--acc));border-radius:4px;transition:width .4s}

/* ── MCQ ── */
.mcq-item{margin-bottom:24px}
.mcq-q{font-size:1.05rem;font-weight:700;margin-bottom:12px;padding-left:4px}
.mcq-opts{display:grid;gap:8px}
.mcq-opt{padding:12px 16px;border:2px solid var(--brd);border-radius:10px;font-size:.95rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px}
.mcq-opt:hover{border-color:var(--pri-light);background:rgba(108,92,231,.04)}
.mcq-opt .letter{width:28px;height:28px;border-radius:50%;background:var(--bg);display:grid;place-items:center;font-weight:700;font-size:.8rem;flex-shrink:0;transition:all .2s}
.mcq-opt.selected{border-color:var(--pri);background:rgba(108,92,231,.06)}
.mcq-opt.selected .letter{background:var(--pri);color:#fff}
.mcq-opt.correct-opt{border-color:var(--grn);background:rgba(0,184,148,.08)}
.mcq-opt.correct-opt .letter{background:var(--grn);color:#fff}
.mcq-opt.wrong-opt{border-color:var(--hot);background:rgba(255,107,107,.08)}
.mcq-opt.wrong-opt .letter{background:var(--hot);color:#fff}
.mcq-opt.disabled{pointer-events:none}

/* ── MATCH UP ── */
.match-container{display:flex;gap:40px;justify-content:center;flex-wrap:wrap;padding:20px;position:relative}
.match-col{display:flex;flex-direction:column;gap:12px;min-width:200px;flex:1;max-width:340px}
.match-col h3{font-size:.85rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--txt2);margin-bottom:4px;text-align:center}
.match-item{padding:14px 18px;border-radius:10px;font-size:.95rem;cursor:pointer;transition:all .2s;text-align:center;font-weight:500;user-select:none}
.match-term{background:rgba(108,92,231,.08);border:2px solid rgba(108,92,231,.2);color:var(--pri-dark)}
.match-term:hover,.match-term.selected{background:var(--pri);color:#fff;border-color:var(--pri);box-shadow:0 4px 16px rgba(108,92,231,.3)}
.match-def{background:rgba(0,206,206,.08);border:2px solid rgba(0,206,206,.2);color:var(--acc-dark)}
.match-def:hover,.match-def.selected{background:var(--acc);color:#fff;border-color:var(--acc);box-shadow:0 4px 16px rgba(0,206,206,.3)}
.match-item.matched{opacity:.5;pointer-events:none;border-style:dashed}
.match-item.correct-m{border-color:var(--grn)!important;background:rgba(0,184,148,.12)!important;color:var(--grn)!important}
.match-item.wrong-m{border-color:var(--hot)!important;background:rgba(255,107,107,.12)!important;color:var(--hot)!important}
.match-lines-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:2}

/* ── SEQUENCING ── */
.seq-list{max-width:600px;margin:0 auto;display:flex;flex-direction:column;gap:8px}
.seq-item{padding:16px 20px;background:var(--bg);border:2px solid var(--brd);border-radius:10px;cursor:grab;font-size:1rem;display:flex;align-items:center;gap:12px;transition:all .2s;user-select:none}
.seq-item:active{cursor:grabbing;box-shadow:0 6px 24px rgba(0,0,0,.12)}
.seq-item .seq-handle{color:var(--txt2);font-size:1.1rem;flex-shrink:0}
.seq-item.dragging{opacity:.4;border-style:dashed}
.seq-item.drag-over{border-color:var(--pri);background:rgba(108,92,231,.05)}
.seq-item.correct-s{border-color:var(--grn);background:rgba(0,184,148,.06)}
.seq-item.wrong-s{border-color:var(--hot);background:rgba(255,107,107,.06)}
.seq-num{width:28px;height:28px;border-radius:50%;background:var(--pri);color:#fff;display:grid;place-items:center;font-size:.8rem;font-weight:700;flex-shrink:0}

/* ── BRAIN DUMP ── */
.bd-timer{font-size:3rem;font-weight:800;color:var(--pri);text-align:center;margin:10px 0;font-variant-numeric:tabular-nums}
.bd-timer.urgent{color:var(--hot);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.bd-textarea{width:100%;min-height:250px;padding:20px;border:2px solid var(--brd);border-radius:12px;font-size:1.05rem;line-height:1.8;resize:vertical}
.bd-textarea:focus{border-color:var(--pri)}
.bd-review-item{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;border-radius:10px;margin-bottom:8px;background:var(--bg)}
.bd-review-item .bd-check{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;font-size:1rem;cursor:pointer;flex-shrink:0;transition:all .2s}
.bd-check.yes{background:var(--grn);color:#fff}
.bd-check.no{background:var(--brd);color:var(--txt2)}
.bd-check.no:hover{background:var(--hot-light)}

/* ── TOPIC BANK ── */
.tb-list{display:grid;gap:10px}
.tb-item{display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:10px;background:var(--bg);border:1px solid var(--brd);transition:all .2s}
.tb-item:hover{border-color:var(--pri-light)}
.tb-item .tb-name{font-weight:700;flex:1}
.tb-item .tb-sub{font-size:.8rem;color:var(--txt2)}
.tb-item .tb-count{font-size:.78rem;color:var(--txt2)}

/* ── FULLSCREEN ── */
.fullscreen-overlay{display:none;position:fixed;inset:0;background:#fff;z-index:9999;overflow-y:auto}
.fullscreen-overlay.show{display:block}
.fullscreen-overlay .fs-toolbar{position:fixed;top:0;left:0;right:0;background:var(--pri);color:#fff;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;z-index:10}
.fullscreen-overlay .fs-content{padding:70px 32px 32px;max-width:900px;margin:0 auto;font-size:1.2rem}

/* ── INTERLEAVE TOGGLE ── */
.toggle-wrap{display:flex;align-items:center;gap:10px}
.toggle{width:48px;height:26px;border-radius:13px;background:var(--brd);position:relative;cursor:pointer;transition:background .2s}
.toggle.on{background:var(--pri)}
.toggle::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;background:#fff;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.15)}
.toggle.on::after{transform:translateX(22px)}

/* ── MODAL ── */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;place-items:center;backdrop-filter:blur(2px)}
.modal-bg.show{display:grid}
.modal{background:#fff;border-radius:var(--radius);width:90%;max-width:600px;max-height:85vh;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.2)}
.modal-head{padding:18px 24px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between}
.modal-head h2{font-size:1.1rem;font-weight:700}
.modal-body{padding:24px}
.modal-foot{padding:14px 24px;border-top:1px solid var(--brd);display:flex;justify-content:flex-end;gap:8px}

/* ── MISC ── */
.empty-state{text-align:center;padding:40px 20px;color:var(--txt2)}
.empty-state .empty-icon{font-size:2.5rem;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:1rem}
.divider{height:1px;background:var(--brd);margin:20px 0}
.tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.75rem;font-weight:600}
.mt-12{margin-top:12px}.mb-12{margin-bottom:12px}.mt-20{margin-top:20px}
.text-center{text-align:center}
.flex-center{display:flex;align-items:center;justify-content:center;gap:8px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:700px){.grid-2{grid-template-columns:1fr}}

/* ── PRINT ── */
@media print{
.app-header,.tabs,.btn,.toggle-wrap,.no-print{display:none!important}
.card{box-shadow:none;border:1px solid #ccc;break-inside:avoid;margin-bottom:16px}
.tab-panel{display:block!important}
body{background:#fff}
}
.print-section{display:none}
@media print{.print-section{display:block}.no-print{display:none!important}}
</style>
</head>
<body>

<!-- ════ HEADER ════ -->
<header class="app-header">
  <h1><span class="icon">&#9889;</span> Retrieval Practice Quiz Generator</h1>
  <div class="header-actions">
    <button class="btn btn-white" onclick="openTopicBank()">&#128218; Topic Bank</button>
    <button class="btn btn-white" onclick="printActivities()">&#128424; Print</button>
  </div>
</header>

<div class="container" id="mainContainer">

  <!-- ════ INPUT SECTION ════ -->
  <div class="card mb-12" id="inputCard">
    <div class="card-header">
      <h2>&#128221; Create a New Topic</h2>
      <div class="toggle-wrap no-print">
        <span style="font-size:.85rem;font-weight:600;color:var(--txt2)">Interleave with past topics</span>
        <div class="toggle" id="interleaveToggle" onclick="toggleInterleave()" title="Mix questions from previous topics"></div>
      </div>
    </div>
    <div class="card-body">
      <div class="form-row">
        <div class="form-group">
          <label>Topic Name</label>
          <input type="text" id="topicName" placeholder='e.g. "The Cold War", "Photosynthesis"'>
        </div>
        <div class="form-group">
          <label>Subject</label>
          <select id="subjectSelect">
            <option value="">-- Select Subject --</option>
            <option>Maths</option><option>English</option><option>Science</option>
            <option>Geography</option><option>History</option><option>RE</option>
            <option>MFL</option><option>Other</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Key Facts <span class="badge badge-pri">5 - 20 items</span></label>
        <div class="hint">Enter one fact per line. These will be used to generate all activities.</div>
        <textarea id="factsInput" rows="8" placeholder="The Berlin Wall fell in 1989&#10;The Cold War lasted from 1947 to 1991&#10;NATO was formed in 1949&#10;The Cuban Missile Crisis was in 1962&#10;Mikhail Gorbachev introduced glasnost and perestroika"></textarea>
      </div>
      <div class="form-group">
        <label>Key Terms <span class="badge badge-acc">Optional</span></label>
        <div class="hint">Enter one per line in format: <strong>term | definition</strong></div>
        <textarea id="termsInput" rows="5" placeholder="Glasnost | A policy of openness and transparency in government&#10;Perestroika | Restructuring of the Soviet political and economic system&#10;Detente | The easing of hostility between nations"></textarea>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-pri btn-lg" onclick="generateActivities()">&#9889; Generate Activities</button>
        <button class="btn btn-outline btn-lg" onclick="clearForm()">Clear</button>
      </div>
      <div id="inputError" style="color:var(--hot);font-size:.88rem;font-weight:600;margin-top:10px;display:none"></div>
    </div>
  </div>

  <!-- ════ ACTIVITIES SECTION ════ -->
  <div id="activitiesSection" style="display:none">
    <div class="card">
      <div class="card-header" style="flex-direction:column;align-items:stretch;gap:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
          <h2 id="activitiesTitle">&#127919; Activities: <span id="activitiesTopicName"></span></h2>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn btn-outline btn-sm" onclick="scrollToInput()">&#9998; Edit Topic</button>
            <button class="btn btn-outline btn-sm" onclick="saveTopic()">&#128190; Save to Bank</button>
          </div>
        </div>
        <div class="tabs" id="activityTabs">
          <button class="tab active" data-tab="flashcards" onclick="switchTab('flashcards')">&#127183; Flashcards</button>
          <button class="tab" data-tab="fillgap" onclick="switchTab('fillgap')">&#9999;&#65039; Fill the Gap</button>
          <button class="tab" data-tab="mcq" onclick="switchTab('mcq')">&#127912; Multiple Choice</button>
          <button class="tab" data-tab="matchup" onclick="switchTab('matchup')">&#128279; Match Up</button>
          <button class="tab" data-tab="sequence" onclick="switchTab('sequence')">&#128290; Sequencing</button>
          <button class="tab" data-tab="braindump" onclick="switchTab('braindump')">&#129504; Brain Dump</button>
        </div>
      </div>
      <div class="card-body" id="activityBody">

        <!-- FLASHCARDS -->
        <div class="tab-panel active" id="panel-flashcards"></div>

        <!-- FILL THE GAP -->
        <div class="tab-panel" id="panel-fillgap"></div>

        <!-- MCQ -->
        <div class="tab-panel" id="panel-mcq"></div>

        <!-- MATCH UP -->
        <div class="tab-panel" id="panel-matchup"></div>

        <!-- SEQUENCING -->
        <div class="tab-panel" id="panel-sequence"></div>

        <!-- BRAIN DUMP -->
        <div class="tab-panel" id="panel-braindump"></div>

      </div>
    </div>
  </div>
</div>

<!-- ════ FULLSCREEN OVERLAY ════ -->
<div class="fullscreen-overlay" id="fullscreenOverlay">
  <div class="fs-toolbar">
    <span id="fsTitle" style="font-weight:700"></span>
    <button class="btn btn-white btn-sm" onclick="exitFullscreen()">&#10005; Exit Full Screen</button>
  </div>
  <div class="fs-content" id="fsContent"></div>
</div>

<!-- ════ TOPIC BANK MODAL ════ -->
<div class="modal-bg" id="topicBankModal">
  <div class="modal">
    <div class="modal-head">
      <h2>&#128218; Topic Bank</h2>
      <button class="btn btn-sm btn-outline" onclick="closeTopicBank()">&#10005;</button>
    </div>
    <div class="modal-body" id="topicBankBody"></div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════
   STATE
   ═══════════════════════════════════════ */
let currentTopic = null;  // {name, subject, facts[], terms[{term,def}]}
let interleaveOn = false;
const LS_KEY = 'rpqg_topics';

function getTopicBank() {
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
  catch { return []; }
}
function saveTopicBank(bank) { localStorage.setItem(LS_KEY, JSON.stringify(bank)); }

/* ═══════════════════════════════════════
   INPUT & VALIDATION
   ═══════════════════════════════════════ */
function showError(msg) {
  const el = document.getElementById('inputError');
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

function parseFacts(text) {
  return text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
}
function parseTerms(text) {
  return text.split('\n').map(l => l.trim()).filter(l => l.includes('|')).map(l => {
    const [t, ...d] = l.split('|');
    return { term: t.trim(), def: d.join('|').trim() };
  }).filter(t => t.term && t.def);
}

function clearForm() {
  document.getElementById('topicName').value = '';
  document.getElementById('subjectSelect').value = '';
  document.getElementById('factsInput').value = '';
  document.getElementById('termsInput').value = '';
}

function scrollToInput() {
  document.getElementById('inputCard').scrollIntoView({ behavior: 'smooth' });
}

/* ═══════════════════════════════════════
   GENERATE
   ═══════════════════════════════════════ */
function generateActivities() {
  const name = document.getElementById('topicName').value.trim();
  const subject = document.getElementById('subjectSelect').value;
  const facts = parseFacts(document.getElementById('factsInput').value);
  const terms = parseTerms(document.getElementById('termsInput').value);

  if (!name) return showError('Please enter a topic name.');
  if (!subject) return showError('Please select a subject.');
  if (facts.length < 5) return showError('Please enter at least 5 key facts.');
  if (facts.length > 20) return showError('Please enter no more than 20 key facts.');

  currentTopic = { name, subject, facts, terms, created: Date.now() };

  document.getElementById('activitiesTopicName').textContent = name;
  document.getElementById('activitiesSection').style.display = 'block';

  // Gather interleaved facts
  let extraFacts = [];
  if (interleaveOn) {
    const bank = getTopicBank();
    bank.forEach(t => {
      if (t.name !== name) {
        const picked = shuffle([...t.facts]).slice(0, 3);
        extraFacts.push(...picked.map(f => ({ fact: f, from: t.name })));
      }
    });
    extraFacts = shuffle(extraFacts).slice(0, Math.min(6, extraFacts.length));
  }

  buildFlashcards(currentTopic, extraFacts);
  buildFillGap(currentTopic, extraFacts);
  buildMCQ(currentTopic, extraFacts);
  buildMatchUp(currentTopic);
  buildSequence(currentTopic);
  buildBrainDump(currentTopic);

  switchTab('flashcards');
  document.getElementById('activitiesSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ═══════════════════════════════════════
   UTILITIES
   ═══════════════════════════════════════ */
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function extractKeyWords(fact) {
  const words = fact.split(/\s+/);
  // Find "important" words: numbers, capitalised, long words
  let candidates = [];
  words.forEach((w, i) => {
    const clean = w.replace(/[^a-zA-Z0-9]/g, '');
    if (!clean) return;
    const isNum = /\d/.test(clean);
    const isCap = clean[0] === clean[0].toUpperCase() && i > 0 && clean.length > 2;
    const isLong = clean.length >= 6;
    if (isNum || isCap || isLong) candidates.push({ word: w, index: i, score: (isNum?3:0)+(isCap?2:0)+(isLong?1:0) });
  });
  candidates.sort((a, b) => b.score - a.score);
  if (candidates.length === 0) {
    // fallback: pick words > 3 chars
    words.forEach((w, i) => {
      if (w.replace(/[^a-zA-Z]/g,'').length > 3 && i > 0) candidates.push({ word: w, index: i, score: 1 });
    });
    candidates.sort((a,b) => b.score - a.score);
  }
  return candidates.slice(0, 2);
}

function factToQuestion(fact) {
  // Simple heuristic: turn fact into a question by blanking the key element
  const kw = extractKeyWords(fact);
  if (kw.length === 0) return { q: 'What is this fact?', a: fact };
  const target = kw[0];
  const clean = target.word.replace(/[^a-zA-Z0-9\s]/g, '');
  const q = fact.replace(target.word, '______');
  return { q: q + ' ?', a: clean, full: fact };
}

/* ═══════════════════════════════════════
   TABS
   ═══════════════════════════════════════ */
function switchTab(id) {
  document.querySelectorAll('#activityTabs .tab').forEach(t => t.classList.toggle('active', t.dataset.tab === id));
  document.querySelectorAll('#activityBody .tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + id));
}

/* ═══════════════════════════════════════
   1. FLASHCARDS
   ═══════════════════════════════════════ */
let fcCards = [], fcIndex = 0, fcReverse = false;

function buildFlashcards(topic, extra) {
  fcCards = topic.facts.map(f => {
    const kw = extractKeyWords(f);
    if (kw.length > 0) {
      const answer = kw[0].word.replace(/[^a-zA-Z0-9\s]/g,'');
      const question = f.replace(kw[0].word, '______');
      return { q: question, a: answer, full: f, from: topic.name };
    }
    return { q: 'Recall this fact about ' + topic.name + ':', a: f, full: f, from: topic.name };
  });
  // Add terms as flashcards
  topic.terms.forEach(t => {
    fcCards.push({ q: 'Define: ' + t.term, a: t.def, full: t.term + ' - ' + t.def, from: topic.name });
  });
  // Add interleaved
  extra.forEach(e => {
    const kw = extractKeyWords(e.fact);
    if (kw.length > 0) {
      fcCards.push({ q: e.fact.replace(kw[0].word, '______'), a: kw[0].word.replace(/[^a-zA-Z0-9\s]/g,''), full: e.fact, from: e.from });
    }
  });

  fcIndex = 0;
  renderFlashcard();
}

function renderFlashcard() {
  if (fcCards.length === 0) return;
  const c = fcCards[fcIndex];
  const front = fcReverse ? c.a : c.q;
  const back = fcReverse ? c.q : c.a;
  const frontLabel = fcReverse ? 'Answer' : 'Question';
  const backLabel = fcReverse ? 'Question' : 'Answer';
  const fromBadge = c.from !== (currentTopic && currentTopic.name) ?
    `<span class="badge badge-hot" style="position:absolute;top:16px;right:20px;font-size:.7rem">Interleaved: ${escHtml(c.from)}</span>` : '';

  document.getElementById('panel-flashcards').innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
      <div class="fc-mode">
        <label><input type="checkbox" id="fcReverseCheck" ${fcReverse?'checked':''} onchange="fcReverse=this.checked;renderFlashcard()"> Reverse mode (Answer first)</label>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-outline btn-sm" onclick="fcCards=shuffle(fcCards);fcIndex=0;renderFlashcard()">&#128256; Shuffle</button>
        <button class="btn btn-outline btn-sm" onclick="fcIndex=0;renderFlashcard()">&#8634; Reset</button>
        <button class="btn btn-pri btn-sm" onclick="openFsFlashcards()">&#9974; Full Screen</button>
      </div>
    </div>
    <div class="fc-container">
      <div class="fc-card-wrap" onclick="document.querySelector('.fc-card').classList.toggle('flipped')">
        <div class="fc-card" id="fcCard">
          <div class="fc-face fc-front">
            <span class="fc-label">${frontLabel}</span>
            ${fromBadge}
            <span>${escHtml(front)}</span>
          </div>
          <div class="fc-face fc-back">
            <span class="fc-label">${backLabel}</span>
            <span>${escHtml(back)}</span>
          </div>
        </div>
      </div>
      <div class="fc-nav">
        <button class="btn btn-outline btn-icon" onclick="fcPrev()" ${fcIndex===0?'disabled':''}>&larr;</button>
        <span class="fc-counter">${fcIndex+1} / ${fcCards.length}</span>
        <button class="btn btn-outline btn-icon" onclick="fcNext()" ${fcIndex===fcCards.length-1?'disabled':''}>&rarr;</button>
      </div>
    </div>`;
}
function fcPrev() { if (fcIndex > 0) { fcIndex--; renderFlashcard(); } }
function fcNext() { if (fcIndex < fcCards.length - 1) { fcIndex++; renderFlashcard(); } }

/* ═══════════════════════════════════════
   2. FILL THE GAP
   ═══════════════════════════════════════ */
let ftgItems = [], ftgScore = 0, ftgChecked = 0;

function buildFillGap(topic, extra) {
  ftgItems = [];
  const allFacts = [...topic.facts.map(f => ({ fact: f, from: topic.name })), ...extra.map(e => ({ fact: e.fact, from: e.from }))];

  allFacts.forEach((item, idx) => {
    const kws = extractKeyWords(item.fact);
    if (kws.length === 0) return;
    const gaps = kws.slice(0, 2);
    let display = item.fact;
    const answers = [];
    gaps.forEach((g, gi) => {
      const clean = g.word.replace(/[^a-zA-Z0-9\s]/g, '');
      answers.push(clean);
      display = display.replace(g.word, `<span class="gap" data-idx="${idx}" data-gi="${gi}" data-answer="${escHtml(clean)}"><input type="text" autocomplete="off" spellcheck="false" style="width:${Math.max(80, clean.length*12)}px"></span>`);
    });
    ftgItems.push({ html: display, answers, from: item.from });
  });

  ftgScore = 0; ftgChecked = 0;
  renderFillGap();
}

function renderFillGap() {
  const total = ftgItems.reduce((s, it) => s + it.answers.length, 0);
  const pct = total > 0 ? Math.round(ftgScore / total * 100) : 0;
  let html = `
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
      <div class="score-bar" style="flex:1;min-width:200px">
        <div class="score-num">${ftgScore}/${total}</div>
        <div class="score-fill"><div class="score-fill-inner" style="width:${pct}%"></div></div>
        <div class="score-label">${pct}%</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-grn btn-sm" onclick="checkAllFtg()">&#10003; Check All</button>
        <button class="btn btn-outline btn-sm" onclick="buildFillGap(currentTopic,interleaveOn?getInterleaved():[]);renderFillGap()">&#8634; Reset</button>
        <button class="btn btn-pri btn-sm" onclick="openFsActivity('fillgap')">&#9974; Full Screen</button>
      </div>
    </div>`;

  ftgItems.forEach((item, i) => {
    const fromBadge = item.from !== currentTopic.name ? `<span class="badge badge-hot" style="margin-left:8px;font-size:.7rem">From: ${escHtml(item.from)}</span>` : '';
    html += `<div class="ftg-item" id="ftg-${i}">
      <div class="ftg-text">${item.html}${fromBadge}</div>
      <div class="ftg-answer" id="ftg-ans-${i}"></div>
    </div>`;
  });

  document.getElementById('panel-fillgap').innerHTML = html;
}

function checkAllFtg() {
  ftgScore = 0; ftgChecked = ftgItems.length;
  ftgItems.forEach((item, i) => {
    const el = document.getElementById('ftg-' + i);
    const gaps = el.querySelectorAll('.gap');
    let allCorrect = true;
    gaps.forEach((g) => {
      const input = g.querySelector('input');
      const ans = g.dataset.answer;
      if (input.value.trim().toLowerCase() === ans.toLowerCase()) {
        g.classList.add('correct-gap');
        ftgScore++;
      } else {
        g.classList.add('wrong-gap');
        allCorrect = false;
      }
      input.disabled = true;
    });
    el.classList.add(allCorrect ? 'correct' : 'wrong', 'checked');
    document.getElementById('ftg-ans-' + i).textContent = 'Answer: ' + item.answers.join(', ');
  });
  renderFillGapScore();
}

function renderFillGapScore() {
  const total = ftgItems.reduce((s, it) => s + it.answers.length, 0);
  const pct = total > 0 ? Math.round(ftgScore / total * 100) : 0;
  const scoreBar = document.querySelector('#panel-fillgap .score-bar');
  if (scoreBar) {
    scoreBar.querySelector('.score-num').textContent = `${ftgScore}/${total}`;
    scoreBar.querySelector('.score-fill-inner').style.width = pct + '%';
    scoreBar.querySelector('.score-label').textContent = pct + '%';
  }
}

/* ═══════════════════════════════════════
   3. MULTIPLE CHOICE
   ═══════════════════════════════════════ */
let mcqItems = [], mcqScore = 0, mcqAnswered = 0;

function buildMCQ(topic, extra) {
  mcqItems = [];
  const allFacts = [...topic.facts.map(f => ({ fact: f, from: topic.name })), ...extra.map(e => ({ fact: e.fact, from: e.from }))];

  allFacts.forEach((item, idx) => {
    const kws = extractKeyWords(item.fact);
    if (kws.length === 0) return;
    const target = kws[0];
    const correctAnswer = target.word.replace(/[^a-zA-Z0-9\s]/g, '');
    const question = item.fact.replace(target.word, '______');

    // Generate distractors from other facts' keywords
    let distractors = [];
    allFacts.forEach((other, oi) => {
      if (oi === idx) return;
      const okws = extractKeyWords(other.fact);
      okws.forEach(ok => {
        const d = ok.word.replace(/[^a-zA-Z0-9\s]/g, '');
        if (d.toLowerCase() !== correctAnswer.toLowerCase() && d.length > 1 && !distractors.includes(d)) {
          distractors.push(d);
        }
      });
    });

    // If not enough distractors, add generic ones
    const generics = ['Unknown', 'None of the above', 'All of the above', 'Not applicable'];
    while (distractors.length < 3) {
      const g = generics.shift();
      if (g && !distractors.includes(g)) distractors.push(g);
      if (!g) break;
    }

    distractors = shuffle(distractors).slice(0, 3);
    const options = shuffle([correctAnswer, ...distractors]);
    mcqItems.push({ question: question + ' ?', correct: correctAnswer, options, from: item.from });
  });

  mcqScore = 0; mcqAnswered = 0;
  renderMCQ();
}

function renderMCQ() {
  const total = mcqItems.length;
  const pct = total > 0 ? Math.round(mcqScore / total * 100) : 0;
  const letters = ['A', 'B', 'C', 'D'];

  let html = `
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
      <div class="score-bar" style="flex:1;min-width:200px">
        <div class="score-num" id="mcqScoreNum">${mcqScore}/${total}</div>
        <div class="score-fill"><div class="score-fill-inner" id="mcqScoreFill" style="width:${pct}%"></div></div>
        <div class="score-label" id="mcqScorePct">${pct}%</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-outline btn-sm" onclick="buildMCQ(currentTopic,interleaveOn?getInterleaved():[]);renderMCQ()">&#8634; Reset</button>
        <button class="btn btn-pri btn-sm" onclick="openFsActivity('mcq')">&#9974; Full Screen</button>
      </div>
    </div>`;

  mcqItems.forEach((item, qi) => {
    const fromBadge = item.from !== currentTopic.name ? ` <span class="badge badge-hot" style="font-size:.7rem">From: ${escHtml(item.from)}</span>` : '';
    html += `<div class="mcq-item" id="mcq-${qi}">
      <div class="mcq-q">${qi+1}. ${escHtml(item.question)}${fromBadge}</div>
      <div class="mcq-opts">`;
    item.options.forEach((opt, oi) => {
      html += `<div class="mcq-opt" data-qi="${qi}" data-opt="${escHtml(opt)}" onclick="selectMCQ(${qi},'${escHtml(opt).replace(/'/g, "\\'")}',this)">
        <span class="letter">${letters[oi]}</span><span>${escHtml(opt)}</span>
      </div>`;
    });
    html += `</div></div>`;
  });

  document.getElementById('panel-mcq').innerHTML = html;
}

function selectMCQ(qi, selected, el) {
  const item = mcqItems[qi];
  const container = document.getElementById('mcq-' + qi);
  if (container.classList.contains('answered')) return;
  container.classList.add('answered');
  mcqAnswered++;

  const opts = container.querySelectorAll('.mcq-opt');
  opts.forEach(o => {
    o.classList.add('disabled');
    const optVal = o.dataset.opt;
    if (optVal === item.correct) o.classList.add('correct-opt');
    if (optVal === selected && selected !== item.correct) o.classList.add('wrong-opt');
  });

  if (selected === item.correct) mcqScore++;

  // Update score
  const total = mcqItems.length;
  const pct = Math.round(mcqScore / total * 100);
  const sn = document.getElementById('mcqScoreNum');
  if (sn) { sn.textContent = `${mcqScore}/${total}`; }
  const sf = document.getElementById('mcqScoreFill');
  if (sf) sf.style.width = pct + '%';
  const sp = document.getElementById('mcqScorePct');
  if (sp) sp.textContent = pct + '%';
}

/* ═══════════════════════════════════════
   4. MATCH UP
   ═══════════════════════════════════════ */
let matchPairs = [], matchSelected = null, matchScore = 0, matchTotal = 0;

function buildMatchUp(topic) {
  matchPairs = [];
  // Use terms if available, otherwise derive from facts
  if (topic.terms.length >= 3) {
    matchPairs = topic.terms.map(t => ({ term: t.term, def: t.def }));
  } else {
    // Derive from facts: split each fact into a "key" and "detail"
    topic.facts.slice(0, 10).forEach(f => {
      const kw = extractKeyWords(f);
      if (kw.length > 0) {
        const key = kw[0].word.replace(/[^a-zA-Z0-9\s]/g, '');
        matchPairs.push({ term: key, def: f });
      }
    });
  }
  matchScore = 0;
  matchTotal = matchPairs.length;
  matchSelected = null;
  renderMatchUp();
}

function renderMatchUp() {
  const shuffledTerms = shuffle([...matchPairs]);
  const shuffledDefs = shuffle([...matchPairs]);
  const pct = matchTotal > 0 ? Math.round(matchScore / matchTotal * 100) : 0;

  let html = `
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
      <div class="score-bar" style="flex:1;min-width:200px">
        <div class="score-num" id="matchScoreNum">${matchScore}/${matchTotal}</div>
        <div class="score-fill"><div class="score-fill-inner" id="matchScoreFill" style="width:${pct}%"></div></div>
        <div class="score-label" id="matchScorePct">${pct}%</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-outline btn-sm" onclick="buildMatchUp(currentTopic)">&#8634; Reset</button>
        <button class="btn btn-pri btn-sm" onclick="openFsActivity('matchup')">&#9974; Full Screen</button>
      </div>
    </div>
    <p style="text-align:center;color:var(--txt2);font-size:.88rem;margin-bottom:16px">Click a term, then click its matching definition.</p>
    <div class="match-container" id="matchContainer">
      <div class="match-col" id="matchTermsCol">
        <h3>Terms</h3>
        ${shuffledTerms.map((p, i) => `<div class="match-item match-term" data-term="${escHtml(p.term)}" data-idx="${i}" onclick="selectMatch(this,'term')">${escHtml(p.term)}</div>`).join('')}
      </div>
      <div class="match-col" id="matchDefsCol">
        <h3>Definitions</h3>
        ${shuffledDefs.map((p, i) => `<div class="match-item match-def" data-term="${escHtml(p.term)}" data-idx="${i}" onclick="selectMatch(this,'def')">${escHtml(p.def)}</div>`).join('')}
      </div>
    </div>`;

  document.getElementById('panel-matchup').innerHTML = html;
}

function selectMatch(el, type) {
  if (el.classList.contains('matched')) return;

  if (!matchSelected) {
    el.classList.add('selected');
    matchSelected = { el, type, term: el.dataset.term };
  } else {
    if (matchSelected.type === type) {
      matchSelected.el.classList.remove('selected');
      el.classList.add('selected');
      matchSelected = { el, type, term: el.dataset.term };
      return;
    }

    const term1 = matchSelected.term;
    const term2 = el.dataset.term;

    if (term1 === term2) {
      matchSelected.el.classList.add('matched', 'correct-m');
      matchSelected.el.classList.remove('selected');
      el.classList.add('matched', 'correct-m');
      matchScore++;
    } else {
      matchSelected.el.classList.add('wrong-m');
      matchSelected.el.classList.remove('selected');
      el.classList.add('wrong-m');
      setTimeout(() => {
        matchSelected.el.classList.remove('wrong-m');
        el.classList.remove('wrong-m');
        matchSelected = null;
      }, 800);
      matchSelected = null;
      return;
    }
    matchSelected = null;

    // update score
    const pct = Math.round(matchScore / matchTotal * 100);
    const sn = document.getElementById('matchScoreNum');
    if (sn) sn.textContent = `${matchScore}/${matchTotal}`;
    const sf = document.getElementById('matchScoreFill');
    if (sf) sf.style.width = pct + '%';
    const sp = document.getElementById('matchScorePct');
    if (sp) sp.textContent = pct + '%';
  }
}

/* ═══════════════════════════════════════
   5. SEQUENCING
   ═══════════════════════════════════════ */
let seqItems = [], seqCorrectOrder = [], seqChecked = false;

function buildSequence(topic) {
  seqCorrectOrder = [...topic.facts];
  seqItems = shuffle([...topic.facts]);
  seqChecked = false;
  renderSequence();
}

function renderSequence() {
  let html = `
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
      <p style="color:var(--txt2);font-size:.88rem">Drag items into the correct order (chronological, process steps, etc.)</p>
      <div style="display:flex;gap:6px">
        <button class="btn btn-grn btn-sm" onclick="checkSequence()">&#10003; Check Order</button>
        <button class="btn btn-outline btn-sm" onclick="buildSequence(currentTopic)">&#8634; Reset</button>
        <button class="btn btn-pri btn-sm" onclick="openFsActivity('sequence')">&#9974; Full Screen</button>
      </div>
    </div>
    <div class="seq-list" id="seqList">
      ${seqItems.map((item, i) => `<div class="seq-item" draggable="true" data-seq-idx="${i}" ondragstart="seqDragStart(event)" ondragover="seqDragOver(event)" ondrop="seqDrop(event)" ondragend="seqDragEnd(event)" ondragenter="seqDragEnter(event)" ondragleave="seqDragLeave(event)">
        <span class="seq-handle">&#9776;</span>
        <span class="seq-num">${i+1}</span>
        <span class="seq-text">${escHtml(item)}</span>
      </div>`).join('')}
    </div>`;
  document.getElementById('panel-sequence').innerHTML = html;
  initSeqTouch();
}

let seqDragIdx = null;
function seqDragStart(e) {
  seqDragIdx = +e.target.closest('.seq-item').dataset.seqIdx;
  e.target.closest('.seq-item').classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}
function seqDragOver(e) { e.preventDefault(); }
function seqDragEnter(e) {
  e.preventDefault();
  const item = e.target.closest('.seq-item');
  if (item) item.classList.add('drag-over');
}
function seqDragLeave(e) {
  const item = e.target.closest('.seq-item');
  if (item) item.classList.remove('drag-over');
}
function seqDrop(e) {
  e.preventDefault();
  const dropItem = e.target.closest('.seq-item');
  if (!dropItem) return;
  const dropIdx = +dropItem.dataset.seqIdx;
  if (seqDragIdx === null || seqDragIdx === dropIdx) return;
  const moved = seqItems.splice(seqDragIdx, 1)[0];
  seqItems.splice(dropIdx, 0, moved);
  renderSequence();
}
function seqDragEnd(e) {
  document.querySelectorAll('.seq-item').forEach(el => el.classList.remove('dragging', 'drag-over'));
}

function initSeqTouch() {
  const list = document.getElementById('seqList');
  if (!list) return;
  let touchIdx = null, touchEl = null;
  list.querySelectorAll('.seq-item').forEach(item => {
    item.addEventListener('touchstart', e => {
      touchIdx = +item.dataset.seqIdx;
      touchEl = item;
      item.classList.add('dragging');
    }, { passive: true });
    item.addEventListener('touchmove', e => {
      e.preventDefault();
    }, { passive: false });
    item.addEventListener('touchend', e => {
      if (touchEl) touchEl.classList.remove('dragging');
      const touch = e.changedTouches[0];
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      if (el) {
        const target = el.closest('.seq-item');
        if (target && touchIdx !== null) {
          const dropIdx = +target.dataset.seqIdx;
          if (touchIdx !== dropIdx) {
            const moved = seqItems.splice(touchIdx, 1)[0];
            seqItems.splice(dropIdx, 0, moved);
            renderSequence();
          }
        }
      }
      touchIdx = null; touchEl = null;
    });
  });
}

function checkSequence() {
  seqChecked = true;
  let correct = 0;
  const items = document.querySelectorAll('#seqList .seq-item');
  items.forEach((el, i) => {
    el.classList.remove('correct-s', 'wrong-s');
    if (seqItems[i] === seqCorrectOrder[i]) {
      el.classList.add('correct-s');
      correct++;
    } else {
      el.classList.add('wrong-s');
    }
  });
  const total = seqItems.length;
  const pct = Math.round(correct / total * 100);
  let summaryEl = document.getElementById('seqSummary');
  if (!summaryEl) {
    summaryEl = document.createElement('div');
    summaryEl.id = 'seqSummary';
    summaryEl.className = 'score-bar mt-12';
    document.getElementById('seqList').parentNode.insertBefore(summaryEl, document.getElementById('seqList'));
  }
  summaryEl.innerHTML = `
    <div class="score-num">${correct}/${total}</div>
    <div class="score-fill"><div class="score-fill-inner" style="width:${pct}%"></div></div>
    <div class="score-label">${pct}% correct</div>`;
}

/* ═══════════════════════════════════════
   6. BRAIN DUMP
   ═══════════════════════════════════════ */
let bdTimerInterval = null, bdTimeLeft = 0, bdRunning = false, bdMinutes = 3;

function buildBrainDump(topic) {
  bdRunning = false;
  if (bdTimerInterval) clearInterval(bdTimerInterval);
  renderBrainDump();
}

function renderBrainDump() {
  const panel = document.getElementById('panel-braindump');
  panel.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:10px">
        <label style="font-size:.88rem;font-weight:600">Time (minutes):</label>
        <input type="number" id="bdMinInput" min="1" max="5" value="${bdMinutes}" style="width:60px;padding:6px;text-align:center" onchange="bdMinutes=Math.max(1,Math.min(5,+this.value))">
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-grn btn-sm" id="bdStartBtn" onclick="startBrainDump()">&#9654; Start Challenge</button>
        <button class="btn btn-outline btn-sm" onclick="buildBrainDump(currentTopic)">&#8634; Reset</button>
        <button class="btn btn-pri btn-sm" onclick="openFsActivity('braindump')">&#9974; Full Screen</button>
      </div>
    </div>
    <div id="bdTimerDisplay" class="bd-timer" style="display:none">--:--</div>
    <div id="bdInputArea">
      <p style="color:var(--txt2);font-size:.92rem;margin-bottom:12px;text-align:center">Write down everything you can remember about <strong>${escHtml(currentTopic.name)}</strong>.</p>
      <textarea class="bd-textarea" id="bdTextarea" placeholder="Start typing everything you can remember..." disabled></textarea>
    </div>
    <div id="bdReviewArea" style="display:none"></div>`;
}

function startBrainDump() {
  bdTimeLeft = bdMinutes * 60;
  bdRunning = true;
  document.getElementById('bdTextarea').disabled = false;
  document.getElementById('bdTextarea').focus();
  document.getElementById('bdTimerDisplay').style.display = 'block';
  document.getElementById('bdStartBtn').style.display = 'none';
  document.getElementById('bdMinInput').disabled = true;
  updateBdTimer();
  bdTimerInterval = setInterval(() => {
    bdTimeLeft--;
    updateBdTimer();
    if (bdTimeLeft <= 0) {
      clearInterval(bdTimerInterval);
      endBrainDump();
    }
  }, 1000);
}

function updateBdTimer() {
  const m = Math.floor(bdTimeLeft / 60);
  const s = bdTimeLeft % 60;
  const display = document.getElementById('bdTimerDisplay');
  display.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  display.classList.toggle('urgent', bdTimeLeft <= 30);
}

function endBrainDump() {
  bdRunning = false;
  document.getElementById('bdTextarea').disabled = true;
  document.getElementById('bdTimerDisplay').textContent = "Time's up!";
  document.getElementById('bdTimerDisplay').classList.remove('urgent');

  // Show review
  const review = document.getElementById('bdReviewArea');
  review.style.display = 'block';
  let html = `<div class="divider"></div>
    <h3 style="margin-bottom:12px;font-size:1rem">Self-Assessment: Tick each fact you recalled</h3>
    <div id="bdFactsList">`;
  currentTopic.facts.forEach((f, i) => {
    html += `<div class="bd-review-item" id="bd-fact-${i}">
      <div class="bd-check no" id="bd-check-${i}" onclick="toggleBdCheck(${i})">&#10007;</div>
      <span style="flex:1;font-size:.95rem">${escHtml(f)}</span>
    </div>`;
  });
  html += `</div>
    <div class="score-bar mt-12" id="bdScoreBar">
      <div class="score-num" id="bdScoreNum">0/${currentTopic.facts.length}</div>
      <div class="score-fill"><div class="score-fill-inner" id="bdScoreFill" style="width:0%"></div></div>
      <div class="score-label" id="bdScorePct">0%</div>
    </div>`;
  review.innerHTML = html;
}

function toggleBdCheck(i) {
  const el = document.getElementById('bd-check-' + i);
  const isYes = el.classList.contains('yes');
  el.classList.toggle('yes', !isYes);
  el.classList.toggle('no', isYes);
  el.innerHTML = isYes ? '&#10007;' : '&#10003;';

  // Recount
  let count = 0;
  currentTopic.facts.forEach((_, j) => {
    if (document.getElementById('bd-check-' + j).classList.contains('yes')) count++;
  });
  const total = currentTopic.facts.length;
  const pct = Math.round(count / total * 100);
  document.getElementById('bdScoreNum').textContent = `${count}/${total}`;
  document.getElementById('bdScoreFill').style.width = pct + '%';
  document.getElementById('bdScorePct').textContent = pct + '%';
}

/* ═══════════════════════════════════════
   INTERLEAVE HELPERS
   ═══════════════════════════════════════ */
function toggleInterleave() {
  interleaveOn = !interleaveOn;
  document.getElementById('interleaveToggle').classList.toggle('on', interleaveOn);
}

function getInterleaved() {
  if (!interleaveOn || !currentTopic) return [];
  const bank = getTopicBank();
  let extra = [];
  bank.forEach(t => {
    if (t.name !== currentTopic.name) {
      const picked = shuffle([...t.facts]).slice(0, 3);
      extra.push(...picked.map(f => ({ fact: f, from: t.name })));
    }
  });
  return shuffle(extra).slice(0, 6);
}

/* ═══════════════════════════════════════
   FULLSCREEN
   ═══════════════════════════════════════ */
function openFsFlashcards() {
  const overlay = document.getElementById('fullscreenOverlay');
  document.getElementById('fsTitle').textContent = 'Flashcards - ' + currentTopic.name;
  overlay.classList.add('show');
  renderFsFlashcard();
}

function renderFsFlashcard() {
  const c = fcCards[fcIndex];
  const front = fcReverse ? c.a : c.q;
  const back = fcReverse ? c.q : c.a;
  const frontLabel = fcReverse ? 'Answer' : 'Question';
  const backLabel = fcReverse ? 'Question' : 'Answer';

  document.getElementById('fsContent').innerHTML = `
    <div class="fc-container" style="min-height:70vh;justify-content:center">
      <div class="fc-card-wrap" style="max-width:700px;height:380px" onclick="document.getElementById('fsFcCard').classList.toggle('flipped')">
        <div class="fc-card" id="fsFcCard">
          <div class="fc-face fc-front" style="font-size:1.8rem">
            <span class="fc-label">${frontLabel}</span>
            <span>${escHtml(front)}</span>
          </div>
          <div class="fc-face fc-back" style="font-size:1.8rem">
            <span class="fc-label">${backLabel}</span>
            <span>${escHtml(back)}</span>
          </div>
        </div>
      </div>
      <div class="fc-nav" style="font-size:1.2rem">
        <button class="btn btn-outline btn-icon" style="width:50px;height:50px;font-size:1.3rem" onclick="fcPrev();renderFsFlashcard()" ${fcIndex===0?'disabled':''}>&larr;</button>
        <span class="fc-counter" style="font-size:1.3rem">${fcIndex+1} / ${fcCards.length}</span>
        <button class="btn btn-outline btn-icon" style="width:50px;height:50px;font-size:1.3rem" onclick="fcNext();renderFsFlashcard()" ${fcIndex===fcCards.length-1?'disabled':''}>&rarr;</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-outline btn-sm" onclick="fcCards=shuffle(fcCards);fcIndex=0;renderFsFlashcard()">&#128256; Shuffle</button>
        <label style="font-size:.9rem;display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" ${fcReverse?'checked':''} onchange="fcReverse=this.checked;renderFsFlashcard()"> Reverse mode</label>
      </div>
    </div>`;
}

function openFsActivity(tabId) {
  const overlay = document.getElementById('fullscreenOverlay');
  const names = { fillgap: 'Fill the Gap', mcq: 'Multiple Choice', matchup: 'Match Up', sequence: 'Sequencing', braindump: 'Brain Dump' };
  document.getElementById('fsTitle').textContent = (names[tabId] || tabId) + ' - ' + currentTopic.name;
  overlay.classList.add('show');
  const source = document.getElementById('panel-' + tabId);
  document.getElementById('fsContent').innerHTML = '';
  // Clone content
  const clone = source.cloneNode(true);
  clone.classList.add('active');
  clone.style.display = 'block';
  clone.style.fontSize = '1.1rem';
  document.getElementById('fsContent').appendChild(clone);

  // Re-bind events for MCQ in fullscreen
  if (tabId === 'mcq') {
    clone.querySelectorAll('.mcq-opt').forEach(opt => {
      opt.onclick = function() {
        const qi = +this.dataset.qi;
        selectMCQ(qi, this.dataset.opt, this);
        // Also update the clone
        const container = clone.querySelector('#mcq-' + qi);
        if (container && !container.classList.contains('answered')) {
          container.classList.add('answered');
          const opts = container.querySelectorAll('.mcq-opt');
          const item = mcqItems[qi];
          opts.forEach(o => {
            o.classList.add('disabled');
            if (o.dataset.opt === item.correct) o.classList.add('correct-opt');
            if (o.dataset.opt === this.dataset.opt && this.dataset.opt !== item.correct) o.classList.add('wrong-opt');
          });
        }
      };
    });
  }
}

function exitFullscreen() {
  document.getElementById('fullscreenOverlay').classList.remove('show');
  // Rebuild current tab to restore interactivity
  if (currentTopic) {
    const activeTab = document.querySelector('#activityTabs .tab.active');
    if (activeTab) {
      const tabId = activeTab.dataset.tab;
      if (tabId === 'flashcards') renderFlashcard();
    }
  }
}

/* ═══════════════════════════════════════
   TOPIC BANK
   ═══════════════════════════════════════ */
function saveTopic() {
  if (!currentTopic) return;
  let bank = getTopicBank();
  const existing = bank.findIndex(t => t.name === currentTopic.name);
  if (existing >= 0) {
    bank[existing] = { ...currentTopic };
  } else {
    bank.push({ ...currentTopic });
  }
  saveTopicBank(bank);
  showToast('Topic saved to bank!');
}

function openTopicBank() {
  const bank = getTopicBank();
  const body = document.getElementById('topicBankBody');
  if (bank.length === 0) {
    body.innerHTML = `<div class="empty-state"><div class="empty-icon">&#128218;</div><p>No saved topics yet. Generate activities and save topics to build your bank.</p></div>`;
  } else {
    let html = `<div class="tb-list">`;
    bank.forEach((t, i) => {
      html += `<div class="tb-item">
        <div style="flex:1">
          <div class="tb-name">${escHtml(t.name)}</div>
          <div class="tb-sub">${escHtml(t.subject || 'No subject')} &middot; ${t.facts.length} facts${t.terms.length ? ' &middot; ' + t.terms.length + ' terms' : ''}</div>
        </div>
        <button class="btn btn-pri btn-sm" onclick="loadTopic(${i})">Load</button>
        <button class="btn btn-hot btn-sm" onclick="deleteTopic(${i})">&#128465;</button>
      </div>`;
    });
    html += `</div>`;
    body.innerHTML = html;
  }
  document.getElementById('topicBankModal').classList.add('show');
}

function closeTopicBank() {
  document.getElementById('topicBankModal').classList.remove('show');
}

function loadTopic(idx) {
  const bank = getTopicBank();
  const t = bank[idx];
  if (!t) return;
  document.getElementById('topicName').value = t.name;
  document.getElementById('subjectSelect').value = t.subject || '';
  document.getElementById('factsInput').value = t.facts.join('\n');
  document.getElementById('termsInput').value = t.terms.map(x => x.term + ' | ' + x.def).join('\n');
  closeTopicBank();
  scrollToInput();
  showToast('Topic loaded! Click "Generate Activities" to start.');
}

function deleteTopic(idx) {
  if (!confirm('Delete this topic from the bank?')) return;
  let bank = getTopicBank();
  bank.splice(idx, 1);
  saveTopicBank(bank);
  openTopicBank();
}

/* ═══════════════════════════════════════
   PRINT
   ═══════════════════════════════════════ */
function printActivities() {
  if (!currentTopic) {
    alert('Please generate activities first before printing.');
    return;
  }
  const printWin = window.open('', '_blank');
  const topic = currentTopic;
  let html = `<!DOCTYPE html><html><head><title>Retrieval Practice - ${escHtml(topic.name)}</title>
  <style>
    body{font-family:'Segoe UI',system-ui,sans-serif;max-width:800px;margin:0 auto;padding:20px;color:#222;line-height:1.6}
    h1{font-size:1.5rem;border-bottom:3px solid #6C5CE7;padding-bottom:8px;margin-bottom:20px}
    h2{font-size:1.15rem;color:#6C5CE7;margin:28px 0 12px;padding:8px 12px;background:#f0edff;border-radius:8px}
    .q{margin:10px 0;padding:8px 0;border-bottom:1px solid #eee}
    .q b{color:#6C5CE7}
    .gap{border-bottom:2px solid #6C5CE7;min-width:80px;display:inline-block;margin:0 2px}
    .opts{margin:4px 0 4px 20px}.opts div{margin:3px 0}
    .match-table{width:100%;border-collapse:collapse;margin:8px 0}
    .match-table td{padding:8px 12px;border:1px solid #ddd;width:50%}
    .seq-item{padding:8px 12px;border:1px solid #ddd;margin:4px 0;border-radius:6px}
    .facts-list{columns:2;column-gap:20px}.facts-list div{break-inside:avoid;padding:4px 0}
    @media print{body{padding:10px}h1{font-size:1.3rem}}
  </style></head><body>
  <h1>Retrieval Practice: ${escHtml(topic.name)}</h1>
  <p style="color:#666;font-size:.9rem">Subject: ${escHtml(topic.subject)} | ${topic.facts.length} facts | Generated ${new Date().toLocaleDateString()}</p>

  <h2>1. Fill the Gap</h2>`;

  topic.facts.forEach((f, i) => {
    const kws = extractKeyWords(f);
    let display = f;
    kws.slice(0, 2).forEach(k => {
      display = display.replace(k.word, '<span class="gap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>');
    });
    html += `<div class="q">${i+1}. ${display}</div>`;
  });

  html += `<h2>2. Multiple Choice</h2>`;
  const letters = ['A', 'B', 'C', 'D'];
  mcqItems.slice(0, topic.facts.length).forEach((item, i) => {
    html += `<div class="q"><b>${i+1}.</b> ${escHtml(item.question)}<div class="opts">`;
    item.options.forEach((opt, oi) => {
      html += `<div>${letters[oi]}. ${escHtml(opt)}</div>`;
    });
    html += `</div></div>`;
  });

  if (topic.terms.length > 0) {
    html += `<h2>3. Match Up - Key Terms</h2>
    <table class="match-table"><tr><th style="background:#f0edff">Term</th><th style="background:#e0fafa">Definition</th></tr>`;
    const shuffledDefs = shuffle([...topic.terms]);
    topic.terms.forEach((t, i) => {
      html += `<tr><td>${escHtml(t.term)}</td><td>${escHtml(shuffledDefs[i].def)}</td></tr>`;
    });
    html += `</table>`;
  }

  html += `<h2>${topic.terms.length > 0 ? '4' : '3'}. Sequencing</h2>
  <p style="color:#666;font-size:.9rem">Put these in the correct order:</p>`;
  shuffle([...topic.facts]).forEach((f, i) => {
    html += `<div class="seq-item">&#9744; ${escHtml(f)}</div>`;
  });

  html += `<h2>${topic.terms.length > 0 ? '5' : '4'}. Brain Dump</h2>
  <p>Write everything you can remember about <strong>${escHtml(topic.name)}</strong>:</p>
  <div style="border:2px solid #ddd;border-radius:8px;min-height:200px;margin:8px 0"></div>
  <p style="font-size:.85rem;color:#666;margin-top:16px"><strong>Key facts to check against:</strong></p>
  <div class="facts-list">`;
  topic.facts.forEach(f => {
    html += `<div>&#8226; ${escHtml(f)}</div>`;
  });
  html += `</div></body></html>`;

  printWin.document.write(html);
  printWin.document.close();
  printWin.focus();
  setTimeout(() => printWin.print(), 500);
}

/* ═══════════════════════════════════════
   TOAST
   ═══════════════════════════════════════ */
function showToast(msg) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#2d3436;color:#fff;padding:12px 24px;border-radius:12px;font-size:.9rem;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;box-shadow:0 4px 20px rgba(0,0,0,.2)';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 2500);
}

/* ═══════════════════════════════════════
   KEYBOARD
   ═══════════════════════════════════════ */
document.addEventListener('keydown', e => {
  // Fullscreen flashcard navigation
  if (document.getElementById('fullscreenOverlay').classList.contains('show')) {
    if (e.key === 'Escape') exitFullscreen();
    if (e.key === 'ArrowLeft') { fcPrev(); renderFsFlashcard(); }
    if (e.key === 'ArrowRight') { fcNext(); renderFsFlashcard(); }
    if (e.key === ' ' || e.key === 'Enter') {
      const card = document.getElementById('fsFcCard');
      if (card) { e.preventDefault(); card.classList.toggle('flipped'); }
    }
  }
  // Normal flashcard navigation
  const fcPanel = document.getElementById('panel-flashcards');
  if (fcPanel && fcPanel.classList.contains('active') && !document.getElementById('fullscreenOverlay').classList.contains('show')) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'ArrowLeft') fcPrev();
    if (e.key === 'ArrowRight') fcNext();
    if (e.key === ' ') {
      e.preventDefault();
      const card = document.getElementById('fcCard');
      if (card) card.classList.toggle('flipped');
    }
  }
});

/* Close modal on background click */
document.getElementById('topicBankModal').addEventListener('click', function(e) {
  if (e.target === this) closeTopicBank();
});
</script>
</body>
</html>
