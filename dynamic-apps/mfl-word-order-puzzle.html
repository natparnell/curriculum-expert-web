<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Word Order Puzzle</title>
<style>
:root {
  --purple-dark: #4a1a6b;
  --purple-mid: #6b2fa0;
  --purple-light: #9b59b6;
  --purple-pale: #e8d5f5;
  --purple-ghost: #f5eefa;
  --subject: #2980b9;
  --subject-bg: #d6eaf8;
  --verb: #c0392b;
  --verb-bg: #fadbd8;
  --object: #27ae60;
  --object-bg: #d5f5e3;
  --adverbial: #e67e22;
  --adverbial-bg: #fdebd0;
  --negation: #8e44ad;
  --negation-bg: #e8daef;
  --bg: #faf8fc;
  --text: #2c1a3d;
  --text-light: #6c5b7b;
  --card-bg: #ffffff;
  --border: #d5c8e0;
  --success: #27ae60;
  --error: #c0392b;
  --radius: 8px;
  --shadow: 0 2px 8px rgba(74, 26, 107, 0.1);
  --shadow-lg: 0 4px 16px rgba(74, 26, 107, 0.15);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(135deg, var(--purple-dark), var(--purple-mid));
  color: white;
  padding: 12px 20px;
  box-shadow: var(--shadow-lg);
}

.header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 960px;
  margin: 0 auto;
  gap: 12px;
  flex-wrap: wrap;
}

header h1 {
  font-size: 1.3rem;
  font-weight: 700;
  letter-spacing: -0.3px;
}

.score-bar {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 0.9rem;
}

.score-bar span { opacity: 0.9; }
.score-bar strong { font-size: 1.1rem; }

.streak-badge {
  background: rgba(255,255,255,0.2);
  padding: 4px 12px;
  border-radius: 20px;
  font-weight: 600;
}

.streak-badge.on-fire {
  background: #e67e22;
  animation: pulse 0.6s ease-in-out infinite alternate;
}

@keyframes pulse {
  from { transform: scale(1); }
  to { transform: scale(1.08); }
}

.container {
  max-width: 960px;
  margin: 0 auto;
  padding: 16px 20px 40px;
}

/* Language tabs */
.lang-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
  background: var(--card-bg);
  padding: 4px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.lang-tab {
  flex: 1;
  padding: 10px 8px;
  border: none;
  background: transparent;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-light);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
}

.lang-tab:hover { background: var(--purple-ghost); }

.lang-tab.active {
  background: var(--purple-mid);
  color: white;
}

/* Info panel */
.info-panel {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 20px;
  overflow: hidden;
}

.info-toggle {
  width: 100%;
  padding: 12px 16px;
  border: none;
  background: var(--purple-pale);
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--purple-dark);
  cursor: pointer;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.info-toggle:hover { background: #ddc8ed; }

.info-body {
  display: none;
  padding: 16px;
  font-size: 0.88rem;
  line-height: 1.7;
  color: var(--text-light);
}

.info-body.open { display: block; }

.info-body h3 {
  color: var(--purple-dark);
  font-size: 0.95rem;
  margin: 12px 0 4px;
}

.info-body h3:first-child { margin-top: 0; }

.info-body ul {
  margin-left: 18px;
  margin-bottom: 8px;
}

/* Legend */
.legend {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.82rem;
  font-weight: 500;
}

.legend-dot {
  width: 14px;
  height: 14px;
  border-radius: 4px;
}

/* Puzzle card */
.puzzle-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  margin-bottom: 20px;
}

.puzzle-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.puzzle-number {
  font-size: 0.82rem;
  color: var(--text-light);
  font-weight: 600;
}

.difficulty-badge {
  font-size: 0.75rem;
  padding: 2px 10px;
  border-radius: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.difficulty-badge.easy { background: #d5f5e3; color: #1e8449; }
.difficulty-badge.medium { background: #fdebd0; color: #b45309; }
.difficulty-badge.hard { background: #fadbd8; color: #922b21; }

.english-hint {
  font-size: 0.92rem;
  color: var(--text-light);
  margin-bottom: 16px;
  padding: 10px 14px;
  background: var(--purple-ghost);
  border-radius: 6px;
  border-left: 3px solid var(--purple-light);
}

.english-hint strong { color: var(--purple-dark); }

/* Drop zone */
.drop-zone {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  min-height: 56px;
  padding: 12px;
  background: #f8f4fc;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  margin-bottom: 16px;
  transition: border-color 0.2s, background 0.2s;
  align-items: center;
}

.drop-zone.drag-over {
  border-color: var(--purple-mid);
  background: var(--purple-pale);
}

.drop-zone.correct {
  border-color: var(--success);
  background: #eafaf1;
}

.drop-zone.incorrect {
  border-color: var(--error);
  background: #fdf2f2;
  animation: shake 0.4s ease-in-out;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  75% { transform: translateX(6px); }
}

.slot-placeholder {
  width: 80px;
  height: 40px;
  border: 2px dashed #ccc;
  border-radius: 6px;
  opacity: 0.4;
}

/* Word tiles */
.word-bank {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-bottom: 16px;
  min-height: 48px;
}

.word-tile {
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: grab;
  user-select: none;
  border: 2px solid transparent;
  transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
  position: relative;
}

.word-tile:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.word-tile:active { cursor: grabbing; }

.word-tile.dragging {
  opacity: 0.4;
  transform: scale(0.95);
}

.word-tile[data-role="subject"] { background: var(--subject-bg); color: var(--subject); border-color: var(--subject); }
.word-tile[data-role="verb"] { background: var(--verb-bg); color: var(--verb); border-color: var(--verb); }
.word-tile[data-role="object"] { background: var(--object-bg); color: var(--object); border-color: var(--object); }
.word-tile[data-role="adverbial"] { background: var(--adverbial-bg); color: var(--adverbial); border-color: var(--adverbial); }
.word-tile[data-role="negation"] { background: var(--negation-bg); color: var(--negation); border-color: var(--negation); }

.word-tile.in-zone {
  cursor: grab;
}

/* Parallel line */
.parallel-line {
  display: none;
  margin-top: 12px;
  padding: 10px 14px;
  background: #fefbf0;
  border-radius: 6px;
  border-left: 3px solid var(--adverbial);
  font-size: 0.85rem;
}

.parallel-line.visible { display: block; }

.parallel-line .label {
  font-weight: 700;
  color: var(--adverbial);
  margin-right: 6px;
}

.parallel-word {
  display: inline-block;
  padding: 2px 6px;
  margin: 1px 2px;
  border-radius: 4px;
  font-weight: 600;
  font-size: 0.82rem;
}

/* Buttons */
.btn-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--purple-mid);
  color: white;
}

.btn-primary:hover { background: var(--purple-dark); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  background: var(--purple-pale);
  color: var(--purple-dark);
}

.btn-secondary:hover { background: #ddc8ed; }

.btn-skip {
  background: transparent;
  color: var(--text-light);
  border: 1px solid var(--border);
}

.btn-skip:hover { background: #f0eaf5; }

/* Feedback */
.feedback {
  margin-top: 12px;
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 0.88rem;
  font-weight: 500;
  display: none;
}

.feedback.show { display: block; }
.feedback.success { background: #d5f5e3; color: #1e8449; }
.feedback.error { background: #fadbd8; color: #922b21; }

/* Explanation */
.explanation {
  margin-top: 12px;
  padding: 12px 14px;
  background: var(--purple-ghost);
  border-radius: 6px;
  font-size: 0.85rem;
  color: var(--text-light);
  line-height: 1.6;
  display: none;
}

.explanation.show { display: block; }
.explanation strong { color: var(--purple-dark); }

/* Progress */
.progress-bar {
  width: 100%;
  height: 6px;
  background: var(--purple-pale);
  border-radius: 3px;
  margin-bottom: 20px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--purple-mid), var(--purple-light));
  border-radius: 3px;
  transition: width 0.4s ease;
}

/* Complete screen */
.complete-screen {
  text-align: center;
  padding: 48px 24px;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  display: none;
}

.complete-screen.show { display: block; }

.complete-screen h2 {
  font-size: 1.5rem;
  color: var(--purple-dark);
  margin-bottom: 8px;
}

.complete-screen .final-score {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--purple-mid);
  margin: 12px 0;
}

.complete-screen .stats {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin: 16px 0 24px;
  font-size: 0.9rem;
  color: var(--text-light);
}

/* Touch-friendly: larger tap targets on mobile */
@media (max-width: 768px) {
  header { padding: 10px 14px; }
  header h1 { font-size: 1.1rem; }
  .header-row { gap: 8px; }
  .score-bar { gap: 10px; font-size: 0.82rem; }
  .container { padding: 12px 14px 32px; }
  .puzzle-card { padding: 16px; }

  .word-tile {
    padding: 10px 14px;
    font-size: 0.9rem;
  }

  .lang-tab { padding: 10px 6px; font-size: 0.85rem; }

  .legend { gap: 6px; }
  .legend-item { font-size: 0.76rem; }

  .btn { padding: 10px 16px; font-size: 0.85rem; }
}
</style>
</head>
<body>

<header>
  <div class="header-row">
    <h1>Word Order Puzzle</h1>
    <div class="score-bar">
      <span>Score: <strong id="score">0</strong></span>
      <span class="streak-badge" id="streakBadge">Streak: 0</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="lang-tabs" id="langTabs">
    <button class="lang-tab active" data-lang="french">French</button>
    <button class="lang-tab" data-lang="german">German</button>
    <button class="lang-tab" data-lang="spanish">Spanish</button>
  </div>

  <div class="info-panel">
    <button class="info-toggle" id="infoToggle">
      <span>Word Order Rules</span>
      <span id="infoArrow">&#9660;</span>
    </button>
    <div class="info-body" id="infoBody"></div>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--subject-bg);border:2px solid var(--subject)"></div>Subject</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--verb-bg);border:2px solid var(--verb)"></div>Verb</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--object-bg);border:2px solid var(--object)"></div>Object</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--adverbial-bg);border:2px solid var(--adverbial)"></div>Adverbial</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--negation-bg);border:2px solid var(--negation)"></div>Negation</div>
  </div>

  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

  <div class="puzzle-card" id="puzzleCard">
    <div class="puzzle-meta">
      <span class="puzzle-number" id="puzzleNumber"></span>
      <span class="difficulty-badge" id="diffBadge"></span>
    </div>
    <div class="english-hint" id="englishHint"></div>
    <div class="drop-zone" id="dropZone"></div>
    <div class="word-bank" id="wordBank"></div>
    <div class="btn-row">
      <button class="btn btn-primary" id="checkBtn" disabled>Check Answer</button>
      <button class="btn btn-secondary" id="resetBtn">Reset</button>
      <button class="btn btn-skip" id="skipBtn">Skip</button>
    </div>
    <div class="feedback" id="feedback"></div>
    <div class="explanation" id="explanation"></div>
    <div class="parallel-line" id="parallelLine"></div>
  </div>

  <div class="complete-screen" id="completeScreen">
    <h2>Set Complete</h2>
    <div class="final-score" id="finalScore"></div>
    <div class="stats" id="finalStats"></div>
    <button class="btn btn-primary" id="restartBtn">Try Again</button>
  </div>
</div>

<script>
(function () {
  'use strict';

  /* ===== SENTENCE DATA ===== */
  const sentences = {
    french: [
      {
        words: [
          { text: 'Je', role: 'subject' },
          { text: 'mange', role: 'verb' },
          { text: 'une pomme', role: 'object' }
        ],
        english: 'I eat an apple',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'eat', role: 'verb' },
          { text: 'an apple', role: 'object' }
        ],
        difficulty: 'easy',
        explanation: 'French follows Subject-Verb-Object (SVO) order, just like English. Simple sentences are structured the same way.'
      },
      {
        words: [
          { text: 'Le chat', role: 'subject' },
          { text: 'dort', role: 'verb' },
          { text: 'sur le canape', role: 'adverbial' }
        ],
        english: 'The cat sleeps on the sofa',
        englishWords: [
          { text: 'The cat', role: 'subject' },
          { text: 'sleeps', role: 'verb' },
          { text: 'on the sofa', role: 'adverbial' }
        ],
        difficulty: 'easy',
        explanation: 'Adverbials of place typically come after the verb in French, matching English word order here.'
      },
      {
        words: [
          { text: 'Je', role: 'subject' },
          { text: 'ne', role: 'negation' },
          { text: 'mange', role: 'verb' },
          { text: 'pas', role: 'negation' },
          { text: 'de viande', role: 'object' }
        ],
        english: 'I do not eat meat',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'do not', role: 'negation' },
          { text: 'eat', role: 'verb' },
          { text: 'meat', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: 'French uses the "ne...pas" sandwich: the negation wraps around the verb. English places "not" before the main verb (using an auxiliary).'
      },
      {
        words: [
          { text: 'Nous', role: 'subject' },
          { text: 'avons', role: 'verb' },
          { text: 'bien', role: 'adverbial' },
          { text: 'mange', role: 'verb' }
        ],
        english: 'We ate well',
        englishWords: [
          { text: 'We', role: 'subject' },
          { text: 'ate', role: 'verb' },
          { text: 'well', role: 'adverbial' }
        ],
        difficulty: 'medium',
        explanation: 'In the passe compose, short adverbs like "bien" are placed between the auxiliary (avons) and the past participle (mange). English places the adverb after the verb.'
      },
      {
        words: [
          { text: 'Elle', role: 'subject' },
          { text: 'ne', role: 'negation' },
          { text: 'va', role: 'verb' },
          { text: 'jamais', role: 'negation' },
          { text: 'au cinema', role: 'adverbial' }
        ],
        english: 'She never goes to the cinema',
        englishWords: [
          { text: 'She', role: 'subject' },
          { text: 'never', role: 'negation' },
          { text: 'goes', role: 'verb' },
          { text: 'to the cinema', role: 'adverbial' }
        ],
        difficulty: 'medium',
        explanation: 'French uses "ne...jamais" as a negation sandwich around the verb. English places "never" before the main verb.'
      },
      {
        words: [
          { text: 'Hier', role: 'adverbial' },
          { text: 'j\'', role: 'subject' },
          { text: 'ai', role: 'verb' },
          { text: 'achete', role: 'verb' },
          { text: 'un livre', role: 'object' }
        ],
        english: 'Yesterday I bought a book',
        englishWords: [
          { text: 'Yesterday', role: 'adverbial' },
          { text: 'I', role: 'subject' },
          { text: 'bought', role: 'verb' },
          { text: 'a book', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: 'Time adverbials can start the sentence in both French and English. The passe compose splits into auxiliary (ai) + past participle (achete).'
      },
      {
        words: [
          { text: 'Je', role: 'subject' },
          { text: 'la', role: 'object' },
          { text: 'vois', role: 'verb' },
          { text: 'tous les jours', role: 'adverbial' }
        ],
        english: 'I see her every day',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'see', role: 'verb' },
          { text: 'her', role: 'object' },
          { text: 'every day', role: 'adverbial' }
        ],
        difficulty: 'hard',
        explanation: 'In French, object pronouns (la, le, les) go before the verb. In English, they go after. This is a key structural difference.'
      },
      {
        words: [
          { text: 'Il', role: 'subject' },
          { text: 'ne', role: 'negation' },
          { text: 'lui', role: 'object' },
          { text: 'a', role: 'verb' },
          { text: 'rien', role: 'negation' },
          { text: 'donne', role: 'verb' }
        ],
        english: 'He gave him nothing',
        englishWords: [
          { text: 'He', role: 'subject' },
          { text: 'gave', role: 'verb' },
          { text: 'him', role: 'object' },
          { text: 'nothing', role: 'negation' }
        ],
        difficulty: 'hard',
        explanation: 'This combines two tricky French features: the object pronoun (lui) before the verb, and the "ne...rien" negation sandwich. English places the pronoun after the verb and "nothing" at the end.'
      },
      {
        words: [
          { text: 'Ma soeur', role: 'subject' },
          { text: 'veut', role: 'verb' },
          { text: 'devenir', role: 'verb' },
          { text: 'medecin', role: 'object' },
          { text: 'plus tard', role: 'adverbial' }
        ],
        english: 'My sister wants to become a doctor later',
        englishWords: [
          { text: 'My sister', role: 'subject' },
          { text: 'wants to become', role: 'verb' },
          { text: 'a doctor', role: 'object' },
          { text: 'later', role: 'adverbial' }
        ],
        difficulty: 'easy',
        explanation: 'With modal-type constructions (vouloir + infinitive), French and English follow a similar order: subject, modal verb, infinitive, complement.'
      },
      {
        words: [
          { text: 'Ils', role: 'subject' },
          { text: 'ne', role: 'negation' },
          { text: 'se sont', role: 'verb' },
          { text: 'pas', role: 'negation' },
          { text: 'encore', role: 'adverbial' },
          { text: 'leves', role: 'verb' }
        ],
        english: 'They have not got up yet',
        englishWords: [
          { text: 'They', role: 'subject' },
          { text: 'have', role: 'verb' },
          { text: 'not', role: 'negation' },
          { text: 'got up', role: 'verb' },
          { text: 'yet', role: 'adverbial' }
        ],
        difficulty: 'hard',
        explanation: 'Reflexive verbs in the passe compose with negation are complex: ne + reflexive pronoun + auxiliary + pas + adverb + past participle. English is simpler structurally.'
      }
    ],
    german: [
      {
        words: [
          { text: 'Ich', role: 'subject' },
          { text: 'spiele', role: 'verb' },
          { text: 'Fussball', role: 'object' }
        ],
        english: 'I play football',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'play', role: 'verb' },
          { text: 'football', role: 'object' }
        ],
        difficulty: 'easy',
        explanation: 'Simple German sentences follow SVO order, identical to English. The verb is in second position (V2 rule).'
      },
      {
        words: [
          { text: 'Der Hund', role: 'subject' },
          { text: 'frisst', role: 'verb' },
          { text: 'den Knochen', role: 'object' },
          { text: 'im Garten', role: 'adverbial' }
        ],
        english: 'The dog eats the bone in the garden',
        englishWords: [
          { text: 'The dog', role: 'subject' },
          { text: 'eats', role: 'verb' },
          { text: 'the bone', role: 'object' },
          { text: 'in the garden', role: 'adverbial' }
        ],
        difficulty: 'easy',
        explanation: 'With simple SVO + place adverbial, German matches English word order. The verb stays in second position.'
      },
      {
        words: [
          { text: 'Heute', role: 'adverbial' },
          { text: 'spiele', role: 'verb' },
          { text: 'ich', role: 'subject' },
          { text: 'Tennis', role: 'object' }
        ],
        english: 'Today I play tennis',
        englishWords: [
          { text: 'Today', role: 'adverbial' },
          { text: 'I', role: 'subject' },
          { text: 'play', role: 'verb' },
          { text: 'tennis', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: 'The V2 rule in action: when an adverbial starts the sentence, the verb must stay in second position, so the subject moves after the verb. English keeps SVO order regardless.'
      },
      {
        words: [
          { text: 'Ich', role: 'subject' },
          { text: 'habe', role: 'verb' },
          { text: 'gestern', role: 'adverbial' },
          { text: 'einen Kuchen', role: 'object' },
          { text: 'gebacken', role: 'verb' }
        ],
        english: 'I baked a cake yesterday',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'baked', role: 'verb' },
          { text: 'a cake', role: 'object' },
          { text: 'yesterday', role: 'adverbial' }
        ],
        difficulty: 'medium',
        explanation: 'In the perfect tense, German uses a "bracket" structure: the auxiliary (habe) stays in V2 position, but the past participle (gebacken) goes to the end. English keeps everything together.'
      },
      {
        words: [
          { text: 'Ich', role: 'subject' },
          { text: 'spiele', role: 'verb' },
          { text: 'nicht', role: 'negation' },
          { text: 'gern', role: 'adverbial' },
          { text: 'Schach', role: 'object' }
        ],
        english: 'I do not like playing chess',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'do not', role: 'negation' },
          { text: 'like playing', role: 'verb' },
          { text: 'chess', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: 'German "nicht" typically comes after the verb. "Gern" (gladly) is an adverb modifying the verb. The object still follows. English restructures this quite differently.'
      },
      {
        words: [
          { text: 'Am Wochenende', role: 'adverbial' },
          { text: 'fahre', role: 'verb' },
          { text: 'ich', role: 'subject' },
          { text: 'mit dem Zug', role: 'adverbial' },
          { text: 'nach Berlin', role: 'adverbial' }
        ],
        english: 'At the weekend I travel by train to Berlin',
        englishWords: [
          { text: 'At the weekend', role: 'adverbial' },
          { text: 'I', role: 'subject' },
          { text: 'travel', role: 'verb' },
          { text: 'by train', role: 'adverbial' },
          { text: 'to Berlin', role: 'adverbial' }
        ],
        difficulty: 'hard',
        explanation: 'V2 rule with multiple adverbials: the time phrase starts, verb stays second, subject follows. German adverbials follow the TMP rule (Time, Manner, Place).'
      },
      {
        words: [
          { text: 'Ich', role: 'subject' },
          { text: 'weiss', role: 'verb' },
          { text: 'dass', role: 'adverbial' },
          { text: 'er', role: 'subject' },
          { text: 'gut', role: 'adverbial' },
          { text: 'schwimmen', role: 'verb' },
          { text: 'kann', role: 'verb' }
        ],
        english: 'I know that he can swim well',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'know', role: 'verb' },
          { text: 'that', role: 'adverbial' },
          { text: 'he', role: 'subject' },
          { text: 'can', role: 'verb' },
          { text: 'swim', role: 'verb' },
          { text: 'well', role: 'adverbial' }
        ],
        difficulty: 'hard',
        explanation: 'In subordinate clauses (after "dass"), the verb goes to the end in German. The modal "kann" goes to the very end after the infinitive. English keeps normal SVO order in subordinate clauses.'
      },
      {
        words: [
          { text: 'Die Kinder', role: 'subject' },
          { text: 'wollen', role: 'verb' },
          { text: 'morgen', role: 'adverbial' },
          { text: 'im Park', role: 'adverbial' },
          { text: 'spielen', role: 'verb' }
        ],
        english: 'The children want to play in the park tomorrow',
        englishWords: [
          { text: 'The children', role: 'subject' },
          { text: 'want to play', role: 'verb' },
          { text: 'in the park', role: 'adverbial' },
          { text: 'tomorrow', role: 'adverbial' }
        ],
        difficulty: 'medium',
        explanation: 'With modal verbs, the modal (wollen) takes V2 position and the infinitive (spielen) goes to the end, creating a "bracket" around the middle content.'
      },
      {
        words: [
          { text: 'Meine Mutter', role: 'subject' },
          { text: 'hat', role: 'verb' },
          { text: 'mir', role: 'object' },
          { text: 'ein Geschenk', role: 'object' },
          { text: 'gegeben', role: 'verb' }
        ],
        english: 'My mother gave me a present',
        englishWords: [
          { text: 'My mother', role: 'subject' },
          { text: 'gave', role: 'verb' },
          { text: 'me', role: 'object' },
          { text: 'a present', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: 'Perfect tense bracket: "hat" (auxiliary) in V2, "gegeben" (past participle) at the end. The dative object (mir) comes before the accusative object (ein Geschenk).'
      },
      {
        words: [
          { text: 'Obwohl', role: 'adverbial' },
          { text: 'es', role: 'subject' },
          { text: 'kalt', role: 'adverbial' },
          { text: 'ist', role: 'verb' },
          { text: 'gehe', role: 'verb' },
          { text: 'ich', role: 'subject' },
          { text: 'spazieren', role: 'verb' }
        ],
        english: 'Although it is cold I go for a walk',
        englishWords: [
          { text: 'Although', role: 'adverbial' },
          { text: 'it', role: 'subject' },
          { text: 'is', role: 'verb' },
          { text: 'cold', role: 'adverbial' },
          { text: 'I', role: 'subject' },
          { text: 'go for a walk', role: 'verb' }
        ],
        difficulty: 'hard',
        explanation: 'After a subordinate clause (obwohl...), the main clause verb comes first (inversion). In the subordinate clause, the verb (ist) goes to the end. This is one of German\'s most challenging word order patterns.'
      }
    ],
    spanish: [
      {
        words: [
          { text: 'Yo', role: 'subject' },
          { text: 'como', role: 'verb' },
          { text: 'una manzana', role: 'object' }
        ],
        english: 'I eat an apple',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'eat', role: 'verb' },
          { text: 'an apple', role: 'object' }
        ],
        difficulty: 'easy',
        explanation: 'Spanish follows SVO order like English. The subject pronoun (Yo) is often dropped in Spanish, but is included here for clarity.'
      },
      {
        words: [
          { text: 'El gato', role: 'subject' },
          { text: 'duerme', role: 'verb' },
          { text: 'en la cama', role: 'adverbial' }
        ],
        english: 'The cat sleeps on the bed',
        englishWords: [
          { text: 'The cat', role: 'subject' },
          { text: 'sleeps', role: 'verb' },
          { text: 'on the bed', role: 'adverbial' }
        ],
        difficulty: 'easy',
        explanation: 'Simple SVO with a place adverbial at the end, matching English word order exactly.'
      },
      {
        words: [
          { text: 'No', role: 'negation' },
          { text: 'me', role: 'object' },
          { text: 'gusta', role: 'verb' },
          { text: 'el cafe', role: 'subject' }
        ],
        english: 'I do not like coffee',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'do not', role: 'negation' },
          { text: 'like', role: 'verb' },
          { text: 'coffee', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: '"Gustar" flips the structure: the thing liked (el cafe) is actually the grammatical subject. "No" goes before the indirect object pronoun (me). The word order is very different from English.'
      },
      {
        words: [
          { text: 'Ayer', role: 'adverbial' },
          { text: 'mi hermano', role: 'subject' },
          { text: 'compro', role: 'verb' },
          { text: 'un coche', role: 'object' },
          { text: 'nuevo', role: 'object' }
        ],
        english: 'Yesterday my brother bought a new car',
        englishWords: [
          { text: 'Yesterday', role: 'adverbial' },
          { text: 'my brother', role: 'subject' },
          { text: 'bought', role: 'verb' },
          { text: 'a new', role: 'object' },
          { text: 'car', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: 'Adjectives in Spanish typically follow the noun: "un coche nuevo" (a car new), whereas English places them before: "a new car". Time adverbials can start the sentence in both languages.'
      },
      {
        words: [
          { text: 'Ella', role: 'subject' },
          { text: 'lo', role: 'object' },
          { text: 'compro', role: 'verb' },
          { text: 'en la tienda', role: 'adverbial' }
        ],
        english: 'She bought it in the shop',
        englishWords: [
          { text: 'She', role: 'subject' },
          { text: 'bought', role: 'verb' },
          { text: 'it', role: 'object' },
          { text: 'in the shop', role: 'adverbial' }
        ],
        difficulty: 'medium',
        explanation: 'Object pronouns (lo, la, los, las) go before the conjugated verb in Spanish: "lo compro". English places them after: "bought it".'
      },
      {
        words: [
          { text: 'Nunca', role: 'negation' },
          { text: 'he', role: 'verb' },
          { text: 'visitado', role: 'verb' },
          { text: 'Espana', role: 'object' }
        ],
        english: 'I have never visited Spain',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'have', role: 'verb' },
          { text: 'never', role: 'negation' },
          { text: 'visited', role: 'verb' },
          { text: 'Spain', role: 'object' }
        ],
        difficulty: 'medium',
        explanation: 'Spanish places "nunca" at the start for emphasis (the subject "yo" is dropped). Nothing separates the auxiliary and participle in Spanish, unlike English where "never" sits between them.'
      },
      {
        words: [
          { text: 'A mi madre', role: 'object' },
          { text: 'le', role: 'object' },
          { text: 'encantan', role: 'verb' },
          { text: 'las flores', role: 'subject' }
        ],
        english: 'My mother loves flowers',
        englishWords: [
          { text: 'My mother', role: 'subject' },
          { text: 'loves', role: 'verb' },
          { text: 'flowers', role: 'object' }
        ],
        difficulty: 'hard',
        explanation: '"Encantar" works like "gustar": the grammatical subject (las flores) causes the verb to be plural. The person who loves them (a mi madre) is actually the indirect object. This inverts English word order completely.'
      },
      {
        words: [
          { text: 'Los estudiantes', role: 'subject' },
          { text: 'no', role: 'negation' },
          { text: 'han', role: 'verb' },
          { text: 'terminado', role: 'verb' },
          { text: 'los deberes', role: 'object' },
          { text: 'todavia', role: 'adverbial' }
        ],
        english: 'The students have not finished the homework yet',
        englishWords: [
          { text: 'The students', role: 'subject' },
          { text: 'have', role: 'verb' },
          { text: 'not', role: 'negation' },
          { text: 'finished', role: 'verb' },
          { text: 'the homework', role: 'object' },
          { text: 'yet', role: 'adverbial' }
        ],
        difficulty: 'medium',
        explanation: 'Spanish "no" comes before the entire verb phrase (no han terminado), and "todavia" goes at the end. In English, "not" splits the auxiliary and participle, with "yet" also at the end.'
      },
      {
        words: [
          { text: 'Se', role: 'object' },
          { text: 'lo', role: 'object' },
          { text: 'di', role: 'verb' },
          { text: 'a Maria', role: 'adverbial' },
          { text: 'ayer', role: 'adverbial' }
        ],
        english: 'I gave it to Maria yesterday',
        englishWords: [
          { text: 'I', role: 'subject' },
          { text: 'gave', role: 'verb' },
          { text: 'it', role: 'object' },
          { text: 'to Maria', role: 'adverbial' },
          { text: 'yesterday', role: 'adverbial' }
        ],
        difficulty: 'hard',
        explanation: 'Spanish stacks object pronouns (se lo) before the verb. "Se" replaces "le" when followed by "lo". The subject (yo) is dropped. English spreads these elements after the verb.'
      },
      {
        words: [
          { text: 'Quiero', role: 'verb' },
          { text: 'que', role: 'adverbial' },
          { text: 'vengas', role: 'verb' },
          { text: 'a la fiesta', role: 'adverbial' },
          { text: 'manana', role: 'adverbial' }
        ],
        english: 'I want you to come to the party tomorrow',
        englishWords: [
          { text: 'I want', role: 'verb' },
          { text: 'you', role: 'object' },
          { text: 'to come', role: 'verb' },
          { text: 'to the party', role: 'adverbial' },
          { text: 'tomorrow', role: 'adverbial' }
        ],
        difficulty: 'hard',
        explanation: 'Spanish uses the subjunctive (vengas) after "que" for wishes and desires. The subject "yo" is dropped from "quiero". English uses "want + person + to + infinitive" instead.'
      }
    ]
  };

  /* ===== INFO PANEL CONTENT ===== */
  const infoContent = {
    french: `
      <h3>French Word Order</h3>
      <ul>
        <li><strong>Basic order:</strong> Subject-Verb-Object (SVO), same as English.</li>
        <li><strong>Negation sandwich:</strong> "ne" goes before the verb, "pas/jamais/rien" goes after it (ne...pas, ne...jamais, ne...rien).</li>
        <li><strong>Object pronouns:</strong> Go before the verb (Je <em>la</em> vois), whereas English places them after (I see <em>her</em>).</li>
        <li><strong>Adverbs:</strong> Short adverbs (bien, mal, vite) go between the auxiliary and past participle in the passe compose.</li>
        <li><strong>Questions:</strong> Inversion is possible (Aimes-tu...?) but "Est-ce que" avoids changing word order.</li>
      </ul>
      <h3>Key Difference from English</h3>
      <ul>
        <li>Object pronouns move before the verb: "Je le mange" vs "I eat it".</li>
        <li>Negation wraps around the verb rather than sitting in one place.</li>
      </ul>
    `,
    german: `
      <h3>German Word Order</h3>
      <ul>
        <li><strong>V2 Rule:</strong> The conjugated verb <em>must</em> be the second element in a main clause. If something other than the subject starts the sentence, the subject moves after the verb.</li>
        <li><strong>Verb bracket:</strong> In perfect tense and modal constructions, the auxiliary takes V2 position and the infinitive/past participle goes to the end of the clause.</li>
        <li><strong>Subordinate clauses:</strong> After conjunctions like "dass", "weil", "obwohl", the verb goes to the very end.</li>
        <li><strong>TMP rule:</strong> Adverbials generally follow Time-Manner-Place order.</li>
        <li><strong>Negation:</strong> "Nicht" usually comes after the verb (or after the object if negating the whole clause).</li>
      </ul>
      <h3>Key Difference from English</h3>
      <ul>
        <li>The V2 rule causes subject-verb inversion when the sentence starts with anything other than the subject.</li>
        <li>Verb-final position in subordinate clauses is the biggest structural difference from English.</li>
      </ul>
    `,
    spanish: `
      <h3>Spanish Word Order</h3>
      <ul>
        <li><strong>Basic order:</strong> Subject-Verb-Object (SVO), flexible due to verb conjugation encoding the subject.</li>
        <li><strong>Subject dropping:</strong> Subject pronouns are frequently omitted (pro-drop) because verb endings indicate the subject.</li>
        <li><strong>Object pronouns:</strong> Go before the conjugated verb (Lo compro), unlike English (I bought it).</li>
        <li><strong>Adjective placement:</strong> Most adjectives follow the noun (un coche nuevo), unlike English (a new car).</li>
        <li><strong>Gustar-type verbs:</strong> The thing liked is the subject, the person who likes is the indirect object, inverting the English structure completely.</li>
        <li><strong>Negation:</strong> "No" goes directly before the verb phrase. Double negatives are standard (No tengo nada).</li>
      </ul>
      <h3>Key Difference from English</h3>
      <ul>
        <li>Object pronouns precede the verb.</li>
        <li>Gustar/encantar verbs flip subject and object compared to English.</li>
        <li>Adjectives follow nouns in most cases.</li>
      </ul>
    `
  };

  /* ===== STATE ===== */
  let currentLang = 'french';
  let currentIndex = 0;
  let score = 0;
  let streak = 0;
  let bestStreak = 0;
  let correctCount = 0;
  let attemptCount = 0;
  let puzzleOrder = [];
  let draggedTile = null;
  let startTime = 0;

  /* ===== DOM REFS ===== */
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  const scoreEl = $('#score');
  const streakBadge = $('#streakBadge');
  const langTabs = $('#langTabs');
  const infoToggle = $('#infoToggle');
  const infoArrow = $('#infoArrow');
  const infoBody = $('#infoBody');
  const progressFill = $('#progressFill');
  const puzzleCard = $('#puzzleCard');
  const puzzleNumber = $('#puzzleNumber');
  const diffBadge = $('#diffBadge');
  const englishHint = $('#englishHint');
  const dropZone = $('#dropZone');
  const wordBank = $('#wordBank');
  const checkBtn = $('#checkBtn');
  const resetBtn = $('#resetBtn');
  const skipBtn = $('#skipBtn');
  const feedbackEl = $('#feedback');
  const explanationEl = $('#explanation');
  const parallelLine = $('#parallelLine');
  const completeScreen = $('#completeScreen');
  const finalScore = $('#finalScore');
  const finalStats = $('#finalStats');
  const restartBtn = $('#restartBtn');

  /* ===== UTILITY ===== */
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function updateScore() {
    scoreEl.textContent = score;
    streakBadge.textContent = 'Streak: ' + streak;
    streakBadge.classList.toggle('on-fire', streak >= 3);
  }

  function updateProgress() {
    const total = sentences[currentLang].length;
    const pct = (currentIndex / total) * 100;
    progressFill.style.width = pct + '%';
  }

  /* ===== INFO PANEL ===== */
  function loadInfo() {
    infoBody.innerHTML = infoContent[currentLang];
    infoBody.classList.remove('open');
    infoArrow.textContent = '\u25BC';
  }

  infoToggle.addEventListener('click', function () {
    const open = infoBody.classList.toggle('open');
    infoArrow.textContent = open ? '\u25B2' : '\u25BC';
  });

  /* ===== LANGUAGE TABS ===== */
  langTabs.addEventListener('click', function (e) {
    const tab = e.target.closest('.lang-tab');
    if (!tab || tab.classList.contains('active')) return;
    $$('.lang-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentLang = tab.dataset.lang;
    currentIndex = 0;
    score = 0;
    streak = 0;
    bestStreak = 0;
    correctCount = 0;
    attemptCount = 0;
    updateScore();
    loadInfo();
    initPuzzleSet();
  });

  /* ===== DRAG AND DROP ===== */
  function createTile(word, index) {
    const tile = document.createElement('div');
    tile.className = 'word-tile';
    tile.textContent = word.text;
    tile.dataset.role = word.role;
    tile.dataset.index = index;
    tile.draggable = true;

    tile.addEventListener('dragstart', handleDragStart);
    tile.addEventListener('dragend', handleDragEnd);

    // Touch support
    tile.addEventListener('touchstart', handleTouchStart, { passive: false });
    tile.addEventListener('touchmove', handleTouchMove, { passive: false });
    tile.addEventListener('touchend', handleTouchEnd);

    return tile;
  }

  function handleDragStart(e) {
    draggedTile = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', '');
  }

  function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedTile = null;
    dropZone.classList.remove('drag-over');
  }

  dropZone.addEventListener('dragover', function (e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    dropZone.classList.add('drag-over');
  });

  dropZone.addEventListener('dragleave', function () {
    dropZone.classList.remove('drag-over');
  });

  dropZone.addEventListener('drop', function (e) {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    if (!draggedTile) return;

    if (draggedTile.parentElement === wordBank) {
      // Move from bank to zone
      moveTileToZone(draggedTile);
    } else if (draggedTile.parentElement === dropZone) {
      // Reorder within zone
      const afterElement = getDragAfterElement(dropZone, e.clientX);
      if (afterElement) {
        dropZone.insertBefore(draggedTile, afterElement);
      } else {
        dropZone.appendChild(draggedTile);
      }
    }
    updateCheckBtn();
  });

  wordBank.addEventListener('dragover', function (e) {
    e.preventDefault();
  });

  wordBank.addEventListener('drop', function (e) {
    e.preventDefault();
    if (!draggedTile || draggedTile.parentElement !== dropZone) return;
    moveTileToBank(draggedTile);
    updateCheckBtn();
  });

  function getDragAfterElement(container, x) {
    const tiles = [...container.querySelectorAll('.word-tile:not(.dragging)')];
    let closest = null;
    let closestOffset = Number.POSITIVE_INFINITY;
    tiles.forEach(tile => {
      const box = tile.getBoundingClientRect();
      const offset = x - box.left - box.width / 2;
      if (offset < 0 && offset > -closestOffset) {
        closestOffset = -offset;
        closest = tile;
      }
    });
    return closest;
  }

  /* ===== TOUCH SUPPORT ===== */
  let touchClone = null;
  let touchOffsetX = 0;
  let touchOffsetY = 0;

  function handleTouchStart(e) {
    if (checkBtn.disabled === false && dropZone.querySelectorAll('.word-tile').length === sentences[currentLang][puzzleOrder[currentIndex]].words.length) {
      // All tiles placed, allow normal interaction
    }
    const touch = e.touches[0];
    draggedTile = e.target.closest('.word-tile');
    if (!draggedTile) return;

    e.preventDefault();
    const rect = draggedTile.getBoundingClientRect();
    touchOffsetX = touch.clientX - rect.left;
    touchOffsetY = touch.clientY - rect.top;

    touchClone = draggedTile.cloneNode(true);
    touchClone.style.position = 'fixed';
    touchClone.style.zIndex = '1000';
    touchClone.style.pointerEvents = 'none';
    touchClone.style.opacity = '0.85';
    touchClone.style.width = rect.width + 'px';
    touchClone.style.left = (touch.clientX - touchOffsetX) + 'px';
    touchClone.style.top = (touch.clientY - touchOffsetY) + 'px';
    document.body.appendChild(touchClone);

    draggedTile.classList.add('dragging');
  }

  function handleTouchMove(e) {
    if (!touchClone) return;
    e.preventDefault();
    const touch = e.touches[0];
    touchClone.style.left = (touch.clientX - touchOffsetX) + 'px';
    touchClone.style.top = (touch.clientY - touchOffsetY) + 'px';
  }

  function handleTouchEnd(e) {
    if (!touchClone || !draggedTile) return;
    document.body.removeChild(touchClone);
    touchClone = null;

    const touch = e.changedTouches[0];
    const dropRect = dropZone.getBoundingClientRect();
    const bankRect = wordBank.getBoundingClientRect();

    if (touch.clientY >= dropRect.top && touch.clientY <= dropRect.bottom &&
        touch.clientX >= dropRect.left && touch.clientX <= dropRect.right) {
      if (draggedTile.parentElement === wordBank) {
        moveTileToZone(draggedTile);
      }
    } else if (touch.clientY >= bankRect.top && touch.clientY <= bankRect.bottom &&
               touch.clientX >= bankRect.left && touch.clientX <= bankRect.right) {
      if (draggedTile.parentElement === dropZone) {
        moveTileToBank(draggedTile);
      }
    } else {
      // Tap behaviour: toggle between bank and zone
      if (draggedTile.parentElement === wordBank) {
        moveTileToZone(draggedTile);
      } else {
        moveTileToBank(draggedTile);
      }
    }

    draggedTile.classList.remove('dragging');
    draggedTile = null;
    updateCheckBtn();
  }

  function moveTileToZone(tile) {
    tile.classList.add('in-zone');
    dropZone.appendChild(tile);
  }

  function moveTileToBank(tile) {
    tile.classList.remove('in-zone');
    wordBank.appendChild(tile);
  }

  /* ===== CLICK TO MOVE ===== */
  function handleTileClick(e) {
    const tile = e.target.closest('.word-tile');
    if (!tile) return;
    // Don't handle if we're in a drag
    if (tile.classList.contains('dragging')) return;

    if (tile.parentElement === wordBank) {
      moveTileToZone(tile);
    } else if (tile.parentElement === dropZone) {
      moveTileToBank(tile);
    }
    updateCheckBtn();
  }

  wordBank.addEventListener('click', handleTileClick);
  dropZone.addEventListener('click', handleTileClick);

  /* ===== CHECK / RESET / SKIP ===== */
  function updateCheckBtn() {
    const sentenceData = sentences[currentLang][puzzleOrder[currentIndex]];
    const inZone = dropZone.querySelectorAll('.word-tile').length;
    checkBtn.disabled = inZone !== sentenceData.words.length;
  }

  checkBtn.addEventListener('click', function () {
    const sentenceData = sentences[currentLang][puzzleOrder[currentIndex]];
    const placed = [...dropZone.querySelectorAll('.word-tile')];
    const correct = sentenceData.words;

    const isCorrect = placed.length === correct.length &&
      placed.every((tile, i) => parseInt(tile.dataset.index) === i);

    attemptCount++;

    if (isCorrect) {
      const elapsed = (Date.now() - startTime) / 1000;
      let points = 10;
      if (sentenceData.difficulty === 'medium') points = 15;
      if (sentenceData.difficulty === 'hard') points = 25;
      // Speed bonus
      if (elapsed < 10) points += 5;
      else if (elapsed < 20) points += 2;
      // Streak bonus
      streak++;
      if (streak > bestStreak) bestStreak = streak;
      if (streak >= 3) points += streak * 2;

      score += points;
      correctCount++;
      updateScore();

      dropZone.classList.add('correct');
      feedbackEl.className = 'feedback show success';
      feedbackEl.textContent = 'Correct! +' + points + ' points' + (streak >= 3 ? ' (streak bonus!)' : '');

      // Show explanation and parallel line
      explanationEl.className = 'explanation show';
      explanationEl.innerHTML = '<strong>Word order note:</strong> ' + sentenceData.explanation;

      showParallelLine(sentenceData);

      // Disable further interaction
      checkBtn.disabled = true;
      placed.forEach(t => { t.draggable = false; t.style.cursor = 'default'; });

      // Auto-advance
      setTimeout(nextPuzzle, 2500);
    } else {
      streak = 0;
      updateScore();
      dropZone.classList.add('incorrect');
      feedbackEl.className = 'feedback show error';
      feedbackEl.textContent = 'Not quite. Try rearranging the words.';
      setTimeout(() => {
        dropZone.classList.remove('incorrect');
      }, 500);
    }
  });

  resetBtn.addEventListener('click', function () {
    loadPuzzle(puzzleOrder[currentIndex]);
  });

  skipBtn.addEventListener('click', function () {
    streak = 0;
    updateScore();
    nextPuzzle();
  });

  restartBtn.addEventListener('click', function () {
    currentIndex = 0;
    score = 0;
    streak = 0;
    bestStreak = 0;
    correctCount = 0;
    attemptCount = 0;
    updateScore();
    initPuzzleSet();
  });

  /* ===== PARALLEL LINE ===== */
  function showParallelLine(data) {
    let html = '<span class="label">English structure:</span> ';
    data.englishWords.forEach(w => {
      const roleColour = 'var(--' + w.role + ')';
      const roleBg = 'var(--' + w.role + '-bg)';
      html += '<span class="parallel-word" style="color:' + roleColour + ';background:' + roleBg + '">' + w.text + '</span> ';
    });
    parallelLine.innerHTML = html;
    parallelLine.classList.add('visible');
  }

  /* ===== LOAD PUZZLE ===== */
  function loadPuzzle(sentenceIndex) {
    const data = sentences[currentLang][sentenceIndex];

    puzzleCard.style.display = '';
    completeScreen.classList.remove('show');
    feedbackEl.className = 'feedback';
    explanationEl.className = 'explanation';
    parallelLine.classList.remove('visible');
    dropZone.classList.remove('correct', 'incorrect');
    dropZone.innerHTML = '';
    wordBank.innerHTML = '';

    puzzleNumber.textContent = 'Sentence ' + (currentIndex + 1) + ' of ' + sentences[currentLang].length;
    diffBadge.textContent = data.difficulty;
    diffBadge.className = 'difficulty-badge ' + data.difficulty;
    englishHint.innerHTML = '<strong>English:</strong> ' + data.english;

    // Scramble
    const indices = data.words.map((_, i) => i);
    let scrambled = shuffle(indices);
    // Ensure it's not already in order
    while (scrambled.every((v, i) => v === i) && scrambled.length > 1) {
      scrambled = shuffle(indices);
    }

    scrambled.forEach(i => {
      wordBank.appendChild(createTile(data.words[i], i));
    });

    checkBtn.disabled = true;
    startTime = Date.now();
    updateProgress();
  }

  function nextPuzzle() {
    currentIndex++;
    if (currentIndex >= sentences[currentLang].length) {
      showComplete();
    } else {
      loadPuzzle(puzzleOrder[currentIndex]);
    }
  }

  function showComplete() {
    puzzleCard.style.display = 'none';
    completeScreen.classList.add('show');
    finalScore.textContent = score + ' points';
    const total = sentences[currentLang].length;
    finalStats.innerHTML =
      '<span>Correct: ' + correctCount + '/' + total + '</span>' +
      '<span>Best streak: ' + bestStreak + '</span>' +
      '<span>Accuracy: ' + (attemptCount > 0 ? Math.round((correctCount / attemptCount) * 100) : 0) + '%</span>';
    progressFill.style.width = '100%';
  }

  function initPuzzleSet() {
    const total = sentences[currentLang].length;
    puzzleOrder = shuffle([...Array(total).keys()]);
    completeScreen.classList.remove('show');
    puzzleCard.style.display = '';
    updateProgress();
    loadPuzzle(puzzleOrder[0]);
  }

  /* ===== INIT ===== */
  loadInfo();
  initPuzzleSet();
})();
</script>
</body>
</html>
