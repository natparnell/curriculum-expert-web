<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scaffolding &amp; Fading Planner</title>
<style>
  :root {
    --purple-950: #1e0a3c;
    --purple-900: #2d1057;
    --purple-800: #3d1a78;
    --purple-700: #4f258f;
    --purple-600: #6b35a8;
    --purple-500: #8b5cf6;
    --purple-400: #a78bfa;
    --purple-300: #c4b5fd;
    --purple-200: #ddd6fe;
    --purple-100: #ede9fe;
    --purple-50:  #f5f3ff;

    --indigo-700: #3730a3;
    --indigo-600: #4338ca;
    --indigo-500: #6366f1;
    --indigo-400: #818cf8;
    --indigo-200: #c7d2fe;
    --indigo-100: #e0e7ff;
    --indigo-50:  #eef2ff;

    --teal-500: #14b8a6;
    --teal-400: #2dd4bf;
    --teal-100: #ccfbf1;

    --amber-500: #f59e0b;
    --amber-400: #fbbf24;
    --amber-100: #fef3c7;

    --rose-500: #f43f5e;
    --rose-400: #fb7185;
    --rose-100: #ffe4e6;

    --green-500: #22c55e;
    --green-100: #dcfce7;

    --slate-800: #1e293b;
    --slate-700: #334155;
    --slate-600: #475569;
    --slate-500: #64748b;
    --slate-400: #94a3b8;
    --slate-300: #cbd5e1;
    --slate-200: #e2e8f0;
    --slate-100: #f1f5f9;
    --slate-50:  #f8fafc;
    --white: #ffffff;

    --intensity-high-bg: var(--purple-600);
    --intensity-high-border: var(--purple-800);
    --intensity-med-bg: var(--purple-400);
    --intensity-med-border: var(--purple-600);
    --intensity-low-bg: var(--purple-200);
    --intensity-low-border: var(--purple-400);
    --intensity-off-bg: #f1f5f9;
    --intensity-off-border: #cbd5e1;

    --cell-height: 72px;
    --cell-width: 110px;
    --label-width: 160px;
    --radius: 8px;
    --shadow: 0 2px 8px rgba(0,0,0,0.10);
    --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
    --transition: 0.18s ease;
    --font: 'Segoe UI', system-ui, sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: linear-gradient(135deg, var(--purple-950) 0%, var(--indigo-700) 100%);
    min-height: 100vh;
    color: var(--slate-800);
  }

  /* ===== HEADER ===== */
  .site-header {
    background: linear-gradient(90deg, var(--purple-900) 0%, var(--indigo-600) 100%);
    padding: 18px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: var(--shadow-lg);
  }
  .site-header .logo {
    width: 44px; height: 44px;
    background: var(--purple-500);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
  }
  .site-header h1 {
    color: var(--white);
    font-size: 1.45rem;
    font-weight: 700;
    letter-spacing: -0.01em;
  }
  .site-header p {
    color: var(--purple-300);
    font-size: 0.8rem;
    margin-top: 2px;
  }
  .header-right {
    margin-left: auto;
    display: flex; gap: 10px; align-items: center;
  }

  /* ===== BUTTONS ===== */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px;
    border-radius: var(--radius);
    border: none;
    font-family: var(--font);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
  }
  .btn-primary { background: var(--purple-500); color: var(--white); }
  .btn-primary:hover { background: var(--purple-600); }
  .btn-secondary { background: var(--purple-800); color: var(--purple-200); border: 1px solid var(--purple-600); }
  .btn-secondary:hover { background: var(--purple-700); }
  .btn-outline { background: transparent; color: var(--white); border: 1px solid var(--purple-400); }
  .btn-outline:hover { background: var(--purple-800); }
  .btn-danger { background: var(--rose-500); color: var(--white); }
  .btn-danger:hover { background: #e11d48; }
  .btn-sm { padding: 5px 11px; font-size: 0.77rem; }
  .btn-icon { padding: 7px 10px; }

  /* ===== MAIN LAYOUT ===== */
  .main-wrap {
    max-width: 1340px;
    margin: 0 auto;
    padding: 24px 20px 40px;
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 22px;
  }

  /* ===== PANEL CARD ===== */
  .card {
    background: var(--white);
    border-radius: 14px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }
  .card-header {
    background: linear-gradient(90deg, var(--purple-100) 0%, var(--indigo-50) 100%);
    border-bottom: 1px solid var(--purple-200);
    padding: 14px 20px;
    display: flex; align-items: center; gap: 10px;
  }
  .card-header h2 {
    font-size: 0.97rem;
    font-weight: 700;
    color: var(--purple-900);
  }
  .card-header .icon { font-size: 1.1rem; }
  .card-body { padding: 18px 20px; }

  /* ===== CONTROLS BAR ===== */
  .controls-bar {
    background: var(--white);
    border-radius: 14px;
    padding: 14px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    align-items: center;
    box-shadow: var(--shadow);
    margin-bottom: 4px;
  }
  .control-group {
    display: flex; align-items: center; gap: 8px;
    flex-wrap: wrap;
  }
  .control-group label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--purple-700);
    white-space: nowrap;
  }
  select.ctrl-select {
    font-family: var(--font);
    font-size: 0.82rem;
    padding: 6px 10px;
    border: 1.5px solid var(--purple-300);
    border-radius: 6px;
    background: var(--purple-50);
    color: var(--slate-800);
    cursor: pointer;
    outline: none;
    transition: var(--transition);
  }
  select.ctrl-select:hover, select.ctrl-select:focus {
    border-color: var(--purple-500);
  }
  .lesson-count-group {
    display: flex; align-items: center; gap: 6px;
  }
  .lesson-count-btn {
    width: 28px; height: 28px;
    border-radius: 6px;
    border: 1.5px solid var(--purple-300);
    background: var(--purple-50);
    color: var(--purple-700);
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: var(--transition);
  }
  .lesson-count-btn:hover { background: var(--purple-100); border-color: var(--purple-500); }
  .lesson-count-display {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--purple-700);
    min-width: 22px;
    text-align: center;
  }

  /* ===== FADE SLIDER ===== */
  .fade-section {
    background: linear-gradient(90deg, var(--purple-50) 0%, var(--indigo-50) 100%);
    border: 1.5px solid var(--purple-200);
    border-radius: 12px;
    padding: 14px 18px;
    margin-bottom: 4px;
  }
  .fade-header {
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
    margin-bottom: 10px;
  }
  .fade-header h3 {
    font-size: 0.87rem;
    font-weight: 700;
    color: var(--purple-800);
  }
  .fade-controls {
    display: flex; align-items: center; gap: 12px;
    flex-wrap: wrap;
  }
  .fade-slider-wrap {
    display: flex; align-items: center; gap: 10px;
    flex: 1; min-width: 200px;
  }
  .fade-label { font-size: 0.75rem; color: var(--slate-500); white-space: nowrap; }
  input[type=range] {
    -webkit-appearance: none;
    appearance: none;
    flex: 1;
    height: 6px;
    background: linear-gradient(90deg, var(--purple-500) 0%, var(--purple-200) 100%);
    border-radius: 3px;
    outline: none;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: var(--purple-600);
    border: 2px solid var(--white);
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    cursor: pointer;
    transition: background var(--transition);
  }
  input[type=range]::-webkit-slider-thumb:hover { background: var(--purple-500); }
  .fade-value-badge {
    background: var(--purple-600);
    color: var(--white);
    font-size: 0.77rem;
    font-weight: 700;
    padding: 2px 9px;
    border-radius: 20px;
    min-width: 44px;
    text-align: center;
  }
  .fade-animate-btn {
    background: var(--indigo-600);
    color: var(--white);
    border: none;
    border-radius: 8px;
    padding: 7px 16px;
    font-family: var(--font);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: flex; align-items: center; gap: 6px;
    transition: var(--transition);
  }
  .fade-animate-btn:hover { background: var(--purple-700); }
  .fade-animate-btn.running { background: var(--rose-500); }

  /* ===== GRID AREA ===== */
  .grid-section { overflow-x: auto; }

  .scaffold-grid-wrap {
    min-width: 620px;
  }

  /* lesson header row */
  .lesson-header-row {
    display: flex;
    margin-left: var(--label-width);
    margin-bottom: 4px;
    gap: 4px;
  }
  .lesson-header-cell {
    width: var(--cell-width);
    flex-shrink: 0;
    text-align: center;
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--purple-700);
    background: var(--purple-100);
    border-radius: 8px 8px 0 0;
    padding: 6px 4px 4px;
    border: 1.5px solid var(--purple-200);
    border-bottom: none;
    position: relative;
  }
  .lesson-num {
    display: block;
    font-size: 1rem;
    font-weight: 800;
    color: var(--purple-800);
  }

  /* scaffold rows */
  .scaffold-row {
    display: flex;
    align-items: stretch;
    margin-bottom: 4px;
    gap: 4px;
  }
  .scaffold-label {
    width: var(--label-width);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 10px;
    background: var(--purple-50);
    border: 1.5px solid var(--purple-200);
    border-radius: 8px 0 0 8px;
    font-size: 0.74rem;
    font-weight: 600;
    color: var(--purple-800);
    min-height: var(--cell-height);
  }
  .scaffold-label .scaffold-icon { font-size: 1rem; flex-shrink: 0; }

  /* grid cell */
  .grid-cell {
    width: var(--cell-width);
    flex-shrink: 0;
    height: var(--cell-height);
    border-radius: 6px;
    border: 2px solid var(--intensity-off-border);
    background: var(--intensity-off-bg);
    cursor: pointer;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    overflow: hidden;
    transition: border-color var(--transition), box-shadow var(--transition);
    user-select: none;
  }
  .grid-cell:hover { box-shadow: 0 0 0 3px var(--purple-300); }
  .grid-cell.intensity-high {
    border-color: var(--intensity-high-border);
  }
  .grid-cell.intensity-med {
    border-color: var(--intensity-med-border);
  }
  .grid-cell.intensity-low {
    border-color: var(--intensity-low-border);
  }

  /* fill bar inside cell */
  .cell-fill {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    transition: height 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.35s ease;
    border-radius: 4px 4px 0 0;
  }
  .intensity-high .cell-fill {
    height: 90%;
    background: linear-gradient(180deg, var(--purple-400) 0%, var(--purple-600) 100%);
  }
  .intensity-med .cell-fill {
    height: 55%;
    background: linear-gradient(180deg, var(--purple-300) 0%, var(--purple-400) 100%);
  }
  .intensity-low .cell-fill {
    height: 22%;
    background: linear-gradient(180deg, var(--purple-200) 0%, var(--purple-300) 100%);
  }
  .intensity-off .cell-fill { height: 0; }

  /* cell overlay label */
  .cell-label {
    position: relative;
    z-index: 2;
    font-size: 0.65rem;
    font-weight: 700;
    padding-bottom: 5px;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    pointer-events: none;
  }
  .intensity-high .cell-label { color: var(--white); }
  .intensity-med .cell-label { color: var(--purple-900); }
  .intensity-low .cell-label { color: var(--purple-700); }
  .intensity-off .cell-label { color: var(--slate-400); }

  /* note indicator */
  .note-dot {
    position: absolute;
    top: 4px; right: 4px;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--amber-400);
    border: 1.5px solid var(--white);
    z-index: 3;
    display: none;
  }
  .has-note .note-dot { display: block; }

  /* faded state */
  .cell-faded {
    opacity: 0.32;
    pointer-events: none;
  }

  /* ===== SUMMARY ROW ===== */
  .summary-row {
    display: flex;
    margin-left: var(--label-width);
    gap: 4px;
    margin-top: 8px;
  }
  .summary-cell {
    width: var(--cell-width);
    flex-shrink: 0;
    background: var(--purple-900);
    border-radius: 6px;
    padding: 6px 4px;
    text-align: center;
    color: var(--purple-200);
    font-size: 0.7rem;
    font-weight: 600;
  }
  .summary-cell .total-num {
    display: block;
    font-size: 1.2rem;
    font-weight: 800;
    color: var(--white);
    line-height: 1.1;
  }

  /* ===== GRR MODEL ===== */
  .grr-strip {
    display: flex;
    margin-left: var(--label-width);
    gap: 4px;
    margin-top: 4px;
    margin-bottom: 14px;
  }
  .grr-segment {
    flex: 1;
    border-radius: 6px;
    padding: 5px 6px;
    text-align: center;
    font-size: 0.67rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }
  .grr-i { background: var(--indigo-600); color: var(--white); }
  .grr-we { background: var(--purple-500); color: var(--white); }
  .grr-you { background: var(--teal-500); color: var(--white); }
  .grr-label { display: block; font-size: 0.6rem; opacity: 0.85; margin-top: 1px; }

  /* ===== ZPD DIAGRAM ===== */
  .zpd-diagram {
    position: relative;
    height: 180px;
    margin: 8px 0 14px;
  }
  .zpd-svg { width: 100%; height: 100%; }

  /* ===== THEORY PANELS ===== */
  .theory-section { margin-top: 0; }
  .theory-tab-bar {
    display: flex;
    border-bottom: 2px solid var(--purple-200);
    margin-bottom: 12px;
    gap: 2px;
  }
  .theory-tab {
    padding: 7px 12px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--slate-500);
    cursor: pointer;
    border-bottom: 2.5px solid transparent;
    margin-bottom: -2px;
    transition: var(--transition);
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    font-family: var(--font);
    white-space: nowrap;
  }
  .theory-tab.active { color: var(--purple-700); border-bottom-color: var(--purple-600); }
  .theory-tab:hover { color: var(--purple-600); }
  .theory-panel { display: none; }
  .theory-panel.active { display: block; }
  .theory-panel p, .theory-panel li {
    font-size: 0.78rem;
    color: var(--slate-600);
    line-height: 1.6;
  }
  .theory-panel ul { margin-left: 14px; margin-top: 4px; }
  .theory-panel li { margin-bottom: 3px; }
  .theory-panel strong { color: var(--purple-700); }
  .theory-cite {
    font-size: 0.7rem;
    color: var(--slate-400);
    margin-top: 6px;
    font-style: italic;
  }

  /* ===== LEGEND ===== */
  .legend {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 10px;
    align-items: center;
  }
  .legend-item {
    display: flex; align-items: center; gap: 5px;
    font-size: 0.72rem;
    color: var(--slate-600);
  }
  .legend-swatch {
    width: 18px; height: 14px;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .swatch-high { background: var(--purple-600); }
  .swatch-med { background: var(--purple-400); }
  .swatch-low { background: var(--purple-200); border: 1px solid var(--purple-300); }
  .swatch-off { background: var(--slate-100); border: 1px solid var(--slate-300); }

  /* ===== ANNOTATION MODAL ===== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 5, 35, 0.62);
    z-index: 100;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }
  .modal-box {
    background: var(--white);
    border-radius: 14px;
    padding: 26px 28px;
    min-width: 320px;
    max-width: 420px;
    width: 92vw;
    box-shadow: var(--shadow-lg);
    transform: translateY(16px);
    transition: transform 0.2s;
  }
  .modal-overlay.open .modal-box { transform: translateY(0); }
  .modal-box h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--purple-800);
    margin-bottom: 4px;
  }
  .modal-box .modal-sub {
    font-size: 0.77rem;
    color: var(--slate-500);
    margin-bottom: 14px;
  }
  .modal-intensity-row {
    display: flex; gap: 8px; margin-bottom: 14px;
  }
  .intensity-btn {
    flex: 1;
    padding: 8px 4px;
    border-radius: 8px;
    border: 2px solid;
    font-size: 0.75rem;
    font-weight: 700;
    cursor: pointer;
    font-family: var(--font);
    transition: var(--transition);
  }
  .ibtn-off { border-color: var(--slate-300); background: var(--slate-50); color: var(--slate-500); }
  .ibtn-low { border-color: var(--purple-300); background: var(--purple-50); color: var(--purple-700); }
  .ibtn-med { border-color: var(--purple-500); background: var(--purple-100); color: var(--purple-700); }
  .ibtn-high { border-color: var(--purple-700); background: var(--purple-600); color: var(--white); }
  .intensity-btn.selected { box-shadow: 0 0 0 3px var(--purple-300); }
  .ibtn-off.selected { box-shadow: 0 0 0 3px var(--slate-300); }
  .note-textarea {
    width: 100%;
    min-height: 70px;
    border: 1.5px solid var(--purple-200);
    border-radius: 8px;
    padding: 9px 11px;
    font-family: var(--font);
    font-size: 0.82rem;
    color: var(--slate-800);
    resize: vertical;
    outline: none;
    transition: border-color var(--transition);
    margin-bottom: 14px;
  }
  .note-textarea:focus { border-color: var(--purple-500); }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

  /* ===== PRESET CHIPS ===== */
  .preset-chips {
    display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px;
  }
  .preset-chip {
    padding: 5px 12px;
    border-radius: 20px;
    border: 1.5px solid var(--purple-300);
    background: var(--purple-50);
    color: var(--purple-700);
    font-size: 0.73rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    font-family: var(--font);
  }
  .preset-chip:hover { background: var(--purple-100); border-color: var(--purple-500); }
  .preset-chip.active-preset { background: var(--purple-600); color: var(--white); border-color: var(--purple-700); }

  /* ===== PRINT SECTION ===== */
  .print-section {
    margin-top: 0;
  }
  .print-seq-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 8px;
    margin-top: 10px;
  }
  .print-lesson-col {
    background: var(--purple-50);
    border: 1.5px solid var(--purple-200);
    border-radius: 8px;
    padding: 8px;
  }
  .print-lesson-col h4 {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--purple-700);
    margin-bottom: 6px;
    text-align: center;
  }
  .print-scaffold-item {
    font-size: 0.68rem;
    color: var(--slate-600);
    padding: 2px 0;
    border-bottom: 1px solid var(--purple-100);
    display: flex; align-items: center; gap: 4px;
  }
  .print-scaffold-item:last-child { border-bottom: none; }
  .ps-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .ps-high { background: var(--purple-600); }
  .ps-med { background: var(--purple-400); }
  .ps-low { background: var(--purple-200); border: 1px solid var(--purple-300); }

  /* ===== SIDEBAR PANELS ===== */
  .sidebar-stack { display: flex; flex-direction: column; gap: 18px; }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 1080px) {
    .main-wrap { grid-template-columns: 1fr; }
    :root { --cell-width: 96px; }
  }
  @media (max-width: 768px) {
    .site-header { padding: 14px 16px; flex-wrap: wrap; }
    .header-right { width: 100%; justify-content: flex-end; }
    .main-wrap { padding: 14px 10px 30px; gap: 14px; }
    :root { --cell-width: 78px; --label-width: 130px; --cell-height: 60px; }
    .controls-bar { gap: 10px; padding: 12px 14px; }
    .site-header h1 { font-size: 1.1rem; }
  }
  @media (max-width: 480px) {
    :root { --cell-width: 64px; --label-width: 108px; --cell-height: 54px; }
    .scaffold-label { font-size: 0.65rem; padding: 0 6px; }
  }

  /* ===== PRINT STYLES ===== */
  @media print {
    body { background: white; }
    .site-header { background: white; color: black; box-shadow: none; }
    .site-header h1, .site-header p { color: black; }
    .header-right, .controls-bar, .fade-section, .theory-section, .print-section .card-header .btn { display: none; }
    .main-wrap { display: block; max-width: 100%; padding: 0; }
    .sidebar-stack { display: none; }
    .card { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
    .grid-cell { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .cell-fill { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  }

  /* ===== MISC ===== */
  .section-gap { margin-top: 18px; }
  .text-muted { color: var(--slate-500); font-size: 0.77rem; }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 0.68rem;
    font-weight: 700;
  }
  .badge-purple { background: var(--purple-100); color: var(--purple-700); }
  .badge-indigo { background: var(--indigo-100); color: var(--indigo-700); }
  .badge-teal { background: var(--teal-100); color: #0f766e; }

  .fade-arrow-row {
    display: flex;
    margin-left: var(--label-width);
    gap: 4px;
    margin-bottom: 4px;
  }
  .fade-arrow-cell {
    width: var(--cell-width);
    flex-shrink: 0;
    text-align: center;
    font-size: 1.1rem;
    color: var(--purple-400);
    line-height: 1;
  }
  .fade-arrow-cell.fade-active { color: var(--purple-600); }

  /* Tooltip */
  [data-tip] {
    position: relative;
  }
  [data-tip]:hover::after {
    content: attr(data-tip);
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--slate-800);
    color: var(--white);
    font-size: 0.7rem;
    padding: 4px 8px;
    border-radius: 5px;
    white-space: nowrap;
    z-index: 50;
    pointer-events: none;
  }

  .intensity-right-labels {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 4px 0;
    margin-left: 4px;
  }
  .intensity-right-label {
    font-size: 0.6rem;
    color: var(--slate-400);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <div class="logo">&#x1F9E9;</div>
  <div>
    <h1>Scaffolding &amp; Fading Planner</h1>
    <p>Plan, visualise and fade support across a teaching sequence</p>
  </div>
  <div class="header-right">
    <button class="btn btn-outline btn-sm" onclick="printView()">&#128438; Print / Export</button>
    <button class="btn btn-outline btn-sm" onclick="resetAll()">&#x21BA; Reset</button>
  </div>
</header>

<!-- MAIN -->
<div class="main-wrap">
  <div class="left-col">

    <!-- Controls Bar -->
    <div class="controls-bar">
      <div class="control-group">
        <label>Lessons:</label>
        <div class="lesson-count-group">
          <button class="lesson-count-btn" onclick="changeLessons(-1)">&#8722;</button>
          <span class="lesson-count-display" id="lessonCountDisplay">6</span>
          <button class="lesson-count-btn" onclick="changeLessons(1)">&#43;</button>
        </div>
      </div>
      <div class="control-group">
        <label>Load preset:</label>
        <div class="preset-chips" id="presetChips"></div>
      </div>
    </div>

    <!-- Fade Section -->
    <div class="fade-section">
      <div class="fade-header">
        <h3>&#x1F4C9; Scaffold Fading Visualiser</h3>
        <span class="badge badge-purple">Gradual Release</span>
      </div>
      <div class="fade-controls">
        <div class="fade-slider-wrap">
          <span class="fade-label">Full support</span>
          <input type="range" id="fadeSlider" min="0" max="100" value="0"
            oninput="handleFadeSlider(this.value)">
          <span class="fade-label">Fully faded</span>
        </div>
        <span class="fade-value-badge" id="fadeValueBadge">0%</span>
        <button class="fade-animate-btn" id="fadeAnimBtn" onclick="toggleFadeAnimation()">
          &#9654; Animate
        </button>
      </div>
    </div>

    <!-- GRR Strip -->
    <div class="fade-arrow-row" id="grrStrip"></div>

    <!-- Legend -->
    <div class="legend" style="margin-bottom:6px;">
      <span class="text-muted" style="font-weight:600;">Intensity:</span>
      <div class="legend-item"><div class="legend-swatch swatch-high"></div>High</div>
      <div class="legend-item"><div class="legend-swatch swatch-med"></div>Medium</div>
      <div class="legend-item"><div class="legend-swatch swatch-low"></div>Low</div>
      <div class="legend-item"><div class="legend-swatch swatch-off"></div>Not used</div>
      <div class="legend-item"><div style="width:8px;height:8px;border-radius:50%;background:var(--amber-400);"></div>Has note</div>
      <span class="text-muted" style="margin-left:auto;">Click cell to set intensity &amp; add note</span>
    </div>

    <!-- Grid -->
    <div class="grid-section card" style="padding:16px;">
      <div class="scaffold-grid-wrap">
        <div class="lesson-header-row" id="lessonHeaderRow"></div>
        <div id="scaffoldRows"></div>
        <div class="summary-row" id="summaryRow"></div>
      </div>
    </div>

    <!-- Print Preview -->
    <div class="section-gap card print-section" id="printSection" style="display:none;">
      <div class="card-header">
        <span class="icon">&#128438;</span>
        <h2>Sequence Summary</h2>
        <button class="btn btn-primary btn-sm" style="margin-left:auto;" onclick="window.print()">Print</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('printSection').style.display='none'">Close</button>
      </div>
      <div class="card-body">
        <div class="print-seq-grid" id="printSeqGrid"></div>
      </div>
    </div>

  </div><!-- /left-col -->

  <!-- SIDEBAR -->
  <div class="sidebar-stack">

    <!-- ZPD Diagram -->
    <div class="card">
      <div class="card-header">
        <span class="icon">&#129504;</span>
        <h2>Vygotsky's ZPD</h2>
      </div>
      <div class="card-body" style="padding-top:10px;">
        <div class="zpd-diagram">
          <svg class="zpd-svg" viewBox="0 0 300 170" xmlns="http://www.w3.org/2000/svg">
            <!-- Outer circle: Beyond ZPD -->
            <ellipse cx="150" cy="95" rx="138" ry="70" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
            <!-- ZPD ring -->
            <ellipse cx="150" cy="95" rx="98" ry="50" fill="#ddd6fe" stroke="#6b35a8" stroke-width="2"/>
            <!-- Inner circle: Current ability -->
            <ellipse cx="150" cy="95" rx="58" ry="30" fill="#6b35a8" stroke="#3d1a78" stroke-width="2"/>
            <!-- Labels -->
            <text x="150" y="90" text-anchor="middle" fill="white" font-size="9" font-weight="bold" font-family="Segoe UI,sans-serif">Current</text>
            <text x="150" y="103" text-anchor="middle" fill="white" font-size="9" font-weight="bold" font-family="Segoe UI,sans-serif">Ability</text>
            <text x="150" y="132" text-anchor="middle" fill="#4f258f" font-size="9" font-weight="bold" font-family="Segoe UI,sans-serif">Zone of Proximal Development</text>
            <text x="150" y="148" text-anchor="middle" fill="#4f258f" font-size="8" font-family="Segoe UI,sans-serif">(with scaffolding)</text>
            <text x="150" y="20" text-anchor="middle" fill="#6b35a8" font-size="8.5" font-weight="bold" font-family="Segoe UI,sans-serif">Beyond Current Reach</text>
            <!-- Arrow upward -->
            <path d="M150 88 L150 52" stroke="#f59e0b" stroke-width="2" marker-end="url(#arr)"/>
            <defs>
              <marker id="arr" markerWidth="7" markerHeight="7" refX="3.5" refY="3.5" orient="auto">
                <polygon points="0 0, 7 3.5, 0 7" fill="#f59e0b"/>
              </marker>
            </defs>
            <text x="162" y="72" fill="#d97706" font-size="7.5" font-family="Segoe UI,sans-serif">Scaffolded</text>
            <text x="162" y="82" fill="#d97706" font-size="7.5" font-family="Segoe UI,sans-serif">progress</text>
          </svg>
        </div>
        <p style="font-size:0.74rem; color:var(--slate-500); text-align:center; margin-top:-4px;">
          Scaffolding enables learners to work within their ZPD, moving towards independence as support fades.
        </p>
      </div>
    </div>

    <!-- Theory Panels -->
    <div class="card theory-section">
      <div class="card-header">
        <span class="icon">&#128218;</span>
        <h2>Theoretical Foundations</h2>
      </div>
      <div class="card-body" style="padding-top:12px;">
        <div class="theory-tab-bar">
          <button class="theory-tab active" onclick="showTheory('zpd', this)">ZPD</button>
          <button class="theory-tab" onclick="showTheory('grr', this)">GRR Model</button>
          <button class="theory-tab" onclick="showTheory('meta', this)">Metacognition</button>
        </div>
        <div class="theory-panel active" id="theory-zpd">
          <p><strong>Vygotsky (1978)</strong> proposed that children learn best when working just beyond their current independent ability, in the Zone of Proximal Development.</p>
          <ul>
            <li><strong>Wood, Bruner &amp; Ross (1976)</strong> coined the term scaffolding to describe how an expert adjusts support in response to learner performance.</li>
            <li>Scaffolding is contingent, temporary and ultimately withdrawn.</li>
            <li>The goal is always independence, not dependency.</li>
          </ul>
          <p class="theory-cite">Wood, D., Bruner, J.S., &amp; Ross, G. (1976). The role of tutoring in problem solving. Journal of Child Psychology and Psychiatry, 17(2), 89-100.</p>
        </div>
        <div class="theory-panel" id="theory-grr">
          <p><strong>Gradual Release of Responsibility</strong> (Pearson &amp; Gallagher, 1983) structures learning across three stages:</p>
          <ul>
            <li><strong>I Do:</strong> Teacher models explicitly. Maximum scaffolding. Worked examples and modelling are central.</li>
            <li><strong>We Do:</strong> Shared and guided practice. Peer support, sentence starters and graphic organisers help.</li>
            <li><strong>You Do:</strong> Independent practice. Scaffolds fade. Self-regulation takes over.</li>
          </ul>
          <p>Map your lessons to these phases using the colour-coded strip above the grid.</p>
          <p class="theory-cite">Pearson, P.D., &amp; Gallagher, M.C. (1983). The instruction of reading comprehension. Contemporary Educational Psychology, 8(3), 317-344.</p>
        </div>
        <div class="theory-panel" id="theory-meta">
          <p><strong>Metacognition</strong> (thinking about one's own thinking) is closely linked to scaffold fading.</p>
          <ul>
            <li>As scaffolds reduce, learners must increasingly self-monitor and self-regulate.</li>
            <li>Writing frames and cloze procedures build metacognitive vocabulary.</li>
            <li>Sentence starters scaffold the <em>language</em> of reasoning before learners internalise it.</li>
            <li>The EEF (2021) rates metacognition as high-impact, low-cost for all age groups.</li>
          </ul>
          <p class="theory-cite">EEF Teaching &amp; Learning Toolkit: Metacognition &amp; Self-regulation (2021).</p>
        </div>
      </div>
    </div>

    <!-- Scaffold Key -->
    <div class="card">
      <div class="card-header">
        <span class="icon">&#128273;</span>
        <h2>Scaffold Descriptions</h2>
      </div>
      <div class="card-body" style="padding:12px 16px;">
        <div id="scaffoldKey"></div>
      </div>
    </div>

  </div><!-- /sidebar-stack -->
</div><!-- /main-wrap -->

<!-- ANNOTATION MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOnBack(event)">
  <div class="modal-box">
    <h3 id="modalTitle">Edit Cell</h3>
    <p class="modal-sub" id="modalSub"></p>
    <div class="modal-intensity-row">
      <button class="intensity-btn ibtn-off" onclick="selectIntensity('off', this)">Off</button>
      <button class="intensity-btn ibtn-low" onclick="selectIntensity('low', this)">Low</button>
      <button class="intensity-btn ibtn-med" onclick="selectIntensity('med', this)">Med</button>
      <button class="intensity-btn ibtn-high" onclick="selectIntensity('high', this)">High</button>
    </div>
    <textarea class="note-textarea" id="modalNote" placeholder="Add a brief note (optional)..."></textarea>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveModal()">Save</button>
    </div>
  </div>
</div>

<script>
// ============================================================
//  DATA MODEL
// ============================================================

const SCAFFOLDS = [
  { id: 'worked',   label: 'Worked Examples',      icon: 'ðŸ“‹', desc: 'Step-by-step models of completed tasks showing expert thinking. Reduces cognitive load by demonstrating the process before practice.' },
  { id: 'sentence', label: 'Sentence Starters',     icon: 'âœï¸', desc: 'Partial sentences that scaffold academic language. Help pupils express reasoning before they have internalised the vocabulary.' },
  { id: 'wordbank', label: 'Word Banks',             icon: 'ðŸ“š', desc: 'Curated lists of subject-specific vocabulary. Support retrieval and model precise language use without constraining ideas.' },
  { id: 'graphic',  label: 'Graphic Organisers',    icon: 'ðŸ—ºï¸', desc: 'Visual frameworks (mind maps, Venn diagrams, tables) that externalise thinking and reduce working memory demands.' },
  { id: 'peer',     label: 'Peer Support',           icon: 'ðŸ‘¥', desc: 'Structured collaboration: think-pair-share, expert jigsaws. Provides scaffolding through social interaction within the ZPD.' },
  { id: 'model',    label: 'Teacher Modelling',      icon: 'ðŸŽ¯', desc: 'Live, explicit demonstration with think-aloud. The "I Do" phase of GRR. Makes expert thinking visible and imitable.' },
  { id: 'cloze',    label: 'Cloze Procedure',        icon: 'ðŸ”¤', desc: 'Structured text with gaps to complete. Builds familiarity with academic sentence patterns while keeping the cognitive challenge.' },
  { id: 'frames',   label: 'Writing Frames',         icon: 'ðŸ“', desc: 'Structural templates for extended writing. Scaffold genre conventions and text organisation before pupils write independently.' },
];

const MAX_LESSONS = 8;
const INTENSITIES = ['off', 'low', 'med', 'high'];
const INTENSITY_LABELS = { off: '', low: 'Low', med: 'Med', high: 'High' };

// grid[scaffoldIndex][lessonIndex] = { intensity: 'off'|'low'|'med'|'high', note: '' }
let grid = [];
let lessonCount = 6;
let fadeValue = 0;
let animInterval = null;
let modalTarget = null; // { row, col }
let modalTempIntensity = 'off';
let activePreset = null;

// ============================================================
//  PRESETS
// ============================================================

const PRESETS = {
  english: {
    label: 'English Writing',
    lessons: 6,
    data: [
      // Worked Examples
      ['high','high','med','low','off','off'],
      // Sentence Starters
      ['high','high','high','med','low','off'],
      // Word Banks
      ['med','high','high','med','low','off'],
      // Graphic Organisers
      ['high','med','med','low','off','off'],
      // Peer Support
      ['off','med','high','high','med','low'],
      // Teacher Modelling
      ['high','high','med','off','off','off'],
      // Cloze Procedure
      ['med','med','low','off','off','off'],
      // Writing Frames
      ['high','high','med','med','low','off'],
    ]
  },
  maths: {
    label: 'Maths Concepts',
    lessons: 5,
    data: [
      ['high','high','med','low','off'],
      ['med','high','med','low','off'],
      ['off','off','off','off','off'],
      ['high','med','low','off','off'],
      ['off','med','med','low','off'],
      ['high','high','high','med','low'],
      ['high','med','off','off','off'],
      ['off','off','off','off','off'],
    ]
  },
  science: {
    label: 'Science Investigation',
    lessons: 7,
    data: [
      ['high','med','med','low','off','off','off'],
      ['high','high','med','med','low','off','off'],
      ['med','high','high','med','off','off','off'],
      ['high','med','med','low','off','off','off'],
      ['off','med','high','high','med','low','off'],
      ['high','high','med','low','off','off','off'],
      ['med','med','low','off','off','off','off'],
      ['high','med','med','low','off','off','off'],
    ]
  },
};

// ============================================================
//  INIT
// ============================================================

function initGrid() {
  grid = SCAFFOLDS.map(() =>
    Array.from({ length: MAX_LESSONS }, () => ({ intensity: 'off', note: '' }))
  );
}

function boot() {
  initGrid();
  renderPresetChips();
  renderAll();
  buildScaffoldKey();
  loadPreset('english');
}

// ============================================================
//  RENDER
// ============================================================

function renderAll() {
  renderLessonHeaders();
  renderScaffoldRows();
  renderSummaryRow();
  renderGRRStrip();
}

function renderLessonHeaders() {
  const row = document.getElementById('lessonHeaderRow');
  row.innerHTML = '';
  for (let l = 0; l < lessonCount; l++) {
    const cell = document.createElement('div');
    cell.className = 'lesson-header-cell';
    cell.innerHTML = `<span class="lesson-num">${l + 1}</span>Lesson`;
    row.appendChild(cell);
  }
}

function renderScaffoldRows() {
  const container = document.getElementById('scaffoldRows');
  container.innerHTML = '';
  SCAFFOLDS.forEach((scaffold, ri) => {
    const row = document.createElement('div');
    row.className = 'scaffold-row';

    const label = document.createElement('div');
    label.className = 'scaffold-label';
    label.innerHTML = `<span class="scaffold-icon">${scaffold.icon}</span>${scaffold.label}`;
    row.appendChild(label);

    for (let ci = 0; ci < lessonCount; ci++) {
      const cell = buildCell(ri, ci);
      row.appendChild(cell);
    }
    container.appendChild(row);
  });
}

function buildCell(ri, ci) {
  const d = grid[ri][ci];
  const intensity = getDisplayIntensity(ri, ci);
  const el = document.createElement('div');
  el.className = `grid-cell intensity-${intensity}${d.note ? ' has-note' : ''}`;
  el.dataset.row = ri;
  el.dataset.col = ci;
  el.innerHTML = `
    <div class="cell-fill"></div>
    <span class="cell-label">${INTENSITY_LABELS[intensity]}</span>
    <div class="note-dot" title="${escHtml(d.note)}"></div>
  `;
  el.addEventListener('click', () => openModal(ri, ci));
  return el;
}

function renderSummaryRow() {
  const row = document.getElementById('summaryRow');
  row.innerHTML = '';
  for (let ci = 0; ci < lessonCount; ci++) {
    let total = 0;
    SCAFFOLDS.forEach((_, ri) => {
      const intens = grid[ri][ci].intensity;
      if (intens === 'high') total += 3;
      else if (intens === 'med') total += 2;
      else if (intens === 'low') total += 1;
    });
    const cell = document.createElement('div');
    cell.className = 'summary-cell';
    cell.innerHTML = `<span class="total-num">${total}</span>Scaffold score`;
    row.appendChild(cell);
  }
}

function renderGRRStrip() {
  const strip = document.getElementById('grrStrip');
  strip.innerHTML = '';
  const phases = getGRRPhases();
  phases.forEach(phase => {
    const seg = document.createElement('div');
    let cls = 'grr-i';
    let phaseLabel = 'I Do';
    if (phase === 'we') { cls = 'grr-we'; phaseLabel = 'We Do'; }
    if (phase === 'you') { cls = 'grr-you'; phaseLabel = 'You Do'; }
    seg.className = `grr-segment ${cls}`;
    seg.innerHTML = `${phaseLabel}<span class="grr-label">${phase === 'i' ? 'Model' : phase === 'we' ? 'Guided' : 'Independent'}</span>`;
    strip.appendChild(seg);
  });
}

function getGRRPhases() {
  // Determine phases by lesson scaffold score
  const scores = [];
  for (let ci = 0; ci < lessonCount; ci++) {
    let total = 0;
    SCAFFOLDS.forEach((_, ri) => {
      const intens = grid[ri][ci].intensity;
      if (intens === 'high') total += 3;
      else if (intens === 'med') total += 2;
      else if (intens === 'low') total += 1;
    });
    scores.push(total);
  }
  const maxScore = Math.max(...scores, 1);
  return scores.map(s => {
    const ratio = s / maxScore;
    if (ratio >= 0.55) return 'i';
    if (ratio >= 0.2) return 'we';
    return 'you';
  });
}

// ============================================================
//  FADE / DISPLAY INTENSITY
// ============================================================

function getDisplayIntensity(ri, ci) {
  const base = grid[ri][ci].intensity;
  if (base === 'off') return 'off';
  // Fade reduces intensity from right side first
  const fadeRatio = fadeValue / 100;
  // Lesson position 0=first, lessonCount-1=last
  // At full fade, later lessons lose intensity first
  const lessonFactor = (ci / (lessonCount - 1 || 1)); // 0..1
  const fadeCutoff = fadeRatio * 1.4 - (1 - lessonFactor) * 0.4;
  if (fadeCutoff >= 1.0) return 'off';
  if (fadeCutoff >= 0.65) {
    if (base === 'high') return 'low';
    return 'off';
  }
  if (fadeCutoff >= 0.3) {
    if (base === 'high') return 'med';
    if (base === 'med') return 'low';
    return 'off';
  }
  return base;
}

function handleFadeSlider(val) {
  fadeValue = parseInt(val);
  document.getElementById('fadeValueBadge').textContent = val + '%';
  refreshCellIntensities();
}

function refreshCellIntensities() {
  const cells = document.querySelectorAll('.grid-cell');
  cells.forEach(cell => {
    const ri = parseInt(cell.dataset.row);
    const ci = parseInt(cell.dataset.col);
    if (isNaN(ri) || isNaN(ci)) return;
    const intensity = getDisplayIntensity(ri, ci);
    // Update classes
    INTENSITIES.forEach(i => cell.classList.remove('intensity-' + i));
    cell.classList.add('intensity-' + intensity);
    // Update label
    const lbl = cell.querySelector('.cell-label');
    if (lbl) lbl.textContent = INTENSITY_LABELS[intensity];
  });
}

function toggleFadeAnimation() {
  const btn = document.getElementById('fadeAnimBtn');
  if (animInterval) {
    clearInterval(animInterval);
    animInterval = null;
    btn.textContent = 'â–¶ Animate';
    btn.classList.remove('running');
    return;
  }
  // Reset to 0 and animate
  fadeValue = 0;
  document.getElementById('fadeSlider').value = 0;
  document.getElementById('fadeValueBadge').textContent = '0%';
  btn.textContent = 'â–  Stop';
  btn.classList.add('running');

  animInterval = setInterval(() => {
    fadeValue += 1;
    document.getElementById('fadeSlider').value = fadeValue;
    document.getElementById('fadeValueBadge').textContent = fadeValue + '%';
    refreshCellIntensities();
    if (fadeValue >= 100) {
      clearInterval(animInterval);
      animInterval = null;
      btn.textContent = 'â–¶ Animate';
      btn.classList.remove('running');
    }
  }, 55);
}

// ============================================================
//  MODAL
// ============================================================

function openModal(ri, ci) {
  modalTarget = { ri, ci };
  const d = grid[ri][ci];
  modalTempIntensity = d.intensity;
  document.getElementById('modalTitle').textContent = SCAFFOLDS[ri].label + ' - Lesson ' + (ci + 1);
  document.getElementById('modalSub').textContent = SCAFFOLDS[ri].desc;
  document.getElementById('modalNote').value = d.note;

  // Set intensity buttons
  document.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('selected'));
  const map = { off: 0, low: 1, med: 2, high: 3 };
  const btns = document.querySelectorAll('.intensity-btn');
  btns[map[modalTempIntensity]].classList.add('selected');

  document.getElementById('modalOverlay').classList.add('open');
  setTimeout(() => document.getElementById('modalNote').focus(), 200);
}

function selectIntensity(val, btn) {
  modalTempIntensity = val;
  document.querySelectorAll('.intensity-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  modalTarget = null;
}

function closeModalOnBack(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

function saveModal() {
  if (!modalTarget) return;
  const { ri, ci } = modalTarget;
  grid[ri][ci].intensity = modalTempIntensity;
  grid[ri][ci].note = document.getElementById('modalNote').value.trim();
  closeModal();
  renderScaffoldRows();
  renderSummaryRow();
  renderGRRStrip();
  refreshCellIntensities();
}

// ============================================================
//  LESSON COUNT
// ============================================================

function changeLessons(delta) {
  const next = lessonCount + delta;
  if (next < 2 || next > MAX_LESSONS) return;
  lessonCount = next;
  document.getElementById('lessonCountDisplay').textContent = lessonCount;
  renderAll();
}

// ============================================================
//  PRESETS
// ============================================================

function renderPresetChips() {
  const container = document.getElementById('presetChips');
  container.innerHTML = '';
  Object.entries(PRESETS).forEach(([key, preset]) => {
    const chip = document.createElement('button');
    chip.className = 'preset-chip';
    chip.textContent = preset.label;
    chip.dataset.key = key;
    chip.onclick = () => loadPreset(key);
    container.appendChild(chip);
  });
}

function loadPreset(key) {
  const preset = PRESETS[key];
  if (!preset) return;
  lessonCount = preset.lessons;
  document.getElementById('lessonCountDisplay').textContent = lessonCount;
  initGrid();
  preset.data.forEach((row, ri) => {
    row.forEach((intensity, ci) => {
      if (ci < MAX_LESSONS && ri < SCAFFOLDS.length) {
        grid[ri][ci].intensity = intensity;
      }
    });
  });
  // Reset fade
  fadeValue = 0;
  document.getElementById('fadeSlider').value = 0;
  document.getElementById('fadeValueBadge').textContent = '0%';
  activePreset = key;
  document.querySelectorAll('.preset-chip').forEach(chip => {
    chip.classList.toggle('active-preset', chip.dataset.key === key);
  });
  renderAll();
}

// ============================================================
//  RESET
// ============================================================

function resetAll() {
  if (!confirm('Reset the entire grid? This cannot be undone.')) return;
  initGrid();
  lessonCount = 6;
  document.getElementById('lessonCountDisplay').textContent = lessonCount;
  fadeValue = 0;
  document.getElementById('fadeSlider').value = 0;
  document.getElementById('fadeValueBadge').textContent = '0%';
  if (animInterval) {
    clearInterval(animInterval);
    animInterval = null;
    document.getElementById('fadeAnimBtn').textContent = 'â–¶ Animate';
    document.getElementById('fadeAnimBtn').classList.remove('running');
  }
  activePreset = null;
  document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('active-preset'));
  renderAll();
}

// ============================================================
//  PRINT / EXPORT
// ============================================================

function printView() {
  const section = document.getElementById('printSection');
  section.style.display = '';
  const grid_el = document.getElementById('printSeqGrid');
  grid_el.innerHTML = '';
  for (let ci = 0; ci < lessonCount; ci++) {
    const col = document.createElement('div');
    col.className = 'print-lesson-col';
    col.innerHTML = `<h4>Lesson ${ci + 1}</h4>`;
    SCAFFOLDS.forEach((scaffold, ri) => {
      const d = grid[ri][ci];
      if (d.intensity === 'off') return;
      const item = document.createElement('div');
      item.className = 'print-scaffold-item';
      item.innerHTML = `<div class="ps-dot ps-${d.intensity}"></div>${scaffold.label}${d.note ? ' <em>(' + escHtml(d.note) + ')</em>' : ''}`;
      col.appendChild(item);
    });
    if (col.querySelectorAll('.print-scaffold-item').length === 0) {
      col.innerHTML += '<p style="font-size:0.65rem;color:#94a3b8;text-align:center;margin-top:6px;">Independent</p>';
    }
    grid_el.appendChild(col);
  }
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ============================================================
//  SCAFFOLD KEY
// ============================================================

function buildScaffoldKey() {
  const container = document.getElementById('scaffoldKey');
  container.innerHTML = '';
  SCAFFOLDS.forEach(s => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:8px;align-items:flex-start;margin-bottom:9px;';
    row.innerHTML = `
      <span style="font-size:1rem;flex-shrink:0;margin-top:1px;">${s.icon}</span>
      <div>
        <div style="font-size:0.75rem;font-weight:700;color:var(--purple-700);">${s.label}</div>
        <div style="font-size:0.7rem;color:var(--slate-500);line-height:1.45;">${s.desc}</div>
      </div>
    `;
    container.appendChild(row);
  });
}

// ============================================================
//  THEORY TABS
// ============================================================

function showTheory(id, btn) {
  document.querySelectorAll('.theory-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.theory-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('theory-' + id).classList.add('active');
}

// ============================================================
//  UTILITY
// ============================================================

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// ============================================================
//  KEYBOARD
// ============================================================

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// ============================================================
//  START
// ============================================================

boot();
</script>
</body>
</html>
