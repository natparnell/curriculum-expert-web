<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vectors Visualiser - GCSE/A-Level Mathematics</title>
    <style>
        /* CSS Reset and Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --vec-a: #2563eb;
            --vec-a-light: #93bbfd;
            --vec-b: #dc2626;
            --vec-b-light: #fca5a5;
            --vec-r: #059669;
            --vec-r-light: #6ee7b7;
            --axis-color: #374151;
            --grid-color: #e5e7eb;
            --grid-color-strong: #cbd5e1;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --parallelogram-color: rgba(5, 150, 105, 0.1);
        }

        html { font-size: 16px; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 1.25rem 2rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.15rem;
        }

        header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* Main Layout */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.25rem;
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1.25rem;
        }

        /* Canvas container */
        .canvas-wrap {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        canvas {
            width: 100%;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            cursor: crosshair;
            display: block;
        }

        /* Readout bar beneath canvas */
        .readout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        .readout-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 0.6rem 0.75rem;
            border-left: 4px solid var(--vec-a);
        }

        .readout-card.vec-b { border-left-color: var(--vec-b); }
        .readout-card.vec-r { border-left-color: var(--vec-r); }

        .readout-card .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 0.15rem;
        }

        .readout-card .values {
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'Courier New', Courier, monospace;
        }

        .readout-card .meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.1rem;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 1rem 1.15rem;
        }

        .panel h2 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        /* Input groups */
        .vec-input-group { margin-bottom: 0.85rem; }

        .vec-input-group .vec-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }

        .vec-input-group .vec-label .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .dot-a { background: var(--vec-a); }
        .dot-b { background: var(--vec-b); }

        .vec-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .vec-row label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            width: 1rem;
            text-align: center;
        }

        .vec-row input[type="number"] {
            flex: 1;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            background: var(--bg-tertiary);
            outline: none;
            transition: border-color 0.15s;
        }

        .vec-row input[type="number"]:focus {
            border-color: var(--vec-a);
        }

        /* Operation selector */
        .op-selector {
            display: flex;
            gap: 0.35rem;
            margin-bottom: 0.75rem;
        }

        .op-btn {
            flex: 1;
            padding: 0.45rem 0.3rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
            color: var(--text-secondary);
        }

        .op-btn:hover { border-color: var(--vec-r); }

        .op-btn.active {
            border-color: var(--vec-r);
            background: var(--vec-r);
            color: white;
        }

        /* Scalar slider */
        .scalar-group {
            margin-bottom: 0.5rem;
            display: none;
        }

        .scalar-group.visible { display: block; }

        .scalar-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .scalar-group input[type="range"] {
            width: 100%;
            margin-top: 0.25rem;
            accent-color: var(--vec-r);
        }

        /* Toggle switches */
        .toggle-list { display: flex; flex-direction: column; gap: 0.5rem; }

        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.82rem;
        }

        .toggle-item span { color: var(--text-secondary); }

        .switch {
            position: relative;
            width: 38px;
            height: 20px;
            flex-shrink: 0;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            inset: 0;
            background: var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }

        .slider::before {
            content: '';
            position: absolute;
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .switch input:checked + .slider { background: var(--vec-r); }
        .switch input:checked + .slider::before { transform: translateX(18px); }

        /* Info panel */
        .info-panel {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 1rem 1.15rem;
            grid-column: 1 / -1;
        }

        .info-panel h2 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.6rem;
            padding-bottom: 0.4rem;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
        }

        .info-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 0.85rem 1rem;
        }

        .info-card h3 {
            font-size: 0.82rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
            color: var(--text-primary);
        }

        .info-card p, .info-card ul {
            font-size: 0.78rem;
            color: var(--text-secondary);
            line-height: 1.55;
        }

        .info-card ul {
            padding-left: 1.1rem;
            margin-top: 0.25rem;
        }

        .info-card code {
            background: var(--bg-secondary);
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            font-size: 0.76rem;
            font-family: 'Courier New', Courier, monospace;
        }

        /* Reset button */
        .btn-reset {
            width: 100%;
            padding: 0.5rem;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-reset:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
            }
            .readout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            header { padding: 1rem; }
            header h1 { font-size: 1.3rem; }
            main { padding: 0.75rem; }
            .op-selector { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Vectors Visualiser</h1>
        <p>Interactive 2D vector addition, subtraction, and scalar multiplication</p>
    </header>

    <main>
        <!-- Canvas area -->
        <div class="canvas-wrap">
            <canvas id="vecCanvas" width="700" height="500"></canvas>
            <div class="readout">
                <div class="readout-card vec-a">
                    <div class="label">Vector a</div>
                    <div class="values" id="readA">(3, 2)</div>
                    <div class="meta" id="readAMeta">|a| = 3.61, &theta; = 33.7&deg;</div>
                </div>
                <div class="readout-card vec-b">
                    <div class="label">Vector b</div>
                    <div class="values" id="readB">(-1, 4)</div>
                    <div class="meta" id="readBMeta">|b| = 4.12, &theta; = 104.0&deg;</div>
                </div>
                <div class="readout-card vec-r">
                    <div class="label">Resultant</div>
                    <div class="values" id="readR">(2, 6)</div>
                    <div class="meta" id="readRMeta">|r| = 6.32, &theta; = 71.6&deg;</div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Vector inputs -->
            <div class="panel">
                <h2>Vector Components</h2>
                <div class="vec-input-group">
                    <div class="vec-label"><span class="dot dot-a"></span> Vector a</div>
                    <div class="vec-row">
                        <label>x</label>
                        <input type="number" id="ax" value="3" step="0.5" min="-10" max="10">
                        <label>y</label>
                        <input type="number" id="ay" value="2" step="0.5" min="-10" max="10">
                    </div>
                </div>
                <div class="vec-input-group">
                    <div class="vec-label"><span class="dot dot-b"></span> Vector b</div>
                    <div class="vec-row">
                        <label>x</label>
                        <input type="number" id="bx" value="-1" step="0.5" min="-10" max="10">
                        <label>y</label>
                        <input type="number" id="by" value="4" step="0.5" min="-10" max="10">
                    </div>
                </div>
                <button class="btn-reset" id="btnReset">Reset to defaults</button>
            </div>

            <!-- Operation -->
            <div class="panel">
                <h2>Operation</h2>
                <div class="op-selector">
                    <button class="op-btn active" data-op="add">a + b</button>
                    <button class="op-btn" data-op="sub">a - b</button>
                    <button class="op-btn" data-op="scalar">Scalar</button>
                </div>
                <div class="scalar-group" id="scalarGroup">
                    <label>
                        Multiplier (k)
                        <span id="scalarVal">2.0</span>
                    </label>
                    <input type="range" id="scalarSlider" min="-3" max="3" step="0.1" value="2">
                    <div style="font-size:0.75rem; color:var(--text-muted); margin-top:0.25rem;">
                        Result = k &middot; a (green vector)
                    </div>
                </div>
            </div>

            <!-- Display options -->
            <div class="panel">
                <h2>Display Options</h2>
                <div class="toggle-list">
                    <div class="toggle-item">
                        <span>Show components</span>
                        <label class="switch">
                            <input type="checkbox" id="togComponents" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <span>Show parallelogram</span>
                        <label class="switch">
                            <input type="checkbox" id="togParallelogram" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <span>Show unit vectors</span>
                        <label class="switch">
                            <input type="checkbox" id="togUnit">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <span>Show labels</span>
                        <label class="switch">
                            <input type="checkbox" id="togLabels" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <span>Snap to grid</span>
                        <label class="switch">
                            <input type="checkbox" id="togSnap" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info panel -->
        <div class="info-panel">
            <h2>Vector Reference</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3>Column Vector Notation</h3>
                    <p>A 2D vector is written as a column: <code>(x, y)</code>. The x-component is the horizontal displacement; the y-component is the vertical displacement. For example, <code>(3, 2)</code> means 3 right and 2 up from the origin.</p>
                </div>
                <div class="info-card">
                    <h3>Magnitude</h3>
                    <p>The magnitude (length) of vector <code>(x, y)</code> is calculated using Pythagoras:</p>
                    <p style="margin-top:0.3rem;"><code>|v| = sqrt(x&sup2; + y&sup2;)</code></p>
                    <p style="margin-top:0.3rem;">The direction angle from the positive x-axis is <code>&theta; = atan2(y, x)</code>.</p>
                </div>
                <div class="info-card">
                    <h3>Addition and Subtraction</h3>
                    <ul>
                        <li><strong>Addition:</strong> <code>(a1+b1, a2+b2)</code>. The parallelogram rule: place both vectors at the origin; the diagonal of the parallelogram is the resultant.</li>
                        <li><strong>Subtraction:</strong> <code>(a1-b1, a2-b2)</code>. Equivalent to adding a + (-b).</li>
                    </ul>
                </div>
                <div class="info-card">
                    <h3>Scalar Multiplication</h3>
                    <p>Multiplying vector <code>(x, y)</code> by scalar k gives <code>(kx, ky)</code>. This scales the magnitude by |k|. If k is negative the direction reverses. A unit vector has magnitude 1: <code>v&#770; = v / |v|</code>.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
    (function () {
        'use strict';

        /* --------------------------------------------------------
           State
        -------------------------------------------------------- */
        const state = {
            a: { x: 3, y: 2 },
            b: { x: -1, y: 4 },
            op: 'add',       // add | sub | scalar
            scalar: 2,
            show: {
                components: true,
                parallelogram: true,
                unit: false,
                labels: true,
                snap: true
            },
            dragging: null   // 'a' | 'b' | null
        };

        /* --------------------------------------------------------
           DOM refs
        -------------------------------------------------------- */
        const canvas = document.getElementById('vecCanvas');
        const ctx = canvas.getContext('2d');

        const elAx = document.getElementById('ax');
        const elAy = document.getElementById('ay');
        const elBx = document.getElementById('bx');
        const elBy = document.getElementById('by');

        const readA = document.getElementById('readA');
        const readB = document.getElementById('readB');
        const readR = document.getElementById('readR');
        const readAMeta = document.getElementById('readAMeta');
        const readBMeta = document.getElementById('readBMeta');
        const readRMeta = document.getElementById('readRMeta');

        const opBtns = document.querySelectorAll('.op-btn');
        const scalarGroup = document.getElementById('scalarGroup');
        const scalarSlider = document.getElementById('scalarSlider');
        const scalarVal = document.getElementById('scalarVal');

        const togComponents = document.getElementById('togComponents');
        const togParallelogram = document.getElementById('togParallelogram');
        const togUnit = document.getElementById('togUnit');
        const togLabels = document.getElementById('togLabels');
        const togSnap = document.getElementById('togSnap');

        /* --------------------------------------------------------
           Canvas coordinate system
        -------------------------------------------------------- */
        const GRID = 10;          // units visible each side of origin
        let dpr = 1;
        let cw, ch, ox, oy, scale;

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const w = Math.floor(rect.width - 32);   // subtract padding
            const aspect = 500 / 700;
            const h = Math.floor(w * aspect);

            dpr = window.devicePixelRatio || 1;
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';

            cw = canvas.width;
            ch = canvas.height;
            ox = cw / 2;
            oy = ch / 2;
            scale = Math.min(cw, ch) / (GRID * 2 + 2);
        }

        function toCanvas(vx, vy) {
            return { x: ox + vx * scale, y: oy - vy * scale };
        }

        function toWorld(cx, cy) {
            return { x: (cx - ox) / scale, y: -(cy - oy) / scale };
        }

        /* --------------------------------------------------------
           Drawing helpers
        -------------------------------------------------------- */
        function drawGrid() {
            ctx.save();
            // minor grid
            ctx.strokeStyle = getCSS('--grid-color');
            ctx.lineWidth = dpr;
            for (let i = -GRID; i <= GRID; i++) {
                const p = toCanvas(i, 0);
                ctx.beginPath(); ctx.moveTo(p.x, 0); ctx.lineTo(p.x, ch); ctx.stroke();
                const q = toCanvas(0, i);
                ctx.beginPath(); ctx.moveTo(0, q.y); ctx.lineTo(cw, q.y); ctx.stroke();
            }
            // axes
            ctx.strokeStyle = getCSS('--axis-color');
            ctx.lineWidth = 1.5 * dpr;
            ctx.beginPath(); ctx.moveTo(0, oy); ctx.lineTo(cw, oy); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(ox, 0); ctx.lineTo(ox, ch); ctx.stroke();

            // axis tick labels
            ctx.fillStyle = getCSS('--text-muted');
            ctx.font = (10 * dpr) + 'px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for (let i = -GRID; i <= GRID; i++) {
                if (i === 0) continue;
                const p = toCanvas(i, 0);
                ctx.fillText(i, p.x, oy + 4 * dpr);
            }
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = -GRID; i <= GRID; i++) {
                if (i === 0) continue;
                const p = toCanvas(0, i);
                ctx.fillText(i, ox - 6 * dpr, p.y);
            }
            // origin label
            ctx.textAlign = 'right';
            ctx.textBaseline = 'top';
            ctx.fillText('O', ox - 5 * dpr, oy + 4 * dpr);
            ctx.restore();
        }

        function drawArrow(from, to, color, lineWidth, headSize) {
            const fx = from.x, fy = from.y, tx = to.x, ty = to.y;
            const angle = Math.atan2(ty - fy, tx - fx);
            const hs = headSize || 12 * dpr;

            ctx.save();
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = lineWidth || 2.5 * dpr;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // shaft
            ctx.beginPath();
            ctx.moveTo(fx, fy);
            ctx.lineTo(tx, ty);
            ctx.stroke();

            // arrowhead
            ctx.beginPath();
            ctx.moveTo(tx, ty);
            ctx.lineTo(tx - hs * Math.cos(angle - 0.4), ty - hs * Math.sin(angle - 0.4));
            ctx.lineTo(tx - hs * Math.cos(angle + 0.4), ty - hs * Math.sin(angle + 0.4));
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        function drawDashedLine(from, to, color) {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.2 * dpr;
            ctx.setLineDash([6 * dpr, 4 * dpr]);
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(to.x, to.y);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();
        }

        function drawLabel(text, cx, cy, color) {
            ctx.save();
            ctx.font = 'bold ' + (13 * dpr) + 'px sans-serif';
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(text, cx, cy - 6 * dpr);
            ctx.restore();
        }

        function drawDragHandle(cx, cy, color) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(cx, cy, 7 * dpr, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.lineWidth = 2.5 * dpr;
            ctx.strokeStyle = color;
            ctx.stroke();
            ctx.restore();
        }

        function drawComponentLines(v, color) {
            const o = toCanvas(0, 0);
            const pX = toCanvas(v.x, 0);
            const pFull = toCanvas(v.x, v.y);

            ctx.save();
            ctx.strokeStyle = color;
            ctx.globalAlpha = 0.35;
            ctx.lineWidth = 1.5 * dpr;
            ctx.setLineDash([4 * dpr, 3 * dpr]);

            ctx.beginPath(); ctx.moveTo(o.x, o.y); ctx.lineTo(pX.x, pX.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(pX.x, pX.y); ctx.lineTo(pFull.x, pFull.y); ctx.stroke();

            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function drawUnitVector(v, color) {
            const mag = Math.sqrt(v.x * v.x + v.y * v.y);
            if (mag < 0.01) return;
            const ux = v.x / mag, uy = v.y / mag;
            const o = toCanvas(0, 0);
            const tip = toCanvas(ux, uy);
            drawArrow(o, tip, color, 1.8 * dpr, 8 * dpr);
        }

        function getCSS(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        /* --------------------------------------------------------
           Compute resultant
        -------------------------------------------------------- */
        function resultant() {
            const a = state.a, b = state.b;
            if (state.op === 'add') return { x: a.x + b.x, y: a.y + b.y };
            if (state.op === 'sub') return { x: a.x - b.x, y: a.y - b.y };
            // scalar
            return { x: state.scalar * a.x, y: state.scalar * a.y };
        }

        function mag(v) { return Math.sqrt(v.x * v.x + v.y * v.y); }

        function angleDeg(v) {
            if (mag(v) < 0.001) return 0;
            let a = Math.atan2(v.y, v.x) * 180 / Math.PI;
            if (a < 0) a += 360;
            return a;
        }

        /* --------------------------------------------------------
           Main draw
        -------------------------------------------------------- */
        function draw() {
            ctx.clearRect(0, 0, cw, ch);

            // background
            ctx.fillStyle = '#fefefe';
            ctx.fillRect(0, 0, cw, ch);

            drawGrid();

            const o = toCanvas(0, 0);
            const pA = toCanvas(state.a.x, state.a.y);
            const pB = toCanvas(state.b.x, state.b.y);
            const r = resultant();
            const pR = toCanvas(r.x, r.y);

            const colA = getCSS('--vec-a');
            const colB = getCSS('--vec-b');
            const colR = getCSS('--vec-r');

            // Parallelogram / triangle rule
            if (state.show.parallelogram && state.op !== 'scalar') {
                // shaded parallelogram
                ctx.save();
                ctx.fillStyle = getCSS('--parallelogram-color');
                ctx.beginPath();
                ctx.moveTo(o.x, o.y);
                ctx.lineTo(pA.x, pA.y);
                ctx.lineTo(pR.x, pR.y);
                ctx.lineTo(pB.x, pB.y);
                ctx.closePath();
                ctx.fill();

                // dashed helper lines
                drawDashedLine(pA, pR, colB);
                drawDashedLine(pB, pR, colR);
                ctx.restore();
            }

            // Components
            if (state.show.components) {
                drawComponentLines(state.a, colA);
                drawComponentLines(state.b, colB);
            }

            // Unit vectors
            if (state.show.unit) {
                drawUnitVector(state.a, colA);
                drawUnitVector(state.b, colB);
            }

            // Vector arrows
            drawArrow(o, pA, colA);
            drawArrow(o, pB, colB);
            drawArrow(o, pR, colR, 3 * dpr, 14 * dpr);

            // Drag handles
            drawDragHandle(pA.x, pA.y, colA);
            drawDragHandle(pB.x, pB.y, colB);

            // Labels
            if (state.show.labels) {
                const midA = { x: (o.x + pA.x) / 2, y: (o.y + pA.y) / 2 };
                const midB = { x: (o.x + pB.x) / 2, y: (o.y + pB.y) / 2 };
                const midR = { x: (o.x + pR.x) / 2, y: (o.y + pR.y) / 2 };

                drawLabel('a', midA.x - 10 * dpr, midA.y, colA);
                drawLabel('b', midB.x + 10 * dpr, midB.y, colB);

                let rLabel = 'a + b';
                if (state.op === 'sub') rLabel = 'a - b';
                if (state.op === 'scalar') rLabel = state.scalar.toFixed(1) + 'a';
                drawLabel(rLabel, midR.x, midR.y - 4 * dpr, colR);
            }

            updateReadouts(r);
        }

        /* --------------------------------------------------------
           Readout updates
        -------------------------------------------------------- */
        function fmt(n) { return (n >= 0 ? '' : '') + n.toFixed(1); }

        function updateReadouts(r) {
            readA.textContent = '(' + fmt(state.a.x) + ', ' + fmt(state.a.y) + ')';
            readB.textContent = '(' + fmt(state.b.x) + ', ' + fmt(state.b.y) + ')';
            readR.textContent = '(' + fmt(r.x) + ', ' + fmt(r.y) + ')';

            readAMeta.innerHTML = '|a| = ' + mag(state.a).toFixed(2) + ', &theta; = ' + angleDeg(state.a).toFixed(1) + '&deg;';
            readBMeta.innerHTML = '|b| = ' + mag(state.b).toFixed(2) + ', &theta; = ' + angleDeg(state.b).toFixed(1) + '&deg;';
            readRMeta.innerHTML = '|r| = ' + mag(r).toFixed(2) + ', &theta; = ' + angleDeg(r).toFixed(1) + '&deg;';
        }

        /* --------------------------------------------------------
           Sync inputs <-> state
        -------------------------------------------------------- */
        function syncInputsFromState() {
            elAx.value = state.a.x;
            elAy.value = state.a.y;
            elBx.value = state.b.x;
            elBy.value = state.b.y;
        }

        function onInputChange() {
            state.a.x = clampVal(parseFloat(elAx.value) || 0);
            state.a.y = clampVal(parseFloat(elAy.value) || 0);
            state.b.x = clampVal(parseFloat(elBx.value) || 0);
            state.b.y = clampVal(parseFloat(elBy.value) || 0);
            syncInputsFromState();
            draw();
        }

        function clampVal(v) {
            return Math.max(-GRID, Math.min(GRID, v));
        }

        [elAx, elAy, elBx, elBy].forEach(function (el) {
            el.addEventListener('input', onInputChange);
        });

        /* --------------------------------------------------------
           Operation buttons
        -------------------------------------------------------- */
        opBtns.forEach(function (btn) {
            btn.addEventListener('click', function () {
                opBtns.forEach(function (b) { b.classList.remove('active'); });
                btn.classList.add('active');
                state.op = btn.dataset.op;
                scalarGroup.classList.toggle('visible', state.op === 'scalar');
                draw();
            });
        });

        scalarSlider.addEventListener('input', function () {
            state.scalar = parseFloat(this.value);
            scalarVal.textContent = state.scalar.toFixed(1);
            draw();
        });

        /* --------------------------------------------------------
           Toggle switches
        -------------------------------------------------------- */
        togComponents.addEventListener('change', function () { state.show.components = this.checked; draw(); });
        togParallelogram.addEventListener('change', function () { state.show.parallelogram = this.checked; draw(); });
        togUnit.addEventListener('change', function () { state.show.unit = this.checked; draw(); });
        togLabels.addEventListener('change', function () { state.show.labels = this.checked; draw(); });
        togSnap.addEventListener('change', function () { state.show.snap = this.checked; });

        /* --------------------------------------------------------
           Reset button
        -------------------------------------------------------- */
        document.getElementById('btnReset').addEventListener('click', function () {
            state.a = { x: 3, y: 2 };
            state.b = { x: -1, y: 4 };
            state.scalar = 2;
            scalarSlider.value = 2;
            scalarVal.textContent = '2.0';
            syncInputsFromState();
            draw();
        });

        /* --------------------------------------------------------
           Dragging
        -------------------------------------------------------- */
        function getCanvasPos(e) {
            var rect = canvas.getBoundingClientRect();
            var clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return {
                x: (clientX - rect.left) * dpr,
                y: (clientY - rect.top) * dpr
            };
        }

        function hitTest(pos) {
            var pA = toCanvas(state.a.x, state.a.y);
            var pB = toCanvas(state.b.x, state.b.y);
            var hitR = 18 * dpr;

            var dA = Math.hypot(pos.x - pA.x, pos.y - pA.y);
            var dB = Math.hypot(pos.x - pB.x, pos.y - pB.y);

            if (dA < hitR && dA <= dB) return 'a';
            if (dB < hitR) return 'b';
            return null;
        }

        function onPointerDown(e) {
            var pos = getCanvasPos(e);
            var hit = hitTest(pos);
            if (hit) {
                state.dragging = hit;
                canvas.style.cursor = 'grabbing';
                e.preventDefault();
            }
        }

        function onPointerMove(e) {
            if (!state.dragging) {
                // Hover cursor
                var pos2 = getCanvasPos(e);
                canvas.style.cursor = hitTest(pos2) ? 'grab' : 'crosshair';
                return;
            }
            e.preventDefault();
            var pos = getCanvasPos(e);
            var world = toWorld(pos.x, pos.y);
            var vx = clampVal(world.x);
            var vy = clampVal(world.y);

            if (state.show.snap) {
                vx = Math.round(vx * 2) / 2;  // snap to 0.5
                vy = Math.round(vy * 2) / 2;
            }

            if (state.dragging === 'a') {
                state.a.x = vx;
                state.a.y = vy;
            } else {
                state.b.x = vx;
                state.b.y = vy;
            }

            syncInputsFromState();
            draw();
        }

        function onPointerUp() {
            if (state.dragging) {
                state.dragging = null;
                canvas.style.cursor = 'crosshair';
            }
        }

        canvas.addEventListener('mousedown', onPointerDown);
        window.addEventListener('mousemove', onPointerMove);
        window.addEventListener('mouseup', onPointerUp);

        canvas.addEventListener('touchstart', onPointerDown, { passive: false });
        window.addEventListener('touchmove', onPointerMove, { passive: false });
        window.addEventListener('touchend', onPointerUp);

        /* --------------------------------------------------------
           Init
        -------------------------------------------------------- */
        function init() {
            resizeCanvas();
            syncInputsFromState();
            draw();
        }

        window.addEventListener('resize', function () {
            resizeCanvas();
            draw();
        });

        init();
    })();
    </script>
</body>
</html>
