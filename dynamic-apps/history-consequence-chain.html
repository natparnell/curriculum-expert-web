<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consequence Chain Builder</title>
    <style>
        :root {
            --colour-bg: #faf6f0;
            --colour-surface: #fff8f0;
            --colour-surface-alt: #f5ede0;
            --colour-border: #d4c4a8;
            --colour-border-light: #e8dcc8;
            --colour-text: #3e2f1c;
            --colour-text-muted: #7a6b55;
            --colour-header-bg: #5c3d1e;
            --colour-header-text: #faf6f0;
            --colour-accent: #b8860b;
            --colour-accent-light: #daa520;
            --colour-political: #3b6ea5;
            --colour-political-light: #d0e0f0;
            --colour-social: #4a8c5c;
            --colour-social-light: #d0ecd8;
            --colour-economic: #c4961c;
            --colour-economic-light: #f5e8c0;
            --colour-military: #b04040;
            --colour-military-light: #f0d0d0;
            --colour-lane-short: rgba(200, 160, 80, 0.08);
            --colour-lane-medium: rgba(180, 140, 60, 0.05);
            --colour-lane-long: rgba(160, 120, 40, 0.03);
            --colour-lane-border: #d4c4a8;
            --shadow-sm: 0 1px 3px rgba(62, 47, 28, 0.12);
            --shadow-md: 0 3px 8px rgba(62, 47, 28, 0.15);
            --shadow-lg: 0 6px 16px rgba(62, 47, 28, 0.18);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-heading: Georgia, 'Times New Roman', serif;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background: var(--colour-bg);
            color: var(--colour-text);
            min-height: 100vh;
            line-height: 1.5;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--colour-header-bg);
            color: var(--colour-header-text);
            padding: 14px 24px;
            box-shadow: var(--shadow-lg);
        }

        header h1 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        header p {
            font-size: 0.85rem;
            opacity: 0.82;
            margin-top: 2px;
        }

        .app-layout {
            display: flex;
            height: calc(100vh - 72px);
        }

        .sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--colour-surface);
            border-right: 1px solid var(--colour-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            padding: 14px 16px;
            border-bottom: 1px solid var(--colour-border-light);
        }

        .sidebar-section h3 {
            font-family: var(--font-heading);
            font-size: 0.9rem;
            color: var(--colour-text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .event-pack-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--colour-border);
            border-radius: var(--radius-sm);
            background: var(--colour-bg);
            font-family: var(--font-main);
            font-size: 0.88rem;
            color: var(--colour-text);
            cursor: pointer;
        }

        .card-tray {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }

        .card-tray::-webkit-scrollbar { width: 6px; }
        .card-tray::-webkit-scrollbar-thumb { background: var(--colour-border); border-radius: 3px; }

        .consequence-card {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: var(--radius-sm);
            border-left: 4px solid;
            background: var(--colour-surface-alt);
            cursor: grab;
            font-size: 0.82rem;
            transition: box-shadow 0.15s, transform 0.15s;
            user-select: none;
        }

        .consequence-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .consequence-card:active { cursor: grabbing; }
        .consequence-card.placed { opacity: 0.4; pointer-events: none; }

        .consequence-card[data-type="political"] { border-left-color: var(--colour-political); }
        .consequence-card[data-type="social"] { border-left-color: var(--colour-social); }
        .consequence-card[data-type="economic"] { border-left-color: var(--colour-economic); }
        .consequence-card[data-type="military"] { border-left-color: var(--colour-military); }

        .card-type-badge {
            display: inline-block;
            font-size: 0.68rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 1px 6px;
            border-radius: 3px;
            margin-bottom: 4px;
        }

        [data-type="political"] .card-type-badge { background: var(--colour-political-light); color: var(--colour-political); }
        [data-type="social"] .card-type-badge { background: var(--colour-social-light); color: var(--colour-social); }
        [data-type="economic"] .card-type-badge { background: var(--colour-economic-light); color: var(--colour-economic); }
        [data-type="military"] .card-type-badge { background: var(--colour-military-light); color: var(--colour-military); }

        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--colour-surface);
            border-bottom: 1px solid var(--colour-border-light);
            flex-wrap: wrap;
        }

        .toolbar button, .toolbar select {
            padding: 6px 14px;
            border: 1px solid var(--colour-border);
            border-radius: var(--radius-sm);
            background: var(--colour-bg);
            font-size: 0.8rem;
            font-family: var(--font-main);
            color: var(--colour-text);
            cursor: pointer;
            transition: background 0.15s;
        }

        .toolbar button:hover { background: var(--colour-surface-alt); }

        .toolbar .btn-primary {
            background: var(--colour-accent);
            color: #fff;
            border-color: var(--colour-accent);
        }

        .toolbar .btn-primary:hover { background: var(--colour-accent-light); }

        .toolbar .btn-danger {
            background: var(--colour-military);
            color: #fff;
            border-color: var(--colour-military);
        }

        .toolbar .spacer { flex: 1; }

        .legend {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .svg-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        #canvas {
            min-width: 100%;
            min-height: 100%;
        }

        .lane-label {
            font-family: var(--font-heading);
            font-size: 14px;
            fill: var(--colour-text-muted);
            font-weight: 600;
        }

        .lane-sublabel {
            font-family: var(--font-main);
            font-size: 11px;
            fill: var(--colour-text-muted);
            opacity: 0.7;
        }

        .node-group { cursor: grab; }
        .node-group:active { cursor: grabbing; }
        .node-group.connecting { cursor: crosshair; }

        .node-rect {
            rx: 8;
            ry: 8;
            stroke-width: 2;
            filter: drop-shadow(0 2px 4px rgba(62,47,28,0.15));
            transition: stroke-width 0.15s;
        }

        .node-group:hover .node-rect { stroke-width: 3; }
        .node-group.selected .node-rect { stroke-width: 3; stroke-dasharray: 5 3; }

        .node-text {
            font-family: var(--font-main);
            font-size: 11px;
            fill: var(--colour-text);
            pointer-events: none;
        }

        .node-type-label {
            font-family: var(--font-main);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            pointer-events: none;
        }

        .connection-line {
            fill: none;
            stroke-width: 2;
            opacity: 0.7;
            marker-end: url(#arrowhead);
        }

        .connection-line:hover { stroke-width: 3; opacity: 1; cursor: pointer; }

        .root-node-rect {
            rx: 10;
            ry: 10;
            stroke-width: 3;
        }

        .info-panel {
            position: fixed;
            right: -380px;
            top: 72px;
            width: 360px;
            height: calc(100vh - 72px);
            background: var(--colour-surface);
            border-left: 1px solid var(--colour-border);
            box-shadow: var(--shadow-lg);
            transition: right 0.3s ease;
            z-index: 90;
            overflow-y: auto;
            padding: 20px;
        }

        .info-panel.open { right: 0; }

        .info-panel h2 {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            margin-bottom: 14px;
            color: var(--colour-header-bg);
        }

        .info-panel h3 {
            font-family: var(--font-heading);
            font-size: 0.95rem;
            margin: 14px 0 6px;
            color: var(--colour-accent);
        }

        .info-panel p, .info-panel li {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--colour-text-muted);
        }

        .info-panel ul { padding-left: 18px; }
        .info-panel li { margin-bottom: 4px; }

        .info-close {
            position: absolute;
            top: 14px;
            right: 14px;
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--colour-text-muted);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(62, 47, 28, 0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--colour-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 90%;
            max-width: 440px;
            box-shadow: var(--shadow-lg);
        }

        .modal h2 {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        .modal label {
            display: block;
            font-size: 0.82rem;
            font-weight: 600;
            margin-bottom: 4px;
            margin-top: 10px;
            color: var(--colour-text-muted);
        }

        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--colour-border);
            border-radius: var(--radius-sm);
            font-family: var(--font-main);
            font-size: 0.88rem;
            background: var(--colour-bg);
        }

        .modal textarea { resize: vertical; min-height: 60px; }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 18px;
        }

        .modal-actions button {
            padding: 8px 18px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--colour-border);
            font-family: var(--font-main);
            font-size: 0.85rem;
            cursor: pointer;
            background: var(--colour-bg);
        }

        .modal-actions .btn-primary {
            background: var(--colour-accent);
            color: #fff;
            border-color: var(--colour-accent);
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 16px;
            left: 16px;
            z-index: 110;
            background: var(--colour-header-bg);
            color: var(--colour-header-text);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
        }

        .connect-hint {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--colour-header-bg);
            color: var(--colour-header-text);
            padding: 8px 20px;
            border-radius: var(--radius-md);
            font-size: 0.82rem;
            display: none;
            z-index: 80;
            box-shadow: var(--shadow-md);
        }

        .connect-hint.visible { display: block; }

        @media (max-width: 768px) {
            header h1 { font-size: 1.2rem; }

            .sidebar {
                position: fixed;
                left: -300px;
                top: 72px;
                height: calc(100vh - 72px);
                z-index: 95;
                transition: left 0.3s ease;
                box-shadow: var(--shadow-lg);
            }

            .sidebar.open { left: 0; }

            .sidebar-toggle { display: block; }

            .app-layout { flex-direction: column; }

            .canvas-area { height: calc(100vh - 72px); }

            .toolbar { padding: 6px 10px; }
            .toolbar button { padding: 5px 10px; font-size: 0.75rem; }

            .legend { display: none; }

            .info-panel { width: 300px; }
        }
    </style>
</head>
<body>

<header>
    <h1>Consequence Chain Builder</h1>
    <p>Map how historical events cascade through short-term, medium-term, and long-term consequences</p>
</header>

<div class="app-layout">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <h3>Event Pack</h3>
            <select class="event-pack-select" id="eventPackSelect">
                <option value="">Select an event pack...</option>
                <option value="hastings">Battle of Hastings (1066)</option>
                <option value="french-rev">French Revolution (1789)</option>
                <option value="ww1-end">End of WW1 (1918)</option>
                <option value="berlin-wall">Fall of Berlin Wall (1989)</option>
                <option value="free">Free Mode (custom events)</option>
            </select>
        </div>
        <div class="sidebar-section" id="eventInfo" style="display:none;">
            <h3>Event</h3>
            <p id="eventDescription" style="font-size:0.82rem; color:var(--colour-text-muted);"></p>
        </div>
        <div class="card-tray" id="cardTray">
            <p style="font-size:0.82rem; color:var(--colour-text-muted); text-align:center; padding:30px 0;">
                Select an event pack above to load consequence cards, then drag them onto the canvas.
            </p>
        </div>
    </aside>

    <main class="canvas-area">
        <div class="toolbar">
            <button onclick="toggleInfoPanel()" title="Learn about consequences">&#9432; Info</button>
            <button class="btn-primary" id="connectBtn" onclick="toggleConnectMode()">&#8594; Connect</button>
            <button onclick="openAddNodeModal()">&#43; Add Node</button>
            <button onclick="undoLast()">&#8630; Undo</button>
            <div class="spacer"></div>
            <div class="legend">
                <span class="legend-item"><span class="legend-dot" style="background:var(--colour-political);"></span> Political</span>
                <span class="legend-item"><span class="legend-dot" style="background:var(--colour-social);"></span> Social</span>
                <span class="legend-item"><span class="legend-dot" style="background:var(--colour-economic);"></span> Economic</span>
                <span class="legend-item"><span class="legend-dot" style="background:var(--colour-military);"></span> Military</span>
            </div>
            <div class="spacer"></div>
            <button class="btn-danger" onclick="clearCanvas()">&#10005; Clear</button>
        </div>

        <div class="svg-container" id="svgContainer">
            <svg id="canvas" width="1200" height="700">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="var(--colour-text-muted)" />
                    </marker>
                </defs>
            </svg>
        </div>
    </main>
</div>

<button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">&#9776;</button>

<div class="connect-hint" id="connectHint">Click a source node, then click a target node to draw a connection. Press Escape to cancel.</div>

<div class="info-panel" id="infoPanel">
    <button class="info-close" onclick="toggleInfoPanel()">&times;</button>
    <h2>Understanding Consequences</h2>
    <h3>Time Horizons</h3>
    <ul>
        <li><strong>Short-term (0 to 5 years):</strong> Immediate reactions and changes that follow directly from an event. These are often the most visible and dramatic.</li>
        <li><strong>Medium-term (5 to 20 years):</strong> Structural shifts in politics, society, or the economy that develop as the initial shock settles into new patterns.</li>
        <li><strong>Long-term (20+ years):</strong> Deep, lasting transformations that reshape entire systems, cultures, or world orders. Often only fully understood with hindsight.</li>
    </ul>
    <h3>Types of Consequence</h3>
    <ul>
        <li><strong style="color:var(--colour-political);">Political:</strong> Changes in governance, law, borders, power structures, and political systems.</li>
        <li><strong style="color:var(--colour-social);">Social:</strong> Shifts in culture, daily life, class structures, education, and demographic patterns.</li>
        <li><strong style="color:var(--colour-economic);">Economic:</strong> Effects on trade, industry, wealth distribution, taxation, and economic systems.</li>
        <li><strong style="color:var(--colour-military);">Military:</strong> Impacts on armed forces, warfare, defence, alliances, and military technology.</li>
    </ul>
    <h3>Intended vs Unintended</h3>
    <p>Historians distinguish between consequences that were deliberately sought by the people involved (intended) and those that nobody predicted (unintended). Many of the most significant consequences of historical events were entirely unforeseen. When building your chain, consider which consequences were planned and which surprised contemporaries.</p>
    <h3>Cascading Effects</h3>
    <p>Consequences rarely exist in isolation. One change triggers another, creating branching chains. A political decision may cause economic disruption, which in turn drives social change. Drawing connections between your nodes reveals these cascading relationships and helps you build a richer understanding of cause and consequence.</p>
    <h3>How to Use This Tool</h3>
    <ul>
        <li>Select an event pack or use Free Mode to create your own event.</li>
        <li>Drag consequence cards from the sidebar onto the appropriate time-horizon lane on the canvas.</li>
        <li>Use the Connect button to draw arrows showing how one consequence leads to another.</li>
        <li>Click any node on the canvas to select it; press Delete to remove it.</li>
        <li>Add custom nodes using the Add Node button.</li>
    </ul>
</div>

<div class="modal-overlay" id="addNodeModal">
    <div class="modal">
        <h2>Add Custom Node</h2>
        <label for="nodeTitle">Title</label>
        <input type="text" id="nodeTitle" placeholder="e.g. Rise of nationalism" maxlength="60">
        <label for="nodeType">Type</label>
        <select id="nodeType">
            <option value="political">Political</option>
            <option value="social">Social</option>
            <option value="economic">Economic</option>
            <option value="military">Military</option>
        </select>
        <label for="nodeDetail">Detail (optional)</label>
        <textarea id="nodeDetail" placeholder="Brief explanation..."></textarea>
        <div class="modal-actions">
            <button onclick="closeAddNodeModal()">Cancel</button>
            <button class="btn-primary" onclick="addCustomNode()">Add to Canvas</button>
        </div>
    </div>
</div>

<script>
    // ========== DATA: Event Packs ==========
    const EVENT_PACKS = {
        hastings: {
            title: 'Battle of Hastings (1066)',
            description: 'William of Normandy defeated King Harold II, ending Anglo-Saxon rule in England and beginning the Norman Conquest.',
            cards: [
                { id: 'h1', text: 'William crowned King of England', type: 'political', lane: 'short', detail: 'William was crowned on Christmas Day 1066 at Westminster Abbey.' },
                { id: 'h2', text: 'Anglo-Saxon nobles lose their lands', type: 'political', lane: 'short', detail: 'By 1071, only two major Anglo-Saxon landowners remained.' },
                { id: 'h3', text: 'Harrying of the North (1069-70)', type: 'military', lane: 'short', detail: 'William devastated northern England to crush resistance, causing widespread famine.' },
                { id: 'h4', text: 'Construction of motte-and-bailey castles', type: 'military', lane: 'short', detail: 'Over 500 castles built in the first 20 years to control the population.' },
                { id: 'h5', text: 'Introduction of the feudal system', type: 'political', lane: 'medium', detail: 'Land was redistributed to Norman lords in exchange for military service.' },
                { id: 'h6', text: 'Domesday Book commissioned (1086)', type: 'economic', lane: 'medium', detail: 'A comprehensive survey of land and resources for taxation purposes.' },
                { id: 'h7', text: 'French becomes language of the court', type: 'social', lane: 'medium', detail: 'Norman French dominated law, government, and the aristocracy for over 200 years.' },
                { id: 'h8', text: 'Rebuilding of cathedrals in Norman style', type: 'social', lane: 'medium', detail: 'Anglo-Saxon churches were replaced with grand Romanesque architecture.' },
                { id: 'h9', text: 'English language absorbs French vocabulary', type: 'social', lane: 'long', detail: 'Around 10,000 French words entered English, reshaping the language permanently.' },
                { id: 'h10', text: 'England drawn into continental European politics', type: 'political', lane: 'long', detail: 'Norman and later Plantagenet kings held territory in France, shaping centuries of conflict.' },
                { id: 'h11', text: 'Centralised royal government established', type: 'political', lane: 'long', detail: 'Norman administrative systems laid the groundwork for English common law and governance.' },
                { id: 'h12', text: 'Decline of English monasteries\u2019 independence', type: 'social', lane: 'medium', detail: 'Norman bishops and abbots replaced Anglo-Saxon church leaders.' }
            ]
        },
        'french-rev': {
            title: 'French Revolution (1789)',
            description: 'The overthrow of the French monarchy and the radical restructuring of French society, beginning with the storming of the Bastille.',
            cards: [
                { id: 'f1', text: 'Declaration of the Rights of Man (1789)', type: 'political', lane: 'short', detail: 'Proclaimed liberty, equality, and popular sovereignty as fundamental principles.' },
                { id: 'f2', text: 'Abolition of feudal privileges', type: 'economic', lane: 'short', detail: 'The National Assembly abolished serfdom, tithes, and noble privileges on 4 August 1789.' },
                { id: 'f3', text: 'Execution of Louis XVI (1793)', type: 'political', lane: 'short', detail: 'The king was guillotined, shocking European monarchies and provoking war.' },
                { id: 'f4', text: 'Reign of Terror (1793-94)', type: 'political', lane: 'short', detail: 'Robespierre\u2019s Committee of Public Safety executed thousands of perceived enemies.' },
                { id: 'f5', text: 'Rise of Napoleon Bonaparte', type: 'military', lane: 'medium', detail: 'Military success during the Revolutionary Wars propelled Napoleon to power by 1799.' },
                { id: 'f6', text: 'Napoleonic Code (1804)', type: 'political', lane: 'medium', detail: 'Codified civil law across France, influencing legal systems worldwide.' },
                { id: 'f7', text: 'Spread of revolutionary ideas across Europe', type: 'social', lane: 'medium', detail: 'Nationalism and liberalism inspired uprisings across the continent for decades.' },
                { id: 'f8', text: 'Redistribution of Church lands', type: 'economic', lane: 'medium', detail: 'Church property was nationalised and sold, creating a new class of landowners.' },
                { id: 'f9', text: 'Introduction of the metric system', type: 'social', lane: 'medium', detail: 'Standardised weights and measures, eventually adopted globally.' },
                { id: 'f10', text: 'European revolutions of 1848', type: 'political', lane: 'long', detail: 'Revolutionary ideals inspired widespread uprisings across Europe sixty years later.' },
                { id: 'f11', text: 'Foundation of modern democratic ideals', type: 'political', lane: 'long', detail: 'Concepts of citizenship, human rights, and republicanism became enduring political principles.' },
                { id: 'f12', text: 'Decline of absolute monarchy in Europe', type: 'political', lane: 'long', detail: 'The Revolution demonstrated that monarchs could be overthrown, weakening royal authority permanently.' }
            ]
        },
        'ww1-end': {
            title: 'End of World War One (1918)',
            description: 'The armistice of 11 November 1918 ended four years of devastating conflict, leaving Europe fundamentally reshaped.',
            cards: [
                { id: 'w1', text: 'Treaty of Versailles (1919)', type: 'political', lane: 'short', detail: 'Imposed harsh reparations and territorial losses on Germany.' },
                { id: 'w2', text: 'Collapse of four empires', type: 'political', lane: 'short', detail: 'The German, Austro-Hungarian, Ottoman, and Russian empires all fell.' },
                { id: 'w3', text: 'Creation of the League of Nations', type: 'political', lane: 'short', detail: 'The first international organisation aimed at maintaining world peace.' },
                { id: 'w4', text: 'Spanish Flu pandemic (1918-19)', type: 'social', lane: 'short', detail: 'Troop movements spread influenza globally, killing an estimated 50 million people.' },
                { id: 'w5', text: 'Women gain the right to vote in Britain', type: 'social', lane: 'short', detail: 'Women over 30 gained suffrage in 1918, partly due to war service.' },
                { id: 'w6', text: 'German hyperinflation (1923)', type: 'economic', lane: 'medium', detail: 'War reparations contributed to catastrophic inflation, destabilising the Weimar Republic.' },
                { id: 'w7', text: 'Rise of fascism in Italy and Germany', type: 'political', lane: 'medium', detail: 'Post-war instability and resentment fuelled extremist movements.' },
                { id: 'w8', text: 'Redrawing of Middle Eastern borders', type: 'political', lane: 'medium', detail: 'The Sykes-Picot Agreement and mandate system created new nations from Ottoman territory.' },
                { id: 'w9', text: 'Shell shock recognised as a medical condition', type: 'social', lane: 'medium', detail: 'Understanding of psychological trauma advanced, though treatment remained limited.' },
                { id: 'w10', text: 'Outbreak of World War Two (1939)', type: 'military', lane: 'long', detail: 'Many historians view WW2 as a direct consequence of the unresolved tensions of WW1.' },
                { id: 'w11', text: 'Decolonisation movements accelerate', type: 'political', lane: 'long', detail: 'Colonial troops\u2019 war service and weakened European powers fuelled independence movements.' },
                { id: 'w12', text: 'Creation of the United Nations (1945)', type: 'political', lane: 'long', detail: 'The League\u2019s failure led to a stronger international body after the next war.' }
            ]
        },
        'berlin-wall': {
            title: 'Fall of the Berlin Wall (1989)',
            description: 'On 9 November 1989, East German citizens breached the Berlin Wall, symbolising the end of the Cold War division of Europe.',
            cards: [
                { id: 'b1', text: 'East Germans flood into West Berlin', type: 'social', lane: 'short', detail: 'Hundreds of thousands crossed the border in the first days.' },
                { id: 'b2', text: 'Free elections in East Germany (1990)', type: 'political', lane: 'short', detail: 'The first free elections led to a government committed to reunification.' },
                { id: 'b3', text: 'German reunification (October 1990)', type: 'political', lane: 'short', detail: 'East and West Germany formally united into a single state.' },
                { id: 'b4', text: 'Collapse of communist regimes across Eastern Europe', type: 'political', lane: 'short', detail: 'The Velvet Revolution, Romanian Revolution, and others followed rapidly.' },
                { id: 'b5', text: 'Dissolution of the Soviet Union (1991)', type: 'political', lane: 'short', detail: 'The USSR formally dissolved on 26 December 1991.' },
                { id: 'b6', text: 'Economic shock therapy in former Soviet states', type: 'economic', lane: 'medium', detail: 'Rapid privatisation led to economic turmoil, inequality, and the rise of oligarchs.' },
                { id: 'b7', text: 'Expansion of NATO eastward', type: 'military', lane: 'medium', detail: 'Former Warsaw Pact nations joined NATO through the 1990s and 2000s.' },
                { id: 'b8', text: 'European Union enlargement', type: 'political', lane: 'medium', detail: 'The EU expanded to include former Eastern Bloc nations from 2004 onwards.' },
                { id: 'b9', text: 'Yugoslav Wars (1991-2001)', type: 'military', lane: 'medium', detail: 'The end of Cold War stability contributed to the violent breakup of Yugoslavia.' },
                { id: 'b10', text: 'Rise of the European single market', type: 'economic', lane: 'medium', detail: 'Economic integration deepened as former communist states joined the market economy.' },
                { id: 'b11', text: 'Nostalgia and identity tensions in East Germany', type: 'social', lane: 'long', detail: 'Ostalgie and economic disparities between east and west persist decades later.' },
                { id: 'b12', text: 'Russia-West tensions over NATO expansion', type: 'military', lane: 'long', detail: 'Disagreements over NATO\u2019s eastward growth remain a source of geopolitical conflict.' }
            ]
        }
    };

    // ========== STATE ==========
    let nodes = [];
    let connections = [];
    let undoStack = [];
    let selectedNode = null;
    let connectMode = false;
    let connectSource = null;
    let dragState = null;
    let nextNodeId = 1;
    let currentPack = null;

    const LANE_CONFIG = {
        short:  { label: 'Short-term', sublabel: '0 to 5 years', y: 30, height: 200 },
        medium: { label: 'Medium-term', sublabel: '5 to 20 years', y: 230, height: 200 },
        long:   { label: 'Long-term', sublabel: '20+ years', y: 430, height: 200 }
    };

    const NODE_W = 160;
    const NODE_H = 60;
    const COLOURS = {
        political: { fill: '#d0e0f0', stroke: '#3b6ea5' },
        social:    { fill: '#d0ecd8', stroke: '#4a8c5c' },
        economic:  { fill: '#f5e8c0', stroke: '#c4961c' },
        military:  { fill: '#f0d0d0', stroke: '#b04040' }
    };

    // ========== INITIALISATION ==========
    const svg = document.getElementById('canvas');
    const svgContainer = document.getElementById('svgContainer');

    function initCanvas() {
        // Clear SVG content except defs
        const defs = svg.querySelector('defs');
        svg.innerHTML = '';
        svg.appendChild(defs);
        drawLanes();
    }

    function drawLanes() {
        const laneColours = { short: 'var(--colour-lane-short)', medium: 'var(--colour-lane-medium)', long: 'var(--colour-lane-long)' };
        const w = Math.max(1200, svg.getAttribute('width'));

        for (const [key, lane] of Object.entries(LANE_CONFIG)) {
            const g = createSvgEl('g');

            const rect = createSvgEl('rect', {
                x: 0, y: lane.y, width: w, height: lane.height,
                fill: laneColours[key], stroke: 'var(--colour-lane-border)',
                'stroke-width': 1, 'stroke-dasharray': '6 3'
            });
            g.appendChild(rect);

            const label = createSvgEl('text', {
                x: 14, y: lane.y + 22, class: 'lane-label'
            });
            label.textContent = lane.label;
            g.appendChild(label);

            const sublabel = createSvgEl('text', {
                x: 14, y: lane.y + 38, class: 'lane-sublabel'
            });
            sublabel.textContent = lane.sublabel;
            g.appendChild(sublabel);

            svg.appendChild(g);
        }
    }

    function createSvgEl(tag, attrs = {}) {
        const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
        for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
        return el;
    }

    // ========== EVENT PACK LOADING ==========
    document.getElementById('eventPackSelect').addEventListener('change', function() {
        const val = this.value;
        clearCanvas();
        currentPack = val;

        const tray = document.getElementById('cardTray');
        const info = document.getElementById('eventInfo');
        const desc = document.getElementById('eventDescription');

        if (!val) {
            tray.innerHTML = '<p style="font-size:0.82rem;color:var(--colour-text-muted);text-align:center;padding:30px 0;">Select an event pack above to load consequence cards, then drag them onto the canvas.</p>';
            info.style.display = 'none';
            return;
        }

        if (val === 'free') {
            tray.innerHTML = '<p style="font-size:0.82rem;color:var(--colour-text-muted);text-align:center;padding:30px 0;">Free Mode: use the "Add Node" button in the toolbar to create your own events and consequences.</p>';
            info.style.display = 'none';
            // Place a root node for custom event
            addRootNode('Your Event', 'Define your own historical event');
            return;
        }

        const pack = EVENT_PACKS[val];
        if (!pack) return;

        info.style.display = 'block';
        desc.textContent = pack.description;

        tray.innerHTML = '';
        pack.cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'consequence-card';
            div.dataset.type = card.type;
            div.dataset.id = card.id;
            div.dataset.lane = card.lane;
            div.dataset.detail = card.detail || '';
            div.draggable = true;
            div.innerHTML = `<span class="card-type-badge">${card.type}</span><div>${card.text}</div>`;

            div.addEventListener('dragstart', onCardDragStart);
            tray.appendChild(div);
        });

        // Add root event node
        addRootNode(pack.title, pack.description);
    });

    // ========== ROOT NODE ==========
    function addRootNode(title, description) {
        const rootX = 100;
        const rootY = LANE_CONFIG.short.y + LANE_CONFIG.short.height / 2 - 30;
        const node = {
            id: 'root',
            text: title.length > 30 ? title.substring(0, 28) + '...' : title,
            fullText: title,
            type: 'root',
            x: rootX,
            y: rootY,
            detail: description
        };
        nodes.push(node);
        renderAll();
    }

    // ========== DRAG AND DROP FROM SIDEBAR ==========
    function onCardDragStart(e) {
        const data = {
            id: e.target.dataset.id || e.target.closest('.consequence-card').dataset.id,
            text: e.target.querySelector('div') ? e.target.querySelector('div').textContent : e.target.textContent,
            type: e.target.dataset.type || e.target.closest('.consequence-card').dataset.type,
            lane: e.target.dataset.lane || e.target.closest('.consequence-card').dataset.lane,
            detail: e.target.dataset.detail || e.target.closest('.consequence-card').dataset.detail || ''
        };
        e.dataTransfer.setData('application/json', JSON.stringify(data));
        e.dataTransfer.effectAllowed = 'move';
    }

    svgContainer.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });

    svgContainer.addEventListener('drop', e => {
        e.preventDefault();
        let data;
        try { data = JSON.parse(e.dataTransfer.getData('application/json')); } catch { return; }

        const rect = svg.getBoundingClientRect();
        const scrollLeft = svgContainer.scrollLeft;
        const scrollTop = svgContainer.scrollTop;
        let dropX = e.clientX - rect.left + scrollLeft;
        let dropY = e.clientY - rect.top + scrollTop;

        // Snap to lane
        const lane = data.lane || getLaneFromY(dropY);
        const laneConfig = LANE_CONFIG[lane];
        if (laneConfig) {
            dropY = Math.max(laneConfig.y + 10, Math.min(dropY - NODE_H / 2, laneConfig.y + laneConfig.height - NODE_H - 10));
        }
        dropX = Math.max(120, dropX - NODE_W / 2);

        // Expand canvas if needed
        expandCanvas(dropX + NODE_W + 40, dropY + NODE_H + 40);

        const node = {
            id: 'node_' + nextNodeId++,
            sourceId: data.id,
            text: data.text.length > 35 ? data.text.substring(0, 33) + '...' : data.text,
            fullText: data.text,
            type: data.type,
            lane: lane,
            x: dropX,
            y: dropY,
            detail: data.detail || ''
        };

        undoStack.push({ action: 'addNode', nodeId: node.id });
        nodes.push(node);

        // Mark sidebar card as placed
        const card = document.querySelector(`.consequence-card[data-id="${data.id}"]`);
        if (card) card.classList.add('placed');

        renderAll();
    });

    function getLaneFromY(y) {
        if (y < LANE_CONFIG.medium.y) return 'short';
        if (y < LANE_CONFIG.long.y) return 'medium';
        return 'long';
    }

    function expandCanvas(minW, minH) {
        const curW = parseInt(svg.getAttribute('width'));
        const curH = parseInt(svg.getAttribute('height'));
        let changed = false;
        if (minW > curW) { svg.setAttribute('width', minW + 100); changed = true; }
        if (minH > curH) { svg.setAttribute('height', minH + 100); changed = true; }
        if (changed) {
            initCanvas();
            renderAll();
        }
    }

    // ========== RENDERING ==========
    function renderAll() {
        // Remove existing nodes and connections
        svg.querySelectorAll('.node-group, .connection-line').forEach(el => el.remove());

        // Draw connections
        connections.forEach(conn => {
            const from = nodes.find(n => n.id === conn.from);
            const to = nodes.find(n => n.id === conn.to);
            if (!from || !to) return;

            const fromCx = from.x + (from.type === 'root' ? 90 : NODE_W / 2);
            const fromCy = from.y + (from.type === 'root' ? 30 : NODE_H / 2);
            const toCx = to.x + NODE_W / 2;
            const toCy = to.y + NODE_H / 2;

            const dx = toCx - fromCx;
            const dy = toCy - fromCy;
            const cx1 = fromCx + dx * 0.4;
            const cy1 = fromCy;
            const cx2 = fromCx + dx * 0.6;
            const cy2 = toCy;

            const path = createSvgEl('path', {
                d: `M${fromCx},${fromCy} C${cx1},${cy1} ${cx2},${cy2} ${toCx},${toCy}`,
                class: 'connection-line',
                stroke: COLOURS[to.type] ? COLOURS[to.type].stroke : '#7a6b55',
                'data-from': conn.from,
                'data-to': conn.to
            });
            path.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Remove this connection?')) {
                    undoStack.push({ action: 'addConnection', from: conn.from, to: conn.to });
                    connections = connections.filter(c => !(c.from === conn.from && c.to === conn.to));
                    renderAll();
                }
            });
            svg.appendChild(path);
        });

        // Draw nodes
        nodes.forEach(node => {
            const g = createSvgEl('g', { class: 'node-group', 'data-id': node.id, transform: `translate(${node.x}, ${node.y})` });

            if (node.type === 'root') {
                const rect = createSvgEl('rect', {
                    class: 'root-node-rect',
                    x: 0, y: 0, width: 180, height: 60,
                    fill: 'var(--colour-header-bg)', stroke: '#3e2f1c'
                });
                g.appendChild(rect);

                const text = createSvgEl('text', {
                    x: 90, y: 28, 'text-anchor': 'middle', fill: '#fff',
                    'font-family': 'Georgia, serif', 'font-size': '12', 'font-weight': '700',
                    class: 'node-text'
                });
                text.textContent = node.text;
                g.appendChild(text);

                const sub = createSvgEl('text', {
                    x: 90, y: 44, 'text-anchor': 'middle', fill: 'rgba(255,255,255,0.7)',
                    'font-size': '9', class: 'node-text'
                });
                sub.textContent = 'Root Event';
                g.appendChild(sub);
            } else {
                const colours = COLOURS[node.type] || { fill: '#e8e0d4', stroke: '#7a6b55' };
                if (selectedNode === node.id) g.classList.add('selected');

                const rect = createSvgEl('rect', {
                    class: 'node-rect',
                    x: 0, y: 0, width: NODE_W, height: NODE_H,
                    fill: colours.fill, stroke: colours.stroke
                });
                g.appendChild(rect);

                const typeLabel = createSvgEl('text', {
                    x: 8, y: 15, class: 'node-type-label', fill: colours.stroke
                });
                typeLabel.textContent = node.type.toUpperCase();
                g.appendChild(typeLabel);

                const lines = wrapText(node.text, 22);
                lines.forEach((line, i) => {
                    const text = createSvgEl('text', {
                        x: 8, y: 30 + i * 14, class: 'node-text'
                    });
                    text.textContent = line;
                    g.appendChild(text);
                });
            }

            g.addEventListener('mousedown', e => onNodeMouseDown(e, node));
            g.addEventListener('click', e => onNodeClick(e, node));
            svg.appendChild(g);
        });
    }

    function wrapText(text, maxChars) {
        if (text.length <= maxChars) return [text];
        const words = text.split(' ');
        const lines = [];
        let current = '';
        for (const word of words) {
            if ((current + ' ' + word).trim().length > maxChars) {
                if (current) lines.push(current.trim());
                current = word;
            } else {
                current += ' ' + word;
            }
            if (lines.length >= 2) { current += '...'; break; }
        }
        if (current) lines.push(current.trim());
        return lines.slice(0, 3);
    }

    // ========== NODE INTERACTION ==========
    function onNodeMouseDown(e, node) {
        if (connectMode) return;
        e.stopPropagation();
        const rect = svg.getBoundingClientRect();
        dragState = {
            node: node,
            offsetX: e.clientX - rect.left + svgContainer.scrollLeft - node.x,
            offsetY: e.clientY - rect.top + svgContainer.scrollTop - node.y,
            startX: node.x,
            startY: node.y,
            moved: false
        };
    }

    document.addEventListener('mousemove', e => {
        if (!dragState) return;
        const rect = svg.getBoundingClientRect();
        let nx = e.clientX - rect.left + svgContainer.scrollLeft - dragState.offsetX;
        let ny = e.clientY - rect.top + svgContainer.scrollTop - dragState.offsetY;
        nx = Math.max(0, nx);
        ny = Math.max(0, ny);

        dragState.node.x = nx;
        dragState.node.y = ny;
        dragState.moved = true;

        expandCanvas(nx + NODE_W + 40, ny + NODE_H + 40);
        renderAll();
    });

    document.addEventListener('mouseup', () => {
        if (dragState && dragState.moved) {
            const node = dragState.node;
            // Snap to nearest lane
            if (node.type !== 'root') {
                const centerY = node.y + NODE_H / 2;
                const lane = getLaneFromY(centerY);
                const laneConfig = LANE_CONFIG[lane];
                node.y = Math.max(laneConfig.y + 10, Math.min(node.y, laneConfig.y + laneConfig.height - NODE_H - 10));
                node.lane = lane;
            }
            renderAll();
        }
        dragState = null;
    });

    function onNodeClick(e, node) {
        e.stopPropagation();
        if (dragState && dragState.moved) return;

        if (connectMode) {
            if (!connectSource) {
                connectSource = node.id;
                document.querySelector(`[data-id="${node.id}"]`).classList.add('selected');
            } else if (connectSource !== node.id) {
                // Check for duplicate
                const exists = connections.some(c => c.from === connectSource && c.to === node.id);
                if (!exists) {
                    connections.push({ from: connectSource, to: node.id });
                    undoStack.push({ action: 'addConnection', from: connectSource, to: node.id });
                }
                connectSource = null;
                renderAll();
            }
            return;
        }

        selectedNode = (selectedNode === node.id) ? null : node.id;
        renderAll();
    }

    svg.addEventListener('click', () => {
        if (!connectMode) {
            selectedNode = null;
            renderAll();
        }
    });

    // ========== KEYBOARD ==========
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            if (connectMode) toggleConnectMode();
            if (document.getElementById('addNodeModal').classList.contains('visible')) closeAddNodeModal();
            selectedNode = null;
            renderAll();
        }
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedNode && !e.target.closest('input, textarea, select')) {
            e.preventDefault();
            removeNode(selectedNode);
        }
    });

    function removeNode(nodeId) {
        const node = nodes.find(n => n.id === nodeId);
        if (!node || node.type === 'root') return;
        const removedConns = connections.filter(c => c.from === nodeId || c.to === nodeId);
        undoStack.push({ action: 'removeNode', node: { ...node }, connections: removedConns });
        nodes = nodes.filter(n => n.id !== nodeId);
        connections = connections.filter(c => c.from !== nodeId && c.to !== nodeId);
        selectedNode = null;

        // Unmark sidebar card
        if (node.sourceId) {
            const card = document.querySelector(`.consequence-card[data-id="${node.sourceId}"]`);
            if (card) card.classList.remove('placed');
        }
        renderAll();
    }

    // ========== CONNECT MODE ==========
    function toggleConnectMode() {
        connectMode = !connectMode;
        connectSource = null;
        const btn = document.getElementById('connectBtn');
        const hint = document.getElementById('connectHint');
        if (connectMode) {
            btn.textContent = '\u2716 Cancel';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-danger');
            hint.classList.add('visible');
            svg.style.cursor = 'crosshair';
        } else {
            btn.innerHTML = '&#8594; Connect';
            btn.classList.add('btn-primary');
            btn.classList.remove('btn-danger');
            hint.classList.remove('visible');
            svg.style.cursor = '';
        }
        renderAll();
    }

    // ========== ADD CUSTOM NODE ==========
    function openAddNodeModal() {
        document.getElementById('addNodeModal').classList.add('visible');
        document.getElementById('nodeTitle').focus();
    }

    function closeAddNodeModal() {
        document.getElementById('addNodeModal').classList.remove('visible');
        document.getElementById('nodeTitle').value = '';
        document.getElementById('nodeDetail').value = '';
    }

    function addCustomNode() {
        const title = document.getElementById('nodeTitle').value.trim();
        if (!title) { alert('Please enter a title.'); return; }
        const type = document.getElementById('nodeType').value;
        const detail = document.getElementById('nodeDetail').value.trim();

        // Place in the middle of the short-term lane initially
        const x = 300 + Math.random() * 400;
        const lane = 'short';
        const laneConfig = LANE_CONFIG[lane];
        const y = laneConfig.y + laneConfig.height / 2 - NODE_H / 2;

        const node = {
            id: 'node_' + nextNodeId++,
            text: title.length > 35 ? title.substring(0, 33) + '...' : title,
            fullText: title,
            type: type,
            lane: lane,
            x: x,
            y: y,
            detail: detail
        };

        undoStack.push({ action: 'addNode', nodeId: node.id });
        nodes.push(node);
        renderAll();
        closeAddNodeModal();
    }

    // ========== UNDO ==========
    function undoLast() {
        if (undoStack.length === 0) return;
        const action = undoStack.pop();

        if (action.action === 'addNode') {
            const node = nodes.find(n => n.id === action.nodeId);
            if (node && node.sourceId) {
                const card = document.querySelector(`.consequence-card[data-id="${node.sourceId}"]`);
                if (card) card.classList.remove('placed');
            }
            nodes = nodes.filter(n => n.id !== action.nodeId);
            connections = connections.filter(c => c.from !== action.nodeId && c.to !== action.nodeId);
        } else if (action.action === 'addConnection') {
            connections = connections.filter(c => !(c.from === action.from && c.to === action.to));
        } else if (action.action === 'removeNode') {
            nodes.push(action.node);
            action.connections.forEach(c => connections.push(c));
            if (action.node.sourceId) {
                const card = document.querySelector(`.consequence-card[data-id="${action.node.sourceId}"]`);
                if (card) card.classList.add('placed');
            }
        }

        selectedNode = null;
        renderAll();
    }

    // ========== CLEAR ==========
    function clearCanvas() {
        nodes = [];
        connections = [];
        undoStack = [];
        selectedNode = null;
        connectSource = null;
        nextNodeId = 1;
        if (connectMode) toggleConnectMode();

        document.querySelectorAll('.consequence-card.placed').forEach(c => c.classList.remove('placed'));

        svg.setAttribute('width', 1200);
        svg.setAttribute('height', 700);
        initCanvas();
    }

    // ========== INFO PANEL ==========
    function toggleInfoPanel() {
        document.getElementById('infoPanel').classList.toggle('open');
    }

    // ========== SIDEBAR TOGGLE (MOBILE) ==========
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // Close sidebar on outside click (mobile)
    document.addEventListener('click', e => {
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('sidebarToggle');
        if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !toggle.contains(e.target)) {
            sidebar.classList.remove('open');
        }
    });

    // ========== INIT ==========
    initCanvas();
</script>
</body>
</html>