<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timeline Builder</title>
<style>
:root {
  --bg-primary: #1a1f2e;
  --bg-secondary: #242a3d;
  --bg-card: #f5ecd7;
  --bg-card-hover: #efe3c8;
  --bg-parchment: #faf3e0;
  --accent-gold: #c9a84c;
  --accent-gold-light: #e2c872;
  --accent-gold-dim: #9a7b30;
  --text-light: #e8e4dc;
  --text-muted: #9a968e;
  --text-dark: #2c2a26;
  --track-political: #5b8abf;
  --track-social: #7ab87a;
  --track-economic: #d4a054;
  --track-military: #c05555;
  --border-subtle: rgba(201,168,76,0.25);
  --shadow-card: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-popup: 0 8px 32px rgba(0,0,0,0.5);
  --radius: 6px;
  --header-h: 72px;
  --sidebar-w: 300px;
  --track-h: 70px;
  --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --font-display: Georgia, 'Times New Roman', serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-main);
  background: var(--bg-primary);
  color: var(--text-light);
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Header */
header {
  position: sticky; top: 0; z-index: 100;
  background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
  border-bottom: 2px solid var(--accent-gold);
  padding: 10px 24px;
  display: flex; align-items: center; justify-content: space-between;
  height: var(--header-h);
  flex-shrink: 0;
}
header .title-group h1 {
  font-family: var(--font-display);
  font-size: 1.5rem;
  color: var(--accent-gold-light);
  letter-spacing: 0.5px;
}
header .title-group p {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 2px;
}
.header-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.header-controls select, .header-controls button {
  background: var(--bg-primary);
  color: var(--text-light);
  border: 1px solid var(--border-subtle);
  padding: 6px 12px;
  border-radius: var(--radius);
  font-size: 0.8rem;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
}
.header-controls select:hover, .header-controls button:hover {
  border-color: var(--accent-gold);
  background: var(--bg-secondary);
}
.btn-gold {
  background: var(--accent-gold-dim) !important;
  color: #fff !important;
  font-weight: 600;
}
.btn-gold:hover { background: var(--accent-gold) !important; }

/* Layout */
.app-body {
  display: flex;
  flex: 1;
  overflow: hidden;
  position: relative;
}

/* Sidebar */
.sidebar {
  width: var(--sidebar-w);
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}
.sidebar-tabs {
  display: flex;
  border-bottom: 1px solid var(--border-subtle);
}
.sidebar-tab {
  flex: 1; padding: 10px 8px;
  background: transparent; border: none;
  color: var(--text-muted); cursor: pointer;
  font-size: 0.78rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.5px;
  transition: color 0.2s, border-bottom 0.2s;
  border-bottom: 2px solid transparent;
}
.sidebar-tab.active {
  color: var(--accent-gold-light);
  border-bottom-color: var(--accent-gold);
}
.sidebar-content { flex: 1; overflow-y: auto; padding: 12px; }
.sidebar-content::-webkit-scrollbar { width: 6px; }
.sidebar-content::-webkit-scrollbar-thumb { background: var(--accent-gold-dim); border-radius: 3px; }

/* Event cards in bank */
.event-card {
  background: var(--bg-card);
  color: var(--text-dark);
  border-radius: var(--radius);
  padding: 10px 12px;
  margin-bottom: 8px;
  cursor: grab;
  box-shadow: var(--shadow-card);
  border-left: 4px solid var(--track-political);
  transition: transform 0.15s, box-shadow 0.15s;
  user-select: none;
}
.event-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
.event-card:active { cursor: grabbing; }
.event-card.placed { opacity: 0.35; pointer-events: none; }
.event-card .card-name { font-weight: 700; font-size: 0.82rem; margin-bottom: 3px; }
.event-card .card-date { font-size: 0.72rem; color: #665; margin-bottom: 4px; }
.event-card .card-desc { font-size: 0.7rem; color: #554; line-height: 1.35; }
.event-card .card-tag {
  display: inline-block; margin-top: 5px;
  font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
  padding: 2px 6px; border-radius: 3px; color: #fff;
}
.tag-political { background: var(--track-political); }
.tag-social { background: var(--track-social); }
.tag-economic { background: var(--track-economic); }
.tag-military { background: var(--track-military); }
.cat-political { border-left-color: var(--track-political); }
.cat-social { border-left-color: var(--track-social); }
.cat-economic { border-left-color: var(--track-economic); }
.cat-military { border-left-color: var(--track-military); }

/* Info panel */
.info-panel h3 { font-family: var(--font-display); color: var(--accent-gold-light); margin-bottom: 10px; font-size: 1rem; }
.info-panel p { font-size: 0.78rem; color: var(--text-muted); line-height: 1.55; margin-bottom: 10px; }
.info-panel ul { padding-left: 18px; margin-bottom: 10px; }
.info-panel li { font-size: 0.78rem; color: var(--text-muted); line-height: 1.55; margin-bottom: 4px; }
.info-panel strong { color: var(--text-light); }

/* Timeline area */
.timeline-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}
.timeline-toolbar {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-subtle);
  flex-shrink: 0; flex-wrap: wrap;
}
.timeline-toolbar label { font-size: 0.75rem; color: var(--text-muted); }
.zoom-controls { display: flex; align-items: center; gap: 6px; }
.zoom-controls button {
  width: 28px; height: 28px;
  background: var(--bg-primary); border: 1px solid var(--border-subtle);
  color: var(--text-light); border-radius: var(--radius);
  cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center;
}
.zoom-controls button:hover { border-color: var(--accent-gold); }
.zoom-level { font-size: 0.75rem; color: var(--accent-gold-light); min-width: 36px; text-align: center; }
.arrow-mode-toggle {
  padding: 5px 10px; border-radius: var(--radius);
  font-size: 0.75rem; cursor: pointer;
  border: 1px solid var(--border-subtle);
  background: var(--bg-primary); color: var(--text-light);
}
.arrow-mode-toggle.active { background: var(--accent-gold-dim); border-color: var(--accent-gold); color: #fff; }

.timeline-scroll {
  flex: 1;
  overflow: auto;
  position: relative;
}
.timeline-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
.timeline-scroll::-webkit-scrollbar-thumb { background: var(--accent-gold-dim); border-radius: 5px; }
.timeline-scroll::-webkit-scrollbar-track { background: var(--bg-primary); }

.timeline-canvas {
  position: relative;
  min-height: 100%;
}

/* Year markers */
.year-markers {
  position: sticky; top: 0; z-index: 10;
  height: 36px;
  background: var(--bg-primary);
  border-bottom: 2px solid var(--accent-gold-dim);
}
.year-marker {
  position: absolute; top: 0; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.72rem; color: var(--accent-gold-light);
  font-weight: 600; border-left: 1px solid var(--border-subtle);
  padding-left: 6px;
}
.year-marker.major { font-size: 0.82rem; border-left-color: var(--accent-gold); }

/* Track rows */
.track-area { position: relative; }
.track-row {
  position: relative;
  height: var(--track-h);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.track-label {
  position: sticky; left: 0; z-index: 5;
  width: 90px; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.68rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.5px; writing-mode: horizontal-tb;
  background: var(--bg-secondary); border-right: 1px solid var(--border-subtle);
}
.track-row.political .track-label { color: var(--track-political); }
.track-row.social .track-label { color: var(--track-social); }
.track-row.economic .track-label { color: var(--track-economic); }
.track-row.military .track-label { color: var(--track-military); }
.track-row .track-drop {
  position: absolute; left: 90px; top: 0; right: 0; bottom: 0;
}
.track-row.drag-over .track-drop { background: rgba(201,168,76,0.08); }

/* Placed events on timeline */
.timeline-event {
  position: absolute;
  top: 8px;
  height: calc(var(--track-h) - 16px);
  min-width: 100px;
  background: var(--bg-card);
  color: var(--text-dark);
  border-radius: var(--radius);
  padding: 6px 10px;
  font-size: 0.7rem;
  font-weight: 600;
  box-shadow: var(--shadow-card);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: box-shadow 0.15s;
  border-top: 3px solid var(--track-political);
}
.timeline-event:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.5); z-index: 3; }
.timeline-event.political { border-top-color: var(--track-political); }
.timeline-event.social { border-top-color: var(--track-social); }
.timeline-event.economic { border-top-color: var(--track-economic); }
.timeline-event.military { border-top-color: var(--track-military); }
.timeline-event .remove-btn {
  position: absolute; top: 2px; right: 4px;
  background: none; border: none; cursor: pointer;
  color: #999; font-size: 0.8rem; line-height: 1;
}
.timeline-event .remove-btn:hover { color: #c00; }

/* Arrows SVG overlay */
.arrows-overlay {
  position: absolute; top: 0; left: 0;
  pointer-events: none; z-index: 4;
}
.arrows-overlay line, .arrows-overlay path {
  pointer-events: stroke;
  cursor: pointer;
}
.arrow-line { stroke: var(--accent-gold); stroke-width: 2; fill: none; }
.arrow-line:hover { stroke: var(--accent-gold-light); stroke-width: 3; }

/* Popup overlay */
.popup-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.6);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
.popup-overlay.visible { opacity: 1; pointer-events: all; }
.popup-card {
  background: var(--bg-parchment);
  color: var(--text-dark);
  border-radius: 10px;
  padding: 28px 32px;
  max-width: 480px; width: 90%;
  box-shadow: var(--shadow-popup);
  position: relative;
  border-top: 5px solid var(--accent-gold);
}
.popup-card h2 { font-family: var(--font-display); font-size: 1.2rem; margin-bottom: 4px; }
.popup-card .popup-date { font-size: 0.82rem; color: #776; margin-bottom: 10px; }
.popup-card .popup-desc { font-size: 0.85rem; line-height: 1.6; margin-bottom: 12px; }
.popup-card .popup-tag { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #fff; }
.popup-close {
  position: absolute; top: 12px; right: 16px;
  background: none; border: none; font-size: 1.4rem;
  cursor: pointer; color: #998;
}
.popup-close:hover { color: #333; }

/* Check results toast */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--bg-secondary); color: var(--text-light);
  padding: 14px 28px; border-radius: 8px;
  box-shadow: var(--shadow-popup);
  border: 1px solid var(--accent-gold);
  font-size: 0.88rem; z-index: 300;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s;
}
.toast.visible { opacity: 1; pointer-events: all; }
.toast.success { border-color: #5b5; }
.toast.error { border-color: #c55; }

/* Sidebar toggle for mobile */
.sidebar-toggle {
  display: none;
  position: fixed; bottom: 16px; right: 16px; z-index: 150;
  width: 48px; height: 48px; border-radius: 50%;
  background: var(--accent-gold); border: none;
  color: var(--bg-primary); font-size: 1.4rem;
  cursor: pointer; box-shadow: var(--shadow-card);
}

@media (max-width: 800px) {
  :root { --sidebar-w: 260px; }
  .sidebar {
    position: fixed; left: 0; top: var(--header-h); bottom: 0;
    z-index: 50; transform: translateX(-100%);
    transition: transform 0.3s;
  }
  .sidebar.open { transform: translateX(0); }
  .sidebar-toggle { display: flex; align-items: center; justify-content: center; }
  header .title-group h1 { font-size: 1.15rem; }
  .header-controls { gap: 4px; }
}
</style>
</head>
<body>

<header>
  <div class="title-group">
    <h1>Timeline Builder</h1>
    <p>Drag historical events onto a chronological timeline</p>
  </div>
  <div class="header-controls">
    <select id="topicSelect">
      <option value="ww1">World War One</option>
      <option value="tudor">Tudor England</option>
      <option value="civilrights">Civil Rights Movement</option>
    </select>
    <button class="btn-gold" id="checkOrderBtn">Check Order</button>
    <button id="resetBtn">Reset</button>
  </div>
</header>

<div class="app-body">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" data-tab="events">Events</button>
      <button class="sidebar-tab" data-tab="info">Info</button>
    </div>
    <div class="sidebar-content" id="sidebarContent"></div>
  </aside>

  <div class="timeline-area">
    <div class="timeline-toolbar">
      <div class="zoom-controls">
        <label>Zoom:</label>
        <button id="zoomOut" title="Zoom out">-</button>
        <span class="zoom-level" id="zoomLabel">100%</span>
        <button id="zoomIn" title="Zoom in">+</button>
      </div>
      <button class="arrow-mode-toggle" id="arrowToggle" title="Toggle arrow drawing mode">Draw Arrows</button>
      <button id="clearArrowsBtn" style="font-size:0.75rem;padding:5px 10px;border-radius:var(--radius);border:1px solid var(--border-subtle);background:var(--bg-primary);color:var(--text-light);cursor:pointer;">Clear Arrows</button>
    </div>
    <div class="timeline-scroll" id="timelineScroll">
      <div class="timeline-canvas" id="timelineCanvas">
        <div class="year-markers" id="yearMarkers"></div>
        <div class="track-area" id="trackArea"></div>
        <svg class="arrows-overlay" id="arrowsSvg">
          <defs>
            <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
              <polygon points="0 0, 8 3, 0 6" fill="var(--accent-gold)" />
            </marker>
          </defs>
        </svg>
      </div>
    </div>
  </div>
</div>

<button class="sidebar-toggle" id="sidebarToggle">&#9776;</button>

<div class="popup-overlay" id="popupOverlay">
  <div class="popup-card" id="popupCard">
    <button class="popup-close" id="popupClose">&times;</button>
    <h2 id="popupTitle"></h2>
    <div class="popup-date" id="popupDate"></div>
    <div class="popup-desc" id="popupDesc"></div>
    <span class="popup-tag" id="popupTag"></span>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== DATA: Topic Packs ===== */
const TOPICS = {
  ww1: {
    label: 'World War One',
    startYear: 1905,
    endYear: 1920,
    events: [
      { id:'w1', name:'Schlieffen Plan Devised', date:'1905-12-01', sortDate:1905.92, desc:'Germany developed a military strategy to avoid a two-front war by quickly defeating France through Belgium before turning east to fight Russia.', category:'military' },
      { id:'w2', name:'Bosnian Crisis', date:'1908-10-06', sortDate:1908.76, desc:'Austria-Hungary annexed Bosnia and Herzegovina, angering Serbia and increasing tensions in the Balkans. Russia backed down under German pressure.', category:'political' },
      { id:'w3', name:'First Moroccan Crisis', date:'1905-03-31', sortDate:1905.25, desc:'Kaiser Wilhelm II challenged French influence in Morocco, testing the Anglo-French Entente. The resulting Algeciras Conference strengthened ties between Britain and France.', category:'political' },
      { id:'w4', name:'Anglo-German Naval Race', date:'1906-02-10', sortDate:1906.11, desc:'The launch of HMS Dreadnought intensified naval competition between Britain and Germany, deepening mutual suspicion and driving the arms race.', category:'military' },
      { id:'w5', name:'Second Moroccan Crisis (Agadir)', date:'1911-07-01', sortDate:1911.50, desc:'Germany sent the gunboat Panther to Agadir, challenging French expansion in Morocco. British support for France further isolated Germany.', category:'political' },
      { id:'w6', name:'First Balkan War', date:'1912-10-08', sortDate:1912.77, desc:'The Balkan League (Serbia, Greece, Bulgaria, Montenegro) defeated the Ottoman Empire, redrawing borders and heightening regional rivalries.', category:'military' },
      { id:'w7', name:'Second Balkan War', date:'1913-06-29', sortDate:1913.49, desc:'Bulgaria attacked its former allies but was defeated. Serbia doubled in size, alarming Austria-Hungary and deepening Balkan instability.', category:'military' },
      { id:'w8', name:'Assassination of Archduke Franz Ferdinand', date:'1914-06-28', sortDate:1914.49, desc:'Gavrilo Princip, a Bosnian Serb nationalist, shot Archduke Franz Ferdinand and his wife in Sarajevo, triggering the July Crisis.', category:'political' },
      { id:'w9', name:'Austria-Hungary Declares War on Serbia', date:'1914-07-28', sortDate:1914.57, desc:'After issuing an ultimatum that Serbia could not fully accept, Austria-Hungary declared war, activating the alliance system across Europe.', category:'military' },
      { id:'w10', name:'Germany Invades Belgium', date:'1914-08-04', sortDate:1914.59, desc:'Germany invaded neutral Belgium as part of the Schlieffen Plan, prompting Britain to declare war on Germany in defence of Belgian neutrality.', category:'military' },
      { id:'w11', name:'Battle of the Marne', date:'1914-09-05', sortDate:1914.68, desc:'The Allied counter-attack halted the German advance on Paris. The failure of the Schlieffen Plan led to trench warfare on the Western Front.', category:'military' },
      { id:'w12', name:'Christmas Truce', date:'1914-12-25', sortDate:1914.98, desc:'Unofficial ceasefires occurred along the Western Front as soldiers from both sides exchanged gifts and played football in No Man\'s Land.', category:'social' },
      { id:'w13', name:'Gallipoli Campaign Begins', date:'1915-04-25', sortDate:1915.31, desc:'Allied forces landed at Gallipoli in an attempt to knock the Ottoman Empire out of the war. The campaign ended in costly failure and withdrawal.', category:'military' },
      { id:'w14', name:'Sinking of the Lusitania', date:'1915-05-07', sortDate:1915.35, desc:'A German U-boat torpedoed the British liner Lusitania, killing 1,198 people including 128 Americans. It shifted public opinion against Germany.', category:'economic' },
      { id:'w15', name:'Battle of the Somme', date:'1916-07-01', sortDate:1916.50, desc:'A major British offensive that saw nearly 20,000 British soldiers killed on the first day alone. Over 1 million casualties by November. Symbolised the horror of industrial warfare.', category:'military' },
      { id:'w16', name:'USA Enters the War', date:'1917-04-06', sortDate:1917.26, desc:'Prompted by unrestricted submarine warfare and the Zimmermann Telegram, the United States declared war on Germany, tipping the balance toward the Allies.', category:'political' },
      { id:'w17', name:'Russian Revolution', date:'1917-11-07', sortDate:1917.85, desc:'The Bolsheviks seized power in Russia, eventually leading to Russia\'s withdrawal from the war via the Treaty of Brest-Litovsk in March 1918.', category:'political' },
      { id:'w18', name:'Armistice Signed', date:'1918-11-11', sortDate:1918.86, desc:'At 11am on the 11th day of the 11th month, the guns fell silent. Germany signed the armistice, ending four years of devastating conflict.', category:'military' },
      { id:'w19', name:'Treaty of Versailles', date:'1919-06-28', sortDate:1919.49, desc:'The peace settlement imposed harsh terms on Germany: war guilt, reparations of 6.6 billion, loss of territory, and military restrictions. It sowed seeds of future conflict.', category:'political' }
    ]
  },
  tudor: {
    label: 'Tudor England',
    startYear: 1485,
    endYear: 1605,
    events: [
      { id:'t1', name:'Battle of Bosworth Field', date:'1485-08-22', sortDate:1485.64, desc:'Henry Tudor defeated Richard III, ending the Wars of the Roses and establishing the Tudor dynasty on the English throne.', category:'military' },
      { id:'t2', name:'Henry VII Marries Elizabeth of York', date:'1486-01-18', sortDate:1486.05, desc:'The marriage united the rival houses of Lancaster and York, symbolising peace and strengthening Tudor legitimacy.', category:'political' },
      { id:'t3', name:'Henry VIII Becomes King', date:'1509-04-21', sortDate:1509.30, desc:'The eighteen-year-old Henry VIII inherited a stable, wealthy kingdom and initially ruled as a Renaissance prince.', category:'political' },
      { id:'t4', name:'Henry VIII Breaks with Rome', date:'1534-11-03', sortDate:1534.84, desc:'The Act of Supremacy declared Henry VIII Supreme Head of the Church of England, severing ties with the Pope over the divorce from Catherine of Aragon.', category:'political' },
      { id:'t5', name:'Dissolution of the Monasteries', date:'1536-03-01', sortDate:1536.16, desc:'Henry VIII ordered the closure of Catholic monasteries, seizing their lands and wealth. It was the largest redistribution of land since the Norman Conquest.', category:'economic' },
      { id:'t6', name:'Pilgrimage of Grace', date:'1536-10-01', sortDate:1536.75, desc:'A major uprising in northern England against the religious reforms, particularly the dissolution of the monasteries. It was eventually crushed.', category:'social' },
      { id:'t7', name:'Execution of Anne Boleyn', date:'1536-05-19', sortDate:1536.38, desc:'Henry VIII\'s second wife was executed on charges of treason and adultery, making way for Jane Seymour to become queen.', category:'political' },
      { id:'t8', name:'Edward VI Becomes King', date:'1547-01-28', sortDate:1547.08, desc:'Henry VIII\'s nine-year-old son became king. Under his Protestant protectors, England moved further toward reformed religion.', category:'political' },
      { id:'t9', name:'Book of Common Prayer Introduced', date:'1549-06-09', sortDate:1549.44, desc:'Thomas Cranmer\'s English-language prayer book replaced Latin services, provoking the Western Rising in Devon and Cornwall.', category:'social' },
      { id:'t10', name:'Lady Jane Grey (Nine Days\' Queen)', date:'1553-07-10', sortDate:1553.52, desc:'Jane Grey was proclaimed queen but overthrown after nine days by Mary Tudor, who had widespread popular support.', category:'political' },
      { id:'t11', name:'Mary I Restores Catholicism', date:'1553-10-01', sortDate:1553.75, desc:'Mary I reversed the Protestant reforms, reconciled England with Rome, and burned nearly 300 Protestants at the stake, earning the name "Bloody Mary".', category:'social' },
      { id:'t12', name:'Elizabeth I Becomes Queen', date:'1558-11-17', sortDate:1558.88, desc:'Elizabeth inherited a divided nation and would go on to reign for 45 years, presiding over a golden age of exploration, literature, and relative stability.', category:'political' },
      { id:'t13', name:'Elizabethan Religious Settlement', date:'1559-04-29', sortDate:1559.33, desc:'Elizabeth\'s compromise established a moderate Protestant Church of England, aiming to satisfy both Catholics and Protestants.', category:'social' },
      { id:'t14', name:'Execution of Mary Queen of Scots', date:'1587-02-08', sortDate:1587.11, desc:'After years of imprisonment, Mary Stuart was executed for her involvement in plots against Elizabeth, removing a Catholic figurehead.', category:'political' },
      { id:'t15', name:'Defeat of the Spanish Armada', date:'1588-08-08', sortDate:1588.60, desc:'The English navy and severe storms destroyed Philip II\'s invasion fleet, securing England\'s independence and boosting national confidence.', category:'military' },
      { id:'t16', name:'English East India Company Founded', date:'1600-12-31', sortDate:1600.99, desc:'Elizabeth I granted a royal charter to the East India Company, marking the beginning of English commercial expansion into Asia.', category:'economic' },
      { id:'t17', name:'Death of Elizabeth I', date:'1603-03-24', sortDate:1603.23, desc:'Elizabeth died without an heir, ending the Tudor dynasty. James VI of Scotland became James I of England.', category:'political' }
    ]
  },
  civilrights: {
    label: 'Civil Rights Movement',
    startYear: 1945,
    endYear: 1975,
    events: [
      { id:'c1', name:'Executive Order 9981 (Desegregation of Military)', date:'1948-07-26', sortDate:1948.57, desc:'President Truman signed an executive order desegregating the US armed forces, an early federal step toward racial equality.', category:'political' },
      { id:'c2', name:'Brown v. Board of Education', date:'1954-05-17', sortDate:1954.38, desc:'The Supreme Court ruled that racial segregation in public schools was unconstitutional, overturning the "separate but equal" doctrine of Plessy v. Ferguson.', category:'political' },
      { id:'c3', name:'Murder of Emmett Till', date:'1955-08-28', sortDate:1955.66, desc:'The brutal murder of 14-year-old Emmett Till in Mississippi, and the acquittal of his killers, galvanised the civil rights movement and drew national attention to racial violence.', category:'social' },
      { id:'c4', name:'Montgomery Bus Boycott', date:'1955-12-05', sortDate:1955.93, desc:'After Rosa Parks was arrested for refusing to give up her bus seat, a 381-day boycott led by Martin Luther King Jr. ended segregation on Montgomery buses.', category:'social' },
      { id:'c5', name:'Little Rock Nine', date:'1957-09-25', sortDate:1957.74, desc:'Nine Black students integrated Central High School in Little Rock, Arkansas, escorted by federal troops after Governor Faubus tried to block them.', category:'social' },
      { id:'c6', name:'Greensboro Sit-Ins', date:'1960-02-01', sortDate:1960.09, desc:'Four Black college students staged a sit-in at a segregated Woolworth\'s lunch counter, sparking a wave of nonviolent protests across the South.', category:'social' },
      { id:'c7', name:'Freedom Rides', date:'1961-05-04', sortDate:1961.34, desc:'Interracial groups rode buses through the Deep South to challenge segregation in interstate travel, facing violent attacks from white mobs.', category:'social' },
      { id:'c8', name:'March on Washington', date:'1963-08-28', sortDate:1963.66, desc:'Over 250,000 people gathered at the Lincoln Memorial where Martin Luther King Jr. delivered his famous "I Have a Dream" speech, calling for racial equality.', category:'political' },
      { id:'c9', name:'Birmingham Campaign', date:'1963-04-03', sortDate:1963.26, desc:'Organised protests in Birmingham, Alabama were met with police dogs and fire hoses. The televised brutality shocked the nation and pressured the federal government to act.', category:'social' },
      { id:'c10', name:'16th Street Baptist Church Bombing', date:'1963-09-15', sortDate:1963.71, desc:'A white supremacist bombing killed four young Black girls at a church in Birmingham, highlighting the deadly violence faced by the civil rights movement.', category:'social' },
      { id:'c11', name:'Civil Rights Act 1964', date:'1964-07-02', sortDate:1964.50, desc:'Landmark legislation that outlawed discrimination based on race, colour, religion, sex, or national origin, banning segregation in public places and employment discrimination.', category:'political' },
      { id:'c12', name:'Mississippi Freedom Summer', date:'1964-06-15', sortDate:1964.45, desc:'A voter registration drive in Mississippi drew hundreds of volunteers. Three civil rights workers were murdered by the Ku Klux Klan.', category:'social' },
      { id:'c13', name:'Selma to Montgomery Marches', date:'1965-03-07', sortDate:1965.18, desc:'Peaceful marchers were attacked on "Bloody Sunday" while crossing the Edmund Pettus Bridge. The violence led directly to the passage of the Voting Rights Act.', category:'political' },
      { id:'c14', name:'Voting Rights Act 1965', date:'1965-08-06', sortDate:1965.60, desc:'Prohibited racial discrimination in voting, removing barriers like literacy tests that had disenfranchised Black voters across the South.', category:'political' },
      { id:'c15', name:'Watts Riots', date:'1965-08-11', sortDate:1965.61, desc:'Six days of unrest in the Watts neighbourhood of Los Angeles, triggered by police brutality and systemic economic inequality faced by Black residents.', category:'economic' },
      { id:'c16', name:'Black Panther Party Founded', date:'1966-10-15', sortDate:1966.79, desc:'Huey Newton and Bobby Seale founded the Black Panther Party in Oakland, advocating self-defence, community programmes, and Black empowerment.', category:'political' },
      { id:'c17', name:'Assassination of Martin Luther King Jr.', date:'1968-04-04', sortDate:1968.26, desc:'King was shot and killed in Memphis, Tennessee. His death sparked riots in over 100 cities and marked a turning point in the movement.', category:'political' },
      { id:'c18', name:'Fair Housing Act 1968', date:'1968-04-11', sortDate:1968.28, desc:'Signed one week after King\'s assassination, this act prohibited discrimination in the sale, rental, and financing of housing.', category:'economic' }
    ]
  }
};

/* ===== STATE ===== */
let currentTopic = 'ww1';
let zoomLevel = 1;
let placedEvents = []; // { eventId, trackCategory }
let arrows = []; // { fromId, toId }
let arrowMode = false;
let arrowStart = null;
let activeTab = 'events';

const ZOOM_STEPS = [0.25, 0.5, 0.75, 1, 1.5, 2, 3];
const BASE_PX_PER_YEAR = 160;
const CATEGORIES = ['political','social','economic','military'];
const CATEGORY_COLORS = { political:'var(--track-political)', social:'var(--track-social)', economic:'var(--track-economic)', military:'var(--track-military)' };

/* ===== DOM REFS ===== */
const $ = s => document.querySelector(s);
const topicSelect = $('#topicSelect');
const sidebarContent = $('#sidebarContent');
const yearMarkers = $('#yearMarkers');
const trackArea = $('#trackArea');
const timelineCanvas = $('#timelineCanvas');
const timelineScroll = $('#timelineScroll');
const arrowsSvg = $('#arrowsSvg');
const popupOverlay = $('#popupOverlay');
const toast = $('#toast');

/* ===== HELPERS ===== */
function getTopic() { return TOPICS[currentTopic]; }
function pxPerYear() { return BASE_PX_PER_YEAR * zoomLevel; }
function dateToX(sortDate) {
  const topic = getTopic();
  return 90 + (sortDate - topic.startYear) * pxPerYear();
}
function totalWidth() {
  const topic = getTopic();
  return 90 + (topic.endYear - topic.startYear) * pxPerYear() + 60;
}
function isPlaced(eventId) { return placedEvents.some(p => p.eventId === eventId); }
function getEvent(eventId) { return getTopic().events.find(e => e.id === eventId); }

function showToast(msg, type) {
  toast.textContent = msg;
  toast.className = 'toast visible ' + (type || '');
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => toast.classList.remove('visible'), 3500);
}

/* ===== RENDER SIDEBAR ===== */
function renderSidebar() {
  if (activeTab === 'events') {
    renderEventBank();
  } else {
    renderInfoPanel();
  }
}

function renderEventBank() {
  const topic = getTopic();
  let html = '<div style="margin-bottom:10px;font-size:0.78rem;color:var(--text-muted);">Drag events onto the timeline:</div>';
  topic.events.forEach(ev => {
    const placed = isPlaced(ev.id);
    html += `<div class="event-card cat-${ev.category} ${placed ? 'placed' : ''}" draggable="${placed ? 'false' : 'true'}" data-event-id="${ev.id}">
      <div class="card-name">${ev.name}</div>
      <div class="card-date">${ev.date}</div>
      <div class="card-desc">${ev.desc.substring(0,80)}${ev.desc.length>80?'...':''}</div>
      <span class="card-tag tag-${ev.category}">${ev.category}</span>
    </div>`;
  });
  sidebarContent.innerHTML = html;
  attachDragListeners();
}

function renderInfoPanel() {
  sidebarContent.innerHTML = `<div class="info-panel">
    <h3>Chronology Skills</h3>
    <p>Chronology is the arrangement of events in the order they occurred. Understanding chronology helps historians identify patterns, causes, and consequences.</p>
    <ul>
      <li><strong>Sequencing:</strong> Placing events in the correct time order reveals how one development led to another.</li>
      <li><strong>Duration:</strong> Zooming in and out helps you see whether changes were sudden or gradual.</li>
      <li><strong>Simultaneity:</strong> Parallel tracks show events happening at the same time in different areas (political, social, economic, military).</li>
    </ul>
    <h3>Cause and Effect</h3>
    <p>Use the "Draw Arrows" tool to connect events that have a cause-and-effect relationship. Ask yourself:</p>
    <ul>
      <li>Did this event directly lead to another?</li>
      <li>Were there multiple causes contributing to one outcome?</li>
      <li>What were the short-term and long-term consequences?</li>
    </ul>
    <h3>Significance of Sequencing</h3>
    <p>Getting the order right matters because:</p>
    <ul>
      <li>It prevents <strong>anachronism</strong> (placing ideas or events in the wrong time period).</li>
      <li>It helps identify <strong>turning points</strong> where the direction of events changed.</li>
      <li>It builds <strong>narrative understanding</strong>, helping you explain "why" events unfolded as they did.</li>
    </ul>
    <h3>How to Use This Tool</h3>
    <ul>
      <li>Drag event cards from this panel onto the matching category track.</li>
      <li>Events snap to their correct date position.</li>
      <li>Click any placed event to see full details.</li>
      <li>Use "Draw Arrows" to connect causes to effects.</li>
      <li>Press "Check Order" to test your placement.</li>
      <li>Switch between topic packs using the dropdown.</li>
    </ul>
  </div>`;
}

/* ===== RENDER TIMELINE ===== */
function renderTimeline() {
  const topic = getTopic();
  const w = totalWidth();
  timelineCanvas.style.width = w + 'px';

  // Year markers
  let markersHtml = '';
  const span = topic.endYear - topic.startYear;
  let step = 1;
  if (zoomLevel <= 0.25) step = 10;
  else if (zoomLevel <= 0.5) step = 5;
  else if (zoomLevel <= 0.75) step = 2;
  else if (zoomLevel <= 1) step = 1;
  else step = 1;

  for (let y = topic.startYear; y <= topic.endYear; y++) {
    const x = dateToX(y);
    const isMajor = y % (step >= 5 ? step : 5) === 0;
    if (y % step !== 0 && !isMajor) continue;
    markersHtml += `<div class="year-marker ${isMajor ? 'major' : ''}" style="left:${x}px;">${y}</div>`;
  }
  yearMarkers.innerHTML = markersHtml;
  yearMarkers.style.width = w + 'px';

  // Track rows
  let tracksHtml = '';
  CATEGORIES.forEach(cat => {
    tracksHtml += `<div class="track-row ${cat}" data-category="${cat}">
      <div class="track-label">${cat}</div>
      <div class="track-drop" data-category="${cat}"></div>
    </div>`;
  });
  trackArea.innerHTML = tracksHtml;
  trackArea.style.width = w + 'px';

  // Place events
  placedEvents.forEach(p => {
    const ev = getEvent(p.eventId);
    if (!ev) return;
    const x = dateToX(ev.sortDate);
    const trackRow = trackArea.querySelector(`.track-row.${p.trackCategory} .track-drop`);
    if (!trackRow) return;
    const el = document.createElement('div');
    el.className = `timeline-event ${p.trackCategory}`;
    el.dataset.eventId = ev.id;
    el.style.left = (x - 90) + 'px';
    el.innerHTML = `<span>${ev.name}</span><button class="remove-btn" data-event-id="${ev.id}">&times;</button>`;
    trackRow.appendChild(el);
  });

  // Arrows SVG sizing
  const totalH = 36 + CATEGORIES.length * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--track-h'));
  arrowsSvg.setAttribute('width', w);
  arrowsSvg.setAttribute('height', totalH + 40);
  arrowsSvg.style.width = w + 'px';
  arrowsSvg.style.height = (totalH + 40) + 'px';

  renderArrows();
  attachTimelineListeners();
  attachDropListeners();
}

/* ===== ARROWS ===== */
function renderArrows() {
  // Clear existing arrow lines
  arrowsSvg.querySelectorAll('.arrow-line').forEach(l => l.remove());
  arrows.forEach((arrow, idx) => {
    const fromEl = trackArea.querySelector(`.timeline-event[data-event-id="${arrow.fromId}"]`);
    const toEl = trackArea.querySelector(`.timeline-event[data-event-id="${arrow.toId}"]`);
    if (!fromEl || !toEl) return;
    const fromRect = fromEl.getBoundingClientRect();
    const toRect = toEl.getBoundingClientRect();
    const canvasRect = timelineCanvas.getBoundingClientRect();
    const scrollLeft = timelineScroll.scrollLeft;
    const scrollTop = timelineScroll.scrollTop;

    const x1 = fromRect.right - canvasRect.left + scrollLeft;
    const y1 = fromRect.top + fromRect.height/2 - canvasRect.top + scrollTop;
    const x2 = toRect.left - canvasRect.left + scrollLeft;
    const y2 = toRect.top + toRect.height/2 - canvasRect.top + scrollTop;

    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('marker-end','url(#arrowhead)');
    line.classList.add('arrow-line');
    line.dataset.arrowIdx = idx;
    line.style.pointerEvents = 'stroke';
    line.style.cursor = 'pointer';
    line.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      arrows.splice(idx, 1);
      renderArrows();
    });
    arrowsSvg.appendChild(line);
  });
}

/* ===== DRAG & DROP ===== */
function attachDragListeners() {
  sidebarContent.querySelectorAll('.event-card[draggable="true"]').forEach(card => {
    card.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', card.dataset.eventId);
      e.dataTransfer.effectAllowed = 'move';
    });
  });
}

function attachDropListeners() {
  trackArea.querySelectorAll('.track-drop').forEach(drop => {
    drop.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      drop.parentElement.classList.add('drag-over');
    });
    drop.addEventListener('dragleave', () => {
      drop.parentElement.classList.remove('drag-over');
    });
    drop.addEventListener('drop', e => {
      e.preventDefault();
      drop.parentElement.classList.remove('drag-over');
      const eventId = e.dataTransfer.getData('text/plain');
      if (!eventId || isPlaced(eventId)) return;
      const ev = getEvent(eventId);
      if (!ev) return;
      const trackCat = drop.dataset.category;
      placedEvents.push({ eventId, trackCategory: trackCat });
      renderSidebar();
      renderTimeline();
    });
  });
}

/* ===== TIMELINE EVENT LISTENERS ===== */
function attachTimelineListeners() {
  // Click to show popup (or arrow mode)
  trackArea.querySelectorAll('.timeline-event').forEach(el => {
    el.addEventListener('click', e => {
      if (e.target.classList.contains('remove-btn')) return;
      const evId = el.dataset.eventId;
      if (arrowMode) {
        handleArrowClick(evId);
        return;
      }
      showEventPopup(evId);
    });
  });
  // Remove buttons
  trackArea.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const evId = btn.dataset.eventId;
      placedEvents = placedEvents.filter(p => p.eventId !== evId);
      arrows = arrows.filter(a => a.fromId !== evId && a.toId !== evId);
      renderSidebar();
      renderTimeline();
    });
  });
}

function handleArrowClick(evId) {
  if (!arrowStart) {
    arrowStart = evId;
    const el = trackArea.querySelector(`.timeline-event[data-event-id="${evId}"]`);
    if (el) el.style.outline = '2px solid var(--accent-gold-light)';
    return;
  }
  if (arrowStart === evId) {
    const el = trackArea.querySelector(`.timeline-event[data-event-id="${evId}"]`);
    if (el) el.style.outline = '';
    arrowStart = null;
    return;
  }
  // Check duplicate
  const exists = arrows.some(a => a.fromId === arrowStart && a.toId === evId);
  if (!exists) {
    arrows.push({ fromId: arrowStart, toId: evId });
  }
  const prevEl = trackArea.querySelector(`.timeline-event[data-event-id="${arrowStart}"]`);
  if (prevEl) prevEl.style.outline = '';
  arrowStart = null;
  renderArrows();
}

/* ===== POPUP ===== */
function showEventPopup(evId) {
  const ev = getEvent(evId);
  if (!ev) return;
  $('#popupTitle').textContent = ev.name;
  $('#popupDate').textContent = ev.date;
  $('#popupDesc').textContent = ev.desc;
  const tag = $('#popupTag');
  tag.textContent = ev.category;
  tag.className = 'popup-tag tag-' + ev.category;
  popupOverlay.classList.add('visible');
}
$('#popupClose').addEventListener('click', () => popupOverlay.classList.remove('visible'));
popupOverlay.addEventListener('click', e => { if (e.target === popupOverlay) popupOverlay.classList.remove('visible'); });

/* ===== CHECK ORDER ===== */
$('#checkOrderBtn').addEventListener('click', () => {
  if (placedEvents.length === 0) {
    showToast('Place some events on the timeline first.', 'error');
    return;
  }
  const topic = getTopic();
  const totalEvents = topic.events.length;
  const placedCount = placedEvents.length;

  // Check correct category
  let wrongCategory = 0;
  let correctCategory = 0;
  placedEvents.forEach(p => {
    const ev = getEvent(p.eventId);
    if (ev.category === p.trackCategory) {
      correctCategory++;
    } else {
      wrongCategory++;
    }
  });

  // Check chronological order within each track
  let orderCorrect = true;
  CATEGORIES.forEach(cat => {
    const inTrack = placedEvents
      .filter(p => p.trackCategory === cat)
      .map(p => getEvent(p.eventId))
      .filter(Boolean);
    for (let i = 1; i < inTrack.length; i++) {
      // Events snap to correct position so visual order is always right,
      // but we check category assignment
    }
  });

  if (placedCount < totalEvents) {
    if (wrongCategory === 0) {
      showToast(`${placedCount} of ${totalEvents} events placed. All in correct categories. Keep going!`, 'success');
    } else {
      showToast(`${placedCount} of ${totalEvents} events placed. ${wrongCategory} in the wrong category track.`, 'error');
    }
  } else {
    if (wrongCategory === 0) {
      showToast(`All ${totalEvents} events placed correctly. Well done!`, 'success');
    } else {
      showToast(`All events placed, but ${wrongCategory} are on the wrong category track. Review the coloured categories.`, 'error');
    }
  }
});

/* ===== ZOOM ===== */
function setZoom(level) {
  zoomLevel = level;
  $('#zoomLabel').textContent = Math.round(level * 100) + '%';
  renderTimeline();
}
$('#zoomIn').addEventListener('click', () => {
  const idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx < ZOOM_STEPS.length - 1) setZoom(ZOOM_STEPS[idx + 1]);
});
$('#zoomOut').addEventListener('click', () => {
  const idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx > 0) setZoom(ZOOM_STEPS[idx - 1]);
});

/* ===== ARROW MODE ===== */
$('#arrowToggle').addEventListener('click', () => {
  arrowMode = !arrowMode;
  $('#arrowToggle').classList.toggle('active', arrowMode);
  arrowStart = null;
  // Clear any outlines
  trackArea.querySelectorAll('.timeline-event').forEach(el => el.style.outline = '');
});
$('#clearArrowsBtn').addEventListener('click', () => {
  arrows = [];
  renderArrows();
});

/* ===== TOPIC SWITCH ===== */
topicSelect.addEventListener('change', () => {
  currentTopic = topicSelect.value;
  placedEvents = [];
  arrows = [];
  arrowStart = null;
  zoomLevel = 1;
  $('#zoomLabel').textContent = '100%';
  renderSidebar();
  renderTimeline();
});

/* ===== RESET ===== */
$('#resetBtn').addEventListener('click', () => {
  placedEvents = [];
  arrows = [];
  arrowStart = null;
  renderSidebar();
  renderTimeline();
});

/* ===== SIDEBAR TABS ===== */
document.querySelectorAll('.sidebar-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    activeTab = tab.dataset.tab;
    renderSidebar();
  });
});

/* ===== MOBILE SIDEBAR TOGGLE ===== */
$('#sidebarToggle').addEventListener('click', () => {
  $('#sidebar').classList.toggle('open');
});

/* ===== SCROLL WHEEL ZOOM ===== */
timelineScroll.addEventListener('wheel', e => {
  if (e.ctrlKey || e.metaKey) {
    e.preventDefault();
    const idx = ZOOM_STEPS.indexOf(zoomLevel);
    if (e.deltaY < 0 && idx < ZOOM_STEPS.length - 1) setZoom(ZOOM_STEPS[idx + 1]);
    else if (e.deltaY > 0 && idx > 0) setZoom(ZOOM_STEPS[idx - 1]);
  }
}, { passive: false });

/* ===== INIT ===== */
renderSidebar();
renderTimeline();
</script>
</body>
</html>
