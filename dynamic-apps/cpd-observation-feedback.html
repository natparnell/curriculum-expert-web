<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lesson Observation Feedback Builder</title>
<style>
:root {
  --primary: #1a5276;
  --primary-light: #2980b9;
  --primary-lighter: #3498db;
  --primary-faint: #ebf5fb;
  --primary-wash: #f4f9fd;
  --accent: #2471a3;
  --success: #27ae60;
  --success-light: #d5f5e3;
  --warning: #f39c12;
  --warning-light: #fef9e7;
  --danger: #e74c3c;
  --danger-light: #fdedec;
  --text: #2c3e50;
  --text-light: #5d6d7e;
  --text-lighter: #85929e;
  --border: #d5dbdb;
  --border-light: #e8e8e8;
  --bg: #f8f9fa;
  --white: #ffffff;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
  --radius: 8px;
  --radius-sm: 6px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ── Header ── */
.app-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: var(--white);
  padding: 20px 24px 16px;
  box-shadow: var(--shadow-md);
  position: sticky; top: 0; z-index: 100;
}
.app-header h1 {
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: -0.3px;
  margin-bottom: 2px;
}
.app-header .subtitle {
  font-size: 0.8rem;
  opacity: 0.8;
  font-weight: 400;
}

/* ── Lesson Meta ── */
.meta-bar {
  background: var(--white);
  border-bottom: 1px solid var(--border-light);
  padding: 12px 24px;
}
.meta-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 8px;
  max-width: 1200px;
  margin: 0 auto;
}
.meta-grid input {
  padding: 7px 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  color: var(--text);
  transition: border-color var(--transition);
  width: 100%;
}
.meta-grid input:focus {
  outline: none;
  border-color: var(--primary-lighter);
  box-shadow: 0 0 0 3px rgba(52,152,219,0.12);
}
.meta-grid input::placeholder { color: var(--text-lighter); }

/* ── Tabs ── */
.tab-bar {
  display: flex;
  background: var(--white);
  border-bottom: 2px solid var(--border-light);
  padding: 0 24px;
  position: sticky;
  top: 76px;
  z-index: 90;
  overflow-x: auto;
}
.tab-btn {
  padding: 12px 20px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-light);
  background: none;
  border: none;
  cursor: pointer;
  position: relative;
  white-space: nowrap;
  transition: color var(--transition);
}
.tab-btn:hover { color: var(--primary); }
.tab-btn.active {
  color: var(--primary);
}
.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: -2px; left: 0; right: 0;
  height: 2px;
  background: var(--primary-lighter);
  border-radius: 2px 2px 0 0;
}
.tab-btn .badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 18px;
  height: 18px;
  padding: 0 5px;
  border-radius: 9px;
  background: var(--primary-lighter);
  color: var(--white);
  font-size: 0.68rem;
  font-weight: 700;
  margin-left: 6px;
  vertical-align: middle;
}

/* ── Main Content ── */
.main-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px 24px 80px;
}
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ── Timer ── */
.timer-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--white);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  padding: 14px 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  flex-wrap: wrap;
}
.timer-display {
  font-size: 2rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: var(--primary);
  min-width: 130px;
  letter-spacing: 1px;
}
.timer-label {
  font-size: 0.75rem;
  color: var(--text-lighter);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}
.timer-btn {
  padding: 8px 16px;
  border-radius: var(--radius-sm);
  border: none;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
}
.timer-btn.start { background: var(--success); color: var(--white); }
.timer-btn.start:hover { background: #219a52; }
.timer-btn.pause { background: var(--warning); color: var(--white); }
.timer-btn.pause:hover { background: #d68910; }
.timer-btn.reset { background: var(--border-light); color: var(--text-light); }
.timer-btn.reset:hover { background: var(--border); }

/* ── Strategy Categories ── */
.category-section {
  margin-bottom: 16px;
}
.category-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--white);
  border: 1px solid var(--border-light);
  border-radius: var(--radius) var(--radius) 0 0;
  cursor: pointer;
  user-select: none;
}
.category-header .cat-icon {
  width: 28px; height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  color: var(--white);
  flex-shrink: 0;
}
.category-header h3 {
  font-size: 0.88rem;
  font-weight: 700;
  flex: 1;
}
.category-header .cat-count {
  font-size: 0.72rem;
  font-weight: 700;
  color: var(--text-lighter);
  background: var(--bg);
  padding: 2px 8px;
  border-radius: 10px;
}
.category-header .chevron {
  color: var(--text-lighter);
  transition: transform var(--transition);
  font-size: 0.7rem;
}
.category-section.collapsed .chevron { transform: rotate(-90deg); }
.category-section.collapsed .strategy-grid { display: none; }

.strategy-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(155px, 1fr));
  gap: 6px;
  padding: 10px;
  background: var(--primary-wash);
  border: 1px solid var(--border-light);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
}
.strategy-btn {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--white);
  font-size: 0.78rem;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  transition: all var(--transition);
  text-align: center;
  line-height: 1.3;
  position: relative;
}
.strategy-btn:hover {
  border-color: var(--primary-lighter);
  background: var(--primary-faint);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}
.strategy-btn:active {
  transform: scale(0.97);
}
.strategy-btn .tap-count {
  position: absolute;
  top: -6px; right: -6px;
  background: var(--primary-lighter);
  color: var(--white);
  font-size: 0.65rem;
  font-weight: 700;
  width: 18px; height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ── Evidence Quick Note ── */
.evidence-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  align-items: stretch;
}
.evidence-input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  color: var(--text);
  resize: none;
  font-family: inherit;
}
.evidence-input:focus {
  outline: none;
  border-color: var(--primary-lighter);
  box-shadow: 0 0 0 3px rgba(52,152,219,0.12);
}
.evidence-btn {
  padding: 10px 18px;
  background: var(--accent);
  color: var(--white);
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: background var(--transition);
}
.evidence-btn:hover { background: var(--primary); }

/* ── Log ── */
.log-section {
  margin-top: 20px;
}
.log-section h3 {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--text-light);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.log-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.log-entry {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 14px;
  background: var(--white);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  transition: background var(--transition);
}
.log-entry:hover { background: var(--primary-wash); }
.log-time {
  font-weight: 700;
  color: var(--primary-lighter);
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
  min-width: 48px;
}
.log-cat-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 5px;
}
.log-content { flex: 1; }
.log-strategy { font-weight: 600; color: var(--text); }
.log-note {
  color: var(--text-light);
  font-style: italic;
  margin-top: 2px;
  font-size: 0.78rem;
}
.log-entry-note-input {
  width: 100%;
  padding: 5px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 0.78rem;
  font-family: inherit;
  margin-top: 4px;
  color: var(--text);
}
.log-entry-note-input:focus {
  outline: none;
  border-color: var(--primary-lighter);
}
.log-delete {
  background: none;
  border: none;
  color: var(--text-lighter);
  cursor: pointer;
  font-size: 0.85rem;
  padding: 2px 4px;
  opacity: 0;
  transition: opacity var(--transition), color var(--transition);
}
.log-entry:hover .log-delete { opacity: 1; }
.log-delete:hover { color: var(--danger); }
.log-evidence-tag {
  display: inline-block;
  background: #eaf2f8;
  color: var(--accent);
  font-size: 0.68rem;
  font-weight: 600;
  padding: 1px 6px;
  border-radius: 3px;
  margin-left: 6px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* ── Note Modal ── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal-box {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 24px;
  max-width: 460px;
  width: 100%;
  box-shadow: var(--shadow-lg);
}
.modal-box h3 {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 4px;
}
.modal-box .modal-sub {
  font-size: 0.78rem;
  color: var(--text-light);
  margin-bottom: 12px;
}
.modal-box textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-family: inherit;
  color: var(--text);
  resize: vertical;
  min-height: 80px;
}
.modal-box textarea:focus {
  outline: none;
  border-color: var(--primary-lighter);
  box-shadow: 0 0 0 3px rgba(52,152,219,0.12);
}
.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 12px;
}
.modal-actions button {
  padding: 8px 18px;
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all var(--transition);
}
.btn-cancel { background: var(--border-light); color: var(--text-light); }
.btn-cancel:hover { background: var(--border); }
.btn-save { background: var(--primary-lighter); color: var(--white); }
.btn-save:hover { background: var(--primary); }

/* ── Feedback Tab ── */
.feedback-section {
  background: var(--white);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: var(--shadow-sm);
}
.feedback-section h3 {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.feedback-section h3 .section-icon {
  width: 24px; height: 24px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  color: var(--white);
}
.strength-icon { background: var(--success); }
.ebi-icon { background: var(--warning); }
.takeaway-icon { background: var(--primary-lighter); }

.feedback-block {
  margin-bottom: 14px;
  padding: 14px;
  background: var(--bg);
  border-radius: var(--radius-sm);
  border-left: 3px solid transparent;
}
.feedback-block.strength-block { border-left-color: var(--success); }
.feedback-block.ebi-block { border-left-color: var(--warning); }
.feedback-block.takeaway-block { border-left-color: var(--primary-lighter); }

.feedback-block h4 {
  font-size: 0.82rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 6px;
}
.feedback-block textarea {
  width: 100%;
  min-height: 70px;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  font-family: inherit;
  color: var(--text);
  line-height: 1.55;
  resize: vertical;
  background: var(--white);
}
.feedback-block textarea:focus {
  outline: none;
  border-color: var(--primary-lighter);
  box-shadow: 0 0 0 3px rgba(52,152,219,0.12);
}
.cpd-suggestions {
  margin-top: 8px;
}
.cpd-suggestions h5 {
  font-size: 0.72rem;
  font-weight: 700;
  color: var(--text-lighter);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.cpd-suggestion {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  padding: 5px 0;
  font-size: 0.78rem;
  color: var(--text-light);
}
.cpd-suggestion::before {
  content: "\25B8";
  color: var(--primary-lighter);
  font-size: 0.7rem;
  margin-top: 1px;
}

.generate-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: var(--white);
  border: none;
  border-radius: var(--radius);
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  transition: all var(--transition);
  margin-bottom: 20px;
}
.generate-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
.generate-btn:active { transform: scale(0.99); }

.action-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 16px;
}
.action-btn {
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--white);
  color: var(--text);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}
.action-btn:hover { background: var(--primary-faint); border-color: var(--primary-lighter); color: var(--primary); }
.action-btn.primary-action {
  background: var(--primary-lighter);
  color: var(--white);
  border-color: var(--primary-lighter);
}
.action-btn.primary-action:hover { background: var(--primary); }

/* ── Dashboard ── */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
.dash-card {
  background: var(--white);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  padding: 20px;
  box-shadow: var(--shadow-sm);
}
.dash-card h3 {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 14px;
}
.dash-card canvas {
  width: 100% !important;
  max-height: 280px;
}

.coverage-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.coverage-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
}
.coverage-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.coverage-dot.strong { background: var(--success); }
.coverage-dot.moderate { background: var(--warning); }
.coverage-dot.weak { background: var(--danger); }
.coverage-label { font-size: 0.78rem; font-weight: 600; flex: 1; }
.coverage-level {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  padding: 2px 8px;
  border-radius: 10px;
}
.coverage-level.strong { background: var(--success-light); color: var(--success); }
.coverage-level.moderate { background: var(--warning-light); color: var(--warning); }
.coverage-level.weak { background: var(--danger-light); color: var(--danger); }

/* Timeline */
.timeline-container {
  position: relative;
  padding: 10px 0;
}
.timeline-track {
  position: relative;
  height: 36px;
  background: var(--bg);
  border-radius: 18px;
  margin-bottom: 6px;
  overflow: visible;
}
.timeline-track-label {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.68rem;
  font-weight: 700;
  color: var(--text-lighter);
  z-index: 2;
  pointer-events: none;
}
.timeline-dot {
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 2px solid var(--white);
  z-index: 3;
  cursor: pointer;
  transition: transform var(--transition);
}
.timeline-dot:hover { transform: translate(-50%, -50%) scale(1.3); }
.timeline-dot .timeline-tooltip {
  display: none;
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: var(--white);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.68rem;
  white-space: nowrap;
  z-index: 10;
}
.timeline-dot:hover .timeline-tooltip { display: block; }

.no-data-msg {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-lighter);
  font-size: 0.85rem;
}

/* ── Toasts ── */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--text);
  color: var(--white);
  padding: 10px 20px;
  border-radius: var(--radius);
  font-size: 0.82rem;
  font-weight: 500;
  z-index: 300;
  opacity: 0;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-lg);
}
.toast.visible {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* ── Print ── */
@media print {
  .app-header, .meta-bar, .tab-bar, .timer-bar, .action-bar,
  .generate-btn, .modal-overlay, .toast, .tab-panel:not(.print-target) { display: none !important; }
  .tab-panel.print-target { display: block !important; }
  body { background: white; }
  .main-content { padding: 0; max-width: 100%; }
  .feedback-section { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
  .feedback-block textarea { border: none; background: none; padding: 0; resize: none; }
  .dash-card { box-shadow: none; break-inside: avoid; }
  .print-header { display: block !important; margin-bottom: 20px; }
  .print-header h2 { font-size: 1.2rem; margin-bottom: 4px; }
  .print-header .print-meta { font-size: 0.8rem; color: #666; }
}
.print-header { display: none; }

/* ── Responsive ── */
@media (max-width: 768px) {
  .app-header { padding: 14px 16px 12px; }
  .app-header h1 { font-size: 1.1rem; }
  .meta-bar { padding: 10px 16px; }
  .meta-grid { grid-template-columns: 1fr 1fr; }
  .main-content { padding: 14px 16px 80px; }
  .tab-btn { padding: 10px 14px; font-size: 0.8rem; }
  .strategy-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
  .dashboard-grid { grid-template-columns: 1fr; }
  .coverage-grid { grid-template-columns: 1fr; }
  .timer-display { font-size: 1.6rem; min-width: 110px; }
}
@media (max-width: 480px) {
  .meta-grid { grid-template-columns: 1fr; }
  .strategy-grid { grid-template-columns: 1fr 1fr; }
  .evidence-bar { flex-direction: column; }
}
</style>
</head>
<body>

<!-- Header -->
<header class="app-header">
  <h1>Lesson Observation Feedback Builder</h1>
  <div class="subtitle">Structured observation tool for school leaders</div>
</header>

<!-- Lesson Meta -->
<div class="meta-bar">
  <div class="meta-grid">
    <input type="text" id="metaTeacher" placeholder="Teacher name">
    <input type="text" id="metaSubject" placeholder="Subject">
    <input type="text" id="metaClass" placeholder="Class / Year group">
    <input type="date" id="metaDate">
    <input type="text" id="metaObserver" placeholder="Observer name">
    <input type="text" id="metaRoom" placeholder="Room">
  </div>
</div>

<!-- Tabs -->
<nav class="tab-bar">
  <button class="tab-btn active" data-tab="observe" onclick="switchTab('observe')">During Observation <span class="badge" id="logCountBadge">0</span></button>
  <button class="tab-btn" data-tab="feedback" onclick="switchTab('feedback')">Feedback Generator</button>
  <button class="tab-btn" data-tab="dashboard" onclick="switchTab('dashboard')">Summary Dashboard</button>
</nav>

<!-- Main Content -->
<div class="main-content">

  <!-- ═══════ OBSERVE TAB ═══════ -->
  <div class="tab-panel active" id="tab-observe">

    <!-- Timer -->
    <div class="timer-bar">
      <div>
        <div class="timer-label">Elapsed Time</div>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
      </div>
      <button class="timer-btn start" id="timerStartBtn" onclick="toggleTimer()">Start</button>
      <button class="timer-btn reset" onclick="resetTimer()">Reset</button>
    </div>

    <!-- Evidence Quick Note -->
    <div class="evidence-bar">
      <textarea class="evidence-input" id="evidenceInput" rows="1" placeholder='Capture a verbatim quote or key evidence note (e.g. "T: Can anyone explain why the author used this metaphor?")'></textarea>
      <button class="evidence-btn" onclick="logEvidence()">+ Evidence</button>
    </div>

    <!-- Strategy Categories -->
    <div id="categoriesContainer"></div>

    <!-- Observation Log -->
    <div class="log-section">
      <h3>Observation Log (<span id="logCount">0</span> entries)</h3>
      <div class="log-list" id="logList">
        <div class="no-data-msg" id="logEmpty">Tap strategies above as you observe them. Entries will appear here with timestamps.</div>
      </div>
    </div>
  </div>

  <!-- ═══════ FEEDBACK TAB ═══════ -->
  <div class="tab-panel" id="tab-feedback">
    <div class="print-header">
      <h2>Lesson Observation Feedback</h2>
      <div class="print-meta" id="printMeta"></div>
    </div>

    <button class="generate-btn" onclick="generateFeedback()">
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v4m0 12v4m-7.07-3.93l2.83-2.83m8.48-8.48l2.83-2.83M2 12h4m12 0h4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83"/></svg>
      Generate Feedback from Observation Data
    </button>

    <div id="feedbackContent">
      <div class="no-data-msg">Click the button above to generate feedback from your observation log. You can also switch to the observation tab first to log more strategies.</div>
    </div>

    <div class="action-bar" id="feedbackActions" style="display:none">
      <button class="action-btn primary-action" onclick="copyFeedback()">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Copy to Clipboard
      </button>
      <button class="action-btn" onclick="printFeedback()">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Print Feedback
      </button>
    </div>
  </div>

  <!-- ═══════ DASHBOARD TAB ═══════ -->
  <div class="tab-panel" id="tab-dashboard">
    <div id="dashboardContent">
      <div class="no-data-msg">Start logging strategies during an observation to see your dashboard data here.</div>
    </div>
  </div>

</div>

<!-- Note Modal -->
<div class="modal-overlay" id="noteModal">
  <div class="modal-box">
    <h3 id="modalTitle">Add Note</h3>
    <div class="modal-sub" id="modalSub">Add context or detail for this observation.</div>
    <textarea id="modalNote" placeholder="e.g. Used cold calling effectively to check understanding of key vocabulary. 18/24 students responded correctly."></textarea>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeNoteModal(false)">Skip</button>
      <button class="btn-save" onclick="closeNoteModal(true)">Save Note</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════
// DATA MODEL
// ═══════════════════════════════════════

const CATEGORIES = {
  questioning: {
    label: 'Questioning',
    color: '#2980b9',
    icon: '?',
    strategies: ['Cold calling', 'Think-Pair-Share', 'Probing questions', 'Hinge questions', 'No-hands-up', 'Wait time used']
  },
  explanation: {
    label: 'Explanation',
    color: '#8e44ad',
    icon: 'E',
    strategies: ['Modelling', 'Worked examples', 'Analogies used', 'Dual coding', 'Chunking', 'Checking understanding']
  },
  assessment: {
    label: 'Assessment',
    color: '#27ae60',
    icon: 'A',
    strategies: ['Mini whiteboards', 'Exit tickets', 'MCQs', 'Peer assessment', 'Self assessment', 'Live marking']
  },
  behaviour: {
    label: 'Behaviour',
    color: '#e67e22',
    icon: 'B',
    strategies: ['Positive reinforcement', 'Narrating the positive', 'Least invasive intervention', 'Routines established', 'Transitions smooth']
  },
  differentiation: {
    label: 'Differentiation',
    color: '#e74c3c',
    icon: 'D',
    strategies: ['Scaffolding', 'Extension tasks', 'Support provided', 'Adaptive teaching', 'SEND provision visible']
  },
  engagement: {
    label: 'Engagement',
    color: '#16a085',
    icon: 'G',
    strategies: ['All students active', 'High participation ratio', 'Student talk quality', 'Independent practice', 'Collaborative learning']
  }
};

const CPD_SUGGESTIONS = {
  questioning: [
    'Read Chapter 12 "No Opt Out" and Chapter 13 "Cold Call" of Teach Like a Champion by Doug Lemov',
    'Watch Doug Lemov\'s Cold Calling video on teachlikeachampion.org',
    'Read Questioning section in Rosenshine\'s Principles in Action by Tom Sherrington',
    'Observe a colleague known for strong questioning technique',
    'Try planning 5 key questions before your next lesson using Bloom\'s taxonomy'
  ],
  explanation: [
    'Read Making Every Lesson Count, Chapter 2: Explanation by Shaun Allison & Andy Tharby',
    'Watch Oliver Caviglioli\'s Dual Coding videos on YouTube',
    'Read Chapter 3 of Rosenshine\'s Principles in Action on modelling',
    'Study the Worked Example Effect in cognitive load theory literature',
    'Plan a lesson with explicit "I do, We do, You do" structure'
  ],
  assessment: [
    'Read Embedding Formative Assessment by Dylan Wiliam, Chapter 4',
    'Watch Dylan Wiliam\'s "The Classroom Experiment" (BBC)',
    'Implement mini whiteboards as a daily formative assessment routine',
    'Read Daisy Christodoulou\'s Making Good Progress? for assessment design',
    'Create a bank of hinge questions for your most-taught topics'
  ],
  behaviour: {
    label: 'Behaviour',
    suggestions: [
      'Read Running the Room by Tom Bennett, Chapters 6-8',
      'Watch Bill Rogers\' "Classroom Behaviour Management" keynotes',
      'Read Chapter 7 "What to Do" in Teach Like a Champion by Doug Lemov',
      'Focus on scripting your positive narration phrases before lessons',
      'Observe a colleague with strong routines and transitions'
    ]
  },
  differentiation: [
    'Read Adaptive Teaching by the Education Endowment Foundation guidance report',
    'Study the EEF\'s SEND in Mainstream Schools guidance report',
    'Read Making Every Lesson Count, Chapter 6 on challenge for all',
    'Plan scaffolded resources with built-in "fade" so support reduces over time',
    'Explore the NASEN resources on Quality First Teaching for SEND'
  ],
  engagement: [
    'Read Engage the Brain by Allison Posey on UDL principles',
    'Study Barak Rosenshine\'s Principles, particularly on participation',
    'Read The Learning Rainforest by Tom Sherrington on participation ratio',
    'Implement a "Ratio" tracker: aim for 80%+ student talk/thinking time',
    'Watch Harry Fletcher-Wood\'s "Responsive Teaching" talks'
  ]
};

// Fix behaviour to match the same format
if (CPD_SUGGESTIONS.behaviour.suggestions) {
  CPD_SUGGESTIONS.behaviour = CPD_SUGGESTIONS.behaviour.suggestions;
}

let observationLog = [];
let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;
let pendingStrategy = null;

// ═══════════════════════════════════════
// INITIALIZATION
// ═══════════════════════════════════════

(function init() {
  document.getElementById('metaDate').value = new Date().toISOString().split('T')[0];
  buildCategories();
})();

function buildCategories() {
  const container = document.getElementById('categoriesContainer');
  let html = '';
  for (const [key, cat] of Object.entries(CATEGORIES)) {
    html += `
      <div class="category-section" id="cat-${key}">
        <div class="category-header" onclick="toggleCategory('${key}')">
          <div class="cat-icon" style="background:${cat.color}">${cat.icon}</div>
          <h3>${cat.label}</h3>
          <span class="cat-count" id="catCount-${key}">0</span>
          <span class="chevron">&#9660;</span>
        </div>
        <div class="strategy-grid">
          ${cat.strategies.map(s => {
            const id = strategyId(key, s);
            return `<button class="strategy-btn" id="btn-${id}" onclick="logStrategy('${key}','${s.replace(/'/g, "\\'")}')">
              ${s}
              <span class="tap-count" id="count-${id}" style="display:none">0</span>
            </button>`;
          }).join('')}
        </div>
      </div>`;
  }
  container.innerHTML = html;
}

function strategyId(cat, strategy) {
  return (cat + '-' + strategy).replace(/[^a-zA-Z0-9]/g, '_');
}

// ═══════════════════════════════════════
// TIMER
// ═══════════════════════════════════════

function toggleTimer() {
  const btn = document.getElementById('timerStartBtn');
  if (timerRunning) {
    clearInterval(timerInterval);
    timerRunning = false;
    btn.textContent = 'Resume';
    btn.classList.remove('pause');
    btn.classList.add('start');
  } else {
    timerInterval = setInterval(() => {
      timerSeconds++;
      updateTimerDisplay();
    }, 1000);
    timerRunning = true;
    btn.textContent = 'Pause';
    btn.classList.remove('start');
    btn.classList.add('pause');
  }
}

function resetTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
  timerSeconds = 0;
  updateTimerDisplay();
  const btn = document.getElementById('timerStartBtn');
  btn.textContent = 'Start';
  btn.classList.remove('pause');
  btn.classList.add('start');
}

function updateTimerDisplay() {
  const h = Math.floor(timerSeconds / 3600);
  const m = Math.floor((timerSeconds % 3600) / 60);
  const s = timerSeconds % 60;
  document.getElementById('timerDisplay').textContent =
    String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return m + ':' + String(s).padStart(2, '0');
}

// ═══════════════════════════════════════
// STRATEGY LOGGING
// ═══════════════════════════════════════

function logStrategy(category, strategy) {
  pendingStrategy = { category, strategy, time: timerSeconds, timestamp: new Date() };
  openNoteModal(strategy, CATEGORIES[category].label);
}

function openNoteModal(strategy, catLabel) {
  document.getElementById('modalTitle').textContent = strategy;
  document.getElementById('modalSub').textContent = `${catLabel} — logged at ${formatTime(pendingStrategy.time)}`;
  document.getElementById('modalNote').value = '';
  document.getElementById('noteModal').classList.add('active');
  setTimeout(() => document.getElementById('modalNote').focus(), 100);
}

function closeNoteModal(save) {
  const note = save ? document.getElementById('modalNote').value.trim() : '';
  document.getElementById('noteModal').classList.remove('active');

  if (pendingStrategy) {
    pendingStrategy.note = note;
    pendingStrategy.id = Date.now();
    observationLog.push(pendingStrategy);
    updateLogDisplay();
    updateCategoryCounts();
    pendingStrategy = null;
    showToast(`Logged: ${observationLog[observationLog.length - 1].strategy}`);
  }
}

// Close modal on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && document.getElementById('noteModal').classList.contains('active')) {
    closeNoteModal(false);
  }
  if (e.key === 'Enter' && e.ctrlKey && document.getElementById('noteModal').classList.contains('active')) {
    closeNoteModal(true);
  }
});

function logEvidence() {
  const input = document.getElementById('evidenceInput');
  const text = input.value.trim();
  if (!text) { showToast('Please enter evidence text first'); return; }

  observationLog.push({
    id: Date.now(),
    category: 'evidence',
    strategy: 'Verbatim / Evidence',
    note: text,
    time: timerSeconds,
    timestamp: new Date(),
    isEvidence: true
  });
  input.value = '';
  updateLogDisplay();
  showToast('Evidence note captured');
}

function deleteLogEntry(id) {
  observationLog = observationLog.filter(e => e.id !== id);
  updateLogDisplay();
  updateCategoryCounts();
}

function updateLogEntryNote(id, note) {
  const entry = observationLog.find(e => e.id === id);
  if (entry) entry.note = note;
}

function updateLogDisplay() {
  const list = document.getElementById('logList');
  const empty = document.getElementById('logEmpty');
  const count = observationLog.length;

  document.getElementById('logCount').textContent = count;
  document.getElementById('logCountBadge').textContent = count;

  if (count === 0) {
    list.innerHTML = '<div class="no-data-msg" id="logEmpty">Tap strategies above as you observe them. Entries will appear here with timestamps.</div>';
    return;
  }

  let html = '';
  const reversed = [...observationLog].reverse();
  for (const entry of reversed) {
    const catData = CATEGORIES[entry.category];
    const color = catData ? catData.color : '#7f8c8d';
    const evidenceTag = entry.isEvidence ? '<span class="log-evidence-tag">Evidence</span>' : '';

    html += `
      <div class="log-entry">
        <span class="log-time">${formatTime(entry.time)}</span>
        <span class="log-cat-dot" style="background:${color}"></span>
        <div class="log-content">
          <div class="log-strategy">${entry.strategy}${evidenceTag}</div>
          ${entry.note ? `<div class="log-note">${escapeHtml(entry.note)}</div>` : ''}
          <input class="log-entry-note-input" placeholder="Add/edit note..." value="${escapeHtml(entry.note || '')}" onchange="updateLogEntryNote(${entry.id}, this.value)">
        </div>
        <button class="log-delete" title="Remove" onclick="deleteLogEntry(${entry.id})">&#10005;</button>
      </div>`;
  }
  list.innerHTML = html;
}

function updateCategoryCounts() {
  for (const key of Object.keys(CATEGORIES)) {
    const catEntries = observationLog.filter(e => e.category === key);
    document.getElementById('catCount-' + key).textContent = catEntries.length;

    // Update per-strategy counts
    for (const s of CATEGORIES[key].strategies) {
      const id = strategyId(key, s);
      const c = catEntries.filter(e => e.strategy === s).length;
      const badge = document.getElementById('count-' + id);
      if (c > 0) {
        badge.style.display = 'flex';
        badge.textContent = c;
      } else {
        badge.style.display = 'none';
      }
    }
  }
}

function toggleCategory(key) {
  document.getElementById('cat-' + key).classList.toggle('collapsed');
}

// ═══════════════════════════════════════
// TABS
// ═══════════════════════════════════════

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');

  if (tab === 'dashboard') renderDashboard();
}

// ═══════════════════════════════════════
// FEEDBACK GENERATOR
// ═══════════════════════════════════════

function generateFeedback() {
  const content = document.getElementById('feedbackContent');
  const actions = document.getElementById('feedbackActions');

  if (observationLog.length === 0) {
    content.innerHTML = '<div class="no-data-msg">No observations logged yet. Switch to the During Observation tab and log some strategies first.</div>';
    actions.style.display = 'none';
    return;
  }

  // Analyse by category
  const catStats = {};
  for (const key of Object.keys(CATEGORIES)) {
    const entries = observationLog.filter(e => e.category === key);
    catStats[key] = {
      count: entries.length,
      entries: entries,
      strategies: [...new Set(entries.map(e => e.strategy))]
    };
  }

  // Sort by count descending for strengths
  const sorted = Object.entries(catStats).sort((a, b) => b[1].count - a[1].count);
  const strong = sorted.filter(([, v]) => v.count >= 3);
  const moderate = sorted.filter(([, v]) => v.count >= 1 && v.count < 3);
  const weak = sorted.filter(([, v]) => v.count === 0);

  // Build strengths
  let strengthsHtml = '';
  const strengthCats = [...strong, ...moderate.slice(0, Math.max(0, 2 - strong.length))];
  if (strengthCats.length === 0 && moderate.length > 0) {
    strengthCats.push(moderate[0]);
  }

  for (const [key, stats] of strengthCats) {
    const cat = CATEGORIES[key];
    const entriesWithNotes = stats.entries.filter(e => e.note);
    const times = stats.entries.map(e => formatTime(e.time)).join(', ');
    const stratList = stats.strategies.join(', ');

    let text = `${cat.label} was a strength of this lesson. `;
    text += `You used ${stratList} (observed at ${times}). `;

    if (stats.count >= 3) {
      text += `This category was well-represented with ${stats.count} logged instances, demonstrating consistent and effective practice. `;
    } else {
      text += `This was evident in your practice during the lesson. `;
    }

    if (entriesWithNotes.length > 0) {
      text += entriesWithNotes[0].note ? `In particular: "${entriesWithNotes[0].note}" ` : '';
    }

    text += `\n\nConsider how you might share this practice with colleagues as part of your professional development contribution.`;

    strengthsHtml += `
      <div class="feedback-block strength-block">
        <h4>${cat.label}</h4>
        <textarea rows="5">${text.trim()}</textarea>
      </div>`;
  }

  if (strengthsHtml === '') {
    strengthsHtml = '<div class="feedback-block strength-block"><h4>General</h4><textarea rows="3">Limited strategy evidence was logged during this observation. Consider discussing with the observer what was observed informally.</textarea></div>';
  }

  // Build EBIs
  let ebiHtml = '';
  const ebiCats = [...weak, ...moderate.filter(([k]) => !strengthCats.some(([sk]) => sk === k))];

  for (const [key, stats] of ebiCats) {
    const cat = CATEGORIES[key];
    const cpd = Array.isArray(CPD_SUGGESTIONS[key]) ? CPD_SUGGESTIONS[key] : [];

    let text = '';
    if (stats.count === 0) {
      text = `There was limited evidence of ${cat.label.toLowerCase()} strategies during this observation. `;
      text += `To develop this area, consider incorporating techniques such as ${cat.strategies.slice(0, 3).join(', ')}. `;
      text += `\n\nAs a next step, plan one ${cat.label.toLowerCase()} strategy into your next lesson and reflect on its impact on student learning.`;
    } else {
      text = `${cat.label} was observed (${stats.strategies.join(', ')}) but could be developed further. `;
      text += `Consider broadening your repertoire to include ${cat.strategies.filter(s => !stats.strategies.includes(s)).slice(0, 2).join(' and ')}. `;
      text += `\n\nAs a next step, try using at least two different ${cat.label.toLowerCase()} strategies in your next observed lesson.`;
    }

    let cpdHtml = '';
    if (cpd.length > 0) {
      cpdHtml = `<div class="cpd-suggestions"><h5>Linked CPD</h5>${cpd.slice(0, 3).map(s => `<div class="cpd-suggestion">${s}</div>`).join('')}</div>`;
    }

    ebiHtml += `
      <div class="feedback-block ebi-block">
        <h4>${cat.label}</h4>
        <textarea rows="4">${text.trim()}</textarea>
        ${cpdHtml}
      </div>`;
  }

  if (ebiHtml === '') {
    ebiHtml = '<div class="feedback-block ebi-block"><h4>Excellent coverage</h4><textarea rows="3">All six categories showed evidence during this observation. For further development, consider deepening your practice in any one area and mentoring colleagues.</textarea></div>';
  }

  // Key takeaway
  let takeaway = '';
  if (weak.length > 0) {
    const topEbi = weak[0];
    const cat = CATEGORIES[topEbi[0]];
    takeaway = `The single most impactful development point from this observation is ${cat.label.toLowerCase()}. No ${cat.label.toLowerCase()} strategies were observed during the lesson. Prioritise embedding one key ${cat.label.toLowerCase()} technique (e.g. ${cat.strategies[0]}) into every lesson over the next two weeks, then review the impact with your line manager.`;
  } else if (moderate.length > 0) {
    const topMod = moderate[moderate.length - 1];
    const cat = CATEGORIES[topMod[0]];
    takeaway = `The area with the most room for growth is ${cat.label.toLowerCase()}. While there was some evidence, this could be strengthened significantly. Focus on developing your ${cat.label.toLowerCase()} practice by trying ${cat.strategies.filter(s => !topMod[1].strategies.includes(s)).slice(0, 2).join(' and ')} in upcoming lessons.`;
  } else {
    takeaway = 'This was a well-rounded lesson with evidence across all observation categories. Consider choosing one area to take to expert level and sharing your practice with colleagues through a coaching or mentoring conversation.';
  }

  // Evidence notes
  const evidenceEntries = observationLog.filter(e => e.isEvidence);
  let evidenceHtml = '';
  if (evidenceEntries.length > 0) {
    evidenceHtml = `
      <div class="feedback-section">
        <h3><span class="section-icon" style="background:#7f8c8d">&#8221;</span> Evidence Notes</h3>
        ${evidenceEntries.map(e => `<div class="feedback-block" style="border-left-color:#7f8c8d"><p style="font-size:0.82rem;font-style:italic;color:var(--text)">"${escapeHtml(e.note)}" <span style="color:var(--text-lighter);font-style:normal">- at ${formatTime(e.time)}</span></p></div>`).join('')}
      </div>`;
  }

  content.innerHTML = `
    <div class="feedback-section">
      <h3><span class="section-icon strength-icon">&#10003;</span> Strengths</h3>
      ${strengthsHtml}
    </div>
    <div class="feedback-section">
      <h3><span class="section-icon ebi-icon">&#9650;</span> Even Better If (EBI)</h3>
      ${ebiHtml}
    </div>
    <div class="feedback-section">
      <h3><span class="section-icon takeaway-icon">&#9733;</span> Key Takeaway</h3>
      <div class="feedback-block takeaway-block">
        <textarea rows="4">${takeaway}</textarea>
      </div>
    </div>
    ${evidenceHtml}
  `;

  actions.style.display = 'flex';
  showToast('Feedback generated successfully');
}

// ═══════════════════════════════════════
// COPY & PRINT
// ═══════════════════════════════════════

function getMetaString() {
  const t = document.getElementById('metaTeacher').value;
  const s = document.getElementById('metaSubject').value;
  const c = document.getElementById('metaClass').value;
  const d = document.getElementById('metaDate').value;
  const o = document.getElementById('metaObserver').value;
  const parts = [];
  if (t) parts.push('Teacher: ' + t);
  if (s) parts.push('Subject: ' + s);
  if (c) parts.push('Class: ' + c);
  if (d) parts.push('Date: ' + d);
  if (o) parts.push('Observer: ' + o);
  return parts.join(' | ');
}

function copyFeedback() {
  const sections = document.querySelectorAll('#feedbackContent .feedback-section');
  let text = 'LESSON OBSERVATION FEEDBACK\n';
  text += '='.repeat(40) + '\n';
  const meta = getMetaString();
  if (meta) text += meta + '\n';
  text += '='.repeat(40) + '\n\n';

  sections.forEach(section => {
    const heading = section.querySelector('h3');
    if (heading) text += heading.textContent.trim().toUpperCase() + '\n' + '-'.repeat(30) + '\n';

    const blocks = section.querySelectorAll('.feedback-block');
    blocks.forEach(block => {
      const h4 = block.querySelector('h4');
      if (h4) text += '\n' + h4.textContent + ':\n';
      const ta = block.querySelector('textarea');
      if (ta) text += ta.value + '\n';
      const p = block.querySelector('p');
      if (p) text += p.textContent + '\n';

      const cpds = block.querySelectorAll('.cpd-suggestion');
      if (cpds.length > 0) {
        text += '\nLinked CPD:\n';
        cpds.forEach(c => { text += '  - ' + c.textContent.trim() + '\n'; });
      }
      text += '\n';
    });
    text += '\n';
  });

  navigator.clipboard.writeText(text.trim()).then(() => {
    showToast('Feedback copied to clipboard');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text.trim();
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Feedback copied to clipboard');
  });
}

function printFeedback() {
  document.getElementById('printMeta').textContent = getMetaString();
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('print-target'));
  document.getElementById('tab-feedback').classList.add('print-target');
  window.print();
}

// ═══════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════

function renderDashboard() {
  const container = document.getElementById('dashboardContent');

  if (observationLog.filter(e => !e.isEvidence).length === 0) {
    container.innerHTML = '<div class="no-data-msg">Start logging strategies during an observation to see your dashboard data here.</div>';
    return;
  }

  const catStats = {};
  for (const key of Object.keys(CATEGORIES)) {
    catStats[key] = observationLog.filter(e => e.category === key).length;
  }

  container.innerHTML = `
    <div class="dashboard-grid">
      <div class="dash-card">
        <h3>Strategy Distribution</h3>
        <canvas id="pieChart"></canvas>
      </div>
      <div class="dash-card">
        <h3>Lesson Profile</h3>
        <canvas id="radarChart"></canvas>
      </div>
    </div>
    <div class="dashboard-grid">
      <div class="dash-card">
        <h3>Observation Timeline</h3>
        <div id="timelineContainer"></div>
      </div>
      <div class="dash-card">
        <h3>Coverage Indicator</h3>
        <div class="coverage-grid" id="coverageGrid"></div>
      </div>
    </div>
  `;

  setTimeout(() => {
    drawPieChart(catStats);
    drawRadarChart(catStats);
    drawTimeline();
    drawCoverage(catStats);
  }, 50);
}

// ── Pie Chart (pure canvas) ──
function drawPieChart(stats) {
  const canvas = document.getElementById('pieChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  const size = Math.min(rect.width - 40, 260);
  canvas.width = (size + 140) * dpr;
  canvas.height = size * dpr;
  canvas.style.width = (size + 140) + 'px';
  canvas.style.height = size + 'px';
  ctx.scale(dpr, dpr);

  const total = Object.values(stats).reduce((a, b) => a + b, 0);
  if (total === 0) return;

  const cx = size / 2;
  const cy = size / 2;
  const r = size / 2 - 10;
  let startAngle = -Math.PI / 2;

  const entries = Object.entries(CATEGORIES);
  const legendX = size + 20;
  let legendY = 20;

  for (const [key, cat] of entries) {
    const val = stats[key] || 0;
    if (val === 0) continue;
    const slice = (val / total) * 2 * Math.PI;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, startAngle, startAngle + slice);
    ctx.closePath();
    ctx.fillStyle = cat.color;
    ctx.fill();

    // Label
    if (slice > 0.25) {
      const mid = startAngle + slice / 2;
      const lx = cx + (r * 0.6) * Math.cos(mid);
      const ly = cy + (r * 0.6) * Math.sin(mid);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 11px -apple-system, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(val, lx, ly);
    }

    startAngle += slice;
  }

  // Hollow center
  ctx.beginPath();
  ctx.arc(cx, cy, r * 0.45, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  // Center text
  ctx.fillStyle = '#2c3e50';
  ctx.font = 'bold 20px -apple-system, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(total, cx, cy - 6);
  ctx.font = '10px -apple-system, sans-serif';
  ctx.fillStyle = '#85929e';
  ctx.fillText('total', cx, cy + 10);

  // Legend
  for (const [key, cat] of entries) {
    const val = stats[key] || 0;
    ctx.fillStyle = cat.color;
    ctx.fillRect(legendX, legendY, 10, 10);
    ctx.fillStyle = '#2c3e50';
    ctx.font = '11px -apple-system, sans-serif';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.fillText(`${cat.label} (${val})`, legendX + 16, legendY);
    legendY += 22;
  }
}

// ── Radar Chart (pure canvas) ──
function drawRadarChart(stats) {
  const canvas = document.getElementById('radarChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  const size = Math.min(rect.width - 40, 280);
  canvas.width = size * dpr;
  canvas.height = size * dpr;
  canvas.style.width = size + 'px';
  canvas.style.height = size + 'px';
  ctx.scale(dpr, dpr);

  const cx = size / 2;
  const cy = size / 2;
  const r = size / 2 - 40;
  const keys = Object.keys(CATEGORIES);
  const n = keys.length;
  const maxVal = Math.max(5, ...Object.values(stats));

  const angleStep = (2 * Math.PI) / n;
  const startAngle = -Math.PI / 2;

  // Grid rings
  for (let ring = 1; ring <= 5; ring++) {
    const rr = (ring / 5) * r;
    ctx.beginPath();
    for (let i = 0; i <= n; i++) {
      const a = startAngle + i * angleStep;
      const x = cx + rr * Math.cos(a);
      const y = cy + rr * Math.sin(a);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.strokeStyle = '#e8e8e8';
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // Axis lines and labels
  for (let i = 0; i < n; i++) {
    const a = startAngle + i * angleStep;
    const x = cx + r * Math.cos(a);
    const y = cy + r * Math.sin(a);
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(x, y);
    ctx.strokeStyle = '#e8e8e8';
    ctx.lineWidth = 1;
    ctx.stroke();

    // Label
    const lx = cx + (r + 22) * Math.cos(a);
    const ly = cy + (r + 22) * Math.sin(a);
    ctx.fillStyle = '#5d6d7e';
    ctx.font = '10px -apple-system, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(CATEGORIES[keys[i]].label, lx, ly);
  }

  // Data polygon
  ctx.beginPath();
  for (let i = 0; i < n; i++) {
    const a = startAngle + i * angleStep;
    const val = Math.min(stats[keys[i]] || 0, maxVal);
    const rr = (val / maxVal) * r;
    const x = cx + rr * Math.cos(a);
    const y = cy + rr * Math.sin(a);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.closePath();
  ctx.fillStyle = 'rgba(41,128,185,0.2)';
  ctx.fill();
  ctx.strokeStyle = 'rgba(41,128,185,0.8)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Data points
  for (let i = 0; i < n; i++) {
    const a = startAngle + i * angleStep;
    const val = Math.min(stats[keys[i]] || 0, maxVal);
    const rr = (val / maxVal) * r;
    const x = cx + rr * Math.cos(a);
    const y = cy + rr * Math.sin(a);
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fillStyle = CATEGORIES[keys[i]].color;
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
  }
}

// ── Timeline ──
function drawTimeline() {
  const container = document.getElementById('timelineContainer');
  if (!container) return;

  const nonEvidence = observationLog.filter(e => !e.isEvidence);
  if (nonEvidence.length === 0) {
    container.innerHTML = '<div class="no-data-msg" style="padding:20px 0">No strategy data to display</div>';
    return;
  }

  const maxTime = Math.max(...nonEvidence.map(e => e.time), 60);

  let html = '<div class="timeline-container">';
  for (const [key, cat] of Object.entries(CATEGORIES)) {
    const entries = nonEvidence.filter(e => e.category === key);
    html += `<div class="timeline-track">
      <div class="timeline-track-label">${cat.label}</div>`;
    for (const entry of entries) {
      const pct = Math.max(12, Math.min(95, (entry.time / maxTime) * 100));
      html += `<div class="timeline-dot" style="left:${pct}%;background:${cat.color}">
        <div class="timeline-tooltip">${entry.strategy} (${formatTime(entry.time)})</div>
      </div>`;
    }
    html += '</div>';
  }

  // Time axis
  html += '<div style="display:flex;justify-content:space-between;padding:4px 10px;font-size:0.68rem;color:#85929e">';
  html += '<span>0:00</span>';
  const mid = Math.round(maxTime / 2);
  html += `<span>${formatTime(mid)}</span>`;
  html += `<span>${formatTime(maxTime)}</span>`;
  html += '</div></div>';

  container.innerHTML = html;
}

// ── Coverage ──
function drawCoverage(stats) {
  const grid = document.getElementById('coverageGrid');
  if (!grid) return;

  let html = '';
  for (const [key, cat] of Object.entries(CATEGORIES)) {
    const count = stats[key] || 0;
    let level, cls;
    if (count >= 3) { level = 'Strong'; cls = 'strong'; }
    else if (count >= 1) { level = 'Moderate'; cls = 'moderate'; }
    else { level = 'Weak'; cls = 'weak'; }

    html += `
      <div class="coverage-item">
        <div class="coverage-dot ${cls}"></div>
        <span class="coverage-label">${cat.label}</span>
        <span class="coverage-level ${cls}">${level} (${count})</span>
      </div>`;
  }
  grid.innerHTML = html;
}

// ═══════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('visible');
  setTimeout(() => t.classList.remove('visible'), 2200);
}
</script>
</body>
</html>
