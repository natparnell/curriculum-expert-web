<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Propaganda Techniques Decoder</title>
<style>
:root {
  --bg-primary: #faf6f0;
  --bg-secondary: #f0e8da;
  --bg-card: #ffffff;
  --bg-header: #5c3d2e;
  --bg-header-accent: #7a5240;
  --text-primary: #3b2a1d;
  --text-secondary: #6b5344;
  --text-light: #f5efe7;
  --border-colour: #d4c4a8;
  --border-dark: #b8a48c;
  --accent-amber: #c77d28;
  --accent-amber-light: #e8a84c;
  --accent-gold: #d4a234;
  --shadow-sm: 0 1px 3px rgba(59,42,29,0.12);
  --shadow-md: 0 4px 12px rgba(59,42,29,0.15);
  --shadow-lg: 0 8px 24px rgba(59,42,29,0.18);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --tech-bandwagon: #e07b39;
  --tech-scapegoating: #c0392b;
  --tech-emotional: #8e44ad;
  --tech-repetition: #2980b9;
  --tech-loaded: #d4a234;
  --tech-authority: #27ae60;
  --tech-cardstack: #16a085;
  --tech-plainfolks: #7f8c8d;
  --tech-bandwagon-bg: rgba(224,123,57,0.18);
  --tech-scapegoating-bg: rgba(192,57,43,0.18);
  --tech-emotional-bg: rgba(142,68,173,0.18);
  --tech-repetition-bg: rgba(41,128,185,0.18);
  --tech-loaded-bg: rgba(212,162,52,0.18);
  --tech-authority-bg: rgba(39,174,96,0.18);
  --tech-cardstack-bg: rgba(22,160,133,0.18);
  --tech-plainfolks-bg: rgba(127,140,141,0.18);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Georgia', 'Times New Roman', serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(135deg, var(--bg-header) 0%, var(--bg-header-accent) 100%);
  color: var(--text-light);
  padding: 16px 24px;
  box-shadow: var(--shadow-lg);
}

header h1 {
  font-size: 1.6rem;
  font-weight: 700;
  letter-spacing: 0.5px;
}

header p {
  font-size: 0.88rem;
  opacity: 0.85;
  margin-top: 2px;
  font-style: italic;
}

.app-container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 20px;
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 20px;
}

.main-area { display: flex; flex-direction: column; gap: 16px; }

/* Passage selector */
.passage-selector {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  padding: 12px 16px;
  background: var(--bg-card);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-colour);
  box-shadow: var(--shadow-sm);
}

.passage-btn {
  font-family: inherit;
  font-size: 0.82rem;
  padding: 8px 14px;
  border: 2px solid var(--border-colour);
  background: var(--bg-secondary);
  color: var(--text-primary);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
}

.passage-btn:hover { border-color: var(--accent-amber); background: #fdf3e3; }
.passage-btn.active {
  border-color: var(--accent-amber);
  background: var(--accent-amber);
  color: white;
}

/* Technique toolbar */
.toolbar {
  background: var(--bg-card);
  border: 1px solid var(--border-colour);
  border-radius: var(--radius-md);
  padding: 12px 16px;
  box-shadow: var(--shadow-sm);
}

.toolbar h3 {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.toolbar-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}

.tech-btn {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 0.72rem;
  padding: 8px 6px;
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  cursor: pointer;
  text-align: centre;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  font-weight: 600;
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.tech-btn .icon { font-size: 1.1rem; }
.tech-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.tech-btn.active { color: white; transform: translateY(-1px); box-shadow: var(--shadow-md); }
.tech-btn[data-tech="bandwagon"].active { background: var(--tech-bandwagon); border-color: var(--tech-bandwagon); }
.tech-btn[data-tech="scapegoating"].active { background: var(--tech-scapegoating); border-color: var(--tech-scapegoating); }
.tech-btn[data-tech="emotional"].active { background: var(--tech-emotional); border-color: var(--tech-emotional); }
.tech-btn[data-tech="repetition"].active { background: var(--tech-repetition); border-color: var(--tech-repetition); }
.tech-btn[data-tech="loaded"].active { background: var(--tech-loaded); border-color: var(--tech-loaded); }
.tech-btn[data-tech="authority"].active { background: var(--tech-authority); border-color: var(--tech-authority); }
.tech-btn[data-tech="cardstack"].active { background: var(--tech-cardstack); border-color: var(--tech-cardstack); }
.tech-btn[data-tech="plainfolks"].active { background: var(--tech-plainfolks); border-color: var(--tech-plainfolks); }

.toolbar-hint {
  font-size: 0.78rem;
  color: var(--text-secondary);
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--border-colour);
  text-align: center;
  font-style: italic;
}

/* Text passage display */
.passage-panel {
  background: var(--bg-card);
  border: 1px solid var(--border-colour);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.passage-header {
  background: var(--bg-secondary);
  padding: 14px 20px;
  border-bottom: 1px solid var(--border-colour);
}

.passage-header h2 { font-size: 1.1rem; color: var(--text-primary); }
.passage-header .meta {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-top: 2px;
  font-style: italic;
}

.passage-body {
  padding: 20px;
  font-size: 1.05rem;
  line-height: 1.85;
  cursor: text;
  min-height: 200px;
  user-select: text;
}

.passage-body .annotated {
  padding: 1px 3px;
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  transition: opacity 0.2s;
}

.passage-body .annotated:hover { opacity: 0.8; }
.annotated.bandwagon { background: var(--tech-bandwagon-bg); border-bottom: 2px solid var(--tech-bandwagon); }
.annotated.scapegoating { background: var(--tech-scapegoating-bg); border-bottom: 2px solid var(--tech-scapegoating); }
.annotated.emotional { background: var(--tech-emotional-bg); border-bottom: 2px solid var(--tech-emotional); }
.annotated.repetition { background: var(--tech-repetition-bg); border-bottom: 2px solid var(--tech-repetition); }
.annotated.loaded { background: var(--tech-loaded-bg); border-bottom: 2px solid var(--tech-loaded); }
.annotated.authority { background: var(--tech-authority-bg); border-bottom: 2px solid var(--tech-authority); }
.annotated.cardstack { background: var(--tech-cardstack-bg); border-bottom: 2px solid var(--tech-cardstack); }
.annotated.plainfolks { background: var(--tech-plainfolks-bg); border-bottom: 2px solid var(--tech-plainfolks); }

.annotated .tech-label {
  font-size: 0.6rem;
  font-family: 'Segoe UI', Arial, sans-serif;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1px 5px;
  border-radius: 3px;
  color: white;
  vertical-align: super;
  margin-left: 2px;
}

.tech-label.bandwagon { background: var(--tech-bandwagon); }
.tech-label.scapegoating { background: var(--tech-scapegoating); }
.tech-label.emotional { background: var(--tech-emotional); }
.tech-label.repetition { background: var(--tech-repetition); }
.tech-label.loaded { background: var(--tech-loaded); }
.tech-label.authority { background: var(--tech-authority); }
.tech-label.cardstack { background: var(--tech-cardstack); }
.tech-label.plainfolks { background: var(--tech-plainfolks); }

/* Action buttons */
.actions-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.action-btn {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  padding: 10px 18px;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
}

.action-btn.primary {
  background: var(--accent-amber);
  color: white;
}

.action-btn.primary:hover { background: #b06d1e; }

.action-btn.secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-colour);
}

.action-btn.secondary:hover { background: #e6d9c4; }

/* Sidebar */
.sidebar { display: flex; flex-direction: column; gap: 16px; }

/* Chart panel */
.chart-panel {
  background: var(--bg-card);
  border: 1px solid var(--border-colour);
  border-radius: var(--radius-md);
  padding: 16px;
  box-shadow: var(--shadow-sm);
}

.chart-panel h3 {
  font-size: 0.9rem;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.chart-panel canvas { width: 100%; }

/* Score panel */
.score-panel {
  background: var(--bg-card);
  border: 1px solid var(--border-colour);
  border-radius: var(--radius-md);
  padding: 16px;
  box-shadow: var(--shadow-sm);
  display: none;
}

.score-panel.visible { display: block; }

.score-panel h3 { font-size: 0.9rem; margin-bottom: 10px; }

.score-value {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--accent-amber);
  text-align: center;
  margin: 8px 0;
}

.score-detail {
  font-size: 0.82rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

.score-detail li { margin-bottom: 4px; list-style: none; padding-left: 1.2em; text-indent: -1.2em; }

/* Annotations list */
.annotations-list {
  background: var(--bg-card);
  border: 1px solid var(--border-colour);
  border-radius: var(--radius-md);
  padding: 16px;
  box-shadow: var(--shadow-sm);
}

.annotations-list h3 { font-size: 0.9rem; margin-bottom: 10px; }

.annotation-item {
  padding: 8px 10px;
  border-radius: var(--radius-sm);
  margin-bottom: 6px;
  font-size: 0.8rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.annotation-item .text-preview {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-style: italic;
}

.annotation-item .remove-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  opacity: 0.5;
  transition: opacity 0.2s;
  flex-shrink: 0;
}

.annotation-item .remove-btn:hover { opacity: 1; }

.no-annotations {
  font-size: 0.82rem;
  color: var(--text-secondary);
  font-style: italic;
  text-align: center;
  padding: 12px;
}

/* Info panel */
.info-panel {
  background: var(--bg-card);
  border: 1px solid var(--border-colour);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.info-toggle {
  width: 100%;
  padding: 14px 16px;
  background: var(--bg-secondary);
  border: none;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.info-toggle .arrow { transition: transform 0.3s; }
.info-toggle.open .arrow { transform: rotate(180deg); }

.info-content {
  display: none;
  padding: 16px;
  font-size: 0.85rem;
  line-height: 1.7;
}

.info-content.open { display: block; }

.info-content h4 {
  font-size: 0.9rem;
  color: var(--accent-amber);
  margin: 14px 0 6px;
}

.info-content h4:first-child { margin-top: 0; }

.info-content p { margin-bottom: 8px; color: var(--text-secondary); }

.info-content .tech-def {
  padding: 8px 12px;
  border-left: 3px solid var(--border-dark);
  margin: 8px 0;
  background: var(--bg-secondary);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
}

.info-content .tech-def strong { color: var(--text-primary); }

/* Toast notification */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--bg-header);
  color: var(--text-light);
  padding: 12px 24px;
  border-radius: var(--radius-md);
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 0.85rem;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  transition: all 0.35s ease;
  z-index: 200;
  pointer-events: none;
}

.toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Responsive */
@media (max-width: 768px) {
  header { padding: 12px 16px; }
  header h1 { font-size: 1.25rem; }
  .app-container {
    grid-template-columns: 1fr;
    padding: 12px;
    gap: 14px;
  }
  .toolbar-grid { grid-template-columns: repeat(2, 1fr); }
  .passage-body { font-size: 0.95rem; padding: 14px; }
  .sidebar { order: 1; }
  .main-area { order: 0; }
}
</style>
</head>
<body>

<header>
  <h1>Propaganda Techniques Decoder</h1>
  <p>Analyse historical propaganda texts by identifying persuasion techniques</p>
</header>

<div class="app-container">
  <div class="main-area">
    <div class="passage-selector" id="passageSelector"></div>

    <div class="toolbar">
      <h3>Technique Toolbar</h3>
      <div class="toolbar-grid" id="toolbarGrid"></div>
      <div class="toolbar-hint" id="toolbarHint">Select a technique, then highlight text in the passage below</div>
    </div>

    <div class="passage-panel">
      <div class="passage-header">
        <h2 id="passageTitle">Select a passage above to begin</h2>
        <div class="meta" id="passageMeta"></div>
      </div>
      <div class="passage-body" id="passageBody">
        <p style="color:var(--text-secondary); font-style:italic; text-align:center; padding:40px 0;">
          Choose a historical propaganda text from the buttons above to start analysing.
        </p>
      </div>
    </div>

    <div class="actions-bar">
      <button class="action-btn primary" onclick="checkAnswers()">Check My Answers</button>
      <button class="action-btn secondary" onclick="showModelAnswers()">Show Model Answers</button>
      <button class="action-btn secondary" onclick="clearAnnotations()">Clear All</button>
    </div>
  </div>

  <div class="sidebar">
    <div class="chart-panel">
      <h3>Technique Frequency</h3>
      <canvas id="chartCanvas" width="288" height="260"></canvas>
    </div>

    <div class="score-panel" id="scorePanel">
      <h3>Your Score</h3>
      <div class="score-value" id="scoreValue">--</div>
      <ul class="score-detail" id="scoreDetail"></ul>
    </div>

    <div class="annotations-list">
      <h3>Your Annotations</h3>
      <div id="annotationsList">
        <div class="no-annotations">No annotations yet</div>
      </div>
    </div>

    <div class="info-panel">
      <button class="info-toggle" id="infoToggle" onclick="toggleInfo()">
        <span>Technique Reference Guide</span>
        <span class="arrow">&#9660;</span>
      </button>
      <div class="info-content" id="infoContent">
        <h4>Why Does Propaganda Work?</h4>
        <p>Propaganda exploits cognitive biases: our tendency to follow the crowd, trust authority figures, and react emotionally rather than rationally. Recognising these techniques is the first step towards critical media literacy.</p>

        <h4>The Eight Techniques</h4>

        <div class="tech-def">
          <strong>Bandwagon:</strong> Encourages people to join in because "everyone else is doing it." Creates social pressure and fear of being left out.
          <br><em>Example: "Millions of patriots have already enlisted. Will you be left behind?"</em>
        </div>

        <div class="tech-def">
          <strong>Scapegoating:</strong> Blaming a specific group for society's problems to redirect anger and unite people against a common enemy.
          <br><em>Example: "Foreign agitators are the cause of all our hardship."</em>
        </div>

        <div class="tech-def">
          <strong>Emotional Appeal:</strong> Using feelings (fear, pride, guilt, love) rather than logic to persuade. Bypasses rational thought.
          <br><em>Example: "Think of your children's future; think of their safety."</em>
        </div>

        <div class="tech-def">
          <strong>Repetition:</strong> Repeating key words or phrases to make them memorable and seemingly true. Familiarity breeds acceptance.
          <br><em>Example: Slogans repeated across posters, speeches, and broadcasts.</em>
        </div>

        <div class="tech-def">
          <strong>Loaded Language:</strong> Words deliberately chosen for their strong emotional connotations rather than their literal meaning.
          <br><em>Example: "Glorious sacrifice" instead of "death in battle."</em>
        </div>

        <div class="tech-def">
          <strong>Appeal to Authority:</strong> Citing respected figures, experts, or institutions to lend credibility to a claim.
          <br><em>Example: "The King himself has called upon every man to serve."</em>
        </div>

        <div class="tech-def">
          <strong>Card Stacking:</strong> Presenting only the facts that support one side whilst omitting opposing evidence. A selective truth.
          <br><em>Example: Reporting only victories and never defeats.</em>
        </div>

        <div class="tech-def">
          <strong>Plain Folks:</strong> Presenting leaders or ideas as being of ordinary, common people to build trust and relatability.
          <br><em>Example: "I am but a simple citizen, just like you, asking for fairness."</em>
        </div>

        <h4>Media Literacy Today</h4>
        <p>These techniques remain in use across modern media: advertising, political campaigns, and social media. By learning to decode historical propaganda, students develop transferable skills for evaluating claims in their daily lives. Always ask: who created this message, what techniques are being used, and what has been left out?</p>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const TECHNIQUES = [
  { id: 'bandwagon',    label: 'Bandwagon',         icon: '\uD83D\uDC65' },
  { id: 'scapegoating', label: 'Scapegoating',      icon: '\uD83D\uDC49' },
  { id: 'emotional',    label: 'Emotional Appeal',   icon: '\u2764\uFE0F' },
  { id: 'repetition',   label: 'Repetition',         icon: '\uD83D\uDD01' },
  { id: 'loaded',       label: 'Loaded Language',     icon: '\uD83D\uDCA3' },
  { id: 'authority',    label: 'Appeal to Authority', icon: '\uD83D\uDC51' },
  { id: 'cardstack',    label: 'Card Stacking',      icon: '\uD83C\uDCCF' },
  { id: 'plainfolks',   label: 'Plain Folks',        icon: '\uD83C\uDFE1' }
];

const PASSAGES = [
  {
    id: 'ww1',
    shortTitle: 'WW1 Recruitment',
    title: 'British Recruitment Poster Text (1914)',
    meta: 'Adapted from Parliamentary Recruiting Committee materials, 1914-1915',
    text: 'YOUR COUNTRY NEEDS YOU. Your King and Country need you. Will you answer your Country\'s call? Each day is fraught with the gravest possibilities, and at this very moment the Empire is on the brink of the greatest war in the history of the world. Every patriotic man of military age should join the ranks of our glorious Army. In this crisis your Country calls on all her young men to rally round the Flag and enlist today. Full particulars can be obtained at any Post Office. YOUR COUNTRY IS STILL CALLING. FIGHTING MEN! FALL IN! Men of Britain! Your fellow countrymen in their hundreds of thousands have already answered the call to arms. Do not be the last to go. Show the enemy what British pluck and valour mean. God Save the King.',
    answers: [
      { text: 'YOUR COUNTRY NEEDS YOU', technique: 'emotional' },
      { text: 'Your King and Country need you', technique: 'authority' },
      { text: 'the Empire is on the brink of the greatest war in the history of the world', technique: 'loaded' },
      { text: 'Every patriotic man of military age should join the ranks', technique: 'bandwagon' },
      { text: 'our glorious Army', technique: 'loaded' },
      { text: 'your Country calls on all her young men to rally round the Flag', technique: 'emotional' },
      { text: 'YOUR COUNTRY IS STILL CALLING. FIGHTING MEN! FALL IN!', technique: 'repetition' },
      { text: 'Your fellow countrymen in their hundreds of thousands have already answered the call', technique: 'bandwagon' },
      { text: 'Do not be the last to go', technique: 'bandwagon' },
      { text: 'British pluck and valour', technique: 'loaded' },
      { text: 'God Save the King', technique: 'authority' }
    ]
  },
  {
    id: 'ww2',
    shortTitle: 'WW2 Home Front',
    title: 'Home Front Leaflet (1940)',
    meta: 'Adapted from Ministry of Information public guidance, 1940',
    text: 'MAKE DO AND MEND. To the Women of Britain: Our brave boys are fighting on the front lines so that we may live in freedom. Every scrap of fabric saved, every jar preserved, every penny put aside brings us one step closer to Victory. The enemy wastes; we save. The enemy destroys; we build. Mrs Sew-and-Sew says: a patch today keeps Hitler away! Your neighbour is already doing her bit. The Ministry of Food has shown that careful housekeeping can feed a family on far less than you think. We are all in this together, rich and poor, young and old. Do your duty on the Home Front. Waste not, want not. Britain expects every woman to do her duty. Remember: loose lips sink ships. Keep calm and carry on.',
    answers: [
      { text: 'Our brave boys are fighting on the front lines so that we may live in freedom', technique: 'emotional' },
      { text: 'brings us one step closer to Victory', technique: 'emotional' },
      { text: 'The enemy wastes; we save. The enemy destroys; we build', technique: 'cardstack' },
      { text: 'Mrs Sew-and-Sew says: a patch today keeps Hitler away', technique: 'plainfolks' },
      { text: 'Your neighbour is already doing her bit', technique: 'bandwagon' },
      { text: 'The Ministry of Food has shown', technique: 'authority' },
      { text: 'We are all in this together, rich and poor, young and old', technique: 'plainfolks' },
      { text: 'Do your duty on the Home Front', technique: 'emotional' },
      { text: 'Waste not, want not', technique: 'repetition' },
      { text: 'Britain expects every woman to do her duty', technique: 'authority' },
      { text: 'loose lips sink ships', technique: 'loaded' },
      { text: 'Keep calm and carry on', technique: 'repetition' }
    ]
  },
  {
    id: 'coldwar',
    shortTitle: 'Cold War Speech',
    title: 'Cold War Era Speech Extract (1950s)',
    meta: 'Composite adapted from Western political rhetoric, 1950s',
    text: 'Fellow citizens of the free world, we stand at the crossroads of civilisation itself. The forces of tyranny and oppression spread like a plague across Eastern Europe, enslaving millions who once knew liberty. Every free nation, every democracy, every God-fearing people must unite against this menace. Our scientists, our generals, our finest minds all agree: the Communist threat is the gravest danger mankind has ever faced. Those who would appease the enemy are no better than the enemy themselves. We have built the mightiest arsenal the world has ever seen, and our economy towers above all others. Do not be fooled by their promises of equality; behind the Iron Curtain there is only misery and chains. Your fathers fought for freedom; your grandfathers bled for liberty. Will this generation surrender what they died to protect? Stand firm. Stand together. Stand for freedom.',
    answers: [
      { text: 'fellow citizens of the free world', technique: 'plainfolks' },
      { text: 'The forces of tyranny and oppression spread like a plague', technique: 'loaded' },
      { text: 'enslaving millions who once knew liberty', technique: 'emotional' },
      { text: 'Every free nation, every democracy, every God-fearing people must unite', technique: 'bandwagon' },
      { text: 'Our scientists, our generals, our finest minds all agree', technique: 'authority' },
      { text: 'the gravest danger mankind has ever faced', technique: 'loaded' },
      { text: 'Those who would appease the enemy are no better than the enemy themselves', technique: 'scapegoating' },
      { text: 'We have built the mightiest arsenal the world has ever seen, and our economy towers above all others', technique: 'cardstack' },
      { text: 'behind the Iron Curtain there is only misery and chains', technique: 'cardstack' },
      { text: 'Your fathers fought for freedom; your grandfathers bled for liberty', technique: 'emotional' },
      { text: 'Will this generation surrender what they died to protect', technique: 'emotional' },
      { text: 'Stand firm. Stand together. Stand for freedom', technique: 'repetition' }
    ]
  },
  {
    id: 'suffragette',
    shortTitle: 'Suffragette Pamphlet',
    title: 'Suffragette Campaign Pamphlet (1912)',
    meta: 'Adapted from WSPU pamphlet rhetoric, c. 1910-1913',
    text: 'VOTES FOR WOMEN. To every woman who values justice and liberty: the hour of action is upon us. For centuries, men alone have held the power of the ballot whilst women, who bear children, run households, teach the young, and nurse the sick, have been denied their voice. Mrs Pankhurst, that courageous champion of our cause, has shown us the way. Thousands of women across this land have already taken up the fight. Will you stand idle whilst your sisters march? The Government tells you that women do not want the vote. This is a lie. They show you only the voices of the comfortable and compliant whilst silencing ours. We are your mothers, your daughters, your wives. We ask for nothing more than what every working man already enjoys. Deeds, not words! Deeds, not words! Rise up, for justice delayed is justice denied. VOTES FOR WOMEN.',
    answers: [
      { text: 'VOTES FOR WOMEN', technique: 'repetition' },
      { text: 'every woman who values justice and liberty', technique: 'emotional' },
      { text: 'women, who bear children, run households, teach the young, and nurse the sick', technique: 'cardstack' },
      { text: 'Mrs Pankhurst, that courageous champion of our cause', technique: 'authority' },
      { text: 'Thousands of women across this land have already taken up the fight', technique: 'bandwagon' },
      { text: 'Will you stand idle whilst your sisters march', technique: 'emotional' },
      { text: 'They show you only the voices of the comfortable and compliant whilst silencing ours', technique: 'cardstack' },
      { text: 'We are your mothers, your daughters, your wives', technique: 'plainfolks' },
      { text: 'nothing more than what every working man already enjoys', technique: 'plainfolks' },
      { text: 'Deeds, not words! Deeds, not words!', technique: 'repetition' },
      { text: 'justice delayed is justice denied', technique: 'loaded' }
    ]
  }
];

let activePassageId = null;
let activeTechnique = null;
let annotations = {};  // passageId -> [{text, technique, startOffset, endOffset}]

// Initialise
function init() {
  buildPassageButtons();
  buildToolbar();
  drawChart();
}

function buildPassageButtons() {
  const container = document.getElementById('passageSelector');
  PASSAGES.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'passage-btn';
    btn.textContent = p.shortTitle;
    btn.dataset.id = p.id;
    btn.addEventListener('click', () => loadPassage(p.id));
    container.appendChild(btn);
  });
}

function buildToolbar() {
  const grid = document.getElementById('toolbarGrid');
  TECHNIQUES.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'tech-btn';
    btn.dataset.tech = t.id;
    btn.innerHTML = `<span class="icon">${t.icon}</span><span>${t.label}</span>`;
    btn.addEventListener('click', () => selectTechnique(t.id));
    grid.appendChild(btn);
  });
}

function selectTechnique(techId) {
  const hint = document.getElementById('toolbarHint');
  if (activeTechnique === techId) {
    activeTechnique = null;
    document.querySelectorAll('.tech-btn').forEach(b => b.classList.remove('active'));
    hint.textContent = 'Select a technique, then highlight text in the passage below';
    return;
  }
  activeTechnique = techId;
  document.querySelectorAll('.tech-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tech === techId);
  });
  const t = TECHNIQUES.find(t => t.id === techId);
  hint.textContent = `Now highlight text to label it as "${t.label}"`;
}

function loadPassage(id) {
  activePassageId = id;
  const passage = PASSAGES.find(p => p.id === id);

  document.querySelectorAll('.passage-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.id === id);
  });

  document.getElementById('passageTitle').textContent = passage.title;
  document.getElementById('passageMeta').textContent = passage.meta;

  if (!annotations[id]) annotations[id] = [];

  renderPassageBody();
  renderAnnotationsList();
  drawChart();

  document.getElementById('scorePanel').classList.remove('visible');
}

function renderPassageBody() {
  const passage = PASSAGES.find(p => p.id === activePassageId);
  if (!passage) return;

  const body = document.getElementById('passageBody');
  const annots = annotations[activePassageId] || [];

  if (annots.length === 0) {
    body.textContent = passage.text;
    return;
  }

  // Sort annotations by start position
  const sorted = annots
    .map((a, i) => ({ ...a, idx: i }))
    .sort((a, b) => a.startOffset - b.startOffset);

  let html = '';
  let lastEnd = 0;

  sorted.forEach(a => {
    if (a.startOffset < lastEnd) return; // skip overlapping
    html += escapeHtml(passage.text.slice(lastEnd, a.startOffset));
    const techObj = TECHNIQUES.find(t => t.id === a.technique);
    html += `<span class="annotated ${a.technique}" data-idx="${a.idx}" title="${techObj.label}: click to remove">${escapeHtml(a.text)}<span class="tech-label ${a.technique}">${techObj.label}</span></span>`;
    lastEnd = a.endOffset;
  });

  html += escapeHtml(passage.text.slice(lastEnd));
  body.innerHTML = html;

  body.querySelectorAll('.annotated').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      const idx = parseInt(el.dataset.idx);
      removeAnnotation(idx);
    });
  });
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// Handle text selection
document.getElementById('passageBody').addEventListener('mouseup', handleSelection);
document.getElementById('passageBody').addEventListener('touchend', handleSelection);

function handleSelection() {
  if (!activeTechnique || !activePassageId) return;

  const sel = window.getSelection();
  if (!sel || sel.isCollapsed) return;

  const selectedText = sel.toString().trim();
  if (selectedText.length < 2) return;

  const passage = PASSAGES.find(p => p.id === activePassageId);
  const fullText = passage.text;
  const startIdx = fullText.indexOf(selectedText);
  if (startIdx === -1) { sel.removeAllRanges(); return; }

  // Check for overlap
  const endIdx = startIdx + selectedText.length;
  const existing = annotations[activePassageId] || [];
  const overlaps = existing.some(a =>
    (startIdx < a.endOffset && endIdx > a.startOffset)
  );

  if (overlaps) {
    showToast('That selection overlaps an existing annotation. Remove it first.');
    sel.removeAllRanges();
    return;
  }

  if (!annotations[activePassageId]) annotations[activePassageId] = [];
  annotations[activePassageId].push({
    text: selectedText,
    technique: activeTechnique,
    startOffset: startIdx,
    endOffset: endIdx
  });

  sel.removeAllRanges();
  renderPassageBody();
  renderAnnotationsList();
  drawChart();
  showToast(`Labelled as "${TECHNIQUES.find(t => t.id === activeTechnique).label}"`);
}

function removeAnnotation(idx) {
  if (!activePassageId) return;
  const annots = annotations[activePassageId];
  if (idx >= 0 && idx < annots.length) {
    annots.splice(idx, 1);
    renderPassageBody();
    renderAnnotationsList();
    drawChart();
    showToast('Annotation removed');
  }
}

function clearAnnotations() {
  if (!activePassageId) return;
  annotations[activePassageId] = [];
  renderPassageBody();
  renderAnnotationsList();
  drawChart();
  document.getElementById('scorePanel').classList.remove('visible');
  showToast('All annotations cleared');
}

function renderAnnotationsList() {
  const container = document.getElementById('annotationsList');
  const annots = annotations[activePassageId] || [];

  if (annots.length === 0) {
    container.innerHTML = '<div class="no-annotations">No annotations yet</div>';
    return;
  }

  container.innerHTML = annots.map((a, i) => {
    const t = TECHNIQUES.find(t => t.id === a.technique);
    const bgVar = `var(--tech-${a.technique}-bg)`;
    const preview = a.text.length > 35 ? a.text.slice(0, 35) + '...' : a.text;
    return `<div class="annotation-item" style="background:${bgVar}">
      <span class="tech-label ${a.technique}">${t.label}</span>
      <span class="text-preview">"${escapeHtml(preview)}"</span>
      <button class="remove-btn" onclick="removeAnnotation(${i})" title="Remove">&times;</button>
    </div>`;
  }).join('');
}

// Chart drawing
function drawChart() {
  const canvas = document.getElementById('chartCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, w, h);

  const annots = annotations[activePassageId] || [];
  const counts = {};
  TECHNIQUES.forEach(t => counts[t.id] = 0);
  annots.forEach(a => { if (counts[a.technique] !== undefined) counts[a.technique]++; });

  const maxCount = Math.max(1, ...Object.values(counts));
  const padding = { top: 10, right: 12, bottom: 60, left: 12 };
  const chartW = w - padding.left - padding.right;
  const chartH = h - padding.top - padding.bottom;
  const barW = chartW / TECHNIQUES.length;
  const gap = 6;

  // Grid lines
  ctx.strokeStyle = '#e6ddd0';
  ctx.lineWidth = 0.5;
  for (let i = 0; i <= maxCount; i++) {
    const y = padding.top + chartH - (i / maxCount) * chartH;
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(w - padding.right, y);
    ctx.stroke();
  }

  // Bars
  const colours = {
    bandwagon: '#e07b39', scapegoating: '#c0392b', emotional: '#8e44ad',
    repetition: '#2980b9', loaded: '#d4a234', authority: '#27ae60',
    cardstack: '#16a085', plainfolks: '#7f8c8d'
  };

  TECHNIQUES.forEach((t, i) => {
    const x = padding.left + i * barW + gap / 2;
    const bw = barW - gap;
    const barH = (counts[t.id] / maxCount) * chartH;
    const y = padding.top + chartH - barH;

    // Bar
    ctx.fillStyle = colours[t.id];
    ctx.beginPath();
    const r = 3;
    if (barH > r * 2) {
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + bw, y, x + bw, y + barH, r);
      ctx.arcTo(x + bw, y + barH, x, y + barH, 0);
      ctx.arcTo(x, y + barH, x, y, 0);
      ctx.arcTo(x, y, x + bw, y, r);
    } else if (barH > 0) {
      ctx.rect(x, y, bw, barH);
    }
    ctx.fill();

    // Count label
    if (counts[t.id] > 0) {
      ctx.fillStyle = '#3b2a1d';
      ctx.font = 'bold 11px "Segoe UI", sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(counts[t.id], x + bw / 2, y - 4);
    }

    // X-axis label (rotated)
    ctx.save();
    ctx.translate(x + bw / 2, padding.top + chartH + 8);
    ctx.rotate(-Math.PI / 4);
    ctx.fillStyle = '#6b5344';
    ctx.font = '9px "Segoe UI", sans-serif';
    ctx.textAlign = 'right';
    const shortLabel = t.label.length > 10 ? t.label.slice(0, 9) + '.' : t.label;
    ctx.fillText(shortLabel, 0, 0);
    ctx.restore();
  });
}

// Scoring
function checkAnswers() {
  if (!activePassageId) { showToast('Select a passage first'); return; }
  const passage = PASSAGES.find(p => p.id === activePassageId);
  const userAnnots = annotations[activePassageId] || [];

  if (userAnnots.length === 0) { showToast('Add some annotations before checking'); return; }

  const modelAnswers = passage.answers;
  let correctCount = 0;
  let partialCount = 0;
  const feedback = [];

  userAnnots.forEach(ua => {
    const match = modelAnswers.find(ma => {
      const overlap = getOverlap(ua.startOffset, ua.endOffset,
        passage.text.indexOf(ma.text), passage.text.indexOf(ma.text) + ma.text.length);
      return overlap > 0.4;
    });

    if (match && match.technique === ua.technique) {
      correctCount++;
    } else if (match) {
      partialCount++;
      const correctTech = TECHNIQUES.find(t => t.id === match.technique);
      feedback.push(`"${ua.text.slice(0, 30)}..." is ${correctTech.label}, not ${TECHNIQUES.find(t => t.id === ua.technique).label}`);
    }
  });

  const total = modelAnswers.length;
  const pct = Math.round(((correctCount + partialCount * 0.3) / total) * 100);

  const panel = document.getElementById('scorePanel');
  panel.classList.add('visible');
  document.getElementById('scoreValue').textContent = pct + '%';

  const detail = document.getElementById('scoreDetail');
  let detailHtml = `<li>Correct matches: ${correctCount} of ${total}</li>`;
  detailHtml += `<li>Partially correct: ${partialCount}</li>`;
  detailHtml += `<li>Model answers in passage: ${total}</li>`;
  if (feedback.length > 0) {
    detailHtml += '<li style="margin-top:6px; font-weight:600;">Corrections:</li>';
    feedback.forEach(f => { detailHtml += `<li style="color:var(--tech-scapegoating);">${escapeHtml(f)}</li>`; });
  }
  detail.innerHTML = detailHtml;
}

function getOverlap(s1, e1, s2, e2) {
  const overlapStart = Math.max(s1, s2);
  const overlapEnd = Math.min(e1, e2);
  if (overlapEnd <= overlapStart) return 0;
  const overlapLen = overlapEnd - overlapStart;
  const minLen = Math.min(e1 - s1, e2 - s2);
  return minLen > 0 ? overlapLen / minLen : 0;
}

function showModelAnswers() {
  if (!activePassageId) { showToast('Select a passage first'); return; }
  const passage = PASSAGES.find(p => p.id === activePassageId);

  annotations[activePassageId] = passage.answers.map(a => {
    const start = passage.text.indexOf(a.text);
    return {
      text: a.text,
      technique: a.technique,
      startOffset: start,
      endOffset: start + a.text.length
    };
  }).filter(a => a.startOffset >= 0);

  renderPassageBody();
  renderAnnotationsList();
  drawChart();
  showToast('Showing model answers');
}

function toggleInfo() {
  const toggle = document.getElementById('infoToggle');
  const content = document.getElementById('infoContent');
  toggle.classList.toggle('open');
  content.classList.toggle('open');
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => toast.classList.remove('visible'), 2200);
}

window.addEventListener('resize', drawChart);

init();
</script>
</body>
</html>