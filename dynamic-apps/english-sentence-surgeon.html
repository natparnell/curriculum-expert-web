<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sentence Surgeon</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:#1a2744;--navy-light:#243556;--navy-mid:#2d4270;
  --gold:#d4a843;--gold-light:#e8c36a;--gold-dim:#b8923a;
  --cream:#faf6ed;--cream-dark:#f0e8d8;--cream-mid:#e8dcc8;
  --ink:#2c2418;--ink-light:#5a4e3e;
  --accent-teal:#4a9b8e;--accent-rose:#c47a7a;--accent-plum:#8b6fa3;
  --accent-amber:#d4943a;
  --shadow:0 2px 12px rgba(26,39,68,.18);
  --shadow-lg:0 8px 32px rgba(26,39,68,.22);
  --radius:10px;--radius-sm:6px;
  --font-serif:'Georgia','Times New Roman',serif;
  --font-sans:'Segoe UI','Helvetica Neue',Arial,sans-serif;
  --font-mono:'Consolas','Courier New',monospace;
}
html{font-size:15px;scroll-behavior:smooth}
body{
  font-family:var(--font-sans);background:var(--cream);color:var(--ink);
  min-height:100vh;line-height:1.6;
}
/* Scrollbar */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--cream-dark);border-radius:4px}
::-webkit-scrollbar-thumb{background:var(--navy-mid);border-radius:4px}

/* ─── HEADER ─── */
header{
  background:linear-gradient(135deg,var(--navy) 0%,var(--navy-light) 50%,var(--navy-mid) 100%);
  color:var(--cream);padding:1.1rem 2rem;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:var(--shadow-lg);position:sticky;top:0;z-index:100;
}
header h1{
  font-family:var(--font-serif);font-size:1.7rem;font-weight:700;
  display:flex;align-items:center;gap:.6rem;letter-spacing:.02em;
}
header h1 .icon{font-size:1.5rem;filter:drop-shadow(0 0 4px rgba(212,168,67,.5))}
header h1 .highlight{color:var(--gold-light)}
.header-controls{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}

/* Buttons */
.btn{
  font-family:var(--font-sans);font-size:.82rem;font-weight:600;
  padding:.45rem 1rem;border-radius:var(--radius-sm);border:none;
  cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.35rem;
  white-space:nowrap;
}
.btn-gold{background:var(--gold);color:var(--navy);box-shadow:0 2px 8px rgba(212,168,67,.3)}
.btn-gold:hover{background:var(--gold-light);transform:translateY(-1px)}
.btn-outline{background:transparent;color:var(--cream);border:1.5px solid rgba(255,255,255,.35)}
.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn-outline.active{border-color:var(--gold);color:var(--gold);background:rgba(212,168,67,.12)}
.btn-navy{background:var(--navy);color:var(--cream);border:1.5px solid var(--navy-mid)}
.btn-navy:hover{background:var(--navy-light)}
.btn-sm{padding:.3rem .7rem;font-size:.75rem}
.btn-teal{background:var(--accent-teal);color:#fff}
.btn-teal:hover{background:#3d8a7e}

/* ─── LAYOUT ─── */
.app{display:flex;gap:0;min-height:calc(100vh - 60px)}
.main-panel{flex:1;min-width:0;padding:1.5rem 2rem;overflow-y:auto;max-height:calc(100vh - 60px)}
.side-panel{
  width:310px;min-width:310px;background:#fff;
  border-left:1px solid var(--cream-mid);padding:1.2rem;
  overflow-y:auto;max-height:calc(100vh - 60px);
  box-shadow:-4px 0 16px rgba(26,39,68,.06);
}

/* ─── SECTION CARDS ─── */
.card{
  background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
  padding:1.2rem 1.4rem;margin-bottom:1.2rem;border:1px solid var(--cream-dark);
}
.card h2{
  font-family:var(--font-serif);font-size:1.1rem;color:var(--navy);
  margin-bottom:.7rem;display:flex;align-items:center;gap:.4rem;
  border-bottom:2px solid var(--cream-dark);padding-bottom:.4rem;
}
.card h2 .badge{
  font-family:var(--font-sans);font-size:.65rem;font-weight:700;
  background:var(--gold);color:var(--navy);padding:.15rem .5rem;
  border-radius:20px;margin-left:auto;
}

/* ─── INPUT AREA ─── */
.input-section{position:relative}
#inputText{
  width:100%;min-height:130px;padding:1rem;
  font-family:var(--font-serif);font-size:1rem;line-height:1.7;
  border:2px solid var(--cream-mid);border-radius:var(--radius-sm);
  background:var(--cream);color:var(--ink);resize:vertical;
  transition:border-color .2s;
}
#inputText:focus{outline:none;border-color:var(--gold)}
.example-btns{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.6rem}

/* ─── SENTENCE WORKSPACE ─── */
.workspace{min-height:200px}
.sentence-block{
  background:var(--cream);border-radius:var(--radius-sm);
  padding:.7rem .9rem;margin-bottom:.6rem;
  border-left:4px solid var(--navy-mid);
  transition:all .25s;position:relative;
  cursor:pointer;
}
.sentence-block:hover{box-shadow:0 2px 10px rgba(26,39,68,.1)}
.sentence-block.active{
  border-left-color:var(--gold);background:#fff;
  box-shadow:0 3px 14px rgba(212,168,67,.15);
}
.sentence-block .sentence-text{
  font-family:var(--font-serif);font-size:.95rem;line-height:1.7;
}
.sentence-block .opener-tag{
  display:inline-block;font-size:.65rem;font-weight:700;
  padding:.12rem .45rem;border-radius:3px;margin-right:.4rem;
  vertical-align:middle;letter-spacing:.03em;text-transform:uppercase;
}
/* opener type colours */
.opener-adverbial{background:#dceefb;color:#1a5f9e;border-left-color:#1a5f9e !important}
.opener-conjunction{background:#fde9d0;color:#b5651d;border-left-color:#b5651d !important}
.opener-pronoun{background:#e8dff5;color:#6b3fa0;border-left-color:#6b3fa0 !important}
.opener-ing{background:#d4f0e8;color:#2a7a5e;border-left-color:#2a7a5e !important}
.opener-prepositional{background:#fce4e4;color:#a94442;border-left-color:#a94442 !important}
.opener-article{background:#f0e8d8;color:#7a6530;border-left-color:#7a6530 !important}
.opener-unknown{background:#e8e8e8;color:#555;border-left-color:#999 !important}

/* drag styling */
.sentence-block.dragging{opacity:.4;transform:scale(.97)}
.sentence-block.drag-over{border-top:3px solid var(--gold);margin-top:-3px}
.drag-handle{
  cursor:grab;color:var(--navy-mid);margin-right:.5rem;
  font-size:1rem;opacity:.5;transition:opacity .2s;user-select:none;
}
.drag-handle:hover{opacity:1}
.sentence-header{display:flex;align-items:center;margin-bottom:.25rem}

/* ─── CLAUSE EDITOR ─── */
.clause-editor{
  background:#fff;border-radius:var(--radius-sm);
  padding:.8rem;margin-top:.5rem;
  border:1.5px dashed var(--gold-dim);
}
.clause-chip{
  display:inline-flex;align-items:center;
  background:var(--cream);border:1.5px solid var(--cream-mid);
  border-radius:var(--radius-sm);padding:.35rem .65rem;
  margin:.2rem;font-family:var(--font-serif);font-size:.88rem;
  cursor:grab;transition:all .2s;user-select:none;
}
.clause-chip:hover{border-color:var(--gold);background:var(--cream-dark)}
.clause-chip.dragging{opacity:.35}
.clause-chip .punct-btn{
  margin-left:.3rem;padding:.1rem .3rem;font-size:.85rem;
  font-weight:700;cursor:pointer;border-radius:3px;
  color:var(--accent-rose);background:transparent;border:none;
  transition:all .15s;font-family:var(--font-mono);
}
.clause-chip .punct-btn:hover{background:rgba(196,122,122,.12)}

/* ─── VOCABULARY POPUP ─── */
.vocab-overlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  z-index:500;background:rgba(26,39,68,.25);
}
.vocab-overlay.show{display:flex;align-items:center;justify-content:center}
.vocab-popup{
  background:#fff;border-radius:var(--radius);padding:1.5rem;
  min-width:340px;max-width:480px;box-shadow:var(--shadow-lg);
  border:2px solid var(--gold);
}
.vocab-popup h3{
  font-family:var(--font-serif);color:var(--navy);margin-bottom:.7rem;
  font-size:1.05rem;
}
.vocab-tier{margin-bottom:.6rem}
.vocab-tier-label{
  font-size:.7rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.08em;margin-bottom:.25rem;display:flex;align-items:center;gap:.3rem;
}
.tier-basic .vocab-tier-label{color:#888}
.tier-ambitious .vocab-tier-label{color:var(--accent-teal)}
.tier-sophisticated .vocab-tier-label{color:var(--gold-dim)}
.vocab-word{
  display:inline-block;padding:.25rem .6rem;margin:.15rem;
  border-radius:var(--radius-sm);cursor:pointer;font-size:.88rem;
  font-family:var(--font-serif);transition:all .2s;border:1.5px solid transparent;
}
.tier-basic .vocab-word{background:#f0f0f0;color:#555}
.tier-basic .vocab-word:hover{border-color:#888;background:#e8e8e8}
.tier-ambitious .vocab-word{background:#e0f4ef;color:#2a7a5e}
.tier-ambitious .vocab-word:hover{border-color:var(--accent-teal);background:#d0ece5}
.tier-sophisticated .vocab-word{background:#fef5e0;color:var(--gold-dim)}
.tier-sophisticated .vocab-word:hover{border-color:var(--gold);background:#fdecc8}
.vocab-popup .close-btn{
  margin-top:.5rem;display:block;width:100%;text-align:center;
  padding:.4rem;background:var(--cream);border:1px solid var(--cream-mid);
  border-radius:var(--radius-sm);cursor:pointer;font-size:.82rem;color:var(--ink-light);
}
.vocab-popup .close-btn:hover{background:var(--cream-dark)}

/* ─── SCORE PANEL ─── */
.score-ring-container{display:flex;justify-content:center;margin-bottom:.8rem}
.score-ring{position:relative;width:110px;height:110px}
.score-ring svg{transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:8}
.score-ring .bg{stroke:var(--cream-dark)}
.score-ring .fg{stroke:var(--gold);stroke-linecap:round;transition:stroke-dashoffset .6s ease}
.score-ring .score-label{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:var(--font-serif);font-size:1.6rem;font-weight:700;color:var(--navy);
}
.score-ring .score-sublabel{
  position:absolute;top:68%;left:50%;transform:translate(-50%,-50%);
  font-size:.6rem;color:var(--ink-light);text-transform:uppercase;letter-spacing:.06em;
}
.score-detail{
  display:flex;justify-content:space-between;align-items:center;
  padding:.45rem 0;border-bottom:1px solid var(--cream-dark);
  font-size:.82rem;
}
.score-detail:last-child{border-bottom:none}
.score-detail .label{color:var(--ink-light)}
.score-detail .value{font-weight:700;color:var(--navy)}
.score-bar{
  width:80px;height:6px;background:var(--cream-dark);border-radius:3px;
  overflow:hidden;margin-left:.5rem;display:inline-block;vertical-align:middle;
}
.score-bar-fill{height:100%;border-radius:3px;transition:width .5s ease}
.bar-low{background:var(--accent-rose)}
.bar-mid{background:var(--accent-amber)}
.bar-high{background:var(--accent-teal)}

/* ─── BEFORE / AFTER ─── */
.compare-container{display:none;gap:1rem}
.compare-container.show{display:grid;grid-template-columns:1fr 1fr}
.compare-pane{
  background:#fff;border-radius:var(--radius);padding:1rem 1.2rem;
  box-shadow:var(--shadow);border:1px solid var(--cream-dark);
}
.compare-pane h3{
  font-family:var(--font-serif);font-size:.95rem;margin-bottom:.5rem;
  padding-bottom:.3rem;border-bottom:2px solid var(--cream-dark);
}
.compare-pane.original h3{color:var(--accent-rose)}
.compare-pane.modified h3{color:var(--accent-teal)}
.compare-pane p{font-family:var(--font-serif);font-size:.92rem;line-height:1.75;color:var(--ink)}
.diff-highlight{background:#fef3c7;padding:.05rem .15rem;border-radius:2px}

/* ─── TOOLTIP ─── */
.tip{
  position:relative;
}
.tip::after{
  content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;
  transform:translateX(-50%);background:var(--navy);color:var(--cream);
  font-size:.7rem;padding:.3rem .6rem;border-radius:4px;white-space:nowrap;
  opacity:0;pointer-events:none;transition:opacity .2s;z-index:10;
}
.tip:hover::after{opacity:1}

/* ─── INSTRUCTIONS STRIP ─── */
.instructions{
  display:flex;gap:1.2rem;flex-wrap:wrap;padding:.6rem 1rem;
  background:linear-gradient(90deg,rgba(26,39,68,.04),rgba(212,168,67,.06));
  border-radius:var(--radius-sm);margin-bottom:1rem;
  border:1px solid var(--cream-mid);
}
.instructions .step{
  display:flex;align-items:center;gap:.3rem;font-size:.75rem;color:var(--ink-light);
}
.instructions .step-num{
  width:20px;height:20px;border-radius:50%;background:var(--navy);
  color:var(--gold);font-size:.65rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}

/* ─── WORD CLICKABLE ─── */
.clickable-word{
  cursor:pointer;padding:.05rem .1rem;border-radius:2px;
  transition:all .15s;display:inline;
}
.clickable-word:hover{background:rgba(212,168,67,.2);color:var(--navy)}
.clickable-word.upgraded{
  background:rgba(74,155,142,.12);color:#2a7a5e;
  font-weight:600;border-bottom:2px solid var(--accent-teal);
}

/* ─── RESPONSIVE ─── */
@media(max-width:900px){
  .app{flex-direction:column}
  .side-panel{width:100%;min-width:0;max-height:none;border-left:none;border-top:1px solid var(--cream-mid)}
  .main-panel{max-height:none}
  .compare-container.show{grid-template-columns:1fr}
  header{flex-direction:column;gap:.6rem;text-align:center}
  .header-controls{justify-content:center}
}
@media(min-width:1600px){
  .main-panel{padding:2rem 3rem}
  html{font-size:16px}
}

/* ─── ANIMATIONS ─── */
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.animate-in{animation:slideUp .35s ease both}
.pulse{animation:pulse .3s ease}

/* Punctuation cycle indicator */
.punct-indicator{
  display:inline-block;min-width:18px;text-align:center;
  font-family:var(--font-mono);font-weight:700;font-size:1.05rem;
  color:var(--accent-rose);cursor:pointer;
  padding:0 .1rem;border-radius:2px;transition:all .15s;
}
.punct-indicator:hover{background:rgba(196,122,122,.15)}

/* Legend */
.legend{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.5rem}
.legend-item{
  display:flex;align-items:center;gap:.25rem;font-size:.68rem;
  color:var(--ink-light);
}
.legend-dot{width:10px;height:10px;border-radius:2px}

/* Tab bar */
.tab-bar{display:flex;gap:0;margin-bottom:1rem;border-bottom:2px solid var(--cream-mid)}
.tab-btn{
  font-family:var(--font-sans);font-size:.82rem;font-weight:600;
  padding:.5rem 1.1rem;border:none;background:transparent;
  cursor:pointer;color:var(--ink-light);border-bottom:2px solid transparent;
  margin-bottom:-2px;transition:all .2s;
}
.tab-btn.active{color:var(--navy);border-bottom-color:var(--gold)}
.tab-btn:hover{color:var(--navy)}
.tab-content{display:none}
.tab-content.active{display:block}

/* toast */
.toast{
  position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--navy);color:var(--cream);padding:.6rem 1.2rem;
  border-radius:var(--radius-sm);font-size:.82rem;opacity:0;
  transition:all .3s;z-index:999;pointer-events:none;box-shadow:var(--shadow-lg);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<header>
  <h1>
    <span class="icon">&#9986;</span>
    <span>Sentence <span class="highlight">Surgeon</span></span>
  </h1>
  <div class="header-controls">
    <button class="btn btn-outline" id="btnCompare">&#9881; Before / After</button>
    <button class="btn btn-outline" id="btnReset">&#8634; Reset</button>
    <button class="btn btn-gold" id="btnAnalyse">&#9889; Analyse Text</button>
  </div>
</header>

<div class="app">
  <div class="main-panel" id="mainPanel">
    <!-- Instructions -->
    <div class="instructions">
      <div class="step"><span class="step-num">1</span> Enter or select a paragraph below</div>
      <div class="step"><span class="step-num">2</span> Click <strong>Analyse</strong> to break it apart</div>
      <div class="step"><span class="step-num">3</span> Drag sentences to reorder openers</div>
      <div class="step"><span class="step-num">4</span> Click a sentence to edit clauses</div>
      <div class="step"><span class="step-num">5</span> Click any word to upgrade vocabulary</div>
    </div>

    <!-- Tab bar -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="input">Input</button>
      <button class="tab-btn" data-tab="workspace">Workspace</button>
      <button class="tab-btn" data-tab="compare">Compare</button>
    </div>

    <!-- INPUT TAB -->
    <div class="tab-content active" id="tab-input">
      <div class="card input-section">
        <h2>&#9997; Your Paragraph</h2>
        <textarea id="inputText" spellcheck="false">The boy walked to the school. He was feeling nervous because it was his first day. He didn't know anyone there. The corridors were long and they were busy. He found his classroom and he sat down at a desk. The teacher smiled at him and she said welcome. He felt a bit better then. The other students were talking and laughing. He hoped he would make some friends soon. The day went by slowly but he survived it.</textarea>
        <div class="example-btns">
          <span style="font-size:.75rem;color:var(--ink-light);margin-right:.3rem;align-self:center">Examples:</span>
          <button class="btn btn-sm btn-navy" data-example="poor">Poor Quality</button>
          <button class="btn btn-sm btn-navy" data-example="average">Average Quality</button>
          <button class="btn btn-sm btn-navy" data-example="good">Good Quality</button>
          <button class="btn btn-sm btn-navy" data-example="descriptive">Descriptive</button>
        </div>
      </div>
    </div>

    <!-- WORKSPACE TAB -->
    <div class="tab-content" id="tab-workspace">
      <div class="card">
        <h2>&#128300; Sentence Workspace <span class="badge" id="sentenceCount">0 sentences</span></h2>
        <div class="legend" id="openerLegend"></div>
        <div class="workspace" id="workspace">
          <p style="color:var(--ink-light);font-style:italic;padding:2rem;text-align:center">
            Click <strong>Analyse Text</strong> to begin dissecting your paragraph.
          </p>
        </div>
      </div>
    </div>

    <!-- COMPARE TAB -->
    <div class="tab-content" id="tab-compare">
      <div class="compare-container show" id="compareView">
        <div class="compare-pane original">
          <h3>&#128308; Original</h3>
          <p id="originalText">No text analysed yet.</p>
        </div>
        <div class="compare-pane modified">
          <h3>&#128994; Modified</h3>
          <p id="modifiedText">Make changes in the workspace to see them here.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- SIDE PANEL: Scores -->
  <div class="side-panel">
    <div class="card">
      <h2>&#127942; Writing Quality</h2>
      <div class="score-ring-container">
        <div class="score-ring">
          <svg width="110" height="110" viewBox="0 0 110 110">
            <circle class="bg" cx="55" cy="55" r="46"/>
            <circle class="fg" id="scoreRingFg" cx="55" cy="55" r="46"
              stroke-dasharray="289.03" stroke-dashoffset="289.03"/>
          </svg>
          <div class="score-label" id="overallScore">--</div>
          <div class="score-sublabel">overall</div>
        </div>
      </div>
      <div class="score-detail">
        <span class="label">Opener Variety</span>
        <span><span class="value" id="scoreOpener">--</span><span class="score-bar"><span class="score-bar-fill" id="barOpener" style="width:0"></span></span></span>
      </div>
      <div class="score-detail">
        <span class="label">Sentence Length</span>
        <span><span class="value" id="scoreLength">--</span><span class="score-bar"><span class="score-bar-fill" id="barLength" style="width:0"></span></span></span>
      </div>
      <div class="score-detail">
        <span class="label">Vocabulary</span>
        <span><span class="value" id="scoreVocab">--</span><span class="score-bar"><span class="score-bar-fill" id="barVocab" style="width:0"></span></span></span>
      </div>
      <div class="score-detail">
        <span class="label">Punctuation</span>
        <span><span class="value" id="scorePunct">--</span><span class="score-bar"><span class="score-bar-fill" id="barPunct" style="width:0"></span></span></span>
      </div>
    </div>

    <div class="card">
      <h2>&#128218; Opener Key</h2>
      <div id="openerKeySide"></div>
    </div>

    <div class="card">
      <h2>&#128161; Quick Tips</h2>
      <div id="tipsArea" style="font-size:.82rem;color:var(--ink-light);line-height:1.6">
        Analyse a paragraph to receive targeted writing tips.
      </div>
    </div>
  </div>
</div>

<!-- Vocabulary Popup -->
<div class="vocab-overlay" id="vocabOverlay">
  <div class="vocab-popup">
    <h3 id="vocabTitle">Upgrade: <span id="vocabOriginal"></span></h3>
    <div id="vocabTiers"></div>
    <button class="close-btn" id="vocabClose">Cancel</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ═══════════════════════════════════════
   DATA & STATE
   ═══════════════════════════════════════ */
const EXAMPLES = {
  poor: `The boy went to school. He was sad. He didn't like school. The teacher was nice. She said hello. He sat down. He got his books out. He did some work. It was boring. He went home.`,
  average: `The boy walked to the school. He was feeling nervous because it was his first day. He didn't know anyone there. The corridors were long and they were busy. He found his classroom and he sat down at a desk. The teacher smiled at him and she said welcome. He felt a bit better then. The other students were talking and laughing. He hoped he would make some friends soon. The day went by slowly but he survived it.`,
  good: `Nervously, the boy approached the unfamiliar school building, his heart hammering against his ribs. Although he had imagined this moment many times, nothing had prepared him for the overwhelming rush of noise that greeted him inside. Stretching endlessly before him, the corridors buzzed with clusters of students who all seemed to know exactly where they belonged. After locating his classroom, he slipped into a seat near the back and clutched his bag like a shield. With a warm smile, the teacher welcomed him by name; instantly, the knot in his stomach began to loosen. Beside him, a freckled girl leaned over and whispered a friendly introduction. Perhaps this place would not be so terrible after all.`,
  descriptive: `Beyond the rusted iron gates, the old manor house crouched like a sleeping beast beneath a canopy of ancient oaks. Ivy crawled across its crumbling facade, threading through cracked windowpanes that stared out like hollow eyes. Inside the entrance hall, dust motes drifted through shafts of pale light, and the air carried a faint scent of damp wood and forgotten years. Cautiously, she stepped across the threshold, her footsteps echoing against the marble floor. A grand staircase spiralled upward into shadow, its banister draped with cobwebs that shimmered like silver thread. From somewhere deep within the house, a clock began to chime — slow, resonant notes that seemed to vibrate through the very walls. Despite every instinct urging her to retreat, curiosity pulled her forward into the darkness.`
};

const OPENER_TYPES = {
  adverbial: {label:'Adverbial', color:'#1a5f9e', bg:'#dceefb', css:'opener-adverbial'},
  conjunction: {label:'Conjunction', color:'#b5651d', bg:'#fde9d0', css:'opener-conjunction'},
  pronoun: {label:'Pronoun', color:'#6b3fa0', bg:'#e8dff5', css:'opener-pronoun'},
  ing: {label:'-ing Opener', color:'#2a7a5e', bg:'#d4f0e8', css:'opener-ing'},
  prepositional: {label:'Prepositional', color:'#a94442', bg:'#fce4e4', css:'opener-prepositional'},
  article: {label:'Article/The', color:'#7a6530', bg:'#f0e8d8', css:'opener-article'},
  unknown: {label:'Other', color:'#555', bg:'#e8e8e8', css:'opener-unknown'}
};

const ADVERBS_AND_ADVERBIALS = [
  'nervously','cautiously','suddenly','slowly','quickly','quietly','carefully','desperately',
  'unfortunately','fortunately','meanwhile','however','therefore','consequently','furthermore',
  'nevertheless','afterwards','eventually','immediately','silently','gently','fiercely',
  'reluctantly','eagerly','anxiously','curiously','remarkably','surprisingly','obviously',
  'certainly','perhaps','finally','initially','recently','occasionally','frequently',
  'apparently','presumably','honestly','sadly','happily','angrily','calmly','boldly',
  'wearily','triumphantly','instinctively','despite','although','though','even though',
  'after','before','while','when','whenever','since','until','as soon as','once',
  'beyond','beneath','above','inside','outside','within','without','across','around',
  'through','during','between','among'
];
const CONJUNCTIONS = ['and','but','so','yet','or','nor','for','because','although','though','however','nevertheless','furthermore','moreover','meanwhile','consequently','therefore','while','whereas','since','unless','until','after','before','if','when'];
const PRONOUNS = ['he','she','it','they','we','i','you','his','her','its','their','our','my','your','him','them','us','me','this','that','these','those','everyone','someone','nobody','anybody','everything','something','nothing','anything'];
const PREPOSITIONS = ['in','on','at','by','with','from','to','for','of','about','into','through','during','before','after','above','below','between','under','over','near','behind','beside','beyond','across','against','along','among','around','beneath','despite','down','inside','outside','past','throughout','towards','upon','within','without','up','off','out'];
const ARTICLES = ['the','a','an'];

/* Vocabulary thesaurus - basic -> ambitious -> sophisticated */
const THESAURUS = {
  'walked':   {basic:['went','moved','stepped'],ambitious:['strode','trudged','marched'],sophisticated:['ambled','sauntered','traversed']},
  'went':     {basic:['walked','moved','got'],ambitious:['travelled','headed','proceeded'],sophisticated:['ventured','journeyed','progressed']},
  'said':     {basic:['told','spoke','talked'],ambitious:['explained','announced','declared'],sophisticated:['articulated','proclaimed','remarked']},
  'nice':     {basic:['kind','good','fine'],ambitious:['pleasant','friendly','warm'],sophisticated:['gracious','amiable','genial']},
  'big':      {basic:['large','huge','tall'],ambitious:['enormous','massive','vast'],sophisticated:['immense','colossal','monumental']},
  'small':    {basic:['little','tiny','short'],ambitious:['compact','modest','slight'],sophisticated:['diminutive','minute','minuscule']},
  'happy':    {basic:['glad','pleased','cheerful'],ambitious:['delighted','thrilled','overjoyed'],sophisticated:['elated','euphoric','exuberant']},
  'sad':      {basic:['upset','unhappy','down'],ambitious:['miserable','gloomy','dejected'],sophisticated:['despondent','melancholy','forlorn']},
  'good':     {basic:['fine','okay','decent'],ambitious:['excellent','impressive','admirable'],sophisticated:['exceptional','exemplary','outstanding']},
  'bad':      {basic:['poor','wrong','awful'],ambitious:['dreadful','terrible','unpleasant'],sophisticated:['atrocious','abysmal','deplorable']},
  'scared':   {basic:['afraid','worried','nervous'],ambitious:['terrified','petrified','alarmed'],sophisticated:['apprehensive','trepidatious','horror-struck']},
  'nervous':  {basic:['worried','scared','uneasy'],ambitious:['anxious','apprehensive','tense'],sophisticated:['trepidatious','perturbed','disquieted']},
  'looked':   {basic:['saw','watched','stared'],ambitious:['gazed','observed','examined'],sophisticated:['scrutinised','surveyed','contemplated']},
  'got':      {basic:['had','took','found'],ambitious:['received','obtained','acquired'],sophisticated:['procured','attained','secured']},
  'ran':      {basic:['rushed','hurried','dashed'],ambitious:['sprinted','bolted','charged'],sophisticated:['hurtled','careered','barrelled']},
  'old':      {basic:['aged','worn','used'],ambitious:['ancient','weathered','decrepit'],sophisticated:['antiquated','venerable','archaic']},
  'new':      {basic:['fresh','recent','modern'],ambitious:['brand-new','pristine','novel'],sophisticated:['contemporary','innovative','unprecedented']},
  'dark':     {basic:['dim','black','unlit'],ambitious:['shadowy','gloomy','murky'],sophisticated:['tenebrous','stygian','crepuscular']},
  'light':    {basic:['bright','pale','fair'],ambitious:['luminous','radiant','brilliant'],sophisticated:['incandescent','resplendent','lambent']},
  'beautiful':{basic:['pretty','lovely','nice'],ambitious:['stunning','gorgeous','magnificent'],sophisticated:['resplendent','exquisite','sublime']},
  'interesting':{basic:['cool','fun','good'],ambitious:['fascinating','engaging','captivating'],sophisticated:['compelling','riveting','enthralling']},
  'boring':   {basic:['dull','plain','flat'],ambitious:['tedious','monotonous','dreary'],sophisticated:['laborious','insipid','soporific']},
  'very':     {basic:['really','quite','so'],ambitious:['extremely','incredibly','remarkably'],sophisticated:['exceedingly','extraordinarily','profoundly']},
  'slowly':   {basic:['gently','softly','calmly'],ambitious:['gradually','steadily','deliberately'],sophisticated:['languidly','lethargically','unhurriedly']},
  'quickly':  {basic:['fast','soon','rapidly'],ambitious:['swiftly','hastily','briskly'],sophisticated:['expeditiously','precipitously','instantaneously']},
  'house':    {basic:['home','place','building'],ambitious:['residence','dwelling','property'],sophisticated:['abode','domicile','edifice']},
  'long':     {basic:['big','far','tall'],ambitious:['extensive','lengthy','prolonged'],sophisticated:['interminable','protracted','expansive']},
  'busy':     {basic:['full','active','loud'],ambitious:['bustling','hectic','lively'],sophisticated:['teeming','frenetic','vivacious']},
  'found':    {basic:['got','saw','reached'],ambitious:['discovered','located','identified'],sophisticated:['unearthed','ascertained','pinpointed']},
  'smiled':   {basic:['grinned','laughed','beamed'],ambitious:['beamed','radiated warmth','brightened'],sophisticated:['emanated warmth','bestowed a grin','illuminated']},
  'felt':     {basic:['was','seemed','thought'],ambitious:['sensed','experienced','perceived'],sophisticated:['discerned','intuited','apprehended']},
  'talking':  {basic:['speaking','chatting','saying'],ambitious:['conversing','discussing','debating'],sophisticated:['deliberating','discoursing','conferring']},
  'hoped':    {basic:['wanted','wished','thought'],ambitious:['aspired','longed','yearned'],sophisticated:['harboured hope','coveted','anticipated']},
  'survived': {basic:['got through','managed','lasted'],ambitious:['endured','weathered','withstood'],sophisticated:['persevered through','prevailed over','surmounted']},
  'crouched': {basic:['sat','lay','rested'],ambitious:['huddled','squatted','hunched'],sophisticated:['hunkered','cowered','stooped']},
  'crawled':  {basic:['moved','spread','went'],ambitious:['crept','slithered','snaked'],sophisticated:['insinuated itself','proliferated','encroached']},
  'drifted':  {basic:['moved','floated','went'],ambitious:['glided','hovered','wandered'],sophisticated:['meandered','permeated','wafted']},
  'echoing':  {basic:['sounding','ringing','bouncing'],ambitious:['reverberating','resounding','resonating'],sophisticated:['reverberating','pulsating','cascading']},
  'approached':{basic:['went to','neared','came to'],ambitious:['advanced towards','drew near to','headed for'],sophisticated:['converged upon','gravitated towards','made one\'s way to']},
};

const PUNCTUATION_CYCLE = [', ', '; ', ' -- ', ': ', '. '];
const PUNCT_LABELS = ['comma','semicolon','dash','colon','full stop'];

let state = {
  originalText: '',
  sentences: [],       // [{text, opener, openerType, clauses, words}]
  activeSentence: -1,
  scores: {opener:0,length:0,vocab:0,punct:0,overall:0}
};

/* ═══════════════════════════════════════
   UTILITIES
   ═══════════════════════════════════════ */
function $(sel){return document.querySelector(sel)}
function $$(sel){return [...document.querySelectorAll(sel)]}
function toast(msg){
  const t=$('#toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}

function splitSentences(text){
  // Split on sentence-ending punctuation followed by space or end
  const raw = text.match(/[^.!?]*[.!?]+[\s]?/g) || [text];
  return raw.map(s=>s.trim()).filter(s=>s.length>0);
}

function classifyOpener(sentence){
  const s = sentence.trim().toLowerCase();
  const firstWord = s.split(/[\s,]+/)[0];
  const firstTwoWords = s.split(/[\s,]+/).slice(0,2).join(' ');
  // -ing opener
  if(firstWord.endsWith('ing') && firstWord.length > 3 && !PRONOUNS.includes(firstWord) && !CONJUNCTIONS.includes(firstWord))
    return 'ing';
  // Adverbial / subordinate clause opener
  if(ADVERBS_AND_ADVERBIALS.some(a => s.startsWith(a)))
    return 'adverbial';
  if(firstWord.endsWith('ly') && firstWord.length > 3)
    return 'adverbial';
  // Conjunction
  if(CONJUNCTIONS.includes(firstWord))
    return 'conjunction';
  // Prepositional
  if(PREPOSITIONS.includes(firstWord) && !['it','i'].includes(firstWord))
    return 'prepositional';
  // Article
  if(ARTICLES.includes(firstWord))
    return 'article';
  // Pronoun
  if(PRONOUNS.includes(firstWord))
    return 'pronoun';
  return 'unknown';
}

function splitClauses(sentence){
  // Split on commas, semicolons, dashes, colons -- keep delimiter with preceding clause
  const parts = [];
  let current = '';
  const chars = sentence.split('');
  for(let i=0;i<chars.length;i++){
    current += chars[i];
    if((chars[i]===',' || chars[i]===';' || chars[i]===':') && i<chars.length-1){
      parts.push(current.trim());
      current='';
    } else if(chars[i]==='-' && chars[i+1]==='-'){
      current += chars[i+1]; i++;
      parts.push(current.trim());
      current='';
    } else if(chars[i]===' ' && current.trim().length > 0){
      // check for ' and ' or ' but ' as clause boundary if clause is long enough
      const words = current.trim().split(/\s+/);
      const lastWord = words[words.length-1]?.toLowerCase();
      if(['and','but','yet','so','or'].includes(lastWord) && words.length > 4){
        parts.push(current.trim());
        current='';
      }
    }
  }
  if(current.trim()) parts.push(current.trim());
  return parts.length > 0 ? parts : [sentence];
}

function getWords(sentence){
  return sentence.split(/\s+/).filter(w=>w.length>0);
}

function lookupWord(word){
  const clean = word.toLowerCase().replace(/[^a-z'-]/g,'');
  return THESAURUS[clean] || null;
}

/* ═══════════════════════════════════════
   ANALYSIS & SCORING
   ═══════════════════════════════════════ */
function analyseParagraph(){
  const text = $('#inputText').value.trim();
  if(!text){toast('Please enter some text first.');return;}
  state.originalText = text;
  const rawSentences = splitSentences(text);
  state.sentences = rawSentences.map(s => {
    const type = classifyOpener(s);
    return {
      text: s,
      originalText: s,
      openerType: type,
      clauses: splitClauses(s),
      words: getWords(s)
    };
  });
  state.activeSentence = -1;
  renderWorkspace();
  updateScores();
  switchTab('workspace');
  toast('Paragraph analysed: ' + state.sentences.length + ' sentences found.');
}

function updateScores(){
  if(state.sentences.length === 0) return;
  // 1. Opener variety
  const types = state.sentences.map(s=>s.openerType);
  const uniqueTypes = new Set(types);
  const openerScore = Math.min(100, Math.round((uniqueTypes.size / Math.max(types.length, 1)) * 100 * 1.8));

  // 2. Sentence length variation
  const lengths = state.sentences.map(s=>s.text.split(/\s+/).length);
  const avgLen = lengths.reduce((a,b)=>a+b,0)/lengths.length;
  const variance = lengths.reduce((a,b)=>a+Math.pow(b-avgLen,2),0)/lengths.length;
  const stdDev = Math.sqrt(variance);
  const lengthScore = Math.min(100, Math.round(stdDev * 12));

  // 3. Vocabulary sophistication
  let totalWords=0, upgradedWords=0, sophisticatedWords=0;
  state.sentences.forEach(s=>{
    s.words.forEach(w=>{
      totalWords++;
      const clean = w.toLowerCase().replace(/[^a-z'-]/g,'');
      if(clean.length > 6) upgradedWords++;
      if(clean.length > 9) sophisticatedWords++;
    });
  });
  // Check for known upgraded words
  const allText = state.sentences.map(s=>s.text).join(' ').toLowerCase();
  let knownSoph = 0;
  Object.values(THESAURUS).forEach(t=>{
    t.sophisticated.forEach(w=>{
      if(allText.includes(w.toLowerCase())) knownSoph++;
    });
    t.ambitious.forEach(w=>{
      if(allText.includes(w.toLowerCase())) knownSoph += 0.5;
    });
  });
  const vocabScore = Math.min(100, Math.round(((upgradedWords/Math.max(totalWords,1))*80 + sophisticatedWords*3 + knownSoph*6)));

  // 4. Punctuation variety
  const fullText = state.sentences.map(s=>s.text).join(' ');
  const punctTypes = new Set();
  if(fullText.includes(',')) punctTypes.add('comma');
  if(fullText.includes(';')) punctTypes.add('semicolon');
  if(fullText.includes(':')) punctTypes.add('colon');
  if(fullText.includes('--') || fullText.includes('\u2014')) punctTypes.add('dash');
  if(fullText.includes('.')) punctTypes.add('period');
  if(fullText.includes('!')) punctTypes.add('exclamation');
  if(fullText.includes('?')) punctTypes.add('question');
  const punctScore = Math.min(100, Math.round(punctTypes.size / 5 * 100));

  const overall = Math.round((openerScore*0.3 + lengthScore*0.2 + vocabScore*0.3 + punctScore*0.2));

  state.scores = {opener:openerScore,length:lengthScore,vocab:vocabScore,punct:punctScore,overall};

  // Update UI
  $('#overallScore').textContent = overall;
  const circumference = 2 * Math.PI * 46; // ~289.03
  const offset = circumference - (overall/100) * circumference;
  $('#scoreRingFg').style.strokeDashoffset = offset;
  // color the ring
  if(overall >= 70) $('#scoreRingFg').style.stroke = '#4a9b8e';
  else if(overall >= 40) $('#scoreRingFg').style.stroke = '#d4a843';
  else $('#scoreRingFg').style.stroke = '#c47a7a';

  setScoreBar('scoreOpener','barOpener',openerScore);
  setScoreBar('scoreLength','barLength',lengthScore);
  setScoreBar('scoreVocab','barVocab',vocabScore);
  setScoreBar('scorePunct','barPunct',punctScore);

  updateTips();
  updateCompare();
}

function setScoreBar(labelId, barId, score){
  $(`#${labelId}`).textContent = score + '%';
  const bar = $(`#${barId}`);
  bar.style.width = score + '%';
  bar.className = 'score-bar-fill ' + (score >= 70 ? 'bar-high' : score >= 40 ? 'bar-mid' : 'bar-low');
}

function updateTips(){
  const tips = [];
  const s = state.scores;
  if(s.opener < 50){
    const counts = {};
    state.sentences.forEach(se=>{counts[se.openerType]=(counts[se.openerType]||0)+1});
    const most = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
    tips.push(`<strong>Opener Variety:</strong> Too many sentences start with ${OPENER_TYPES[most[0]].label} openers (${most[1]}/${state.sentences.length}). Try starting with an adverbial, -ing word, or prepositional phrase.`);
  }
  if(s.length < 40){
    tips.push(`<strong>Sentence Length:</strong> Your sentences are too similar in length. Mix short, punchy sentences with longer, more complex ones for rhythm and impact.`);
  }
  if(s.vocab < 40){
    tips.push(`<strong>Vocabulary:</strong> Click on common words in the workspace to discover more ambitious and sophisticated alternatives.`);
  }
  if(s.punct < 40){
    tips.push(`<strong>Punctuation:</strong> You mainly use full stops and commas. Try semicolons to link related ideas, colons to introduce explanations, or dashes for dramatic effect.`);
  }
  if(s.overall >= 70){
    tips.push(`<strong>Excellent work!</strong> This paragraph demonstrates strong variety in sentence structure, vocabulary, and punctuation. Keep refining!`);
  }
  $('#tipsArea').innerHTML = tips.length ? tips.map(t=>`<p style="margin-bottom:.5rem">${t}</p>`).join('') : '<p>Analyse a paragraph to receive targeted writing tips.</p>';
}

function updateCompare(){
  $('#originalText').innerHTML = state.originalText || 'No text analysed yet.';
  const modified = state.sentences.map(s=>s.text).join(' ');
  // Highlight differences
  if(modified !== state.originalText){
    $('#modifiedText').innerHTML = modified;
  } else {
    $('#modifiedText').innerHTML = modified || 'Make changes in the workspace to see them here.';
  }
}

/* ═══════════════════════════════════════
   RENDER WORKSPACE
   ═══════════════════════════════════════ */
function renderWorkspace(){
  const ws = $('#workspace');
  ws.innerHTML = '';
  if(state.sentences.length === 0) {
    ws.innerHTML = '<p style="color:var(--ink-light);font-style:italic;padding:2rem;text-align:center">Click <strong>Analyse Text</strong> to begin dissecting your paragraph.</p>';
    return;
  }

  // Update sentence count
  $('#sentenceCount').textContent = state.sentences.length + ' sentences';

  state.sentences.forEach((sent, idx) => {
    const block = document.createElement('div');
    block.className = `sentence-block ${OPENER_TYPES[sent.openerType]?.css || 'opener-unknown'} animate-in`;
    block.style.animationDelay = (idx * 0.06) + 's';
    block.dataset.idx = idx;
    block.draggable = true;

    const header = document.createElement('div');
    header.className = 'sentence-header';

    const handle = document.createElement('span');
    handle.className = 'drag-handle';
    handle.innerHTML = '&#9776;';
    handle.title = 'Drag to reorder';
    header.appendChild(handle);

    const tag = document.createElement('span');
    tag.className = 'opener-tag';
    const ot = OPENER_TYPES[sent.openerType] || OPENER_TYPES.unknown;
    tag.style.background = ot.bg;
    tag.style.color = ot.color;
    tag.textContent = ot.label;
    header.appendChild(tag);

    block.appendChild(header);

    // Sentence text with clickable words
    const textDiv = document.createElement('div');
    textDiv.className = 'sentence-text';
    renderClickableWords(textDiv, sent, idx);
    block.appendChild(textDiv);

    // Click to expand clauses
    if(state.activeSentence === idx){
      block.classList.add('active');
      const clauseEditor = createClauseEditor(sent, idx);
      block.appendChild(clauseEditor);
    }

    // Event: click to activate
    block.addEventListener('click', (e) => {
      if(e.target.classList.contains('clickable-word') || e.target.classList.contains('punct-btn') || e.target.classList.contains('punct-indicator') || e.target.classList.contains('drag-handle') || e.target.closest('.clause-editor')) return;
      state.activeSentence = state.activeSentence === idx ? -1 : idx;
      renderWorkspace();
    });

    // Drag events for sentence reordering
    block.addEventListener('dragstart', handleDragStart);
    block.addEventListener('dragend', handleDragEnd);
    block.addEventListener('dragover', handleDragOver);
    block.addEventListener('drop', handleDrop);
    block.addEventListener('dragleave', handleDragLeave);

    ws.appendChild(block);
  });

  renderOpenerLegend();
  updateScores();
}

function renderClickableWords(container, sent, sentIdx){
  const words = sent.text.split(/(\s+)/);
  words.forEach((token, wIdx) => {
    if(/^\s+$/.test(token)){
      container.appendChild(document.createTextNode(token));
      return;
    }
    // Check if this is a punctuation between clauses
    const cleanToken = token.replace(/[^a-zA-Z'-]/g,'').toLowerCase();

    const span = document.createElement('span');
    span.className = 'clickable-word';
    span.textContent = token;

    // If word has a thesaurus entry, make it clickable
    if(lookupWord(token)){
      span.title = 'Click to upgrade this word';
      span.addEventListener('click', (e) => {
        e.stopPropagation();
        openVocabPopup(token, sentIdx, wIdx);
      });
    }

    // Check if this word was upgraded from original
    if(sent.originalText){
      const origWords = sent.originalText.split(/(\s+)/);
      if(origWords[wIdx] && origWords[wIdx] !== token && !/^\s+$/.test(token)){
        span.classList.add('upgraded');
      }
    }

    container.appendChild(span);
  });
}

/* ─── CLAUSE EDITOR ─── */
function createClauseEditor(sent, sentIdx){
  const editor = document.createElement('div');
  editor.className = 'clause-editor';

  const label = document.createElement('div');
  label.style.cssText = 'font-size:.72rem;color:var(--ink-light);margin-bottom:.4rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em';
  label.textContent = 'Clause Reordering & Punctuation';
  editor.appendChild(label);

  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexWrap = 'wrap';
  container.style.alignItems = 'center';
  container.dataset.sentIdx = sentIdx;

  sent.clauses.forEach((clause, cIdx) => {
    const chip = document.createElement('span');
    chip.className = 'clause-chip';
    chip.draggable = true;
    chip.dataset.clauseIdx = cIdx;
    chip.dataset.sentIdx = sentIdx;
    chip.textContent = clause;

    chip.addEventListener('dragstart', handleClauseDragStart);
    chip.addEventListener('dragend', handleClauseDragEnd);
    chip.addEventListener('dragover', handleClauseDragOver);
    chip.addEventListener('drop', handleClauseDrop);

    container.appendChild(chip);

    // Add punctuation indicator between clauses (not after last)
    if(cIdx < sent.clauses.length - 1){
      const punct = document.createElement('span');
      punct.className = 'punct-indicator';
      punct.dataset.sentIdx = sentIdx;
      punct.dataset.afterClause = cIdx;
      // Detect current punctuation
      const currentPunct = detectTrailingPunct(clause);
      punct.textContent = currentPunct || ',';
      punct.title = 'Click to cycle punctuation: comma, semicolon, dash, colon, full stop';
      punct.addEventListener('click', (e) => {
        e.stopPropagation();
        cyclePunctuation(punct, sentIdx, cIdx);
      });
      container.appendChild(punct);
    }
  });

  editor.appendChild(container);
  return editor;
}

function detectTrailingPunct(clause){
  const trimmed = clause.trim();
  if(trimmed.endsWith(';')) return ';';
  if(trimmed.endsWith('--')) return '--';
  if(trimmed.endsWith(':')) return ':';
  if(trimmed.endsWith('.')) return '.';
  if(trimmed.endsWith(',')) return ',';
  return ',';
}

function cyclePunctuation(elem, sentIdx, clauseIdx){
  const cycle = [',', ';', ' --', ':', '.'];
  const display = [',', ';', '--', ':', '.'];
  const currentDisplay = elem.textContent.trim();
  let currentIdx = display.indexOf(currentDisplay);
  if(currentIdx === -1) currentIdx = 0;
  const nextIdx = (currentIdx + 1) % cycle.length;
  elem.textContent = display[nextIdx];
  elem.classList.add('pulse');
  setTimeout(()=>elem.classList.remove('pulse'), 300);

  // Update the clause text
  const sent = state.sentences[sentIdx];
  let clause = sent.clauses[clauseIdx];
  // Remove trailing punctuation
  clause = clause.replace(/[,;:\.]?\s*$/, '').replace(/\s*--\s*$/, '');
  // Add new punctuation
  if(cycle[nextIdx] === '.'){
    clause = clause.trim() + '.';
  } else {
    clause = clause.trim() + cycle[nextIdx];
  }
  sent.clauses[clauseIdx] = clause;
  rebuildSentenceFromClauses(sentIdx);
  updateScores();
  toast('Punctuation changed to ' + PUNCT_LABELS[nextIdx]);
}

function rebuildSentenceFromClauses(sentIdx){
  const sent = state.sentences[sentIdx];
  let text = sent.clauses.map(c => c.trim()).join(' ');
  // Clean up spacing issues
  text = text.replace(/\s+/g,' ').replace(/\s([,;:.])/g,'$1').trim();
  // Ensure capital first letter
  if(text.length > 0) text = text[0].toUpperCase() + text.slice(1);
  // Ensure ends with punctuation
  if(!/[.!?]$/.test(text)) text += '.';
  sent.text = text;
  sent.words = getWords(text);
  // Re-classify opener
  sent.openerType = classifyOpener(text);
}

/* ─── VOCABULARY POPUP ─── */
function openVocabPopup(word, sentIdx, wordIdx){
  const clean = word.replace(/[^a-zA-Z'-]/g,'');
  const entry = lookupWord(word);
  if(!entry) return;

  const trailingPunct = word.replace(clean, '').replace(/^[^a-zA-Z'-]+/,'');
  const leadingPunct = word.substring(0, word.indexOf(clean));

  $('#vocabOriginal').textContent = clean;
  const tiersDiv = $('#vocabTiers');
  tiersDiv.innerHTML = '';

  ['basic','ambitious','sophisticated'].forEach(tier => {
    const tierDiv = document.createElement('div');
    tierDiv.className = 'vocab-tier tier-' + tier;
    const labelDiv = document.createElement('div');
    labelDiv.className = 'vocab-tier-label';
    const stars = tier === 'basic' ? '\u2605' : tier === 'ambitious' ? '\u2605\u2605' : '\u2605\u2605\u2605';
    labelDiv.innerHTML = `${stars} ${tier.charAt(0).toUpperCase()+tier.slice(1)}`;
    tierDiv.appendChild(labelDiv);

    const wordsDiv = document.createElement('div');
    (entry[tier]||[]).forEach(alt => {
      const btn = document.createElement('span');
      btn.className = 'vocab-word';
      btn.textContent = alt;
      btn.addEventListener('click', () => {
        replaceWord(sentIdx, wordIdx, leadingPunct + alt + trailingPunct);
        closeVocabPopup();
        toast(`Upgraded "${clean}" to "${alt}"`);
      });
      wordsDiv.appendChild(btn);
    });
    tierDiv.appendChild(wordsDiv);
    tiersDiv.appendChild(tierDiv);
  });

  $('#vocabOverlay').classList.add('show');
}

function closeVocabPopup(){
  $('#vocabOverlay').classList.remove('show');
}

function replaceWord(sentIdx, wordIdx, newWord){
  const sent = state.sentences[sentIdx];
  const tokens = sent.text.split(/(\s+)/);
  if(tokens[wordIdx] !== undefined){
    // Preserve capitalisation if first word
    if(wordIdx === 0 && /^[A-Z]/.test(tokens[0])){
      newWord = newWord.charAt(0).toUpperCase() + newWord.slice(1);
    }
    tokens[wordIdx] = newWord;
    sent.text = tokens.join('');
    sent.words = getWords(sent.text);
    sent.clauses = splitClauses(sent.text);
    sent.openerType = classifyOpener(sent.text);
    renderWorkspace();
  }
}

/* ─── DRAG & DROP: SENTENCES ─── */
let dragSrcIdx = null;
function handleDragStart(e){
  const block = e.target.closest('.sentence-block');
  if(!block) return;
  dragSrcIdx = parseInt(block.dataset.idx);
  block.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', dragSrcIdx);
}
function handleDragEnd(e){
  $$('.sentence-block').forEach(b=>{b.classList.remove('dragging','drag-over')});
  dragSrcIdx = null;
}
function handleDragOver(e){
  e.preventDefault();
  const block = e.target.closest('.sentence-block');
  if(!block) return;
  const overIdx = parseInt(block.dataset.idx);
  if(overIdx !== dragSrcIdx){
    block.classList.add('drag-over');
  }
}
function handleDragLeave(e){
  const block = e.target.closest('.sentence-block');
  if(block) block.classList.remove('drag-over');
}
function handleDrop(e){
  e.preventDefault();
  const block = e.target.closest('.sentence-block');
  if(!block) return;
  const dropIdx = parseInt(block.dataset.idx);
  if(dragSrcIdx === null || dragSrcIdx === dropIdx) return;
  // Reorder
  const [moved] = state.sentences.splice(dragSrcIdx, 1);
  state.sentences.splice(dropIdx, 0, moved);
  state.activeSentence = -1;
  renderWorkspace();
  toast('Sentence moved');
}

/* ─── DRAG & DROP: CLAUSES ─── */
let clauseDragData = null;
function handleClauseDragStart(e){
  const chip = e.target.closest('.clause-chip');
  if(!chip) return;
  clauseDragData = {sentIdx: parseInt(chip.dataset.sentIdx), clauseIdx: parseInt(chip.dataset.clauseIdx)};
  chip.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', 'clause');
  e.stopPropagation();
}
function handleClauseDragEnd(e){
  $$('.clause-chip').forEach(c=>c.classList.remove('dragging'));
  clauseDragData = null;
}
function handleClauseDragOver(e){
  e.preventDefault();
  e.stopPropagation();
}
function handleClauseDrop(e){
  e.preventDefault();
  e.stopPropagation();
  const chip = e.target.closest('.clause-chip');
  if(!chip || !clauseDragData) return;
  const targetSentIdx = parseInt(chip.dataset.sentIdx);
  const targetClauseIdx = parseInt(chip.dataset.clauseIdx);
  if(clauseDragData.sentIdx !== targetSentIdx) return; // only within same sentence
  const sent = state.sentences[targetSentIdx];
  const [moved] = sent.clauses.splice(clauseDragData.clauseIdx, 1);
  sent.clauses.splice(targetClauseIdx, 0, moved);
  rebuildSentenceFromClauses(targetSentIdx);
  renderWorkspace();
  toast('Clause reordered');
}

/* ─── OPENER LEGEND ─── */
function renderOpenerLegend(){
  const counts = {};
  state.sentences.forEach(s=>{
    counts[s.openerType] = (counts[s.openerType]||0) + 1;
  });

  // Main legend
  const legend = $('#openerLegend');
  legend.innerHTML = '';
  Object.entries(OPENER_TYPES).forEach(([key, val]) => {
    if(!counts[key]) return;
    const item = document.createElement('span');
    item.className = 'legend-item';
    item.innerHTML = `<span class="legend-dot" style="background:${val.color}"></span>${val.label}: ${counts[key]}`;
    legend.appendChild(item);
  });

  // Side panel key
  const side = $('#openerKeySide');
  side.innerHTML = '';
  Object.entries(OPENER_TYPES).forEach(([key, val]) => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:.4rem;padding:.25rem 0;font-size:.78rem;border-bottom:1px solid var(--cream-dark)';
    const dot = document.createElement('span');
    dot.style.cssText = `width:12px;height:12px;border-radius:3px;background:${val.color};flex-shrink:0`;
    row.appendChild(dot);
    const label = document.createElement('span');
    label.style.color = val.color;
    label.style.fontWeight = '600';
    label.textContent = val.label;
    row.appendChild(label);
    const count = document.createElement('span');
    count.style.cssText = 'margin-left:auto;color:var(--ink-light)';
    count.textContent = counts[key] ? `${counts[key]} sentence${counts[key]>1?'s':''}` : '--';
    row.appendChild(count);
    side.appendChild(row);
  });
}

/* ═══════════════════════════════════════
   TAB SWITCHING
   ═══════════════════════════════════════ */
function switchTab(tabName){
  $$('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===tabName));
  $$('.tab-content').forEach(c=>c.classList.toggle('active', c.id === 'tab-'+tabName));
}

/* ═══════════════════════════════════════
   EVENT LISTENERS
   ═══════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', () => {
  // Tab buttons
  $$('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
  });

  // Analyse button
  $('#btnAnalyse').addEventListener('click', analyseParagraph);

  // Example buttons
  $$('[data-example]').forEach(btn => {
    btn.addEventListener('click', () => {
      $('#inputText').value = EXAMPLES[btn.dataset.example];
      toast('Example loaded: ' + btn.dataset.example + ' quality');
    });
  });

  // Compare button
  $('#btnCompare').addEventListener('click', () => {
    switchTab('compare');
    updateCompare();
  });

  // Reset button
  $('#btnReset').addEventListener('click', () => {
    if(state.sentences.length > 0 && state.originalText){
      $('#inputText').value = state.originalText;
      state.sentences = [];
      state.activeSentence = -1;
      state.scores = {opener:0,length:0,vocab:0,punct:0,overall:0};
      renderWorkspace();
      // Reset scores display
      $('#overallScore').textContent = '--';
      $('#scoreRingFg').style.strokeDashoffset = 289.03;
      ['scoreOpener','scoreLength','scoreVocab','scorePunct'].forEach(id=>{
        $(`#${id}`).textContent = '--';
      });
      ['barOpener','barLength','barVocab','barPunct'].forEach(id=>{
        $(`#${id}`).style.width = '0';
      });
      $('#tipsArea').innerHTML = 'Analyse a paragraph to receive targeted writing tips.';
      switchTab('input');
      toast('Reset complete');
    }
  });

  // Vocab popup close
  $('#vocabClose').addEventListener('click', closeVocabPopup);
  $('#vocabOverlay').addEventListener('click', (e) => {
    if(e.target === $('#vocabOverlay')) closeVocabPopup();
  });

  // Keyboard shortcut: Escape to close popup
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') closeVocabPopup();
    // Ctrl+Enter to analyse
    if(e.key === 'Enter' && e.ctrlKey) analyseParagraph();
  });

  // Render opener legend placeholder
  renderOpenerLegend();
});
</script>
</body>
</html>
