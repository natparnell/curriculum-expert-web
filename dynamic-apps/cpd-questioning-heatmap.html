<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Questioning Distribution Heatmap - CPD Tool</title>
<style>
  :root {
    --primary: #5b21b6;
    --primary-light: #7c3aed;
    --primary-lighter: #a78bfa;
    --primary-dark: #3b0764;
    --accent: #4f46e5;
    --accent-light: #818cf8;
    --surface: #faf9ff;
    --surface-2: #f3f0ff;
    --surface-3: #ede9fe;
    --border: #ddd6fe;
    --border-strong: #c4b5fd;
    --text-primary: #1e1b4b;
    --text-secondary: #4c3b8a;
    --text-muted: #7c6faa;
    --text-light: #a397c7;
    --white: #ffffff;
    --success: #059669;
    --success-light: #d1fae5;
    --warning: #d97706;
    --warning-light: #fef3c7;
    --danger: #dc2626;
    --danger-light: #fee2e2;
    --cold-0: #e0f2fe;
    --cold-1: #7dd3fc;
    --warm-1: #fde68a;
    --warm-2: #fbbf24;
    --hot-1: #f97316;
    --hot-2: #dc2626;
    --shadow-sm: 0 1px 3px rgba(91,33,182,0.08);
    --shadow: 0 4px 12px rgba(91,33,182,0.12);
    --shadow-lg: 0 8px 24px rgba(91,33,182,0.16);
    --radius-sm: 6px;
    --radius: 10px;
    --radius-lg: 16px;
    --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: var(--surface);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* HEADER */
  .app-header {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 60%, var(--accent) 100%);
    color: var(--white);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow-lg);
    flex-wrap: wrap;
  }
  .app-header-icon {
    width: 44px; height: 44px;
    background: rgba(255,255,255,0.15);
    border-radius: var(--radius);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem;
    flex-shrink: 0;
  }
  .app-header-text { flex: 1; min-width: 180px; }
  .app-header-text h1 { font-size: 1.2rem; font-weight: 700; letter-spacing: -0.01em; }
  .app-header-text p { font-size: 0.78rem; opacity: 0.82; margin-top: 1px; }
  .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .btn {
    display: inline-flex; align-items: center; gap: 0.35rem;
    padding: 0.45rem 0.9rem;
    border-radius: var(--radius-sm);
    border: none; cursor: pointer;
    font-family: var(--font); font-size: 0.8rem; font-weight: 600;
    transition: all 0.15s ease;
    text-decoration: none; line-height: 1.4;
  }
  .btn:active { transform: scale(0.97); }
  .btn-ghost {
    background: rgba(255,255,255,0.15);
    color: var(--white);
    border: 1px solid rgba(255,255,255,0.25);
  }
  .btn-ghost:hover { background: rgba(255,255,255,0.25); }
  .btn-primary {
    background: var(--primary-light);
    color: var(--white);
  }
  .btn-primary:hover { background: var(--primary); }
  .btn-danger {
    background: var(--danger-light);
    color: var(--danger);
  }
  .btn-danger:hover { background: #fecaca; }
  .btn-success {
    background: var(--success-light);
    color: var(--success);
  }
  .btn-success:hover { background: #a7f3d0; }
  .btn-outline {
    background: var(--white);
    color: var(--primary);
    border: 1.5px solid var(--border-strong);
  }
  .btn-outline:hover { background: var(--surface-3); }

  /* MAIN LAYOUT */
  .app-body {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.25rem;
    padding: 1.25rem;
    max-width: 1300px;
    margin: 0 auto;
  }

  /* LEFT COLUMN */
  .classroom-column { display: flex; flex-direction: column; gap: 1.25rem; }

  /* RIGHT COLUMN */
  .stats-column { display: flex; flex-direction: column; gap: 1.25rem; }

  /* CARDS */
  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .card-header {
    padding: 0.85rem 1.1rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface-2);
    display: flex; align-items: center; gap: 0.5rem;
  }
  .card-header h2 { font-size: 0.88rem; font-weight: 700; color: var(--primary); }
  .card-header .badge {
    margin-left: auto;
    font-size: 0.7rem; font-weight: 600;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    background: var(--surface-3);
    color: var(--primary);
  }
  .card-body { padding: 1rem 1.1rem; }

  /* TOOLBAR */
  .toolbar {
    display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap;
  }
  .toolbar-label {
    font-size: 0.75rem; font-weight: 600;
    color: var(--text-secondary);
    white-space: nowrap;
  }
  .layout-btn {
    padding: 0.35rem 0.7rem;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border-strong);
    background: var(--white);
    color: var(--text-secondary);
    font-size: 0.75rem; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
  }
  .layout-btn:hover { border-color: var(--primary-lighter); color: var(--primary); }
  .layout-btn.active { background: var(--primary); color: var(--white); border-color: var(--primary); }
  .sep { width: 1px; height: 24px; background: var(--border); }

  /* GENDER TOGGLE */
  .gender-pill {
    display: inline-flex; border-radius: 999px;
    border: 1.5px solid var(--border-strong);
    overflow: hidden; font-size: 0.72rem;
  }
  .gender-pill button {
    padding: 0.25rem 0.55rem;
    border: none; background: var(--white);
    cursor: pointer; font-size: 0.72rem; font-weight: 600;
    color: var(--text-muted); transition: all 0.12s;
    font-family: var(--font);
  }
  .gender-pill button.active { background: var(--primary); color: var(--white); }
  .gender-pill button:hover:not(.active) { background: var(--surface-3); }

  /* CLASSROOM AREA */
  .classroom-wrapper {
    position: relative;
    padding: 1rem;
  }
  .teacher-desk {
    display: flex; align-items: center; justify-content: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    color: var(--white);
    border-radius: var(--radius);
    padding: 0.6rem 1rem;
    margin-bottom: 1.25rem;
    font-size: 0.82rem; font-weight: 600;
    letter-spacing: 0.02em;
    box-shadow: var(--shadow);
  }
  .teacher-desk .desk-icon { font-size: 1.1rem; }

  /* SEAT GRID */
  #seat-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
    min-height: 280px;
    transition: all 0.3s ease;
  }
  .seat-row {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  /* SEAT */
  .seat {
    width: 72px; height: 72px;
    border-radius: var(--radius);
    border: 2px solid var(--border-strong);
    cursor: pointer;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: all 0.2s ease;
    position: relative;
    user-select: none;
    background: var(--cold-0);
    box-shadow: var(--shadow-sm);
  }
  .seat:hover { transform: translateY(-2px) scale(1.04); box-shadow: var(--shadow); border-color: var(--primary-lighter); }
  .seat.empty-slot { visibility: hidden; cursor: default; }
  .seat.cold-spot { box-shadow: 0 0 0 3px #7dd3fc, var(--shadow); animation: pulse-cold 2s infinite; }
  @keyframes pulse-cold {
    0%, 100% { box-shadow: 0 0 0 3px #7dd3fc, var(--shadow); }
    50% { box-shadow: 0 0 0 6px #bae6fd, var(--shadow); }
  }
  .seat .seat-count {
    font-size: 1.3rem; font-weight: 800;
    line-height: 1; color: inherit;
  }
  .seat .seat-name {
    font-size: 0.6rem; font-weight: 600;
    text-align: center; line-height: 1.2;
    color: inherit; max-width: 64px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    padding: 0 2px;
  }
  .seat .seat-gender {
    position: absolute; top: 3px; right: 4px;
    font-size: 0.6rem; font-weight: 700;
    opacity: 0.7;
  }
  .seat .seat-cold-icon {
    position: absolute; bottom: 2px; right: 3px;
    font-size: 0.65rem;
  }
  /* U-shape specific */
  .seat-row.u-gap { gap: 90px; }
  .seat-row.u-row-end { justify-content: space-between; width: 100%; max-width: 540px; }
  /* Groups of 4 */
  .groups-wrapper { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
  .group-of-4 {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 10px;
    border: 2px dashed var(--border-strong);
    border-radius: var(--radius);
    background: var(--surface-2);
  }

  /* HEATMAP LEGEND */
  .legend {
    display: flex; align-items: center; gap: 0.5rem;
    flex-wrap: wrap;
  }
  .legend-label { font-size: 0.72rem; color: var(--text-muted); font-weight: 600; }
  .legend-scale {
    display: flex; border-radius: 999px; overflow: hidden;
    height: 14px; flex: 1; min-width: 120px; max-width: 200px;
    border: 1px solid var(--border);
  }
  .legend-scale div { flex: 1; }
  .legend-ticks { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-light); min-width: 120px; max-width: 200px; }

  /* STAT CARDS */
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; }
  .stat-item {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.7rem 0.8rem;
    text-align: center;
  }
  .stat-value { font-size: 1.6rem; font-weight: 800; color: var(--primary); line-height: 1; }
  .stat-label { font-size: 0.68rem; color: var(--text-muted); font-weight: 600; margin-top: 0.2rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .stat-item.full { grid-column: 1 / -1; }
  .stat-name { font-size: 0.8rem; font-weight: 700; color: var(--text-primary); }
  .stat-sub { font-size: 0.68rem; color: var(--text-muted); }

  /* EQUITY SCORE */
  .equity-bar-wrap { margin-top: 0.5rem; }
  .equity-bar-track {
    height: 10px; background: var(--surface-3);
    border-radius: 999px; overflow: hidden;
    border: 1px solid var(--border);
  }
  .equity-bar-fill {
    height: 100%; border-radius: 999px;
    transition: width 0.4s ease, background 0.4s;
    background: var(--success);
  }
  .equity-score-label {
    display: flex; justify-content: space-between;
    font-size: 0.72rem; margin-top: 0.3rem;
    color: var(--text-muted);
  }
  .equity-val { font-weight: 700; color: var(--text-primary); }

  /* GENDER BREAKDOWN */
  .gender-bar-wrap { display: flex; flex-direction: column; gap: 0.4rem; margin-top: 0.3rem; }
  .gender-row { display: flex; align-items: center; gap: 0.5rem; }
  .gender-row-label { font-size: 0.72rem; font-weight: 600; color: var(--text-secondary); width: 40px; }
  .gender-track { flex: 1; height: 8px; background: var(--surface-3); border-radius: 999px; overflow: hidden; }
  .gender-fill { height: 100%; border-radius: 999px; transition: width 0.4s; }
  .gender-fill.m { background: #60a5fa; }
  .gender-fill.f { background: #f472b6; }
  .gender-fill.o { background: #a78bfa; }
  .gender-count { font-size: 0.7rem; color: var(--text-muted); width: 50px; text-align: right; }

  /* ALERTS */
  .alert-list { display: flex; flex-direction: column; gap: 0.4rem; }
  .alert-item {
    display: flex; gap: 0.5rem; align-items: flex-start;
    padding: 0.5rem 0.65rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem; line-height: 1.4;
  }
  .alert-item.cold { background: #e0f2fe; color: #0369a1; border-left: 3px solid #38bdf8; }
  .alert-item.warn { background: var(--warning-light); color: #92400e; border-left: 3px solid var(--warning); }
  .alert-item.ok { background: var(--success-light); color: #065f46; border-left: 3px solid var(--success); }
  .alert-icon { font-size: 0.85rem; flex-shrink: 0; margin-top: 1px; }
  .no-alerts { font-size: 0.78rem; color: var(--text-muted); text-align: center; padding: 0.5rem; }

  /* RESEARCH PANEL */
  .research-accordion { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .acc-item { border-bottom: 1px solid var(--border); }
  .acc-item:last-child { border-bottom: none; }
  .acc-trigger {
    width: 100%; padding: 0.65rem 0.85rem;
    background: var(--surface-2); border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: space-between;
    font-family: var(--font); font-size: 0.78rem; font-weight: 600;
    color: var(--text-secondary); text-align: left;
    transition: background 0.15s;
  }
  .acc-trigger:hover { background: var(--surface-3); }
  .acc-trigger.open { color: var(--primary); background: var(--surface-3); }
  .acc-chevron { font-size: 0.7rem; transition: transform 0.2s; }
  .acc-trigger.open .acc-chevron { transform: rotate(180deg); }
  .acc-body {
    display: none; padding: 0.75rem 0.85rem;
    font-size: 0.75rem; line-height: 1.65; color: var(--text-secondary);
    background: var(--white);
  }
  .acc-body.open { display: block; }
  .acc-body ul { padding-left: 1.1rem; }
  .acc-body ul li { margin-bottom: 0.35rem; }
  .acc-body strong { color: var(--primary); }

  /* EXPORT MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(30,27,75,0.55); backdrop-filter: blur(4px);
    z-index: 1000; align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--white); border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: 1.5rem; max-width: 560px; width: 90%;
    max-height: 85vh; overflow-y: auto;
  }
  .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
  .modal-header h3 { font-size: 1rem; font-weight: 700; color: var(--primary); }
  .modal-close {
    background: none; border: none; font-size: 1.2rem; cursor: pointer;
    color: var(--text-muted); padding: 0.2rem 0.4rem; border-radius: var(--radius-sm);
  }
  .modal-close:hover { background: var(--surface-3); }
  .export-text {
    font-family: 'Courier New', monospace; font-size: 0.72rem;
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 0.85rem;
    white-space: pre-wrap; line-height: 1.7;
    color: var(--text-primary); max-height: 400px; overflow-y: auto;
  }
  .modal-footer { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }

  /* NAME MODAL */
  .name-modal {
    background: var(--white); border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: 1.25rem; max-width: 340px; width: 90%;
  }
  .name-modal h3 { font-size: 0.95rem; font-weight: 700; color: var(--primary); margin-bottom: 0.75rem; }
  .name-input-wrap { margin-bottom: 0.75rem; }
  .name-input-wrap label { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.3rem; }
  .name-input-wrap input {
    width: 100%; padding: 0.5rem 0.7rem;
    border: 1.5px solid var(--border-strong); border-radius: var(--radius-sm);
    font-family: var(--font); font-size: 0.85rem; color: var(--text-primary);
    outline: none;
  }
  .name-input-wrap input:focus { border-color: var(--primary-lighter); box-shadow: 0 0 0 3px rgba(167,139,250,0.2); }

  /* UNDO TOAST */
  .toast {
    position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
    background: var(--primary-dark); color: var(--white);
    padding: 0.6rem 1.2rem; border-radius: 999px;
    font-size: 0.8rem; font-weight: 600;
    box-shadow: var(--shadow-lg); z-index: 2000;
    display: none; align-items: center; gap: 0.6rem;
    white-space: nowrap;
  }
  .toast.show { display: flex; animation: toast-in 0.25s ease; }
  @keyframes toast-in { from { opacity: 0; transform: translateX(-50%) translateY(8px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
  .toast-undo {
    background: rgba(255,255,255,0.2); border: none; color: var(--white);
    font-size: 0.75rem; font-weight: 700; cursor: pointer;
    padding: 0.2rem 0.5rem; border-radius: 999px; font-family: var(--font);
  }
  .toast-undo:hover { background: rgba(255,255,255,0.35); }

  /* UNDO HISTORY indicator */
  .undo-hint { font-size: 0.68rem; color: var(--text-light); }

  /* RESPONSIVE */
  @media (max-width: 900px) {
    .app-body { grid-template-columns: 1fr; }
    .stats-column { order: -1; }
    .stat-grid { grid-template-columns: repeat(4, 1fr); }
  }
  @media (max-width: 768px) {
    .app-header { padding: 0.85rem 1rem; }
    .app-body { padding: 0.75rem; gap: 0.75rem; }
    .seat { width: 58px; height: 58px; }
    .stat-grid { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 480px) {
    .seat { width: 48px; height: 48px; }
    .seat .seat-count { font-size: 1rem; }
    .seat .seat-name { font-size: 0.55rem; }
    .header-actions { width: 100%; }
  }

  /* Utility */
  .divider { height: 1px; background: var(--border); margin: 0.6rem 0; }
  .text-xs { font-size: 0.72rem; }
  .text-muted { color: var(--text-muted); }
  .fw-bold { font-weight: 700; }
  .mt-2 { margin-top: 0.5rem; }
  .flex-center { display: flex; align-items: center; justify-content: center; }
  .gap-2 { gap: 0.5rem; }
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div class="app-header-icon">&#128101;</div>
  <div class="app-header-text">
    <h1>Questioning Distribution Heatmap</h1>
    <p>CPD tool: click seats to record questions and reveal cold spots and bias in questioning patterns</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-ghost" id="undo-btn" onclick="undoLast()" title="Undo last click (Ctrl+Z)">&#8617; Undo</button>
    <button class="btn btn-ghost" onclick="openExport()">&#128196; Export</button>
    <button class="btn btn-ghost" id="reset-btn" onclick="confirmReset()">&#128260; Reset</button>
  </div>
</header>

<!-- MAIN BODY -->
<div class="app-body">

  <!-- LEFT: CLASSROOM -->
  <div class="classroom-column">

    <!-- TOOLBAR -->
    <div class="card">
      <div class="card-body" style="padding:0.7rem 1rem;">
        <div class="toolbar">
          <span class="toolbar-label">Layout:</span>
          <button class="layout-btn active" id="layout-rows" onclick="setLayout('rows')">&#9636; Rows</button>
          <button class="layout-btn" id="layout-u" onclick="setLayout('u')">&#8991; Horseshoe</button>
          <button class="layout-btn" id="layout-groups" onclick="setLayout('groups')">&#9638; Groups of 4</button>
          <div class="sep"></div>
          <span class="toolbar-label">Mark gender:</span>
          <div class="gender-pill">
            <button id="gmode-none" class="active" onclick="setGenderMode(null)">Off</button>
            <button id="gmode-M" onclick="setGenderMode('M')">M</button>
            <button id="gmode-F" onclick="setGenderMode('F')">F</button>
            <button id="gmode-O" onclick="setGenderMode('O')">Other</button>
          </div>
          <span class="undo-hint" id="undo-hint"></span>
        </div>
      </div>
    </div>

    <!-- CLASSROOM -->
    <div class="card">
      <div class="card-header">
        <span>&#127979;</span>
        <h2>Classroom View</h2>
        <span class="badge" id="mode-badge">Click to record question</span>
      </div>
      <div class="card-body classroom-wrapper">
        <div class="teacher-desk">
          <span class="desk-icon">&#127979;</span>
          TEACHER'S DESK (FRONT OF ROOM)
        </div>
        <div id="seat-container"></div>
        <!-- Legend -->
        <div style="margin-top:1rem;">
          <div class="legend">
            <span class="legend-label">None</span>
            <div class="legend-scale" id="legend-scale"></div>
            <span class="legend-label" id="legend-max-label">Max</span>
          </div>
          <div class="legend-ticks" style="margin-left:2.8rem; margin-top:2px;" id="legend-ticks"></div>
        </div>
        <p style="font-size:0.7rem; color:var(--text-light); margin-top:0.5rem; text-align:center;">
          Right-click or long-press a seat to assign a pupil name. Click to record a question.
        </p>
      </div>
    </div>

  </div>

  <!-- RIGHT: STATS -->
  <div class="stats-column">

    <!-- LIVE STATS -->
    <div class="card">
      <div class="card-header"><span>&#128200;</span><h2>Live Statistics</h2></div>
      <div class="card-body">
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Total Questions</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-coverage">0%</div>
            <div class="stat-label">Coverage</div>
          </div>
          <div class="stat-item full" id="stat-most-wrap">
            <div class="stat-label">Most Questioned</div>
            <div class="stat-name" id="stat-most">-</div>
            <div class="stat-sub" id="stat-most-sub"></div>
          </div>
          <div class="stat-item full" id="stat-least-wrap">
            <div class="stat-label">Least Questioned (asked)</div>
            <div class="stat-name" id="stat-least">-</div>
            <div class="stat-sub" id="stat-least-sub"></div>
          </div>
        </div>
        <div class="divider"></div>
        <!-- EQUITY SCORE -->
        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.4rem;">
            <span style="font-size:0.78rem; font-weight:700; color:var(--text-secondary);">Equity Score</span>
            <span style="font-size:0.68rem; color:var(--text-muted);">based on distribution evenness</span>
          </div>
          <div class="equity-bar-wrap">
            <div class="equity-bar-track">
              <div class="equity-bar-fill" id="equity-bar" style="width:0%;"></div>
            </div>
            <div class="equity-score-label">
              <span>Uneven</span>
              <span class="equity-val" id="equity-val">-</span>
              <span>Even</span>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <!-- GENDER BREAKDOWN -->
        <div>
          <div style="font-size:0.78rem; font-weight:700; color:var(--text-secondary); margin-bottom:0.5rem;">Gender Breakdown</div>
          <div class="gender-bar-wrap" id="gender-bars">
            <div class="gender-row">
              <span class="gender-row-label">M</span>
              <div class="gender-track"><div class="gender-fill m" id="gbar-m" style="width:0%;"></div></div>
              <span class="gender-count" id="gcnt-m">0 (0%)</span>
            </div>
            <div class="gender-row">
              <span class="gender-row-label">F</span>
              <div class="gender-track"><div class="gender-fill f" id="gbar-f" style="width:0%;"></div></div>
              <span class="gender-count" id="gcnt-f">0 (0%)</span>
            </div>
            <div class="gender-row">
              <span class="gender-row-label">Other</span>
              <div class="gender-track"><div class="gender-fill o" id="gbar-o" style="width:0%;"></div></div>
              <span class="gender-count" id="gcnt-o">0 (0%)</span>
            </div>
          </div>
          <p style="font-size:0.68rem; color:var(--text-light); margin-top:0.35rem;">Mark gender using the toolbar above, then question data is split by gender.</p>
        </div>
      </div>
    </div>

    <!-- ALERTS -->
    <div class="card">
      <div class="card-header"><span>&#9888;&#65039;</span><h2>Alerts</h2></div>
      <div class="card-body">
        <div class="alert-list" id="alert-list">
          <p class="no-alerts">Ask some questions to see alerts.</p>
        </div>
      </div>
    </div>

    <!-- RESEARCH -->
    <div class="card">
      <div class="card-header"><span>&#128218;</span><h2>Research &amp; Guidance</h2></div>
      <div class="card-body" style="padding:0.6rem;">
        <div class="research-accordion">
          <div class="acc-item">
            <button class="acc-trigger" onclick="toggleAcc(this)">
              Why equitable questioning matters
              <span class="acc-chevron">&#9660;</span>
            </button>
            <div class="acc-body">
              Research consistently shows that teachers unconsciously favour certain pupils when asking questions. Studies by Good &amp; Brophy (1987) and later work by Black &amp; Wiliam (1998) found that:
              <ul>
                <li>High-attaining pupils are called on <strong>up to 3x more often</strong> than lower-attaining peers.</li>
                <li>Boys receive more questions than girls in many classrooms, particularly in STEM subjects.</li>
                <li>Pupils seated near the front and centre receive disproportionately more questions.</li>
                <li>This creates a self-reinforcing cycle: un-questioned pupils disengage further.</li>
              </ul>
            </div>
          </div>
          <div class="acc-item">
            <button class="acc-trigger" onclick="toggleAcc(this)">
              Cold-calling strategies
              <span class="acc-chevron">&#9660;</span>
            </button>
            <div class="acc-body">
              <ul>
                <li><strong>Lolly sticks / random name generators:</strong> remove teacher bias entirely by selecting pupils randomly.</li>
                <li><strong>Think-Pair-Share:</strong> all pupils formulate an answer before anyone is called upon.</li>
                <li><strong>No hands up:</strong> teacher nominates rather than accepting volunteers, ensuring broad coverage.</li>
                <li><strong>Pose-Pause-Pounce-Bounce:</strong> pose question, allow wait time, select a pupil, then bounce to another.</li>
                <li><strong>Mini whiteboards:</strong> all pupils respond simultaneously, making gaps immediately visible.</li>
              </ul>
            </div>
          </div>
          <div class="acc-item">
            <button class="acc-trigger" onclick="toggleAcc(this)">
              Gender and attainment bias
              <span class="acc-chevron">&#9660;</span>
            </button>
            <div class="acc-body">
              <ul>
                <li>Research by Myhill &amp; Dunkin (2005) found boys received <strong>more disciplinary questions</strong> and more closed questions.</li>
                <li>Girls may be asked more procedural questions; boys more conceptual or challenging ones.</li>
                <li>Pupil premium and SEND pupils are at risk of receiving fewer higher-order questions.</li>
                <li>Use this heatmap to notice if any gender grouping is consistently in the cold spots.</li>
                <li>Aim for parity in both quantity <strong>and quality</strong> of questions across groups.</li>
              </ul>
            </div>
          </div>
          <div class="acc-item">
            <button class="acc-trigger" onclick="toggleAcc(this)">
              Understanding the equity score
              <span class="acc-chevron">&#9660;</span>
            </button>
            <div class="acc-body">
              The equity score is calculated using the <strong>Gini coefficient</strong> inverted: 0% means one pupil receives all questions; 100% means perfectly even distribution. Aim for above <strong>70%</strong> in a typical lesson. Below 50% indicates significant concentration of questioning. Cold spots highlight rows or sections with below-average questioning rates by a significant margin.
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="export-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>&#128196; Session Summary Export</h3>
      <button class="modal-close" onclick="closeExport()">&#10005;</button>
    </div>
    <pre class="export-text" id="export-content"></pre>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="copyExport()">&#128203; Copy to clipboard</button>
      <button class="btn btn-outline" onclick="closeExport()">Close</button>
    </div>
  </div>
</div>

<!-- NAME MODAL -->
<div class="modal-overlay" id="name-modal">
  <div class="name-modal">
    <h3>&#9998; Assign Pupil Name</h3>
    <div class="name-input-wrap">
      <label for="name-input">Pupil name (optional)</label>
      <input type="text" id="name-input" placeholder="e.g. Alex, Seat 3A" maxlength="30" autocomplete="off" />
    </div>
    <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
      <button class="btn btn-outline" onclick="closeNameModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveName()">Save</button>
    </div>
  </div>
</div>

<!-- UNDO TOAST -->
<div class="toast" id="toast">
  <span id="toast-msg">Question removed</span>
  <button class="toast-undo" onclick="undoLast()">Undo</button>
</div>

<script>
// =====================
// STATE
// =====================
const ROWS = 5;
const COLS = 6;
const TOTAL_SEATS = ROWS * COLS;

let seats = [];           // { id, count, name, gender }
let history = [];         // stack of { seatId } for undo
let currentLayout = 'rows';
let genderMode = null;    // null | 'M' | 'F' | 'O'
let pendingNameSeatId = null;
let longPressTimer = null;
let toastTimer = null;

// =====================
// INIT
// =====================
function initSeats() {
  seats = [];
  for (let i = 0; i < TOTAL_SEATS; i++) {
    seats.push({ id: i, count: 0, name: '', gender: null });
  }
  history = [];
  render();
  updateStats();
}

// =====================
// HEATMAP COLOUR
// =====================
function getHeatColour(count, maxCount) {
  if (maxCount === 0 || count === 0) return { bg: '#e0f2fe', text: '#374151', border: '#bae6fd' };
  const t = count / maxCount;
  // Blue -> Yellow -> Red gradient
  let r, g, b;
  if (t < 0.25) {
    const s = t / 0.25;
    r = Math.round(125 + s * (253 - 125));
    g = Math.round(211 + s * (224 - 211));
    b = Math.round(252 + s * (71 - 252));
  } else if (t < 0.5) {
    const s = (t - 0.25) / 0.25;
    r = Math.round(253 + s * (251 - 253));
    g = Math.round(224 + s * (191 - 224));
    b = Math.round(71 + s * (36 - 71));
  } else if (t < 0.75) {
    const s = (t - 0.5) / 0.25;
    r = Math.round(251 + s * (249 - 251));
    g = Math.round(191 + s * (115 - 191));
    b = Math.round(36 + s * (22 - 36));
  } else {
    const s = (t - 0.75) / 0.25;
    r = Math.round(249 + s * (220 - 249));
    g = Math.round(115 + s * (38 - 115));
    b = Math.round(22 + s * (38 - 22));
  }
  const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
  const text = brightness > 155 ? '#1e1b4b' : '#ffffff';
  const border = `rgb(${Math.max(0, r-30)},${Math.max(0, g-30)},${Math.max(0, b-30)})`;
  return { bg: `rgb(${r},${g},${b})`, text, border };
}

// =====================
// COLD SPOT DETECTION
// =====================
function getColdSpots() {
  const totalQ = seats.reduce((a, s) => a + s.count, 0);
  if (totalQ < 5) return { coldSeats: new Set(), coldRows: [] };
  const avgPerSeat = totalQ / TOTAL_SEATS;
  const rowAvgs = [];
  for (let r = 0; r < ROWS; r++) {
    const rowSeats = seats.slice(r * COLS, (r + 1) * COLS);
    const rowTotal = rowSeats.reduce((a, s) => a + s.count, 0);
    rowAvgs.push({ row: r, avg: rowTotal / COLS, total: rowTotal });
  }
  const overallRowAvg = rowAvgs.reduce((a, r) => a + r.avg, 0) / ROWS;
  const coldRows = rowAvgs.filter(r => r.avg < overallRowAvg * 0.5 && overallRowAvg > 0.5).map(r => r.row);
  const coldSeats = new Set();
  seats.forEach(s => {
    if (s.count === 0 && avgPerSeat > 1) coldSeats.add(s.id);
  });
  return { coldSeats, coldRows, rowAvgs, overallRowAvg };
}

// =====================
// GINI COEFFICIENT
// =====================
function computeGini(counts) {
  const n = counts.length;
  if (n === 0) return 0;
  const sorted = [...counts].sort((a, b) => a - b);
  const total = sorted.reduce((a, v) => a + v, 0);
  if (total === 0) return 1; // perfectly even (all zero)
  let sumOfDiffs = 0;
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < n; j++) {
      sumOfDiffs += Math.abs(sorted[i] - sorted[j]);
    }
  }
  const gini = sumOfDiffs / (2 * n * total);
  return 1 - gini; // invert: 1 = even, 0 = concentrated
}

// =====================
// RENDER
// =====================
function render() {
  const container = document.getElementById('seat-container');
  container.innerHTML = '';
  const maxCount = Math.max(...seats.map(s => s.count), 1);
  const { coldSeats, coldRows } = getColdSpots();

  if (currentLayout === 'rows') {
    renderRows(container, maxCount, coldSeats, coldRows);
  } else if (currentLayout === 'u') {
    renderU(container, maxCount, coldSeats, coldRows);
  } else {
    renderGroups(container, maxCount, coldSeats, coldRows);
  }
  updateLegend(maxCount);
}

function makeSeatEl(seat, maxCount, coldSeats) {
  const colours = getHeatColour(seat.count, maxCount);
  const isCold = coldSeats.has(seat.id) && seat.count === 0;
  const el = document.createElement('div');
  el.className = 'seat' + (isCold ? ' cold-spot' : '');
  el.dataset.id = seat.id;
  el.style.background = colours.bg;
  el.style.color = colours.text;
  el.style.borderColor = isCold ? '#38bdf8' : colours.border;

  // Count
  const countEl = document.createElement('div');
  countEl.className = 'seat-count';
  countEl.textContent = seat.count;
  el.appendChild(countEl);

  // Name
  if (seat.name) {
    const nameEl = document.createElement('div');
    nameEl.className = 'seat-name';
    nameEl.textContent = seat.name;
    el.appendChild(nameEl);
  }

  // Gender badge
  if (seat.gender) {
    const gEl = document.createElement('div');
    gEl.className = 'seat-gender';
    gEl.textContent = seat.gender;
    el.appendChild(gEl);
  }

  // Cold icon
  if (isCold) {
    const coldEl = document.createElement('div');
    coldEl.className = 'seat-cold-icon';
    coldEl.textContent = 'â„';
    el.appendChild(coldEl);
  }

  // Events
  el.addEventListener('click', () => handleSeatClick(seat.id));
  el.addEventListener('contextmenu', (e) => { e.preventDefault(); openNameModal(seat.id); });
  // Long press for mobile
  el.addEventListener('touchstart', () => { longPressTimer = setTimeout(() => openNameModal(seat.id), 600); }, { passive: true });
  el.addEventListener('touchend', () => clearTimeout(longPressTimer));
  el.addEventListener('touchmove', () => clearTimeout(longPressTimer));

  return el;
}

function renderRows(container, maxCount, coldSeats) {
  for (let r = 0; r < ROWS; r++) {
    const row = document.createElement('div');
    row.className = 'seat-row';
    for (let c = 0; c < COLS; c++) {
      const seat = seats[r * COLS + c];
      row.appendChild(makeSeatEl(seat, maxCount, coldSeats));
    }
    container.appendChild(row);
  }
}

function renderU(container, maxCount, coldSeats) {
  // Top row (seats 0-5), empty middle, bottom left/right columns
  // Layout: row 0 = top row full, rows 1-4 = left col + right col (empty in middle), last = optional centre
  // 5 rows x 6 cols: top row (6 seats), then 4 rows of 2 on sides (8 seats), centre bottom (6 seats) = 20
  // We'll use 5 rows of varying patterns
  const patterns = [
    [0,1,2,3,4,5],       // row 0: full top
    [6,-1,-1,-1,-1,11],  // row 1: sides only
    [12,-1,-1,-1,-1,17], // row 2: sides
    [18,-1,-1,-1,-1,23], // row 3: sides
    [24,25,26,27,28,29], // row 4: bottom full
  ];
  patterns.forEach(pattern => {
    const row = document.createElement('div');
    row.className = 'seat-row';
    pattern.forEach(idx => {
      if (idx === -1) {
        const empty = document.createElement('div');
        empty.className = 'seat empty-slot';
        row.appendChild(empty);
      } else {
        row.appendChild(makeSeatEl(seats[idx], maxCount, coldSeats));
      }
    });
    container.appendChild(row);
  });
}

function renderGroups(container, maxCount, coldSeats) {
  // 30 seats in groups of 4 = 7 groups + 2 extras: 7 full groups + 1 partial
  const wrapper = document.createElement('div');
  wrapper.className = 'groups-wrapper';
  let i = 0;
  while (i < TOTAL_SEATS) {
    const group = document.createElement('div');
    group.className = 'group-of-4';
    for (let k = 0; k < 4 && i < TOTAL_SEATS; k++, i++) {
      group.appendChild(makeSeatEl(seats[i], maxCount, coldSeats));
    }
    wrapper.appendChild(group);
  }
  container.appendChild(wrapper);
}

function updateLegend(maxCount) {
  const scale = document.getElementById('legend-scale');
  const maxLabel = document.getElementById('legend-max-label');
  const ticks = document.getElementById('legend-ticks');
  scale.innerHTML = '';
  // 20 steps
  for (let i = 0; i <= 20; i++) {
    const frac = i / 20;
    const d = document.createElement('div');
    const mockMax = 20;
    const col = getHeatColour(Math.round(frac * mockMax), mockMax);
    d.style.background = col.bg;
    scale.appendChild(d);
  }
  maxLabel.textContent = maxCount + '+';
  ticks.innerHTML = `<span>0</span><span>${Math.round(maxCount / 2)}</span><span>${maxCount}</span>`;
}

// =====================
// SEAT CLICK
// =====================
function handleSeatClick(seatId) {
  if (genderMode !== null) {
    // Gender assignment mode
    seats[seatId].gender = seats[seatId].gender === genderMode ? null : genderMode;
    render();
    updateStats();
    return;
  }
  seats[seatId].count++;
  history.push({ seatId, action: 'add' });
  updateUndoHint();
  render();
  updateStats();
  showToastBrief(seatId);
}

function showToastBrief(seatId) {
  const seat = seats[seatId];
  const msg = document.getElementById('toast-msg');
  const name = seat.name || `Seat ${seatId + 1}`;
  msg.textContent = `Question recorded: ${name} (total: ${seat.count})`;
  showToast(false);
}

// =====================
// UNDO
// =====================
function undoLast() {
  if (history.length === 0) return;
  const last = history.pop();
  if (last.action === 'add') {
    seats[last.seatId].count = Math.max(0, seats[last.seatId].count - 1);
  }
  updateUndoHint();
  render();
  updateStats();
  const seat = seats[last.seatId];
  const name = seat.name || `Seat ${last.seatId + 1}`;
  document.getElementById('toast-msg').textContent = `Undone: ${name}`;
  showToast(false);
}

function updateUndoHint() {
  const hint = document.getElementById('undo-hint');
  hint.textContent = history.length > 0 ? `${history.length} action${history.length !== 1 ? 's' : ''} recorded` : '';
}

// =====================
// KEYBOARD SHORTCUT
// =====================
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
    e.preventDefault();
    undoLast();
  }
});

// =====================
// STATS UPDATE
// =====================
function updateStats() {
  const total = seats.reduce((a, s) => a + s.count, 0);
  const asked = seats.filter(s => s.count > 0);
  const coverage = Math.round((asked.length / TOTAL_SEATS) * 100);
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-coverage').textContent = coverage + '%';

  // Most
  const sorted = [...seats].sort((a, b) => b.count - a.count);
  const most = sorted[0];
  document.getElementById('stat-most').textContent = most.count > 0 ? (most.name || `Seat ${most.id + 1}`) : '-';
  document.getElementById('stat-most-sub').textContent = most.count > 0 ? `${most.count} question${most.count !== 1 ? 's' : ''}` : '';

  // Least (from those who have been asked)
  const leastAsked = asked.length > 0 ? asked.reduce((a, b) => a.count < b.count ? a : b) : null;
  document.getElementById('stat-least').textContent = leastAsked ? (leastAsked.name || `Seat ${leastAsked.id + 1}`) : '-';
  document.getElementById('stat-least-sub').textContent = leastAsked ? `${leastAsked.count} question${leastAsked.count !== 1 ? 's' : ''}` : '';

  // Equity (Gini inverted)
  const counts = seats.map(s => s.count);
  const equity = computeGini(counts);
  const equityPct = Math.round(equity * 100);
  const bar = document.getElementById('equity-bar');
  const val = document.getElementById('equity-val');
  bar.style.width = equityPct + '%';
  bar.style.background = equityPct >= 70 ? 'var(--success)' : equityPct >= 45 ? 'var(--warning)' : 'var(--danger)';
  val.textContent = total === 0 ? '-' : equityPct + '%';

  // Gender
  const genders = ['M', 'F', 'O'];
  const gTotals = {};
  genders.forEach(g => gTotals[g] = 0);
  let gTotal = 0;
  seats.forEach(s => {
    if (s.gender && s.count > 0) {
      gTotals[s.gender] = (gTotals[s.gender] || 0) + s.count;
      gTotal += s.count;
    }
  });
  const gMap = { M: 'm', F: 'f', O: 'o' };
  const cntMap = { M: 'gcnt-m', F: 'gcnt-f', O: 'gcnt-o' };
  genders.forEach(g => {
    const pct = gTotal > 0 ? Math.round((gTotals[g] / gTotal) * 100) : 0;
    document.getElementById('gbar-' + gMap[g]).style.width = pct + '%';
    document.getElementById(cntMap[g]).textContent = `${gTotals[g]} (${pct}%)`;
  });

  // Alerts
  updateAlerts(total, coverage, equityPct, gTotals, gTotal);
}

function updateAlerts(total, coverage, equityPct, gTotals, gTotal) {
  const list = document.getElementById('alert-list');
  list.innerHTML = '';
  const alerts = [];

  if (total < 3) {
    list.innerHTML = '<p class="no-alerts">Ask some questions to see alerts.</p>';
    return;
  }

  const { coldRows, rowAvgs, overallRowAvg } = getColdSpots();

  // Cold row alerts
  coldRows.forEach(r => {
    const rowNames = ['Front', 'Row 2', 'Middle', 'Row 4', 'Back'];
    alerts.push({
      type: 'cold',
      icon: '&#10052;',
      text: `Cold spot: ${rowNames[r] || 'Row ' + (r + 1)} has received significantly fewer questions than other rows.`
    });
  });

  // Coverage alert
  if (coverage < 50 && total >= 8) {
    alerts.push({ type: 'warn', icon: '&#9888;', text: `Only ${coverage}% of pupils have been asked a question. Consider broadening your questioning.` });
  }

  // Equity
  if (equityPct < 50 && total >= 5) {
    alerts.push({ type: 'warn', icon: '&#9888;', text: `Equity score is low (${equityPct}%). Questioning is concentrated on a small number of pupils.` });
  }

  // Gender imbalance
  if (gTotal >= 5) {
    const genders = ['M', 'F', 'O'];
    const markedSeats = seats.filter(s => s.gender !== null);
    if (markedSeats.length > 0) {
      const maxG = genders.reduce((a, b) => (gTotals[a] || 0) > (gTotals[b] || 0) ? a : b);
      const minG = genders.filter(g => (gTotals[g] || 0) > 0).reduce((a, b) => (gTotals[a] || 0) < (gTotals[b] || 0) ? a : b, null);
      if (minG && gTotals[maxG] > 0) {
        const ratio = gTotals[maxG] / Math.max(1, gTotals[minG] || 1);
        if (ratio >= 2) {
          alerts.push({ type: 'warn', icon: '&#9878;', text: `Gender imbalance: ${maxG} pupils are receiving ${Math.round(ratio)}x more questions than ${minG} pupils.` });
        }
      }
    }
  }

  // Un-asked pupils
  const unasked = seats.filter(s => s.count === 0).length;
  if (unasked > 0 && total >= 10) {
    alerts.push({ type: (unasked > 10 ? 'warn' : 'cold'), icon: '&#128100;', text: `${unasked} pupil${unasked !== 1 ? 's' : ''} ${unasked !== 1 ? 'have' : 'has'} not yet been asked a question.` });
  }

  // Positive
  if (equityPct >= 70 && coverage >= 70) {
    alerts.push({ type: 'ok', icon: '&#10003;', text: `Good distribution! Equity score ${equityPct}%, coverage ${coverage}%. Keep going.` });
  }

  if (alerts.length === 0) {
    list.innerHTML = '<p class="no-alerts">No issues detected yet. Keep questioning!</p>';
    return;
  }

  alerts.forEach(a => {
    const el = document.createElement('div');
    el.className = 'alert-item ' + a.type;
    el.innerHTML = `<span class="alert-icon">${a.icon}</span><span>${a.text}</span>`;
    list.appendChild(el);
  });
}

// =====================
// LAYOUT
// =====================
function setLayout(layout) {
  currentLayout = layout;
  ['rows', 'u', 'groups'].forEach(l => {
    document.getElementById('layout-' + l).classList.toggle('active', l === layout);
  });
  render();
}

// =====================
// GENDER MODE
// =====================
function setGenderMode(mode) {
  genderMode = mode;
  ['none', 'M', 'F', 'O'].forEach(m => {
    const btn = document.getElementById('gmode-' + m);
    if (btn) btn.classList.toggle('active', (m === 'none' ? null : m) === mode);
  });
  const badge = document.getElementById('mode-badge');
  if (mode === null) {
    badge.textContent = 'Click to record question';
    badge.style.background = '';
    badge.style.color = '';
  } else {
    badge.textContent = `Marking gender: ${mode === 'O' ? 'Other' : mode} (click to assign/remove)`;
    badge.style.background = mode === 'M' ? '#dbeafe' : mode === 'F' ? '#fce7f3' : '#ede9fe';
    badge.style.color = mode === 'M' ? '#1d4ed8' : mode === 'F' ? '#9d174d' : '#5b21b6';
  }
}

// =====================
// NAME MODAL
// =====================
function openNameModal(seatId) {
  pendingNameSeatId = seatId;
  const seat = seats[seatId];
  document.getElementById('name-input').value = seat.name || '';
  document.getElementById('name-modal').classList.add('open');
  setTimeout(() => document.getElementById('name-input').focus(), 50);
}
function closeNameModal() {
  pendingNameSeatId = null;
  document.getElementById('name-modal').classList.remove('open');
}
function saveName() {
  if (pendingNameSeatId === null) return;
  const val = document.getElementById('name-input').value.trim();
  seats[pendingNameSeatId].name = val;
  closeNameModal();
  render();
  updateStats();
}
document.getElementById('name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') saveName();
  if (e.key === 'Escape') closeNameModal();
});
// Close modal on overlay click
document.getElementById('name-modal').parentElement && document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) {
      overlay.classList.remove('open');
      pendingNameSeatId = null;
    }
  });
});

// =====================
// RESET
// =====================
function confirmReset() {
  if (seats.every(s => s.count === 0) || confirm('Reset all question counts? Pupil names and genders will be kept.')) {
    seats.forEach(s => s.count = 0);
    history = [];
    updateUndoHint();
    render();
    updateStats();
    showToastMsg('Session reset. Names and genders kept.');
  }
}

// =====================
// EXPORT
// =====================
function openExport() {
  const content = buildExportText();
  document.getElementById('export-content').textContent = content;
  document.getElementById('export-modal').classList.add('open');
}
function closeExport() {
  document.getElementById('export-modal').classList.remove('open');
}
function copyExport() {
  const text = document.getElementById('export-content').textContent;
  navigator.clipboard.writeText(text).then(() => showToastMsg('Copied to clipboard!'));
}

function buildExportText() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  const total = seats.reduce((a, s) => a + s.count, 0);
  const asked = seats.filter(s => s.count > 0);
  const coverage = Math.round((asked.length / TOTAL_SEATS) * 100);
  const equity = Math.round(computeGini(seats.map(s => s.count)) * 100);
  const sorted = [...seats].sort((a, b) => b.count - a.count);

  let lines = [];
  lines.push('QUESTIONING DISTRIBUTION HEATMAP - SESSION SUMMARY');
  lines.push('='.repeat(52));
  lines.push(`Date: ${dateStr} at ${timeStr}`);
  lines.push(`Layout: ${currentLayout === 'rows' ? 'Standard rows' : currentLayout === 'u' ? 'Horseshoe / U-shape' : 'Groups of 4'}`);
  lines.push('');
  lines.push('OVERVIEW');
  lines.push('-'.repeat(30));
  lines.push(`Total questions recorded : ${total}`);
  lines.push(`Pupils questioned        : ${asked.length} / ${TOTAL_SEATS} (${coverage}%)`);
  lines.push(`Pupils not yet asked     : ${TOTAL_SEATS - asked.length}`);
  lines.push(`Equity score             : ${total === 0 ? 'N/A' : equity + '%'}`);
  lines.push('');

  if (total > 0) {
    const most = sorted[0];
    lines.push('MOST QUESTIONED');
    lines.push(`  ${most.name || 'Seat ' + (most.id + 1)} : ${most.count} question${most.count !== 1 ? 's' : ''}`);
    lines.push('');
    lines.push('PUPIL BREAKDOWN (sorted by questions)');
    lines.push('-'.repeat(30));
    sorted.forEach(s => {
      if (s.count > 0) {
        const name = s.name || `Seat ${s.id + 1}`;
        const gender = s.gender ? ` [${s.gender}]` : '';
        const bar = '#'.repeat(Math.min(s.count, 20));
        lines.push(`  ${(name + gender).padEnd(18)} ${String(s.count).padStart(3)} ${bar}`);
      }
    });

    const unasked = sorted.filter(s => s.count === 0);
    if (unasked.length > 0) {
      lines.push('');
      lines.push('NOT YET ASKED');
      lines.push('-'.repeat(30));
      unasked.forEach(s => {
        const name = s.name || `Seat ${s.id + 1}`;
        const gender = s.gender ? ` [${s.gender}]` : '';
        lines.push(`  ${name}${gender}`);
      });
    }

    // Gender summary
    const genders = ['M', 'F', 'O'];
    const gTotals = { M: 0, F: 0, O: 0 };
    let gTotal = 0;
    seats.forEach(s => {
      if (s.gender && s.count > 0) { gTotals[s.gender] += s.count; gTotal += s.count; }
    });
    if (gTotal > 0) {
      lines.push('');
      lines.push('GENDER BREAKDOWN (questions)');
      lines.push('-'.repeat(30));
      genders.forEach(g => {
        if (gTotals[g] > 0) {
          const pct = Math.round((gTotals[g] / gTotal) * 100);
          lines.push(`  ${g === 'O' ? 'Other' : g}${g.length === 1 ? '    ' : ' '} : ${gTotals[g]} questions (${pct}%)`);
        }
      });
    }
  }

  lines.push('');
  lines.push('='.repeat(52));
  lines.push('Generated by WeST CPD Questioning Heatmap Tool');
  return lines.join('\n');
}

// =====================
// TOAST
// =====================
function showToast(showUndoBtn = true) {
  const toast = document.getElementById('toast');
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 2500);
}
function showToastMsg(msg) {
  document.getElementById('toast-msg').textContent = msg;
  const toast = document.getElementById('toast');
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 2200);
}

// =====================
// ACCORDION
// =====================
function toggleAcc(trigger) {
  const body = trigger.nextElementSibling;
  const isOpen = body.classList.contains('open');
  // Close all
  document.querySelectorAll('.acc-body').forEach(b => b.classList.remove('open'));
  document.querySelectorAll('.acc-trigger').forEach(t => t.classList.remove('open'));
  if (!isOpen) {
    body.classList.add('open');
    trigger.classList.add('open');
  }
}

// =====================
// CLOSE MODALS ON OVERLAY
// =====================
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) {
      overlay.classList.remove('open');
      pendingNameSeatId = null;
    }
  });
});

// =====================
// BOOT
// =====================
initSeats();
</script>
</body>
</html>
