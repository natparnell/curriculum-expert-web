<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demographic Performance Breakdown</title>
  <style>
    /* ── Root Variables ── */
    :root {
      --bg:          #0f172a;
      --surface:     #1e293b;
      --surface2:    #273549;
      --surface3:    #2e3f57;
      --border:      #334155;
      --border2:     #475569;
      --teal:        #14b8a6;
      --teal-light:  #5eead4;
      --teal-dark:   #0d9488;
      --teal-dim:    #134e4a;
      --slate-text:  #94a3b8;
      --muted:       #64748b;
      --white:       #f1f5f9;
      --white-dim:   #cbd5e1;
      --accent1:     #6366f1;
      --accent2:     #f59e0b;
      --accent3:     #ec4899;
      --accent4:     #10b981;
      --accent5:     #f97316;
      --danger:      #ef4444;
      --warning:     #fbbf24;
      --success:     #22c55e;
      --radius:      8px;
      --radius-lg:   12px;
      --shadow:      0 4px 24px rgba(0,0,0,0.4);
      --transition:  0.2s ease;
    }

    /* ── Reset ── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 15px; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--white);
      min-height: 100vh;
      line-height: 1.5;
    }
    button { cursor: pointer; border: none; font-family: inherit; }
    select { font-family: inherit; }
    a { color: var(--teal); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* ── Layout ── */
    .app-header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .app-header h1 {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--teal-light);
      letter-spacing: -0.01em;
    }
    .app-header .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .header-badge {
      margin-left: auto;
      background: var(--teal-dim);
      color: var(--teal-light);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .app-body {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 57px);
    }

    /* ── Sidebar ── */
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-y: auto;
    }
    .sidebar-section h3 {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.6rem;
    }

    /* Control Styles */
    .control-label {
      font-size: 0.78rem;
      color: var(--slate-text);
      margin-bottom: 0.3rem;
      display: block;
    }
    .styled-select {
      width: 100%;
      background: var(--surface2);
      color: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.5rem 0.75rem;
      font-size: 0.82rem;
      outline: none;
      transition: border-color var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2rem;
    }
    .styled-select:focus { border-color: var(--teal); }
    .styled-select:hover { border-color: var(--border2); }

    .toggle-group {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }
    .toggle-btn {
      flex: 1;
      min-width: 0;
      padding: 0.4rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: var(--radius);
      background: var(--surface2);
      color: var(--slate-text);
      border: 1px solid var(--border);
      transition: all var(--transition);
      text-align: center;
      white-space: nowrap;
    }
    .toggle-btn:hover { border-color: var(--teal); color: var(--teal-light); }
    .toggle-btn.active {
      background: var(--teal-dim);
      border-color: var(--teal);
      color: var(--teal-light);
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--white-dim);
      cursor: pointer;
    }
    .checkbox-item input[type="checkbox"] {
      accent-color: var(--teal);
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    .info-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-left: 3px solid var(--teal);
      border-radius: var(--radius);
      padding: 0.75rem;
      font-size: 0.75rem;
      color: var(--slate-text);
      line-height: 1.55;
    }
    .info-card strong { color: var(--white-dim); }
    .info-card.warning { border-left-color: var(--warning); }
    .info-card.success { border-left-color: var(--success); }

    /* ── Main Panel ── */
    .main-panel {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-x: hidden;
    }

    /* ── Stat Row ── */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1rem 1.1rem;
    }
    .stat-card .stat-label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.3rem;
    }
    .stat-card .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--white);
      letter-spacing: -0.02em;
    }
    .stat-card .stat-sub {
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 0.15rem;
    }
    .stat-card .stat-delta {
      font-size: 0.78rem;
      font-weight: 600;
      margin-top: 0.2rem;
    }
    .stat-card .stat-delta.neg { color: var(--danger); }
    .stat-card .stat-delta.pos { color: var(--success); }

    /* ── Chart Card ── */
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
    }
    .chart-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .chart-card-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--white);
    }
    .chart-card-sub {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.1rem;
    }
    .chart-actions {
      display: flex;
      gap: 0.4rem;
    }
    .chart-btn {
      padding: 0.3rem 0.7rem;
      font-size: 0.72rem;
      font-weight: 600;
      border-radius: var(--radius);
      background: var(--surface2);
      color: var(--slate-text);
      border: 1px solid var(--border);
      transition: all var(--transition);
    }
    .chart-btn:hover { border-color: var(--teal); color: var(--teal-light); }
    .chart-btn.active {
      background: var(--teal-dim);
      border-color: var(--teal);
      color: var(--teal-light);
    }

    /* ── SVG Chart ── */
    .chart-wrap {
      position: relative;
      width: 100%;
      overflow: visible;
    }
    .chart-wrap svg {
      width: 100%;
      overflow: visible;
    }
    .chart-wrap svg text {
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    /* ── Legend ── */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.25rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.75rem;
      color: var(--slate-text);
    }
    .legend-swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .legend-swatch.line {
      height: 2px;
      width: 18px;
      border-radius: 0;
    }

    /* ── Gap Annotation ── */
    .gap-annotation {
      font-size: 0.68rem;
      fill: var(--warning);
      font-weight: 600;
    }

    /* ── Summary Table ── */
    .summary-table-wrap {
      overflow-x: auto;
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .summary-table th {
      background: var(--surface2);
      color: var(--muted);
      font-weight: 600;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.55rem 0.85rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    .summary-table td {
      padding: 0.55rem 0.85rem;
      border-bottom: 1px solid var(--border);
      color: var(--white-dim);
      vertical-align: middle;
    }
    .summary-table tr:last-child td { border-bottom: none; }
    .summary-table tr:hover td { background: var(--surface2); }
    .summary-table .cell-score {
      font-weight: 700;
      color: var(--white);
      font-size: 0.88rem;
    }
    .summary-table .cell-gap {
      font-weight: 700;
      font-size: 0.82rem;
    }
    .summary-table .cell-gap.neg { color: var(--danger); }
    .summary-table .cell-gap.pos { color: var(--success); }
    .summary-table .cell-gap.neutral { color: var(--muted); }
    .progress-bar-wrap {
      width: 100px;
      height: 6px;
      background: var(--surface3);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      border-radius: 3px;
    }
    .group-tag {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* ── Drill-down Modal ── */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      width: min(700px, 95vw);
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h2 { font-size: 0.95rem; color: var(--teal-light); font-weight: 700; }
    .modal-close {
      background: var(--surface2);
      color: var(--slate-text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      transition: all var(--transition);
    }
    .modal-close:hover { color: var(--white); border-color: var(--border2); }
    .modal-body { padding: 1.25rem; overflow-y: auto; }
    .modal-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    .modal-table th {
      background: var(--surface2);
      color: var(--muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .modal-table td {
      padding: 0.45rem 0.75rem;
      border-bottom: 1px solid var(--border);
      color: var(--white-dim);
    }
    .modal-table tr:last-child td { border-bottom: none; }
    .modal-table tr:hover td { background: var(--surface2); }
    .score-pill {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 700;
      background: var(--surface3);
      color: var(--white);
    }
    .score-pill.high { background: rgba(34,197,94,0.2); color: var(--success); }
    .score-pill.mid  { background: rgba(251,191,36,0.2); color: var(--warning); }
    .score-pill.low  { background: rgba(239,68,68,0.2);  color: var(--danger); }

    /* ── Trend Chart ── */
    .trend-panel {
      display: none;
    }
    .trend-panel.visible { display: block; }

    /* ── Framing Panel ── */
    .framing-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    .framing-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.85rem;
    }
    .framing-card h4 {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--teal-light);
      margin-bottom: 0.4rem;
    }
    .framing-card p {
      font-size: 0.74rem;
      color: var(--slate-text);
      line-height: 1.55;
    }
    .framing-card ul {
      margin-top: 0.4rem;
      padding-left: 1rem;
      font-size: 0.73rem;
      color: var(--slate-text);
    }
    .framing-card ul li { margin-bottom: 0.25rem; }

    /* ── Intersectionality ── */
    .matrix-wrap { overflow-x: auto; margin-top: 0.75rem; }
    .matrix-table { border-collapse: collapse; font-size: 0.74rem; white-space: nowrap; }
    .matrix-table th, .matrix-table td {
      padding: 0.4rem 0.65rem;
      border: 1px solid var(--border);
      text-align: center;
    }
    .matrix-table th { background: var(--surface2); color: var(--muted); font-size: 0.68rem; text-transform: uppercase; }
    .matrix-table td { color: var(--white-dim); }
    .heat-cell { font-weight: 700; border-radius: 4px; }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .app-body { grid-template-columns: 1fr; }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 1rem;
        gap: 1rem;
      }
      .stat-row { grid-template-columns: repeat(2, 1fr); }
      .framing-grid { grid-template-columns: 1fr; }
      .main-panel { padding: 1rem; }
    }
    @media (max-width: 480px) {
      .stat-row { grid-template-columns: 1fr 1fr; }
    }

    /* ── Tooltip ── */
    .svg-tooltip {
      position: absolute;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      padding: 0.55rem 0.8rem;
      font-size: 0.75rem;
      color: var(--white);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 50;
      white-space: nowrap;
      box-shadow: var(--shadow);
    }
    .svg-tooltip.visible { opacity: 1; }
    .svg-tooltip .tt-label { color: var(--muted); font-size: 0.7rem; }
    .svg-tooltip .tt-value { font-weight: 700; font-size: 0.9rem; color: var(--white); }

    /* ── Misc ── */
    .section-divider {
      border: none;
      border-top: 1px solid var(--border);
    }
    .no-data { color: var(--muted); font-size: 0.82rem; text-align: center; padding: 2rem; }
  </style>
</head>
<body>

<!-- ── App Header ── -->
<header class="app-header">
  <div>
    <h1>Demographic Performance Breakdown</h1>
    <div class="subtitle">Achievement gap analysis by protected characteristic</div>
  </div>
  <div class="header-badge">Demo Data</div>
</header>

<div class="app-body">

  <!-- ── Sidebar ── -->
  <aside class="sidebar">

    <div class="sidebar-section">
      <h3>Subject / Assessment</h3>
      <label class="control-label" for="sel-subject">Select subject</label>
      <select class="styled-select" id="sel-subject">
        <option value="maths">Mathematics</option>
        <option value="reading">Reading</option>
        <option value="writing">Writing</option>
        <option value="science">Science</option>
        <option value="grammar">Grammar, Punctuation &amp; Spelling</option>
        <option value="combined">Combined Average</option>
      </select>
    </div>

    <div class="sidebar-section">
      <h3>Demographic Dimension</h3>
      <label class="control-label" for="sel-dimension">Primary dimension</label>
      <select class="styled-select" id="sel-dimension">
        <option value="gender">Gender</option>
        <option value="pp">Pupil Premium</option>
        <option value="eal">English as Additional Language</option>
        <option value="sen">SEN Status</option>
        <option value="ethnicity">Ethnicity Group</option>
      </select>
      <br/>
      <label class="control-label" for="sel-overlay">Overlay dimension (optional)</label>
      <select class="styled-select" id="sel-overlay">
        <option value="none">None</option>
        <option value="gender">Gender</option>
        <option value="pp">Pupil Premium</option>
        <option value="eal">EAL</option>
        <option value="sen">SEN</option>
      </select>
    </div>

    <div class="sidebar-section">
      <h3>Chart Type</h3>
      <div class="toggle-group">
        <button class="toggle-btn active" id="btn-grouped" onclick="setChartType('grouped')">Grouped</button>
        <button class="toggle-btn" id="btn-stacked" onclick="setChartType('stacked')">Stacked</button>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>View Mode</h3>
      <div class="toggle-group">
        <button class="toggle-btn active" id="btn-scores" onclick="setViewMode('scores')">Scores</button>
        <button class="toggle-btn" id="btn-trend" onclick="setViewMode('trend')">Trend</button>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Overlays</h3>
      <div class="checkbox-group">
        <label class="checkbox-item">
          <input type="checkbox" id="chk-national" checked onchange="render()" />
          National average line
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="chk-gaps" checked onchange="render()" />
          Gap annotations
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="chk-labels" checked onchange="render()" />
          Value labels on bars
        </label>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Educational Context</h3>
      <div class="info-card">
        <strong>Equality Act 2010</strong> defines nine protected characteristics. Schools must have due regard to eliminating disadvantage and advancing equality of opportunity.
      </div>
    </div>

    <div class="sidebar-section">
      <div class="info-card warning">
        <strong>Note:</strong> These are simulated demo data values for training and discussion purposes. They do not represent any real school or cohort.
      </div>
    </div>

  </aside>

  <!-- ── Main Panel ── -->
  <main class="main-panel">

    <!-- Stat Row -->
    <div class="stat-row" id="stat-row"></div>

    <!-- Main Chart Card -->
    <div class="chart-card">
      <div class="chart-card-header">
        <div>
          <div class="chart-card-title" id="chart-title">Average Score by Demographic Group</div>
          <div class="chart-card-sub" id="chart-sub">Click any bar to drill into individual pupils</div>
        </div>
        <div class="chart-actions">
          <button class="chart-btn active" id="btn-chart-scores" onclick="setViewMode('scores')">Bar Chart</button>
          <button class="chart-btn" id="btn-chart-trend" onclick="setViewMode('trend')">Trend Lines</button>
        </div>
      </div>
      <div class="chart-wrap" id="chart-wrap">
        <svg id="main-svg" height="340"></svg>
        <div class="svg-tooltip" id="tooltip"></div>
      </div>
      <div class="legend" id="legend"></div>
    </div>

    <!-- Trend panel (hidden by default) -->
    <div class="chart-card trend-panel" id="trend-panel">
      <div class="chart-card-header">
        <div>
          <div class="chart-card-title">Gap Trend Over Time</div>
          <div class="chart-card-sub">How achievement gaps have changed across 3 assessment points</div>
        </div>
      </div>
      <div class="chart-wrap">
        <svg id="trend-svg" height="280"></svg>
      </div>
      <div class="legend" id="trend-legend"></div>
    </div>

    <!-- Summary Table -->
    <div class="chart-card">
      <div class="chart-card-header">
        <div>
          <div class="chart-card-title">Summary Table</div>
          <div class="chart-card-sub">All subgroups, scores and gap calculations</div>
        </div>
      </div>
      <div class="summary-table-wrap">
        <table class="summary-table" id="summary-table">
          <thead>
            <tr>
              <th>Subgroup</th>
              <th>Pupils</th>
              <th>Avg Score</th>
              <th>vs Cohort</th>
              <th>vs National</th>
              <th>Score distribution</th>
              <th>Trend</th>
            </tr>
          </thead>
          <tbody id="summary-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Intersectionality matrix -->
    <div class="chart-card" id="matrix-card">
      <div class="chart-card-header">
        <div>
          <div class="chart-card-title">Intersectionality Matrix</div>
          <div class="chart-card-sub">Average scores at the intersection of PP status and gender (heat-mapped)</div>
        </div>
      </div>
      <div class="matrix-wrap">
        <table class="matrix-table" id="matrix-table"></table>
      </div>
      <div style="margin-top:0.75rem;">
        <div class="info-card">
          <strong>Intersectionality:</strong> Pupils can face compounding disadvantage. A pupil who is PP, EAL, and has SEN may face challenges that are greater than any single factor alone. Heat mapping helps identify where combined risk is highest.
        </div>
      </div>
    </div>

    <!-- Educational Framing -->
    <div class="chart-card">
      <div class="chart-card-header">
        <div>
          <div class="chart-card-title">Educational Framing</div>
          <div class="chart-card-sub">Context for interpreting demographic performance data</div>
        </div>
      </div>
      <div class="framing-grid">
        <div class="framing-card">
          <h4>Achievement Gap Concept</h4>
          <p>An achievement gap is a persistent difference in academic performance between groups of pupils. Gaps are not fixed; they respond to targeted, evidence-informed intervention and high expectations for all pupils.</p>
        </div>
        <div class="framing-card">
          <h4>Equality Act 2010</h4>
          <p>Schools have a Public Sector Equality Duty under the Act. The nine protected characteristics include: age, disability, gender reassignment, marriage, pregnancy, race, religion, sex, and sexual orientation.</p>
          <p style="margin-top:0.4rem;">Pupil Premium and SEN are not protected characteristics but are key school accountability measures.</p>
        </div>
        <div class="framing-card">
          <h4>Intersectionality Awareness</h4>
          <p>Pupils rarely belong to a single "category". Intersecting identities can create compounding disadvantage or, conversely, protective factors. Data analysis should avoid reducing pupils to a single demographic label.</p>
          <ul>
            <li>PP + SEN: often the most significant overlap</li>
            <li>EAL + newly arrived: distinct from established EAL</li>
            <li>Gender gaps vary by subject</li>
          </ul>
        </div>
        <div class="framing-card">
          <h4>Closing the Gap: Strategies</h4>
          <ul>
            <li>High-quality teaching first (EEF Toolkit)</li>
            <li>Metacognition and self-regulation (+7 months)</li>
            <li>Feedback (+6 months)</li>
            <li>Reading comprehension strategies (+6 months)</li>
            <li>Targeted small-group tuition</li>
            <li>Parental engagement programmes</li>
            <li>Addressing attendance barriers</li>
          </ul>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- ── Drill-down Modal ── -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-title">Pupil List</h2>
      <button class="modal-close" onclick="closeModalDirect()">Close</button>
    </div>
    <div class="modal-body">
      <table class="modal-table">
        <thead>
          <tr>
            <th>Pupil ID</th>
            <th>Gender</th>
            <th>PP</th>
            <th>EAL</th>
            <th>SEN</th>
            <th>Ethnicity</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody id="modal-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════
//  DEMO DATA
// ══════════════════════════════════════════════════════

// 60 demo pupils with realistic demographic profiles
const PUPILS = (function() {
  const names = [
    'Amara', 'Bilal', 'Charlotte', 'Daniel', 'Ellie', 'Farrukh', 'Grace', 'Hassan',
    'Imogen', 'Jamal', 'Kira', 'Leon', 'Mia', 'Noah', 'Olivia', 'Priya',
    'Quinn', 'Ravi', 'Sophie', 'Tariq', 'Uma', 'Victor', 'Wendy', 'Xander',
    'Yusuf', 'Zoe', 'Aiden', 'Bethany', 'Chloe', 'Demi', 'Ethan', 'Freya',
    'George', 'Hannah', 'Ivan', 'Jade', 'Kieran', 'Lily', 'Marcus', 'Niamh',
    'Oscar', 'Phoebe', 'Rowan', 'Sienna', 'Theo', 'Ursula', 'Violet', 'Will',
    'Yasmin', 'Zayne', 'Abby', 'Ben', 'Caitlin', 'Dylan', 'Esme', 'Felix',
    'Georgia', 'Hugo', 'Isla', 'Jack'
  ];

  const ethnicities = ['White British','White British','White British','White British',
    'White British','Asian British','Asian British','Black British',
    'Black British','Mixed Heritage','Mixed Heritage','Other'];

  const raw = [
    // id, gender, pp, eal, sen_type, ethnicity_idx, base_ability (0-100)
    [1,'F',1,0,'none',0,62],[2,'M',1,0,'none',0,55],[3,'F',0,0,'none',0,78],
    [4,'M',0,0,'none',0,81],[5,'F',1,1,'none',5,59],[6,'M',1,1,'none',5,52],
    [7,'F',0,0,'none',0,85],[8,'M',0,0,'SEND',0,61],[9,'F',1,0,'SEND',3,48],
    [10,'M',0,0,'none',0,74],[11,'F',0,1,'none',6,71],[12,'M',1,0,'none',0,57],
    [13,'F',0,0,'none',0,83],[14,'M',1,1,'none',5,53],[15,'F',0,0,'SEND',0,66],
    [16,'M',0,0,'none',0,79],[17,'F',1,0,'none',3,61],[18,'M',0,0,'none',0,77],
    [19,'F',0,0,'none',0,88],[20,'M',1,0,'SEND',0,44],[21,'F',0,1,'none',1,73],
    [22,'M',0,0,'none',1,80],[23,'F',1,0,'none',0,58],[24,'M',0,0,'none',0,82],
    [25,'F',1,1,'SEND',6,41],[26,'M',1,0,'none',0,51],[27,'F',0,0,'none',0,86],
    [28,'M',0,0,'none',0,76],[29,'F',1,0,'none',4,63],[30,'M',1,0,'SEND',0,47],
    [31,'F',0,0,'none',0,84],[32,'M',0,1,'none',5,69],[33,'F',1,0,'none',0,56],
    [34,'M',0,0,'none',0,78],[35,'F',0,0,'none',0,87],[36,'M',1,1,'none',6,60],
    [37,'F',0,0,'SEND',0,70],[38,'M',0,0,'none',0,73],[39,'F',1,0,'none',0,54],
    [40,'M',0,0,'none',1,82],[41,'F',0,1,'none',5,75],[42,'M',1,0,'none',0,50],
    [43,'F',0,0,'none',0,85],[44,'M',0,0,'SEND',0,64],[45,'F',1,0,'none',3,62],
    [46,'M',0,0,'none',0,79],[47,'F',0,0,'none',0,88],[48,'M',1,1,'SEND',6,43],
    [49,'F',0,0,'none',0,81],[50,'M',0,0,'none',0,76],[51,'F',1,0,'none',0,57],
    [52,'M',0,1,'none',5,72],[53,'F',0,0,'none',0,83],[54,'M',1,0,'none',0,49],
    [55,'F',0,0,'none',0,90],[56,'M',0,0,'none',1,77],[57,'F',1,0,'SEND',0,46],
    [58,'M',0,0,'none',0,80],[59,'F',0,1,'none',6,74],[60,'M',1,0,'none',0,53],
  ];

  // Subject score modifiers (relative to base ability, with demographic gaps built in)
  const subjectMods = {
    maths:    { base: 1.0,  genderMF: -3,  ppPenalty: 10, ealPenalty: 4,  senPenalty: 14, noise: 8 },
    reading:  { base: 0.95, genderMF: +5,  ppPenalty: 9,  ealPenalty: 7,  senPenalty: 12, noise: 7 },
    writing:  { base: 0.9,  genderMF: +7,  ppPenalty: 11, ealPenalty: 8,  senPenalty: 15, noise: 9 },
    science:  { base: 0.95, genderMF: -1,  ppPenalty: 8,  ealPenalty: 3,  senPenalty: 10, noise: 7 },
    grammar:  { base: 0.92, genderMF: +4,  ppPenalty: 9,  ealPenalty: 10, senPenalty: 12, noise: 8 },
    combined: { base: 0.95, genderMF: +2,  ppPenalty: 9,  ealPenalty: 6,  senPenalty: 13, noise: 5 },
  };

  // Historical assessment points (P1, P2, P3) gap multiplier
  const historicalGapMult = { P1: 1.3, P2: 1.15, P3: 1.0 };

  // Seeded random for reproducible data
  let seed = 42;
  function seededRand() {
    seed = (seed * 16807 + 0) % 2147483647;
    return (seed - 1) / 2147483646;
  }
  function normal(mean, std) {
    let u = seededRand(), v = seededRand();
    return mean + std * Math.sqrt(-2 * Math.log(u + 0.0001)) * Math.cos(2 * Math.PI * v);
  }

  const pupils = raw.map(([id, gender, pp, eal, senType, ethnIdx, ability], i) => {
    const name = names[i] || 'Pupil ' + id;
    const pupil = {
      id: 'P' + String(id).padStart(3,'0'),
      name,
      gender,
      pp: pp === 1,
      eal: eal === 1,
      sen: senType !== 'none',
      senType,
      ethnicity: ethnicities[ethnIdx],
      ability,
      scores: {}
    };

    // Generate scores per subject and per assessment point
    Object.keys(subjectMods).forEach(subj => {
      const m = subjectMods[subj];
      pupil.scores[subj] = {};
      ['P1','P2','P3'].forEach(pt => {
        const gm = historicalGapMult[pt];
        let score = ability * m.base;
        if (pupil.gender === 'M') score += m.genderMF;
        if (pupil.pp)  score -= m.ppPenalty  * gm;
        if (pupil.eal) score -= m.ealPenalty  * gm;
        if (pupil.sen) score -= m.senPenalty  * gm;
        score = Math.min(100, Math.max(1, normal(score, m.noise)));
        pupil.scores[subj][pt] = Math.round(score * 10) / 10;
      });
    });
    return pupil;
  });

  return pupils;
})();

// National averages by subject (simulated)
const NATIONAL = {
  maths:    73.2,
  reading:  71.8,
  writing:  68.5,
  science:  72.1,
  grammar:  70.4,
  combined: 71.2,
};

// Trend labels
const TREND_LABELS = ['Assessment 1\n(Autumn)', 'Assessment 2\n(Spring)', 'Assessment 3\n(Summer)'];
const TREND_POINTS = ['P1','P2','P3'];

// Colour palette for groups
const PALETTE = [
  '#14b8a6', '#6366f1', '#f59e0b', '#ec4899',
  '#10b981', '#f97316', '#60a5fa', '#a78bfa',
  '#fb7185', '#34d399',
];

// Dimension definitions
const DIMENSIONS = {
  gender:    { label: 'Gender',         groups: ['F','M'],                      labels: { F:'Girls', M:'Boys' } },
  pp:        { label: 'Pupil Premium',  groups: [true, false],                  labels: { true:'PP',  false:'Non-PP' } },
  eal:       { label: 'EAL',            groups: [true, false],                  labels: { true:'EAL', false:'Non-EAL' } },
  sen:       { label: 'SEN Status',     groups: [true, false],                  labels: { true:'SEN Support', false:'No SEN' } },
  ethnicity: { label: 'Ethnicity',      groups: ['White British','Asian British','Black British','Mixed Heritage','Other'],
               labels: null },
};

function dimLabel(dim, val) {
  const d = DIMENSIONS[dim];
  if (!d) return val;
  return d.labels ? (d.labels[val] || val) : val;
}

// ══════════════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════════════
const state = {
  subject: 'maths',
  dimension: 'gender',
  overlay: 'none',
  chartType: 'grouped',
  viewMode: 'scores',
};

// ══════════════════════════════════════════════════════
//  SELECTORS / CONTROLS
// ══════════════════════════════════════════════════════
document.getElementById('sel-subject').addEventListener('change', e => { state.subject = e.target.value; render(); });
document.getElementById('sel-dimension').addEventListener('change', e => { state.dimension = e.target.value; render(); });
document.getElementById('sel-overlay').addEventListener('change', e => { state.overlay = e.target.value; render(); });

function setChartType(t) {
  state.chartType = t;
  document.getElementById('btn-grouped').classList.toggle('active', t === 'grouped');
  document.getElementById('btn-stacked').classList.toggle('active', t === 'stacked');
  render();
}
function setViewMode(m) {
  state.viewMode = m;
  ['scores','trend'].forEach(v => {
    document.getElementById('btn-' + v).classList.toggle('active', v === m);
    document.getElementById('btn-chart-' + v).classList.toggle('active', v === m);
  });
  document.getElementById('trend-panel').classList.toggle('visible', m === 'trend');
  render();
}

// ══════════════════════════════════════════════════════
//  DATA HELPERS
// ══════════════════════════════════════════════════════
function getPupilsByGroup(dim, val, subject, point) {
  return PUPILS.filter(p => {
    if (dim === 'gender')    return p.gender === val;
    if (dim === 'pp')        return p.pp === val;
    if (dim === 'eal')       return p.eal === val;
    if (dim === 'sen')       return p.sen === val;
    if (dim === 'ethnicity') return p.ethnicity === val;
    return true;
  });
}

function avg(arr) {
  if (!arr.length) return 0;
  return arr.reduce((s,v) => s+v, 0) / arr.length;
}

function getGroupScore(dim, val, subject, point='P3') {
  const pupils = getPupilsByGroup(dim, val, subject, point);
  if (!pupils.length) return null;
  return avg(pupils.map(p => p.scores[subject][point]));
}

function getCohortAvg(subject, point='P3') {
  return avg(PUPILS.map(p => p.scores[subject][point]));
}

function getGroupsData(dim, subject, point='P3') {
  const d = DIMENSIONS[dim];
  return d.groups.map((val, i) => {
    const pupils = getPupilsByGroup(dim, val, subject, point);
    const score = pupils.length ? avg(pupils.map(p => p.scores[subject][point])) : null;
    return { val, label: dimLabel(dim, val), score, count: pupils.length, color: PALETTE[i % PALETTE.length] };
  }).filter(g => g.score !== null && g.count > 0);
}

// ══════════════════════════════════════════════════════
//  STAT ROW
// ══════════════════════════════════════════════════════
function renderStats() {
  const subj = state.subject;
  const dim  = state.dimension;
  const cohortAvg = getCohortAvg(subj);
  const national  = NATIONAL[subj];
  const groups    = getGroupsData(dim, subj);
  const maxGroup  = groups.reduce((a,b) => a.score > b.score ? a : b);
  const minGroup  = groups.reduce((a,b) => a.score < b.score ? a : b);
  const maxGap    = groups.length >= 2 ? (maxGroup.score - minGroup.score) : 0;

  const cards = [
    { label: 'Cohort Average', value: cohortAvg.toFixed(1), sub: subj.charAt(0).toUpperCase()+subj.slice(1),
      delta: (cohortAvg - national).toFixed(1), deltaLabel: 'vs national', pos: cohortAvg >= national },
    { label: 'Largest Gap', value: maxGap.toFixed(1) + 'pts', sub: maxGroup.label + ' vs ' + minGroup.label,
      delta: null },
    { label: 'Highest Group', value: maxGroup.score.toFixed(1), sub: maxGroup.label + ' (' + maxGroup.count + ' pupils)',
      delta: (maxGroup.score - cohortAvg).toFixed(1), deltaLabel: 'vs cohort', pos: true },
    { label: 'Lowest Group', value: minGroup.score.toFixed(1), sub: minGroup.label + ' (' + minGroup.count + ' pupils)',
      delta: (minGroup.score - cohortAvg).toFixed(1), deltaLabel: 'vs cohort', pos: false },
  ];

  document.getElementById('stat-row').innerHTML = cards.map(c => `
    <div class="stat-card">
      <div class="stat-label">${c.label}</div>
      <div class="stat-value">${c.value}</div>
      <div class="stat-sub">${c.sub}</div>
      ${c.delta !== null ? `<div class="stat-delta ${c.pos ? 'pos' : 'neg'}">${c.delta > 0 ? '+' : ''}${c.delta} ${c.deltaLabel}</div>` : ''}
    </div>
  `).join('');
}

// ══════════════════════════════════════════════════════
//  MAIN BAR CHART
// ══════════════════════════════════════════════════════
function renderBarChart() {
  const subj    = state.subject;
  const dim     = state.dimension;
  const overlay = state.overlay;
  const showNat = document.getElementById('chk-national').checked;
  const showGaps= document.getElementById('chk-gaps').checked;
  const showLbl = document.getElementById('chk-labels').checked;
  const stacked = state.chartType === 'stacked';

  const svg = document.getElementById('main-svg');
  const wrap = document.getElementById('chart-wrap');
  const W = wrap.getBoundingClientRect().width || 700;
  const H = 340;
  const margin = { top: 32, right: 24, bottom: 54, left: 52 };
  const inner = { w: W - margin.left - margin.right, h: H - margin.top - margin.bottom };

  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.setAttribute('height', H);

  const groups = getGroupsData(dim, subj);
  if (!groups.length) { svg.innerHTML = '<text x="50%" y="50%" fill="#64748b" text-anchor="middle">No data</text>'; return; }

  // If overlay, cross product
  let bars = [];
  if (overlay !== 'none' && overlay !== dim) {
    const ovDim = DIMENSIONS[overlay];
    groups.forEach((g, gi) => {
      ovDim.groups.forEach((ov, oi) => {
        const dimPupils = getPupilsByGroup(dim, g.val, subj, 'P3');
        const crossPupils = dimPupils.filter(p => {
          if (overlay === 'gender') return p.gender === ov;
          if (overlay === 'pp')     return p.pp     === ov;
          if (overlay === 'eal')    return p.eal    === ov;
          if (overlay === 'sen')    return p.sen    === ov;
          return true;
        });
        if (!crossPupils.length) return;
        const score = avg(crossPupils.map(p => p.scores[subj]['P3']));
        bars.push({
          groupLabel: g.label,
          groupVal: g.val,
          groupIdx: gi,
          ovLabel: dimLabel(overlay, ov),
          ovVal: ov,
          ovIdx: oi,
          score,
          count: crossPupils.length,
          color: PALETTE[(gi * 3 + oi) % PALETTE.length],
          dim, overlay,
        });
      });
    });
  } else {
    bars = groups.map((g, gi) => ({
      groupLabel: g.label, groupVal: g.val, groupIdx: gi,
      ovLabel: null, ovVal: null, ovIdx: 0,
      score: g.score, count: g.count, color: g.color,
      dim, overlay: 'none',
    }));
  }

  // Scale
  const scores = bars.map(b => b.score);
  const minScore = Math.max(0, Math.floor(Math.min(...scores) - 10));
  const maxScore = Math.min(100, Math.ceil(Math.max(...scores) + 10));
  const nat = NATIONAL[subj];
  const yMin = Math.min(minScore, nat - 5);
  const yMax = Math.max(maxScore, nat + 2);

  function yPos(v) { return margin.top + inner.h - ((v - yMin) / (yMax - yMin)) * inner.h; }

  // Group layout
  const uniqueGroups = [...new Set(bars.map(b => b.groupLabel))];
  const groupW = inner.w / uniqueGroups.length;
  const barPerGroup = overlay !== 'none' && overlay !== dim ? DIMENSIONS[overlay].groups.length : 1;
  const barPad = 4;
  const barW = Math.max(14, (groupW - barPad * (barPerGroup + 1)) / barPerGroup);

  function barX(groupLabel, ovIdx) {
    const gi = uniqueGroups.indexOf(groupLabel);
    const gx = margin.left + gi * groupW + groupW / 2;
    const totalBarW = barPerGroup * barW + (barPerGroup - 1) * barPad;
    return gx - totalBarW / 2 + ovIdx * (barW + barPad);
  }

  // Build SVG
  let html = '';

  // Grid lines
  const ticks = 5;
  for (let i = 0; i <= ticks; i++) {
    const v = yMin + ((yMax - yMin) * i / ticks);
    const y = yPos(v);
    html += `<line x1="${margin.left}" x2="${margin.left + inner.w}" y1="${y}" y2="${y}"
      stroke="#334155" stroke-width="1" stroke-dasharray="${i === 0 ? '0' : '3,3'}" />`;
    html += `<text x="${margin.left - 6}" y="${y + 4}" fill="#64748b" font-size="10" text-anchor="end">${v.toFixed(0)}</text>`;
  }

  // National line
  if (showNat) {
    const ny = yPos(nat);
    html += `<line x1="${margin.left}" x2="${margin.left + inner.w}" y1="${ny}" y2="${ny}"
      stroke="#f59e0b" stroke-width="2" stroke-dasharray="6,4" />`;
    html += `<text x="${margin.left + inner.w - 4}" y="${ny - 5}" fill="#f59e0b" font-size="10" text-anchor="end">National ${nat}</text>`;
  }

  // Axes
  html += `<line x1="${margin.left}" x2="${margin.left}" y1="${margin.top}" y2="${margin.top + inner.h}" stroke="#334155" stroke-width="1" />`;
  html += `<line x1="${margin.left}" x2="${margin.left + inner.w}" y1="${margin.top + inner.h}" y2="${margin.top + inner.h}" stroke="#334155" stroke-width="1" />`;

  // Bars
  bars.forEach(bar => {
    const bx = barX(bar.groupLabel, bar.ovIdx);
    const by = yPos(bar.score);
    const bh = yPos(yMin) - by;
    const scoreStr = bar.score.toFixed(1);
    html += `<rect
      x="${bx}" y="${by}" width="${barW}" height="${bh}"
      fill="${bar.color}" rx="3"
      opacity="0.88"
      class="bar-rect"
      data-group="${bar.groupLabel}" data-ov="${bar.ovLabel || ''}"
      data-dim="${bar.dim}" data-val="${bar.groupVal}"
      data-score="${scoreStr}" data-count="${bar.count}"
      style="cursor:pointer"
      onmouseenter="showTooltip(event,'${bar.groupLabel}${bar.ovLabel ? ' / '+bar.ovLabel : ''}','${scoreStr}','${bar.count}')"
      onmouseleave="hideTooltip()"
      onclick="drillDown('${bar.dim}','${bar.groupVal}','${bar.ovLabel ? overlay : 'none'}','${bar.ovVal}')"
    />`;
    if (showLbl && bh > 18) {
      html += `<text x="${bx + barW/2}" y="${by - 4}" fill="#f1f5f9" font-size="10" text-anchor="middle" font-weight="600">${scoreStr}</text>`;
    }
  });

  // Gap annotations
  if (showGaps && bars.length >= 2 && overlay === 'none') {
    const sortedBars = [...bars].sort((a,b) => b.score - a.score);
    const hi = sortedBars[0], lo = sortedBars[sortedBars.length - 1];
    const gap = (hi.score - lo.score).toFixed(1);
    const hx = barX(hi.groupLabel, hi.ovIdx) + barW / 2;
    const lx = barX(lo.groupLabel, lo.ovIdx) + barW / 2;
    const hy = yPos(hi.score) - 14;
    const ly = yPos(lo.score) - 14;
    const midY = Math.min(hy, ly) - 16;
    // bracket
    html += `<line x1="${hx}" x2="${hx}" y1="${yPos(hi.score) - 4}" y2="${midY}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="3,2" />`;
    html += `<line x1="${lx}" x2="${lx}" y1="${yPos(lo.score) - 4}" y2="${midY}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="3,2" />`;
    html += `<line x1="${hx}" x2="${lx}" y1="${midY}" y2="${midY}" stroke="#fbbf24" stroke-width="1.5" />`;
    const midX = (hx + lx) / 2;
    html += `<text x="${midX}" y="${midY - 5}" class="gap-annotation" text-anchor="middle">${DIMENSIONS[dim].label} gap: ${gap} pts</text>`;
  }

  // Group labels (X axis)
  uniqueGroups.forEach(gl => {
    const gi = uniqueGroups.indexOf(gl);
    const cx = margin.left + gi * groupW + groupW / 2;
    const labelLines = gl.split(' ');
    labelLines.forEach((line, li) => {
      html += `<text x="${cx}" y="${margin.top + inner.h + 16 + li * 13}" fill="#94a3b8" font-size="11" text-anchor="middle">${line}</text>`;
    });
  });

  svg.innerHTML = html;

  // Legend
  const legendEl = document.getElementById('legend');
  let legHtml = '';
  if (overlay !== 'none' && overlay !== dim) {
    const ovDim = DIMENSIONS[overlay];
    const usedBars = bars.filter((b, i, arr) => arr.findIndex(x => x.ovIdx === b.ovIdx) === i);
    usedBars.forEach(bar => {
      legHtml += `<div class="legend-item"><div class="legend-swatch" style="background:${bar.color}"></div>${bar.ovLabel}</div>`;
    });
  } else {
    bars.forEach(b => {
      legHtml += `<div class="legend-item"><div class="legend-swatch" style="background:${b.color}"></div>${b.groupLabel} (${b.count})</div>`;
    });
  }
  if (showNat) {
    legHtml += `<div class="legend-item"><div class="legend-swatch line" style="background:#f59e0b"></div>National average (${NATIONAL[subj]})</div>`;
  }
  legHtml += `<div class="legend-item" style="margin-left:auto;color:var(--muted);font-size:0.7rem">Click bars to drill down</div>`;
  legendEl.innerHTML = legHtml;
}

// ══════════════════════════════════════════════════════
//  TREND CHART
// ══════════════════════════════════════════════════════
function renderTrendChart() {
  const subj = state.subject;
  const dim  = state.dimension;
  const d    = DIMENSIONS[dim];

  const svg = document.getElementById('trend-svg');
  const wrap = svg.parentElement;
  const W = wrap.getBoundingClientRect().width || 700;
  const H = 280;
  const margin = { top: 24, right: 80, bottom: 48, left: 52 };
  const inner  = { w: W - margin.left - margin.right, h: H - margin.top - margin.bottom };

  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.setAttribute('height', H);

  const groups = d.groups.filter(val => getPupilsByGroup(dim, val, subj, 'P3').length > 0);
  const seriesData = groups.map((val, gi) => ({
    label: dimLabel(dim, val),
    color: PALETTE[gi % PALETTE.length],
    points: TREND_POINTS.map(pt => getGroupScore(dim, val, subj, pt)),
  }));

  const allVals = seriesData.flatMap(s => s.points.filter(Boolean));
  const yMin = Math.max(0, Math.floor(Math.min(...allVals) - 8));
  const yMax = Math.min(100, Math.ceil(Math.max(...allVals) + 8));

  function xPos(i) { return margin.left + (i / (TREND_POINTS.length - 1)) * inner.w; }
  function yPos(v) { return margin.top + inner.h - ((v - yMin) / (yMax - yMin)) * inner.h; }

  let html = '';

  // Grid
  for (let i = 0; i <= 4; i++) {
    const v = yMin + ((yMax - yMin) * i / 4);
    const y = yPos(v);
    html += `<line x1="${margin.left}" x2="${margin.left+inner.w}" y1="${y}" y2="${y}" stroke="#334155" stroke-width="1" stroke-dasharray="3,3" />`;
    html += `<text x="${margin.left-6}" y="${y+4}" fill="#64748b" font-size="10" text-anchor="end">${v.toFixed(0)}</text>`;
  }

  // Axes
  html += `<line x1="${margin.left}" x2="${margin.left}" y1="${margin.top}" y2="${margin.top+inner.h}" stroke="#334155" />`;
  html += `<line x1="${margin.left}" x2="${margin.left+inner.w}" y1="${margin.top+inner.h}" y2="${margin.top+inner.h}" stroke="#334155" />`;

  // X axis labels
  TREND_LABELS.forEach((lbl, i) => {
    const x = xPos(i);
    lbl.split('\n').forEach((line, li) => {
      html += `<text x="${x}" y="${margin.top+inner.h+14+li*13}" fill="#94a3b8" font-size="10" text-anchor="middle">${line}</text>`;
    });
  });

  // Series lines
  seriesData.forEach(series => {
    const pts = series.points.map((v, i) => [xPos(i), yPos(v)]);
    const pathD = pts.map((p, i) => (i === 0 ? `M${p[0]},${p[1]}` : `L${p[0]},${p[1]}`)).join(' ');
    html += `<path d="${pathD}" fill="none" stroke="${series.color}" stroke-width="2.5" stroke-linejoin="round" />`;
    pts.forEach(([x, y], i) => {
      html += `<circle cx="${x}" cy="${y}" r="5" fill="${series.color}" stroke="var(--surface)" stroke-width="2" />`;
      html += `<text x="${x}" y="${y-10}" fill="${series.color}" font-size="10" text-anchor="middle" font-weight="600">${series.points[i].toFixed(1)}</text>`;
    });
    // Right label
    const last = pts[pts.length - 1];
    html += `<text x="${last[0]+8}" y="${last[1]+4}" fill="${series.color}" font-size="10">${series.label}</text>`;
  });

  svg.innerHTML = html;

  // Gap trend legend
  const legEl = document.getElementById('trend-legend');
  let legHtml = seriesData.map(s =>
    `<div class="legend-item"><div class="legend-swatch" style="background:${s.color}"></div>${s.label}</div>`
  ).join('');
  legEl.innerHTML = legHtml;
}

// ══════════════════════════════════════════════════════
//  SUMMARY TABLE
// ══════════════════════════════════════════════════════
function renderTable() {
  const subj = state.subject;
  const dim  = state.dimension;
  const groups = getGroupsData(dim, subj);
  const cohortAvg = getCohortAvg(subj);
  const national  = NATIONAL[subj];
  const maxScore  = Math.max(...groups.map(g => g.score));

  const tbody = document.getElementById('summary-tbody');
  tbody.innerHTML = groups.map(g => {
    const vsCohort = (g.score - cohortAvg);
    const vsNat    = (g.score - national);
    const pct      = Math.round((g.score / 100) * 100);
    const fillColor = g.score >= cohortAvg ? '#14b8a6' : (g.score >= cohortAvg - 5 ? '#f59e0b' : '#ef4444');

    // Trend indicator from P1 to P3
    const p1 = getGroupScore(dim, g.val, subj, 'P1');
    const p3 = getGroupScore(dim, g.val, subj, 'P3');
    const trendDelta = p3 - p1;
    const trendIcon = trendDelta > 0.5 ? '&#9650;' : trendDelta < -0.5 ? '&#9660;' : '&#9644;';
    const trendColor = trendDelta > 0.5 ? 'var(--success)' : trendDelta < -0.5 ? 'var(--danger)' : 'var(--muted)';

    const tagColor = g.color;
    return `<tr>
      <td>
        <span class="group-tag" style="background:${tagColor}22;color:${tagColor};border:1px solid ${tagColor}44">${g.label}</span>
      </td>
      <td>${g.count}</td>
      <td class="cell-score">${g.score.toFixed(1)}</td>
      <td class="cell-gap ${vsCohort >= 0 ? 'pos' : 'neg'}">${vsCohort >= 0 ? '+' : ''}${vsCohort.toFixed(1)}</td>
      <td class="cell-gap ${vsNat >= 0 ? 'pos' : 'neg'}">${vsNat >= 0 ? '+' : ''}${vsNat.toFixed(1)}</td>
      <td>
        <div class="progress-bar-wrap">
          <div class="progress-bar-fill" style="width:${pct}%;background:${fillColor}"></div>
        </div>
        <span style="font-size:0.68rem;color:var(--muted)">${pct}%</span>
      </td>
      <td style="color:${trendColor};font-size:0.8rem;font-weight:700">
        ${trendIcon} ${trendDelta >= 0 ? '+' : ''}${trendDelta.toFixed(1)}
      </td>
    </tr>`;
  }).join('');

  // Cohort row
  const pctCohort = Math.round((cohortAvg / 100) * 100);
  tbody.innerHTML += `<tr style="border-top:2px solid var(--border)">
    <td><span class="group-tag" style="background:var(--surface3);color:var(--white-dim);border:1px solid var(--border2)">Cohort</span></td>
    <td>${PUPILS.length}</td>
    <td class="cell-score">${cohortAvg.toFixed(1)}</td>
    <td class="cell-gap neutral">--</td>
    <td class="cell-gap ${cohortAvg >= national ? 'pos' : 'neg'}">${(cohortAvg - national) >= 0 ? '+' : ''}${(cohortAvg - national).toFixed(1)}</td>
    <td>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" style="width:${pctCohort}%;background:var(--teal)"></div>
      </div>
      <span style="font-size:0.68rem;color:var(--muted)">${pctCohort}%</span>
    </td>
    <td style="color:var(--muted)">--</td>
  </tr>`;
}

// ══════════════════════════════════════════════════════
//  INTERSECTIONALITY MATRIX (PP x Gender)
// ══════════════════════════════════════════════════════
function renderMatrix() {
  const subj = state.subject;
  const rowDim = 'pp';
  const colDim = 'gender';
  const rowGroups = [true, false];
  const colGroups = ['F', 'M'];
  const rowLabels  = { true: 'PP', false: 'Non-PP' };
  const colLabels  = { F: 'Girls', M: 'Boys' };

  // Also add EAL column for extra intersectionality
  const extraGroups = [false, true];
  const extraLabels  = { false: 'Non-EAL', true: 'EAL' };

  const scores = [];
  rowGroups.forEach(rv => {
    colGroups.forEach(cv => {
      extraGroups.forEach(ev => {
        const pupils = PUPILS.filter(p => p.pp === rv && p.gender === cv && p.eal === ev);
        scores.push(pupils.length ? avg(pupils.map(p => p.scores[subj]['P3'])) : null);
      });
    });
  });
  const valScores = scores.filter(Boolean);
  const sMin = Math.min(...valScores), sMax = Math.max(...valScores);

  function heatColor(v) {
    if (v === null) return 'var(--surface2)';
    const t = (v - sMin) / (sMax - sMin + 0.001);
    if (t < 0.25) return 'rgba(239,68,68,0.25)';
    if (t < 0.5)  return 'rgba(251,191,36,0.18)';
    if (t < 0.75) return 'rgba(20,184,166,0.18)';
    return 'rgba(34,197,94,0.22)';
  }
  function heatText(v) {
    if (v === null) return 'var(--muted)';
    const t = (v - sMin) / (sMax - sMin + 0.001);
    if (t < 0.25) return 'var(--danger)';
    if (t < 0.5)  return 'var(--warning)';
    return 'var(--success)';
  }

  const tbl = document.getElementById('matrix-table');
  let h = '<thead><tr><th>PP / Gender</th>';
  colGroups.forEach(cv => {
    extraGroups.forEach(ev => {
      h += `<th>${colLabels[cv]}, ${extraLabels[ev]}</th>`;
    });
  });
  h += '</tr></thead><tbody>';

  rowGroups.forEach(rv => {
    h += `<tr><td style="font-weight:700;color:var(--white-dim);text-align:left">${rowLabels[rv]}</td>`;
    colGroups.forEach(cv => {
      extraGroups.forEach(ev => {
        const pupils = PUPILS.filter(p => p.pp === rv && p.gender === cv && p.eal === ev);
        const score = pupils.length ? avg(pupils.map(p => p.scores[subj]['P3'])) : null;
        const bg = heatColor(score);
        const tc = heatText(score);
        h += `<td class="heat-cell" style="background:${bg};color:${tc}">
          ${score !== null ? score.toFixed(1) + '<br><span style="font-size:0.65rem;opacity:0.7">n=' + pupils.length + '</span>' : 'n/a'}
        </td>`;
      });
    });
    h += '</tr>';
  });
  h += '</tbody>';
  tbl.innerHTML = h;
}

// ══════════════════════════════════════════════════════
//  TOOLTIP
// ══════════════════════════════════════════════════════
function showTooltip(event, label, score, count) {
  const tt = document.getElementById('tooltip');
  const wrap = document.getElementById('chart-wrap');
  const rect = wrap.getBoundingClientRect();
  const x = event.clientX - rect.left + 12;
  const y = event.clientY - rect.top  - 12;
  tt.innerHTML = `<div class="tt-label">${label} (n=${count})</div><div class="tt-value">Avg: ${score}</div>`;
  tt.style.left = x + 'px';
  tt.style.top  = y + 'px';
  tt.classList.add('visible');
}
function hideTooltip() {
  document.getElementById('tooltip').classList.remove('visible');
}

// ══════════════════════════════════════════════════════
//  DRILL DOWN MODAL
// ══════════════════════════════════════════════════════
function drillDown(dim, val, overlay, ovVal) {
  // Convert string booleans back to proper types
  if (val === 'true')  val = true;
  if (val === 'false') val = false;
  if (ovVal === 'true')  ovVal = true;
  if (ovVal === 'false') ovVal = false;

  let pupils = getPupilsByGroup(dim, val, state.subject, 'P3');

  // Apply overlay filter if present
  if (overlay !== 'none' && ovVal !== null && ovVal !== 'null') {
    pupils = pupils.filter(p => {
      if (overlay === 'gender') return p.gender === ovVal;
      if (overlay === 'pp')     return p.pp     === ovVal;
      if (overlay === 'eal')    return p.eal    === ovVal;
      if (overlay === 'sen')    return p.sen    === ovVal;
      return true;
    });
  }

  const subj = state.subject;
  const label = dimLabel(dim, val);

  document.getElementById('modal-title').textContent =
    `Pupils: ${label}${overlay !== 'none' ? ' / ' + dimLabel(overlay, ovVal) : ''} (${subj.charAt(0).toUpperCase()+subj.slice(1)})`;

  const cohortAvg = getCohortAvg(subj);

  const rows = [...pupils]
    .sort((a,b) => b.scores[subj]['P3'] - a.scores[subj]['P3'])
    .map(p => {
      const s = p.scores[subj]['P3'];
      const cls = s >= cohortAvg + 5 ? 'high' : s >= cohortAvg - 5 ? 'mid' : 'low';
      return `<tr>
        <td>${p.id}</td>
        <td>${p.gender === 'F' ? 'Girl' : 'Boy'}</td>
        <td>${p.pp ? '<span style="color:var(--teal)">PP</span>' : '<span style="color:var(--muted)">No</span>'}</td>
        <td>${p.eal ? '<span style="color:var(--accent1)">EAL</span>' : '<span style="color:var(--muted)">No</span>'}</td>
        <td>${p.sen ? '<span style="color:var(--accent2)">' + p.senType + '</span>' : '<span style="color:var(--muted)">None</span>'}</td>
        <td style="font-size:0.75rem">${p.ethnicity}</td>
        <td><span class="score-pill ${cls}">${s.toFixed(1)}</span></td>
      </tr>`;
    }).join('');

  document.getElementById('modal-tbody').innerHTML = rows || '<tr><td colspan="7" class="no-data">No pupils in this subgroup</td></tr>';
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal(event) {
  if (event.target === document.getElementById('modal-overlay')) closeModalDirect();
}
function closeModalDirect() {
  document.getElementById('modal-overlay').classList.remove('open');
}

// ══════════════════════════════════════════════════════
//  MAIN RENDER
// ══════════════════════════════════════════════════════
function render() {
  const subj = state.subject;
  const dim  = state.dimension;

  // Update chart title
  const subjLabel = document.getElementById('sel-subject').options[document.getElementById('sel-subject').selectedIndex].text;
  const dimLabel2 = DIMENSIONS[dim].label;
  document.getElementById('chart-title').textContent = `${subjLabel}: Average Score by ${dimLabel2}`;

  renderStats();
  renderBarChart();
  renderTable();
  renderMatrix();

  if (state.viewMode === 'trend') {
    renderTrendChart();
  }
}

// Debounce resize
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(render, 150);
});

// Initial render
render();
</script>
</body>
</html>
