<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Curriculum Expert</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #1a365d;
  --primary-light: #2a4a7f;
  --bg: #f7f8fa;
  --card-bg: #ffffff;
  --text: #1a202c;
  --text-light: #718096;
  --border: #e2e8f0;
  --user-bg: #ebf4ff;
  --expert-bg: #ffffff;
  --accent: #718096;  /* default; overridden dynamically from config */
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 860px;
  margin: 0 auto;
}

/* --- Header --- */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: var(--primary);
  color: white;
  flex-shrink: 0;
}

.header h1 {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.header h1 span {
  opacity: 0.7;
  font-weight: 400;
  margin-left: 6px;
  font-size: 14px;
}

.subject-select {
  padding: 6px 12px;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  color: white;
  font-size: 14px;
  cursor: pointer;
  outline: none;
}

.subject-select option {
  color: var(--text);
  background: white;
}

/* --- File context card --- */
.file-card {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 12px 20px 0;
  padding: 10px 14px;
  background: #fffbeb;
  border: 1px solid #f6e05e;
  border-radius: 8px;
  font-size: 13px;
  flex-shrink: 0;
}

.file-card .file-icon { font-size: 18px; }
.file-card .file-name { font-weight: 600; }
.file-card .file-meta { color: var(--text-light); margin-left: 4px; }
.file-card .file-dismiss {
  margin-left: auto;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  color: var(--text-light);
  padding: 2px 6px;
  border-radius: 4px;
}
.file-card .file-dismiss:hover { background: rgba(0,0,0,0.06); }

/* --- Chat area --- */
.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.message {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.6;
  word-wrap: break-word;
}

.message.user {
  align-self: flex-end;
  background: var(--user-bg);
  border-bottom-right-radius: 4px;
  white-space: pre-wrap;
}

.message.expert {
  align-self: flex-start;
  background: var(--expert-bg);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.message.expert h1 { font-size: 18px; font-weight: 700; margin: 16px 0 6px; color: var(--primary); }
.message.expert h2 { font-size: 16px; font-weight: 700; margin: 14px 0 5px; color: var(--primary); }
.message.expert h3 { font-size: 14px; font-weight: 700; margin: 12px 0 4px; color: var(--primary); }
.message.expert h4 { font-size: 13px; font-weight: 700; margin: 10px 0 3px; color: var(--primary); }
.message.expert h1:first-child,
.message.expert h2:first-child,
.message.expert h3:first-child,
.message.expert h4:first-child { margin-top: 0; }
.message.expert table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 13px; }
.message.expert th, .message.expert td { border: 1px solid #e2e8f0; padding: 7px 12px; text-align: left; }
.message.expert th { background: var(--primary); color: #fff; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; }
.message.expert tr:nth-child(even) td { background: #f7fafc; }
.message.expert tr:hover td { background: #edf2f7; }

.message.error {
  align-self: center;
  background: #fed7d7;
  border: 1px solid #fc8181;
  color: #9b2c2c;
  font-size: 13px;
}

.message .sources {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
}

.source-chip {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  background: #edf2f7;
  color: var(--text-light);
}

.typing-indicator {
  align-self: flex-start;
  padding: 12px 16px;
  background: var(--expert-bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  border-bottom-left-radius: 4px;
  font-size: 14px;
  color: var(--text-light);
}

.typing-indicator span {
  animation: pulse 1.4s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 1; }
}

/* --- Welcome --- */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  text-align: center;
  color: var(--text-light);
  padding: 40px 20px;
}

.welcome h2 {
  font-size: 20px;
  color: var(--text);
  margin-bottom: 8px;
}

.welcome p {
  font-size: 14px;
  max-width: 440px;
  line-height: 1.6;
  margin-bottom: 20px;
}

.welcome .suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

.suggestion-btn {
  padding: 8px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: white;
  font-size: 13px;
  cursor: pointer;
  color: var(--text);
  transition: all 0.15s;
}

.suggestion-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* --- Input bar --- */
.input-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px 20px;
  background: var(--bg);
  flex-shrink: 0;
  border-top: 1px solid var(--border);
}

.upload-btn {
  height: 42px;
  width: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  cursor: pointer;
  font-size: 18px;
  flex-shrink: 0;
  transition: all 0.15s;
  padding: 0;
}

.upload-btn:hover { border-color: var(--accent); }

.input-wrapper {
  flex: 1;
  position: relative;
}

.input-wrapper textarea {
  width: 100%;
  padding: 9px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  resize: none;
  outline: none;
  height: 42px;
  min-height: 42px;
  max-height: 120px;
  line-height: 1.5;
  transition: border-color 0.15s;
  box-sizing: border-box;
}

.input-wrapper textarea:focus { border-color: var(--accent); }

.send-btn {
  height: 42px;
  padding: 0 18px;
  border: none;
  border-radius: 8px;
  background: var(--accent);
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  flex-shrink: 0;
  transition: opacity 0.15s;
}

.send-btn:hover { opacity: 0.85; }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.length-select {
  height: 42px;
  padding: 0 8px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  font-size: 12px;
  color: var(--text-light);
  cursor: pointer;
  outline: none;
  flex-shrink: 0;
  transition: border-color 0.15s;
}
.length-select:focus { border-color: var(--accent); }

.thinkers-toggle {
  height: 42px;
  padding: 0 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.15s;
  color: var(--text-light);
  white-space: nowrap;
}
.thinkers-toggle:hover { border-color: var(--accent); }
.thinkers-toggle.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* --- Drag overlay --- */
.drag-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26, 54, 93, 0.15);
  z-index: 100;
  align-items: center;
  justify-content: center;
}

.drag-overlay.active { display: flex; }

.drag-overlay .drop-zone {
  padding: 40px 60px;
  border: 2px dashed var(--accent);
  border-radius: 16px;
  background: rgba(255,255,255,0.95);
  font-size: 16px;
  color: var(--primary);
  font-weight: 600;
}

/* --- Message action bar --- */
.message-actions {
  display: flex;
  gap: 6px;
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
}

.action-btn {
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: white;
  color: var(--text-light);
  cursor: pointer;
  transition: all 0.15s;
}

.action-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: #fafbfc;
}

/* --- Visual blocks --- */
.visual-wrapper {
  margin: 12px 0;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  overflow-x: auto;
  background: #fafbfc;
}

.visual-content {
  padding: 14px 16px;
  min-width: fit-content;
}

.visual-content .visual {
  font-size: 13px;
  line-height: 1.5;
}

.visual-content table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

.visual-content th, .visual-content td {
  border: 1px solid #e2e8f0;
  padding: 6px 10px;
  text-align: left;
}

.visual-content th {
  background: #edf2f7;
  font-weight: 600;
}

.visual-footer {
  display: flex;
  border-top: 1px solid #e2e8f0;
}

.flesh-out-btn, .png-btn {
  flex: 1;
  padding: 7px 14px;
  border: none;
  background: #f7fafc;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  transition: background 0.15s;
}

.flesh-out-btn {
  color: var(--accent);
  border-right: 1px solid #e2e8f0;
}

.png-btn {
  color: var(--text-light);
}

.flesh-out-btn:hover, .png-btn:hover {
  background: #edf2f7;
}

.flesh-out-btn:disabled, .png-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* --- Infographic Modal Overlay --- */
.infographic-modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0, 0, 0, 0.6);
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.infographic-modal-overlay.active {
  display: flex;
}
.infographic-modal {
  background: #ffffff;
  border-radius: 12px;
  width: 95vw;
  max-width: 1200px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}
.infographic-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.infographic-modal-header h3 {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 60%;
}
.infographic-modal-header .modal-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}
.modal-download-btn {
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: white;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.15s;
}
.modal-download-btn:hover {
  border-color: var(--accent);
  background: #fafbfc;
}
.modal-download-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.modal-close-btn {
  padding: 6px 10px;
  font-size: 16px;
  border: none;
  background: none;
  cursor: pointer;
  color: var(--text-light);
  border-radius: 4px;
  line-height: 1;
}
.modal-close-btn:hover { background: #f0f0f0; }
.infographic-modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}
.infographic-modal-body .visual-content {
  padding: 0;
  min-width: auto;
}

/* Hidden file input */
.hidden-input { display: none; }
/* Print styles no longer needed ‚Äî PDF opens in new tab */

/* --- Knowledge Dashboard Modal --- */
.kb-modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 1000;
  justify-content: center;
  align-items: flex-start;
  padding: 40px 20px;
  overflow-y: auto;
}
.kb-modal-overlay.active { display: flex; }

.kb-modal {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  width: 100%;
  max-width: 900px;
  max-height: calc(100vh - 80px);
  overflow-y: auto;
  position: relative;
}

.kb-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px 10px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: #fff;
  border-radius: 12px 12px 0 0;
  z-index: 1;
}
.kb-header h3 { font-size: 15px; font-weight: 700; color: var(--text); margin: 0; }
.kb-header-right { display: flex; align-items: center; gap: 8px; }
.kb-summary { font-size: 11px; color: var(--text-light); }
.kb-close-btn {
  background: none; border: none; font-size: 20px; cursor: pointer;
  color: var(--text-light); padding: 0 0 0 8px; line-height: 1;
}
.kb-close-btn:hover { color: var(--text); }

.kb-body { padding-bottom: 8px; }

/* Trigger button in page header */
.kb-trigger {
  padding: 3px 10px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: white;
  cursor: pointer;
  color: var(--text-light);
  transition: all 0.15s;
  white-space: nowrap;
}
.kb-trigger:hover { border-color: var(--accent); color: var(--accent); }

.kb-compare-btn, .kb-pdf-btn {
  padding: 2px 8px;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: white;
  cursor: pointer;
  color: var(--text-light);
  transition: all 0.15s;
}
.kb-compare-btn:hover, .kb-pdf-btn:hover { border-color: var(--accent); color: var(--accent); }

.kb-toggle {
  font-size: 10px;
  color: var(--text-light);
  transition: transform 0.3s ease;
  display: inline-block;
}
.kb-toggle.collapsed { transform: rotate(180deg); }

.kb-progress-track {
  height: 3px;
  background: #e2e8f0;
  border-radius: 2px;
  flex: 1;
  overflow: hidden;
}
.kb-progress-track.large { height: 4px; margin: 0 20px 4px; }
.kb-progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 0.3s ease;
  min-width: 0;
}

.kb-folders {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(175px, 1fr));
  gap: 5px;
  padding: 3px 20px 5px;
}
.kb-folder {
  padding: 4px 7px;
  border: 1px solid var(--border);
  border-radius: 4px;
}
.kb-folder-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1px;
}
.kb-folder-name { font-weight: 600; color: var(--text); font-size: 10px; }
.kb-folder-count { color: var(--text-light); font-size: 10px; }
.kb-folder .kb-progress-track { margin: 2px 0 3px; }

.kb-files { display: flex; flex-direction: column; gap: 0; }
.kb-file {
  font-size: 10px;
  padding: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.25;
}
.kb-file-done { color: #276749; }
.kb-file-pending { color: var(--text-light); opacity: 0.4; }

.kb-index-info {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  padding: 4px 20px 5px;
  font-size: 10px;
  color: var(--text-light);
  border-top: 1px solid var(--border);
}
.kb-index-info span { white-space: nowrap; }

/* Compare view */
.kb-compare { padding: 2px 20px 4px; }
.kb-compare-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 3px 6px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 11px;
  transition: background 0.1s;
}
.kb-compare-row:hover { background: #f7fafc; }
.kb-compare-row.active { background: #edf2f7; font-weight: 600; }
.kb-compare-name { width: 80px; flex-shrink: 0; }
.kb-compare-stat { width: 48px; text-align: right; color: var(--text-light); font-size: 10px; flex-shrink: 0; }
.kb-compare-pct { width: 28px; text-align: right; color: var(--text-light); font-size: 10px; flex-shrink: 0; }

.kb-loading {
  padding: 8px 20px;
  font-size: 11px;
  color: var(--text-light);
  text-align: center;
}

/* ===== Mobile responsive ===== */
@media (max-width: 600px) {
  /* Fix 100vh on mobile browsers (address bar eats space) */
  body, #app { height: 100dvh; }

  /* Header: wrap onto two lines */
  .header {
    flex-wrap: wrap;
    gap: 6px;
    padding: 10px 12px;
  }
  .header h1 { font-size: 15px; flex: 1; min-width: 0; }
  .header h1 span { font-size: 12px; display: block; margin-left: 0; }
  .kb-trigger { font-size: 10px; padding: 2px 8px; }
  .subject-select {
    order: 10;
    width: 100%;
    font-size: 13px;
    padding: 8px 10px;
  }

  /* Chat area: tighter padding, wider messages */
  .chat-area { padding: 10px; gap: 10px; }
  .message { max-width: 95%; font-size: 13px; padding: 10px 12px; }
  .message.expert table { font-size: 11px; }
  .message.expert th, .message.expert td { padding: 5px 7px; }

  /* Welcome screen */
  .welcome { padding: 20px 12px; }
  .welcome h2 { font-size: 17px; }
  .welcome p { font-size: 13px; }
  .suggestion-btn { font-size: 12px; padding: 7px 11px; }

  /* Input bar: wrap controls onto two rows */
  .input-bar {
    flex-wrap: wrap;
    gap: 6px;
    padding: 8px 10px calc(8px + env(safe-area-inset-bottom, 0px));
  }
  .upload-btn { height: 38px; width: 38px; font-size: 16px; }
  .input-wrapper { flex: 1; min-width: 0; order: 0; }
  .input-wrapper textarea { height: 38px; min-height: 38px; font-size: 14px; padding: 7px 10px; }
  .send-btn { height: 38px; padding: 0 14px; font-size: 13px; order: 0; }
  .length-select { height: 34px; font-size: 11px; order: 10; }
  .thinkers-toggle { height: 34px; font-size: 11px; padding: 0 8px; order: 10; }

  /* File card */
  .file-card { margin: 8px 10px 0; padding: 8px 10px; font-size: 12px; }

  /* Modals: less padding */
  .kb-modal-overlay { padding: 10px; }
  .kb-modal { max-height: calc(100vh - 20px); }
  .kb-folders { grid-template-columns: 1fr 1fr; gap: 4px; padding: 3px 10px 5px; }
  .kb-header { padding: 10px 12px 8px; }
  .kb-index-info { padding: 4px 10px 5px; }

  .infographic-modal-overlay { padding: 8px; }
  .infographic-modal { max-height: 95vh; }
  .infographic-modal-body { padding: 12px; }
  .infographic-modal-header { padding: 10px 12px; }
  .infographic-modal-header h3 { font-size: 13px; max-width: 55%; }
}
</style>
</head>
<body>
<div id="app"></div>

<div class="drag-overlay" id="dragOverlay">
  <div class="drop-zone">Drop file here to upload</div>
</div>

<input type="file" class="hidden-input" id="fileInput" accept=".pdf,.docx,.txt,.md">

<!-- Knowledge Base Modal -->
<div class="kb-modal-overlay" id="kbModal" onclick="closeKbModal(event)">
  <div class="kb-modal" id="kbModalContent" onclick="event.stopPropagation()">
  </div>
</div>

<!-- Infographic Modal -->
<div class="infographic-modal-overlay" id="infographicModal" onclick="closeInfographicModal(event)">
  <div class="infographic-modal" onclick="event.stopPropagation()">
    <div class="infographic-modal-header">
      <h3 id="modalTitle">Infographic</h3>
      <div class="modal-actions">
        <button class="modal-download-btn" id="modalDownloadBtn" onclick="downloadModalPng()">‚¨á Save as PNG</button>
        <button class="modal-close-btn" onclick="closeInfographicModal()">‚úï</button>
      </div>
    </div>
    <div class="infographic-modal-body" id="modalBody">
      <div class="visual-content" id="modalVisualContent"></div>
    </div>
  </div>
</div>

<script>
const API = '';  // same origin
let state = {
  subject: 'history',
  subjects: {},
  messages: [],
  fileSession: null,  // {session_id, filename, word_count}
  loading: false,
  length: 'medium',  // 'short' | 'medium' | 'extended'
  citeThinkers: true,  // toggle: cite curriculum thinkers by name
  streamPhase: null,  // 'searching' | 'generating' | null
  knowledgeStatus: null,
  knowledgeSummary: null,
  knowledgePanelOpen: true,
  knowledgeCompareMode: false,
  knowledgeLoading: false
};

// --- Config-driven UI helpers ---
function getSubjectSuggestions(subject) {
  const s = state.subjects[subject];
  if (s && s.suggestions && s.suggestions.length > 0) return s.suggestions;
  const name = (s && s.name) || subject;
  return [
    `What are the key curriculum requirements for ${name}?`,
    `How should ${name} be taught across key stages?`,
    `What do the leading thinkers say about ${name} pedagogy?`,
    `What does the National Curriculum require for ${name}?`
  ];
}

function getAccentHex(subject) {
  const s = state.subjects[subject];
  return (s && s.accent_color) ? s.accent_color : '#718096';
}

// --- Knowledge Dashboard ---

async function fetchKnowledgeStatus() {
  state.knowledgeLoading = true;
  try {
    const [statusRes, summaryRes] = await Promise.all([
      fetch(API + '/knowledge-status/' + state.subject),
      fetch(API + '/knowledge-status')
    ]);
    if (statusRes.ok) state.knowledgeStatus = await statusRes.json();
    if (summaryRes.ok) state.knowledgeSummary = await summaryRes.json();
  } catch (e) {
    // Silently fail ‚Äî panel just won't show
  }
  state.knowledgeLoading = false;
  render();
}

function toggleCompareMode(e) {
  if (e) e.stopPropagation();
  state.knowledgeCompareMode = !state.knowledgeCompareMode;
  updateKbModal();
}

function renderCompareView() {
  if (!state.knowledgeSummary || !state.knowledgeSummary.subjects) return '';
  const subjects = state.knowledgeSummary.subjects;
  const rows = Object.entries(subjects).map(([key, s]) => {
    const colour = getAccentHex(key);
    const active = key === state.subject ? ' active' : '';
    return `<div class="kb-compare-row${active}" onclick="switchSubject('${key}')">
      <span class="kb-compare-name">${escapeHtml(s.name)}</span>
      <div class="kb-progress-track">
        <div class="kb-progress-fill" style="width:${s.percent}%;background:${colour}"></div>
      </div>
      <span class="kb-compare-stat">${s.built}/${s.planned}</span>
      <span class="kb-compare-pct">${s.percent}%</span>
    </div>`;
  }).join('');
  return `<div class="kb-compare">${rows}</div>`;
}

function renderKnowledgePanel() {
  // Knowledge panel now renders into the modal ‚Äî this returns nothing for inline
  updateKbModal();
  return '';
}

function updateKbModal() {
  const modal = document.getElementById('kbModalContent');
  if (!modal) return;

  if (state.knowledgeLoading && !state.knowledgeStatus) {
    modal.innerHTML = '<div class="kb-loading">Loading knowledge base status...</div>';
    return;
  }
  if (!state.knowledgeStatus) {
    modal.innerHTML = '<div class="kb-loading">No knowledge base data available.</div>';
    return;
  }

  const ks = state.knowledgeStatus;
  const s = ks.summary;
  const chunkText = ks.indexing.chromadb_chunks >= 0
    ? ' \u00b7 ' + ks.indexing.chromadb_chunks + ' chunks' : '';

  const foldersHtml = ks.folders.map(f => {
    const pct = f.planned > 0 ? Math.round(f.built / f.planned * 100) : 0;
    const filesHtml = f.files.map(file => {
      const icon = file.status === 'built' ? '&#10003;' : '&#9675;';
      const cls = file.status === 'built' ? 'kb-file-done' : 'kb-file-pending';
      const name = file.file.replace('.md', '').replace(/_/g, ' ');
      return `<div class="kb-file ${cls}" title="${escapeHtml(file.description || file.file)}">${icon} ${escapeHtml(name)}</div>`;
    }).join('');
    return `<div class="kb-folder">
      <div class="kb-folder-header">
        <span class="kb-folder-name">${escapeHtml(f.label)}</span>
        <span class="kb-folder-count">${f.built}/${f.planned}</span>
      </div>
      <div class="kb-progress-track"><div class="kb-progress-fill" style="width:${pct}%"></div></div>
      <div class="kb-files">${filesHtml}</div>
    </div>`;
  }).join('');

  const chunkInfo = ks.indexing.chromadb_chunks >= 0
    ? `${ks.indexing.chromadb_chunks} chunks in ChromaDB` : 'ChromaDB unavailable';

  modal.innerHTML = `
    <div class="kb-header">
      <h3>${escapeHtml(ks.subject_name)}</h3>
      <div class="kb-header-right">
        <span class="kb-summary">${s.total_built}/${s.total_planned} (${s.percent_complete}%)${chunkText}</span>
        <button class="kb-compare-btn" onclick="toggleCompareMode(event)">
          ${state.knowledgeCompareMode ? 'Detail' : 'Compare'}
        </button>
        <button class="kb-pdf-btn" onclick="downloadKnowledgePdf(event)">PDF</button>
        <button class="kb-close-btn" onclick="closeKbModal()">‚úï</button>
      </div>
    </div>
    <div class="kb-body">
      <div class="kb-progress-track large"><div class="kb-progress-fill" style="width:${s.percent_complete}%"></div></div>
      ${state.knowledgeCompareMode ? renderCompareView() : '<div class="kb-folders">' + foldersHtml + '</div>'}
      <div class="kb-index-info">
        <span>${chunkInfo}</span>
        <span>Embedding: ${escapeHtml(ks.indexing.embedding_model)}</span>
      </div>
    </div>`;
}

function openKbModal() {
  updateKbModal();
  document.getElementById('kbModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeKbModal(e) {
  if (e && e.target !== document.getElementById('kbModal')) return;
  document.getElementById('kbModal').classList.remove('active');
  document.body.style.overflow = '';
}

// --- Init ---
async function init() {
  try {
    const res = await fetch(API + '/config');
    const data = await res.json();
    state.subjects = data.subjects;
    if (!state.subjects[state.subject]) {
      state.subject = Object.keys(state.subjects)[0];
    }
  } catch (e) {
    state.subjects = {
      history: { name: 'History' },
      geography: { name: 'Geography' }
    };
  }
  render();
  fetchKnowledgeStatus();
  setupDragDrop();
}

// --- Render ---
function render() {
  const subjectName = (state.subjects[state.subject] || {}).name || state.subject;
  document.documentElement.style.setProperty('--accent', getAccentHex(state.subject));

  const subjectOptions = Object.entries(state.subjects)
    .map(([k, v]) => `<option value="${k}" ${k === state.subject ? 'selected' : ''}>${v.name}</option>`)
    .join('');

  let chatContent = '';

  if (state.messages.length === 0) {
    const subjectSuggestions = getSubjectSuggestions(state.subject);
    chatContent = `
      <div class="welcome">
        <h2>${subjectName} Curriculum Expert</h2>
        <p>Ask questions about the UK National Curriculum, key thinkers, pedagogy, and assessment. Upload a scheme of work or curriculum plan to get expert feedback on it.</p>
        <div class="suggestions">
          ${subjectSuggestions.map(s => `<button class="suggestion-btn" onclick="askQuestion('${s.replace(/'/g, "\\'")}')">${s}</button>`).join('')}
        </div>
      </div>`;
  } else {
    chatContent = '<div class="chat-area" id="chatArea">';
    for (let i = 0; i < state.messages.length; i++) {
      const msg = state.messages[i];
      if (msg.role === 'user') {
        chatContent += `<div class="message user">${escapeHtml(msg.content)}</div>`;
      } else if (msg.role === 'error') {
        chatContent += `<div class="message error">${escapeHtml(msg.content)}</div>`;
      } else {
        let sourcesHtml = '';
        if (msg.sources && msg.sources.length > 0) {
          const chips = msg.sources
            .map(s => {
              const label = s.thinker || s.heading || s.file.split('/').pop();
              return `<span class="source-chip">${escapeHtml(label)}</span>`;
            })
            .join('');
          sourcesHtml = `<div class="sources">${chips}</div>`;
        }
        const msgId = 'msg_' + i;
        chatContent += `<div class="message expert" id="${msgId}">
          ${formatAnswer(msg.content)}
          ${sourcesHtml}
          <div class="message-actions">
            <button class="action-btn" onclick="saveAsPdf('${msgId}', ${i})">üìÑ Save as PDF</button>
            ${msg._isReading ? '' : (msg._infographicHtml
              ? '<button class="action-btn" onclick="reopenInfographic(' + i + ')">üé® View Infographic</button>'
              : '<button class="action-btn" onclick="visualiseAnswer(' + i + ')">‚ú® Visualise</button>'
            )}
            ${msg._isReading ? '' : '<button class="action-btn" onclick="suggestReading(' + i + ')">üìñ Suggest further reading</button>'}
          </div>
        </div>`;
      }
    }
    if (state.loading) {
      const phaseText = state.streamPhase === 'searching'
          ? 'Searching knowledge base...'
          : state.streamPhase === 'generating'
              ? 'Generating answer...'
              : 'Connecting...';
      chatContent += `<div class="typing-indicator"><span>${phaseText}</span></div>`;
    }
    chatContent += '</div>';
  }

  let fileCardHtml = '';
  if (state.fileSession) {
    fileCardHtml = `
      <div class="file-card">
        <span class="file-icon">üìé</span>
        <span class="file-name">${escapeHtml(state.fileSession.filename)}</span>
        <span class="file-meta">${state.fileSession.word_count.toLocaleString()} words</span>
        <button class="file-dismiss" onclick="dismissFile()" title="Remove file">‚úï</button>
      </div>`;
  }

  renderKnowledgePanel();

  // Build KB trigger button summary
  const kbTriggerHtml = state.knowledgeStatus
    ? `<button class="kb-trigger" onclick="openKbModal()">üìä ${state.knowledgeStatus.summary.total_built}/${state.knowledgeStatus.summary.total_planned} KB</button>`
    : (state.knowledgeLoading ? '<button class="kb-trigger" disabled>üìä Loading...</button>' : '');

  document.getElementById('app').innerHTML = `
    <div class="header">
      <h1>Curriculum Expert<span>${subjectName}</span></h1>
      ${kbTriggerHtml}
      <select class="subject-select" onchange="switchSubject(this.value)">${subjectOptions}</select>
    </div>
    ${fileCardHtml}
    ${chatContent}
    <div class="input-bar">
      <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Upload a file">üìé</button>
      <div class="input-wrapper">
        <textarea id="questionInput" placeholder="Ask a curriculum question..." rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      </div>
      <select class="length-select" onchange="state.length=this.value" title="Answer length">
        <option value="short" ${state.length==='short'?'selected':''}>Short</option>
        <option value="medium" ${state.length==='medium'?'selected':''}>Medium</option>
        <option value="extended" ${state.length==='extended'?'selected':''}>Extended</option>
      </select>
      <button class="thinkers-toggle ${state.citeThinkers ? 'active' : ''}"
        onclick="state.citeThinkers=!state.citeThinkers;render()"
        title="${state.citeThinkers ? 'Thinkers ON ‚Äî answers cite curriculum academics by name' : 'Thinkers OFF ‚Äî practical guidance without named academics'}">
        üìö Thinkers
      </button>
      <button class="send-btn" onclick="sendQuestion()" ${state.loading ? 'disabled' : ''}>Send</button>
    </div>`;

  // Scroll chat to bottom
  const chatArea = document.getElementById('chatArea');
  if (chatArea) {
    setTimeout(() => chatArea.scrollTop = chatArea.scrollHeight, 50);
  }

  // Focus input
  const input = document.getElementById('questionInput');
  if (input) setTimeout(() => input.focus(), 100);
}

// --- Actions ---
function switchSubject(subject) {
  state.subject = subject;
  state.messages = [];
  state.knowledgeStatus = null;  // Clear stale data
  // Keep file session across subject switches
  render();
  fetchKnowledgeStatus();
}

function askQuestion(text) {
  document.getElementById('questionInput').value = text;
  sendQuestion();
}

function suggestReading(msgIndex) {
  // Find the user question that prompted this answer
  const msgs = state.messages;
  let question = '';
  for (let j = msgIndex - 1; j >= 0; j--) {
    if (msgs[j].role === 'user') { question = msgs[j].content; break; }
  }
  const prompt = question
    ? `Based on your answer about "${question.substring(0, 120)}", suggest further reading ‚Äî books, academic papers, journal articles, and key texts that a teacher or curriculum leader should read to go deeper on this topic. Include author, title, year where possible, and a one-line note on why each is valuable.`
    : 'Suggest key further reading ‚Äî books, academic papers, and texts ‚Äî for curriculum leaders wanting to deepen their understanding of this topic.';
  state._pendingReading = true;
  document.getElementById('questionInput').value = prompt;
  sendQuestion();
}

async function sendQuestion() {
  const input = document.getElementById('questionInput');
  const question = (input ? input.value : '').trim();
  if (!question || state.loading) return;

  state.messages.push({ role: 'user', content: question });
  state.loading = true;
  state.streamPhase = 'searching';
  render();

  // Build conversation history for context (last 6 messages)
  const history = state.messages
    .filter(m => m.role === 'user' || m.role === 'assistant')
    .slice(-6)
    .map(m => ({ role: m.role === 'user' ? 'user' : 'assistant', content: m.content }));
  history.pop();

  const body = {
    question: question,
    subject: state.subject,
    session_id: state.fileSession ? state.fileSession.session_id : null,
    conversation_history: history.length > 0 ? history : null,
    length: state.length,
    cite_thinkers: state.citeThinkers
  };

  try {
    const res = await fetch(API + '/ask-stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    // Fallback to non-streaming if endpoint not available
    if (res.status === 404) {
      const fallbackRes = await fetch(API + '/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const fallbackData = await fallbackRes.json();
      if (fallbackData.error) {
        state.messages.push({ role: 'error', content: fallbackData.error });
      } else {
        const fbMsg = { role: 'assistant', content: fallbackData.answer, sources: fallbackData.sources || [] };
        if (state._pendingReading) { fbMsg._isReading = true; state._pendingReading = false; }
        state.messages.push(fbMsg);
      }
      state.loading = false;
      state.streamPhase = null;
      render();
      return;
    }

    if (!res.ok) {
      const errData = await res.json().catch(() => ({ error: 'Request failed' }));
      state.messages.push({ role: 'error', content: errData.error || 'Request failed' });
      state.loading = false;
      state.streamPhase = null;
      render();
      return;
    }

    // Prepare a placeholder message for the streaming response
    const assistantMsg = { role: 'assistant', content: '', sources: [] };
    if (state._pendingReading) { assistantMsg._isReading = true; state._pendingReading = false; }
    state.messages.push(assistantMsg);
    render();

    // Get the streaming message element for incremental DOM updates
    const chatArea = document.getElementById('chatArea');
    const msgElements = chatArea ? chatArea.querySelectorAll('.message.expert') : [];
    const streamingEl = msgElements[msgElements.length - 1];

    // Remove typing indicator since we'll show live text
    const typingEl = document.querySelector('.typing-indicator');
    if (typingEl) typingEl.remove();

    // Parse SSE from the stream
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();  // Keep incomplete line in buffer

      let eventType = '';
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith('data: ')) {
          try {
            const evData = JSON.parse(line.slice(6));
            switch (eventType) {
              case 'phase':
                state.streamPhase = evData.phase;
                // Update typing indicator if it still exists
                const indicator = document.querySelector('.typing-indicator span');
                if (indicator) {
                  indicator.textContent = evData.phase === 'searching'
                    ? 'Searching knowledge base...'
                    : 'Generating answer...';
                }
                break;
              case 'sources':
                assistantMsg.sources = evData.sources;
                break;
              case 'token':
                assistantMsg.content += evData.text;
                if (streamingEl) {
                  streamingEl.innerHTML = formatAnswer(assistantMsg.content);
                  if (chatArea) chatArea.scrollTop = chatArea.scrollHeight;
                }
                break;
              case 'error':
                state.messages.push({ role: 'error', content: evData.error });
                break;
              case 'done':
                break;
            }
          } catch (e) {
            // Ignore malformed JSON
          }
          eventType = '';
        }
      }
    }
  } catch (e) {
    state.messages.push({ role: 'error', content: 'Failed to connect: ' + e.message });
  }

  state.loading = false;
  state.streamPhase = null;
  render();  // Final re-render for action buttons, sources, etc.
}

async function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);

  state.loading = true;
  render();

  try {
    const res = await fetch(API + '/upload', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();

    if (data.error) {
      state.messages.push({ role: 'error', content: 'Upload failed: ' + data.error });
    } else {
      state.fileSession = {
        session_id: data.session_id,
        filename: data.filename,
        word_count: data.word_count
      };
      state.messages.push({
        role: 'assistant',
        content: `I've loaded "${data.filename}" (${data.word_count.toLocaleString()} words). You can now ask questions about this document ‚Äî I'll draw on both its content and the curriculum knowledge base to answer.`,
        sources: []
      });
    }
  } catch (e) {
    state.messages.push({ role: 'error', content: 'Upload failed: ' + e.message });
  }

  state.loading = false;
  render();
}

function dismissFile() {
  state.fileSession = null;
  render();
}

// --- Helpers ---
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatAnswer(text) {
  // Split on html-visual fenced blocks
  const parts = text.split(/```html-visual\n?([\s\S]*?)```/g);
  let textHtml = '';
  let visualsHtml = '';
  for (let i = 0; i < parts.length; i++) {
    if (i % 2 === 0) {
      // Regular text ‚Äî apply markdown-lite formatting
      // First, convert markdown tables to HTML tables before escaping
      let chunk = parts[i];
      chunk = chunk.replace(
        /(?:^|\n)((?:\|.+\|[ \t]*\n)+)/g,
        function(match, tableBlock) {
          const rows = tableBlock.trim().split('\n').filter(r => r.trim());
          if (rows.length < 2) return match;
          // Check if row 2 is a separator (|---|---|) ‚Äî allow pipes, hyphens, colons, spaces
          const isSep = /^\|[-:\s|]+\|$/.test(rows[1].trim());
          let html = '<table>';
          const startData = isSep ? 2 : 0;
          if (isSep && rows[0]) {
            // Header row
            const cells = rows[0].split('|').filter((c, idx, arr) => idx > 0 && idx < arr.length - 1);
            html += '<thead><tr>' + cells.map(c => '<th>' + c.trim() + '</th>').join('') + '</tr></thead>';
          }
          html += '<tbody>';
          for (let r = startData; r < rows.length; r++) {
            const cells = rows[r].split('|').filter((c, idx, arr) => idx > 0 && idx < arr.length - 1);
            html += '<tr>' + cells.map(c => '<td>' + c.trim() + '</td>').join('') + '</tr>';
          }
          html += '</tbody></table>';
          return '\n' + html + '\n';
        }
      );
      chunk = escapeHtml(chunk)
        .replace(/&lt;table&gt;/g, '<table>').replace(/&lt;\/table&gt;/g, '</table>')
        .replace(/&lt;thead&gt;/g, '<thead>').replace(/&lt;\/thead&gt;/g, '</thead>')
        .replace(/&lt;tbody&gt;/g, '<tbody>').replace(/&lt;\/tbody&gt;/g, '</tbody>')
        .replace(/&lt;tr&gt;/g, '<tr>').replace(/&lt;\/tr&gt;/g, '</tr>')
        .replace(/&lt;th&gt;/g, '<th>').replace(/&lt;\/th&gt;/g, '</th>')
        .replace(/&lt;td&gt;/g, '<td>').replace(/&lt;\/td&gt;/g, '</td>')
        .replace(/\*\*([\s\S]+?)\*\*/g, '<strong>$1</strong>')
        .replace(/(?<!\*)\*(?!\*)(.+?)\*(?!\*)/g, '<em>$1</em>')
        .replace(/^#### (.+)$/gm, '\n<h4>$1</h4>\n')
        .replace(/^### (.+)$/gm, '\n<h3>$1</h3>\n')
        .replace(/^## (.+)$/gm, '\n<h2>$1</h2>\n')
        .replace(/^# (.+)$/gm, '\n<h1>$1</h1>\n')
        .replace(/^---$/gm, '')
        .replace(/^- (.+)$/gm, '‚Ä¢ $1');
      // Convert newlines to <br> then clean up excess whitespace around block elements
      chunk = chunk
        .replace(/\n/g, '<br>')
        .replace(/(<br>)+(<h[1-4]>)/g, '$2')    // strip <br> before headings
        .replace(/(<\/h[1-4]>)(<br>)+/g, '$1')   // strip <br> after headings
        .replace(/(<br>)+(<table>)/g, '$2')       // strip <br> before tables
        .replace(/(<\/table>)(<br>)+/g, '$1')     // strip <br> after tables
        .replace(/(<br>){3,}/g, '<br><br>');      // collapse 3+ <br> to max 2
      // Strip leading <br> tags from the very start of the answer
      if (i === 0) chunk = chunk.replace(/^(<br>\s*)+/, '');
      textHtml += chunk;
    } else {
      // Collect visual blocks ‚Äî render them all after the text
      const visualId = 'vis_' + Math.random().toString(36).substr(2, 6);
      visualsHtml += `<div class="visual-wrapper" id="${visualId}">
        <div class="visual-content">${parts[i]}</div>
        <div class="visual-footer">
          <button class="png-btn" onclick="downloadPng('${visualId}')" style="flex:1">‚¨á Save as PNG</button>
        </div>
      </div>`;
    }
  }
  return textHtml + visualsHtml;
}

async function fleshOut(visualId) {
  const wrapper = document.getElementById(visualId);
  if (!wrapper) return;
  const btn = wrapper.querySelector('.flesh-out-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Building infographic...';

  // Find the question and answer that produced this visual
  // Walk back through state.messages to find the last assistant message
  const msgs = state.messages;
  let question = '';
  let answer = '';
  for (let i = msgs.length - 1; i >= 0; i--) {
    if (msgs[i].role === 'assistant' && msgs[i].content && !question) {
      answer = msgs[i].content;
    }
    if (msgs[i].role === 'user' && answer) {
      question = msgs[i].content;
      break;
    }
  }

  try {
    const res = await fetch(API + '/visualise', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, answer })
    });
    const data = await res.json();

    if (data.html) {
      wrapper.querySelector('.visual-content').innerHTML = data.html;
      btn.textContent = '‚úÖ Done';
      btn.disabled = true;
    } else {
      btn.textContent = '‚ùå ' + (data.error || 'Failed');
      btn.disabled = false;
    }
  } catch (e) {
    btn.textContent = '‚ùå Failed ‚Äî try again';
    btn.disabled = false;
  }
}

async function visualiseAnswer(msgIndex) {
  const msgs = state.messages;
  const msg = msgs[msgIndex];
  if (!msg || msg.role !== 'assistant') return;

  // Find the user question that preceded this answer
  let question = '';
  for (let j = msgIndex - 1; j >= 0; j--) {
    if (msgs[j].role === 'user') { question = msgs[j].content; break; }
  }

  // Open modal with loading state
  openInfographicModal(question || 'Curriculum Infographic');

  try {
    const res = await fetch(API + '/visualise', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, answer: msg.content })
    });
    const data = await res.json();
    if (data.html) {
      document.getElementById('modalVisualContent').innerHTML = data.html;
      document.getElementById('modalDownloadBtn').disabled = false;
      // Cache the HTML on the message so we can re-open without re-generating
      msg._infographicHtml = data.html;
      render();  // Update button to "View Infographic"
    } else {
      document.getElementById('modalVisualContent').innerHTML =
        '<div style="text-align:center;padding:40px;color:#e53e3e;font-size:14px">' +
        escapeHtml(data.error || 'Failed to generate visual') + '</div>';
    }
  } catch (e) {
    document.getElementById('modalVisualContent').innerHTML =
      '<div style="text-align:center;padding:40px;color:#e53e3e;font-size:14px">' +
      'Failed ‚Äî check your connection and try again</div>';
  }
}

function reopenInfographic(msgIndex) {
  const msg = state.messages[msgIndex];
  if (!msg || !msg._infographicHtml) return;
  let question = '';
  for (let j = msgIndex - 1; j >= 0; j--) {
    if (state.messages[j].role === 'user') { question = state.messages[j].content; break; }
  }
  openInfographicModal(question || 'Curriculum Infographic');
  document.getElementById('modalVisualContent').innerHTML = msg._infographicHtml;
  document.getElementById('modalDownloadBtn').disabled = false;
}

function openInfographicModal(title) {
  document.getElementById('modalTitle').textContent = title || 'Infographic';
  document.getElementById('modalVisualContent').innerHTML =
    '<div style="text-align:center;padding:40px;color:var(--text-light);font-size:14px">‚è≥ Building infographic...</div>';
  document.getElementById('modalDownloadBtn').disabled = true;
  document.getElementById('infographicModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeInfographicModal(e) {
  // If called from backdrop click, only close if clicking the overlay itself
  if (e && e.target !== document.getElementById('infographicModal')) return;
  document.getElementById('infographicModal').classList.remove('active');
  document.body.style.overflow = '';
}

async function downloadModalPng() {
  const content = document.getElementById('modalVisualContent');
  const btn = document.getElementById('modalDownloadBtn');
  if (!content || !btn) return;

  btn.disabled = true;
  btn.textContent = '‚è≥ Rendering...';

  try {
    if (typeof html2canvas === 'undefined') {
      throw new Error('html2canvas not loaded');
    }
    const canvas = await html2canvas(content, {
      scale: 2,
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false,
      width: content.scrollWidth,
      windowWidth: content.scrollWidth
    });

    const link = document.createElement('a');
    const subjectName = (state.subjects[state.subject] || {}).name || state.subject;
    link.download = 'curriculum-' + subjectName.toLowerCase() + '-infographic.png';
    link.href = canvas.toDataURL('image/png');
    link.click();

    btn.textContent = '‚úÖ Downloaded';
    setTimeout(() => { btn.textContent = '‚¨á Save as PNG'; btn.disabled = false; }, 2000);
  } catch (e) {
    btn.textContent = '‚ùå Failed';
    setTimeout(() => { btn.textContent = '‚¨á Save as PNG'; btn.disabled = false; }, 2000);
    console.error('Modal PNG export failed:', e);
  }
}

function saveAsPdf(msgId, msgIndex) {
  const el = document.getElementById(msgId);
  if (!el) return;
  // Look up the user question that prompted this answer
  const question = (function() {
    for (let j = msgIndex - 1; j >= 0; j--) {
      if (state.messages[j] && state.messages[j].role === 'user') return state.messages[j].content;
    }
    return '';
  })();

  // Grab the answer ‚Äî strip action bar but keep visuals
  const clone = el.cloneNode(true);
  clone.querySelectorAll('.message-actions, .sources').forEach(n => n.remove());
  // Remove visual footers (buttons) but keep visual content
  clone.querySelectorAll('.visual-footer').forEach(n => n.remove());
  const answerHtml = clone.innerHTML;

  const subjectName = (state.subjects[state.subject] || {}).name || state.subject;
  const subjectConf = state.subjects[state.subject] || {};
  const accent = subjectConf.accent_color || '#718096';
  const accentLight = subjectConf.accent_light || '#f7fafc';
  const now = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

  const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>${subjectName} ‚Äî Curriculum Expert</title>
<style>
  @page { margin: 18mm 16mm 14mm 16mm; size: A4; }
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
  body {
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    color: #1a202c;
    line-height: 1.65;
    font-size: 13px;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  h1 { font-size: 18px; font-weight: 700; margin: 14px 0 5px; color: ${accent}; }
  h2 { font-size: 16px; font-weight: 700; margin: 12px 0 4px; color: ${accent}; }
  h3 { font-size: 14px; font-weight: 700; margin: 10px 0 3px; color: ${accent}; }
  h4 { font-size: 13px; font-weight: 700; margin: 8px 0 2px; color: ${accent}; }
  strong { color: #1a202c; }
  .pdf-question {
    background: ${accentLight};
    border-left: 4px solid ${accent};
    padding: 10px 14px;
    border-radius: 0 6px 6px 0;
    margin-bottom: 14px;
    font-weight: 600;
    font-size: 14px;
    color: #2d3748;
  }
  .pdf-body { color: #2d3748; }
  .pdf-body br + br { display: none; }
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 10px 0;
    font-size: 12px;
  }
  th, td {
    border: 1px solid #e2e8f0;
    padding: 5px 8px;
    text-align: left;
  }
  th {
    background: #f7fafc;
    font-weight: 600;
    color: #2d3748;
  }
  td[style*="background"], th[style*="background"],
  div[style*="background"], span[style*="background"] {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  .visual-wrapper {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    overflow: visible;
    margin: 10px 0;
    break-inside: avoid;
  }
  .visual-content { padding: 10px 12px; }
  .visual-content * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  @media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
    body { -webkit-print-color-adjust: exact !important; }
    th, td, div, span, svg, canvas { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  }
</style>
</head>
<body>
  ${question ? '<div class="pdf-question">' + question + '</div>' : ''}
  <div class="pdf-body">${answerHtml}</div>
</body>
</html>`;

  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const pdfWindow = window.open(url, '_blank');

  // Auto-open print dialog after content loads, then close tab when done
  pdfWindow.addEventListener('load', () => {
    pdfWindow.addEventListener('afterprint', () => {
      pdfWindow.close();
      URL.revokeObjectURL(url);
    });
    pdfWindow.print();
    // Fallback cleanup if afterprint doesn't fire (e.g. some browsers)
    setTimeout(() => URL.revokeObjectURL(url), 120000);
  });
}

async function downloadPng(visualId) {
  const wrapper = document.getElementById(visualId);
  if (!wrapper) return;
  const content = wrapper.querySelector('.visual-content');
  const btn = wrapper.querySelector('.png-btn');

  btn.disabled = true;
  btn.textContent = '‚è≥ Rendering...';

  try {
    if (typeof html2canvas === 'undefined') {
      throw new Error('html2canvas not loaded');
    }
    const canvas = await html2canvas(content, {
      scale: 2,           // retina quality
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false,
      width: content.scrollWidth,       // capture full content width, not just visible area
      windowWidth: content.scrollWidth  // prevent clipping of wide visuals
    });

    const link = document.createElement('a');
    const subjectName = (state.subjects[state.subject] || {}).name || state.subject;
    link.download = `curriculum-${subjectName.toLowerCase()}-infographic.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();

    btn.textContent = '‚úÖ Downloaded';
    setTimeout(() => {
      btn.textContent = '‚¨á PNG';
      btn.disabled = false;
    }, 2000);
  } catch (e) {
    btn.textContent = '‚ùå Failed';
    btn.disabled = false;
    console.error('PNG export failed:', e);
  }
}

function downloadKnowledgePdf(e) {
  if (e) e.stopPropagation();
  const ks = state.knowledgeStatus;
  if (!ks) return;

  const subjectName = (state.subjects[state.subject] || {}).name || state.subject;
  const accent = getAccentHex(state.subject);
  const now = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  const isCompare = state.knowledgeCompareMode && state.knowledgeSummary;

  let bodyContent = '';

  if (isCompare) {
    const subjects = state.knowledgeSummary.subjects;
    const rows = Object.entries(subjects).map(([key, s]) => {
      const c = getAccentHex(key);
      return `<tr>
        <td><strong>${escapeHtml(s.name)}</strong></td>
        <td class="bar-cell"><div class="bar-track"><div class="bar-fill" style="width:${s.percent}%;background:${c}"></div></div></td>
        <td style="text-align:center">${s.built}</td>
        <td style="text-align:center">${s.planned}</td>
        <td style="text-align:center">${s.percent}%</td>
        <td style="text-align:center">${s.chunks != null ? s.chunks : '\u2014'}</td>
      </tr>`;
    }).join('');
    bodyContent = `<h1 style="color:${accent}">Knowledge Base Status \u2014 All Subjects</h1>
      <div class="subtitle">${now}</div>
      <table><tr><th>Subject</th><th class="bar-cell">Progress</th><th>Built</th><th>Planned</th><th>%</th><th>Chunks</th></tr>${rows}</table>`;
  } else {
    const s = ks.summary;
    const foldersHtml = ks.folders.map(f => {
      const pct = f.planned > 0 ? Math.round(f.built / f.planned * 100) : 0;
      const filesHtml = f.files.map(file => {
        const icon = file.status === 'built' ? '\u2713' : '\u25CB';
        const cls = file.status === 'built' ? 'file-done' : 'file-pending';
        const name = file.file.replace('.md', '').replace(/_/g, ' ');
        return `<div class="file ${cls}">${icon} ${name}</div>`;
      }).join('');
      return `<div class="folder">
        <div class="folder-head"><span>${escapeHtml(f.label)}</span><span>${f.built}/${f.planned}</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${accent}"></div></div>
        ${filesHtml}
      </div>`;
    }).join('');

    let recentHtml = '';
    if (ks.recent_builds && ks.recent_builds.length > 0) {
      const rows = ks.recent_builds.map(b => {
        const fname = b.file.split('/').pop().replace('.md', '').replace(/_/g, ' ');
        return `<tr><td>${b.date}</td><td>${escapeHtml(fname)}</td><td>${b.words} words</td></tr>`;
      }).join('');
      recentHtml = `<h2 style="color:${accent}">Recent Builds</h2><table><tr><th>Date</th><th>File</th><th>Words</th></tr>${rows}</table>`;
    }

    bodyContent = `<h1 style="color:${accent}">${escapeHtml(subjectName)} \u2014 Knowledge Base Status</h1>
      <div class="subtitle">${now} \u00b7 ${s.total_built}/${s.total_planned} files (${s.percent_complete}%) \u00b7 ${ks.indexing.chromadb_chunks} chunks indexed</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${s.percent_complete}%;background:${accent}"></div></div>
      <div class="folders">${foldersHtml}</div>
      ${recentHtml}
      <div class="info">Embedding: ${escapeHtml(ks.indexing.embedding_model)} \u00b7 Collection: ${escapeHtml(ks.indexing.collection_name)}</div>`;
  }

  const htmlContent = `<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8">
<title>Knowledge Base \u2014 ${isCompare ? 'All Subjects' : escapeHtml(subjectName)}</title>
<style>
  @page { margin: 15mm 14mm 12mm 14mm; size: A4; }
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; color: #1a202c; line-height: 1.5; font-size: 11px; }
  h1 { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
  h2 { font-size: 13px; font-weight: 700; margin: 14px 0 4px; }
  .subtitle { font-size: 11px; color: #718096; margin-bottom: 10px; }
  .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; margin: 6px 0 10px; }
  .progress-fill { height: 100%; border-radius: 3px; }
  .folders { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .folder { border: 1px solid #e2e8f0; border-radius: 4px; padding: 6px 8px; break-inside: avoid; }
  .folder-head { display: flex; justify-content: space-between; font-weight: 600; font-size: 10px; margin-bottom: 2px; }
  .folder .progress-bar { height: 3px; margin: 2px 0 4px; }
  .file { font-size: 9px; line-height: 1.3; }
  .file-done { color: #276749; }
  .file-pending { color: #a0aec0; }
  .info { font-size: 9px; color: #718096; border-top: 1px solid #e2e8f0; padding-top: 6px; margin-top: 8px; }
  table { width: 100%; border-collapse: collapse; margin: 6px 0; }
  th, td { border: 1px solid #e2e8f0; padding: 4px 8px; text-align: left; font-size: 10px; }
  th { background: #f7fafc; font-weight: 600; }
  .bar-cell { width: 40%; }
  .bar-track { height: 8px; background: #e2e8f0; border-radius: 4px; }
  .bar-fill { height: 100%; border-radius: 4px; }
  @media print { * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; } }
</style></head>
<body>${bodyContent}</body></html>`;

  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const pdfWindow = window.open(url, '_blank');
  pdfWindow.addEventListener('load', () => {
    pdfWindow.addEventListener('afterprint', () => {
      pdfWindow.close();
      URL.revokeObjectURL(url);
    });
    pdfWindow.print();
    setTimeout(() => URL.revokeObjectURL(url), 120000);
  });
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendQuestion();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// --- Drag & Drop ---
function setupDragDrop() {
  const overlay = document.getElementById('dragOverlay');
  let dragCount = 0;

  document.addEventListener('dragenter', (e) => {
    e.preventDefault();
    dragCount++;
    overlay.classList.add('active');
  });

  document.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dragCount--;
    if (dragCount <= 0) {
      overlay.classList.remove('active');
      dragCount = 0;
    }
  });

  document.addEventListener('dragover', (e) => e.preventDefault());

  document.addEventListener('drop', (e) => {
    e.preventDefault();
    overlay.classList.remove('active');
    dragCount = 0;
    const files = e.dataTransfer.files;
    if (files.length > 0) uploadFile(files[0]);
  });

  // File input handler
  document.getElementById('fileInput').addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      uploadFile(e.target.files[0]);
      e.target.value = '';
    }
  });

  // Escape key closes modals
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (document.getElementById('kbModal').classList.contains('active')) {
        closeKbModal();
      } else if (document.getElementById('infographicModal').classList.contains('active')) {
        closeInfographicModal();
      }
    }
  });
}

// --- Go ---
init();
</script>
</body>
</html>
